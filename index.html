<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESH COMPLIANCE DASHBOARD - SCIC</title>
    <!-- Security meta tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%231b5e20' d='M256 0c4.6 0 9.2 1 13.4 2.9L457.7 82.8c22 9.3 38.4 31 38.3 57.2c-.5 99.2-41.3 280.7-213.6 363.2c-16.7 8-36.1 8-52.8 0C57.3 420.7 16.5 239.2 16 140c-.1-26.2 16.3-47.9 38.3-57.2L242.7 2.9C246.8 1 251.4 0 256 0z'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdqVEm3PWPuFTVbrxaP4JAZNXl2bmNUg4",
            authDomain: "esh-dashboard.firebaseapp.com",
            projectId: "esh-dashboard",
            storageBucket: "esh-dashboard.firebasestorage.app",
            messagingSenderId: "121684914529",
            appId: "1:121684914529:web:d5292a3c30f1bba2959520",
            measurementId: "G-TXYB9T0T3W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebase = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            sendPasswordResetEmail,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            updateDoc
        };

        console.log("✅ Firebase initialized!");
    </script>
    <style>
        :root {
            --safety-green-grad: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            --header-grad: linear-gradient(90deg, #1b5e20 0%, #388e3c 100%);
            --safety-yellow: #fbc02d;
            --bg-body: #f4f7f6;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-card: #ffffff;
            --border-color: #eee;
            --table-header: #2e7d32;
            --input-bg: #fdfdfd;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --text-primary: #e4e4e4;
            --text-secondary: #b0b0b0;
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --border-color: #444;
            --table-header: #1b5e20;
            --input-bg: #3a3a3a;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { 
            margin: 0; 
            background: var(--bg-body); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        #login-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 100%);
            display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;
        }

        .login-card {
            background: var(--bg-card); padding: 35px; border-radius: 15px; width: 100%; max-width: 480px;
            text-align: center; border-bottom: 8px solid var(--safety-yellow); box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            color: var(--text-primary);
        }

        .login-card input {
            width: 100%; padding: 15px; margin: 10px 0; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 1rem; background: var(--input-bg); color: var(--text-primary);
        }

        .login-card input::placeholder {
            color: var(--text-secondary);
        }

        .disclaimer-box {
            background: #fff9c4; border: 1px solid #fbc02d; border-radius: 8px; padding: 15px;
            margin-top: 25px; font-size: 0.72rem; color: #333; line-height: 1.4;
        }

        body.dark-mode .disclaimer-box {
            background: #4a4a2d; border: 1px solid #fbc02d; color: #e4e4e4;
        }

        aside {
            width: 260px; background: var(--safety-green-grad); color: white;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .nav-item {
            padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: 0.3s; font-size: 0.75rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255,255,255,0.2); border-left: 5px solid var(--safety-yellow); font-weight: 600; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; background: var(--bg-body); }
        
        header {
            background: var(--bg-card); padding: 12px 15px; border-bottom: 1px solid var(--border-color); position: sticky;
            top: 0; z-index: 90; display: flex; gap: 15px; align-items: center; justify-content: space-between;
            flex-wrap: wrap;
        }

        .header-title { font-size: 1.1rem; color: #1b5e20; font-weight: 600; }
        .header-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .header-controls input, .header-controls select {
            padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;
            background: var(--input-bg); color: var(--text-primary);
        }

        /* Dark Mode Toggle Button */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1rem;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .btn {
            padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600;
            font-size: 0.75rem; white-space: nowrap;
        }
        .btn-primary { background: var(--safety-green-grad); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background: #ccc; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-danger:hover { background: #b71c1c; }

        .region-banner {
            background: var(--header-grad); color: white; padding: 15px 20px;
            margin: 20px 20px 0; border-radius: 6px; font-weight: 700; display: flex;
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .badge { background: var(--safety-yellow); color: #1b5e20; padding: 4px 12px;
            border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .sort-select {
            background: rgba(255,255,255,0.2); color: white; padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 4px;
        }
        .sort-select option { background: #1b5e20; color: white; }

        .project-row {
            background: var(--bg-card); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 8px;
            margin: 0 20px 8px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
        }
        .project-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .circular-progress {
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; background: conic-gradient(#1b5e20 var(--percentage), #e0e0e0 var(--percentage));
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .circular-progress-inner {
            width: 44px; height: 44px; border-radius: 50%; background: var(--bg-card); display: flex;
            align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem; color: #1b5e20;
        }
        .project-info { display: flex; flex-direction: column; gap: 3px; flex-grow: 1; min-width: 150px; }
        .project-name { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
        .project-meta { font-size: 0.65rem; color: var(--text-secondary); }
        .project-dates { display: flex; flex-direction: column; gap: 2px; min-width: 200px; font-size: 0.65rem; }
        .date-label { font-weight: 600; color: #1b5e20; }
        .status-badge {
            padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; font-size: 0.65rem;
            cursor: pointer; text-transform: uppercase; transition: 0.2s;
        }
        .status-ongoing { background: #1976D2; }
        .status-stoppage { background: #d32f2f; }
        .status-finished { background: #616161; }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%;
            height: 100%; background: rgba(0,0,0,0.4); align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); color: var(--text-primary);
        }
        .modal-header { font-size: 1.2rem; font-weight: 700; color: #1b5e20; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem;
            background: var(--input-bg); color: var(--text-primary);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #1b5e20; box-shadow: 0 0 5px rgba(27,94,32,0.2);
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .error-message { color: #d32f2f; font-size: 0.8rem; margin-top: 10px; }
        .success-message { color: #1b5e20; font-size: 0.8rem; margin-top: 10px; font-weight: 600; }
        .hidden { display: none !important; }
        
/* Backup & Recovery Styles */
.backup-section {
    background: var(--bg-card);
    border-left: 5px solid #1b5e20;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.backup-section h4 {
    margin-top: 0;
    color: #1b5e20;
    font-size: 1rem;
}

.backup-info {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 6px;
    margin: 12px 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

body.dark-mode .backup-info {
    background: #3a3a3a;
}

.backup-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.backup-status {
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.8rem;
    margin-top: 10px;
    font-weight: 600;
}

.backup-status.success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #4caf50;
}

.backup-status.error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #f44336;
}

.backup-status.info {
    background: #e3f2fd;
    color: #1565c0;
    border-left: 4px solid #2196f3;
}

body.dark-mode .backup-status.success {
    background: #1b5e20;
    color: #81c784;
}

body.dark-mode .backup-status.error {
    background: #5a1414;
    color: #ef5350;
}

body.dark-mode .backup-status.info {
    background: #1a3a52;
    color: #64b5f6;
}

.backup-list {
    margin-top: 15px;
}

.backup-item {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    border-left: 3px solid #fbc02d;
}

body.dark-mode .backup-item {
    background: #3a3a3a;
}

.backup-item-info {
    flex-grow: 1;
}

.backup-item-date {
    font-weight: 600;
    color: var(--text-primary);
}

.backup-item-size {
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.backup-item-actions {
    display: flex;
    gap: 8px;
}

.backup-item-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: 0.2s;
}

.backup-item-btn-restore {
    background: #1b5e20;
    color: white;
}

.backup-item-btn-restore:hover {
    background: #0a2e10;
}

.backup-item-btn-delete {
    background: #d32f2f;
    color: white;
}

.backup-item-btn-delete:hover {
    background: #b71c1c;
}

.backup-progress {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    margin: 10px 0;
    overflow: hidden;
}

.backup-progress-bar {
    height: 100%;
    background: var(--safety-green-grad);
    border-radius: 3px;
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0%; }
    50% { width: 100%; }
    100% { width: 0%; }
}


/* Modern Dialog Styles */
.modern-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.modern-dialog {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
}

.modern-dialog-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 12px 0;
    color: #1b5e20;
}

.modern-dialog-message {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.modern-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modern-dialog-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
}

.modern-dialog-btn-cancel {
    background: var(--border-color);
    color: var(--text-primary);
}

.modern-dialog-btn-cancel:hover {
    background: #ccc;
}

.modern-dialog-btn-confirm {
    background: var(--safety-green-grad);
    color: white;
}

.modern-dialog-btn-confirm:hover {
    opacity: 0.9;
}

.modern-dialog-btn-danger {
    background: #d32f2f;
    color: white;
}

.modern-dialog-btn-danger:hover {
    background: #b71c1c;
}

	.status-dropdown {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 150px;
}

.status-dropdown button {
    display: block;
    width: 100%;
    padding: 10px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-primary);
    transition: 0.2s;
}

.status-dropdown button:hover {
    background: var(--border-color);
}

        /* IMPROVED TABLE STYLES */
        .table-container {
            margin: 10px 20px; overflow-x: auto; padding: 10px; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 8px;
        }
        
        table { 
            width: auto;
            min-width: 100%;
            border-collapse: collapse; 
            font-size: 0.7rem;
            table-layout: auto;
            color: var(--text-primary);
        }
        
        th { 
    background: var(--table-header); 
    color: white; 
    padding: 10px 8px; 
    border: 1px solid #1b5e20;
    white-space: nowrap;
    min-width: auto;
    width: auto;
}
        
        td { 
    border: 1px solid var(--border-color); 
    padding: 8px 6px; 
    text-align: center;
    min-width: auto;
    width: auto;
    background: var(--bg-card);
    white-space: nowrap;
}
        
        td:first-child {
            text-align: left;
            min-width: 200px;
            font-weight: 600;
            background: var(--border-color);
        }
        
        /* Previous Year Column - Light Blue */
        td.prev-year {
    background: #e3f2fd;
    font-weight: 600;
    color: #1565c0;
    min-width: auto;
    width: auto;
}

        body.dark-mode td.prev-year {
            background: #1a3a52;
            color: #64b5f6;
        }
        
        th.prev-year {
            background: #1565c0;
        }
        
        /* Monthly Columns - Default */
       /* Monthly Columns - Default */
td.monthly-data {
    background: var(--bg-card);
    min-width: auto;
    width: auto;
}
        
        /* YTD Column - Yellow */
        /* YTD Column - Yellow */
td.ytd-cell {
    background: #fff59d;
    font-weight: 700;
    color: #f57f17;
    min-width: auto;
    width: auto;
    padding: 8px 12px;
}
        }

        body.dark-mode td.ytd-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.ytd-header {
            background: #f9a825;
            color: white;
            min-width: 90px;
        }

        body.dark-mode th.ytd-header {
            background: #e65100;
            color: white;
        }
        
        /* Average Column - Light Yellow */
       /* Average Column - Light Yellow */
td.average-cell {
    background: #fffde7;
    font-weight: 700;
    color: #f57f17;
    min-width: auto;
    width: auto;
    padding: 8px 12px;
}

        body.dark-mode td.average-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.average-header {
            background: #fbc02d;
            color: #333;
            min-width: 90px;
        }

        body.dark-mode th.average-header {
            background: #e65100;
            color: white;
        }
        
        table input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 6px 4px;
            font-size: 0.7rem;
            text-align: center;
            font-weight: 500;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        
        table input:disabled { 
            background: transparent; 
            border: none; 
            color: var(--text-primary); 
            font-weight: 600;
        }
        
        table input[type="number"] {
    min-width: auto;
    width: auto;
    padding: 6px 4px;
}

table input[type="date"] {
    min-width: auto;
    width: auto;
    padding: 6px 4px;
}
        
        #grand-stats {
            margin: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        .stat-card {
            background: var(--bg-card); padding: 15px; border-radius: 8px; border-left: 5px solid #1b5e20;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: var(--text-primary);
        }
        .stat-value { font-size: 1.5rem; font-weight: 900; color: #1b5e20; margin-top: 5px; }
        .stat-label { font-size: 0.65rem; color: var(--text-secondary); font-weight: 700; }
        .charts-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;
            padding: 20px; margin-top: 0;
        }
        .chart-box {
            background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            color: var(--text-primary);
        }
        .chart-box h3 {
            color: #1b5e20; margin-top: 0; font-size: 0.95rem; border-bottom: 2px solid var(--safety-yellow);
            padding-bottom: 10px;
        }
        .chart-box canvas { max-height: 300px; }
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .logout-btn {
            width: 100%; background: rgba(255,255,255,0.1); color: white;
            border: 1px solid rgba(255,255,255,0.2); padding: 10px; cursor: pointer;
            font-size: 0.75rem; border-radius: 4px;
        }
        .user-badge { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 4px;
            font-size: 0.7rem; margin-top: 10px; border: 1px solid rgba(255,255,255,0.3); }

        #dashboard-content {
            color: var(--text-primary);
        }

/* I-adjust ang width ng specific DOLE columns */
.col-narrow {
    width: 1%;
    white-space: nowrap;
    padding-left: 10px !important;
    padding-right: 10px !important;
}

/* Kulay para sa disabled cells */
.cell-disabled {
    background-color: var(--border-color) !important;
    cursor: not-allowed;
    opacity: 0.6;
}

    </style>
</head>
<body>

	
    <div id="login-overlay">
        <div class="login-card">
            <div style="background: var(--safety-green-grad); width: 60px; height: 60px; border-radius: 50%;
                display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 1.5rem;">
                <i class="fas fa-shield-halved"></i>
            </div>
            <h2 style="color:#1b5e20; margin:0 0 5px 0; font-size: 1.1rem; letter-spacing: 1px;">ESH COMPLIANCE DASHBOARD</h2>
            <p style="margin:0 0 20px 0; font-size: 0.75rem; font-weight: 600; color: #666;">STA. CLARA INTERNATIONAL CORPORATION</p>
            <form onsubmit="handleLogin(event)" autocomplete="off">
                <input type="email" id="login-user" placeholder="Email Address" required autocomplete="email">
                <input type="password" id="login-pass" placeholder="Password" required autocomplete="current-password">
                <button type="submit" class="btn btn-primary" id="login-btn" style="width:100%; margin-top:15px; padding: 12px; font-size: 0.9rem;">
                    <i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM
                </button>
            </form>
            <div id="login-error" class="error-message"></div>
            <div style="margin-top: 12px; text-align: center;">
                <a href="#" id="forgot-password-link" onclick="handleForgotPassword(event)" style="color: #1b5e20; font-size: 0.78rem; text-decoration: underline;">
                    <i class="fas fa-key"></i> Forgot Password?
                </a>
            </div>
            <div class="disclaimer-box">
                <strong><i class="fas fa-lock"></i> AUTHORIZED ACCESS ONLY</strong><br>
                This system is restricted to ESH SCIC personnel only.<br>
                Contact your administrator if you need access.
            </div>
        </div>
    </div>

    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Add New Project</span>
                <button class="modal-close" onclick="closeAddProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="projectNameInput" placeholder="Enter project name" required>
            </div>
            <div class="form-group">
                <label>Date Started *</label>
                <input type="date" id="projectDateStarted" required>
            </div>
            <div class="form-group">
                <label>Date Finished</label>
                <input type="date" id="projectDateFinished">
            </div>
            <div class="form-group">
                <label>Region *</label>
                <select id="projectRegion" required>
                    <option value="">Select Region</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                </select>
            </div>


            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddProject()">Add Project</button>
            </div>
            <div id="projectModalError" class="error-message"></div>
        </div>
    </div>

    <aside id="main-sidebar" class="hidden">
        <div class="sidebar-header">
            <div style="font-size: 1.4rem; font-weight: 900; line-height: 1.1; margin-top: 5px;">ESH <span style="color:var(--safety-yellow)">COMPLIANCE</span><br>DASHBOARD</div>
            <div id="live-date" style="font-size: 0.6rem; color: #a5d6a7; margin-top: 10px;"></div>
            <div id="live-clock" style="color: var(--safety-yellow); font-size: 0.8rem; font-weight: 700;"></div>
            <div id="user-badge" class="user-badge"></div>
        </div>
        <nav style="flex-grow: 1; padding-top: 10px;">
            <div class="nav-item active" data-tab="overall" onclick="changeTab('overall')"><i class="fas fa-chart-pie"></i> Overall Dashboard</div>
 <div class="nav-item" data-tab="incident-rate" onclick="changeTab('incident-rate')"><i class="fas fa-calculator"></i> Incident Tabulation Rate</div>
            <div class="nav-item" data-tab="exposures" onclick="changeTab('exposures')"><i class="fas fa-clock"></i> Total Exposures</div>
            <div class="nav-item" data-tab="rates" onclick="changeTab('rates')"><i class="fas fa-chart-line"></i> Statistics Rate</div>
            <div class="nav-item" data-tab="medical" onclick="changeTab('medical')"><i class="fas fa-kit-medical"></i> Accident/ Incident Record</div>
            <div class="nav-item" data-tab="activities" onclick="changeTab('activities')"><i class="fas fa-list-check"></i> ESH Activities & Programs</div>
	    <div class="nav-item" data-tab="nov" onclick="changeTab('nov')"><i class="fa-solid fa-helmet-safety"></i> OSH Issued NOV</div>
            <div class="nav-item" data-tab="environment" onclick="changeTab('environment')"><i class="fas fa-leaf"></i> Envi Issued NOV</div>
            <div class="nav-item" data-tab="kpm" onclick="changeTab('kpm')"><i class="fas fa-file-export"></i> Monthly Report</div>
	    <div class="nav-item" data-tab="audit" onclick="changeTab('audit')"><i class="fa-solid fa-square-poll-horizontal"></i> Internal ESH Audit Result</div>
            <div class="nav-item" data-tab="cshp" onclick="changeTab('cshp')"><i class="fas fa-calendar-check"></i> CSHP</div>
	    <div class="nav-item" data-tab="reg" onclick="changeTab('reg')"><i class="fas fa-calendar-check"></i> Certificate of Registration</div>
            <div class="nav-item" data-tab="dole" onclick="changeTab('dole')"><i class="fas fa-file-export"></i> DOLE Reportorial</div>
	    <div class="nav-item" data-tab="emb" onclick="changeTab('emb')"><i class="fas fa-file-export"></i> EMB Reportorial</div>
            <div class="nav-item" data-tab="personnel" onclick="changeTab('personnel')"><i class="fas fa-users-gear"></i> ESH Personnel Monitoring</div>
            <div class="nav-item" data-tab="settings" onclick="changeTab('settings')"><i class="fas fa-cog"></i> Settings</div>
        </nav>
        <div style="padding: 15px;">
            <button onclick="handleLogout()" class="logout-btn">
                <i class="fas fa-power-off"></i> LOGOUT SESSION
            </button>
        </div>
    </aside>

    <main id="main-content" class="hidden">
        <header>
            <h2 class="header-title">OVERALL DASHBOARD</h2>
            <div class="header-controls">
                <input type="text" id="search-input" placeholder="Search projects..." onkeyup="handleSearch()" style="display: none;">
                <select id="region-filter" onchange="handleFilter()" style="display: none;">
                    <option value="">All Regions</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                </select>
                <select id="status-filter" onchange="handleFilter()" style="display: none;">
                    <option value="">All Status</option>
                    <option value="on-going">On-Going</option>
                    <option value="work-stoppage">Work Stoppage</option>
                    <option value="finished">Finished</option>
                </select>
                <div style="display:flex; gap: 8px;" id="edit-controls" style="display: none;">
                    <button onclick="exportToCSV()" class="btn btn-primary" title="Export to CSV" style="display: none;" id="btn-csv">
                        <i class="fas fa-download"></i> CSV
                    </button>
                    <button onclick="exportToPDF()" class="btn btn-primary" title="Export to PDF" style="display: none;" id="btn-pdf">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
                <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <button id="edit-btn" class="btn btn-primary" onclick="toggleEdit()"><i class="fas fa-edit"></i> EDIT</button>
                <button id="save-btn" class="btn btn-primary hidden" onclick="saveData()"><i class="fas fa-save"></i> SAVE</button>
            </div>
        </header>
       

 <div id="dashboard-content"></div>



<div id="personnel-view" class="hidden" style="padding: 20px;">
    <div class="backup-section" style="border-left: 5px solid #1b5e20;">
        <h3 style="color: #1b5e20; margin-bottom: 15px;">ESH Personnel Monitoring</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="p-search" placeholder="Search Name or ID..." onkeyup="filterP()" style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
            <button class="btn btn-primary" onclick="addPRow()"><i class="fas fa-plus"></i> Add Personnel</button>
        </div>
        <div class="table-container" style="overflow-x: auto;">
            <table id="p-table">
                <thead>
                    <tr>
                        <th>Full Name</th>
                        <th>Position</th>
                        <th>ID Number</th>
                        <th>Date Hired</th>
                        <th>Current Project</th>
                        <th>Previous Projects</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Email</th>
                        <th>Contact No.</th>
                        <th>Home Address</th>
                        <th>Length of Service</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="p-body"></tbody>
            </table>
        </div>
    </div>
</div>



<!-- INCIDENT TABULATION RATE VIEW -->
<div id="incident-rate-view" class="hidden" style="padding: 20px;">
    <div style="background: var(--bg-card); padding: 25px; border-radius: 12px; max-width: 1200px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h2 style="margin: 0; color: #1b5e20; font-size: 1.3rem;">
                <i class="fas fa-calculator"></i> INCIDENT TABULATION RATE
            </h2>
            <button class="btn btn-primary" onclick="saveUserData(state.currentUser.email)">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>

        <!-- Input Section -->
        <div style="background: #f0f7f0; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 2px solid #1b5e20;">
            <h3 style="color: #1b5e20; margin-top: 0; font-size: 1rem; margin-bottom: 15px;">
                <i class="fas fa-edit"></i> Input Data
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 5px;">
                        No. of Recordable Cases:
                    </label>
                    <input type="number" id="recordable-cases" 
                           oninput="calculateIncidentRates()" 
                           placeholder="Enter number"
                           style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 5px;">
                        No. of Lost Days:
                    </label>
                    <input type="number" id="lost-days" 
                           oninput="calculateIncidentRates()" 
                           placeholder="Enter number"
                           style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 5px;">
                        Total Employee Hours Exposure:
                    </label>
                    <input type="number" id="total-hours" 
                           oninput="calculateIncidentRates()" 
                           placeholder="Enter number"
                           style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem;">
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div style="overflow-x: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                <thead>
                    <tr>
                        <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 15px; text-align: left; font-size: 1rem; border: none; width: 40%;">
                            INJURY/ILLNESS
                        </th>
                        <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 15px; text-align: center; font-size: 1rem; border: none; width: 30%;">
                            OSHA<br><span style="font-size: 0.8rem; font-weight: 400;">200,000</span>
                        </th>
                        <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 15px; text-align: center; font-size: 1rem; border: none; width: 30%;">
                            OSHS<br><span style="font-size: 0.8rem; font-weight: 400;">1,000,000</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- LTIR Row -->
                    <tr style="border-bottom: 2px solid #e0e0e0;">
                        <td style="background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%); color: white; padding: 20px 15px; border: none;">
                            <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 5px;">LTIR (Loss Time Incident Rate)</div>
                            <div style="font-size: 0.7rem; opacity: 0.95; line-height: 1.3;">
                                <strong>Formula:</strong><br>
                                No of Recordable Cases × 1M/2K<br>
                                Total Employee Hours Exposure
                            </div>
                        </td>
                        <td style="background: var(--bg-card); padding: 15px; text-align: center; border: 1px solid var(--border-color);">
                            <div id="ltir-osha" style="font-size: 2rem; font-weight: 800; color: #1b5e20;">0</div>
                        </td>
                        <td style="background: var(--bg-card); padding: 15px; text-align: center; border: 1px solid var(--border-color);">
                            <div id="ltir-oshs" style="font-size: 2rem; font-weight: 800; color: #1b5e20;">0</div>
                        </td>
                    </tr>

                    <!-- TRIR Row -->
                    <tr style="border-bottom: 2px solid #e0e0e0;">
                        <td style="background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%); color: white; padding: 20px 15px; border: none;">
                            <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 5px;">TRIR (Total Recordable Incident Rate)</div>
                            <div style="font-size: 0.7rem; opacity: 0.95; line-height: 1.3;">
                                <strong>Formula:</strong><br>
                                No of Recordable Cases × 1M/2K<br>
                                Total Employee Hours Exposure
                            </div>
                        </td>
                        <td style="background: var(--bg-card); padding: 15px; text-align: center; border: 1px solid var(--border-color);">
                            <div id="trir-osha" style="font-size: 2rem; font-weight: 800; color: #1b5e20;">0</div>
                        </td>
                        <td style="background: var(--bg-card); padding: 15px; text-align: center; border: 1px solid var(--border-color);">
                            <div id="trir-oshs" style="font-size: 2rem; font-weight: 800; color: #1b5e20;">0</div>
                        </td>
                    </tr>

                    <!-- Severity Rate Row -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%); color: white; padding: 20px 15px; border: none;">
                            <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 5px;">Severity Rate</div>
                            <div style="font-size: 0.7rem; opacity: 0.95; line-height: 1.3;">
                                <strong>Formula:</strong><br>
                                No of Total Days Lost × 1M/2K<br>
                                Total Employee Hours Exposure
                            </div>
                        </td>
                        <td style="background: var(--bg-card); padding: 15px; text-align: center; border: 1px solid var(--border-color);">
                            <div id="severity-osha" style="font-size: 2rem; font-weight: 800; color: #1b5e20;">0</div>
                        </td>
                        <td style="background: var(--bg-card); padding: 15px; text-align: center; border: 1px solid var(--border-color);">
                            <div id="severity-oshs" style="font-size: 2rem; font-weight: 800; color: #1b5e20;">0</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Info Box -->
        <div style="margin-top: 20px; padding: 15px; background: #fff9c4; border: 2px solid #fbc02d; border-radius: 8px;">
            <strong style="color: #f57f17;"><i class="fas fa-info-circle"></i> NOTES:</strong>
            <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #333; font-size: 0.85rem; line-height: 1.6;">
                <li><strong>OSHA Standard:</strong> Uses 200,000 hours (100 employees × 40 hours/week × 50 weeks)</li>
                <li><strong>OSHS Standard:</strong> Uses 1,000,000 hours (Philippine standard)</li>
                <li><strong>Auto-calculation:</strong> Results update automatically as you type</li>
                <li><strong>Data Persistence:</strong> All data is saved automatically to your account</li>
            </ul>
        </div>
    </div>
</div>

        <div id="settings-view" class="hidden" style="max-width: 600px; margin: 40px auto; background: var(--bg-card); padding: 30px; border-radius: 12px; color: var(--text-primary);">
    <h3 style="color: #1b5e20; border-bottom: 2px solid var(--safety-yellow); padding-bottom: 5px;">Account Settings</h3>
    <div class="form-group">
        <label>Current Email:</label>
        <input type="email" id="current-email" disabled>
    </div>
    <div class="form-group">
        <label>New Password</label>
        <input type="password" id="new-password" placeholder="Enter new password">
    </div>
    <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="confirm-password" placeholder="Confirm password">
    </div>
    <button class="btn btn-primary" style="width:100%; padding: 10px;" onclick="updatePassword()">UPDATE PASSWORD</button>
    <div id="settings-message"></div>
    <div style="margin-top: 15px; text-align: center;">
        <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="sendResetFromSettings()">
            <i class="fas fa-envelope"></i> Send Password Reset Email
        </button>
    </div>

    <div id="backup-recovery-section" style="margin-top: 30px;"></div>
</div>
            
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>

// ===== BACKUP & RECOVERY SYSTEM =====
let backupManager = {
    backups: [],
    autoSaveInterval: null,
    maxBackups: 10,
    autoSaveFrequency: 300000, // 5 minutes in milliseconds

    init() {
        this.loadBackupsFromStorage();
        this.startAutoSave();
        console.log('✅ Backup Manager Initialized');
    },

    loadBackupsFromStorage() {
        const saved = localStorage.getItem('esh_backups');
        this.backups = saved ? JSON.parse(saved) : [];
    },

    saveBackupsToStorage() {
        localStorage.setItem('esh_backups', JSON.stringify(this.backups));
    },

    createBackup(manual = false) {
        if (!state.currentUser) return false;

        const backup = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            email: state.currentUser.email,
            projects: JSON.parse(JSON.stringify(state.projects)),
            manual: manual,
            size: JSON.stringify(state.projects).length
        };

        this.backups.unshift(backup);

        // Keep only latest backups
        if (this.backups.length > this.maxBackups) {
            this.backups = this.backups.slice(0, this.maxBackups);
        }

        this.saveBackupsToStorage();
        return backup;
    },

    startAutoSave() {
        this.autoSaveInterval = setInterval(() => {
            if (state.isLoggedIn) {
                this.createBackup(false);
                console.log('✅ Auto-backup created');
            }
        }, this.autoSaveFrequency);
    },

    stopAutoSave() {
        if (this.autoSaveInterval) {
            clearInterval(this.autoSaveInterval);
        }
    },

    getBackupsForUser(email) {
        return this.backups.filter(b => b.email === email);
    },

    restoreBackup(backupId) {
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup) {
            console.error('Backup not found');
            return false;
        }

        state.projects = JSON.parse(JSON.stringify(backup.projects));
        state.filteredProjects = [...state.projects];
        saveUserData(state.currentUser.email);
        render();
        return true;
    },

    deleteBackup(backupId) {
        this.backups = this.backups.filter(b => b.id !== backupId);
        this.saveBackupsToStorage();
        return true;
    },

    exportBackup(backupId) {
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup) return false;

        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `esh_backup_${backup.timestamp.split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        return true;
    },

    importBackup(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.projects && Array.isArray(backup.projects)) {
                        state.projects = backup.projects;
                        state.filteredProjects = [...state.projects];
                        saveUserData(state.currentUser.email);
                        this.createBackup(true);
                        render();
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                } catch (error) {
                    console.error('Error importing backup:', error);
                    resolve(false);
                }
            };
            reader.readAsText(file);
        });
    },

    formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('en-PH', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
};

function showBackupRecoveryUI() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    const lastBackup = userBackups[0];
    const lastBackupTime = lastBackup ? backupManager.formatDate(lastBackup.timestamp) : 'Never';

    let html = `
        <div class="backup-section">
            <h4><i class="fas fa-shield-alt"></i> Backup & Recovery</h4>
            
            <div class="backup-info">
                <strong>Last Auto-Backup:</strong> ${lastBackupTime}<br>
                <strong>Total Backups:</strong> ${userBackups.length} / ${backupManager.maxBackups}<br>
                <strong>Auto-save Frequency:</strong> Every 5 minutes
            </div>

            <div class="backup-buttons">
                <button class="btn btn-primary" onclick="createManualBackup()">
                    <i class="fas fa-download"></i> Create Manual Backup
                </button>
                <button class="btn btn-primary" onclick="exportCurrentBackup()">
                    <i class="fas fa-file-export"></i> Export Backup
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('import-backup-input').click()">
                    <i class="fas fa-file-import"></i> Import Backup
                </button>
            </div>

            <input type="file" id="import-backup-input" accept=".json" style="display:none;" onchange="importBackupFile(this)">

            <div id="backup-status-message"></div>

            <div class="backup-list">
                <h5 style="color: #1b5e20; margin-top: 20px; margin-bottom: 10px;">
                    <i class="fas fa-history"></i> Backup History
                </h5>
                ${userBackups.length > 0 ? userBackups.map(backup => `
                    <div class="backup-item">
                        <div class="backup-item-info">
                            <div class="backup-item-date">
                                ${backup.manual ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'} 
                                ${backupManager.formatDate(backup.timestamp)}
                            </div>
                            <div class="backup-item-size">
                                ${backupManager.formatSize(backup.size)} • 
                                ${backup.projects.length} projects
                            </div>
                        </div>
                        <div class="backup-item-actions">
                            <button class="backup-item-btn backup-item-btn-restore" onclick="restoreBackupConfirm(${backup.id})">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button class="backup-item-btn backup-item-btn-delete" onclick="deleteBackupConfirm(${backup.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('') : '<p style="color: var(--text-secondary); font-size: 0.85rem;">No backups available</p>'}
            </div>
        </div>
    `;

    return html;
}

function createManualBackup() {
    const backup = backupManager.createBackup(true);
    if (backup) {
        showBackupStatus('✅ Backup created successfully!', 'success');
        setTimeout(() => {
            changeTab('settings');
        }, 500);
    }
}

function exportCurrentBackup() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    if (userBackups.length === 0) {
        showBackupStatus('⚠️ No backups to export', 'error');
        return;
    }
    backupManager.exportBackup(userBackups[0].id);
    showBackupStatus('✅ Backup exported successfully!', 'success');
}

function importBackupFile(input) {
    const file = input.files[0];
    if (!file) return;

    backupManager.importBackup(file).then(success => {
        if (success) {
            showBackupStatus('✅ Backup imported and restored successfully!', 'success');
            setTimeout(() => {
                changeTab('settings');
            }, 500);
        } else {
            showBackupStatus('❌ Invalid backup file format', 'error');
        }
    });

    input.value = '';
}

function restoreBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Restore Backup',
        `Restore data from ${backupManager.formatDate(backup.timestamp)}? Your current data will be replaced.`,
        false
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.restoreBackup(backupId)) {
                showBackupStatus('✅ Backup restored successfully!', 'success');
                setTimeout(() => {
                    changeTab('overall');
                }, 500);
            } else {
                showBackupStatus('❌ Failed to restore backup', 'error');
            }
        }
    });
}

function deleteBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Delete Backup',
        `Delete backup from ${backupManager.formatDate(backup.timestamp)}? This cannot be undone.`,
        true
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.deleteBackup(backupId)) {
                showBackupStatus('✅ Backup deleted successfully!', 'success');
                setTimeout(() => {
                    changeTab('settings');
                }, 500);
            } else {
                showBackupStatus('❌ Failed to delete backup', 'error');
            }
        }
    });
}

function showBackupStatus(message, type) {
    const statusDiv = document.getElementById('backup-status-message');
    if (!statusDiv) return;

    statusDiv.innerHTML = `<div class="backup-status ${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 4000);
}

   
        const REGIONS = ["NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       const SCHEMA = {
    'exposures': ["Total Manpower", "Total Exposed Manhour", "Total Exposed Man-hour to date", "No. of Days w/o LTA"],
    'rates': ["LTIR","TRIR","SEVERITY RATE"],
    'medical': ["Medical Treatment","First Aid","LTA","Fatality","High-Potential incident", "Dangerous Occurrences"],
    'nov': ["Internal Issues", "External Issues"],
    'environment': ["Internal Issues", "External Issues"],
    'activities': ["No. of ESH Committee Conducted", "No. of ESH inspection", "No. of Identified Near-Miss","Drills Conducted", "Training Conducted"],
    'kpm': ["KPM&I"],
    'audit': ["Score Implementation", "Documentation and Compliance"],
    'dole': ["RSO", "MOM"],
    'dole_annual': ["AEDR", "AMR"],
    'emb': ["SMR (Quarterly)", "CMR (Semi-Annual)"],
    'cshp': ["CSHP Approval Date"],
    'reg': ["DOLE Certificate of Registration Date"]
};

        const FULL_PROJECT_LIST = {
            "NCR": ["ANGAT", "CENTRAL OFFICE", "HDD MERALCO", "MERALCO HDD SOUTH", "MRT 7", "56ML RESERVOIR"],
            "SOUTH LUZON": ["ACCESS ROAD 335MW", "EAST BAY", "KALAYAAN CBOP", "KALAYAAN EBOP", "ROLLING MILL (LEMERY)", "TR4", "500kV PAETE SUBSTATION"],
            "NORTH LUZON": ["BALOG-BALOG", "BAMBAN-HANN", "CASTILLEJOS", "COCA COLA", "KAPANGAN", "MORONG - BCDA", "SAN SIMON", "TUMAUINI", "UPS CLARK"],
            "VISAYAS & MINDANAO": ["CABULIG 2", "CALAPE BOHOL", "CLARIN", "HIBALE BOHOL", "LEYTE PHASE 2", "MALADUGAO", "MALITBOG", "MANGIMA", "MAT-I", "SIGUIL HEPP"]
        };

        let state = {
            isLoggedIn: false,
            isEditing: false,
            currentTab: 'overall',
            currentUser: null,
            projects: [],
            personnelData: [],
            incidentRateData: { recordableCases: 0, lostDays: 0, totalHours: 0 },
            filteredProjects: [],
            selectedProjects: [],
            charts: {},
            currentSort: 'name',
            darkMode: false
        };

        // ===== DARK MODE FUNCTIONS =====
        function initDarkMode() {
            const savedTheme = localStorage.getItem('esh_theme_preference');
            if (savedTheme === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            state.darkMode = true;
            localStorage.setItem('esh_theme_preference', 'dark');
            updateThemeIcon();
            console.log('✅ Dark mode enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            state.darkMode = false;
            localStorage.setItem('esh_theme_preference', 'light');
            updateThemeIcon();
            console.log('✅ Light mode enabled');
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // ===== LOGIN & AUTH =====
  // Firebase-connected login handler
window.handleLogin = async (event) => {
    event.preventDefault();
    const email = document.getElementById('login-user').value.trim().toLowerCase();
    const password = document.getElementById('login-pass').value;
    const errorDiv = document.getElementById('login-error');
    const loginBtn = document.getElementById('login-btn');

    errorDiv.innerText = '';

    if (!email || !password) {
        errorDiv.innerText = '⚠️ Please enter both email and password';
        return;
    }

    // Basic input validation
    if (password.length < 6) {
        errorDiv.innerText = '⚠️ Password must be at least 6 characters';
        return;
    }

    loginBtn.disabled = true;
    loginBtn.innerHTML = '<span class="loading-spinner"></span> Authenticating...';

    try {
        // Wait for Firebase to be ready
        await waitForFirebase();

        if (!window.firebase || !window.firebaseAuth) {
            errorDiv.innerText = '❌ Authentication service unavailable. Please refresh.';
            return;
        }

        const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        const user = userCredential.user;

        // onAuthStateChanged will handle the rest (showUI, loadFromFirebase, etc.)
        console.log('✅ Firebase Login successful:', user.email);

    } catch (error) {
        console.error('Login Error:', error.code);
        if (
            error.code === 'auth/invalid-credential' ||
            error.code === 'auth/user-not-found' ||
            error.code === 'auth/wrong-password' ||
            error.code === 'auth/invalid-email'
        ) {
            errorDiv.innerText = '❌ Invalid email or password.';
        } else if (error.code === 'auth/too-many-requests') {
            errorDiv.innerText = '⚠️ Too many failed attempts. Please try again later.';
        } else if (error.code === 'auth/network-request-failed') {
            errorDiv.innerText = '❌ Network error. Please check your connection.';
        } else {
            errorDiv.innerText = '❌ Login failed. Please try again.';
        }
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
    }
};

// Forgot Password Handler
async function handleForgotPassword(event) {
    event.preventDefault();
    const emailInput = document.getElementById('login-user');
    const email = emailInput ? emailInput.value.trim().toLowerCase() : '';

    if (!email) {
        const errorDiv = document.getElementById('login-error');
        if (errorDiv) errorDiv.innerText = '⚠️ Please enter your email address first.';
        return;
    }

    await waitForFirebase();
    const success = await firebaseResetPassword(email);
    if (success) {
        const errorDiv = document.getElementById('login-error');
        if (errorDiv) {
            errorDiv.style.color = '#1b5e20';
            errorDiv.innerText = '✅ Password reset email sent! Check your inbox.';
        }
    }
}

function handleLogout() {
    showModernDialog('Logout Confirmation', 'Are you sure you want to logout?').then(async confirmed => {
        if (confirmed) {
            backupManager.stopAutoSave();
            // Save data before logout
            await saveToFirebase();
            // Firebase sign out
            await firebaseLogout();
            // Clear local session state
            state.isLoggedIn = false;
            state.currentUser = null;
            sessionStorage.clear();
            location.reload();
        }
    });
}

function loadUserData(email) {
            // Data loading is handled via loadFromFirebase() in setupAuthObserver
            // This function is kept for compatibility but delegates to Firebase
            if (firebaseReady) {
                loadFromFirebase();
            }
        }

        function initializeUserProjects(email) {
            state.projects = [];
            Object.keys(FULL_PROJECT_LIST).forEach(reg => {
                FULL_PROJECT_LIST[reg].forEach(name => {
                    state.projects.push({
                        name,
                        region: reg,
                        status: 'on-going',
                        dateStarted: '',
                        dateFinished: '',
                        vals: {},
                        selected: false
                    });
                });
            });
            sortProjects('name');
            saveUserData(email);
        }

function saveUserData(email) {
            if (!email) return;
            // Data is persisted to Firebase (saveToFirebase), not localStorage
            // Trigger Firebase save - this is the authoritative store
            if (firebaseReady) {
                saveToFirebase();
            }
        }

        function sortProjects(sortBy) {
            state.currentSort = sortBy;
            state.projects.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'dateStarted') {
                    const da = new Date(a.dateStarted || '9999-12-31');
                    const db = new Date(b.dateStarted || '9999-12-31');
                    return da - db;
                }
                if (sortBy === 'dateFinished') {
                    const da = new Date(a.dateFinished || '9999-12-31');
                    const db = new Date(b.dateFinished || '9999-12-31');
                    return da - db;
                }
                return 0;
            });
            state.filteredProjects = [...state.projects];
            saveUserData(state.currentUser?.email);
            render();
        }

        function openAddProjectModal(region) {
            document.getElementById('projectNameInput').value = '';
            document.getElementById('projectDateStarted').value = '';
            document.getElementById('projectDateFinished').value = '';
            document.getElementById('projectRegion').value = region || '';
            document.getElementById('projectModalError').innerText = '';
            document.getElementById('addProjectModal').classList.add('show');
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('show');
        }

        function confirmAddProject() {
            const name = document.getElementById('projectNameInput').value.trim();
            const dateStarted = document.getElementById('projectDateStarted').value;
            const dateFinished = document.getElementById('projectDateFinished').value;
            const region = document.getElementById('projectRegion').value;
            const errorDiv = document.getElementById('projectModalError');

            errorDiv.innerText = '';

            if (!name) { errorDiv.innerText = '⚠️ Project name is required'; return; }
            if (!dateStarted) { errorDiv.innerText = '⚠️ Date started is required'; return; }
            if (!region) { errorDiv.innerText = '⚠️ Region is required'; return; }
            if (dateFinished && new Date(dateFinished) < new Date(dateStarted)) {
                errorDiv.innerText = '⚠️ Date finished cannot be before date started'; return;
            }
            if (state.projects.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                errorDiv.innerText = '⚠️ Project name already exists'; return;
            }

            state.projects.push({
    name, region, status: 'on-going',
    dateStarted, dateFinished, vals: {}, selected: false,
    auditData: {
        Q1: { scoreImpl: 0, docuComp: 0 },
        Q2: { scoreImpl: 0, docuComp: 0 },
        Q3: { scoreImpl: 0, docuComp: 0 },
        Q4: { scoreImpl: 0, docuComp: 0 }
    }
});

            sortProjects(state.currentSort);
            saveUserData(state.currentUser.email);
            closeAddProjectModal();
            render();
        }

        function handleSearch() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const region = document.getElementById('region-filter').value;
            const status = document.getElementById('status-filter').value;

            state.filteredProjects = state.projects.filter(p =>
                p.name.toLowerCase().includes(search) &&
                (!region || p.region === region) &&
                (!status || p.status === status)
            );
            render();
        }

        function handleFilter() { handleSearch(); }

        function toggleEdit() {
            state.isEditing = true;
            document.getElementById('search-input').style.display = 'block';
            document.getElementById('region-filter').style.display = 'block';
            document.getElementById('status-filter').style.display = 'block';
            document.getElementById('btn-csv').style.display = 'block';
            document.getElementById('btn-pdf').style.display = 'block';
            document.getElementById('edit-btn').classList.add('hidden');
            document.getElementById('save-btn').classList.remove('hidden');
            render();
        }

        function saveData() {
            state.isEditing = false;
            document.getElementById('search-input').style.display = 'none';
            document.getElementById('region-filter').style.display = 'none';
            document.getElementById('status-filter').style.display = 'none';
            document.getElementById('btn-csv').style.display = 'none';
            document.getElementById('btn-pdf').style.display = 'none';
            saveUserData(state.currentUser.email);
            document.getElementById('edit-btn').classList.remove('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            render();
        }

        function changeTab(t) {
            state.currentTab = t;
            document.querySelectorAll('.nav-item').forEach(n =>
                n.classList.toggle('active', n.dataset.tab === t)
            );
            const titles = {
                'overall': 'OVERALL DASHBOARD', 'exposures': 'TOTAL EXPOSURES',
                'rates': 'STATISTICS RATE', 'medical': 'ACCIDENT/ INCIDENT RECORD',
		'nov': 'OSH NOTICE OF VIOLATION ISSUED',
                'environment': 'ENVIRONMENTAL NOTICE OF VIOLATION ISSUED', 'activities': 'ESH ACTIVITIES AND PROGRAMS','kpm': 'MONTHLY REPORT','reg': 'DOLE CERTIFICATE OF REGISTRATION (DATE REGISTERED)','audit': 'INTERNAL ESH AUDIT REPORT',
                'cshp': 'CONSTRUCTION SAFETY & HEALTH PROGRAM (DATE APPROVED)', 'dole': 'DOLE REPORTORIAL','emb': ["SMR (Quarterly)", "CMR (Semi-Annual)"],
                'personnel': 'ESH PERSONNEL MONITORING', 'incident-rate': 'INCIDENT TABULATION RATE', 'settings': 'SETTINGS'
            };
            document.querySelector('.header-title').innerText = titles[t] || t.toUpperCase();
            document.getElementById('settings-view').classList.toggle('hidden', t !== 'settings');
            document.getElementById('personnel-view').classList.toggle('hidden', t !== 'personnel');
            document.getElementById('incident-rate-view').classList.toggle('hidden', t !== 'incident-rate');
            document.getElementById('dashboard-content').classList.toggle('hidden', t === 'settings' || t === 'personnel' || t === 'incident-rate');
            
            if (t === 'settings') {
                document.getElementById('current-email').value = state.currentUser?.email || '';
                const backupSection = document.getElementById('backup-recovery-section');
                if (backupSection) {
                    backupSection.innerHTML = showBackupRecoveryUI();
                }
            }
            
            if (t === 'personnel') renderPTable();
            if (t === 'incident-rate') loadIncidentRateData();
            
            render();
        }

function updateAuditData(pName, qtr, field, val) {
    const p = state.projects.find(x => x.name === pName);
    if (p) {
        if (!p.auditData) {
            p.auditData = {
                Q1: { scoreImpl: 0, docuComp: 0 }, Q2: { scoreImpl: 0, docuComp: 0 },
                Q3: { scoreImpl: 0, docuComp: 0 }, Q4: { scoreImpl: 0, docuComp: 0 }
            };
        }
        p.auditData[qtr][field] = parseFloat(val) || 0;
        render(); // Para mag-update ang computation ng average sa screen
    }
}

        function updateVal(pName, key, mIdx, val) {
            const p = state.projects.find(x => x.name === pName);
            if (p) {
                if (!p.vals[key]) p.vals[key] = new Array(13).fill("");
                p.vals[key][mIdx] = val;
            }
        }

        function deleteProject(projectName) {
    showModernDialog('Delete Project', `Are you sure you want to delete "${projectName}"? This action cannot be undone.`, true).then(confirmed => {
        if (confirmed) {
            state.projects = state.projects.filter(p => p.name !== projectName);
            state.filteredProjects = state.filteredProjects.filter(p => p.name !== projectName);
            saveUserData(state.currentUser.email);
            render();
        }
    });
}

     function changeProjectStatus(projectName, event) {
    event.stopPropagation();
    const project = state.projects.find(p => p.name === projectName);
    if (!project) return;
    
    // Close any existing dropdown
    closeAllStatusDropdowns();
    
    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    
    const statuses = [
        { value: 'on-going', label: 'On-Going' },
        { value: 'work-stoppage', label: 'Work Stoppage' },
        { value: 'finished', label: 'Finished' }
    ];
    
    statuses.forEach(status => {
        const btn = document.createElement('button');
        btn.textContent = status.label;
        btn.style.fontWeight = project.status === status.value ? '700' : '400';
        btn.onclick = () => {
            project.status = status.value;
            saveUserData(state.currentUser.email);
            closeAllStatusDropdowns();
            render();
        };
        dropdown.appendChild(btn);
    });
    
    const badge = event.target;
    const rect = badge.getBoundingClientRect();
    
    dropdown.style.position = 'fixed';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    dropdown.style.left = rect.left + 'px';
    
    document.body.appendChild(dropdown);
}

function closeAllStatusDropdowns() {
    document.querySelectorAll('.status-dropdown').forEach(d => d.remove());
}

        function getPerc(proj) {
            let total = 0, filled = 0;
            ["exposures", "rates", "medical", "nov","environment", "activities", "kpm","dole","emb", "cshp","reg"].forEach(cat => {
    SCHEMA[cat].forEach(row => {
        const key = `${cat}_${row}`;
        if (cat === 'cshp' || cat === 'reg') {
            total += 1;
            if (proj.vals[key] && proj.vals[key][1]) filled++;
        } else if (cat === 'emb') {
            // EMB has special submission cycles
            if (row === "SMR (Quarterly)") {
                total += 4; // Q1, Q2, Q3, Q4
                if (proj.vals[key]) {
                    for (let i = 1; i <= 4; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            } else if (row === "CMR (Semi-Annual)") {
                total += 2; // 1st Half, 2nd Half
                if (proj.vals[key]) {
                    for (let i = 1; i <= 2; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            }
        } else {
            total += 12;
            if (proj.vals[key]) {
                for (let i = 1; i <= 12; i++) {
                    if (proj.vals[key][i] && proj.vals[key][i] !== "0" && proj.vals[key][i] !== "") filled++;
                }
            }
        }
    });
});
            return total > 0 ? Math.round((filled / total) * 100) : 0;
        }

        function calculateYTD(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) sum += val;
            }
            return sum;
        }

        function calculateAverage(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            let count = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) {
                    sum += val;
                    count++;
                }
            }
            return count > 0 ? Math.round(sum / count) : 0;
        }

        function renderCharts() {
            const regionData = {};
            REGIONS.forEach(r => regionData[r] = [0, 0]);
            state.projects.forEach(p => {
                const perc = getPerc(p);
                regionData[p.region][0] += perc;
                regionData[p.region][1] += 1;
            });

            const regionAvgs = REGIONS.map(r => regionData[r][1] > 0 ? Math.round(regionData[r][0] / regionData[r][1]) : 0);
            const statusCounts = { 'on-going': 0, 'work-stoppage': 0, 'finished': 0 };
            state.projects.forEach(p => statusCounts[p.status]++);

            Object.values(state.charts).forEach(chart => { if (chart) chart.destroy(); });
            state.charts = {};

            setTimeout(() => {
                const regionCtx = document.getElementById('regionChart');
                if (regionCtx) {
                    const existingChart = Chart.getChart(regionCtx);
                    if (existingChart) existingChart.destroy();
                    state.charts.region = new Chart(regionCtx, {
                        type: 'bar',
                        data: {
                            labels: REGIONS,
                            datasets: [{
                                label: 'Compliance %',
                                data: regionAvgs,
                                backgroundColor: '#1b5e20',
                                borderColor: '#0a2e10',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, max: 100 } }
                        }
                    });
                }

                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    state.charts.status = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['On-Going', 'Work Stoppage', 'Finished'],
                            datasets: [{
                                data: [statusCounts['on-going'], statusCounts['work-stoppage'], statusCounts['finished']],
                                backgroundColor: ['#1976D2', '#d32f2f', '#616161']
                            }]
                        },
                        options: { responsive: true }
                    });
                }
            }, 100);
        }

        function exportToCSV() {
            let csv = 'Project Name,Region,Status,Date Started,Date Finished,Compliance %\n';
            state.filteredProjects.forEach(p => {
                csv += `"${p.name}","${p.region}","${p.status}","${p.dateStarted || 'N/A'}","${p.dateFinished || 'N/A'}","${getPerc(p)}%"\n`;
            });
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            a.download = `esh_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportToPDF() {
            const element = document.getElementById('dashboard-content');
            html2pdf().set({
                margin: 10, filename: `esh_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            }).from(element).save();
        }

        function showUI() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('user-badge').innerHTML = `<i class="fas fa-user-circle"></i> ${state.currentUser.email}`;
            changeTab('overall');
        }

        function render() {
            if (state.currentTab === 'settings' || state.currentTab === 'personnel' || state.currentTab === 'incident-rate') return;

            const container = document.getElementById('dashboard-content');
            let html = '';

            let grandTotal = 0;
            state.projects.forEach(p => grandTotal += getPerc(p));
            const overallAvg = state.projects.length > 0 ? Math.round(grandTotal / state.projects.length) : 0;

            if (state.currentTab === 'overall') {
                html += `<div id="grand-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL PROJECTS</div>
                        <div class="stat-value">${state.projects.length}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--safety-yellow);">
                        <div class="stat-label">OVERALL COMPLIANCE</div>
                        <div class="stat-value">${overallAvg}%</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #1976D2;">
                        <div class="stat-label">ON-GOING</div>
                        <div class="stat-value" style="color: #1976D2;">${state.projects.filter(p => p.status === 'on-going').length}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #d32f2f;">
                        <div class="stat-label">WORK STOPPAGE</div>
                        <div class="stat-value" style="color: #d32f2f;">${state.projects.filter(p => p.status === 'work-stoppage').length}</div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box"><h3><i class="fas fa-chart-bar"></i> Compliance by Region</h3><canvas id="regionChart"></canvas></div>
                    <div class="chart-box"><h3><i class="fas fa-chart-pie"></i> Project Status</h3><canvas id="statusChart"></canvas></div>
                </div>`;
                renderCharts();
            }

            const displayProjects = state.filteredProjects.length > 0 ? state.filteredProjects : state.projects;

            REGIONS.forEach(reg => {
                const projs = displayProjects.filter(p => p.region === reg);
                if (projs.length === 0) return;

                const regSum = projs.reduce((sum, p) => sum + getPerc(p), 0);
                const regionAvg = Math.round(regSum / projs.length);

                html += `<div class="region-banner">
                    <div><i class="fas fa-location-dot"></i> ${reg} <span class="badge">${projs.length} PROJ</span> <span class="badge" style="background:#1b5e20; color:var(--safety-yellow);">AVG: ${regionAvg}%</span></div>
                    ${state.isEditing ? `<button onclick="openAddProjectModal('${reg}')" class="btn btn-primary">+ ADD PROJECT</button>` : ''}
                    ${state.currentTab === 'overall' ? `<select class="sort-select" onchange="sortProjects(this.value)">
                        <option value="name" ${state.currentSort === 'name' ? 'selected' : ''}>Sort: Name</option>
                        <option value="dateStarted" ${state.currentSort === 'dateStarted' ? 'selected' : ''}>Sort: Date Started</option>
                        <option value="dateFinished" ${state.currentSort === 'dateFinished' ? 'selected' : ''}>Sort: Date Finished</option>
                    </select>` : ''}
                </div>`;

                projs.forEach(p => {
                    const perc = getPerc(p);
                    const statusClass = p.status === 'on-going' ? 'status-ongoing' : p.status === 'work-stoppage' ? 'status-stoppage' : 'status-finished';
                    const statusLabel = p.status === 'on-going' ? 'On-Going' : p.status === 'work-stoppage' ? 'Work Stoppage' : 'Finished';

                    html += `<div class="project-row">
                        ${state.isEditing ? `<input type="checkbox" class="project-checkbox" ${p.selected ? 'checked' : ''} onchange="toggleProjectSelect('${p.name}')">` : ''}
                        <div class="circular-progress" style="--percentage: ${perc * 3.6}deg;">
                            <div class="circular-progress-inner">${perc}%</div>
                        </div>
                        <div class="project-info">
                            <div class="project-name">${p.name}</div>
                            <div class="project-meta">Safety Compliance</div>
                        </div>
                        <div class="project-dates">
                            <div><span class="date-label">Started:</span> ${p.dateStarted ? new Date(p.dateStarted).toLocaleDateString() : 'Not set'}</div>
                            <div><span class="date-label">Finished:</span> ${p.dateFinished ? new Date(p.dateFinished).toLocaleDateString() : 'Ongoing'}</div>
                        </div>
                        <span class="status-badge ${statusClass}" onclick="changeProjectStatus('${p.name}', event)">${statusLabel}</span>
                        ${state.isEditing ? `<button class="btn btn-danger" onclick="deleteProject('${p.name}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;

if (state.currentTab === 'audit') {
    html += `<div class="table-container">
        <style>
            .audit-table {
                border-collapse: collapse;
                width: 100%;
                max-width: 1000px;
                margin: 10px 0;
                font-family: Arial, sans-serif;
                border: 0.5px solid #d1d1d1;
            }
            /* Green Header style base sa image */
            .audit-table thead th {
                background-color: #2e7d32; /* Dark green background */
                color: #ffffff;            /* White text */
                font-weight: bold;
                text-transform: uppercase;
                font-size: 11px;
                padding: 10px 4px;
                border: 0.5px solid #1b5e20;
            }
            .audit-table td { 
                border: 0.5px solid #d1d1d1;
                text-align: center; 
                vertical-align: middle; 
                padding: 4px;
                font-size: 12px;
            }
            /* Row highlight para sa alternating colors */
            .audit-table tbody tr {
                background-color: #ffffff;
            }
            /* Specific cell adjustments */
            .cell-white { background-color: #ffffff; }
            .cell-avg-gray { background: #808080 !important; color: white !important; font-weight: bold; }
            .cell-grand-total { background-color: #ffff00 !important; color: #000000 !important; font-weight: bold; }
            
            .audit-table input { 
                text-align: center; 
                width: 45px;
                border: 0.5px solid #ccc;
                border-radius: 2px;
                font-size: 11px;
                padding: 2px;
            }
            .audit-table p { margin: 0; padding: 0; font-size: 10px; }
        </style>
        
        <table class="audit-table">
            <thead>
                <tr>
                    <th colspan="3">Q1 (JAN-MAR)</th>
                    <th colspan="3">Q2 (APR-JUN)</th>
                    <th colspan="3">Q3 (JUL-SEP)</th>
                    <th colspan="3">Q4 (OCT-DEC)</th>
                    <th rowspan="3" class="cell-grand-total" style="border: 0.5px solid #d1d1d1;">GRAND<br>TOTAL AVG</th>
                </tr>
                <tr>
                    <th colspan="3">Score</th>
                    <th colspan="3">Score</th>
                    <th colspan="3">Score</th>
                    <th colspan="3">Score</th>
                </tr>
                <tr>
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                    
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                    
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                    
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                </tr>
            </thead>
            <tbody>
                <tr>`;

    const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
    let totalYearAvg = 0;
    
    quarters.forEach(q => {
        const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
        const qAvg = (audit.scoreImpl + audit.docuComp) / 2;
        totalYearAvg += qAvg;

        html += `
            <td class="cell-white"><input type="number" value="${audit.scoreImpl}" ${state.isEditing ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)"></td>
            <td class="cell-white"><input type="number" value="${audit.docuComp}" ${state.isEditing ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)"></td>
            <td class="cell-avg-gray">${qAvg.toFixed(2)}</td>`;
    });

    html += `<td class="cell-grand-total">${(totalYearAvg / 4).toFixed(2)}</td>
                </tr>
            </tbody>
        </table>
    </div>`;
}
                  if (state.currentTab !== 'overall' && state.currentTab !== 'audit') {
    const isDateType = ['kpm','dole','emb','cshp','reg'].includes(state.currentTab);
    const isCshp = state.currentTab === 'cshp'|| state.currentTab === 'reg';
    const hasYTD = ['exposures', 'rates', 'medical', 'nov','environment', 'activities'].includes(state.currentTab);

    html += `<div class="table-container"><table>`;
    html += `<tr><th style="width:250px; text-align:left;">TYPE</th>`;

    if (isCshp) {
        const headerText = (state.currentTab === 'cshp') ? "DATE APPROVED" : "DATE REGISTERED";
        html += `<th>${headerText}</th>`;
    } else {
        // Previous column header
        if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb') {
            html += `<th class="prev-year">PREVIOUS</th>`;
        }

        // Main columns
        if (state.currentTab === 'emb') {
            html += `<th>Q1 (JAN-MAR)</th>`;
            html += `<th>Q2 (APR-JUN)</th>`;
            html += `<th>Q3 (JUL-SEP)</th>`;
            html += `<th>Q4 (OCT-DEC)</th>`;
            html += `<th>1ST HALF (JAN-JUN)</th>`;
            html += `<th>2ND HALF (JUL-DEC)</th>`;
        } else {
            MONTHS.forEach(m => html += `<th>${m}</th>`);
        }

        if (hasYTD) {
            html += `<th class="ytd-header">RUNNING YTD</th>`;
        }
    }

    html += `</tr>`;

    SCHEMA[state.currentTab].forEach((row, rowIdx) => {
        const key = `${state.currentTab}_${row}`;
        html += `<tr><td style="text-align:left; font-weight:600; background:var(--border-color);">${row}</td>`;

        if (isCshp) {
            const v = p.vals[key] ? p.vals[key][1] : "";
            html += `<td><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>`;
        } else {
            // Previous Year Column
            const prevVal = p.vals[key] ? p.vals[key][0] : "";
            
            if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb') {
                html += `<td class="prev-year">
                    <input type="${isDateType ? 'date' : 'number'}"
                        value="${prevVal}"
                        ${state.isEditing ? '' : 'disabled'}
                        oninput="updateVal('${p.name}','${key}',0,this.value)">
                </td>`;
            }
            
            // Main data columns
            if (state.currentTab === 'emb') {
                // EMB Reportorial - Quarterly or Semi-Annual
                if (row === "SMR (Quarterly)") {
                    // Q1, Q2, Q3, Q4
                    for (let i = 1; i <= 4; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="monthly-data"><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                    // Add empty cells for semi-annual columns
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                } else if (row === "CMR (Semi-Annual)") {
                    // Add empty cells for quarterly columns
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                    // 1st Half (JAN-JUN), 2nd Half (JUL-DEC)
                    for (let i = 1; i <= 2; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="monthly-data"><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                }
            } else {
                // Monthly Columns for other tabs
                for (let i = 1; i <= 12; i++) {
                    const v = p.vals[key] ? p.vals[key][i] : "";
                    html += `<td class="monthly-data"><input type="${isDateType ? 'date' : 'number'}" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                }
            }
            
            // Add Running YTD column
            if (hasYTD) {
                let ytdValue = 0;
                if (row === "Total Manpower") {
                    ytdValue = calculateAverage(p.vals[key], rowIdx);
                    html += `<td class="average-cell">${ytdValue}</td>`;
                } else {
                    ytdValue = calculateYTD(p.vals[key], rowIdx);
                    html += `<td class="ytd-cell">${ytdValue}</td>`;
                }
            }
        }
        html += `</tr>`;
    });
    html += `</table></div>`;
    
    // ANNUAL REPORTS SECTION (for DOLE only)
    if (state.currentTab === 'dole' && SCHEMA.dole_annual) {
        html += `<div style="margin-top: 30px;">`;
        html += `<div style="background: var(--header-grad); color: white; padding: 10px 15px; border-radius: 6px; font-weight: 700; margin-bottom: 10px;">
                    📅 ANNUAL REPORTS (Submitted Every January)
                 </div>`;
        html += `<div class="table-container"><table>`;
        html += `<tr><th style="width:250px; text-align:left;">TYPE</th><th>DATE SUBMITTED</th></tr>`;
        
        SCHEMA.dole_annual.forEach((row, rowIdx) => {
            const key = `dole_annual_${row}`;
            const v = p.vals[key] ? p.vals[key][1] : "";
            html += `<tr>
                <td style="text-align:left; font-weight:600; background:var(--border-color);">${row}</td>
                <td><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
            </tr>`;
        });
        
        html += `</table></div></div>`;
    }
}

        });
            });

            container.innerHTML = html;
        }


        
// Close dropdowns when clicking elsewhere
document.addEventListener('click', closeAllStatusDropdowns);
        function toggleProjectSelect(projectName) {
            const project = state.filteredProjects.find(p => p.name === projectName);
            if (project) project.selected = !project.selected;
        }

async function updatePassword() {
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const msgDiv = document.getElementById('settings-message');

            msgDiv.innerHTML = '';
            if (!newPass || !confirmPass) {
                msgDiv.innerHTML = '<div class="error-message">⚠️ Please fill both fields</div>';
                return;
            }
            if (newPass !== confirmPass) {
                msgDiv.innerHTML = '<div class="error-message">❌ Passwords do not match</div>';
                return;
            }
            if (newPass.length < 6) {
                msgDiv.innerHTML = '<div class="error-message">❌ Password must be at least 6 characters</div>';
                return;
            }
            // Check for strong password
            const hasUpper = /[A-Z]/.test(newPass);
            const hasNumber = /[0-9]/.test(newPass);
            if (!hasUpper || !hasNumber) {
                msgDiv.innerHTML = '<div class="error-message">⚠️ Password must contain at least one uppercase letter and one number</div>';
                return;
            }
            // Call Firebase to actually change the password
            const success = await firebaseChangePassword(newPass);
            if (success) {
                msgDiv.innerHTML = '<div class="success-message">✅ Password updated in Firebase!</div>';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            }
        }

        setInterval(() => {
            const now = new Date();
            const dateEl = document.getElementById('live-date');
            const clockEl = document.getElementById('live-clock');
            if (dateEl) dateEl.innerText = now.toLocaleDateString('en-PH', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).toUpperCase();
            if (clockEl) clockEl.innerText = now.toLocaleTimeString('en-PH');
        }, 1000);

window.addEventListener('load', () => {
    initDarkMode();
    backupManager.init();
    // Auth state is fully managed by Firebase onAuthStateChanged (set up in setupAuthObserver)
    // No local session bypass - always require Firebase authentication
});
// Send password reset from settings
async function sendResetFromSettings() {
    const email = state.currentUser?.email;
    if (!email) return;
    const msgDiv = document.getElementById('settings-message');
    if (msgDiv) msgDiv.innerHTML = '';
    const success = await firebaseResetPassword(email);
    if (success && msgDiv) {
        msgDiv.innerHTML = '<div class="success-message">✅ Reset email sent to ' + email + '</div>';
    }
}

// Security helper: sanitize user-provided strings before inserting into HTML
function sanitizeHTML(str) {
    if (typeof str !== 'string') return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
}

function showModernDialog(title, message, isDanger = false) {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'modern-dialog-overlay';

        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = 'modern-dialog';

        // Title
        const titleEl = document.createElement('h2');
        titleEl.className = 'modern-dialog-title';
        titleEl.textContent = title;

        // Message
        const messageEl = document.createElement('p');
        messageEl.className = 'modern-dialog-message';
        messageEl.textContent = message;

        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'modern-dialog-buttons';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modern-dialog-btn modern-dialog-btn-cancel';
        cancelBtn.textContent = 'CANCEL';
        cancelBtn.onclick = () => {
            overlay.remove();
            resolve(false);
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.className = isDanger ? 'modern-dialog-btn modern-dialog-btn-danger' : 'modern-dialog-btn modern-dialog-btn-confirm';
        confirmBtn.textContent = isDanger ? 'DELETE' : 'CONFIRM';
        confirmBtn.onclick = () => {
            overlay.remove();
            resolve(true);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(titleEl);
        dialog.appendChild(messageEl);
        dialog.appendChild(buttonsDiv);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Close on overlay click
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.remove();
                resolve(false);
            }
        };

        confirmBtn.focus();
    });
}

// --- ESH PERSONNEL MONITORING SYSTEM ---

function addPRow() {
    if (!state.personnelData) state.personnelData = [];
    state.personnelData.push({ name: '', pos: '', id: '', hired: '', current: '', prev: '', age: '', gen: '', mail: '', num: '', addr: '', len: '' });
    renderPTable();
    saveUserData(state.currentUser.email);
}

function renderPTable() {
    const tbody = document.getElementById('p-body');
    if (!tbody) return;
    const projOptions = (state.projects || []).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    tbody.innerHTML = (state.personnelData || []).map((p, i) => `
        <tr>
            <td><input type="text" value="${p.name}" onchange="state.personnelData[${i}].name=this.value"></td>
            <td>
                <select onchange="state.personnelData[${i}].pos=this.value">
                    <option>${p.pos || 'Select'}</option>
                    <option>Project Physician</option><option>ESH Head</option><option>Safety Officer I</option>
                    <option>Safety Officer II</option><option>Safety Officer III</option><option>Safety Officer IV</option>
                    <option>PCO</option><option>Project Nurse</option><option>First Aider</option><option>Others</option>
                </select>
            </td>
            <td><input type="text" value="${p.id}" onchange="state.personnelData[${i}].id=this.value"></td>
            <td><input type="date" value="${p.hired}" onchange="state.personnelData[${i}].hired=this.value"></td>
            <td>
                <select onchange="state.personnelData[${i}].current=this.value">
                    <option>${p.current || 'Select Project'}</option>
                    ${projOptions}
                </select>
            </td>
            <td><input type="text" value="${p.prev}" onchange="state.personnelData[${i}].prev=this.value"></td>
            <td><input type="number" value="${p.age}" onchange="state.personnelData[${i}].age=this.value"></td>
            <td><select onchange="state.personnelData[${i}].gen=this.value"><option>${p.gen || 'Select'}</option><option>Male</option><option>Female</option></select></td>
            <td><input type="email" value="${p.mail}" onchange="state.personnelData[${i}].mail=this.value"></td>
            <td><input type="text" value="${p.num}" onchange="state.personnelData[${i}].num=this.value"></td>
            <td><input type="text" value="${p.addr}" onchange="state.personnelData[${i}].addr=this.value"></td>
            <td><input type="text" value="${p.len}" onchange="state.personnelData[${i}].len=this.value"></td>
            <td><button class="btn btn-danger" onclick="state.personnelData.splice(${i},1);renderPTable()"><i class="fas fa-trash"></i></button></td>
        </tr>
    `).join('');
}

function filterP() {
    const term = document.getElementById('p-search').value.toLowerCase();
    const rows = document.querySelectorAll('#p-body tr');
    rows.forEach(row => row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none');
}

// --- INCIDENT TABULATION RATE SYSTEM ---

function calculateIncidentRates() {
    const recordableCases = parseFloat(document.getElementById('recordable-cases').value) || 0;
    const lostDays = parseFloat(document.getElementById('lost-days').value) || 0;
    const totalHours = parseFloat(document.getElementById('total-hours').value) || 0;

    // Save to state
    state.incidentRateData = {
        recordableCases: recordableCases,
        lostDays: lostDays,
        totalHours: totalHours
    };

    // Auto-save
    saveUserData(state.currentUser.email);

    // Prevent division by zero
    if (totalHours === 0) {
        document.getElementById('ltir-osha').textContent = '0';
        document.getElementById('ltir-oshs').textContent = '0';
        document.getElementById('trir-osha').textContent = '0';
        document.getElementById('trir-oshs').textContent = '0';
        document.getElementById('severity-osha').textContent = '0';
        document.getElementById('severity-oshs').textContent = '0';
        return;
    }

    // LTIR Calculations (OSHA: 200,000 / OSHS: 1,000,000)
    const ltirOsha = (recordableCases * 200000) / totalHours;
    const ltirOshs = (recordableCases * 1000000) / totalHours;

    // TRIR Calculations (same formula as LTIR)
    const trirOsha = (recordableCases * 200000) / totalHours;
    const trirOshs = (recordableCases * 1000000) / totalHours;

    // Severity Rate Calculations
    const severityOsha = (lostDays * 200000) / totalHours;
    const severityOshs = (lostDays * 1000000) / totalHours;

    // Display results (rounded to 2 decimal places)
    document.getElementById('ltir-osha').textContent = ltirOsha.toFixed(2);
    document.getElementById('ltir-oshs').textContent = ltirOshs.toFixed(2);
    document.getElementById('trir-osha').textContent = trirOsha.toFixed(2);
    document.getElementById('trir-oshs').textContent = trirOshs.toFixed(2);
    document.getElementById('severity-osha').textContent = severityOsha.toFixed(2);
    document.getElementById('severity-oshs').textContent = severityOshs.toFixed(2);
}

function loadIncidentRateData() {
    if (!state.incidentRateData) {
        state.incidentRateData = { recordableCases: 0, lostDays: 0, totalHours: 0 };
    }

    document.getElementById('recordable-cases').value = state.incidentRateData.recordableCases || 0;
    document.getElementById('lost-days').value = state.incidentRateData.lostDays || 0;
    document.getElementById('total-hours').value = state.incidentRateData.totalHours || 0;

    calculateIncidentRates();
}


// ==================== COMPLETE FIREBASE INTEGRATION ====================

// Global Firebase State
let firebaseReady = false;
let firebaseUnsubscribe = null;

// Wait for Firebase to initialize
function waitForFirebase() {
    return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
            if (window.firebaseAuth && window.firebaseDb && window.firebase) {
                clearInterval(checkInterval);
                firebaseReady = true;
                resolve();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(checkInterval);
            if (!firebaseReady) {
                console.error('❌ Firebase failed to initialize');
                resolve();
            }
        }, 10000);
    });
}

// Get current user ID for Firestore
function getCurrentUserId() {
    const user = window.firebaseAuth?.currentUser;
    if (user) {
        return user.uid;
    }
    return 'local-user'; // Fallback for non-authenticated mode
}

// Save ALL data to Firebase
async function saveToFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('⏳ Firebase not ready, saving to localStorage only');
        return;
    }

    try {
        const userId = getCurrentUserId();
        const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
        
        const dataToSave = {
            email: state.currentUser?.email || 'local-user',
            projects: state.projects || [],
            personnelData: state.personnelData || [],
            incidentRateData: state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
            darkMode: state.darkMode || false,
            lastUpdated: new Date().toISOString(),
            timestamp: Date.now()
        };

        await window.firebase.setDoc(docRef, dataToSave, { merge: true });
        console.log('✅ Data saved to Firebase:', new Date().toLocaleTimeString());
        
    } catch (error) {
        console.error('❌ Error saving to Firebase:', error);
    }
}

// Load ALL data from Firebase
async function loadFromFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('⏳ Firebase not ready, loading from localStorage only');
        return;
    }

    try {
        const userId = getCurrentUserId();
        const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
        const docSnap = await window.firebase.getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Load all data
            state.projects = data.projects || [];
            state.personnelData = data.personnelData || [];
            state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
            state.darkMode = data.darkMode || false;
            state.filteredProjects = [...state.projects];
            
            // Apply dark mode
            if (state.darkMode) {
                document.body.classList.add('dark-mode');
                updateThemeIcon();
            }
            
            console.log('✅ Data loaded from Firebase');
            console.log('📊 Projects:', state.projects.length);
            console.log('👥 Personnel:', state.personnelData.length);
            
            // Update UI if already shown
            if (state.isLoggedIn) {
                render();
                renderPTable();
                if (document.getElementById('incident-rate-view') && !document.getElementById('incident-rate-view').classList.contains('hidden')) {
                    loadIncidentRateData();
                }
            }
            
        } else {
            console.log('📝 No Firebase data found, initializing new user data');
            // Initialize projects for new user
            initializeUserProjects(state.currentUser?.email || 'new-user');
            await saveToFirebase();
        }
        
    } catch (error) {
        console.error('❌ Error loading from Firebase:', error);
    }
}

// Setup Real-time Listener
function setupFirebaseListener() {
    if (!firebaseReady || !window.firebaseDb) {
        return;
    }

    try {
        const userId = getCurrentUserId();
        const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);

        // Unsubscribe from previous listener if exists
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
        }

        // Setup new listener
        firebaseUnsubscribe = window.firebase.onSnapshot(docRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                
                // Only update if timestamp is newer
                const savedTimestamp = data.timestamp || 0;
                const currentTimestamp = Date.now();
                
                if (savedTimestamp > (state.lastSyncTimestamp || 0)) {
                    state.projects = data.projects || [];
                    state.personnelData = data.personnelData || [];
                    state.incidentRateData = data.incidentRateData || {};
                    state.darkMode = data.darkMode || false;
                    state.filteredProjects = [...state.projects];
                    state.lastSyncTimestamp = savedTimestamp;
                    
                    // Apply dark mode
                    if (state.darkMode && !document.body.classList.contains('dark-mode')) {
                        document.body.classList.add('dark-mode');
                        updateThemeIcon();
                    } else if (!state.darkMode && document.body.classList.contains('dark-mode')) {
                        document.body.classList.remove('dark-mode');
                        updateThemeIcon();
                    }
                    
                    // Update UI
                    if (state.isLoggedIn) {
                        render();
                        renderPTable();
                    }
                    
                    console.log('🔄 Real-time update from Firebase');
                }
            }
        }, (error) => {
            console.error('❌ Real-time listener error:', error);
        });
        
        console.log('👂 Real-time listener active');
        
    } catch (error) {
        console.error('❌ Error setting up Firebase listener:', error);
    }
}

// Firebase Authentication Handlers
async function firebaseLogin(email, password) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('✅ Login successful:', userCredential.user.email);
        return true;
    } catch (error) {
        console.error('❌ Login error:', error);
        alert('Login failed: ' + error.message);
        return false;
    }
}

async function firebaseSignup(email, password) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('✅ Signup successful:', userCredential.user.email);
        
        // Initialize user data
        await saveToFirebase();
        
        return true;
    } catch (error) {
        console.error('❌ Signup error:', error);
        alert('Signup failed: ' + error.message);
        return false;
    }
}

async function firebaseLogout() {
    if (!window.firebase) {
        return;
    }

    try {
        await window.firebase.signOut(window.firebaseAuth);
        
        // Unsubscribe from listener
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
            firebaseUnsubscribe = null;
        }
        
        console.log('✅ Logout successful');
    } catch (error) {
        console.error('❌ Logout error:', error);
    }
}

async function firebaseChangePassword(newPassword) {
    if (!window.firebase || !window.firebaseAuth.currentUser) {
        alert('Not authenticated');
        return false;
    }

    try {
        await window.firebase.updatePassword(window.firebaseAuth.currentUser, newPassword);
        console.log('✅ Password changed successfully');
        alert('Password changed successfully!');
        return true;
    } catch (error) {
        console.error('❌ Password change error:', error);
        alert('Password change failed: ' + error.message);
        return false;
    }
}

async function firebaseResetPassword(email) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        await window.firebase.sendPasswordResetEmail(window.firebaseAuth, email);
        console.log('✅ Password reset email sent');
        alert('Password reset email sent! Check your inbox.');
        return true;
    } catch (error) {
        console.error('❌ Password reset error:', error);
        alert('Password reset failed: ' + error.message);
        return false;
    }
}

// Auth State Observer - Single source of truth for login/logout
function setupAuthObserver() {
    if (!window.firebase) {
        return;
    }

    window.firebase.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
            console.log('👤 User authenticated:', user.email);
            state.currentUser = { email: user.email, uid: user.uid };
            state.isLoggedIn = true;

            // Load user data from Firebase
            await loadFromFirebase();

            // Setup real-time sync listener
            setupFirebaseListener();

            // Show the dashboard UI
            showUI();
            initDarkMode();

        } else {
            console.log('👤 No user authenticated - showing login screen');
            state.currentUser = null;
            state.isLoggedIn = false;

            // Make sure login overlay is shown
            const overlay = document.getElementById('login-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
            }

            // Reset login button if it got stuck
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }

            // Unsubscribe from Firestore listener on logout
            if (firebaseUnsubscribe) {
                firebaseUnsubscribe();
                firebaseUnsubscribe = null;
            }
        }
    });
}

// saveUserData is already defined and calls saveToFirebase() internally.
// No override needed - Firebase save is handled directly in the function.

// Initialize Firebase Integration
waitForFirebase().then(() => {
    console.log('🔥 Firebase Ready!');
    // Setup auth observer - this is the ONLY gate for login/logout
    // It handles: showing UI on login, hiding UI on logout
    setupAuthObserver();
});

// Auto-save on page unload
window.addEventListener('beforeunload', () => {
    if (firebaseReady) {
        saveToFirebase();
    }
});

// Auto-save every 30 seconds
setInterval(() => {
    if (firebaseReady) {
        saveToFirebase();
    }
}, 30000);

console.log('🔥 Firebase integration loaded');

// ==================== END FIREBASE INTEGRATION ====================
    </script>
</body>
</html>
