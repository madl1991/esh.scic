<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESH COMPLIANCE DASHBOARD - SCIC</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%231b5e20' d='M256 0c4.6 0 9.2 1 13.4 2.9L457.7 82.8c22 9.3 38.4 31 38.3 57.2c-.5 99.2-41.3 280.7-213.6 363.2c-16.7 8-36.1 8-52.8 0C57.3 420.7 16.5 239.2 16 140c-.1-26.2 16.3-47.9 38.3-57.2L242.7 2.9C246.8 1 251.4 0 256 0z'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>


    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdqVEm3PWPuFTVbrxaP4JAZNXl2bmNUg4",
            authDomain: "esh-dashboard.firebaseapp.com",
            projectId: "esh-dashboard",
            storageBucket: "esh-dashboard.firebasestorage.app",
            messagingSenderId: "121684914529",
            appId: "1:121684914529:web:d5292a3c30f1bba2959520",
            measurementId: "G-TXYB9T0T3W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebase = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            sendPasswordResetEmail,
            doc,
            setDoc,
            getDoc,
        };

        console.log("âœ… Firebase initialized!");
    </script>
    <style>
        :root {
            --safety-green-grad: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            --header-grad: linear-gradient(90deg, #1b5e20 0%, #388e3c 100%);
            --safety-yellow: #fbc02d;
            --bg-body: #f4f7f6;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-card: #ffffff;
            --border-color: #eee;
            --table-header: #2e7d32;
            --input-bg: #fdfdfd;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --text-primary: #e4e4e4;
            --text-secondary: #b0b0b0;
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --border-color: #444;
            --table-header: #1b5e20;
            --input-bg: #3a3a3a;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { 
            margin: 0; 
            background: var(--bg-body); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        #login-overlay {
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 40%, #2e7d32 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000; 
            padding: 20px;
            overflow: hidden;
        }

        /* Animated background circles */
        #login-overlay::before {
            content: '';
            position: absolute;
            top: -20%;
            right: -10%;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(251,192,45,0.15) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        #login-overlay::after {
            content: '';
            position: absolute;
            bottom: -25%;
            left: -15%;
            width: 700px;
            height: 700px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-30px, -40px) scale(1.05); }
            50% { transform: translate(20px, 30px) scale(0.95); }
            75% { transform: translate(-20px, 20px) scale(1.02); }
        }

        /* Safety & Health Background Icons */
        .safety-bg-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.06;
            overflow: hidden;
        }

        .safety-icon-float {
            position: absolute;
            font-size: 80px;
            color: #ffffff;
            animation: floatIcon 15s ease-in-out infinite;
        }

        .safety-icon-float:nth-child(1) {
            top: 10%;
            left: 8%;
            animation-delay: 0s;
            animation-duration: 18s;
        }

        .safety-icon-float:nth-child(2) {
            top: 15%;
            right: 12%;
            animation-delay: 2s;
            animation-duration: 22s;
        }

        .safety-icon-float:nth-child(3) {
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
            animation-duration: 20s;
        }

        .safety-icon-float:nth-child(4) {
            bottom: 15%;
            right: 10%;
            animation-delay: 1s;
            animation-duration: 19s;
        }

        .safety-icon-float:nth-child(5) {
            top: 50%;
            left: 5%;
            animation-delay: 3s;
            animation-duration: 21s;
        }

        .safety-icon-float:nth-child(6) {
            top: 45%;
            right: 8%;
            animation-delay: 5s;
            animation-duration: 17s;
        }

        @keyframes floatIcon {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.06;
            }
            25% {
                transform: translateY(-30px) rotate(5deg);
                opacity: 0.08;
            }
            50% {
                transform: translateY(-20px) rotate(-5deg);
                opacity: 0.04;
            }
            75% {
                transform: translateY(-35px) rotate(3deg);
                opacity: 0.07;
            }
        }

        /* Construction/Safety Pattern Overlay */
        .safety-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.04;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(251, 192, 45, 0.3) 10px,
                    rgba(251, 192, 45, 0.3) 12px
                ),
                repeating-linear-gradient(
                    -45deg,
                    transparent,
                    transparent 10px,
                    rgba(251, 192, 45, 0.3) 10px,
                    rgba(251, 192, 45, 0.3) 12px
                );
            background-size: 100px 100px;
            background-position: 0 0, 50px 50px;
        }

        /* Warning Stripes Accent (bottom) */
        .warning-stripe {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                45deg,
                #fbc02d,
                #fbc02d 20px,
                #1b5e20 20px,
                #1b5e20 40px
            );
            opacity: 0.7;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 50px 45px;
            border-radius: 24px;
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 -5px 30px rgba(251, 192, 45, 0.2) inset;
            border-top: 4px solid #fbc02d;
            color: var(--text-primary);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body.dark-mode .login-card {
            background: rgba(45, 45, 45, 0.95);
        }

        .login-header {
            position: relative;
            margin-bottom: 35px;
        }

        .login-shield {
            width: 90px;
            height: 90px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 50%, #2e7d32 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(27, 94, 32, 0.4),
                0 0 0 8px rgba(251, 192, 45, 0.1);
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 
                    0 10px 30px rgba(27, 94, 32, 0.4),
                    0 0 0 8px rgba(251, 192, 45, 0.1);
            }
            50% {
                box-shadow: 
                    0 15px 40px rgba(27, 94, 32, 0.6),
                    0 0 0 12px rgba(251, 192, 45, 0.2);
            }
        }

        .login-shield::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbc02d, transparent, #fbc02d);
            opacity: 0.4;
            z-index: -1;
            animation: rotate 8s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .login-shield i {
            font-size: 2.5rem;
            color: #fbc02d;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .login-title {
            color: #1b5e20;
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 1.5px;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: #666;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0 0 5px 0;
            letter-spacing: 0.5px;
        }

        body.dark-mode .login-subtitle {
            color: #999;
        }

        .login-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%);
            color: #1b5e20;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 4px 14px;
            border-radius: 20px;
            letter-spacing: 1px;
            margin-top: 5px;
            box-shadow: 0 2px 8px rgba(251, 192, 45, 0.3);
        }

        .login-form {
            margin-top: 30px;
        }

        .login-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .login-input-group i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #2e7d32;
            font-size: 1rem;
            z-index: 1;
        }

        .login-card input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.95rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .login-card input:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .login-card input::placeholder {
            color: #999;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            margin-top: 25px;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(27, 94, 32, 0.3);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(27, 94, 32, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: wait;
            transform: none;
        }

        .disclaimer-box {
            background: linear-gradient(135deg, #fffbea 0%, #fff9e6 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            padding: 16px;
            margin-top: 30px;
            font-size: 0.75rem;
            color: #333;
            line-height: 1.6;
            position: relative;
            overflow: hidden;
        }

        .disclaimer-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #fbc02d;
        }

        body.dark-mode .disclaimer-box {
            background: linear-gradient(135deg, #4a4a2d 0%, #3d3d25 100%);
            color: #e4e4e4;
        }

        .disclaimer-box strong {
            color: #1b5e20;
            font-size: 0.8rem;
        }

        body.dark-mode .disclaimer-box strong {
            color: #fbc02d;
        }

        /* Firebase init loading overlay */
        #firebase-loading-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 100%);
            display: flex; align-items: center; justify-content: center; z-index: 20000; flex-direction: column; gap: 20px;
        }
        #firebase-loading-overlay .spinner {
            width: 48px; height: 48px; border: 5px solid rgba(255,255,255,0.3);
            border-top-color: #fbc02d; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        #firebase-loading-overlay p {
            color: #a5d6a7; font-size: 0.85rem; font-weight: 600; letter-spacing: 1px; margin: 0;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
            border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px;
        }

        aside {
            width: 260px; background: var(--safety-green-grad); color: white;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .nav-item {
            padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: 0.3s; font-size: 0.75rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255,255,255,0.2); border-left: 5px solid var(--safety-yellow); font-weight: 600; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; background: var(--bg-body); }
        
        header {
            background: var(--bg-card); padding: 12px 15px; border-bottom: 1px solid var(--border-color); position: sticky;
            top: 0; z-index: 90; display: flex; gap: 15px; align-items: center; justify-content: space-between;
            flex-wrap: wrap;
        }

        .header-title { font-size: 1.1rem; color: #1b5e20; font-weight: 600; }
        .header-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .header-controls input, .header-controls select {
            padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;
            background: var(--input-bg); color: var(--text-primary);
        }

        /* Dark Mode Toggle Button */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1rem;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* Floating Main Save Button */
        .main-firebase-save-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(27, 94, 32, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            transition: all 0.3s ease;
        }

        .main-firebase-save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(27, 94, 32, 0.5);
        }

        .main-firebase-save-btn:active {
            transform: translateY(-1px);
        }

        .main-firebase-save-btn.saving {
            background: #666;
            cursor: wait;
        }

        .main-firebase-save-btn .save-icon {
            font-size: 1.1rem;
        }

        .main-firebase-save-btn .pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        @media (max-width: 768px) {
            .main-firebase-save-btn {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                font-size: 0.8rem;
            }
        }


        .btn {
            padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600;
            font-size: 0.75rem; white-space: nowrap;
        }
        .btn-primary { background: var(--safety-green-grad); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background: #ccc; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-danger:hover { background: #b71c1c; }

        .region-banner {
            background: var(--header-grad); color: white; padding: 15px 20px;
            margin: 20px 20px 0; border-radius: 6px; font-weight: 700; display: flex;
            justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .badge { background: var(--safety-yellow); color: #1b5e20; padding: 4px 12px;
            border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .sort-select {
            background: rgba(255,255,255,0.2); color: white; padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 4px;
        }
        .sort-select option { background: #1b5e20; color: white; }

        .project-row {
            background: var(--bg-card); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 8px;
            margin: 0 20px 8px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
        }
        .project-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .circular-progress {
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; background: conic-gradient(#1b5e20 var(--percentage), #e0e0e0 var(--percentage));
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .circular-progress-inner {
            width: 44px; height: 44px; border-radius: 50%; background: var(--bg-card); display: flex;
            align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem; color: #1b5e20;
        }
        .project-info { display: flex; flex-direction: column; gap: 3px; flex-grow: 1; min-width: 150px; }
        .project-name { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
        .project-meta { font-size: 0.65rem; color: var(--text-secondary); }
        .project-dates { display: flex; flex-direction: column; gap: 2px; min-width: 200px; font-size: 0.65rem; }
        .date-label { font-weight: 600; color: #1b5e20; }
        .status-badge {
            padding: 6px 12px; border-radius: 4px; color: white; font-weight: 600; font-size: 0.65rem;
            cursor: pointer; text-transform: uppercase; transition: 0.2s;
        }
        .status-ongoing { background: #1976D2; }
        .status-stoppage { background: #d32f2f; }
        .status-finished { background: #616161; }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%;
            height: 100%; background: rgba(0,0,0,0.4); align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); color: var(--text-primary);
        }
        .modal-header { font-size: 1.2rem; font-weight: 700; color: #1b5e20; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem;
            background: var(--input-bg); color: var(--text-primary);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #1b5e20; box-shadow: 0 0 5px rgba(27,94,32,0.2);
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .error-message { color: #d32f2f; font-size: 0.8rem; margin-top: 10px; }
        .success-message { color: #1b5e20; font-size: 0.8rem; margin-top: 10px; font-weight: 600; }
        .hidden { display: none !important; }
        
/* Backup & Recovery Styles */
.backup-section {
    background: var(--bg-card);
    border-left: 5px solid #1b5e20;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.backup-section h4 {
    margin-top: 0;
    color: #1b5e20;
    font-size: 1rem;
}

.backup-info {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 6px;
    margin: 12px 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

body.dark-mode .backup-info {
    background: #3a3a3a;
}

.backup-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.backup-status {
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.8rem;
    margin-top: 10px;
    font-weight: 600;
}

.backup-status.success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #4caf50;
}

.backup-status.error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #f44336;
}

.backup-status.info {
    background: #e3f2fd;
    color: #1565c0;
    border-left: 4px solid #2196f3;
}

body.dark-mode .backup-status.success {
    background: #1b5e20;
    color: #81c784;
}

body.dark-mode .backup-status.error {
    background: #5a1414;
    color: #ef5350;
}

body.dark-mode .backup-status.info {
    background: #1a3a52;
    color: #64b5f6;
}

.backup-list {
    margin-top: 15px;
}

.backup-item {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    border-left: 3px solid #fbc02d;
}

body.dark-mode .backup-item {
    background: #3a3a3a;
}

.backup-item-info {
    flex-grow: 1;
}

.backup-item-date {
    font-weight: 600;
    color: var(--text-primary);
}

.backup-item-size {
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.backup-item-actions {
    display: flex;
    gap: 8px;
}

.backup-item-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: 0.2s;
}

.backup-item-btn-restore {
    background: #1b5e20;
    color: white;
}

.backup-item-btn-restore:hover {
    background: #0a2e10;
}

.backup-item-btn-delete {
    background: #d32f2f;
    color: white;
}

.backup-item-btn-delete:hover {
    background: #b71c1c;
}

.backup-progress {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    margin: 10px 0;
    overflow: hidden;
}

.backup-progress-bar {
    height: 100%;
    background: var(--safety-green-grad);
    border-radius: 3px;
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0%; }
    50% { width: 100%; }
    100% { width: 0%; }
}


/* Modern Dialog Styles */
.modern-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.modern-dialog {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
}

.modern-dialog-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 12px 0;
    color: #1b5e20;
}

.modern-dialog-message {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.modern-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modern-dialog-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
}

.modern-dialog-btn-cancel {
    background: var(--border-color);
    color: var(--text-primary);
}

.modern-dialog-btn-cancel:hover {
    background: #ccc;
}

.modern-dialog-btn-confirm {
    background: var(--safety-green-grad);
    color: white;
}

.modern-dialog-btn-confirm:hover {
    opacity: 0.9;
}

.modern-dialog-btn-danger {
    background: #d32f2f;
    color: white;
}

.modern-dialog-btn-danger:hover {
    background: #b71c1c;
}

	.status-dropdown {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 150px;
}

.status-dropdown button {
    display: block;
    width: 100%;
    padding: 10px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-primary);
    transition: 0.2s;
}

.status-dropdown button:hover {
    background: var(--border-color);
}

        /* IMPROVED TABLE STYLES */
        .table-container {
            margin: 10px 20px; overflow-x: auto; padding: 10px; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 8px;
        }
        
        table { 
            width: auto;
            min-width: 100%;
            border-collapse: collapse; 
            font-size: 0.7rem;
            table-layout: auto;
            color: var(--text-primary);
        }
        
        th { 
    background: var(--table-header); 
    color: white; 
    padding: 10px 8px; 
    border: 1px solid #1b5e20;
    white-space: nowrap;
    min-width: auto;
    width: auto;
}
        
        td { 
    border: 1px solid var(--border-color); 
    padding: 8px 6px; 
    text-align: center;
    min-width: auto;
    width: auto;
    background: var(--bg-card);
    white-space: nowrap;
}
        
        td:first-child {
            text-align: left;
            min-width: 200px;
            font-weight: 600;
            background: var(--border-color);
        }
        
        /* Previous Year Column - Light Green */
        td.prev-year {
    background: #c8e6c9;
    font-weight: 600;
    color: #2e7d32;
    min-width: auto;
    width: auto;
}

        body.dark-mode td.prev-year {
            background: #1b5e20;
            color: #a5d6a7;
        }
        
        th.prev-year {
            background: #2e7d32;
        }
        
        /* Monthly Columns - Default */
       /* Monthly Columns - Default */
td.monthly-data {
    background: var(--bg-card);
    min-width: auto;
    width: auto;
}
        
        /* YTD Column - Yellow */
        /* YTD Column - Yellow */
td.ytd-cell {
    background: #fff59d;
    font-weight: 700;
    color: #f57f17;
    min-width: auto;
    width: auto;
    padding: 8px 12px;
}
        }

        body.dark-mode td.ytd-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.ytd-header {
            background: #f9a825;
            color: white;
            min-width: 90px;
        }

        body.dark-mode th.ytd-header {
            background: #e65100;
            color: white;
        }
        
        /* Average Column - Light Yellow */
       /* Average Column - Light Yellow */
td.average-cell {
    background: #fffde7;
    font-weight: 700;
    color: #f57f17;
    min-width: auto;
    width: auto;
    padding: 8px 12px;
}

        body.dark-mode td.average-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.average-header {
            background: #fbc02d;
            color: #333;
            min-width: 90px;
        }

        body.dark-mode th.average-header {
            background: #e65100;
            color: white;
        }
        
        table input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 6px 4px;
            font-size: 0.7rem;
            text-align: center;
            font-weight: 500;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        
        table input:disabled { 
            background: transparent; 
            border: none; 
            color: var(--text-primary); 
            font-weight: 600;
        }
        
        table input[type="number"] {
    min-width: auto;
    width: auto;
    padding: 6px 4px;
}

table input[type="date"] {
    min-width: auto;
    width: auto;
    padding: 6px 4px;
}
        
        #grand-stats {
            margin: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        .stat-card {
            background: var(--bg-card); padding: 15px; border-radius: 8px; border-left: 5px solid #1b5e20;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: var(--text-primary);
        }
        .stat-value { font-size: 1.5rem; font-weight: 900; color: #1b5e20; margin-top: 5px; }
        .stat-label { font-size: 0.65rem; color: var(--text-secondary); font-weight: 700; }
        .charts-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;
            padding: 20px; margin-top: 0;
        }
        .chart-box {
            background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            color: var(--text-primary);
        }
        .chart-box h3 {
            color: #1b5e20; margin-top: 0; font-size: 0.95rem; border-bottom: 2px solid var(--safety-yellow);
            padding-bottom: 10px;
        }
        .chart-box canvas { max-height: 300px; }
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .logout-btn {
            width: 100%; background: rgba(255,255,255,0.1); color: white;
            border: 1px solid rgba(255,255,255,0.2); padding: 10px; cursor: pointer;
            font-size: 0.75rem; border-radius: 4px;
        }
        .user-badge { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 4px;
            font-size: 0.7rem; margin-top: 10px; border: 1px solid rgba(255,255,255,0.3); }

        #dashboard-content {
            color: var(--text-primary);
        }

/* I-adjust ang width ng specific DOLE columns */
.col-narrow {
    width: 1%;
    white-space: nowrap;
    padding-left: 10px !important;
    padding-right: 10px !important;
}

/* Kulay para sa disabled cells */
.cell-disabled {
    background-color: var(--border-color) !important;
    cursor: not-allowed;
    opacity: 0.6;
}

/* NOV tab: slim columns since values are 3-digit max */
.nov-narrow-th {
    min-width: 0 !important;
    width: 42px !important;
    padding: 8px 3px !important;
    font-size: 0.62rem !important;
}
.nov-narrow-td {
    min-width: 0 !important;
    width: 42px !important;
    padding: 5px 2px !important;
}
.nov-narrow-td input[type="number"] {
    width: 36px !important;
    min-width: 0 !important;
    padding: 4px 2px !important;
    font-size: 0.68rem !important;
}

/* Personnel table: locked by default, per-row Edit/Save */
#p-body td input,
#p-body td select {
    pointer-events: none;
    background: transparent !important;
    border: none !important;
    color: var(--text-primary);
    cursor: default;
    font-size: 0.72rem;
}
#p-body tr.p-editing td input,
#p-body tr.p-editing td select {
    pointer-events: auto;
    background: var(--input-bg) !important;
    border: 1px solid #2e7d32 !important;
    border-radius: 4px !important;
    cursor: text;
    padding: 4px 6px !important;
}
#p-body tr {
    border-bottom: 1px solid var(--border-color);
    transition: background 0.15s;
}
#p-body tr:nth-child(even) { background: rgba(0,0,0,0.018); }
body.dark-mode #p-body tr:nth-child(even) { background: rgba(255,255,255,0.03); }
#p-body tr:hover { background: #e8f5e9 !important; }
body.dark-mode #p-body tr:hover { background: rgba(27,94,32,0.18) !important; }
#p-body tr.p-editing { background: #f1f8e9 !important; box-shadow: inset 3px 0 0 #2e7d32; }
body.dark-mode #p-body tr.p-editing { background: rgba(27,94,32,0.25) !important; }
#p-body td { padding: 8px 10px; vertical-align: middle; border: none; color: var(--text-primary); }
#p-body td:first-child { font-weight: 600; }
.p-row-num {
    display: inline-flex; align-items:center; justify-content:center;
    width: 20px; height: 20px; border-radius: 50%;
    background: #e8f5e9; color: #2e7d32;
    font-size: 0.65rem; font-weight: 700; margin-right: 6px;
    flex-shrink: 0; vertical-align: middle;
}
body.dark-mode .p-row-num { background: #1b5e20; color: #a5d6a7; }
.p-pos-badge {
    display: inline-block; padding: 2px 7px;
    border-radius: 10px; font-size: 0.65rem; font-weight: 600;
    background: #e3f2fd; color: #1565c0; white-space: nowrap;
}
body.dark-mode .p-pos-badge { background: #1a3a52; color: #64b5f6; }
.p-gender-m { background: #e3f2fd !important; color: #1565c0 !important; }
.p-gender-f { background: #fce4ec !important; color: #c2185b !important; }
.p-edit-btn {
    padding: 5px 10px;
    background: #1976D2;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 0.68rem;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex; align-items:center; gap:4px;
    transition: 0.2s;
}
.p-edit-btn:hover { background: #1565c0; }
.p-save-btn {
    display: none;
    padding: 5px 10px;
    background: #2e7d32;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 0.68rem;
    cursor: pointer;
    font-weight: 600;
    margin-left: 3px;
    align-items:center; gap:4px;
    transition: 0.2s;
}
.p-save-btn:hover { background: #1b5e20; }
.p-del-btn {
    padding: 5px 8px;
    background: #ffebee;
    color: #d32f2f;
    border: 1px solid #ffcdd2;
    border-radius: 5px;
    font-size: 0.68rem;
    cursor: pointer;
    margin-left: 3px;
    transition: 0.2s;
}
.p-del-btn:hover { background: #d32f2f; color: white; border-color: #d32f2f; }

    </style>
</head>
<body>

    <!-- Firebase initialization loading screen -->
    <div id="firebase-loading-overlay">
        <div class="spinner"></div>
        <p>INITIALIZING SYSTEM...</p>
    </div>

	
    <div id="login-overlay" style="display:none;">
        <!-- Safety Background Elements -->
        <div class="safety-bg-icons">
            <i class="fas fa-hard-hat safety-icon-float"></i>
            <i class="fas fa-user-shield safety-icon-float"></i>
            <i class="fas fa-briefcase-medical safety-icon-float"></i>
            <i class="fas fa-fire-extinguisher safety-icon-float"></i>
            <i class="fas fa-vest safety-icon-float"></i>
            <i class="fas fa-triangle-exclamation safety-icon-float"></i>
        </div>
        <div class="safety-pattern"></div>
        <div class="warning-stripe"></div>
        
        <div class="login-card">
            <div class="login-header">
                <div class="login-shield">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <h1 class="login-title">ESH Compliance</h1>
                <p class="login-subtitle">STA. CLARA INTERNATIONAL CORPORATION</p>
                <div class="login-badge">
                    <i class="fas fa-users-gear"></i> MANAGER ACCESS PORTAL
                </div>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)" autocomplete="off">
                <div class="login-input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="login-user" placeholder="Corporate Email Address" required autocomplete="off">
                </div>
                <div class="login-input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-pass" placeholder="Password" required autocomplete="off">
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM
                </button>
            </form>
            
            <div id="login-error" class="error-message"></div>
            
            <div class="disclaimer-box">
                <strong><i class="fas fa-shield-halved"></i> AUTHORIZED ACCESS ONLY</strong><br>
                This system is exclusively for ESH Department managers and authorized personnel. 
                For account access, please contact your system administrator.
            </div>
        </div>
    </div>

    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Add New Project</span>
                <button class="modal-close" onclick="closeAddProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="projectNameInput" placeholder="Enter project name" required>
            </div>
            <div class="form-group">
                <label>Date Started *</label>
                <input type="date" id="projectDateStarted" required>
            </div>
            <div class="form-group">
                <label>Date Finished</label>
                <input type="date" id="projectDateFinished">
            </div>
            <div class="form-group">
                <label>Region *</label>
                <select id="projectRegion" required>
                    <option value="">Select Region</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                </select>
            </div>


            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddProject()">Add Project</button>
            </div>
            <div id="projectModalError" class="error-message"></div>
        </div>
    </div>

    <aside id="main-sidebar" class="hidden">
        <div class="sidebar-header">
            <div style="font-size: 1.4rem; font-weight: 900; line-height: 1.1; margin-top: 5px;">ESH <span style="color:var(--safety-yellow)">COMPLIANCE</span><br>DASHBOARD</div>
            <div id="live-date" style="font-size: 0.6rem; color: #a5d6a7; margin-top: 10px;"></div>
            <div id="live-clock" style="color: var(--safety-yellow); font-size: 0.8rem; font-weight: 700;"></div>
            <div id="user-badge" class="user-badge"></div>
        </div>
        <nav style="flex-grow: 1; padding-top: 10px;">
            <div class="nav-item active" data-tab="overall" onclick="changeTab('overall')"><i class="fas fa-chart-pie"></i> Overall Dashboard</div>
            <div class="nav-item" data-tab="exposures" onclick="changeTab('exposures')"><i class="fas fa-clock"></i> Total Exposures</div>
            <div class="nav-item" data-tab="rates" onclick="changeTab('rates')"><i class="fas fa-chart-line"></i> Statistics Rate</div>
            <div class="nav-item" data-tab="medical" onclick="changeTab('medical')"><i class="fas fa-kit-medical"></i> Accident/ Incident Record</div>
            <div class="nav-item" data-tab="activities" onclick="changeTab('activities')"><i class="fas fa-list-check"></i> ESH Activities & Programs</div>
	    <div class="nav-item" data-tab="nov" onclick="changeTab('nov')"><i class="fa-solid fa-helmet-safety"></i> Regulatory Issued NOV</div>
            <div class="nav-item" data-tab="nov-monitoring" onclick="changeTab('nov-monitoring')"><i class="fas fa-chart-bar"></i> ESH NOV Monitoring</div>
            <div class="nav-item" data-tab="kpm" onclick="changeTab('kpm')"><i class="fas fa-file-export"></i> Monthly Report</div>
	    <div class="nav-item" data-tab="audit" onclick="changeTab('audit')"><i class="fa-solid fa-square-poll-horizontal"></i> Internal ESH Audit Result</div>
            <div class="nav-item" data-tab="cshp" onclick="changeTab('cshp')"><i class="fas fa-calendar-check"></i> CSHP</div>
	    <div class="nav-item" data-tab="reg" onclick="changeTab('reg')"><i class="fas fa-calendar-check"></i> Certificate of Registration</div>
            <div class="nav-item" data-tab="dole" onclick="changeTab('dole')"><i class="fas fa-file-export"></i> DOLE Reportorial</div>
	    <div class="nav-item" data-tab="emb" onclick="changeTab('emb')"><i class="fas fa-file-export"></i> EMB Reportorial</div>
            <div class="nav-item" data-tab="personnel" onclick="changeTab('personnel')"><i class="fas fa-users-gear"></i> ESH Personnel Monitoring</div>
            <div class="nav-item" data-tab="settings" onclick="changeTab('settings')"><i class="fas fa-cog"></i> Settings</div>
        </nav>
        <div style="padding: 15px;">
            <button onclick="handleLogout()" class="logout-btn">
                <i class="fas fa-power-off"></i> LOGOUT SESSION
            </button>
        </div>
    </aside>

    <main id="main-content" class="hidden">
        <header>
            <h2 class="header-title">OVERALL DASHBOARD</h2>
            <div class="header-controls">
                <input type="text" id="search-input" placeholder="Search projects..." onkeyup="handleSearch()" style="display: none;">
                <select id="region-filter" onchange="handleFilter()" style="display: none;">
                    <option value="">All Regions</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                </select>
                <select id="status-filter" onchange="handleFilter()" style="display: none;">
                    <option value="">All Status</option>
                    <option value="on-going">On-Going</option>
                    <option value="work-stoppage">Work Stoppage</option>
                    <option value="finished">Finished</option>
                </select>
                <div style="display:flex; gap: 8px;" id="edit-controls" style="display: none;">
                    <button onclick="exportToCSV()" class="btn btn-primary" title="Export to CSV" style="display: none;" id="btn-csv">
                        <i class="fas fa-download"></i> CSV
                    </button>
                    <button onclick="exportToPDF()" class="btn btn-primary" title="Export to PDF" style="display: none;" id="btn-pdf">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
                <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <button id="edit-btn" class="btn btn-primary" onclick="toggleEdit()"><i class="fas fa-edit"></i> EDIT</button>
                <button id="save-btn" class="btn btn-primary hidden" onclick="saveData()"><i class="fas fa-save"></i> SAVE</button>
            </div>
        </header>
       

 <div id="dashboard-content"></div>



<div id="personnel-view" class="hidden" style="padding: 20px;">
    <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color);">

        <!-- Header Banner -->
        <div style="background: linear-gradient(90deg,#1b5e20 0%,#2e7d32 100%); padding: 18px 24px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fas fa-users-gear" style="font-size:1.3rem; color:var(--safety-yellow);"></i>
                <div>
                    <div style="font-size:1rem; font-weight:800; color:white; letter-spacing:0.5px;">ESH PERSONNEL MONITORING</div>
                    <div style="font-size:0.65rem; color:#a5d6a7; margin-top:2px;">Environment, Safety &amp; Health Team Registry</div>
                </div>
            </div>
            <div id="p-summary-badges" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>

        <!-- Controls Bar -->
        <div style="padding: 14px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div style="display:flex; gap:8px; flex:1; min-width:280px;">
                <select id="p-filter-column" style="padding:8px 10px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:0.75rem; min-width:150px;">
                    <option value="all">ðŸ” Filter: All Columns</option>
                    <option value="name">Full Name</option>
                    <option value="pos">Position</option>
                    <option value="id">ID Number</option>
                    <option value="current">Current Project</option>
                    <option value="gen">Gender</option>
                </select>
                <input type="text" id="p-filter-value" placeholder="Search personnel..." onkeyup="filterPTable()" style="flex:1; padding:8px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:0.75rem;">
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-primary" onclick="addPRow()" style="padding:8px 16px; display:flex; align-items:center; gap:6px; font-size:0.78rem; border-radius:6px;">
                    <i class="fas fa-user-plus"></i> Add Personnel
                </button>
                <div id="p-global-action" style="display:none; gap:6px;">
                    <button class="p-edit-btn" id="p-global-edit-btn" onclick="pGlobalEdit()" style="padding:8px 14px; border-radius:6px; display:flex; align-items:center; gap:5px; font-size:0.78rem;">
                        <i class="fas fa-edit"></i> Edit All
                    </button>
                    <button class="p-save-btn" id="p-global-save-btn" onclick="pGlobalSave()" style="padding:8px 14px; border-radius:6px; display:flex; align-items:center; gap:5px; font-size:0.78rem; display:none;">
                        <i class="fas fa-save"></i> Save All
                    </button>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div style="overflow-x:auto; padding: 0;">
            <table id="p-table" style="width:100%; border-collapse:collapse; font-size:0.72rem;">
                <thead>
                    <tr style="background: linear-gradient(90deg,#1b5e20 0%,#388e3c 100%);">
                        <th style="padding:10px 12px; color:white; text-align:left; white-space:nowrap; font-weight:700; letter-spacing:0.3px; border:none; min-width:160px;">#&nbsp;&nbsp;Full Name</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; width:145px;">Position</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:95px;">ID Number</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:110px;">Date Hired</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; min-width:160px;">Current Project</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:48px;">Age</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:80px;">Gender</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; min-width:180px;">Email</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:115px;">Contact No.</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; min-width:200px;">Home Address</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:70px;">Yrs. of Svc</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:100px;">Action</th>
                    </tr>
                </thead>
                <tbody id="p-body"></tbody>
            </table>
            <div id="p-empty" style="display:none; padding:40px; text-align:center; color:var(--text-secondary);">
                <i class="fas fa-users" style="font-size:2.5rem; opacity:0.3; margin-bottom:10px;"></i>
                <div style="font-size:0.85rem;">No personnel records yet. Click <strong>Add Personnel</strong> to get started.</div>
            </div>
        </div>

        <!-- Footer stats -->
        <div id="p-footer" style="padding:10px 20px; background:var(--border-color); border-top:1px solid var(--border-color); font-size:0.7rem; color:var(--text-secondary); display:flex; gap:20px; flex-wrap:wrap;"></div>
    </div>
</div>



        <div id="settings-view" class="hidden">
  <style>
    .settings-page { max-width: 780px; margin: 0 auto; padding: 28px 24px 80px; }
    .settings-hero {
      background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 60%, #2e7d32 100%);
      border-radius: 16px; padding: 28px 30px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px; position: relative; overflow: hidden;
    }
    .settings-hero::before {
      content: ''; position: absolute; top: -30px; right: -30px;
      width: 180px; height: 180px; border-radius: 50%;
      background: rgba(251,192,45,0.08); pointer-events: none;
    }
    .settings-hero::after {
      content: ''; position: absolute; bottom: -50px; right: 60px;
      width: 120px; height: 120px; border-radius: 50%;
      background: rgba(255,255,255,0.04); pointer-events: none;
    }
    .settings-avatar {
      width: 72px; height: 72px; border-radius: 50%;
      background: rgba(255,255,255,0.12); border: 3px solid rgba(251,192,45,0.6);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; color: #fbc02d; flex-shrink: 0;
      box-shadow: 0 0 0 6px rgba(251,192,45,0.1);
    }
    .settings-hero-info { flex: 1; }
    .settings-hero-name { font-size: 1.25rem; font-weight: 800; color: white; letter-spacing: 0.3px; }
    .settings-hero-email { font-size: 0.78rem; color: #a5d6a7; margin-top: 3px; }
    .settings-hero-badge {
      background: rgba(251,192,45,0.2); border: 1px solid rgba(251,192,45,0.4);
      color: #fbc02d; font-size: 0.65rem; font-weight: 700; padding: 3px 10px;
      border-radius: 20px; letter-spacing: 0.5px; margin-top: 8px; display: inline-block;
    }
    .settings-sync-status {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.7rem; color: #a5d6a7; margin-top: 6px;
    }
    .settings-sync-dot {
      width: 7px; height: 7px; border-radius: 50%; background: #4caf50;
      animation: pulse 2s infinite;
    }

    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    @media (max-width: 620px) { .settings-grid { grid-template-columns: 1fr; } }

    .settings-card {
      background: var(--bg-card); border-radius: 14px; overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 12px rgba(0,0,0,0.06); transition: box-shadow 0.2s;
    }
    .settings-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .settings-card-full { grid-column: 1 / -1; }
    .settings-card-header {
      background: linear-gradient(90deg, #1b5e20 0%, #2e7d32 100%);
      padding: 13px 18px; display: flex; align-items: center; gap: 10px;
    }
    .settings-card-header i { color: #fbc02d; font-size: 0.95rem; }
    .settings-card-title { color: white; font-weight: 700; font-size: 0.82rem; letter-spacing: 0.5px; }
    .settings-card-body { padding: 18px; }

    .settings-input-group { margin-bottom: 14px; position: relative; }
    .settings-input-group:last-child { margin-bottom: 0; }
    .settings-label {
      display: block; font-size: 0.72rem; font-weight: 700;
      color: var(--text-secondary); letter-spacing: 0.5px;
      text-transform: uppercase; margin-bottom: 6px;
    }
    .settings-input {
      width: 100%; padding: 11px 14px; border: 1.5px solid var(--border-color);
      border-radius: 8px; font-size: 0.85rem; background: var(--input-bg);
      color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .settings-input:focus {
      outline: none; border-color: #2e7d32;
      box-shadow: 0 0 0 3px rgba(46,125,50,0.15);
    }
    .settings-input:disabled {
      opacity: 0.65; cursor: not-allowed; background: var(--border-color);
    }
    .settings-input-icon { position: relative; }
    .settings-input-icon .settings-input { padding-right: 42px; }
    .settings-input-icon .icon-btn {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text-secondary);
      font-size: 0.9rem; padding: 4px; transition: color 0.2s;
    }
    .settings-input-icon .icon-btn:hover { color: #1b5e20; }

    .settings-btn {
      width: 100%; padding: 11px; border: none; border-radius: 8px;
      font-size: 0.82rem; font-weight: 700; cursor: pointer;
      letter-spacing: 0.5px; display: flex; align-items: center;
      justify-content: center; gap: 8px; transition: all 0.2s; margin-top: 4px;
    }
    .settings-btn-primary {
      background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
      color: white; box-shadow: 0 3px 10px rgba(27,94,32,0.3);
    }
    .settings-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(27,94,32,0.4); }
    .settings-btn-primary:disabled { opacity: 0.6; cursor: wait; transform: none; }
    .settings-btn-danger { background: #ffebee; color: #c62828; border: 1.5px solid #ffcdd2; }
    .settings-btn-danger:hover { background: #c62828; color: white; border-color: #c62828; }
    .settings-btn-outline {
      background: transparent; color: #1b5e20;
      border: 1.5px solid #2e7d32;
    }
    .settings-btn-outline:hover { background: #e8f5e9; }
    .settings-btn + .settings-btn { margin-top: 8px; }

    .settings-msg {
      margin-top: 10px; padding: 10px 14px; border-radius: 7px;
      font-size: 0.78rem; font-weight: 600; display: none;
    }
    .settings-msg.success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; display: block; }
    .settings-msg.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; display: block; }
    .settings-msg.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; display: block; }
    .settings-msg.loading { background: #f3e5f5; color: #6a1b9a; border-left: 4px solid #9c27b0; display: flex; align-items: center; gap: 8px; }

    .settings-divider { height: 1px; background: var(--border-color); margin: 14px 0; }

    .danger-zone-card .settings-card-header { background: linear-gradient(90deg, #b71c1c 0%, #d32f2f 100%); }

    .theme-options { display: flex; gap: 10px; margin-bottom: 14px; }
    .theme-option {
      flex: 1; padding: 12px 8px; border-radius: 10px; cursor: pointer;
      border: 2px solid var(--border-color); text-align: center;
      transition: all 0.2s; font-size: 0.75rem; font-weight: 600;
    }
    .theme-option:hover { border-color: #2e7d32; }
    .theme-option.active { border-color: #2e7d32; background: #e8f5e9; color: #1b5e20; }
    body.dark-mode .theme-option.active { background: rgba(46,125,50,0.2); }
    .theme-option .theme-icon { font-size: 1.5rem; margin-bottom: 5px; }

    .info-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.78rem;
    }
    .info-row:last-child { border-bottom: none; padding-bottom: 0; }
    .info-row-label { color: var(--text-secondary); font-weight: 600; }
    .info-row-value { color: var(--text-primary); font-weight: 500; }
    .firebase-status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 700;
    }
    .firebase-status-badge.connected { background: #e8f5e9; color: #2e7d32; }
    .firebase-status-badge.disconnected { background: #ffebee; color: #c62828; }

    .username-display {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: var(--input-bg); border: 1.5px solid var(--border-color);
      border-radius: 8px; margin-bottom: 4px;
    }
    .username-display-text { font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
    .username-edit-btn {
      background: none; border: none; cursor: pointer;
      color: #1976D2; font-size: 0.75rem; font-weight: 600;
      display: flex; align-items: center; gap: 4px;
    }
    .username-edit-btn:hover { color: #1565c0; }
  </style>

  <div class="settings-page">

    <!-- Hero Header -->
    <div class="settings-hero">
      <div class="settings-avatar"><i class="fas fa-user-shield"></i></div>
      <div class="settings-hero-info">
        <div class="settings-hero-name" id="settings-display-name">ESH User</div>
        <div class="settings-hero-email" id="settings-hero-email">Loading...</div>
        <div class="settings-hero-badge"><i class="fas fa-shield-halved"></i> &nbsp;ESH COMPLIANCE OFFICER</div>
        <div class="settings-sync-status">
          <span class="settings-sync-dot"></span>
          <span id="settings-firebase-sync-label">Connected to Firebase</span>
        </div>
      </div>
    </div>

    <div class="settings-grid">

      <!-- Profile / Display Name -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-id-badge"></i>
          <span class="settings-card-title">DISPLAY NAME</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">Current Display Name</label>
            <div class="username-display">
              <span class="username-display-text" id="current-display-name-text">â€”</span>
              <button class="username-edit-btn" onclick="toggleUsernameEdit()">
                <i class="fas fa-pencil"></i> Edit
              </button>
            </div>
          </div>
          <div id="username-edit-fields" style="display:none;">
            <div class="settings-input-group">
              <label class="settings-label">New Display Name</label>
              <input type="text" id="new-display-name" class="settings-input" placeholder="Enter display name" maxlength="40">
            </div>
            <button class="settings-btn settings-btn-primary" id="save-name-btn" onclick="saveDisplayName()">
              <i class="fas fa-save"></i> SAVE NAME
            </button>
          </div>
          <div id="name-msg" class="settings-msg"></div>
        </div>
      </div>

      <!-- Account Info -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-circle-info"></i>
          <span class="settings-card-title">ACCOUNT INFO</span>
        </div>
        <div class="settings-card-body">
          <div class="info-row">
            <span class="info-row-label">Email</span>
            <span class="info-row-value" id="current-email" style="font-size:0.75rem; word-break:break-all;">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Firebase UID</span>
            <span class="info-row-value" id="settings-uid" style="font-size:0.65rem; font-family:monospace; color:var(--text-secondary);">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Firebase Status</span>
            <span id="settings-firebase-status" class="firebase-status-badge connected">
              <i class="fas fa-wifi"></i> Connected
            </span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Last Sync</span>
            <span class="info-row-value" id="settings-last-sync">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Total Projects</span>
            <span class="info-row-value" id="settings-total-projects">â€”</span>
          </div>
        </div>
      </div>

      <!-- Change Password -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-lock"></i>
          <span class="settings-card-title">CHANGE PASSWORD</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">New Password</label>
            <div class="settings-input-icon">
              <input type="password" id="new-password" class="settings-input" placeholder="Min. 6 characters">
              <button class="icon-btn" onclick="togglePwd('new-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <div class="settings-input-group">
            <label class="settings-label">Confirm Password</label>
            <div class="settings-input-icon">
              <input type="password" id="confirm-password" class="settings-input" placeholder="Re-enter password">
              <button class="icon-btn" onclick="togglePwd('confirm-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <div id="pwd-strength" style="margin-bottom:10px; font-size:0.7rem; height:14px;"></div>
          <button class="settings-btn settings-btn-primary" id="update-pwd-btn" onclick="updatePassword()">
            <i class="fas fa-key"></i> UPDATE PASSWORD
          </button>
          <button class="settings-btn settings-btn-outline" style="margin-top:8px;" onclick="sendPasswordReset()">
            <i class="fas fa-envelope"></i> SEND RESET EMAIL
          </button>
          <div id="settings-message" class="settings-msg"></div>
        </div>
      </div>

      <!-- Appearance -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-palette"></i>
          <span class="settings-card-title">APPEARANCE</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">Theme</label>
            <div class="theme-options">
              <div class="theme-option" id="theme-light-btn" onclick="applyTheme('light')">
                <div class="theme-icon">â˜€ï¸</div>
                Light Mode
              </div>
              <div class="theme-option" id="theme-dark-btn" onclick="applyTheme('dark')">
                <div class="theme-icon">ðŸŒ™</div>
                Dark Mode
              </div>
            </div>
          </div>
          <div class="settings-divider"></div>
          <div class="settings-input-group" style="margin-bottom:0;">
            <label class="settings-label">Firebase Cloud Sync</label>
            <button class="settings-btn settings-btn-primary" onclick="saveToFirebaseMain()">
              <i class="fas fa-cloud-upload-alt"></i> FORCE SYNC TO CLOUD
            </button>
          </div>
        </div>
      </div>

      <!-- Backup & Recovery - Full Width -->
      <div class="settings-card settings-card-full">
        <div class="settings-card-header">
          <i class="fas fa-database"></i>
          <span class="settings-card-title">BACKUP &amp; RECOVERY</span>
        </div>
        <div class="settings-card-body">
          <div id="backup-recovery-section"></div>
        </div>
      </div>

      <!-- Danger Zone - Full Width -->
      <div class="settings-card settings-card-full danger-zone-card">
        <div class="settings-card-header">
          <i class="fas fa-triangle-exclamation"></i>
          <span class="settings-card-title">DANGER ZONE</span>
        </div>
        <div class="settings-card-body">
          <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
            <div>
              <div style="font-size:0.85rem; font-weight:700; color:var(--text-primary); margin-bottom:3px;">Sign Out of All Sessions</div>
              <div style="font-size:0.75rem; color:var(--text-secondary);">Logs you out and clears local session data.</div>
            </div>
            <button class="settings-btn settings-btn-danger" style="width:auto; padding:10px 22px;" onclick="handleLogout()">
              <i class="fas fa-right-from-bracket"></i> LOGOUT SESSION
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
            
    </main>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>

// ===== BACKUP & RECOVERY SYSTEM =====
let backupManager = {
    backups: [],
    autoSaveInterval: null,
    maxBackups: 10,
    autoSaveFrequency: 300000, // 5 minutes in milliseconds

    init() {
        this.loadBackupsFromStorage();
        this.startAutoSave();
        console.log('âœ… Backup Manager Initialized');
    },

    loadBackupsFromStorage() {
        const saved = localStorage.getItem('esh_backups');
        this.backups = saved ? JSON.parse(saved) : [];
    },

    saveBackupsToStorage() {
        localStorage.setItem('esh_backups', JSON.stringify(this.backups));
    },

    createBackup(manual = false) {
        if (!state.currentUser) return false;

        const backup = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            email: state.currentUser.email,
            projects: JSON.parse(JSON.stringify(state.projects)),
            manual: manual,
            size: JSON.stringify(state.projects).length
        };

        this.backups.unshift(backup);

        // Keep only latest backups
        if (this.backups.length > this.maxBackups) {
            this.backups = this.backups.slice(0, this.maxBackups);
        }

        this.saveBackupsToStorage();
        return backup;
    },

    startAutoSave() {
        this.autoSaveInterval = setInterval(() => {
            if (state.isLoggedIn) {
                this.createBackup(false);
                console.log('âœ… Auto-backup created');
            }
        }, this.autoSaveFrequency);
    },

    stopAutoSave() {
        if (this.autoSaveInterval) {
            clearInterval(this.autoSaveInterval);
        }
    },

    getBackupsForUser(email) {
        return this.backups.filter(b => b.email === email);
    },

    restoreBackup(backupId) {
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup) {
            console.error('Backup not found');
            return false;
        }

        state.projects = JSON.parse(JSON.stringify(backup.projects));
        state.filteredProjects = [...state.projects];
        saveUserData(state.currentUser.email);
        render();
        return true;
    },

    deleteBackup(backupId) {
        this.backups = this.backups.filter(b => b.id !== backupId);
        this.saveBackupsToStorage();
        return true;
    },

    exportBackup(backupId) {
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup) return false;

        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `esh_backup_${backup.timestamp.split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        return true;
    },

    importBackup(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.projects && Array.isArray(backup.projects)) {
                        state.projects = backup.projects;
                        state.filteredProjects = [...state.projects];
                        saveUserData(state.currentUser.email);
                        this.createBackup(true);
                        render();
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                } catch (error) {
                    console.error('Error importing backup:', error);
                    resolve(false);
                }
            };
            reader.readAsText(file);
        });
    },

    formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('en-PH', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
};

function showBackupRecoveryUI() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    const lastBackup = userBackups[0];
    const lastBackupTime = lastBackup ? backupManager.formatDate(lastBackup.timestamp) : 'Never';

    let html = `
        <div class="backup-section">
            <h4><i class="fas fa-shield-alt"></i> Backup & Recovery</h4>
            
            <div class="backup-info">
                <strong>Last Auto-Backup:</strong> ${lastBackupTime}<br>
                <strong>Total Backups:</strong> ${userBackups.length} / ${backupManager.maxBackups}<br>
                <strong>Auto-save Frequency:</strong> Every 5 minutes
            </div>

            <div class="backup-buttons">
                <button class="btn btn-primary" onclick="createManualBackup()">
                    <i class="fas fa-download"></i> Create Manual Backup
                </button>
                <button class="btn btn-primary" onclick="exportCurrentBackup()">
                    <i class="fas fa-file-export"></i> Export Backup
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('import-backup-input').click()">
                    <i class="fas fa-file-import"></i> Import Backup
                </button>
            </div>

            <input type="file" id="import-backup-input" accept=".json" style="display:none;" onchange="importBackupFile(this)">

            <div id="backup-status-message"></div>

            <div class="backup-list">
                <h5 style="color: #1b5e20; margin-top: 20px; margin-bottom: 10px;">
                    <i class="fas fa-history"></i> Backup History
                </h5>
                ${userBackups.length > 0 ? userBackups.map(backup => `
                    <div class="backup-item">
                        <div class="backup-item-info">
                            <div class="backup-item-date">
                                ${backup.manual ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'} 
                                ${backupManager.formatDate(backup.timestamp)}
                            </div>
                            <div class="backup-item-size">
                                ${backupManager.formatSize(backup.size)} â€¢ 
                                ${backup.projects.length} projects
                            </div>
                        </div>
                        <div class="backup-item-actions">
                            <button class="backup-item-btn backup-item-btn-restore" onclick="restoreBackupConfirm(${backup.id})">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button class="backup-item-btn backup-item-btn-delete" onclick="deleteBackupConfirm(${backup.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('') : '<p style="color: var(--text-secondary); font-size: 0.85rem;">No backups available</p>'}
            </div>
        </div>
    `;

    return html;
}

function createManualBackup() {
    const backup = backupManager.createBackup(true);
    if (backup) {
        showBackupStatus('âœ… Backup created successfully!', 'success');
        setTimeout(() => {
            changeTab('settings');
        }, 500);
    }
}

function exportCurrentBackup() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    if (userBackups.length === 0) {
        showBackupStatus('âš ï¸ No backups to export', 'error');
        return;
    }
    backupManager.exportBackup(userBackups[0].id);
    showBackupStatus('âœ… Backup exported successfully!', 'success');
}

function importBackupFile(input) {
    const file = input.files[0];
    if (!file) return;

    backupManager.importBackup(file).then(success => {
        if (success) {
            showBackupStatus('âœ… Backup imported and restored successfully!', 'success');
            setTimeout(() => {
                changeTab('settings');
            }, 500);
        } else {
            showBackupStatus('âŒ Invalid backup file format', 'error');
        }
    });

    input.value = '';
}

function restoreBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Restore Backup',
        `Restore data from ${backupManager.formatDate(backup.timestamp)}? Your current data will be replaced.`,
        false
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.restoreBackup(backupId)) {
                showBackupStatus('âœ… Backup restored successfully!', 'success');
                setTimeout(() => {
                    changeTab('overall');
                }, 500);
            } else {
                showBackupStatus('âŒ Failed to restore backup', 'error');
            }
        }
    });
}

function deleteBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Delete Backup',
        `Delete backup from ${backupManager.formatDate(backup.timestamp)}? This cannot be undone.`,
        true
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.deleteBackup(backupId)) {
                showBackupStatus('âœ… Backup deleted successfully!', 'success');
                setTimeout(() => {
                    changeTab('settings');
                }, 500);
            } else {
                showBackupStatus('âŒ Failed to delete backup', 'error');
            }
        }
    });
}

function showBackupStatus(message, type) {
    const statusDiv = document.getElementById('backup-status-message');
    if (!statusDiv) return;

    statusDiv.innerHTML = `<div class="backup-status ${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 4000);
}

        const REGIONS = ["NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       const SCHEMA = {
    'exposures': ["Total Manpower", "Total Exposed Manhour", "Total Exposed Man-hour to date", "No. of Days w/o LTA"],
    'rates': ["LTIR","TRIR","SEVERITY RATE"],
    'medical': ["Medical Treatment","First Aid","LTA","Fatality","High-Potential incident", "Dangerous Occurrences"],
    'nov': ["OSH Internal Issues", "OSH External Issues", "Environmental Internal Issues", "Environmental External Issues"],
    'activities': ["No. of ESH Committee Conducted", "No. of ESH inspection", "No. of Identified Near-Miss","Drills Conducted", "Training Conducted"],
    'kpm': ["KPM&I"],
    'audit': ["Score Implementation", "Documentation and Compliance"],
    'dole': ["RSO", "MOM"],
    'dole_annual': ["AEDR", "AMR"],
    'emb': ["SMR (Quarterly)", "CMR (Semi-Annual)"],
    'cshp': ["CSHP Approval Date"],
    'reg': ["DOLE Certificate of Registration Date"]
};

        // Regions are maintained - users add their own projects via "Add Project" button
        // No hard-coded projects to ensure fresh start for each user

        let state = {
            isLoggedIn: false,
            isEditing: false,
            currentTab: 'overall',
            currentUser: null,
            projects: [],
            personnelData: [],
            incidentRateData: { recordableCases: 0, lostDays: 0, totalHours: 0 },
            filteredProjects: [],
            selectedProjects: [],
            charts: {},
            currentSort: 'name',
            darkMode: false
        };

        // ===== DARK MODE FUNCTIONS =====
        function initDarkMode() {
            const savedTheme = localStorage.getItem('esh_theme_preference');
            if (savedTheme === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            state.darkMode = true;
            localStorage.setItem('esh_theme_preference', 'dark');
            updateThemeIcon();
            console.log('âœ… Dark mode enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            state.darkMode = false;
            localStorage.setItem('esh_theme_preference', 'light');
            updateThemeIcon();
            console.log('âœ… Light mode enabled');
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // ===== LOGIN & AUTH =====
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-user').value.trim();
            const password = document.getElementById('login-pass').value;
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            errorDiv.innerText = '';

            if (!email || !password) {
                errorDiv.innerText = 'âš ï¸ Please enter both email and password';
                return;
            }

            // Wait for Firebase to be ready
            if (!window.firebase || !window.firebaseAuth) {
                errorDiv.innerText = 'â³ System initializing, please try again...';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading-spinner"></span> Signing in...';

            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                state.currentUser = { email: user.email, uid: user.uid };
                state.isLoggedIn = true;
                console.log('âœ… Firebase login successful:', user.email);
                // showUI() will be called by onAuthStateChanged observer
            } catch (error) {
                console.error('âŒ Firebase login error:', error);
                let msg = 'âŒ Invalid email or password';
                if (error.code === 'auth/user-not-found') msg = 'âŒ No account found with this email';
                else if (error.code === 'auth/wrong-password') msg = 'âŒ Incorrect password';
                else if (error.code === 'auth/invalid-email') msg = 'âŒ Invalid email address';
                else if (error.code === 'auth/too-many-requests') msg = 'âŒ Too many attempts. Try again later.';
                else if (error.code === 'auth/network-request-failed') msg = 'âŒ Network error. Check your connection.';
                errorDiv.innerText = msg;
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }
        }

      function handleLogout() {
    showModernDialog('Logout Confirmation', 'Are you sure you want to logout?').then(async confirmed => {
        if (confirmed) {
            backupManager.stopAutoSave();
            state.isLoggedIn = false;
            state.currentUser = null;
            await firebaseLogout();
            location.reload();
        }
    });
}

        function loadUserData(email) {
            const storageKey = `esh_dashboard_${email}`;
            const savedData = localStorage.getItem(storageKey);

            if (savedData) {
                const data = JSON.parse(savedData);
                state.projects = data.projects || [];
                state.personnelData = data.personnelData || [];
                state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.currentSort = data.currentSort || 'name';
            } else {
                initializeUserProjects(email);
            }
            state.filteredProjects = [...state.projects];
        }

        function initializeUserProjects(email) {
            // Start with empty projects - users will add their own
            state.projects = [];
            state.filteredProjects = [];
            saveUserData(email);
            console.log('âœ… Initialized with empty projects - ready for user to add projects');
        }

        function saveUserData(email) {
            if (!email) return;
            const storageKey = `esh_dashboard_${email}`;
            const data = {
                projects: state.projects.map(p => {
                    const copy = { ...p };
                    delete copy.selected;
                    return copy;
                }),
                personnelData: state.personnelData || [],
                incidentRateData: state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
                currentSort: state.currentSort,
                lastSaved: new Date().toISOString(),
                timestamp: Date.now()
            };
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function sortProjects(sortBy) {
            state.currentSort = sortBy;
            state.projects.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'dateStarted') {
                    const da = new Date(a.dateStarted || '9999-12-31');
                    const db = new Date(b.dateStarted || '9999-12-31');
                    return da - db;
                }
                if (sortBy === 'dateFinished') {
                    const da = new Date(a.dateFinished || '9999-12-31');
                    const db = new Date(b.dateFinished || '9999-12-31');
                    return da - db;
                }
                return 0;
            });
            state.filteredProjects = [...state.projects];
            saveUserData(state.currentUser?.email);
            render();
        }

        function openAddProjectModal(region) {
            document.getElementById('projectNameInput').value = '';
            document.getElementById('projectDateStarted').value = '';
            document.getElementById('projectDateFinished').value = '';
            document.getElementById('projectRegion').value = region || '';
            document.getElementById('projectModalError').innerText = '';
            document.getElementById('addProjectModal').classList.add('show');
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('show');
        }

        function confirmAddProject() {
            const name = document.getElementById('projectNameInput').value.trim();
            const dateStarted = document.getElementById('projectDateStarted').value;
            const dateFinished = document.getElementById('projectDateFinished').value;
            const region = document.getElementById('projectRegion').value;
            const errorDiv = document.getElementById('projectModalError');

            errorDiv.innerText = '';

            if (!name) { errorDiv.innerText = 'âš ï¸ Project name is required'; return; }
            if (!dateStarted) { errorDiv.innerText = 'âš ï¸ Date started is required'; return; }
            if (!region) { errorDiv.innerText = 'âš ï¸ Region is required'; return; }
            if (dateFinished && new Date(dateFinished) < new Date(dateStarted)) {
                errorDiv.innerText = 'âš ï¸ Date finished cannot be before date started'; return;
            }
            if (state.projects.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                errorDiv.innerText = 'âš ï¸ Project name already exists'; return;
            }

            state.projects.push({
    name, region, status: 'on-going',
    dateStarted, dateFinished, vals: {}, selected: false,
    auditData: {
        Q1: { scoreImpl: 0, docuComp: 0 },
        Q2: { scoreImpl: 0, docuComp: 0 },
        Q3: { scoreImpl: 0, docuComp: 0 },
        Q4: { scoreImpl: 0, docuComp: 0 }
    }
});

            sortProjects(state.currentSort);
            saveUserData(state.currentUser.email);
            closeAddProjectModal();
            render();
        }

        function handleSearch() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const region = document.getElementById('region-filter').value;
            const status = document.getElementById('status-filter').value;

            state.filteredProjects = state.projects.filter(p =>
                p.name.toLowerCase().includes(search) &&
                (!region || p.region === region) &&
                (!status || p.status === status)
            );
            render();
        }

        function handleFilter() { handleSearch(); }

        function toggleEdit() {
            state.isEditing = true;
            document.getElementById('search-input').style.display = 'block';
            document.getElementById('region-filter').style.display = 'block';
            document.getElementById('status-filter').style.display = 'block';
            document.getElementById('btn-csv').style.display = 'block';
            document.getElementById('btn-pdf').style.display = 'block';
            document.getElementById('edit-btn').classList.add('hidden');
            document.getElementById('save-btn').classList.remove('hidden');
            render();
        }

        function saveData() {
            state.isEditing = false;
            document.getElementById('search-input').style.display = 'none';
            document.getElementById('region-filter').style.display = 'none';
            document.getElementById('status-filter').style.display = 'none';
            document.getElementById('btn-csv').style.display = 'none';
            document.getElementById('btn-pdf').style.display = 'none';
            
            // Save to localStorage + auto-sync to Firebase
            saveUserData(state.currentUser.email);
            
            document.getElementById('edit-btn').classList.remove('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            render();
            
            console.log('ðŸ’¾ Data saved and syncing to Firebase...');
        }

        function changeTab(t) {
            state.currentTab = t;
            document.querySelectorAll('.nav-item').forEach(n =>
                n.classList.toggle('active', n.dataset.tab === t)
            );
            const titles = {
                'overall': 'OVERALL DASHBOARD', 'exposures': 'TOTAL EXPOSURES',
                'rates': 'STATISTICS RATE', 'medical': 'ACCIDENT/ INCIDENT RECORD',
		'nov': 'REGULATORY ISSUED NOV',
                'nov-monitoring': 'ESH NOV MONITORING',
                'activities': 'ESH ACTIVITIES AND PROGRAMS','kpm': 'MONTHLY REPORT','reg': 'DOLE CERTIFICATE OF REGISTRATION (DATE REGISTERED)','audit': 'INTERNAL ESH AUDIT REPORT',
                'cshp': 'CONSTRUCTION SAFETY & HEALTH PROGRAM (DATE APPROVED)', 'dole': 'DOLE REPORTORIAL','emb': ["SMR (Quarterly)", "CMR (Semi-Annual)"],
                'personnel': 'ESH PERSONNEL MONITORING', 'settings': 'SETTINGS'
            };
            document.querySelector('.header-title').innerText = titles[t] || t.toUpperCase();
            document.getElementById('settings-view').classList.toggle('hidden', t !== 'settings');
            document.getElementById('personnel-view').classList.toggle('hidden', t !== 'personnel');
            document.getElementById('dashboard-content').classList.toggle('hidden', t === 'settings' || t === 'personnel');
            
            if (t === 'settings') {
                populateSettingsTab();
            }
            
            if (t === 'personnel') renderPTable();
            
            render();
        }

function updateAuditData(pName, qtr, field, val) {
    const p = state.projects.find(x => x.name === pName);
    if (p) {
        if (!p.auditData) {
            p.auditData = {
                Q1: { scoreImpl: 0, docuComp: 0 }, Q2: { scoreImpl: 0, docuComp: 0 },
                Q3: { scoreImpl: 0, docuComp: 0 }, Q4: { scoreImpl: 0, docuComp: 0 }
            };
        }
        p.auditData[qtr][field] = parseFloat(val) || 0;
        render(); // Para mag-update ang computation ng average sa screen
    }
}

        function updateVal(pName, key, mIdx, val) {
            const p = state.projects.find(x => x.name === pName);
            if (p) {
                if (!p.vals[key]) p.vals[key] = new Array(13).fill("");
                p.vals[key][mIdx] = val;
            }
            // Live-update the Incident Tabulation panel when relevant data changes
            if (state.currentTab === 'rates') {
                const panel = document.getElementById('incident-tabulation-panel');
                if (panel) {
                    panel.outerHTML = buildIncidentTabulationHTML();
                }
            }
        }

        function deleteProject(projectName) {
    showModernDialog('Delete Project', `Are you sure you want to delete "${projectName}"? This action cannot be undone.`, true).then(confirmed => {
        if (confirmed) {
            state.projects = state.projects.filter(p => p.name !== projectName);
            state.filteredProjects = state.filteredProjects.filter(p => p.name !== projectName);
            saveUserData(state.currentUser.email);
            render();
        }
    });
}

     function changeProjectStatus(projectName, event) {
    event.stopPropagation();
    const project = state.projects.find(p => p.name === projectName);
    if (!project) return;
    
    // Close any existing dropdown
    closeAllStatusDropdowns();
    
    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    
    const statuses = [
        { value: 'on-going', label: 'On-Going' },
        { value: 'work-stoppage', label: 'Work Stoppage' },
        { value: 'finished', label: 'Finished' }
    ];
    
    statuses.forEach(status => {
        const btn = document.createElement('button');
        btn.textContent = status.label;
        btn.style.fontWeight = project.status === status.value ? '700' : '400';
        btn.onclick = () => {
            project.status = status.value;
            saveUserData(state.currentUser.email);
            closeAllStatusDropdowns();
            render();
        };
        dropdown.appendChild(btn);
    });
    
    const badge = event.target;
    const rect = badge.getBoundingClientRect();
    
    dropdown.style.position = 'fixed';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    dropdown.style.left = rect.left + 'px';
    
    document.body.appendChild(dropdown);
}

function closeAllStatusDropdowns() {
    document.querySelectorAll('.status-dropdown').forEach(d => d.remove());
}

        function getPerc(proj) {
            let total = 0, filled = 0;
            ["exposures", "rates", "medical", "nov", "activities", "kpm","dole","emb", "cshp","reg"].forEach(cat => {
    SCHEMA[cat].forEach(row => {
        const key = `${cat}_${row}`;
        if (cat === 'cshp' || cat === 'reg') {
            total += 1;
            if (proj.vals[key] && proj.vals[key][1]) filled++;
        } else if (cat === 'emb') {
            // EMB has special submission cycles
            if (row === "SMR (Quarterly)") {
                total += 4; // Q1, Q2, Q3, Q4
                if (proj.vals[key]) {
                    for (let i = 1; i <= 4; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            } else if (row === "CMR (Semi-Annual)") {
                total += 2; // 1st Half, 2nd Half
                if (proj.vals[key]) {
                    for (let i = 1; i <= 2; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            }
        } else {
            total += 12;
            if (proj.vals[key]) {
                for (let i = 1; i <= 12; i++) {
                    if (proj.vals[key][i] && proj.vals[key][i] !== "0" && proj.vals[key][i] !== "") filled++;
                }
            }
        }
    });
});
            return total > 0 ? Math.round((filled / total) * 100) : 0;
        }

        function calculateYTD(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) sum += val;
            }
            return sum;
        }

        function calculateAverage(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            let count = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) {
                    sum += val;
                    count++;
                }
            }
            return count > 0 ? Math.round(sum / count) : 0;
        }

        function renderCharts() {
            const regionData = {};
            REGIONS.forEach(r => regionData[r] = [0, 0]);
            state.projects.forEach(p => {
                const perc = getPerc(p);
                regionData[p.region][0] += perc;
                regionData[p.region][1] += 1;
            });

            const regionAvgs = REGIONS.map(r => regionData[r][1] > 0 ? Math.round(regionData[r][0] / regionData[r][1]) : 0);
            const statusCounts = { 'on-going': 0, 'work-stoppage': 0, 'finished': 0 };
            state.projects.forEach(p => statusCounts[p.status]++);

            Object.values(state.charts).forEach(chart => { if (chart) chart.destroy(); });
            state.charts = {};

            setTimeout(() => {
                const regionCtx = document.getElementById('regionChart');
                if (regionCtx) {
                    const existingChart = Chart.getChart(regionCtx);
                    if (existingChart) existingChart.destroy();
                    state.charts.region = new Chart(regionCtx, {
                        type: 'bar',
                        data: {
                            labels: REGIONS,
                            datasets: [{
                                label: 'Compliance %',
                                data: regionAvgs,
                                backgroundColor: '#1b5e20',
                                borderColor: '#0a2e10',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, max: 100 } }
                        }
                    });
                }

                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    state.charts.status = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['On-Going', 'Work Stoppage', 'Finished'],
                            datasets: [{
                                data: [statusCounts['on-going'], statusCounts['work-stoppage'], statusCounts['finished']],
                                backgroundColor: ['#1976D2', '#d32f2f', '#616161']
                            }]
                        },
                        options: { responsive: true }
                    });
                }
            }, 100);
        }

        function exportToCSV() {
            let csv = 'Project Name,Region,Status,Date Started,Date Finished,Compliance %\n';
            state.filteredProjects.forEach(p => {
                csv += `"${p.name}","${p.region}","${p.status}","${p.dateStarted || 'N/A'}","${p.dateFinished || 'N/A'}","${getPerc(p)}%"\n`;
            });
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            a.download = `esh_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportToPDF() {
            const element = document.getElementById('dashboard-content');
            html2pdf().set({
                margin: 10, filename: `esh_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            }).from(element).save();
        }

        function showUI() {
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('user-badge').innerHTML = `<i class="fas fa-user-circle"></i> ${state.currentUser.email}`;
            changeTab('overall');
        }

        function render() {
            if (state.currentTab === 'settings' || state.currentTab === 'personnel') return;

            const container = document.getElementById('dashboard-content');
            let html = '';

            // â”€â”€ INCIDENT TABULATION RATE summary always shows at the TOP of Statistics Rate â”€â”€
            if (state.currentTab === 'rates') {
                html += buildIncidentTabulationHTML();
            }

            let grandTotal = 0;
            state.projects.forEach(p => grandTotal += getPerc(p));
            const overallAvg = state.projects.length > 0 ? Math.round(grandTotal / state.projects.length) : 0;

            if (state.currentTab === 'overall') {
                html += `<div id="grand-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL PROJECTS</div>
                        <div class="stat-value">${state.projects.length}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--safety-yellow);">
                        <div class="stat-label">OVERALL COMPLIANCE</div>
                        <div class="stat-value">${overallAvg}%</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #1976D2;">
                        <div class="stat-label">ON-GOING</div>
                        <div class="stat-value" style="color: #1976D2;">${state.projects.filter(p => p.status === 'on-going').length}</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #d32f2f;">
                        <div class="stat-label">WORK STOPPAGE</div>
                        <div class="stat-value" style="color: #d32f2f;">${state.projects.filter(p => p.status === 'work-stoppage').length}</div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box"><h3><i class="fas fa-chart-bar"></i> Compliance by Region</h3><canvas id="regionChart"></canvas></div>
                    <div class="chart-box"><h3><i class="fas fa-chart-pie"></i> Project Status</h3><canvas id="statusChart"></canvas></div>
                </div>`;
                renderCharts();
            }

            const displayProjects = state.filteredProjects.length > 0 ? state.filteredProjects : state.projects;

            // Show welcome message if no projects exist yet
            if (state.projects.length === 0 && state.currentTab === 'overall') {
                html += `<div style="background: var(--bg-card); border-radius: 12px; padding: 40px; text-align: center; margin: 20px 0; border: 2px dashed var(--border-color);">
                    <i class="fas fa-rocket" style="font-size: 3rem; color: #2e7d32; opacity: 0.6; margin-bottom: 15px;"></i>
                    <h3 style="color: var(--text-primary); margin: 10px 0; font-size: 1.2rem;">Welcome to ESH Compliance Dashboard!</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0 20px; font-size: 0.9rem;">Get started by adding your first project. Click the <strong>EDIT</strong> button above, then use <strong>+ ADD PROJECT</strong> in any region below.</p>
                    <button onclick="toggleEdit()" class="btn btn-primary" style="padding: 12px 30px; font-size: 0.9rem;">
                        <i class="fas fa-plus-circle"></i> START ADDING PROJECTS
                    </button>
                </div>`;
            }

            REGIONS.forEach(reg => {
                const projs = displayProjects.filter(p => p.region === reg);
                
                // Calculate region average only if there are projects
                const regSum = projs.reduce((sum, p) => sum + getPerc(p), 0);
                const regionAvg = projs.length > 0 ? Math.round(regSum / projs.length) : 0;

                // Always show region banner, even if empty (so user can add projects)
                html += `<div class="region-banner">
                    <div><i class="fas fa-location-dot"></i> ${reg} <span class="badge">${projs.length} PROJ</span> ${projs.length > 0 ? `<span class="badge" style="background:#1b5e20; color:var(--safety-yellow);">AVG: ${regionAvg}%</span>` : ''}</div>
                    ${state.isEditing ? `<button onclick="openAddProjectModal('${reg}')" class="btn btn-primary">+ ADD PROJECT</button>` : ''}
                    ${state.currentTab === 'overall' && projs.length > 0 ? `<select class="sort-select" onchange="sortProjects(this.value)">
                        <option value="name" ${state.currentSort === 'name' ? 'selected' : ''}>Sort: Name</option>
                        <option value="dateStarted" ${state.currentSort === 'dateStarted' ? 'selected' : ''}>Sort: Date Started</option>
                        <option value="dateFinished" ${state.currentSort === 'dateFinished' ? 'selected' : ''}>Sort: Date Finished</option>
                    </select>` : ''}
                </div>`;
                
                // Show empty state message if no projects in this region
                if (projs.length === 0 && state.isEditing) {
                    html += `<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.85rem; font-style: italic;">
                        <i class="fas fa-folder-open" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
                        No projects in this region yet. Click "+ ADD PROJECT" to get started.
                    </div>`;
                }

                projs.forEach(p => {
                    const perc = getPerc(p);
                    const statusClass = p.status === 'on-going' ? 'status-ongoing' : p.status === 'work-stoppage' ? 'status-stoppage' : 'status-finished';
                    const statusLabel = p.status === 'on-going' ? 'On-Going' : p.status === 'work-stoppage' ? 'Work Stoppage' : 'Finished';

                    html += `<div class="project-row">
                        ${state.isEditing ? `<input type="checkbox" class="project-checkbox" ${p.selected ? 'checked' : ''} onchange="toggleProjectSelect('${p.name}')">` : ''}
                        <div class="circular-progress" style="--percentage: ${perc * 3.6}deg;">
                            <div class="circular-progress-inner">${perc}%</div>
                        </div>
                        <div class="project-info">
                            <div class="project-name">${p.name}</div>
                            <div class="project-meta">Safety Compliance</div>
                        </div>
                        <div class="project-dates">
                            <div><span class="date-label">Started:</span> ${p.dateStarted ? new Date(p.dateStarted).toLocaleDateString() : 'Not set'}</div>
                            <div><span class="date-label">Finished:</span> ${p.dateFinished ? new Date(p.dateFinished).toLocaleDateString() : 'Ongoing'}</div>
                        </div>
                        <span class="status-badge ${statusClass}" onclick="changeProjectStatus('${p.name}', event)">${statusLabel}</span>
                        ${state.isEditing ? `<button class="btn btn-danger" onclick="deleteProject('${p.name}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;

if (state.currentTab === 'audit') {
    html += `<div class="table-container">
        <style>
            .audit-table {
                border-collapse: collapse;
                width: 100%;
                max-width: 1000px;
                margin: 10px 0;
                font-family: Arial, sans-serif;
                border: 0.5px solid #d1d1d1;
            }
            /* Green Header style base sa image */
            .audit-table thead th {
                background-color: #2e7d32; /* Dark green background */
                color: #ffffff;            /* White text */
                font-weight: bold;
                text-transform: uppercase;
                font-size: 11px;
                padding: 10px 4px;
                border: 0.5px solid #1b5e20;
            }
            .audit-table td { 
                border: 0.5px solid #d1d1d1;
                text-align: center; 
                vertical-align: middle; 
                padding: 4px;
                font-size: 12px;
            }
            /* Row highlight para sa alternating colors */
            .audit-table tbody tr {
                background-color: #ffffff;
            }
            /* Specific cell adjustments */
            .cell-white { background-color: #ffffff; }
            .cell-avg-gray { background: #808080 !important; color: white !important; font-weight: bold; }
            .cell-grand-total { background-color: #ffff00 !important; color: #000000 !important; font-weight: bold; }
            
            .audit-table input { 
                text-align: center; 
                width: 45px;
                border: 0.5px solid #ccc;
                border-radius: 2px;
                font-size: 11px;
                padding: 2px;
            }
            .audit-table p { margin: 0; padding: 0; font-size: 10px; }
        </style>
        
        <table class="audit-table">
            <thead>
                <tr>
                    <th colspan="3">Q1 (JAN-MAR)</th>
                    <th colspan="3">Q2 (APR-JUN)</th>
                    <th colspan="3">Q3 (JUL-SEP)</th>
                    <th colspan="3">Q4 (OCT-DEC)</th>
                    <th rowspan="3" class="cell-grand-total" style="border: 0.5px solid #d1d1d1;">GRAND<br>TOTAL AVG</th>
                </tr>
                <tr>
                    <th colspan="3">Score</th>
                    <th colspan="3">Score</th>
                    <th colspan="3">Score</th>
                    <th colspan="3">Score</th>
                </tr>
                <tr>
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                    
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                    
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                    
                    <th style="background: white; color: black; font-size: 10px;">Impl.</th>
                    <th style="background: white; color: black; font-size: 10px;">Docu & Comp.</th>
                    <th style="background: #808080; color: white; font-size: 10px;">Avg</th>
                </tr>
            </thead>
            <tbody>
                <tr>`;

    const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
    let totalYearAvg = 0;
    
    quarters.forEach(q => {
        const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
        const qAvg = (audit.scoreImpl + audit.docuComp) / 2;
        totalYearAvg += qAvg;

        html += `
            <td class="cell-white"><input type="number" value="${audit.scoreImpl}" ${state.isEditing ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)"></td>
            <td class="cell-white"><input type="number" value="${audit.docuComp}" ${state.isEditing ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)"></td>
            <td class="cell-avg-gray">${qAvg.toFixed(2)}</td>`;
    });

    html += `<td class="cell-grand-total">${(totalYearAvg / 4).toFixed(2)}</td>
                </tr>
            </tbody>
        </table>
    </div>`;
}
                  if (state.currentTab === 'nov-monitoring') {
    // Special rendering for ESH NOV Monitoring - all projects grouped per region
    // Skip individual project rendering - will be done at region level
}
else if (state.currentTab !== 'overall' && state.currentTab !== 'audit') {
    const isDateType = ['kpm','dole','emb','cshp','reg'].includes(state.currentTab);
    const isCshp = state.currentTab === 'cshp'|| state.currentTab === 'reg';
    const hasYTD = ['exposures', 'rates', 'medical', 'nov', 'activities'].includes(state.currentTab);
    const isNov = state.currentTab === 'nov';

    html += `<div class="table-container"><table>`;
    html += `<tr><th style="width:250px; text-align:left;">TYPE</th>`;

    if (isCshp) {
        const headerText = (state.currentTab === 'cshp') ? "DATE APPROVED" : "DATE REGISTERED";
        html += `<th>${headerText}</th>`;
    } else {
        // Previous column header
        if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb') {
            html += `<th class="prev-year${isNov ? ' nov-narrow-th' : ''}">PREVIOUS</th>`;
        }

        // Main columns
        if (state.currentTab === 'emb') {
            html += `<th>Q1 (JAN-MAR)</th>`;
            html += `<th>Q2 (APR-JUN)</th>`;
            html += `<th>Q3 (JUL-SEP)</th>`;
            html += `<th>Q4 (OCT-DEC)</th>`;
            html += `<th>1ST HALF (JAN-JUN)</th>`;
            html += `<th>2ND HALF (JUL-DEC)</th>`;
        } else {
            MONTHS.forEach(m => html += `<th${isNov ? ' class="nov-narrow-th"' : ''}>${m}</th>`);
        }

        if (hasYTD) {
            html += `<th class="ytd-header">RUNNING YTD</th>`;
        }
    }

    html += `</tr>`;

    SCHEMA[state.currentTab].forEach((row, rowIdx) => {
        const key = `${state.currentTab}_${row}`;
        html += `<tr><td style="text-align:left; font-weight:600; background:var(--border-color);">${row}</td>`;

        if (isCshp) {
            const v = p.vals[key] ? p.vals[key][1] : "";
            html += `<td><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>`;
        } else {
            // Previous Year Column
            const prevVal = p.vals[key] ? p.vals[key][0] : "";
            
            if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb') {
                html += `<td class="prev-year${isNov ? ' nov-narrow-td' : ''}">
                    <input type="${isDateType ? 'date' : 'number'}"
                        value="${prevVal}"
                        ${state.isEditing ? '' : 'disabled'}
                        oninput="updateVal('${p.name}','${key}',0,this.value)">
                </td>`;
            }
            
            // Main data columns
            if (state.currentTab === 'emb') {
                // EMB Reportorial - Quarterly or Semi-Annual
                if (row === "SMR (Quarterly)") {
                    // Q1, Q2, Q3, Q4
                    for (let i = 1; i <= 4; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="monthly-data"><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                    // Add empty cells for semi-annual columns
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                } else if (row === "CMR (Semi-Annual)") {
                    // Add empty cells for quarterly columns
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                    html += `<td class="cell-disabled"></td>`;
                    // 1st Half (JAN-JUN), 2nd Half (JUL-DEC)
                    for (let i = 1; i <= 2; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="monthly-data"><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                }
            } else {
                // Monthly Columns for other tabs
                for (let i = 1; i <= 12; i++) {
                    const v = p.vals[key] ? p.vals[key][i] : "";
                    html += `<td class="${isNov ? 'nov-narrow-td' : 'monthly-data'}"><input type="${isDateType ? 'date' : 'number'}" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                }
            }
            
            // Add Running YTD column
            if (hasYTD) {
                let ytdValue = 0;
                if (row === "Total Manpower") {
                    ytdValue = calculateAverage(p.vals[key], rowIdx);
                    html += `<td class="average-cell">${ytdValue}</td>`;
                } else {
                    ytdValue = calculateYTD(p.vals[key], rowIdx);
                    html += `<td class="ytd-cell">${ytdValue}</td>`;
                }
            }
        }
        html += `</tr>`;
    });
    html += `</table></div>`;
    
    // ANNUAL REPORTS SECTION (for DOLE only)
    if (state.currentTab === 'dole' && SCHEMA.dole_annual) {
        html += `<div style="margin-top: 30px;">`;
        html += `<div style="background: var(--header-grad); color: white; padding: 10px 15px; border-radius: 6px; font-weight: 700; margin-bottom: 10px;">
                    ðŸ“… ANNUAL REPORTS (Submitted Every January)
                 </div>`;
        html += `<div class="table-container"><table>`;
        html += `<tr><th style="width:250px; text-align:left;">TYPE</th><th>DATE SUBMITTED</th></tr>`;
        
        SCHEMA.dole_annual.forEach((row, rowIdx) => {
            const key = `dole_annual_${row}`;
            const v = p.vals[key] ? p.vals[key][1] : "";
            html += `<tr>
                <td style="text-align:left; font-weight:600; background:var(--border-color);">${row}</td>
                <td><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
            </tr>`;
        });
        
        html += `</table></div></div>`;
    }
}

        });
            });

            // â”€â”€ PER-REGION GROUPED TABLES: kpm, cshp, reg, audit â”€â”€
            if (['kpm','cshp','reg','audit'].includes(state.currentTab)) {
                html = ''; // Rebuild cleanly â€” no per-project rows needed

                const isCshpReg = (state.currentTab === 'cshp' || state.currentTab === 'reg');
                const isAudit   = (state.currentTab === 'audit');

                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;

                    const regSum  = projs.reduce((sum, p) => sum + getPerc(p), 0);
                    const regAvg  = Math.round(regSum / projs.length);

                    html += `<div class="region-banner">
                        <div><i class="fas fa-location-dot"></i> ${reg}
                            <span class="badge">${projs.length} PROJ</span>
                            <span class="badge" style="background:#1b5e20;color:var(--safety-yellow);">AVG: ${regAvg}%</span>
                        </div>
                        ${state.isEditing ? `<button onclick="openAddProjectModal('${reg}')" class="btn btn-primary">+ ADD PROJECT</button>` : ''}
                    </div>`;

                    // â”€â”€ CSHP / REG â”€â”€
                    if (isCshpReg) {
                        const headerText = (state.currentTab === 'cshp') ? 'DATE APPROVED' : 'DATE REGISTERED';
                        const schemaRow  = SCHEMA[state.currentTab][0];
                        const key        = `${state.currentTab}_${schemaRow}`;

                        html += `<div class="table-container"><table>
                            <tr>
                                <th style="width:250px;text-align:left;">PROJECT NAME</th>
                                <th>${headerText}</th>
                            </tr>`;

                        projs.forEach(p => {
                            const v = p.vals[key] ? p.vals[key][1] : "";
                            html += `<tr>
                                <td style="text-align:left;font-weight:600;background:var(--border-color);">${p.name}</td>
                                <td><input type="date" value="${v}" ${state.isEditing ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
                            </tr>`;
                        });

                        html += `</table></div>`;

                    // â”€â”€ AUDIT â”€â”€
                    } else if (isAudit) {
                        html += `<div class="table-container">
                            <table class="audit-table">
                                <thead>
                                    <tr>
                                        <th rowspan="3" style="text-align:left;min-width:180px;">PROJECT NAME</th>
                                        <th colspan="3">Q1 (JAN-MAR)</th>
                                        <th colspan="3">Q2 (APR-JUN)</th>
                                        <th colspan="3">Q3 (JUL-SEP)</th>
                                        <th colspan="3">Q4 (OCT-DEC)</th>
                                        <th rowspan="3" class="cell-grand-total" style="border:0.5px solid #d1d1d1;">GRAND<br>TOTAL AVG</th>
                                    </tr>
                                    <tr>
                                        <th colspan="3">Score</th><th colspan="3">Score</th>
                                        <th colspan="3">Score</th><th colspan="3">Score</th>
                                    </tr>
                                    <tr>
                                        <th style="background:white;color:black;font-size:10px;">Impl.</th>
                                        <th style="background:white;color:black;font-size:10px;">Docu &amp; Comp.</th>
                                        <th style="background:#808080;color:white;font-size:10px;">Avg</th>
                                        <th style="background:white;color:black;font-size:10px;">Impl.</th>
                                        <th style="background:white;color:black;font-size:10px;">Docu &amp; Comp.</th>
                                        <th style="background:#808080;color:white;font-size:10px;">Avg</th>
                                        <th style="background:white;color:black;font-size:10px;">Impl.</th>
                                        <th style="background:white;color:black;font-size:10px;">Docu &amp; Comp.</th>
                                        <th style="background:#808080;color:white;font-size:10px;">Avg</th>
                                        <th style="background:white;color:black;font-size:10px;">Impl.</th>
                                        <th style="background:white;color:black;font-size:10px;">Docu &amp; Comp.</th>
                                        <th style="background:#808080;color:white;font-size:10px;">Avg</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        projs.forEach(p => {
                            let totalYearAvg = 0;
                            html += `<tr><td style="text-align:left;font-weight:600;background:var(--border-color);padding:6px 8px;">${p.name}</td>`;
                            ['Q1','Q2','Q3','Q4'].forEach(q => {
                                const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
                                const qAvg  = (audit.scoreImpl + audit.docuComp) / 2;
                                totalYearAvg += qAvg;
                                html += `
                                    <td class="cell-white"><input type="number" value="${audit.scoreImpl}" ${state.isEditing ? '' : 'disabled'}
                                        oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)"></td>
                                    <td class="cell-white"><input type="number" value="${audit.docuComp}" ${state.isEditing ? '' : 'disabled'}
                                        oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)"></td>
                                    <td class="cell-avg-gray">${qAvg.toFixed(2)}</td>`;
                            });
                            html += `<td class="cell-grand-total">${(totalYearAvg/4).toFixed(2)}</td></tr>`;
                        });

                        html += `</tbody></table></div>`;

                    // â”€â”€ KPM (Monthly Report) â”€â”€
                    } else {
                        html += `<div class="table-container"><table>
                            <tr><th style="width:220px;text-align:left;">PROJECT NAME</th>`;
                        MONTHS.forEach(m => html += `<th>${m}</th>`);
                        html += `</tr>`;

                        projs.forEach(p => {
                            SCHEMA['kpm'].forEach(row => {
                                const key = `kpm_${row}`;
                                html += `<tr>
                                    <td style="text-align:left;font-weight:600;background:var(--border-color);">${p.name}</td>`;
                                for (let i = 1; i <= 12; i++) {
                                    const v = p.vals[key] ? p.vals[key][i] : "";
                                    html += `<td class="monthly-data"><input type="date" value="${v}"
                                        ${state.isEditing ? '' : 'disabled'}
                                        oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                                }
                                html += `</tr>`;
                            });
                        });

                        html += `</table></div>`;
                    }
                });
            }

            // ESH NOV MONITORING - Render grouped tables per region
            if (state.currentTab === 'nov-monitoring') {
                html = ''; // Clear previous HTML
                
                // Add CSS styles for NOV Monitoring
                html += `<style>
                    .nov-monitoring-table {
                        border-collapse: collapse;
                        width: 100%;
                        margin: 10px 0;
                        font-family: Arial, sans-serif;
                        border: 0.5px solid #d1d1d1;
                    }
                    .nov-monitoring-table th {
                        background-color: #2e7d32;
                        color: #ffffff;
                        font-weight: bold;
                        text-transform: uppercase;
                        font-size: 10px;
                        padding: 8px 4px;
                        border: 0.5px solid #1b5e20;
                        text-align: center;
                    }
                    .nov-monitoring-table td {
                        border: 0.5px solid #d1d1d1;
                        text-align: center;
                        vertical-align: middle;
                        padding: 4px;
                        font-size: 11px;
                    }
                    .nov-monitoring-table td.project-name {
                        text-align: left;
                        font-weight: 600;
                        background: var(--border-color);
                        min-width: 150px;
                    }
                    .nov-monitoring-table input {
                        text-align: center;
                        width: 40px;
                        border: 0.5px solid #ccc;
                        border-radius: 2px;
                        font-size: 11px;
                        padding: 2px;
                    }
                    .nov-monitoring-table td.month-col {
                        width: 45px;
                        max-width: 45px;
                    }
                    .nov-monitoring-table td.summary-col {
                        width: 50px;
                        max-width: 50px;
                    }
                    .nov-monitoring-table td.total-col {
                        background: #fff9c4;
                        font-weight: 700;
                    }
                    .nov-monitoring-table tr.regional-total {
                        background: #e8f5e9;
                        font-weight: 700;
                    }
                    .nov-monitoring-table tr.overall-total {
                        background: #c8e6c9;
                        font-weight: 700;
                    }
                </style>`;
                
                // Initialize overall totals
                let overallTotals = {
                    prev: 0,
                    months: new Array(12).fill(0),
                    open: 0,
                    pending: 0,
                    closed: 0,
                    total: 0
                };
                
                // First pass: Calculate overall totals
                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;
                    
                    projs.forEach(p => {
                        const key = 'nov-monitoring_data';
                        if (!p.vals[key]) p.vals[key] = new Array(17).fill("");
                        
                        overallTotals.prev += parseFloat(p.vals[key][0]) || 0;
                        
                        for (let i = 1; i <= 12; i++) {
                            const val = parseFloat(p.vals[key][i]) || 0;
                            overallTotals.months[i-1] += val;
                            overallTotals.total += val;
                        }
                        
                        overallTotals.open += parseFloat(p.vals[key][13]) || 0;
                        overallTotals.pending += parseFloat(p.vals[key][14]) || 0;
                        overallTotals.closed += parseFloat(p.vals[key][15]) || 0;
                    });
                });
                
                // Calculate overall percentage
                const overallPercentage = overallTotals.total > 0 
                    ? ((overallTotals.closed / overallTotals.total) * 100).toFixed(2) 
                    : '0.00';
                
                // Render Overall Total Table at the TOP
                html += `<div class="region-banner" style="background: linear-gradient(90deg, #1b5e20 0%, #2e7d32 100%);">
                    <div><i class="fas fa-chart-bar"></i> OVERALL SUMMARY - ALL REGIONS</div>
                </div>
                <div class="table-container">
                    <table class="nov-monitoring-table">
                        <thead>
                            <tr>
                                <th style="min-width: 150px;">SUMMARY</th>
                                <th class="prev-year">PREVIOUS</th>
                                <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th>
                                <th>MAY</th><th>JUN</th><th>JUL</th><th>AUG</th>
                                <th>SEP</th><th>OCT</th><th>NOV</th><th>DEC</th>
                                <th style="background: #66bb6a;">OPEN</th>
                                <th style="background: #ffa726;">PENDING</th>
                                <th style="background: #42a5f5;">CLOSED</th>
                                <th style="background: #fbc02d;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="overall-total">
                                <td style="text-align: left; font-weight: 700; background: #1b5e20; color: white;">OVERALL TOTAL</td>
                                <td style="background: #81c784;">${overallTotals.prev}</td>`;
                
                for (let i = 0; i < 12; i++) {
                    html += `<td style="background: #a5d6a7;">${overallTotals.months[i]}</td>`;
                }
                
                html += `<td style="background: #66bb6a;">${overallTotals.open}</td>
                    <td style="background: #ff9800;">${overallTotals.pending}</td>
                    <td style="background: #2196f3;">${overallTotals.closed}</td>
                    <td style="background: #f9a825; font-size: 14px;">${overallTotals.total}</td>
                </tr>
                <tr class="overall-total">
                    <td colspan="17" style="text-align: center; background: #c8e6c9; font-size: 16px; padding: 12px;">
                        <strong>OVERALL COMPLETION RATE: ${overallPercentage}%</strong>
                    </td>
                </tr>
                        </tbody>
                    </table>
                </div>`;
                
                // Now render table for each region
                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;
                    
                    html += `<div class="region-banner" style="margin-top: 30px;">
                        <div><i class="fas fa-location-dot"></i> ${reg} <span class="badge">${projs.length} PROJECTS</span></div>
                    </div>`;
                    
                    html += `<div class="table-container">
                        <table class="nov-monitoring-table">
                            <thead>
                                <tr>
                                    <th rowspan="2" style="min-width: 150px;">PROJECT NAME</th>
                                    <th rowspan="2" class="prev-year">PREVIOUS</th>
                                    <th colspan="12">2025 MONTHLY DATA</th>
                                    <th colspan="4">SUMMARY</th>
                                </tr>
                                <tr>
                                    <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th>
                                    <th>MAY</th><th>JUN</th><th>JUL</th><th>AUG</th>
                                    <th>SEP</th><th>OCT</th><th>NOV</th><th>DEC</th>
                                    <th style="background: #66bb6a;">OPEN</th>
                                    <th style="background: #ffa726;">PENDING</th>
                                    <th style="background: #42a5f5;">CLOSED</th>
                                    <th style="background: #fbc02d;">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    // Initialize regional totals
                    let regionalTotals = {
                        prev: 0,
                        months: new Array(12).fill(0),
                        open: 0,
                        pending: 0,
                        closed: 0,
                        total: 0
                    };
                    
                    // Render each project in this region
                    projs.forEach(p => {
                        const key = 'nov-monitoring_data';
                        if (!p.vals[key]) p.vals[key] = new Array(17).fill("");
                        
                        html += `<tr>
                            <td class="project-name">${p.name}</td>
                            <td class="prev-year">
                                <input type="number" value="${p.vals[key][0] || ''}" ${state.isEditing ? '' : 'disabled'} 
                                    oninput="updateVal('${p.name}','${key}',0,this.value)">
                            </td>`;
                        
                        // Add to regional prev totals
                        regionalTotals.prev += parseFloat(p.vals[key][0]) || 0;
                        
                        // Monthly columns (1-12)
                        let rowTotal = 0;
                        for (let i = 1; i <= 12; i++) {
                            const val = parseFloat(p.vals[key][i]) || 0;
                            html += `<td class="month-col">
                                <input type="number" value="${p.vals[key][i] || ''}" ${state.isEditing ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',${i},this.value)">
                            </td>`;
                            regionalTotals.months[i-1] += val;
                            rowTotal += val;
                        }
                        
                        // Summary columns
                        const openVal = parseFloat(p.vals[key][13]) || 0;
                        const pendingVal = parseFloat(p.vals[key][14]) || 0;
                        const closedVal = parseFloat(p.vals[key][15]) || 0;
                        
                        html += `<td class="summary-col" style="background: #c8e6c9;">
                            <input type="number" value="${p.vals[key][13] || ''}" ${state.isEditing ? '' : 'disabled'}
                                oninput="updateVal('${p.name}','${key}',13,this.value)">
                        </td>
                        <td class="summary-col" style="background: #ffe0b2;">
                            <input type="number" value="${p.vals[key][14] || ''}" ${state.isEditing ? '' : 'disabled'}
                                oninput="updateVal('${p.name}','${key}',14,this.value)">
                        </td>
                        <td class="summary-col" style="background: #bbdefb;">
                            <input type="number" value="${p.vals[key][15] || ''}" ${state.isEditing ? '' : 'disabled'}
                                oninput="updateVal('${p.name}','${key}',15,this.value)">
                        </td>
                        <td class="total-col">${rowTotal}</td>
                        </tr>`;
                        
                        regionalTotals.open += openVal;
                        regionalTotals.pending += pendingVal;
                        regionalTotals.closed += closedVal;
                        regionalTotals.total += rowTotal;
                    });
                    
                    // Calculate regional percentage
                    const regionalPercentage = regionalTotals.total > 0 
                        ? ((regionalTotals.closed / regionalTotals.total) * 100).toFixed(2) 
                        : '0.00';
                    
                    // Regional Total Row
                    html += `<tr class="regional-total">
                        <td class="project-name" style="background: #2e7d32; color: white;">REGIONAL TOTAL</td>
                        <td style="background: #a5d6a7;">${regionalTotals.prev}</td>`;
                    
                    for (let i = 0; i < 12; i++) {
                        html += `<td style="background: #c8e6c9;">${regionalTotals.months[i]}</td>`;
                    }
                    
                    html += `<td style="background: #81c784;">${regionalTotals.open}</td>
                        <td style="background: #ffb74d;">${regionalTotals.pending}</td>
                        <td style="background: #64b5f6;">${regionalTotals.closed}</td>
                        <td style="background: #fbc02d;">${regionalTotals.total}</td>
                    </tr>`;
                    
                    // Regional Percentage Row
                    html += `<tr class="regional-total">
                        <td colspan="17" style="text-align: right; padding-right: 10px; background: #e8f5e9;">
                            <strong>${reg} COMPLETION RATE:</strong> ${regionalPercentage}%
                        </td>
                    </tr>`;
                    
                    html += `</tbody></table></div>`;
                });
            }

            container.innerHTML = html;
        }


        
// Close dropdowns when clicking elsewhere
document.addEventListener('click', closeAllStatusDropdowns);
        function toggleProjectSelect(projectName) {
            const project = state.filteredProjects.find(p => p.name === projectName);
            if (project) project.selected = !project.selected;
        }

        // ===== SETTINGS FUNCTIONS =====

        // Toggle password field visibility
        function togglePwd(fieldId, btn) {
            const input = document.getElementById(fieldId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // Password strength indicator
        document.addEventListener('input', function(e) {
            if (e.target.id === 'new-password') {
                const val = e.target.value;
                const el = document.getElementById('pwd-strength');
                if (!el || !val) { if(el) el.innerHTML=''; return; }
                let score = 0;
                if (val.length >= 6) score++;
                if (val.length >= 10) score++;
                if (/[A-Z]/.test(val)) score++;
                if (/[0-9]/.test(val)) score++;
                if (/[^A-Za-z0-9]/.test(val)) score++;
                const labels = ['', 'ðŸ”´ Weak', 'ðŸŸ  Fair', 'ðŸŸ¡ Good', 'ðŸŸ¢ Strong', 'âœ… Very Strong'];
                const colors = ['', '#f44336', '#ff9800', '#ffc107', '#4caf50', '#1b5e20'];
                el.innerHTML = `<span style="color:${colors[score]};font-weight:700;">${labels[score] || ''}</span>`;
            }
        });

        // Toggle username edit form
        function toggleUsernameEdit() {
            const fields = document.getElementById('username-edit-fields');
            const isVisible = fields.style.display !== 'none';
            fields.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                const current = document.getElementById('current-display-name-text').textContent;
                document.getElementById('new-display-name').value = (current === 'â€”' || current === 'ESH User') ? '' : current;
                document.getElementById('new-display-name').focus();
            }
        }

        // Save display name to Firebase
        async function saveDisplayName() {
            const nameVal = document.getElementById('new-display-name').value.trim();
            const msgEl = document.getElementById('name-msg');
            const btn = document.getElementById('save-name-btn');

            showSettingsMsg('name-msg', '', '');
            if (!nameVal) { showSettingsMsg('name-msg', 'âš ï¸ Please enter a display name', 'error'); return; }
            if (nameVal.length < 2) { showSettingsMsg('name-msg', 'âš ï¸ Name must be at least 2 characters', 'error'); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
            showSettingsMsg('name-msg', 'Updating display name...', 'loading');

            try {
                // Save to Firebase Firestore user profile
                if (firebaseReady && window.firebaseDb && state.currentUser) {
                    const userId = getCurrentUserId();
                    const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
                    await window.firebase.setDoc(docRef, { displayName: nameVal }, { merge: true });
                }
                // Update state and UI
                state.currentUser.displayName = nameVal;
                localStorage.setItem('esh_displayname_' + state.currentUser.email, nameVal);

                document.getElementById('current-display-name-text').textContent = nameVal;
                document.getElementById('settings-display-name').textContent = nameVal;
                // Update sidebar user badge too
                const badge = document.getElementById('user-badge');
                if (badge) badge.innerHTML = `<i class="fas fa-user-circle"></i> ${nameVal}`;

                document.getElementById('username-edit-fields').style.display = 'none';
                showSettingsMsg('name-msg', 'âœ… Display name updated successfully!', 'success');
            } catch (err) {
                console.error('âŒ Name update error:', err);
                showSettingsMsg('name-msg', 'âŒ Failed to update: ' + err.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> SAVE NAME';
        }

        // Update Password via Firebase
        async function updatePassword() {
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const btn = document.getElementById('update-pwd-btn');

            showSettingsMsg('settings-message', '', '');

            if (!newPass || !confirmPass) { showSettingsMsg('settings-message', 'âš ï¸ Please fill both fields', 'error'); return; }
            if (newPass !== confirmPass) { showSettingsMsg('settings-message', 'âŒ Passwords do not match', 'error'); return; }
            if (newPass.length < 6) { showSettingsMsg('settings-message', 'âŒ Password must be at least 6 characters', 'error'); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> UPDATING...';
            showSettingsMsg('settings-message', 'Updating password in Firebase...', 'loading');

            const success = await firebaseChangePassword(newPass);
            if (success) {
                showSettingsMsg('settings-message', 'âœ… Password updated successfully in Firebase!', 'success');
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('pwd-strength').innerHTML = '';
            } else {
                // firebaseChangePassword already shows alert on error
                showSettingsMsg('settings-message', 'âŒ Password update failed. If you just logged in, please re-login and try again.', 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-key"></i> UPDATE PASSWORD';
        }

        // Send password reset email
        async function sendPasswordReset() {
            const email = state.currentUser?.email;
            if (!email) return;
            showSettingsMsg('settings-message', 'Sending reset email...', 'loading');
            const success = await firebaseResetPassword(email);
            if (success) {
                showSettingsMsg('settings-message', 'âœ… Password reset email sent to ' + email, 'success');
            }
        }

        // Apply theme from settings page
        function applyTheme(mode) {
            if (mode === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
            updateSettingsThemeButtons();
        }

        function updateSettingsThemeButtons() {
            const isDark = document.body.classList.contains('dark-mode');
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');
            if (lightBtn) lightBtn.classList.toggle('active', !isDark);
            if (darkBtn) darkBtn.classList.toggle('active', isDark);
        }

        // Show message helper
        function showSettingsMsg(elId, text, type) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.className = 'settings-msg' + (type ? ' ' + type : '');
            el.innerHTML = type === 'loading'
                ? `<i class="fas fa-spinner fa-spin"></i> ${text}`
                : text;
            if (text && type !== 'loading') {
                setTimeout(() => { el.className = 'settings-msg'; el.innerHTML = ''; }, 4500);
            }
        }

        // Populate settings tab with latest data
        function populateSettingsTab() {
            const user = state.currentUser;
            if (!user) return;

            // Display name: check state, localStorage, then fallback
            const savedName = user.displayName || localStorage.getItem('esh_displayname_' + user.email) || '';
            const displayName = savedName || user.email.split('@')[0];
            document.getElementById('settings-display-name').textContent = displayName;
            document.getElementById('current-display-name-text').textContent = savedName || 'â€”';
            document.getElementById('settings-hero-email').textContent = user.email;
            document.getElementById('current-email').textContent = user.email;

            // Firebase UID
            const uidEl = document.getElementById('settings-uid');
            if (uidEl) uidEl.textContent = user.uid ? user.uid.substring(0, 20) + '...' : 'â€”';

            // Firebase status
            const fbStatus = document.getElementById('settings-firebase-status');
            if (fbStatus) {
                if (firebaseReady && window.firebaseDb) {
                    fbStatus.className = 'firebase-status-badge connected';
                    fbStatus.innerHTML = '<i class="fas fa-wifi"></i> Connected';
                } else {
                    fbStatus.className = 'firebase-status-badge disconnected';
                    fbStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Disconnected';
                }
            }

            // Last sync
            const syncEl = document.getElementById('settings-last-sync');
            if (syncEl && state.lastSyncTimestamp) {
                syncEl.textContent = new Date(state.lastSyncTimestamp).toLocaleString('en-PH');
            } else if (syncEl) {
                syncEl.textContent = 'Not yet synced';
            }

            // Total projects
            const projEl = document.getElementById('settings-total-projects');
            if (projEl) projEl.textContent = state.projects.length + ' projects';

            // Theme buttons
            updateSettingsThemeButtons();

            // Backup section
            const backupSection = document.getElementById('backup-recovery-section');
            if (backupSection) backupSection.innerHTML = showBackupRecoveryUI();
        }

        setInterval(() => {
            const now = new Date();
            const dateEl = document.getElementById('live-date');
            const clockEl = document.getElementById('live-clock');
            if (dateEl) dateEl.innerText = now.toLocaleDateString('en-PH', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).toUpperCase();
            if (clockEl) clockEl.innerText = now.toLocaleTimeString('en-PH');
        }, 1000);

       window.addEventListener('load', () => {
    initDarkMode();
    backupManager.init();
    // Firebase auth state is handled by setupAuthObserver() in the Firebase integration section below.
    // No session storage check needed â€” Firebase persists login automatically.
});
function showModernDialog(title, message, isDanger = false) {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'modern-dialog-overlay';

        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = 'modern-dialog';

        // Title
        const titleEl = document.createElement('h2');
        titleEl.className = 'modern-dialog-title';
        titleEl.textContent = title;

        // Message
        const messageEl = document.createElement('p');
        messageEl.className = 'modern-dialog-message';
        messageEl.textContent = message;

        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'modern-dialog-buttons';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modern-dialog-btn modern-dialog-btn-cancel';
        cancelBtn.textContent = 'CANCEL';
        cancelBtn.onclick = () => {
            overlay.remove();
            resolve(false);
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.className = isDanger ? 'modern-dialog-btn modern-dialog-btn-danger' : 'modern-dialog-btn modern-dialog-btn-confirm';
        confirmBtn.textContent = isDanger ? 'DELETE' : 'CONFIRM';
        confirmBtn.onclick = () => {
            overlay.remove();
            resolve(true);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(titleEl);
        dialog.appendChild(messageEl);
        dialog.appendChild(buttonsDiv);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Close on overlay click
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.remove();
                resolve(false);
            }
        };

        confirmBtn.focus();
    });
}

// --- ESH PERSONNEL MONITORING SYSTEM ---

function addPRow() {
    if (!state.personnelData) state.personnelData = [];
    state.personnelData.push({ name: '', pos: '', id: '', hired: '', current: '', age: '', gen: '', mail: '', num: '', addr: '', len: '' });
    renderPTable();
    // Auto-open edit mode on the newly added row
    const newIdx = state.personnelData.length - 1;
    setTimeout(() => pRowEdit(newIdx), 50);
    saveUserData(state.currentUser.email);
}

function renderPTable() {
    const tbody = document.getElementById('p-body');
    if (!tbody) return;
    const projOptions = (state.projects || []).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    const data = state.personnelData || [];

    tbody.innerHTML = data.map((p, i) => {
        const genderClass = p.gen === 'Male' ? 'p-gender-m' : p.gen === 'Female' ? 'p-gender-f' : '';
        const posDisplay  = p.pos && p.pos !== 'Select' ? `<span class="p-pos-badge">${p.pos}</span>` : '';
        const genDisplay  = p.gen && p.gen !== 'Select' ? `<span class="p-pos-badge ${genderClass}">${p.gen}</span>` : '';

        return `
        <tr id="p-row-${i}">
            <td style="min-width:160px;">
                <span class="p-row-num">${i+1}</span>
                <input type="text" value="${p.name || ''}" onchange="state.personnelData[${i}].name=this.value" style="min-width:120px;" disabled>
            </td>
            <td style="width:145px;">
                ${posDisplay}
                <select onchange="state.personnelData[${i}].pos=this.value;renderPTable();" style="width:130px;display:none;" disabled>
                    <option value="${p.pos||''}">${p.pos||'Select'}</option>
                    <option>Project Physician</option><option>ESH Head</option><option>Safety Officer I</option>
                    <option>Safety Officer II</option><option>Safety Officer III</option><option>Safety Officer IV</option>
                    <option>PCO</option><option>Project Nurse</option><option>First Aider</option><option>Others</option>
                </select>
            </td>
            <td style="width:95px; text-align:center;">
                <input type="text" value="${p.id||''}" onchange="state.personnelData[${i}].id=this.value" style="width:80px;text-align:center;" disabled>
            </td>
            <td style="width:110px; text-align:center;">
                <input type="date" value="${p.hired||''}" onchange="state.personnelData[${i}].hired=this.value" style="width:100px;" disabled>
            </td>
            <td style="min-width:160px;">
                <select onchange="state.personnelData[${i}].current=this.value" style="min-width:150px;" disabled>
                    <option value="${p.current||''}">${p.current||'Select Project'}</option>
                    ${projOptions}
                </select>
            </td>
            <td style="width:48px; text-align:center;">
                <input type="number" value="${p.age||''}" onchange="state.personnelData[${i}].age=this.value" style="width:38px;text-align:center;" min="0" max="99" disabled>
            </td>
            <td style="width:80px; text-align:center;">
                ${genDisplay}
                <select onchange="state.personnelData[${i}].gen=this.value;renderPTable();" style="width:70px;display:none;" disabled>
                    <option value="${p.gen||''}">${p.gen||'Select'}</option>
                    <option>Male</option><option>Female</option>
                </select>
            </td>
            <td style="min-width:180px;">
                <input type="email" value="${p.mail||''}" onchange="state.personnelData[${i}].mail=this.value" style="min-width:165px;" disabled>
            </td>
            <td style="width:115px; text-align:center;">
                <input type="text" value="${p.num||''}" onchange="state.personnelData[${i}].num=this.value" style="width:105px;" disabled>
            </td>
            <td style="min-width:200px;">
                <input type="text" value="${p.addr||''}" onchange="state.personnelData[${i}].addr=this.value" style="min-width:185px;" disabled>
            </td>
            <td style="width:70px; text-align:center;">
                <input type="number" value="${p.len||''}" onchange="state.personnelData[${i}].len=this.value" style="width:50px;text-align:center;" min="0" max="99" disabled>
            </td>
            <td style="width:100px; text-align:center; white-space:nowrap;">
                <button class="p-edit-btn" id="p-edit-btn-${i}" onclick="pRowEdit(${i})"><i class="fas fa-edit"></i></button>
                <button class="p-save-btn" id="p-save-btn-${i}" onclick="pRowSave(${i})"><i class="fas fa-save"></i></button>
                <button class="p-del-btn" onclick="pRowDelete(${i})" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');

    // Show/hide empty state
    const emptyEl = document.getElementById('p-empty');
    if (emptyEl) emptyEl.style.display = data.length === 0 ? 'block' : 'none';

    // Update summary badges
    updatePersonnelSummary();
}

function updatePersonnelSummary() {
    const data = state.personnelData || [];
    const badgesEl = document.getElementById('p-summary-badges');
    const footerEl = document.getElementById('p-footer');
    if (!badgesEl) return;

    const total  = data.length;
    const male   = data.filter(p => p.gen === 'Male').length;
    const female = data.filter(p => p.gen === 'Female').length;

    badgesEl.innerHTML = `
        <span style="background:rgba(255,255,255,0.2);color:white;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            <i class="fas fa-users"></i> ${total} Total
        </span>
        <span style="background:rgba(33,150,243,0.3);color:#bbdefb;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            â™‚ ${male} Male
        </span>
        <span style="background:rgba(233,30,99,0.3);color:#f8bbd0;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            â™€ ${female} Female
        </span>`;

    if (footerEl) {
        const positions = {};
        data.forEach(p => { if (p.pos && p.pos !== 'Select') positions[p.pos] = (positions[p.pos]||0)+1; });
        const posStr = Object.entries(positions).map(([k,v]) => `${k}: ${v}`).join(' &nbsp;|&nbsp; ');
        footerEl.innerHTML = posStr
            ? `<i class="fas fa-id-badge" style="color:#2e7d32;"></i> &nbsp; ${posStr}`
            : '';
    }
}

function pRowEdit(i) {
    const row = document.getElementById('p-row-' + i);
    if (!row) return;
    row.querySelectorAll('input').forEach(el => el.disabled = false);
    row.querySelectorAll('select').forEach(el => { el.disabled = false; el.style.display = ''; });
    row.querySelectorAll('.p-pos-badge').forEach(el => el.style.display = 'none');
    row.classList.add('p-editing');
    const editBtn = document.getElementById('p-edit-btn-' + i);
    const saveBtn = document.getElementById('p-save-btn-' + i);
    if (editBtn) editBtn.style.display = 'none';
    if (saveBtn) { saveBtn.style.display = 'inline-flex'; }
}

function pRowSave(i) {
    const row = document.getElementById('p-row-' + i);
    if (!row) return;
    row.querySelectorAll('input').forEach(el => el.disabled = true);
    row.querySelectorAll('select').forEach(el => { el.disabled = true; el.style.display = 'none'; });
    row.querySelectorAll('.p-pos-badge').forEach(el => el.style.display = '');
    row.classList.remove('p-editing');
    const editBtn = document.getElementById('p-edit-btn-' + i);
    const saveBtn = document.getElementById('p-save-btn-' + i);
    if (editBtn) editBtn.style.display = 'inline-flex';
    if (saveBtn) saveBtn.style.display = 'none';
    saveUserData(state.currentUser.email);
    renderPTable(); // refresh badges
}

function pRowDelete(i) {
    state.personnelData.splice(i, 1);
    renderPTable();
    saveUserData(state.currentUser.email);
}

function filterPTable() {
    const column = document.getElementById('p-filter-column').value;
    const filterValue = document.getElementById('p-filter-value').value.toLowerCase();
    const tbody = document.getElementById('p-body');
    
    if (!tbody || !state.personnelData) return;
    
    // If no filter value, show all rows
    if (!filterValue) {
        tbody.querySelectorAll('tr').forEach(row => row.style.display = '');
        return;
    }
    
    // Filter based on selected column
    const rows = tbody.querySelectorAll('tr');
    state.personnelData.forEach((person, i) => {
        let shouldShow = false;
        
        if (column === 'all') {
            // Search all columns
            shouldShow = 
                (person.name || '').toLowerCase().includes(filterValue) ||
                (person.pos || '').toLowerCase().includes(filterValue) ||
                (person.id || '').toLowerCase().includes(filterValue) ||
                (person.current || '').toLowerCase().includes(filterValue) ||
                (person.gen || '').toLowerCase().includes(filterValue) ||
                (person.mail || '').toLowerCase().includes(filterValue) ||
                (person.num || '').toLowerCase().includes(filterValue) ||
                (person.addr || '').toLowerCase().includes(filterValue);
        } else {
            // Search specific column
            const fieldValue = (person[column] || '').toLowerCase();
            shouldShow = fieldValue.includes(filterValue);
        }
        
        if (rows[i]) {
            rows[i].style.display = shouldShow ? '' : 'none';
        }
    });
}

// --- INCIDENT TABULATION RATE SYSTEM (merged into Statistics Rate tab) ---

/**
 * Computes aggregate tabulation stats from all projects' rates + exposures data.
 */
function computeAggregateTabulation() {
    // Aggregate across ALL projects and ALL 12 months
    let totalManHours   = 0;   // from exposures_Total Exposed Manhour
    let ltaCases        = 0;   // from medical_LTA  (Lost Time Accidents)
    let medTreatment    = 0;   // from medical_Medical Treatment
    let firstAid        = 0;   // from medical_First Aid
    let fatality        = 0;   // from medical_Fatality
    let highPotential   = 0;   // from medical_High-Potential incident
    let lostDaysTotal   = 0;   // from exposures_No. of Days w/o LTA (inverse: total days - days without LTA)
    // Also try to get lost days from a dedicated field if present
    // We'll approximate: No. of Days w/o LTA is NOT the same as lost days.
    // For lost days we use the SEVERITY RATE Ã— TotalHours / 1,000,000 approach as fallback.
    let totalSeveritySum = 0;  // sum of Severity Rate values per month (fallback for lost days)

    state.projects.forEach(p => {
        for (let i = 1; i <= 12; i++) {
            totalManHours   += parseFloat(p.vals['exposures_Total Exposed Manhour']?.[i]) || 0;
            ltaCases        += parseFloat(p.vals['medical_LTA']?.[i])                     || 0;
            medTreatment    += parseFloat(p.vals['medical_Medical Treatment']?.[i])       || 0;
            firstAid        += parseFloat(p.vals['medical_First Aid']?.[i])               || 0;
            fatality        += parseFloat(p.vals['medical_Fatality']?.[i])                || 0;
            highPotential   += parseFloat(p.vals['medical_High-Potential incident']?.[i]) || 0;
            totalSeveritySum+= parseFloat(p.vals['rates_SEVERITY RATE']?.[i])             || 0;
        }
    });

    // Recordable Cases = LTA + Medical Treatment + Fatality + High-Potential
    // (First Aid is typically NOT recordable under OSHS, but included if needed)
    const recordableCases = ltaCases + medTreatment + fatality + highPotential;

    // Lost Days: back-calculate from Severity Rate if no direct field
    // SR (OSHS) = LostDays Ã— 1,000,000 / ManHours  â†’  LostDays = SR Ã— ManHours / 1,000,000
    // We use the average SR per month that has data, multiplied by total hours
    let lostDays = 0;
    if (totalManHours > 0 && totalSeveritySum > 0) {
        // Count months that have severity data
        let srMonthCount = 0;
        state.projects.forEach(p => {
            for (let i = 1; i <= 12; i++) {
                if (parseFloat(p.vals['rates_SEVERITY RATE']?.[i]) > 0) srMonthCount++;
            }
        });
        const avgSR = srMonthCount > 0 ? totalSeveritySum / srMonthCount : totalSeveritySum;
        lostDays = Math.round((avgSR * totalManHours) / 1000000);
    }

    // OSHS Formula (Philippines standard) â€” base: 1,000,000 man-hours
    // LTIR = LTA Cases Ã— 1,000,000 / Total Man-hours
    // TRIR = Recordable Cases Ã— 1,000,000 / Total Man-hours
    // SR   = Lost Days Ã— 1,000,000 / Total Man-hours
    // OSHA Formula â€” base: 200,000 man-hours
    // LTIR = LTA Cases Ã— 200,000 / Total Man-hours
    // TRIR = Recordable Cases Ã— 200,000 / Total Man-hours
    // SR   = Lost Days Ã— 200,000 / Total Man-hours

    let ltirOsha = 0, ltirOshs = 0, trirOsha = 0, trirOshs = 0, srOsha = 0, srOshs = 0;
    if (totalManHours > 0) {
        ltirOsha = (ltaCases        * 200000)   / totalManHours;
        ltirOshs = (ltaCases        * 1000000)  / totalManHours;
        trirOsha = (recordableCases * 200000)   / totalManHours;
        trirOshs = (recordableCases * 1000000)  / totalManHours;
        srOsha   = (lostDays        * 200000)   / totalManHours;
        srOshs   = (lostDays        * 1000000)  / totalManHours;
    }

    return {
        recordableCases: recordableCases,
        lostDays:        lostDays,
        totalHours:      Math.round(totalManHours),
        ltaCases:        ltaCases,
        ltirOsha:  ltirOsha.toFixed(4), ltirOshs:  ltirOshs.toFixed(4),
        trirOsha:  trirOsha.toFixed(4), trirOshs:  trirOshs.toFixed(4),
        srOsha:    srOsha.toFixed(4),   srOshs:    srOshs.toFixed(4)
    };
}

/**
 * Returns the HTML string for the Incident Tabulation Rate panel.
 * Injected at the TOP of the Statistics Rate tab on every render.
 */
function buildIncidentTabulationHTML() {
    const d = computeAggregateTabulation();
    return `
    <div id="incident-tabulation-panel" style="padding: 20px 20px 0 20px;">
      <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); margin-bottom: 6px;">

        <!-- Panel header -->
        <div style="background: linear-gradient(90deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 14px 20px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
          <i class="fas fa-calculator" style="font-size: 1.1rem;"></i>
          <span style="font-weight: 700; font-size: 1rem; letter-spacing: 0.5px;">INCIDENT TABULATION RATE</span>
          <span style="background: var(--safety-yellow); color: #1b5e20; padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 800; margin-left: 4px;">AUTO-COMPUTED FROM ALL PROJECTS</span>
        </div>

        <!-- 4 summary cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">

          <div style="padding: 18px 20px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">No. of LTA Cases</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #1b5e20; line-height: 1;">${d.ltaCases}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">Lost Time Accidents YTD</div>
          </div>

          <div style="padding: 18px 20px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">No. of Recordable Cases</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #e65100; line-height: 1;">${d.recordableCases}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">LTA + Medical + Fatality + High-Pot.</div>
          </div>

          <div style="padding: 18px 20px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">No. of Lost Days</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #1565c0; line-height: 1;">${d.lostDays}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">From Severity Rate data</div>
          </div>

          <div style="padding: 18px 20px; text-align: center;">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">Total Man-hours Exposure</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #b71c1c; line-height: 1;">${d.totalHours.toLocaleString()}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">Total Exposed Manhour YTD</div>
          </div>

        </div>

        <!-- Rates results table -->
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.82rem;">
            <thead>
              <tr>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 12px 15px; text-align: left; border: none; width: 40%;">INJURY / ILLNESS</th>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 12px 15px; text-align: center; border: none; width: 30%;">OSHA<br><span style="font-size:0.72rem;font-weight:400;">200,000 hrs base</span></th>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 12px 15px; text-align: center; border: none; width: 30%;">OSHS<br><span style="font-size:0.72rem;font-weight:400;">1,000,000 hrs base</span></th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:14px 15px;border:none;">
                  <div style="font-weight:700;font-size:0.88rem;">LTIR â€” Lost Time Incident Rate</div>
                  <div style="font-size:0.66rem;opacity:0.9;margin-top:3px;">LTA Cases Ã— 200K or 1M Ã· Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1b5e20;">${d.ltirOsha}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1b5e20;">${d.ltirOshs}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:14px 15px;border:none;">
                  <div style="font-weight:700;font-size:0.88rem;">TRIR â€” Total Recordable Incident Rate</div>
                  <div style="font-size:0.66rem;opacity:0.9;margin-top:3px;">Recordable Cases Ã— 200K or 1M Ã· Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1565c0;">${d.trirOsha}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1565c0;">${d.trirOshs}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
              </tr>
              <tr>
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:14px 15px;border:none;">
                  <div style="font-weight:700;font-size:0.88rem;">SR â€” Severity Rate</div>
                  <div style="font-size:0.66rem;opacity:0.9;margin-top:3px;">Total Days Lost Ã— 200K or 1M Ã· Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#b71c1c;">${d.srOsha}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#b71c1c;">${d.srOshs}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>`;
}



// ==================== LOCAL STORAGE FUNCTIONS ====================

// Save to localStorage only (called internally, no Firebase trigger)
function saveUserDataLocal(email) {
    if (!email) return;
    
    const userData = {
        projects: state.projects.map(p => { const c = {...p}; delete c.selected; return c; }),
        personnelData: state.personnelData,
        incidentRateData: state.incidentRateData,
        darkMode: state.darkMode,
        lastSaved: new Date().toISOString(),
        timestamp: Date.now(),
        lastModified: new Date().toISOString()
    };
    
    localStorage.setItem('esh_dashboard_' + email, JSON.stringify(userData));
    localStorage.setItem('esh_' + email, JSON.stringify(userData));
    console.log('ðŸ’¾ Saved to localStorage (local only)');
}

// Main Firebase Save Button Handler
async function saveToFirebaseMain() {
    const btn = document.getElementById('main-firebase-save-btn');
    const btnText = document.getElementById('main-save-text');
    
    if (!btn || !btnText) return;
    
    // Visual feedback
    btn.classList.add('saving');
    btn.disabled = true;
    btnText.textContent = 'SAVING...';
    
    // Save to Firebase
    const success = await saveToFirebase();
    
    if (success) {
        btnText.textContent = 'âœ“ SAVED!';
        setTimeout(() => {
            btnText.textContent = 'SAVE TO FIREBASE';
            btn.classList.remove('saving');
            btn.disabled = false;
        }, 2000);
    } else {
        btnText.textContent = 'âœ— FAILED';
        setTimeout(() => {
            btnText.textContent = 'SAVE TO FIREBASE';
            btn.classList.remove('saving');
            btn.disabled = false;
        }, 2000);
    }
}

// ==================== OPTIMIZED FIREBASE INTEGRATION ====================

let firebaseReady = false;
let firebaseUnsubscribe = null;

function getCurrentUserId() {
    return window.firebaseAuth?.currentUser?.uid || 'local-user';
}

function waitForFirebase() {
    return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
            if (window.firebase && window.firebaseDb && window.firebaseAuth) {
                clearInterval(checkInterval);
                firebaseReady = true;
                resolve();
            }
        }, 100);
    });
}

// OPTIMIZED: Save to Firebase - MANUAL ONLY
async function saveToFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('â³ Firebase not ready');
        return false;
    }

    try {
        const userId = getCurrentUserId();
        const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
        
        const dataToSave = {
            email: state.currentUser?.email || 'local-user',
            displayName: state.currentUser?.displayName || localStorage.getItem('esh_displayname_' + state.currentUser?.email) || '',
            projects: state.projects || [],
            personnelData: state.personnelData || [],
            incidentRateData: state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
            darkMode: state.darkMode || false,
            lastUpdated: new Date().toISOString(),
            timestamp: Date.now()
        };

        await window.firebase.setDoc(docRef, dataToSave, { merge: true });
        state.lastSyncTimestamp = dataToSave.timestamp;
        console.log('âœ… Data saved to Firebase:', new Date().toLocaleTimeString());
        return true;
        
    } catch (error) {
        console.error('âŒ Error saving to Firebase:', error);
        alert('Failed to save: ' + error.message);
        return false;
    }
}

// OPTIMIZED: Load from Firebase - ONCE on login only  
async function loadFromFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('â³ Firebase not ready, loading from localStorage only');
        loadFromLocalStorage();
        return;
    }

    try {
        const userId = getCurrentUserId();
        const userEmail = state.currentUser?.email;
        const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
        const docSnap = await window.firebase.getDoc(docRef);

        // Check localStorage for newer unsaved data
        const localKey = `esh_dashboard_${userEmail}`;
        const localRaw = localStorage.getItem(localKey);
        const localData = localRaw ? JSON.parse(localRaw) : null;
        const localTimestamp = localData?.lastSaved ? new Date(localData.lastSaved).getTime() : 0;

        if (docSnap.exists()) {
            const fbData = docSnap.data();
            const fbTimestamp = fbData.timestamp || 0;

            // Use whichever is newer: localStorage or Firebase
            if (localTimestamp > fbTimestamp) {
                console.log('ðŸ’¾ localStorage is newer than Firebase â€” loading from localStorage');
                state.projects = localData.projects || [];
                state.personnelData = localData.personnelData || [];
                state.incidentRateData = localData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.darkMode = fbData.darkMode || false;
                state.lastSyncTimestamp = fbTimestamp;
                // Push local data up to Firebase so it's in sync
                await saveToFirebase();
            } else {
                console.log('â˜ï¸ Firebase is newer â€” loading from Firebase');
                state.projects = fbData.projects || [];
                state.personnelData = fbData.personnelData || [];
                state.incidentRateData = fbData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.darkMode = fbData.darkMode || false;
                state.lastSyncTimestamp = fbTimestamp;
                // Sync Firebase data down to localStorage (use local-only save to avoid loop)
                saveUserDataLocal(userEmail);
            }
            
            // Load display name from Firebase
            if (fbData.displayName) {
                state.currentUser.displayName = fbData.displayName;
                localStorage.setItem('esh_displayname_' + userEmail, fbData.displayName);
                // Update sidebar badge
                const badge = document.getElementById('user-badge');
                if (badge) badge.innerHTML = `<i class="fas fa-user-circle"></i> ${fbData.displayName}`;
            }

            // Apply dark mode
            if (state.darkMode) {
                document.body.classList.add('dark-mode');
            }
            
            state.filteredProjects = [...state.projects];
            console.log('âœ… Data loaded. Projects:', state.projects.length, '| Personnel:', state.personnelData.length);

        } else {
            // No Firebase doc yet â€” use localStorage if available, else start fresh
            if (localData) {
                console.log('ðŸ“ No Firebase doc â€” restoring from localStorage');
                state.projects = localData.projects || [];
                state.personnelData = localData.personnelData || [];
                state.incidentRateData = localData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.filteredProjects = [...state.projects];
            } else {
                console.log('ðŸ“ No data anywhere â€” creating new document');
            }
            await saveToFirebase();
        }
        
        // Update UI
        render();
        renderPTable();
        
    } catch (error) {
        console.error('âŒ Error loading from Firebase:', error);
        // Fallback to localStorage on error
        loadFromLocalStorage();
    }
}

// Fallback: load from localStorage only
function loadFromLocalStorage() {
    const userEmail = state.currentUser?.email;
    if (!userEmail) return;
    const localKey = `esh_dashboard_${userEmail}`;
    const localRaw = localStorage.getItem(localKey);
    if (localRaw) {
        const data = JSON.parse(localRaw);
        state.projects = data.projects || [];
        state.personnelData = data.personnelData || [];
        state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
        state.filteredProjects = [...state.projects];
        console.log('ðŸ’¾ Loaded from localStorage fallback');
        render();
        renderPTable();
    }
}

// REMOVED: Real-time listener completely - saves lots of Firebase reads!
// No setupFirebaseListener() function = no continuous reads

// Firebase Authentication Handlers
async function firebaseLogin(email, password) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('âœ… Login successful:', userCredential.user.email);
        return true;
    } catch (error) {
        console.error('âŒ Login error:', error);
        alert('Login failed: ' + error.message);
        return false;
    }
}

async function firebaseSignup(email, password) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('âœ… Signup successful:', userCredential.user.email);
        
        // Initialize user data
        await saveToFirebase();
        
        return true;
    } catch (error) {
        console.error('âŒ Signup error:', error);
        alert('Signup failed: ' + error.message);
        return false;
    }
}

async function firebaseLogout() {
    if (!window.firebase) {
        return;
    }

    try {
        await window.firebase.signOut(window.firebaseAuth);
        
        // Unsubscribe from listener (if any exists)
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
            firebaseUnsubscribe = null;
        }
        
        console.log('âœ… Logout successful');
    } catch (error) {
        console.error('âŒ Logout error:', error);
    }
}

async function firebaseChangePassword(newPassword) {
    if (!window.firebase || !window.firebaseAuth.currentUser) {
        alert('Not authenticated');
        return false;
    }

    try {
        await window.firebase.updatePassword(window.firebaseAuth.currentUser, newPassword);
        console.log('âœ… Password changed successfully');
        return true;
    } catch (error) {
        console.error('âŒ Password change error:', error);
        return false;
    }
}

async function firebaseResetPassword(email) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        await window.firebase.sendPasswordResetEmail(window.firebaseAuth, email);
        console.log('âœ… Password reset email sent');
        return true;
    } catch (error) {
        console.error('âŒ Password reset error:', error);
        return false;
    }
}

// Auth State Observer - OPTIMIZED: No real-time listener!
function setupAuthObserver() {
    if (!window.firebase) {
        return;
    }

    window.firebase.onAuthStateChanged(window.firebaseAuth, async (user) => {
        // Always hide the loading overlay once Firebase responds
        const loadingOverlay = document.getElementById('firebase-loading-overlay');
        if (loadingOverlay) loadingOverlay.style.display = 'none';

        if (user) {
            console.log('ðŸ‘¤ User authenticated:', user.email);
            state.currentUser = { email: user.email, uid: user.uid };
            state.isLoggedIn = true;

            // Hide login, show main UI
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';

            // Update user badge
            const userBadge = document.getElementById('user-badge');
            if (userBadge) {
                userBadge.innerHTML = `<i class="fas fa-user-circle"></i> ${user.email}`;
            }

            // Update user-email field (settings page)
            const userEmailEl = document.getElementById('user-email');
            if (userEmailEl) {
                userEmailEl.textContent = user.email;
            }

            // Show dashboard UI
            showUI();
            initDarkMode();

            // Load user data ONCE - no real-time listener!
            await loadFromFirebase();

        } else {
            console.log('ðŸ‘¤ No user authenticated â€” showing login screen');
            state.currentUser = null;
            state.isLoggedIn = false;

            // Show login overlay
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'flex';

            // Hide main UI
            const sidebar = document.getElementById('main-sidebar');
            const content = document.getElementById('main-content');
            if (sidebar) sidebar.classList.add('hidden');
            if (content) content.classList.add('hidden');

            // Reset login button state if it got stuck
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }
        }
    });
}

// CRITICAL FIX: saveUserData now saves to BOTH localStorage AND Firebase
// so data is never lost on refresh
const originalSaveUserData = window.saveUserData || function() {};

window.saveUserData = function(email) {
    // Always save to localStorage first (instant, no network)
    originalSaveUserData(email);
    
    // Also auto-save to Firebase if ready (prevents data loss on refresh)
    if (firebaseReady && window.firebaseDb && state.currentUser) {
        saveToFirebase().then(success => {
            if (success) console.log('â˜ï¸ Auto-synced to Firebase');
        }).catch(err => console.warn('âš ï¸ Firebase auto-sync failed:', err.message));
    }
};

// Initialize Firebase Integration
waitForFirebase().then(async () => {
    console.log('ðŸ”¥ Firebase Ready! (OPTIMIZED MODE)');
    
    // Setup auth observer â€” handles login state, UI show/hide, and data loading
    setupAuthObserver();
});

console.log('ðŸ”¥ Firebase integration loaded - OPTIMIZED: Save button only!');

// ==================== END FIREBASE INTEGRATION ====================
    </script>

    <!-- Main Firebase Save Button (Floating) -->
    <button class="main-firebase-save-btn" id="main-firebase-save-btn" onclick="saveToFirebaseMain()" title="Save all data to Firebase Cloud">
        <i class="fas fa-cloud-upload-alt save-icon"></i>
        <span id="main-save-text">SAVE UPDATE</span>
        <span class="pulse-dot"></span>
    </button>

</body>
</html>
