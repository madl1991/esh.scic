<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESH COMPLIANCE DASHBOARD - SCIC</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>


    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getDatabase, ref as dbRef, set, push, update, onValue, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‚ö†Ô∏è SECURITY WARNING: API Keys Exposed
        // Dapat gamitin ang Firebase Security Rules at gawing private ang sensitive credentials.
        // I-configure ang Firestore/Database rules sa Firebase Console para sa proper access control.
        const firebaseConfig = {
            apiKey: "AIzaSyBdqVEm3PWPuFTVbrxaP4JAZNXl2bmNUg4",
            authDomain: "esh-dashboard.firebaseapp.com",
            databaseURL: "https://esh-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "esh-dashboard",
            storageBucket: "esh-dashboard.firebasestorage.app",
            messagingSenderId: "121684914529",
            appId: "1:121684914529:web:d5292a3c30f1bba2959520",
            measurementId: "G-TXYB9T0T3W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const storage = getStorage(app);
        const realtimeDb = getDatabase(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseRealtimeDb = realtimeDb;
        window.firebase = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            sendPasswordResetEmail,
            doc,
            setDoc,
            getDoc,
            ref,
            uploadBytes,
            getDownloadURL,
            deleteObject,
            dbRef,
            set,
            push,
            update,
            remove,
            onValue,
            onDisconnect,
            serverTimestamp
        };

        console.log("‚úÖ Firebase initialized!");
    </script>
    <style>
        :root {
            --safety-green-grad: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            --header-grad: linear-gradient(90deg, #1b5e20 0%, #388e3c 100%);
            --safety-yellow: #fbc02d;
            --bg-body: #ced4da;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-card: #ffffff;
            --border-color: #eee;
            --table-header: #2e7d32;
            --input-bg: #fdfdfd;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --text-primary: #e4e4e4;
            --text-secondary: #b0b0b0;
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --border-color: #444;
            --table-header: #1b5e20;
            --input-bg: #3a3a3a;
        }


        #safety-reminder-container {
            position: fixed;
            bottom: -300px;
            right: 30px;
            z-index: 9999;
            transition: bottom 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #safety-reminder-container.show {
            bottom: 30px;
        }

        .safety-character {
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        /* 3D Emoji Character */
        .character-emoji {
            font-size: 100px;
            animation: walk 0.6s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
            user-select: none;
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0px) rotate(-2deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        /* Speech Bubble */
        .reminder-bubble {
            background: white;
            padding: 20px 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 300px;
            max-width: 360px;
            position: relative;
            border: 3px solid #2e7d32;
        }

        body.dark-mode .reminder-bubble {
            background: #2d2d2d;
            color: #e4e4e4;
            border-color: #4caf50;
        }

        .reminder-bubble::before {
            content: '';
            position: absolute;
            bottom: 30px;
            right: -15px;
            width: 0;
            height: 0;
            border-left: 20px solid #2e7d32;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
        }

        body.dark-mode .reminder-bubble::before {
            border-left-color: #4caf50;
        }

        .reminder-bubble::after {
            content: '';
            position: absolute;
            bottom: 30px;
            right: -11px;
            width: 0;
            height: 0;
            border-left: 16px solid white;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        body.dark-mode .reminder-bubble::after {
            border-left-color: #2d2d2d;
        }

        .reminder-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .reminder-icon {
            font-size: 28px;
        }

        .reminder-title {
            font-weight: 700;
            font-size: 18px;
            color: #2e7d32;
        }

        body.dark-mode .reminder-title {
            color: #81c784;
        }

        .reminder-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }

        body.dark-mode .reminder-text {
            color: #e4e4e4;
        }

        .reminder-dismiss {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }


        body.dark-mode .reminder-dismiss {
            background: #4caf50;
        }


        /* ==================== END SAFETY REMINDER CHARACTER ==================== */

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        /* Smooth scrolling for all devices */
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }
        
        body { 
            margin: 0; 
            background: var(--bg-body); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Prevent text selection on buttons for better UX */
        button,
        .btn,
        .nav-item {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #login-overlay {
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 40%, #2e7d32 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000; 
            padding: 20px;
            overflow: hidden;
        }

        /* Animated background circles */
        #login-overlay::before {
            content: '';
            position: absolute;
            top: -20%;
            right: -10%;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(251,192,45,0.15) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        #login-overlay::after {
            content: '';
            position: absolute;
            bottom: -25%;
            left: -15%;
            width: 700px;
            height: 700px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-30px, -40px) scale(1.05); }
            50% { transform: translate(20px, 30px) scale(0.95); }
            75% { transform: translate(-20px, 20px) scale(1.02); }
        }

        /* Safety & Health Background Icons */
        .safety-bg-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.06;
            overflow: hidden;
        }

        .safety-icon-float {
            position: absolute;
            font-size: 80px;
            color: #ffffff;
            animation: floatIcon 15s ease-in-out infinite;
        }

        .safety-icon-float:nth-child(1) {
            top: 10%;
            left: 8%;
            animation-delay: 0s;
            animation-duration: 18s;
        }

        .safety-icon-float:nth-child(2) {
            top: 15%;
            right: 12%;
            animation-delay: 2s;
            animation-duration: 22s;
        }

        .safety-icon-float:nth-child(3) {
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
            animation-duration: 20s;
        }

        .safety-icon-float:nth-child(4) {
            bottom: 15%;
            right: 10%;
            animation-delay: 1s;
            animation-duration: 19s;
        }

        .safety-icon-float:nth-child(5) {
            top: 50%;
            left: 5%;
            animation-delay: 3s;
            animation-duration: 21s;
        }

        .safety-icon-float:nth-child(6) {
            top: 45%;
            right: 8%;
            animation-delay: 5s;
            animation-duration: 17s;
        }

        @keyframes floatIcon {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.06;
            }
            25% {
                transform: translateY(-30px) rotate(5deg);
                opacity: 0.08;
            }
            50% {
                transform: translateY(-20px) rotate(-5deg);
                opacity: 0.04;
            }
            75% {
                transform: translateY(-35px) rotate(3deg);
                opacity: 0.07;
            }
        }

        /* Active Users Pulse Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.3);
            }
        }

        /* Construction/Safety Pattern Overlay */
        .safety-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.04;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(251, 192, 45, 0.3) 10px,
                    rgba(251, 192, 45, 0.3) 12px
                ),
                repeating-linear-gradient(
                    -45deg,
                    transparent,
                    transparent 10px,
                    rgba(251, 192, 45, 0.3) 10px,
                    rgba(251, 192, 45, 0.3) 12px
                );
            background-size: 100px 100px;
            background-position: 0 0, 50px 50px;
        }

        /* Warning Stripes Accent (bottom) */
        .warning-stripe {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                45deg,
                #fbc02d,
                #fbc02d 20px,
                #1b5e20 20px,
                #1b5e20 40px
            );
            opacity: 0.7;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 35px 35px;
            border-radius: 20px;
            width: 100%;
            max-width: 460px;
            position: relative;
            z-index: 1;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 -5px 30px rgba(251, 192, 45, 0.2) inset;
            border-top: 4px solid #fbc02d;
            color: var(--text-primary);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tab entrance animation - Slide from Right */
        @keyframes slideRight {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        body.dark-mode .login-card {
            background: rgba(45, 45, 45, 0.95);
        }

        .login-header {
            position: relative;
            margin-bottom: 25px;
            text-align: center;
        }

        .login-shield {
            width: 70px;
            height: 70px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 50%, #2e7d32 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(27, 94, 32, 0.4),
                0 0 0 8px rgba(251, 192, 45, 0.1);
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 
                    0 10px 30px rgba(27, 94, 32, 0.4),
                    0 0 0 8px rgba(251, 192, 45, 0.1);
            }
            50% {
                box-shadow: 
                    0 15px 40px rgba(27, 94, 32, 0.6),
                    0 0 0 12px rgba(251, 192, 45, 0.2);
            }
        }

        .login-shield::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbc02d, transparent, #fbc02d);
            opacity: 0.4;
            z-index: -1;
            animation: rotate 8s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .login-shield i {
            font-size: 2.5rem;
            color: #fbc02d;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .login-title {
            color: #1b5e20;
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: 0.8px;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            text-align: center;
        }

        .login-subtitle {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 0 8px 0;
            letter-spacing: 0.5px;
            text-align: center;
        }

        body.dark-mode .login-subtitle {
            color: #999;
        }

        .login-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%);
            color: #1b5e20;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 5px 16px;
            border-radius: 20px;
            letter-spacing: 1px;
            margin-top: 5px;
            box-shadow: 0 2px 8px rgba(251, 192, 45, 0.3);
        }

        .login-form {
            margin-top: 30px;
        }

        .login-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .login-input-group i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #2e7d32;
            font-size: 1rem;
            z-index: 1;
        }

        .login-card input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.95rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .login-card input:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .login-card input::placeholder {
            color: #999;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            margin-top: 25px;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(27, 94, 32, 0.3);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }



        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: wait;
            transform: none;
        }

        .disclaimer-box {
            background: linear-gradient(135deg, #fffbea 0%, #fff9e6 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            padding: 16px;
            margin-top: 30px;
            font-size: 0.75rem;
            color: #333;
            line-height: 1.6;
            position: relative;
            overflow: hidden;
            text-align: justify;
        }

        .disclaimer-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #fbc02d;
        }

        body.dark-mode .disclaimer-box {
            background: linear-gradient(135deg, #4a4a2d 0%, #3d3d25 100%);
            color: #e4e4e4;
        }

        .disclaimer-box strong {
            color: #1b5e20;
            font-size: 0.8rem;
        }

        body.dark-mode .disclaimer-box strong {
            color: #fbc02d;
        }

        /* ============================================
           RESPONSIVE DESIGN - MOBILE FIRST
           ============================================ */

        /* Tablet Styles (768px and below) - REMOVED */

        /* Small Mobile Styles (480px and below) - REMOVED */

        /* Large Desktop (1920px and above) */
        @media screen and (min-width: 1920px) {
            aside {
                width: 300px;
            }

            .login-card {
                max-width: 550px;
                padding: 60px 50px;
            }

            .header-title {
                font-size: 1.3rem;
            }

            .project-row {
                padding: 15px 20px;
            }

            .region-banner {
                padding: 20px 25px;
            }
        }

        /* Landscape Mode Adjustments */
        @media screen and (max-height: 600px) and (orientation: landscape) {
            .login-card {
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .login-shield {
                width: 60px;
                height: 60px;
            }

            .login-shield i {
                font-size: 1.8rem;
            }

            .login-title {
                font-size: 1rem;
                margin-bottom: 5px;
            }

            .login-subtitle {
                font-size: 0.75rem;
            }

            .disclaimer-box {
                margin-top: 15px;
                padding: 10px;
            }
        }

        /* Print Styles */
        @media print {
            aside,
            .mobile-menu-toggle,
            .theme-toggle,
            header .header-controls,
            .btn {
                display: none !important;
            }

            main {
                margin-left: 0;
            }

            body {
                background: white;
                color: black;
            }

            .project-row {
                page-break-inside: avoid;
                border: 1px solid #ccc;
            }
        }

        /* Reduce Motion for Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            body {
                background: white;
                color: black;
            }

            .btn-primary {
                background: #006400;
                border: 2px solid black;
            }

            .project-row {
                border: 2px solid black;
            }
        }

        /* Firebase init loading overlay */
        #firebase-loading-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            display: flex; align-items: center; justify-content: center; z-index: 20000; flex-direction: column; gap: 20px;
            animation: overlayTimeout 6.5s forwards;
        }
        @keyframes overlayTimeout {
            0%   { opacity: 1; pointer-events: all; }
            90%  { opacity: 1; pointer-events: all; }
            100% { opacity: 0; pointer-events: none; display: none; }
        }
        /* Shield Pulse Loader */
        #firebase-loading-overlay .shield-loader {
            width: 80px; 
            height: 80px; 
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: shieldPulse 1.5s ease-in-out infinite;
        }
        
        #firebase-loading-overlay .shield-loader i {
            font-size: 60px;
            color: #fbc02d;
            filter: drop-shadow(0 0 20px rgba(251, 192, 45, 0.6));
            animation: shieldGlow 2s ease-in-out infinite;
        }
        
        @keyframes shieldPulse {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.1);
            }
        }
        
        @keyframes shieldGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(251, 192, 45, 0.6));
                color: #fbc02d;
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(251, 192, 45, 0.9));
                color: #fdd835;
            }
        }
        
        #firebase-loading-overlay p {
            color: #a5d6a7; font-size: 0.95rem; font-weight: 700; letter-spacing: 1.5px; margin: 0;
            text-shadow: 0 0 10px rgba(165, 214, 167, 0.5);
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
            border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px;
        }

        aside {
            width: 260px; 
            background: linear-gradient(180deg, #1b5e20 0%, #2e7d32 50%, #43a047 100%);
            color: white;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            overflow-y: auto;
            padding: 20px 15px;
        }

        .sidebar-header { 
            padding-bottom: 20px; 
            margin-bottom: 20px;
            text-align: center; 
        }
        .nav-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.75rem;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            pointer-events: auto !important;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-item:hover { 
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        .nav-item.active { 
            background: linear-gradient(135deg, #fbc02d, #f57f17);
            color: #1b5e20;
            border-left: 3px solid #fff;
            font-weight: 700;
        }
        
        /* Collapsible Navigation Groups */
        .nav-group {
            margin-bottom: 5px;
        }
        
        .nav-group-header {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 12px;
            margin-bottom: 3px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.65rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s;
            user-select: none;
        }
        
        .nav-group-header:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .nav-group-header i.chevron {
            font-size: 0.7rem;
            transition: transform 0.3s;
        }
        
        .nav-group-header.collapsed i.chevron {
            transform: rotate(-90deg);
        }
        
        .nav-group-items {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
        }
        
        .nav-group-items.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .nav-group-items .nav-item {
            padding-left: 25px;
            font-size: 0.72rem;
        }
        
        main { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; background: var(--bg-body); }
        
        header {
            background: var(--bg-card); padding: 12px 15px; border-bottom: 1px solid var(--border-color); position: sticky;
            top: 0; z-index: 90; display: flex; gap: 15px; align-items: center; justify-content: space-between;
            flex-wrap: wrap;
        }

        .header-title { font-size: 1.1rem; color: #1b5e20; font-weight: 600; }
        .header-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .header-controls input, .header-controls select {
            padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;
            background: var(--input-bg); color: var(--text-primary);
        }

        /* Dark Mode Toggle Button */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1rem;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }



        /* Year Selector Styles */
        .year-selector-container {
            position: relative;
            display: inline-block;
        }

        .year-selector-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #year-selector-label {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: inherit;
            line-height: 1;
            display: flex;
            align-items: center;
        }


        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           UNIFIED DROPDOWN SYSTEM ‚Äî Option B Style
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .year-dropdown,
        .device-dropdown,
        .users-dropdown,
        .notification-dropdown,
        .settings-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06);
            z-index: 1000;
            overflow: hidden;
            animation: dropdownSlideIn 0.2s ease-out;
        }

        body.dark-mode .year-dropdown,
        body.dark-mode .device-dropdown,
        body.dark-mode .users-dropdown,
        body.dark-mode .notification-dropdown,
        body.dark-mode .settings-dropdown {
            box-shadow: 0 8px 30px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Shared header */
        .ud-header {
            padding: 13px 15px 11px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ud-header-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: #e8f5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        body.dark-mode .ud-header-icon { background: rgba(46,125,50,0.2); }
        .ud-header-icon i { color: #2e7d32; font-size: 0.75rem; }
        body.dark-mode .ud-header-icon i { color: #66bb6a; }
        .ud-header-text { font-size: 0.82rem; font-weight: 700; color: var(--text-primary); }
        .ud-header-sub  { font-size: 0.67rem; color: var(--text-secondary); margin-top: 1px; }

        /* Shared item */
        .ud-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .ud-item-icon {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        .ud-item-label { flex: 1; font-size: 0.8rem; font-weight: 500; color: var(--text-primary); }
        .ud-item-arrow { font-size: 0.58rem; color: #ccc; }
        .ud-divider { height: 1px; background: var(--border-color); margin: 4px 0; }
        .ud-body { padding: 8px; }

        /* Logout item */
        .ud-item.logout .ud-item-label { color: #c62828; }
        .ud-item.logout .ud-item-icon  { background: #fff0f0 !important; }
        .ud-item.logout .ud-item-icon i { color: #c62828 !important; }

        /* Year sizing */
        .year-dropdown { min-width: 100px; width: fit-content; }
        .year-dropdown .ud-header { justify-content: center; text-align: center; }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Year options */

        .year-options {
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .year-option {
            padding: 7px 16px;
            cursor: pointer;
            border-radius: 7px;
            margin: 2px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: background 0.15s;
            white-space: nowrap;
            text-align: center;
        }


        .year-option.active {
            background: #c8e6c9;
            color: #1b5e20;
            font-weight: 800;
        }

        body.dark-mode .year-option.active {
            background: rgba(46,125,50,0.35);
            color: #43a047;
            font-weight: 800;
        }

        .year-add-btn {
            width: 100%;
            padding: 9px;
            background: none;
            border: none;
            border-top: 1px solid var(--border-color);
            color: #2e7d32;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: inherit;
        }

        body.dark-mode .year-add-btn { color: #66bb6a; }


        /* ========== DEVICE COUNTER & ACTIVE USERS ========== */
        .device-counter-container,
        .active-users-container {
            position: relative;
            display: inline-block;
        }

        .device-counter-btn,
        .active-users-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }


        .counter-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #2e7d32;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0 4px;
        }

        .device-dropdown,
        .users-dropdown { min-width: 300px; max-width: 380px; }

        .dropdown-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 8px;
        }

        /* dropdown-item: used by device & users rendered lists */
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 7px;
            margin: 2px 0;
            transition: background 0.15s;
        }


        /* device item inner */
        .device-info { display: flex; align-items: center; gap: 10px; flex: 1; }

        .device-icon-box {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            background: #e8f5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        body.dark-mode .device-icon-box { background: rgba(46,125,50,0.2); }

        .device-icon { font-size: 0.82rem; color: #2e7d32; }
        body.dark-mode .device-icon { color: #66bb6a; }

        .device-details { flex: 1; }
        .device-name { font-weight: 600; font-size: 0.78rem; color: var(--text-primary); margin-bottom: 1px; }
        .device-meta  { font-size: 0.68rem; color: var(--text-secondary); }

        /* user item inner */
        .user-info { display: flex; align-items: center; gap: 10px; flex: 1; }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.72rem;
            color: white;
            flex-shrink: 0;
        }

        .user-details { flex: 1; }
        .user-name     { font-weight: 600; font-size: 0.78rem; color: var(--text-primary); margin-bottom: 1px; }
        .user-activity { font-size: 0.68rem; color: var(--text-secondary); margin-bottom: 3px; }

        .user-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status-online  { background: #e8f5e9; color: #2e7d32; }
        .status-idle    { background: #fff8e1; color: #f57c00; }
        .status-offline { background: #fce4ec; color: #c62828; }

        body.dark-mode .status-online  { background: rgba(76,175,80,0.2);  color: #81c784; }
        body.dark-mode .status-idle    { background: rgba(255,152,0,0.2);   color: #ffb74d; }
        body.dark-mode .status-offline { background: rgba(244,67,54,0.2);   color: #e57373; }


        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online .status-indicator {
            background: #2e7d32;
        }

        .status-idle .status-indicator {
            background: #f57c00;
        }

        .status-offline .status-indicator {
            background: #c62828;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dropdown-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .dropdown-empty i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* ========== NOTIFICATION BELL DROPDOWN ========== */
        .notification-bell-container {
            position: relative;
            display: inline-block;
        }

        .notification-bell-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            position: relative;
        }


        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #d32f2f;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .notification-dropdown {
            min-width: 320px;
            max-width: 380px;
        }

        .notification-list {
            max-height: 380px;
            overflow-y: auto;
            padding: 5px;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-item:last-child { border-bottom: none; }


        .notif-icon-box {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            background: #fff3e0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .notif-icon-box i { font-size: 0.72rem; color: #e65100; }

        .notification-project {
            font-weight: 700;
            color: #c62828;
            font-size: 0.78rem;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-empty {
            padding: 30px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .notification-empty i {
            font-size: 2.5rem;
            color: #4caf50;
            margin-bottom: 10px;
            display: block;
        }

        /* ========== DEVICE COUNTER & ACTIVE USERS (ADMIN ONLY) ========== */
        .device-counter-container,
        .active-users-container {
            position: relative;
            display: inline-block;
        }

        .device-counter-btn,
        .active-users-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }


        .device-count,
        .users-count {
            background: #2e7d32;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .device-dropdown,
        .active-users-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-card);
            border: 2px solid #2e7d32;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(46, 125, 50, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            overflow: hidden;
            animation: dropdownSlideIn 0.2s ease-out;
        }

        .device-dropdown-header,
        .active-users-dropdown-header {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            padding: 12px 15px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-list,
        .active-users-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 5px;
        }

        .device-item,
        .active-user-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }



        .device-item:last-child,
        .active-user-item:last-child {
            border-bottom: none;
        }

        .device-platform {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-details {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .user-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background: #4caf50;
            box-shadow: 0 0 6px #4caf50;
        }

        .status-idle {
            background: #ff9800;
        }

        .status-offline {
            background: #9e9e9e;
        }

        .user-activity {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-activity-icon {
            font-size: 0.7rem;
        }

        /* ========== SETTINGS DROPDOWN (FACEBOOK STYLE) ========== */
        .settings-dropdown-container {
            position: relative;
            display: inline-block;
        }

        .settings-dropdown-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }


        .settings-dropdown { min-width: 230px; }

        /* settings-menu-item kept for backwards compat but now uses ud-item style */
        .settings-menu { padding: 8px; }

        .settings-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
        }


        .settings-menu-item .smi-icon {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .settings-menu-item .smi-label { flex: 1; }
        .settings-menu-item .smi-arrow { font-size: 0.58rem; color: #ccc; }

        .settings-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

        .settings-menu-item.logout { color: #c62828; }
        .settings-menu-item.logout .smi-icon { background: #fff0f0 !important; }
        .settings-menu-item.logout .smi-icon i { color: #c62828 !important; }

        /* ========== FLOATING EDIT/SAVE BUTTON ========== */
        .floating-edit-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: rgba(46, 125, 50, 0.9);
            border: 3px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 
                        0 0 0 0 rgba(46, 125, 50, 0.7);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
        }


        .floating-edit-btn:active {
            transform: scale(0.95);
        }

        .floating-edit-btn.save-mode {
            background: rgba(251, 192, 45, 0.95);
        }


        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3),
                            0 0 0 0 rgba(251, 192, 45, 0.7);
            }
            50% { 
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3),
                            0 0 20px 10px rgba(251, 192, 45, 0.4);
            }
        }

        .floating-edit-btn .edit-tooltip {
            position: absolute;
            right: 75px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }


        .floating-edit-btn:hover .edit-tooltip { opacity: 1; }
        .floating-edit-btn:hover { transform: scale(1.08); }
        .floating-edit-btn .edit-tooltip::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid rgba(0, 0, 0, 0.8);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        body.dark-mode .floating-edit-btn {
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Save button with Firebase sync indicator */
        .btn-primary.saving {
            background: #666;
            cursor: wait;
        }

        .btn-primary .save-icon {
            font-size: 1rem;
            margin-right: 5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }


        .btn {
            padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600;
            font-size: 0.75rem; white-space: nowrap;
        }
        .btn-primary { background: var(--safety-green-grad); color: white; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn-danger { background: #d32f2f; color: white; }

        /* PDF Upload Styles */
        .pdf-upload-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }
        .pdf-upload-btn {
            padding: 6px 12px;
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        .pdf-upload-btn i {
            font-size: 0.8rem;
        }
        .pdf-view-btn {
            padding: 6px 12px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            transition: background 0.2s;
        }
        .pdf-replace-btn {
            padding: 6px 10px;
            background: #f57c00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        .pdf-delete-btn {
            padding: 6px 10px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        .pdf-filename {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-style: italic;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .region-banner {
            background: linear-gradient(90deg, #1b5e20 0%, #2e7d32 60%, #388e3c 100%);
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            margin: 10px 16px 0;
            position: relative;
            border: none;
            box-shadow: 0 2px 8px rgba(27,94,32,0.18);
            user-select: none;
            padding: 0;
            display: flex;
            align-items: stretch;
            color: white;
            font-weight: 700;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        .region-banner:hover {
            background: linear-gradient(90deg, #155217 0%, #256427 60%, #2e7d32 100%);
            box-shadow: 0 4px 14px rgba(27,94,32,0.28);
        }

        /* Left accent stripe */
        .region-banner::before {
            content: '';
            display: block;
            width: 5px;
            flex-shrink: 0;
            background: #fbc02d;
            border-radius: 10px 0 0 0;
        }

        .region-banner.collapsed {
            border-radius: 10px;
            margin-bottom: 2px;
        }

        .region-banner.collapsed::before {
            border-radius: 10px 0 0 10px;
        }

        .region-banner-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex: 1;
            padding: 10px 16px;
            gap: 12px;
            min-width: 0;
        }

        .region-banner-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex-shrink: 1;
        }

        .region-banner-left .region-icon {
            font-size: 0.78rem;
            opacity: 0.85;
            flex-shrink: 0;
        }

        .region-banner-left .region-name {
            font-size: 0.82rem;
            font-weight: 800;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .region-banner-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .region-toggle-icon {
            transition: transform 0.25s ease;
            font-size: 0.75rem;
            opacity: 0.8;
            width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .region-banner.collapsed .region-toggle-icon {
            transform: rotate(-90deg);
        }

        .region-content {
            overflow: hidden;
            opacity: 1;
            border: 1px solid #c8e6c9;
            border-top: none;
            border-radius: 0 0 10px 10px;
            margin: 0 16px 10px;
            padding: 10px 0 4px;
        }

        .region-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            border: none;
            margin-bottom: 0;
        }

        /* Badge styles inside banners */
        .region-banner .rbadge {
            display: inline-flex;
            align-items: center;
            font-size: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.03em;
            padding: 2px 8px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .region-banner .rbadge-count {
            background: rgba(255,255,255,0.15);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.25);
        }

        .region-banner .rbadge-avg {
            background: #fbc02d;
            color: #1b5e20;
        }

        .region-banner .rbadge-admin {
            background: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.88);
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.56rem;
        }

        /* Glass effect for AVG badge (legacy compat) */
        .region-banner .badge[style*="background:#1b5e20"] {
            background: #fbc02d !important;
            color: #1b5e20 !important;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.6rem;
            font-weight: 800;
        }
        /* ‚îÄ‚îÄ Tab info bar (replaces old redundant banner titles) ‚îÄ‚îÄ */
        .tab-info-bar {
            display: flex;
            align-items: center;
            gap: 14px;
            margin: 10px 16px 0;
            padding: 10px 16px;
            background: var(--bg-card, #fff);
            border: 1px solid #c8e6c9;
            border-left: 4px solid #2e7d32;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(27,94,32,0.07);
        }
        .tab-info-bar .tib-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
            color: #2e7d32;
        }
        .tab-info-bar .tib-body { flex: 1; min-width: 0; }
        .tab-info-bar .tib-title {
            font-size: 0.72rem;
            font-weight: 800;
            color: var(--text-primary, #1b2e1c);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin: 0 0 2px;
        }
        .tab-info-bar .tib-sub {
            font-size: 0.65rem;
            color: var(--text-secondary, #555);
            margin: 0;
            line-height: 1.5;
        }
        .tab-info-bar .tib-badges {
            display: flex; gap: 6px; align-items: center; flex-shrink: 0;
        }
        .tab-info-bar .tib-pill {
            font-size: 0.6rem; font-weight: 800; padding: 3px 9px;
            border-radius: 20px; white-space: nowrap;
        }
        .tab-info-bar .tib-pill-green { background: #e8f5e9; color: #1b5e20; border: 1px solid #a5d6a7; }
        .tab-info-bar .tib-pill-yellow { background: #fff8e1; color: #7a5c00; border: 1px solid #ffe082; }

        .badge { background: var(--safety-yellow); color: #1b5e20; padding: 4px 12px;
            border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .sort-select {
            background: rgba(255,255,255,0.2); color: white; padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 4px;
        }
        .sort-select option { background: #1b5e20; color: white; }

        .project-row {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(241, 248, 233, 0.3) 100%);
            border: 1px solid var(--border-color); 
            padding: 14px 18px; 
            border-radius: 10px;
            margin: 0 20px 10px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .project-row {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(31, 46, 31, 0.5) 100%);
        }
        
        /* Phase 3: Regional Locking - Locked Project Styling */
        .project-locked {
            opacity: 0.7;
            background: linear-gradient(135deg, rgba(245, 245, 245, 0.5) 0%, rgba(224, 224, 224, 0.3) 100%) !important;
            border: 1px dashed #bdbdbd !important;
        }
        
        body.dark-mode .project-locked {
            background: linear-gradient(135deg, rgba(60, 60, 60, 0.5) 0%, rgba(45, 45, 45, 0.3) 100%) !important;
            border: 1px dashed #666 !important;
        }
        
        .project-locked .project-checkbox {
            cursor: not-allowed;
        }
        
        .project-locked .status-badge {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .project-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .circular-progress {
            width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; 
            background: conic-gradient(
                from 0deg,
                #1b5e20 0deg,
                #2e7d32 calc(var(--percentage) * 0.5),
                #4caf50 var(--percentage),
                #e0e0e0 var(--percentage)
            );
            box-shadow: 0 3px 12px rgba(27, 94, 32, 0.3), 
                        inset 0 0 0 2px rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            position: relative;
        }
        
        .circular-progress::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
            pointer-events: none;
        }
        
        .circular-progress-inner {
            width: 46px; height: 46px; border-radius: 50%; background: var(--bg-card); display: flex;
            align-items: center; justify-content: center; font-weight: 800; font-size: 0.82rem; 
            color: #1b5e20;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        
        body.dark-mode .circular-progress-inner {
            color: #66bb6a;
        }
        .project-info { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; min-width: 150px; }
        .project-name { 
            font-size: 0.95rem; 
            font-weight: 700; 
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        .project-meta { 
            font-size: 0.68rem; 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .project-dates { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            min-width: 200px; 
            font-size: 0.68rem;
            background: rgba(76, 175, 80, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 2px solid #4caf50;
        }
        
        .project-dates > div {
            display: flex;
            align-items: center;
        }
        
        body.dark-mode .project-dates {
            background: rgba(76, 175, 80, 0.1);
        }
        
        .date-label { 
            font-weight: 700; 
            color: #1b5e20;
            text-transform: uppercase;
            font-size: 0.6rem;
            letter-spacing: 0.3px;
            display: inline-block;
            width: 75px;
            flex-shrink: 0;
        }
        
        body.dark-mode .date-label {
            color: #66bb6a;
        }
        .status-badge {
            padding: 8px 12px; 
            border-radius: 6px; 
            color: white; 
            font-weight: 700; 
            font-size: 0.6rem;
            cursor: pointer; 
            text-transform: uppercase; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
            min-width: 130px;
            text-align: center;
        }
        
        
        .status-ongoing { 
            background: linear-gradient(135deg, #1565c0 0%, #1976D2 100%);
        }
        
        .status-stoppage { 
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
        }
        
        .status-finished { 
            background: linear-gradient(135deg, #424242 0%, #616161 100%);
        }

        /* ==================== MODAL STYLE 5 DESIGN ==================== */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0; 
            width: 100%;
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            align-items: center; 
            justify-content: center;
            animation: fadeIn 0.2s;
            padding: 20px;
        }
        .modal.show { 
            display: flex; 
        }
        .modal-content {
            background: var(--bg-card); 
            padding: 40px 35px 35px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25); 
            color: var(--text-primary);
            animation: scaleIn 0.3s;
            position: relative;
        }
        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #2e7d32;
            border-radius: 10px;
        }
        .modal-header { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            margin-bottom: 8px;
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
        }
        .modal-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            margin: 0 auto 20px;
            box-shadow: 0 5px 20px rgba(46, 125, 50, 0.3);
        }
        .modal-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 25px;
        }
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 1.8rem; 
            cursor: pointer; 
            color: var(--text-secondary);
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .form-group { 
            margin-bottom: 18px; 
        }
        .form-group label { 
            display: block; 
            font-size: 0.85rem; 
            font-weight: 600; 
            margin-bottom: 6px; 
            color: var(--text-primary); 
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 0.9rem;
            background: var(--input-bg); 
            color: var(--text-primary);
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; 
            border-color: #2e7d32; 
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .error-message { color: #d32f2f; font-size: 0.8rem; margin-top: 10px; }
        .success-message { color: #1b5e20; font-size: 0.8rem; margin-top: 10px; font-weight: 600; }
        .hidden { display: none !important; }

        /* ==================== CUSTOM CONFIRMATION MODAL ==================== */
        .confirm-modal-icon.warning {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            box-shadow: 0 5px 20px rgba(245, 124, 0, 0.3);
        }
        
        .confirm-modal-content {
            background: var(--bg-card);
            padding: 35px 30px 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            color: var(--text-primary);
            animation: scaleIn 0.3s;
            position: relative;
        }

        .confirm-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .confirm-modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 15px 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirm-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .confirm-modal-body {
            background: rgba(255, 152, 0, 0.08);
            border-left: 4px solid #ff9800;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        body.dark-mode .confirm-modal-body {
            background: rgba(255, 152, 0, 0.12);
        }

        .confirm-modal-body ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .confirm-modal-body li {
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .confirm-modal-body li::before {
            content: "‚Ä¢";
            color: #ff9800;
            font-size: 1.2rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .confirm-modal-question {
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-modal-buttons .btn {
            flex: 1;
            max-width: 180px;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirm-modal-buttons .btn-cancel {
            background: var(--border-color);
            color: var(--text-primary);
        }


        body.dark-mode .confirm-modal-buttons .btn-cancel {
            background: #444;
            color: var(--text-primary);
        }


        .confirm-modal-buttons .btn-proceed {
            background: var(--header-grad);
            color: white;
        }


        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ==================== SUCCESS MODAL ==================== */
        .success-modal-icon.success {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            box-shadow: 0 5px 20px rgba(46, 125, 50, 0.4);
        }

        .success-modal-content {
            background: var(--bg-card);
            padding: 35px 30px 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            color: var(--text-primary);
            animation: scaleIn 0.3s;
            position: relative;
        }

        .success-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .success-modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 15px 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .success-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .success-modal-body {
            background: rgba(46, 125, 50, 0.08);
            border-left: 4px solid #4caf50;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        body.dark-mode .success-modal-body {
            background: rgba(46, 125, 50, 0.15);
        }

        .success-modal-body ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .success-modal-body li {
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .success-modal-body li::before {
            content: "‚úì";
            color: #4caf50;
            font-size: 1.2rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .success-modal-footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .success-modal-countdown {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.1rem;
        }

        body.dark-mode .success-modal-countdown {
            color: #4caf50;
        }

        .success-modal-button {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
            display: block;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--header-grad);
            color: white;
        }

        
/* Backup & Recovery Styles */
.backup-section {
    background: var(--bg-card);
    border-left: 5px solid #1b5e20;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.backup-section h4 {
    margin-top: 0;
    color: #1b5e20;
    font-size: 1rem;
}

.backup-info {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 6px;
    margin: 12px 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

body.dark-mode .backup-info {
    background: #3a3a3a;
}

.backup-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.backup-status {
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.8rem;
    margin-top: 10px;
    font-weight: 600;
}

.backup-status.success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #4caf50;
}

.backup-status.error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #f44336;
}

.backup-status.info {
    background: #e3f2fd;
    color: #1565c0;
    border-left: 4px solid #2196f3;
}

body.dark-mode .backup-status.success {
    background: #1b5e20;
    color: #81c784;
}

body.dark-mode .backup-status.error {
    background: #5a1414;
    color: #ef5350;
}

body.dark-mode .backup-status.info {
    background: #1a3a52;
    color: #64b5f6;
}

.backup-list {
    margin-top: 15px;
}

.backup-item {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    border-left: 3px solid #fbc02d;
}

body.dark-mode .backup-item {
    background: #3a3a3a;
}

.backup-item-info {
    flex-grow: 1;
}

.backup-item-date {
    font-weight: 600;
    color: var(--text-primary);
}

.backup-item-size {
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.backup-item-actions {
    display: flex;
    gap: 8px;
}

.backup-item-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: 0.2s;
}

.backup-item-btn-restore {
    background: #1b5e20;
    color: white;
}


.backup-item-btn-delete {
    background: #d32f2f;
    color: white;
}


.backup-progress {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    margin: 10px 0;
    overflow: hidden;
}

.backup-progress-bar {
    height: 100%;
    background: var(--safety-green-grad);
    border-radius: 3px;
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0%; }
    50% { width: 100%; }
    100% { width: 0%; }
}


/* Modern Dialog Styles */
/* ==================== STYLE 5: Success/Error/Warning Dialog ==================== */
@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modern-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s;
}

.modern-dialog {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 40px 30px 30px;
    max-width: 420px;
    width: 90%;
    box-shadow: 0 15px 50px rgba(0,0,0,0.25);
    text-align: center;
    animation: scaleIn 0.3s;
}

.modern-dialog-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 40px;
    margin: 0 auto 20px;
    box-shadow: 0 5px 20px rgba(46, 125, 50, 0.3);
}

.modern-dialog.error .modern-dialog-icon {
    background: linear-gradient(135deg, #d32f2f, #f44336);
    box-shadow: 0 5px 20px rgba(211, 47, 47, 0.3);
}

.modern-dialog.info .modern-dialog-icon {
    background: linear-gradient(135deg, #1976d2, #2196f3);
    box-shadow: 0 5px 20px rgba(25, 118, 210, 0.3);
}

.modern-dialog.warning .modern-dialog-icon {
    background: linear-gradient(135deg, #f57c00, #fbc02d);
    box-shadow: 0 5px 20px rgba(245, 124, 0, 0.3);
}

.modern-dialog-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 15px 0;
}

.modern-dialog-message {
    color: var(--text-secondary);
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 30px;
}

.modern-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.modern-dialog-btn {
    padding: 12px 40px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modern-dialog-btn-cancel {
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid var(--border-color);
}


.modern-dialog-btn-confirm {
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    color: white;
    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
}


.modern-dialog-btn-danger {
    background: linear-gradient(135deg, #d32f2f, #f44336);
    color: white;
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
}


body.dark-mode .modern-dialog-btn-cancel {
    background: transparent;
    border-color: #555;
    color: #b0b0b0;
}


	.status-dropdown {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 150px;
}

.status-dropdown button {
    display: block;
    width: 100%;
    padding: 10px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-primary);
    transition: 0.2s;
}


        /* IMPROVED TABLE STYLES - OPTION 4: STRIPED WITH ACCENT */
        .table-container {
            margin: 10px 20px; overflow-x: auto; padding: 10px; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 8px;
        }
        
        table { 
            width: auto;
            min-width: 100%;
            border-collapse: collapse; 
            font-size: 0.7rem;
            table-layout: auto;
            color: var(--text-primary);
        }
        
        /* Option 4: Dark green header with yellow accent */
        th { 
            background: #1b5e20; 
            color: white; 
            padding: 10px 8px; 
            border: none;
            border-bottom: 3px solid var(--safety-yellow);
            white-space: nowrap;
            min-width: auto;
            width: auto;
            font-weight: 600;
        }
        
        /* Striped rows - white and very light green */
        tbody tr {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        tbody tr:nth-child(odd) {
            background: white;
        }
        
        tbody tr:nth-child(even) {
            background: #f1f8e9;
        }
        
        /* Dark mode striped rows */
        body.dark-mode tbody tr:nth-child(odd) {
            background: #2d2d2d;
        }
        
        body.dark-mode tbody tr:nth-child(even) {
            background: #1f2e1f;
        }
        
        /* Hover effect with left border accent */
        
        
        td { 
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 8px 6px; 
            text-align: center;
            min-width: 90px;
            width: auto;
            white-space: nowrap;
        }
        
        body.dark-mode td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        td:first-child {
            text-align: left;
            min-width: 200px;
            font-weight: 600;
        }
        
        /* Previous Year Column */
        td.prev-year {
            font-weight: 700;
            color: #2e7d32;
            min-width: auto;
            width: auto;
            background: rgba(76, 175, 80, 0.05);
        }

        body.dark-mode td.prev-year {
            color: #a5d6a7;
            background: rgba(76, 175, 80, 0.1);
        }
        
        td.prev-year {
            min-width: 90px;
            max-width: 110px;
            width: 100px;
            padding: 8px 6px;
            font-size: 0.7rem;
            text-align: center;
        }
        
        th.prev-year {
            background: #2e7d32;
            min-width: 90px;
            max-width: 110px;
            width: 100px;
            padding: 6px 4px;
            font-size: 0.7rem;
        }
        
        /* Monthly Columns - Default - NARROWER */
       /* Monthly Columns - Default - WIDER FOR 7 DIGITS */
td.monthly-data, th.monthly-header {
    min-width: 100px;
    max-width: none;
    width: auto;
    padding: 8px 12px;
    font-size: 0.7rem;
    text-align: center;
}

/* Style all month header columns - WIDER */
th:not(.prev-year):not(.ytd-header):not([colspan]) {
    min-width: 90px;
    max-width: none;
    width: auto;
    padding: 8px 12px;
    font-size: 0.7rem;
}
        
        /* YTD Column - Yellow - WIDER FOR "Running YTD" HEADER */
        /* YTD Column - Yellow highlight maintained for emphasis */
td.ytd-cell {
    background: #fff59d !important;
    font-weight: 700;
    color: #f57f17;
    min-width: 120px;
    max-width: none;
    width: auto;
    padding: 8px 12px;
    font-size: 0.7rem;
}
        }

        body.dark-mode td.ytd-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.ytd-header {
            background: #f9a825;
            color: white;
            min-width: 120px;
            max-width: none;
            width: auto;
            padding: 8px 12px;
            font-size: 0.7rem;
        }

        body.dark-mode th.ytd-header {
            background: #e65100;
            color: white;
        }
        
        /* Average Column - Light Yellow highlight maintained */
       /* Average Column - Light Yellow */
td.average-cell {
    background: #fffde7 !important;
    font-weight: 700;
    color: #f57f17;
    min-width: auto;
    width: auto;
    padding: 8px 12px;
}

        body.dark-mode td.average-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.average-header {
            background: #fbc02d;
            color: #333;
            min-width: 90px;
        }

        body.dark-mode th.average-header {
            background: #e65100;
            color: white;
        }
        
        /* Dark mode for striped rows - Option 4 */
        body.dark-mode tbody tr:nth-child(odd) {
            background: #2d2d2d;
        }
        
        body.dark-mode tbody tr:nth-child(even) {
            background: #1f2e1f;
        }
        
        
        body.dark-mode td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* ==================== DOE REPORTORIAL STYLES ==================== */
        .pdf-upload-container {
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .pdf-upload-btn {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(27, 94, 32, 0.3);
        }
        
        
        .pdf-file-info {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            padding: 4px 8px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
        }
        
        body.dark-mode .pdf-file-info {
            background: rgba(76, 175, 80, 0.2);
        }
        
        .pdf-view-btn, .pdf-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px 7px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        
        .pdf-view-btn {
            color: #1976D2;
        }
        
        
        
        .pdf-delete-btn {
            color: #d32f2f;
        }
        
        
        
        /* Renewable Energy Badge */
        .re-badge {
            display: inline-block;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 4px rgba(46, 125, 50, 0.3);
            animation: subtlePulse 2s ease-in-out infinite;
        }
        
        @keyframes subtlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        /* ==================== END DOE REPORTORIAL STYLES ==================== */
        
        table input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 6px 4px;
            font-size: 0.7rem;
            text-align: center;
            font-weight: 500;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        
        table input:disabled { 
            background: transparent; 
            border: none; 
            color: var(--text-primary); 
            font-weight: 600;
        }
        
        table input[type="number"],
        table input[data-num] {
    min-width: 60px;
    max-width: 100px;
    width: 85px;
    padding: 6px 4px;
    box-sizing: border-box;
    font-size: 0.7rem;
    text-align: center;
}

table input[type="date"] {
    min-width: 110px;
    width: 110px;
    max-width: 120px;
    padding: 6px 8px;
    cursor: pointer;
    box-sizing: border-box;
}

/* Always show calendar icon for date inputs */
table input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.7;
}


/* Style for empty date inputs - show cleaner appearance */
table input[type="date"]:not(:focus):invalid,
table input[type="date"]:not(:focus):not([value]),
table input[type="date"]:not(:focus)[value=""] {
    color: #999;
    font-style: italic;
}
        
        #grand-stats {
            margin: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        
        .stat-card {
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); 
            color: #ffffff;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
        }
        
        /* Vibrant gradient backgrounds with stronger contrast */
        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%);
        }
        
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #c17900 0%, #f57f17 25%, #fbc02d 50%, #fdd835 75%, #ffeb3b 100%);
        }
        
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #01579b 0%, #0d47a1 25%, #1976D2 50%, #2196F3 75%, #64b5f6 100%);
        }
        
        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #7f0000 0%, #b71c1c 25%, #d32f2f 50%, #e53935 75%, #ef5350 100%);
        }
        
        /* Add subtle shine effect to enhance gradient visibility */
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            pointer-events: none;
            z-index: 1;
        }
        
        
        
        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        /* Ripple effect - only on hover */
        .stat-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .stat-card:nth-child(1)::before {
            background: radial-gradient(circle, rgba(27, 94, 32, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:nth-child(2)::before {
            background: radial-gradient(circle, rgba(251, 192, 45, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:nth-child(3)::before {
            background: radial-gradient(circle, rgba(25, 118, 210, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:nth-child(4)::before {
            background: radial-gradient(circle, rgba(211, 47, 47, 0.3) 0%, transparent 70%);
        }
        
        
        @keyframes rippleEffect {
            0% {
                width: 0;
                height: 0;
                opacity: 0.8;
            }
            100% {
                width: 400px;
                height: 400px;
                opacity: 0;
            }
        }
        
        /* Ensure content is above all background layers */
        .stat-card > * {
            position: relative;
            z-index: 2;
        }
        
        .stat-value { 
            font-size: 1.5rem; 
            font-weight: 900; 
            color: #ffffff; 
            margin-top: 5px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 20px rgba(0,0,0,0.2);
        }
        .stat-label { 
            font-size: 0.65rem; 
            color: rgba(255, 255, 255, 0.95); 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        /* ============================================
           FLOATING PARTICLES ANIMATIONS FOR STAT CARDS
           ============================================ */
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            pointer-events: none;
        }
        
        /* Green particles for TOTAL PROJECTS (card 1) */
        .particle-green-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(102, 187, 106, 0.6);
            box-shadow: 0 0 10px rgba(102, 187, 106, 0.4);
            animation: float-particle-1 25.5s ease-in-out infinite;
        }
        
        .particle-green-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(76, 175, 80, 0.5);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
            animation: float-particle-2 32.4s ease-in-out infinite 7.5s;
        }
        
        .particle-green-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(129, 199, 132, 0.4);
            box-shadow: 0 0 8px rgba(129, 199, 132, 0.3);
            animation: float-particle-3 28.1s ease-in-out infinite 15.2s;
        }
        
        .particle-green-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(102, 187, 106, 0.5);
            box-shadow: 0 0 12px rgba(102, 187, 106, 0.4);
            animation: float-particle-4 38.2s ease-in-out infinite 3.9s;
        }
        
        /* Yellow particles for OVERALL COMPLIANCE (card 2) */
        .particle-yellow-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(255, 235, 59, 0.6);
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
            animation: float-particle-1 30.6s ease-in-out infinite 5.4s;
        }
        
        .particle-yellow-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(255, 202, 40, 0.5);
            box-shadow: 0 0 15px rgba(255, 202, 40, 0.3);
            animation: float-particle-2 35.8s ease-in-out infinite 12.9s;
        }
        
        .particle-yellow-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(255, 238, 88, 0.4);
            box-shadow: 0 0 8px rgba(255, 238, 88, 0.3);
            animation: float-particle-3 26.7s ease-in-out infinite;
        }
        
        .particle-yellow-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(255, 235, 59, 0.5);
            box-shadow: 0 0 12px rgba(255, 235, 59, 0.4);
            animation: float-particle-4 33.9s ease-in-out infinite 9.6s;
        }
        
        /* Blue particles for ON-GOING (card 3) */
        .particle-blue-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(100, 181, 246, 0.6);
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.4);
            animation: float-particle-1 32.4s ease-in-out infinite 8.7s;
        }
        
        .particle-blue-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(33, 150, 243, 0.5);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
            animation: float-particle-2 36.3s ease-in-out infinite;
        }
        
        .particle-blue-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(144, 202, 249, 0.4);
            box-shadow: 0 0 8px rgba(144, 202, 249, 0.3);
            animation: float-particle-3 27.6s ease-in-out infinite 14.1s;
        }
        
        .particle-blue-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(100, 181, 246, 0.5);
            box-shadow: 0 0 12px rgba(100, 181, 246, 0.4);
            animation: float-particle-4 41.1s ease-in-out infinite 5.7s;
        }
        
        /* Red particles for WORK STOPPAGE (card 4) */
        .particle-red-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(239, 83, 80, 0.6);
            box-shadow: 0 0 10px rgba(239, 83, 80, 0.4);
            animation: float-particle-1 34.5s ease-in-out infinite 2.4s;
        }
        
        .particle-red-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(229, 57, 53, 0.5);
            box-shadow: 0 0 15px rgba(229, 57, 53, 0.3);
            animation: float-particle-2 30.3s ease-in-out infinite 11.1s;
        }
        
        .particle-red-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(244, 143, 177, 0.4);
            box-shadow: 0 0 8px rgba(244, 143, 177, 0.3);
            animation: float-particle-3 42.6s ease-in-out infinite 15.3s;
        }
        
        .particle-red-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(239, 83, 80, 0.5);
            box-shadow: 0 0 12px rgba(239, 83, 80, 0.4);
            animation: float-particle-4 24.9s ease-in-out infinite;
        }
        
        /* Floating particle animations - 4 unique variations */
        @keyframes float-particle-1 {
            0%, 100% {
                transform: translateY(0px) translateX(0px);
                opacity: 0.8;
            }
            25% {
                transform: translateY(-25px) translateX(10px);
                opacity: 1;
            }
            50% {
                transform: translateY(-15px) translateX(-8px);
                opacity: 0.6;
            }
            75% {
                transform: translateY(-30px) translateX(5px);
                opacity: 0.9;
            }
        }
        
        @keyframes float-particle-2 {
            0%, 100% {
                transform: translateY(0px) translateX(0px) rotate(0deg);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-20px) translateX(-12px) rotate(5deg);
                opacity: 0.95;
            }
            60% {
                transform: translateY(-28px) translateX(7px) rotate(-3deg);
                opacity: 0.55;
            }
            80% {
                transform: translateY(-18px) translateX(-5px) rotate(2deg);
                opacity: 0.85;
            }
        }
        
        @keyframes float-particle-3 {
            0%, 100% {
                transform: translateY(0px) translateX(0px) scale(1);
                opacity: 0.75;
            }
            20% {
                transform: translateY(-32px) translateX(6px) scale(1.1);
                opacity: 0.9;
            }
            55% {
                transform: translateY(-12px) translateX(-10px) scale(0.95);
                opacity: 0.5;
            }
            85% {
                transform: translateY(-22px) translateX(8px) scale(1.05);
                opacity: 1;
            }
        }
        
        @keyframes float-particle-4 {
            0%, 100% {
                transform: translateY(0px) translateX(0px);
                opacity: 0.65;
            }
            35% {
                transform: translateY(-18px) translateX(-7px);
                opacity: 0.85;
            }
            65% {
                transform: translateY(-35px) translateX(12px);
                opacity: 1;
            }
            90% {
                transform: translateY(-10px) translateX(-4px);
                opacity: 0.7;
            }
        }
        .charts-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;
            padding: 20px; margin-top: 0;
        }
        .chart-box {
            background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            color: var(--text-primary);
        }
        .chart-box h3 {
            color: #1b5e20; margin-top: 0; font-size: 0.95rem; border-bottom: 2px solid var(--safety-yellow);
            padding-bottom: 10px;
        }
        .chart-box canvas { 
            max-height: 300px; 
            width: 100% !important;
            height: auto !important;
        }
        
        .chart-box {
            position: relative;
            width: 100%;
            min-height: 250px;
        }
        
        /* Better table scrolling on mobile */
        div[style*="overflow-x:auto"],
        div[style*="overflow-x: auto"] {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(27, 94, 32, 0.5) transparent;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar,
        div[style*="overflow-x: auto"]::-webkit-scrollbar {
            height: 8px;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar-track,
        div[style*="overflow-x: auto"]::-webkit-scrollbar-track {
            background: transparent;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar-thumb,
        div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb {
            background: rgba(27, 94, 32, 0.5);
            border-radius: 4px;
        }
        
        
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .logout-btn {
            width: 100%; background: rgba(255,255,255,0.1); color: white;
            border: 1px solid rgba(255,255,255,0.2); padding: 10px; cursor: pointer;
            font-size: 0.75rem; border-radius: 4px;
        }
        .user-badge { 
            background: linear-gradient(135deg, #fbc02d, #f57f17);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(251, 192, 45, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-align: center;
            position: relative;
        }
        
        
        .user-badge .name {
            font-size: 0.85rem;
            font-weight: 800;
            color: #1b5e20;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* User Profile Dropdown */
        .user-profile-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 10px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .user-profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-profile-header {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            padding: 15px;
            color: white;
            text-align: center;
        }
        
        .user-profile-email {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .user-profile-menu {
            padding: 8px 0;
        }
        
        .user-profile-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-primary);
            border-left: 3px solid transparent;
        }
        
        
        .user-profile-item i {
            width: 20px;
            text-align: center;
            color: #2e7d32;
        }
        
        .user-profile-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }
        
        .user-profile-item.admin-only {
            border-left-color: #d32f2f;
        }
        
        .user-profile-item.admin-only i {
            color: #d32f2f;
        }
        
        
        .admin-badge-small {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: auto;
        }

        #dashboard-content {
            color: var(--text-primary);
            padding-bottom: 200px; /* Extra space at bottom for dropdowns and scrolling */
            animation: slideRight 0.5s ease-out;
        }

/* ========== TOAST NOTIFICATIONS ‚Äî MODERN ========== */
#toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 99999;
    display: flex;
    flex-direction: column-reverse;
    gap: 10px;
    pointer-events: none;
}

.toast {
    pointer-events: all;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    padding: 0;
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.13), 0 1.5px 4px rgba(0,0,0,0.07);
    display: flex;
    align-items: stretch;
    min-width: 300px;
    max-width: 380px;
    animation: toastSlideIn 0.38s cubic-bezier(0.34,1.56,0.64,1) forwards;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.06);
    position: relative;
}

.toast-accent {
    width: 4px;
    flex-shrink: 0;
    border-radius: 14px 0 0 14px;
}
.toast-success .toast-accent { background: linear-gradient(180deg, #43e97b, #2e7d32); }
.toast-error   .toast-accent { background: linear-gradient(180deg, #ff6b6b, #c62828); }
.toast-warning .toast-accent { background: linear-gradient(180deg, #ffd93d, #e65100); }
.toast-info    .toast-accent { background: linear-gradient(180deg, #74b9ff, #1565c0); }

.toast-body {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 13px 14px 13px 12px;
    flex: 1;
}

.toast-icon-wrap {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 14px;
    font-weight: 700;
}
.toast-success .toast-icon-wrap { background: #e8f5e9; color: #2e7d32; }
.toast-error   .toast-icon-wrap { background: #ffebee; color: #c62828; }
.toast-warning .toast-icon-wrap { background: #fff3e0; color: #e65100; }
.toast-info    .toast-icon-wrap { background: #e3f2fd; color: #1565c0; }

.toast-text-wrap {
    flex: 1;
    min-width: 0;
}

.toast-title {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 1px;
}
.toast-success .toast-title { color: #2e7d32; }
.toast-error   .toast-title { color: #c62828; }
.toast-warning .toast-title { color: #e65100; }
.toast-info    .toast-title { color: #1565c0; }

.toast-message {
    font-size: 0.8rem;
    color: #444;
    font-weight: 500;
    line-height: 1.4;
    word-break: break-word;
}

.toast-close {
    background: none;
    border: none;
    color: #bbb;
    cursor: pointer;
    padding: 8px 10px 8px 4px;
    font-size: 16px;
    line-height: 1;
    align-self: flex-start;
    margin-top: 6px;
    border-radius: 6px;
    transition: color 0.15s;
}
.toast-close:hover { color: #666; }

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 2.5px;
    border-radius: 0 0 14px 14px;
    animation: toastProgress linear forwards;
}
.toast-success .toast-progress { background: linear-gradient(90deg,#43e97b,#2e7d32); }
.toast-error   .toast-progress { background: linear-gradient(90deg,#ff6b6b,#c62828); }
.toast-warning .toast-progress { background: linear-gradient(90deg,#ffd93d,#e65100); }
.toast-info    .toast-progress { background: linear-gradient(90deg,#74b9ff,#1565c0); }

@keyframes toastSlideIn {
    from { transform: translateX(120%) scale(0.95); opacity: 0; }
    to   { transform: translateX(0)    scale(1);    opacity: 1; }
}
@keyframes toastSlideOut {
    from { transform: translateX(0)    scale(1);    opacity: 1; max-height: 100px; margin-bottom: 0; }
    to   { transform: translateX(120%) scale(0.95); opacity: 0; max-height: 0;    margin-bottom: -10px; }
}
@keyframes toastProgress {
    from { width: 100%; }
    to   { width: 0%; }
}

.toast.hiding {
    animation: toastSlideOut 0.32s cubic-bezier(0.4,0,1,1) forwards;
}

/* ‚îÄ‚îÄ Sync Status Pill ‚îÄ‚îÄ */
#sync-status-pill {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    z-index: 99998;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px 8px 12px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.3px;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    cursor: default;
    user-select: none;
    transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s ease, background 0.3s ease;
    opacity: 0;
    pointer-events: none;
    border: 1px solid rgba(255,255,255,0.3);
    white-space: nowrap;
}
#sync-status-pill.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
    pointer-events: all;
}
#sync-status-pill.pill-pending {
    background: rgba(255,152,0,0.92);
    color: white;
    border-color: rgba(255,255,255,0.25);
}
#sync-status-pill.pill-syncing {
    background: rgba(25,118,210,0.92);
    color: white;
    border-color: rgba(255,255,255,0.25);
}
#sync-status-pill.pill-synced {
    background: rgba(46,125,50,0.92);
    color: white;
    border-color: rgba(255,255,255,0.25);
}
#sync-status-pill.pill-offline {
    background: rgba(97,97,97,0.92);
    color: white;
    border-color: rgba(255,255,255,0.15);
}
#sync-status-pill .pill-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: rgba(255,255,255,0.7);
    flex-shrink: 0;
}
#sync-status-pill.pill-pending .pill-dot  { animation: pillPulse 1.2s ease-in-out infinite; }
#sync-status-pill.pill-syncing .pill-dot  { animation: pillSpin 0.9s linear infinite; background: transparent; border: 2px solid white; border-top-color: transparent; border-radius: 50%; width: 9px; height: 9px; }
@keyframes pillPulse { 0%,100%{opacity:0.5;transform:scale(1)} 50%{opacity:1;transform:scale(1.3)} }
@keyframes pillSpin  { to { transform: rotate(360deg); } }

/* dark mode */
body.dark-mode .toast {
    background: rgba(30,30,30,0.93);
    border-color: rgba(255,255,255,0.07);
}
body.dark-mode .toast-message { color: #ddd; }
body.dark-mode .toast-success .toast-icon-wrap { background: rgba(46,125,50,0.25); }
body.dark-mode .toast-error   .toast-icon-wrap { background: rgba(198,40,40,0.25); }
body.dark-mode .toast-warning .toast-icon-wrap { background: rgba(230,81,0,0.25);  }
body.dark-mode .toast-info    .toast-icon-wrap { background: rgba(21,101,192,0.25);}
body.dark-mode .toast-close { color: #666; }
body.dark-mode .toast-close:hover { color: #aaa; }

/* ========== END TOAST ========== */

/* ========== DELETE CONFIRMATION DIALOG ========== */
.delete-dialog-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.45);
    z-index: 99999; display: flex; align-items: center; justify-content: center;
    animation: fadeInOverlay 0.2s ease;
    backdrop-filter: blur(4px);
}
@keyframes fadeInOverlay { from{opacity:0} to{opacity:1} }

.delete-dialog {
    background: white; border-radius: 20px; padding: 32px 28px 24px;
    width: 380px; max-width: 92vw; box-shadow: 0 24px 60px rgba(0,0,0,0.2);
    animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
    text-align: center; position: relative;
}
@keyframes popIn { from{transform:scale(0.85);opacity:0} to{transform:scale(1);opacity:1} }

.delete-dialog-icon {
    width: 60px; height: 60px; border-radius: 50%;
    background: #ffebee; display: flex; align-items: center; justify-content: center;
    margin: 0 auto 16px; font-size: 1.6rem; color: #c62828;
}
.delete-dialog-title {
    font-size: 1.05rem; font-weight: 800; color: #1a1a1a; margin-bottom: 8px;
}
.delete-dialog-message {
    font-size: 0.82rem; color: #666; line-height: 1.5; margin-bottom: 24px;
}
.delete-dialog-name {
    font-weight: 700; color: #c62828; display: block; margin-top: 4px; font-size: 0.9rem;
}
.delete-dialog-btns {
    display: flex; gap: 10px; justify-content: center;
}
.delete-dialog-cancel {
    flex: 1; padding: 11px; border: 1.5px solid #ddd; border-radius: 10px;
    background: white; color: #555; font-weight: 600; font-size: 0.85rem;
    cursor: pointer; transition: all 0.15s;
}
.delete-dialog-cancel:hover { background: #f5f5f5; border-color: #bbb; }

.delete-dialog-confirm {
    flex: 1; padding: 11px; border: none; border-radius: 10px;
    background: #c62828; color: white; font-weight: 700; font-size: 0.85rem;
    cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    display: flex; align-items: center; justify-content: center; gap: 6px;
}
.delete-dialog-confirm:disabled { opacity: 0.7; cursor: not-allowed; }
.delete-dialog-confirm:not(:disabled):hover { background: #b71c1c; transform: translateY(-1px); }

.delete-timer-ring {
    width: 18px; height: 18px; flex-shrink: 0;
}
.delete-timer-ring circle {
    fill: none; stroke: rgba(255,255,255,0.35); stroke-width: 2.5;
}
.delete-timer-ring .progress {
    stroke: white; stroke-width: 2.5; stroke-linecap: round;
    stroke-dasharray: 44; stroke-dashoffset: 0;
    transform: rotate(-90deg); transform-origin: 50% 50%;
    transition: stroke-dashoffset 1s linear;
}

/* Undo toast */
.undo-toast {
    pointer-events: all;
    background: rgba(33,33,33,0.95);
    backdrop-filter: blur(16px);
    border-radius: 12px;
    padding: 0;
    display: flex; align-items: stretch;
    min-width: 300px; max-width: 380px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    animation: toastSlideIn 0.38s cubic-bezier(0.34,1.56,0.64,1) forwards;
    overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
    position: relative;
}
.undo-toast-body {
    display: flex; align-items: center; gap: 10px;
    padding: 13px 14px; flex: 1;
}
.undo-toast-icon {
    width: 30px; height: 30px; border-radius: 50%;
    background: rgba(239,83,80,0.2); color: #ef5350;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; flex-shrink: 0;
}
.undo-toast-text { flex: 1; }
.undo-toast-title { font-size: 0.72rem; font-weight: 700; color: #ef5350; letter-spacing: 0.4px; text-transform: uppercase; }
.undo-toast-msg   { font-size: 0.79rem; color: #ccc; line-height: 1.3; }
.undo-btn {
    background: none; border: 1.5px solid rgba(255,255,255,0.2);
    color: white; font-weight: 700; font-size: 0.78rem;
    padding: 6px 14px; border-radius: 8px; cursor: pointer;
    white-space: nowrap; margin-right: 10px; transition: all 0.15s;
    align-self: center;
}
.undo-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.4); }
.undo-toast-progress {
    position: absolute; bottom: 0; left: 0; height: 2.5px;
    background: linear-gradient(90deg,#ef5350,#ff7043);
    border-radius: 0 0 12px 12px;
    animation: toastProgress linear forwards;
}
body.dark-mode .delete-dialog { background: #1e1e1e; }
body.dark-mode .delete-dialog-title { color: #eee; }
body.dark-mode .delete-dialog-cancel { background: #2a2a2a; border-color: #444; color: #ccc; }
body.dark-mode .delete-dialog-cancel:hover { background: #333; }
/* ========== END DELETE DIALOG ========== */

/* ========== SMOOTH TRANSITIONS ========== */
.project-row {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}



.btn {
    transition: all 0.2s ease;
}


.btn:active {
    transform: translateY(0);
}

input[type="date"]:focus,
input[type="text"]:focus,
input[type="number"]:focus {
    transform: scale(1.01);
    transition: all 0.2s ease;
}

/* ========== END TRANSITIONS ========== */

/* ========== TOOLTIPS ========== */
.tooltip-trigger {
    position: relative;
    cursor: help;
    color: #2e7d32;
    margin-left: 4px;
    display: inline-flex;
    align-items: center;
}

.tooltip-content {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: #333;
}


body.dark-mode .tooltip-content {
    background: #1a1a1a;
    border: 1px solid #444;
}

body.dark-mode .tooltip-content::after {
    border-top-color: #1a1a1a;
}
/* ========== END TOOLTIPS ========== */



/* I-adjust ang width ng specific DOLE columns */
.col-narrow {
    width: 1%;
    white-space: nowrap;
    padding-left: 10px !important;
    padding-right: 10px !important;
}

/* Kulay para sa disabled cells */
.cell-disabled {
    background-color: var(--border-color) !important;
    cursor: not-allowed;
    opacity: 0.6;
}

/* ==================== OSH REQUIREMENT MONITORING ==================== */
.osh-th {
    padding: 9px 10px;
    color: white;
    font-weight: 700;
    white-space: nowrap;
    border: none;
    font-size: 0.7rem;
    letter-spacing: 0.3px;
}
.sticky-col {
    position: sticky;
    left: 0;
    z-index: 10;
    background: #0d3d0f;
}
#osh-req-body tr td { padding: 8px 10px; vertical-align: middle; font-size: 0.72rem; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
#osh-req-body tr:last-child td { border-bottom: none; }
#osh-req-body tr:hover td { filter: brightness(0.97); }
.osh-cell-compliant { background: #e8f5e9; }
.osh-cell-deficient { background: #fff3e0; }
.osh-cell-na { background: #f5f5f5; color: #9e9e9e !important; }
body.dark-mode .osh-cell-compliant { background: rgba(46,125,50,0.18); }
body.dark-mode .osh-cell-deficient { background: rgba(230,81,0,0.2); }
body.dark-mode .osh-cell-na { background: rgba(0,0,0,0.12); }
.osh-req-val { font-weight: 700; font-size: 0.85rem; }
.osh-req-label { font-size: 0.6rem; color: var(--text-secondary); margin-top: 1px; }
.osh-badge-ok { display:inline-block;padding:2px 8px;border-radius:12px;background:#2e7d32;color:white;font-size:0.62rem;font-weight:700; }
.osh-badge-def { display:inline-block;padding:2px 8px;border-radius:12px;background:#e65100;color:white;font-size:0.62rem;font-weight:700;animation:osh-pulse 2s infinite; }
.osh-badge-na { display:inline-block;padding:2px 8px;border-radius:12px;background:#9e9e9e;color:white;font-size:0.62rem;font-weight:700; }
@keyframes osh-pulse { 0%,100%{opacity:1;} 50%{opacity:0.7;} }
.osh-manpower-input { width:68px;padding:5px 7px;border:1.5px solid var(--border-color);border-radius:6px;background:var(--input-bg);color:var(--text-primary);font-size:0.78rem;text-align:center;font-weight:600;transition:border-color 0.2s; }
.osh-manpower-input:focus { outline:none;border-color:#2e7d32;box-shadow:0 0 0 3px rgba(46,125,50,0.15); }
.osh-act-input { width:42px;padding:4px 5px;border:1.5px solid var(--border-color);border-radius:5px;background:var(--input-bg);color:var(--text-primary);font-size:0.75rem;text-align:center;font-weight:600;transition:border-color 0.2s; }
.osh-act-input:focus { outline:none;border-color:#2e7d32; }
.osh-sticky-td { position:sticky;left:0;z-index:5;background:var(--bg-card); }
#osh-req-body tr:nth-child(even) .osh-sticky-td { background: rgba(0,0,0,0.018); }
body.dark-mode #osh-req-body tr:nth-child(even) .osh-sticky-td { background: rgba(255,255,255,0.03); }
/* ==================== END OSH REQUIREMENT MONITORING ==================== */

/* NOV tab: slim columns since values are 3-digit max */
.nov-narrow-th {
    min-width: 0 !important;
    width: 42px !important;
    padding: 8px 3px !important;
    font-size: 0.62rem !important;
}
.nov-narrow-td {
    min-width: 0 !important;
    width: 42px !important;
    padding: 5px 2px !important;
}
.nov-narrow-td input[type="number"],
.nov-narrow-td input[data-num] {
    width: 36px !important;
    min-width: 0 !important;
    padding: 4px 2px !important;
    font-size: 0.68rem !important;
}

/* DOLE Reportorial: narrower columns for RSO, MOM (monthly) and AEDR, AMR (annual) */
.dole-narrow-th {
    min-width: 0 !important;
    width: 100px !important;
    max-width: 100px !important;
    padding: 8px 4px !important;
    font-size: 0.7rem !important;
}
.dole-narrow-td {
    min-width: 0 !important;
    width: 100px !important;
    max-width: 100px !important;
    padding: 5px 2px !important;
}
.dole-narrow-td input[type="date"] {
    width: 95px !important;
    max-width: 95px !important;
    min-width: 0 !important;
    padding: 4px 2px !important;
    font-size: 0.7rem !important;
}

/* Personnel table: locked by default, per-row Edit/Save */
.p-project-card td input,
.p-project-card td select {
    pointer-events: none;
    background: transparent !important;
    border: none !important;
    color: var(--text-primary);
    cursor: default;
    font-size: 0.72rem;
}
.p-project-card tr.p-editing td input,
.p-project-card tr.p-editing td select {
    pointer-events: auto;
    background: var(--input-bg) !important;
    border: 1px solid #2e7d32 !important;
    border-radius: 4px !important;
    cursor: text;
    padding: 4px 6px !important;
}
.p-view-text {
    display: inline-block;
    white-space: normal !important;
    word-break: break-word;
    overflow-wrap: anywhere;
    line-height: 1.35;
    vertical-align: middle;
    font-size: 0.72rem;
}
.p-project-card td {
    white-space: normal;
    vertical-align: middle;
    word-break: break-word;
    overflow-wrap: anywhere;
}
.p-project-card tbody tr {
    border-bottom: 1px solid var(--border-color);
    transition: background 0.15s;
}
.p-project-card tbody tr:nth-child(even) { background: rgba(0,0,0,0.018); }
body.dark-mode .p-project-card tbody tr:nth-child(even) { background: rgba(255,255,255,0.03); }
/* Group & project header rows ‚Äî never inherit nth-child alternating background */




.p-project-card tr.p-editing { background: #f1f8e9 !important; box-shadow: inset 3px 0 0 #2e7d32; }
body.dark-mode .p-project-card tr.p-editing { background: rgba(27,94,32,0.25) !important; }
.p-project-card tr.p-editing td:first-child { background: #f1f8e9 !important; }
body.dark-mode .p-project-card tr.p-editing td:first-child { background: rgba(27,94,32,0.25) !important; }
.p-project-card tbody tr:nth-child(even) td:first-child { background: rgba(0,0,0,0.018); }
body.dark-mode #p-body tr:nth-child(even) td:first-child { background: rgba(255,255,255,0.03); }
#p-body td { padding: 8px 10px; vertical-align: middle; border: none; color: var(--text-primary); }
#p-body td:first-child { font-weight: 600; }
.p-row-num {
    display: inline-flex; align-items:center; justify-content:center;
    width: 20px; height: 20px; border-radius: 50%;
    background: #e8f5e9; color: #2e7d32;
    font-size: 0.65rem; font-weight: 700; margin-right: 6px;
    flex-shrink: 0; vertical-align: middle;
}
body.dark-mode .p-row-num { background: #1b5e20; color: #a5d6a7; }
.p-pos-badge {
    display: inline-block; padding: 2px 7px;
    border-radius: 10px; font-size: 0.65rem; font-weight: 600;
    background: #e3f2fd; color: #1565c0; white-space: nowrap;
}
body.dark-mode .p-pos-badge { background: #1a3a52; color: #64b5f6; }
.p-gender-m { background: #e3f2fd !important; color: #1565c0 !important; }
.p-gender-f { background: #fce4ec !important; color: #c2185b !important; }
.p-edit-btn {
    padding: 4px;
    background: none;
    color: #1976D2;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    display: inline-flex; align-items:center;
    transition: 0.2s;
}
.p-save-btn {
    display: none;
    padding: 4px;
    background: none;
    color: #2e7d32;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    margin-left: 3px;
    align-items:center;
    transition: 0.2s;
}
.p-del-btn {
    padding: 4px;
    background: none;
    color: #d32f2f;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    margin-left: 3px;
    transition: 0.2s;
}

    </style>
</head>
<body>

    <!-- Firebase initialization loading screen -->
    <div id="firebase-loading-overlay">
        <div class="shield-loader">
            <i class="fas fa-shield-halved"></i>
        </div>
        <p>üõ°Ô∏è SECURING YOUR WORKSPACE...</p>
    </div>

	
    <!-- ==================== LOGIN FLASH SCREEN ==================== -->
    <div id="login-flash-screen" style="position:fixed;inset:0;z-index:99999;background:linear-gradient(160deg,#062d09 0%,#0d3d0f 40%,#1b5e20 100%);align-items:center;justify-content:center;flex-direction:column;overflow-y:auto;">
        <!-- Background decoration -->
        <div style="position:fixed;inset:0;overflow:hidden;pointer-events:none;">
            <div style="position:absolute;width:500px;height:500px;border-radius:50%;background:rgba(255,255,255,0.02);top:-150px;left:-150px;"></div>
            <div style="position:absolute;width:350px;height:350px;border-radius:50%;background:rgba(255,255,255,0.025);bottom:-80px;right:-80px;"></div>
            <i class="fas fa-hard-hat" style="position:absolute;top:8%;left:4%;font-size:3rem;color:rgba(251,192,45,0.06);transform:rotate(-15deg);"></i>
            <i class="fas fa-shield-halved" style="position:absolute;bottom:12%;right:5%;font-size:4rem;color:rgba(255,255,255,0.04);"></i>
            <i class="fas fa-leaf" style="position:absolute;top:15%;right:8%;font-size:2.5rem;color:rgba(102,187,106,0.06);transform:rotate(20deg);"></i>
            <i class="fas fa-triangle-exclamation" style="position:absolute;bottom:20%;left:6%;font-size:2rem;color:rgba(255,143,0,0.06);"></i>
        </div>

        <!-- Main content -->
        <div style="position:relative;z-index:2;max-width:620px;width:92%;text-align:center;padding:32px 0 24px;animation:flashFadeIn 0.4s ease;">

            <!-- Header -->
            <div style="display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:10px;">
                <div style="width:60px;height:60px;background:rgba(251,192,45,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(251,192,45,0.4);">
                    <i class="fas fa-shield-halved" style="font-size:1.7rem;color:#fbc02d;"></i>
                </div>
                <div style="text-align:left;">
                    <div style="font-size:0.65rem;font-weight:700;letter-spacing:3px;color:rgba(255,255,255,0.45);text-transform:uppercase;">ESH Compliance Dashboard</div>
                    <div id="flash-welcome-name" style="font-size:1.45rem;font-weight:900;color:white;line-height:1.1;">Welcome!</div>
                </div>
            </div>

            <div style="font-size:0.88rem;color:rgba(165,214,167,0.85);margin-bottom:24px;font-weight:500;">
                Please read the reminders below carefully before you start.
            </div>

            <!-- Reminder Cards -->
            <div style="display:flex;flex-direction:column;gap:14px;margin-bottom:26px;text-align:left;">

                <!-- Reminder 1: Wait for loading -->
                <div style="background:rgba(255,143,0,0.1);border:1.5px solid rgba(255,143,0,0.35);border-left:5px solid #ff8f00;border-radius:12px;padding:18px 20px;display:flex;align-items:flex-start;gap:16px;">
                    <div style="width:44px;height:44px;background:rgba(255,143,0,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">
                        <i class="fas fa-hourglass-half" style="color:#ffb300;font-size:1.2rem;"></i>
                    </div>
                    <div>
                        <div style="font-weight:800;color:#ffb300;font-size:0.95rem;margin-bottom:6px;">‚ö†Ô∏è  REMINDER 1 ‚Äî Wait for the Dashboard to Fully Load</div>
                        <div style="font-size:0.82rem;color:rgba(255,255,255,0.85);line-height:1.7;">After logging in, <strong style="color:#ffb300;">do NOT add or edit anything right away.</strong> Wait a few seconds until all data has finished loading. If you add a project while it is still loading, <strong style="color:#ffb300;">the entry will be duplicated.</strong></div>
                    </div>
                </div>

                <!-- Reminder 2: Check year selector -->
                <div style="background:rgba(41,182,246,0.09);border:1.5px solid rgba(41,182,246,0.3);border-left:5px solid #29b6f6;border-radius:12px;padding:18px 20px;display:flex;align-items:flex-start;gap:16px;">
                    <div style="width:44px;height:44px;background:rgba(41,182,246,0.18);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">
                        <i class="fas fa-calendar-check" style="color:#29b6f6;font-size:1.2rem;"></i>
                    </div>
                    <div>
                        <div style="font-weight:800;color:#29b6f6;font-size:0.95rem;margin-bottom:6px;">üìÖ  REMINDER 2 ‚Äî Always Check the Year Selector</div>
                        <div style="font-size:0.82rem;color:rgba(255,255,255,0.85);line-height:1.7;">Look at the <strong style="color:#29b6f6;">top-right corner of the screen</strong> to see what year is currently displayed. <strong style="color:#29b6f6;">Make sure the correct year is selected</strong> before making any changes. Editing the wrong year will put data in the wrong place.</div>
                    </div>
                </div>

                <!-- Reminder 3: Click Save -->
                <div style="background:rgba(102,187,106,0.09);border:1.5px solid rgba(102,187,106,0.3);border-left:5px solid #66bb6a;border-radius:12px;padding:18px 20px;display:flex;align-items:flex-start;gap:16px;">
                    <div style="width:44px;height:44px;background:rgba(102,187,106,0.18);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">
                        <i class="fas fa-floppy-disk" style="color:#66bb6a;font-size:1.2rem;"></i>
                    </div>
                    <div>
                        <div style="font-weight:800;color:#66bb6a;font-size:0.95rem;margin-bottom:6px;">üíæ  REMINDER 3 ‚Äî Always Press the SAVE Button</div>
                        <div style="font-size:0.82rem;color:rgba(255,255,255,0.85);line-height:1.7;">After editing or entering data, <strong style="color:#66bb6a;">always click the SAVE button at the bottom-left corner</strong> of the screen. <strong style="color:#66bb6a;">If you forget to save, all your changes will be lost</strong> and you will have to re-enter everything.</div>
                    </div>
                </div>

            </div>

            <!-- Progress bar -->
            <div style="background:rgba(255,255,255,0.08);border-radius:99px;height:6px;overflow:hidden;margin-bottom:16px;">
                <div id="flash-progress-bar" style="height:100%;background:linear-gradient(90deg,#fbc02d,#66bb6a,#29b6f6);border-radius:99px;width:0%;transition:width 0.1s linear;"></div>
            </div>

            <!-- Countdown + Button -->
            <div style="display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap;">
                <span id="flash-countdown" style="font-size:0.8rem;color:rgba(255,255,255,0.45);">Auto-closes in <strong style="color:rgba(255,255,255,0.75);">20s</strong></span>
                <button onclick="dismissLoginFlash()" style="background:linear-gradient(135deg,#fbc02d,#f57f17);color:#1b5e20;border:none;padding:12px 36px;border-radius:99px;font-weight:900;font-size:0.9rem;letter-spacing:0.5px;box-shadow:0 4px 20px rgba(251,192,45,0.35);transition:all 0.2s;">
                    <i class="fas fa-check-circle" style="margin-right:8px;"></i>I UNDERSTAND ‚Äî PROCEED TO DASHBOARD
                </button>
            </div>

            <div style="font-size:0.65rem;color:rgba(255,255,255,0.25);margin-top:14px;">This reminder appears once per session only.</div>
        </div>
    </div>

    <style>
        @keyframes flashFadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        #login-flash-screen { display: none; }
        #login-flash-screen.active { display: flex !important; }
        #login-flash-screen button:hover {
            transform: scale(1.04);
            box-shadow: 0 6px 28px rgba(251,192,45,0.5) !important;
        }
    </style>
    <!-- ==================== END LOGIN FLASH SCREEN ==================== -->

    <div id="login-overlay" style="display:none;">
        <!-- Safety Background Elements -->
        <div class="safety-bg-icons">
            <i class="fas fa-hard-hat safety-icon-float"></i>
            <i class="fas fa-user-shield safety-icon-float"></i>
            <i class="fas fa-briefcase-medical safety-icon-float"></i>
            <i class="fas fa-fire-extinguisher safety-icon-float"></i>
            <i class="fas fa-vest safety-icon-float"></i>
            <i class="fas fa-triangle-exclamation safety-icon-float"></i>
        </div>
        <div class="safety-pattern"></div>
        <div class="warning-stripe"></div>
        
        <div class="login-card">
            <div class="login-header">
                <div class="login-shield">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <h1 class="login-title">ESH Compliance Dashboard</h1>
                <p class="login-subtitle">STA. CLARA INTERNATIONAL CORPORATION</p>
                <div class="login-badge">
                    <i class="fas fa-users-gear"></i> MANAGER ACCESS PORTAL
                </div>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)" autocomplete="off">
                <div class="login-input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="login-user" placeholder="Corporate Email Address" required autocomplete="off">
                </div>
                <div class="login-input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-pass" placeholder="Password" required autocomplete="off">
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM
                </button>
            </form>
            
            <div id="login-error" class="error-message"></div>
            
            <div class="disclaimer-box">
                <strong><i class="fas fa-shield-halved"></i> AUTHORIZED ACCESS ONLY</strong><br>
                This system is exclusively for ESH Department managers and authorized personnel. 
                For account access, please contact your system administrator.
            </div>
        </div>
    </div>

    <!-- ==================== CUSTOM CONFIRMATION MODAL ==================== -->
    <div id="confirmModal" class="modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <div class="modal-icon confirm-modal-icon warning">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="confirm-modal-title">
                    <i class="fas fa-lock"></i> SECURITY CONFIRMATION
                </div>
                <div class="confirm-modal-subtitle">Please review the following before proceeding</div>
            </div>

            <div class="confirm-modal-body">
                <strong style="display: block; margin-bottom: 10px; color: var(--text-primary);">
                    ‚ö†Ô∏è After changing your password:
                </strong>
                <ul>
                    <li>You will be logged out automatically</li>
                    <li>All other devices will be logged out</li>
                    <li>You'll need to login again with new password</li>
                    <li>You'll receive an email confirmation</li>
                </ul>
            </div>

            <div class="confirm-modal-question">
                Do you want to proceed?
            </div>

            <div class="confirm-modal-buttons">
                <button class="btn btn-cancel" onclick="closeConfirmModal(false)">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-proceed" onclick="closeConfirmModal(true)">
                    <i class="fas fa-check"></i> Yes, Proceed
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== SUCCESS MODAL ==================== -->
    <div id="successModal" class="modal">
        <div class="success-modal-content">
            <div class="success-modal-header">
                <div class="modal-icon success-modal-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="success-modal-title">
                    ‚úÖ PASSWORD CHANGED SUCCESSFULLY!
                </div>
                <div class="success-modal-subtitle">Your password has been updated securely</div>
            </div>

            <div class="success-modal-body">
                <strong style="display: block; margin-bottom: 10px; color: var(--text-primary);">
                    üîê For your security:
                </strong>
                <ul>
                    <li>All sessions have been logged out</li>
                    <li>Please login again with your new password</li>
                    <li>Check your email for confirmation</li>
                </ul>
            </div>

            <div class="success-modal-footer">
                <div style="margin-bottom: 10px;">You will be redirected to login in</div>
                <div class="success-modal-countdown" id="countdown-timer">3</div>
                <div style="margin-top: 5px; font-size: 0.85rem;">seconds...</div>
            </div>

            <button class="success-modal-button" onclick="closeSuccessModal()">
                <i class="fas fa-sign-in-alt"></i> Login Now
            </button>
        </div>
    </div>

    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-folder-plus"></i>
            </div>
            <div class="modal-header">
                <span>Add New Project</span>
                <button class="modal-close" onclick="closeAddProjectModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Create a new project site to track ESH compliance</div>
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="projectNameInput" placeholder="Enter project name" required>
            </div>
            <div class="form-group">
                <label>Region *</label>
                <select id="projectRegion" required onchange="onProjectRegionChange(this.value)">
                    <option value="">Select Region</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
    
                </select>
            </div>
            <div id="projectDateFields">
                <div class="form-group">
                    <label>Date Started *</label>
                    <input type="date" id="projectDateStarted" required max="">
                </div>
                <div class="form-group">
                    <label>Date Finished</label>
                    <input type="date" id="projectDateFinished" max="">
                </div>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="projectIsRenewable" style="width: auto; cursor: pointer;">
                    <span>Renewable Energy Project</span>
                    <i class="fas fa-leaf" style="color: #4caf50;"></i>
                </label>
                <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> Check if this is a Renewable Energy project (required for DOE Reportorial)
                </small>
            </div>


            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddProject()">Add Project</button>
            </div>
            <div id="projectModalError" class="error-message"></div>
        </div>
    </div>

    <!-- Add Personnel Modal -->
    <div id="addPersonnelModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="modal-header">
                <span>Add New Personnel</span>
                <button class="modal-close" onclick="closeAddPersonnelModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Add a new ESH team member to the registry</div>
            <div class="form-group">
                <label>Last Name *</label>
                <input type="text" id="personnelLastNameInput" placeholder="Enter last name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" id="personnelFirstNameInput" placeholder="Enter first name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Middle Name</label>
                <input type="text" id="personnelMiddleNameInput" placeholder="Enter middle name" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Name Extension (if applicable)</label>
                <select id="personnelNameExtInput">
                    <option value="">None</option>
                    <option value="JR.">Jr.</option>
                    <option value="SR.">Sr.</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                </select>
            </div>
            <div class="form-group">
                <label>Position *</label>
                <select id="personnelPositionInput" required>
                    <option value="">Select Position</option>
                    <optgroup label="Project-Based Positions">
                        <option value="ESH Superintendent">ESH Superintendent</option>
                        <option value="ESH Head">ESH Head</option>
                        <option value="Safety Officer I">Safety Officer I</option>
                        <option value="Safety Officer II">Safety Officer II</option>
                        <option value="Safety Officer III">Safety Officer III</option>
                        <option value="Safety Officer IV">Safety Officer IV</option>
                        <option value="PCO">PCO</option>
                        <option value="TMO">TMO</option>
                        <option value="ESH Project DC">ESH Project DC</option>
                        <option value="Project Physician">Project Physician</option>
                        <option value="Project Nurse">Project Nurse</option>
                        <option value="First Aider">First Aider</option>
                    </optgroup>
                    <optgroup label="Corporate Positions">
                        <option value="QESH Group Manager">QESH Group Manager</option>
                        <option value="QESH Deputy Manager">QESH Deputy Manager</option>
                        <option value="ESH Manager for Regulation & Compliance">ESH Manager for Regulation & Compliance</option>
                        <option value="ESH Manager for Project Implementation">ESH Manager for Project Implementation</option>
                        <option value="Environmental and Sustainability Head">Environmental and Sustainability Head</option>
                        <option value="Corporate Physician">Corporate Physician</option>
                        <option value="Corporate Nurse">Corporate Nurse</option>
                        <option value="QESH Corp. DC">QESH Corp. DC</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="Others">Others</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group">
                <label>ID Number *</label>
                <input type="text" id="personnelIdInput" placeholder="Enter ID number" required>
            </div>
            <div class="form-group">
                <label>Date Hired *</label>
                <input type="date" id="personnelHiredInput" required>
            </div>
            <div class="form-group">
                <label>Current Assignment *</label>
                <select id="personnelAssignmentInput" required>
                    <option value="">Select Assignment</option>
                    <option value="Corporate Office">Corporate Office</option>
                </select>
            </div>
            <div class="form-group">
                <label>Age *</label>
                <input type="number" id="personnelAgeInput" placeholder="Enter age" min="18" max="100" required>
            </div>
            <div class="form-group">
                <label>Gender *</label>
                <select id="personnelGenderInput" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="personnelEmailInput" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Contact Number</label>
                <input type="tel" id="personnelContactInput" placeholder="0977 172 6246" oninput="this.value=fmtPhone(this.value)" maxlength="13">
            </div>
            <div class="form-group">
                <label>Home Address</label>
                <textarea id="personnelAddressInput" placeholder="Enter home address" oninput="this.value=titleCase(this.value)"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddPersonnelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddPersonnel()">Add Personnel</button>
            </div>
            <div id="personnelModalError" class="error-message"></div>
        </div>
    </div>

    <!-- Edit Personnel Modal -->
    <div id="editPersonnelModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-edit"></i>
            </div>
            <div class="modal-header">
                <span>Edit Personnel</span>
                <button class="modal-close" onclick="closeEditPersonnelModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Update personnel information</div>
            <input type="hidden" id="editPersonnelIndex">
            <div class="form-group">
                <label>Last Name *</label>
                <input type="text" id="editPersonnelLastNameInput" placeholder="Enter last name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" id="editPersonnelFirstNameInput" placeholder="Enter first name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Middle Name</label>
                <input type="text" id="editPersonnelMiddleNameInput" placeholder="Enter middle name" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Name Extension (if applicable)</label>
                <select id="editPersonnelNameExtInput">
                    <option value="">None</option>
                    <option value="JR.">Jr.</option>
                    <option value="SR.">Sr.</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                </select>
            </div>
            <div class="form-group">
                <label>Position *</label>
                <select id="editPersonnelPositionInput" required>
                    <option value="">Select Position</option>
                    <optgroup label="Project-Based Positions">
                        <option value="ESH Superintendent">ESH Superintendent</option>
                        <option value="ESH Head">ESH Head</option>
                        <option value="Safety Officer I">Safety Officer I</option>
                        <option value="Safety Officer II">Safety Officer II</option>
                        <option value="Safety Officer III">Safety Officer III</option>
                        <option value="Safety Officer IV">Safety Officer IV</option>
                        <option value="PCO">PCO</option>
                        <option value="TMO">TMO</option>
                        <option value="ESH Project DC">ESH Project DC</option>
                        <option value="Project Physician">Project Physician</option>
                        <option value="Project Nurse">Project Nurse</option>
                        <option value="First Aider">First Aider</option>
                    </optgroup>
                    <optgroup label="Corporate Positions">
                        <option value="QESH Group Manager">QESH Group Manager</option>
                        <option value="QESH Deputy Manager">QESH Deputy Manager</option>
                        <option value="ESH Manager for Regulation & Compliance">ESH Manager for Regulation & Compliance</option>
                        <option value="ESH Manager for Project Implementation">ESH Manager for Project Implementation</option>
                        <option value="Environmental and Sustainability Head">Environmental and Sustainability Head</option>
                        <option value="Corporate Physician">Corporate Physician</option>
                        <option value="Corporate Nurse">Corporate Nurse</option>
                        <option value="QESH Corp. DC">QESH Corp. DC</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="Others">Others</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group">
                <label>ID Number *</label>
                <input type="text" id="editPersonnelIdInput" placeholder="Enter ID number" required>
            </div>
            <div class="form-group">
                <label>Date Hired *</label>
                <input type="date" id="editPersonnelHiredInput" required>
            </div>
            <div class="form-group">
                <label>Current Assignment *</label>
                <select id="editPersonnelAssignmentInput" required>
                    <option value="">Select Assignment</option>
                    <option value="Corporate Office">Corporate Office</option>
                </select>
            </div>
            <div class="form-group">
                <label>Age *</label>
                <input type="number" id="editPersonnelAgeInput" placeholder="Enter age" min="18" max="100" required>
            </div>
            <div class="form-group">
                <label>Gender *</label>
                <select id="editPersonnelGenderInput" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editPersonnelEmailInput" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Contact Number</label>
                <input type="tel" id="editPersonnelContactInput" placeholder="0977 172 6246" oninput="this.value=fmtPhone(this.value)" maxlength="13">
            </div>
            <div class="form-group">
                <label>Home Address</label>
                <textarea id="editPersonnelAddressInput" placeholder="Enter home address" oninput="this.value=titleCase(this.value)"></textarea>
            </div>
            <div class="modal-buttons" style="justify-content:space-between;align-items:center;">
                <button class="btn" id="editPersonnelDeleteBtn" onclick="deletePersonnelFromModal()" style="background:#d32f2f;color:white;border:none;padding:10px 18px;border-radius:8px;font-size:0.8rem;font-weight:600;display:flex;align-items:center;gap:6px;cursor:pointer;transition:background 0.2s;" title="Delete this personnel">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-secondary" onclick="closeEditPersonnelModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmEditPersonnel()">Save Changes</button>
                </div>
            </div>
            <div id="editPersonnelModalError" class="error-message"></div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Edit Project Details</span>
                <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="editProjectNameInput" placeholder="Enter project name" required>
            </div>
            <div class="form-group">
                <label>Date Started *</label>
                <input type="date" id="editProjectDateStarted" required>
            </div>
            <div class="form-group">
                <label>Date Finished</label>
                <input type="date" id="editProjectDateFinished">
                <small style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 5px; display: block;">
                    <i class="fas fa-info-circle"></i> Adding a finish date will automatically set status to "Finished"
                </small>
            </div>
            <div class="form-group">
                <label>Region *</label>
                <select id="editProjectRegion" required>
                    <option value="">Select Region</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                    <option value="CORPORATE">Corporate</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="editProjectIsRenewable" style="width: auto; cursor: pointer;">
                    <span>Renewable Energy Project</span>
                    <i class="fas fa-leaf" style="color: #4caf50;"></i>
                </label>
                <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> Check if this is a Renewable Energy project (required for DOE Reportorial)
                </small>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeEditProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditProject()">Save Changes</button>
            </div>
            <div id="editProjectModalError" class="error-message"></div>
        </div>
    </div>

    <aside id="main-sidebar" class="hidden">
        <div class="sidebar-header">
            <div style="font-size: 1.4rem; font-weight: 900; line-height: 1.1; margin-top: 5px;">ESH <span style="color:var(--safety-yellow)">COMPLIANCE</span><br>DASHBOARD</div>
            <div id="live-date" style="font-size:0.58rem;font-weight:500;color:rgba(255,255,255,0.45);letter-spacing:0.3px;margin-top:6px;"></div>
            <div id="live-clock" style="font-size:0.82rem;font-weight:700;color:rgba(251,192,45,0.85);letter-spacing:0.5px;margin-bottom:4px;"></div>
            <div id="user-badge" class="user-badge" onclick="handleUserBadgeClick()">
                <div class="name">
                    <i class="fas fa-user-circle"></i> Loading...
                </div>
            </div>
        </div>
        <nav style="flex-grow: 1; padding-top: 10px;">
            <!-- DASHBOARD & ANALYTICS -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-chart-bar" style="margin-right: 6px;"></i> Dashboard & Analytics</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item active" data-tab="overall" onclick="changeTab('overall')"><i class="fas fa-gauge-high"></i> Overall Dashboard</div>
                    <div class="nav-item" data-tab="rates" onclick="changeTab('rates')"><i class="fas fa-chart-line"></i> Statistics Rate</div>
                </div>
            </div>

            <!-- MONITORING -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-eye" style="margin-right: 6px;"></i> Monitoring</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="exposures" onclick="changeTab('exposures')"><i class="fas fa-stopwatch"></i> Total Exposures</div>
                    <div class="nav-item" data-tab="personnel" onclick="changeTab('personnel')"><i class="fas fa-users-viewfinder"></i> ESH Personnel Monitoring</div>
                    <div class="nav-item" data-tab="osh-requirement" onclick="changeTab('osh-requirement')"><i class="fas fa-shield-halved"></i> OSH Personnel Requirement</div>
                    <div class="nav-item" data-tab="activities" onclick="changeTab('activities')"><i class="fas fa-clipboard-check"></i> ESH Activities & Programs</div>
                </div>
            </div>

            <!-- REPORTORIAL -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-file-alt" style="margin-right: 6px;"></i> Reportorial</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="kpm" onclick="changeTab('kpm')"><i class="fas fa-file-lines"></i> Monthly Report</div>
                    <div class="nav-item" data-tab="dole" onclick="changeTab('dole')"><i class="fas fa-file-contract"></i> DOLE Reportorial</div>
                    <div class="nav-item" data-tab="emb" onclick="changeTab('emb')"><i class="fas fa-industry"></i> EMB Reportorial</div>
                    <div class="nav-item" data-tab="doe" onclick="changeTab('doe')"><i class="fas fa-solar-panel"></i> DOE Reportorial</div>
                    <div class="nav-item" data-tab="env-monthly-report" onclick="changeTab('env-monthly-report')"><i class="fas fa-leaf"></i> Envi Reportorial</div>
                </div>
            </div>

            <!-- SAFETY RECORDS -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-triangle-exclamation" style="margin-right: 6px;"></i> Safety Records</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="medical" onclick="changeTab('medical')"><i class="fas fa-triangle-exclamation"></i> Accident/Incident Record</div>
                    <div class="nav-item" data-tab="nov" onclick="changeTab('nov')"><i class="fas fa-gavel"></i> Regulatory Issued NOV</div>
                    <div class="nav-item" data-tab="nov-monitoring" onclick="changeTab('nov-monitoring')"><i class="fas fa-chart-gantt"></i> ESH NOV Monitoring</div>
                </div>
            </div>

            <!-- COMPLIANCE & AUDIT -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fa-solid fa-magnifying-glass-chart" style="margin-right: 6px;"></i> Compliance & Audit</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="audit" onclick="changeTab('audit')"><i class="fas fa-magnifying-glass-dollar"></i> Internal ESH Audit Result <i class="fas fa-lock" id="audit-nav-lock" style="font-size:0.7rem; margin-left:4px; color:#fb8c00; display:none;" title="Admin only"></i></div>
                    <div class="nav-item" data-tab="cshp" onclick="changeTab('cshp')"><i class="fas fa-shield-heart"></i> CSHP</div>
                    <div class="nav-item" data-tab="reg" onclick="changeTab('reg')"><i class="fas fa-certificate"></i> Certificate of Registration</div>
                    <div class="nav-item" data-tab="doe-permit" onclick="changeTab('doe-permit')"><i class="fas fa-id-card"></i> DOE Safety Officer Permit</div>
                    <div class="nav-item" data-tab="permits" onclick="changeTab('permits')"><i class="fas fa-leaf"></i> Environmental Permits</div>
                    <div class="nav-item" data-tab="env-monitoring" onclick="changeTab('env-monitoring')"><i class="fas fa-seedling"></i> Environmental Monitoring</div>

                </div>
            </div>

            <!-- ESH CALENDAR & DRILLS -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-calendar-check" style="margin-right: 6px;"></i> ESH Calendar & Drills</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="esh-calendar-env" onclick="changeTab('esh-calendar-env')"><i class="fas fa-leaf"></i> Environment Trainings</div>
                    <div class="nav-item" data-tab="esh-calendar-safety" onclick="changeTab('esh-calendar-safety')"><i class="fas fa-hard-hat"></i> Safety Trainings</div>
                    <div class="nav-item" data-tab="esh-calendar-health" onclick="changeTab('esh-calendar-health')"><i class="fas fa-heart-pulse"></i> Health Trainings</div>
                    <div class="nav-item" data-tab="esh-calendar-drills" onclick="changeTab('esh-calendar-drills')"><i class="fas fa-person-running"></i> Emergency Drills</div>
                </div>
            </div>

            <!-- Hidden Settings Tab -->
            <div class="nav-item" data-tab="settings" onclick="changeTab('settings')" style="display: none;"><i class="fas fa-sliders"></i> Settings</div>
        </nav>

    </aside>

    <main id="main-content" class="hidden">
        <header>
            <h2 class="header-title">OVERALL DASHBOARD</h2>
            <div class="header-controls">
                <!-- Search and filters removed from header - moved to dashboard content area -->
                
                <!-- Always visible controls -->

                <!-- EXPORT PDF BUTTON -->
                <button id="export-pdf-btn" class="year-selector-btn" onclick="exportCurrentTabToPDF()" title="Export to PDF Report" style="padding:4px 6px;">
                    <i class="fas fa-file-pdf" style="color:#e53935;font-size:1.35rem;"></i>
                </button>

                <!-- EXPORT EXCEL BUTTON -->
                <button id="export-excel-btn" class="year-selector-btn" onclick="exportCurrentTabToExcel()" title="Export to Excel" style="padding:4px 6px;">
                    <i class="fas fa-file-excel" style="color:#1b7e3d;font-size:1.35rem;"></i>
                </button>
                
                <!-- DEVICE COUNTER (Admin Only) -->
                <div class="device-counter-container" id="device-counter-container" style="display: none;">
                    <button class="device-counter-btn" onclick="toggleDeviceDropdown()" id="device-counter-btn" title="Active Devices">
                        <i class="fas fa-laptop"></i>
                        <span class="counter-badge" id="device-count-badge">0</span>
                    </button>
                    <div class="device-dropdown hidden" id="device-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-laptop"></i></div>
                            <div>
                                <div class="ud-header-text">Active Devices</div>
                                <div class="ud-header-sub">Connected sessions</div>
                            </div>
                        </div>
                        <div class="dropdown-list" id="device-list"></div>
                        <div style="padding: 8px 12px; border-top: 1px solid var(--border-color);">
                            <button onclick="clearStalePresenceData()" style="width:100%; padding:7px; background:#ffebee; color:#c62828; border:1px solid #ef9a9a; border-radius:8px; font-size:12px; font-weight:600; cursor:pointer;">
                                <i class="fas fa-broom"></i> Clear Stale Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ACTIVE USERS (Admin Only) -->
                <div class="active-users-container" id="active-users-container" style="display: none;">
                    <button class="active-users-btn" onclick="toggleUsersDropdown()" id="active-users-btn" title="Active Users">
                        <i class="fas fa-users"></i>
                        <span class="counter-badge" id="users-count-badge">0</span>
                    </button>
                    <div class="users-dropdown hidden" id="users-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-users"></i></div>
                            <div>
                                <div class="ud-header-text">Active Users</div>
                                <div class="ud-header-sub">Currently online</div>
                            </div>
                        </div>
                        <div class="dropdown-list" id="users-list"></div>
                    </div>
                </div>

                <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode" style="display: none;">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>

                <!-- YEAR SELECTOR -->
                <div class="year-selector-container" style="position: relative;">
                    <button class="year-selector-btn" onclick="toggleYearDropdown()" id="year-selector-btn" title="Select Year">
                        <span id="year-selector-label">2026</span>
                    </button>
                    <div class="year-dropdown hidden" id="year-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-text">Select Year</div>
                        </div>
                        <div class="year-options" id="year-options"></div>
                        <button class="year-add-btn" onclick="showAddYearDialog()" title="Add Custom Year">
                            <i class="fas fa-plus"></i> Add Year
                        </button>
                    </div>
                </div>

                <!-- NOTIFICATION BELL -->
                <div class="notification-bell-container">
                    <button class="notification-bell-btn" onclick="toggleNotificationDropdown()" id="notification-bell-btn" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge hidden" id="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown hidden" id="notification-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon" style="background:#fff3e0"><i class="fas fa-bell" style="color:#e65100"></i></div>
                            <div>
                                <div class="ud-header-text">Overdue Reports</div>
                                <div class="ud-header-sub">Requires your attention</div>
                            </div>
                        </div>
                        <div class="notification-list" id="notification-list"></div>
                    </div>
                </div>

                <!-- SETTINGS DROPDOWN -->
                <div class="settings-dropdown-container">
                    <button class="settings-dropdown-btn" onclick="toggleSettingsDropdown()" id="settings-dropdown-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="settings-dropdown hidden" id="settings-dropdown-menu">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-cog"></i></div>
                            <div>
                                <div class="ud-header-text">Settings</div>
                                <div class="ud-header-sub">ESH Dashboard</div>
                            </div>
                        </div>
                        <div class="settings-menu">
                            <div class="settings-menu-item" onclick="openSettingsTab()">
                                <div class="smi-icon" style="background:#e8f5e9"><i class="fas fa-sliders-h" style="color:#2e7d32"></i></div>
                                <span class="smi-label">Account Settings</span>
                                <i class="fas fa-chevron-right smi-arrow"></i>
                            </div>
                            <div class="settings-menu-item" onclick="toggleDarkModeFromMenu()">
                                <div class="smi-icon" style="background:#e3f2fd"><i class="fas fa-moon" id="settings-theme-icon" style="color:#1976d2"></i></div>
                                <span class="smi-label" id="settings-theme-text">Dark Mode</span>
                                <i class="fas fa-chevron-right smi-arrow"></i>
                            </div>
                            <div class="settings-menu-item" onclick="saveToFirebaseMain()">
                                <div class="smi-icon" style="background:#fff8e1"><i class="fas fa-cloud-upload-alt" style="color:#f57f17"></i></div>
                                <span class="smi-label">Sync to Cloud</span>
                                <i class="fas fa-chevron-right smi-arrow"></i>
                            </div>
                            <div class="settings-divider"></div>
                            <div class="settings-menu-item logout" onclick="handleLogoutFromMenu()">
                                <div class="smi-icon"><i class="fas fa-right-from-bracket"></i></div>
                                <span class="smi-label">Logout Session</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </header>
       
<!-- ‚îÄ‚îÄ Global RBAC Banner ‚Äî shown on ALL tabs for superintendent & PCO ‚îÄ‚îÄ -->
<div id="global-rbac-banner" style="display:none;margin:10px 20px 0;"></div>

 <div id="dashboard-content" style="margin-top: 10px;"></div>



<!-- ==================== ADMIN PANEL ==================== -->
<style>
    /* ‚îÄ‚îÄ Admin Panel: Option A + ESH Green/Yellow ‚îÄ‚îÄ */
    #admin-view {
        padding: 28px 32px;
        background: var(--bg-body);
    }

    .adm-wrap {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Top bar */
    .adm-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-bottom: 18px;
        border-bottom: 2px solid #2e7d32;
        margin-bottom: 22px;
    }

    .adm-topbar-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .adm-topbar-left i {
        font-size: 0.9rem;
        color: #2e7d32;
    }

    .adm-topbar-title {
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-primary);
    }

    .adm-topbar-badge {
        font-size: 0.6rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: #2e7d32;
        color: #fff;
        padding: 3px 8px;
        border-radius: 4px;
    }

    .adm-topbar-right {
        display: flex;
        align-items: center;
        gap: 20px;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .adm-topbar-right span strong {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Stats row */
    .adm-stats {
        display: flex;
        gap: 0;
        margin-bottom: 26px;
        background: var(--bg-card);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .adm-stat {
        flex: 1;
        padding: 16px 20px;
        border-right: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .adm-stat:last-child { border-right: none; }

    .adm-stat-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .adm-stat-body {}

    .adm-stat-num {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .adm-stat-label {
        font-size: 0.68rem;
        color: var(--text-secondary);
        margin-top: 3px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    /* Section label */
    .adm-section-label {
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .adm-section-label::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border-color);
    }

    /* Logbook action row */
    .adm-action-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .adm-btn-group {
        display: flex;
        gap: 4px;
    }

    .adm-btn {
        font-size: 0.72rem;
        color: var(--text-secondary);
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 11px;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.15s;
        background: var(--bg-card);
    }



    .adm-btn i { font-size: 0.65rem; }

    /* Search row */
    .adm-search-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .adm-input {
        flex: 1;
        padding: 7px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.75rem;
        font-family: inherit;
        background: var(--input-bg);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.15s;
    }

    .adm-input:focus { border-color: #2e7d32; }

    .adm-select {
        padding: 7px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.75rem;
        font-family: inherit;
        background: var(--input-bg);
        color: var(--text-primary);
        outline: none;
    }

    /* Table */
    .adm-table-wrap {
        border: 1px solid var(--border-color);
        border-radius: 7px;
        overflow: hidden;
        margin-bottom: 28px;
    }

    /* User management */
    .adm-users-wrap {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .adm-users-wrap::-webkit-scrollbar {
        height: 8px;
    }
    
    .adm-users-wrap::-webkit-scrollbar-track {
        background: var(--bg-body);
        border-radius: 4px;
    }
    
    .adm-users-wrap::-webkit-scrollbar-thumb {
        background: #2e7d32;
        border-radius: 4px;
    }
    
    .adm-users-wrap::-webkit-scrollbar-thumb:hover {
        background: #1b5e20;
    }

    .adm-user-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 14px 16px;
        background: var(--bg-card);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: border-color 0.15s;
        min-width: 280px;
        flex-shrink: 0;
    }


    .adm-user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #e8f5e9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        color: #2e7d32;
        flex-shrink: 0;
    }

    .adm-user-info { flex: 1; min-width: 0; }

    .adm-user-name {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .adm-user-email {
        font-size: 0.68rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
    }

    .adm-user-meta {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    .adm-meta-tag {
        font-size: 0.62rem;
        padding: 2px 6px;
        background: var(--bg-body);
        border-radius: 3px;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .adm-revoke-btn {
        font-size: 0.68rem;
        padding: 5px 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.15s;
        flex-shrink: 0;
    }



    .adm-admin-tag {
        font-size: 0.58rem;
        font-weight: 700;
        padding: 2px 7px;
        background: #2e7d32;
        color: #fff;
        border-radius: 3px;
        letter-spacing: 0.05em;
        flex-shrink: 0;
    }

    /* Yellow accent line on stat hover */

    /* ‚îÄ‚îÄ RBAC Setup Table ‚îÄ‚îÄ */
    .rbac-row-cell {
        padding: 9px 14px;
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        color: var(--text-primary);
        font-size: 0.73rem;
        background: var(--bg-card);
    }
    .rbac-row-cell.rbac-alt { background: var(--input-bg); }
    .rbac-row-cell.rbac-status-cell { justify-content: center; }
    .rbac-ok  { color: #2e7d32; font-weight: 700; font-size: 0.7rem; }
    .rbac-err { color: #c62828; font-weight: 700; font-size: 0.7rem; }
    .rbac-spin { color: #94a3b8; font-size: 0.7rem; }
</style>

<div id="admin-view" class="hidden">
    <div class="adm-wrap">

        <!-- Top bar -->
        <div class="adm-topbar">
            <div class="adm-topbar-left">
                <i class="fas fa-shield-halved"></i>
                <span class="adm-topbar-title">Admin Panel</span>
                <span class="adm-topbar-badge">Full Access</span>
            </div>
            <div class="adm-topbar-right">
                <span><strong id="admin-user-email">‚Äî</strong></span>
                <span>Session: <strong id="admin-session-time">‚Äî</strong></span>
            </div>
        </div>

        <!-- Stats row -->
        <div class="adm-stats">
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#2e7d32;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-total-users">0</div>
                    <div class="adm-stat-label">Total Users</div>
                </div>
            </div>
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#fbc02d;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-logins-24h">0</div>
                    <div class="adm-stat-label">Logins (24h)</div>
                </div>
            </div>
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#1b5e20;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-unique-ips">0</div>
                    <div class="adm-stat-label">Unique IPs (7d)</div>
                </div>
            </div>
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#fbc02d;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-total-audits">0</div>
                    <div class="adm-stat-label">Audit Logs</div>
                </div>
            </div>
        </div>

        <!-- Login Logbook -->
        <div class="adm-section-label">Login Logbook <span style="font-size:0.62rem;font-weight:600;background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:4px;margin-left:6px;">SUPERINTENDENT &amp; PCO ONLY</span></div>

        <div class="adm-action-row">
            <div style="font-size:0.75rem; color:var(--text-secondary);">Complete history of user logins with IP addresses and locations</div>
            <div class="adm-btn-group">
                <button class="adm-btn" onclick="refreshLogbook()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="adm-btn" onclick="exportLogbook()"><i class="fas fa-download"></i> Export CSV</button>
                <button class="adm-btn danger" onclick="clearLogbook()"><i class="fas fa-trash"></i> Clear Log</button>
            </div>
        </div>

        <div class="adm-search-row">
            <input type="text" class="adm-input" id="logbook-search" placeholder="Search by email, IP, or location‚Ä¶" onkeyup="filterLogbook()">
            <select class="adm-select" id="logbook-action-filter" onchange="filterLogbook()">
                <option value="">All Actions</option>
                <option value="LOGIN">Login Only</option>
                <option value="LOGOUT">Logout Only</option>
            </select>
        </div>

        <div class="adm-table-wrap">
            <div id="logbook-container">
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; margin-bottom: 10px;"></i>
                    <p style="font-size:0.8rem;">Loading logbook...</p>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="adm-section-label">User Management</div>

        <div id="user-management-container" class="adm-users-wrap">
            <div style="padding: 30px; text-align: center; color: var(--text-secondary); grid-column: 1/-1;">
                <i class="fas fa-spinner fa-spin" style="font-size: 20px; margin-bottom: 10px;"></i>
                <p style="font-size:0.8rem;">Loading users...</p>
            </div>
        </div>

        <!-- ==================== RBAC ROLES SETUP ==================== -->
        <div class="adm-section-label" style="margin-top:28px;">
            <i class="fas fa-key" style="color:#2e7d32;font-size:0.72rem;"></i>
            Firebase RBAC ‚Äî Roles Setup
        </div>

        <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;overflow:hidden;margin-bottom:28px;">

            <!-- Header -->
            <div style="background:linear-gradient(135deg,#1b5e20 0%,#2e7d32 60%,#388e3c 100%);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <i class="fas fa-shield-halved" style="font-size:1.1rem;color:#fbc02d;"></i>
                    <div>
                        <div style="font-size:0.82rem;font-weight:800;color:white;letter-spacing:0.4px;">ROLE-BASED ACCESS CONTROL DEPLOYER</div>
                        <div style="font-size:0.65rem;color:#a5d6a7;margin-top:2px;">I-deploy ang roles ng lahat ng accounts sa Firestore ‚Äî isang click lang</div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <div id="rbac-deploy-status" style="font-size:0.68rem;color:#a5d6a7;display:none;">
                        <i class="fas fa-circle-check"></i> Deployed
                    </div>
                    <button onclick="rbacDeployAll()" id="rbac-deploy-btn"
                        style="background:#fbc02d;color:#1b5e20;border:none;border-radius:6px;padding:7px 18px;font-size:0.75rem;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:7px;font-family:inherit;letter-spacing:0.3px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                        <i class="fas fa-rocket"></i> Deploy All Roles
                    </button>
                </div>
            </div>

            <!-- Warning -->
            <div style="background:#fff8e1;border-bottom:1px solid #ffe082;padding:10px 20px;display:flex;align-items:center;gap:10px;font-size:0.73rem;color:#e65100;">
                <i class="fas fa-triangle-exclamation" style="flex-shrink:0;color:#fbc02d;"></i>
                <span>Kailangan na naka-login ka bilang <strong>Admin</strong> para gumana ito. Mag-w-write ito ng <code style="background:#fff3e0;padding:1px 5px;border-radius:3px;">roles/{uid}</code> documents sa Firestore para sa bawat account.</span>
            </div>

            <!-- Accounts table -->
            <div style="padding:16px 20px 8px;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0;border:1px solid var(--border-color);border-radius:7px;overflow:hidden;font-size:0.73rem;">
                    <!-- Table header -->
                    <div style="background:#1b5e20;color:white;padding:8px 14px;font-weight:700;font-size:0.65rem;letter-spacing:0.8px;text-transform:uppercase;">Email</div>
                    <div style="background:#1b5e20;color:white;padding:8px 14px;font-weight:700;font-size:0.65rem;letter-spacing:0.8px;text-transform:uppercase;">Role</div>
                    <div style="background:#1b5e20;color:white;padding:8px 14px;font-weight:700;font-size:0.65rem;letter-spacing:0.8px;text-transform:uppercase;">Region</div>
                    <div style="background:#1b5e20;color:white;padding:8px 14px;font-weight:700;font-size:0.65rem;letter-spacing:0.8px;text-transform:uppercase;text-align:center;min-width:90px;">Status</div>

                    <!-- Row: Admin -->
                    <div class="rbac-row-cell" style="border-top:1px solid var(--border-color);">
                        <i class="fas fa-crown" style="color:#d32f2f;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2441574c6457474d470a474b490a544c">[email&#160;protected]</a>
                    </div>
                    <div class="rbac-row-cell" style="border-top:1px solid var(--border-color);">
                        <span class="adm-admin-tag" style="background:#d32f2f;">ADMIN</span>
                    </div>
                    <div class="rbac-row-cell" style="border-top:1px solid var(--border-color);color:var(--text-secondary);">ALL</div>
                    <div class="rbac-row-cell rbac-status-cell" id="rbac-st-fUnXsvKnRYMpuySRbeVYJk7TO452" style="border-top:1px solid var(--border-color);text-align:center;">‚Äî</div>

                    <!-- Superintendent rows -->
                    <div class="rbac-row-cell rbac-alt"><i class="fas fa-hard-hat" style="color:#f57c00;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3356405b735d50411d505c5e1d435b">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell rbac-alt"><span class="adm-admin-tag" style="background:#e65100;">SUPERINTENDENT</span></div>
                    <div class="rbac-row-cell rbac-alt" style="color:var(--text-secondary);">NCR</div>
                    <div class="rbac-row-cell rbac-alt rbac-status-cell" id="rbac-st-hcnqoDM72cQhesbmJpM9SMMGsQb2" style="text-align:center;">‚Äî</div>

                    <div class="rbac-row-cell"><i class="fas fa-hard-hat" style="color:#f57c00;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="80e5f3e8c0eeeff2f4e8aee3efedaef0e8">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell"><span class="adm-admin-tag" style="background:#e65100;">SUPERINTENDENT</span></div>
                    <div class="rbac-row-cell" style="color:var(--text-secondary);">NORTH LUZON</div>
                    <div class="rbac-row-cell rbac-status-cell" id="rbac-st-ZkaQ1QiZQSPKfO1VbFk5uW5eldI2" style="text-align:center;">‚Äî</div>

                    <div class="rbac-row-cell rbac-alt"><i class="fas fa-hard-hat" style="color:#f57c00;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d6b3a5be96a5b9a3a2bef8b5b9bbf8a6be">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell rbac-alt"><span class="adm-admin-tag" style="background:#e65100;">SUPERINTENDENT</span></div>
                    <div class="rbac-row-cell rbac-alt" style="color:var(--text-secondary);">SOUTH LUZON</div>
                    <div class="rbac-row-cell rbac-alt rbac-status-cell" id="rbac-st-TNR2IlOdLreZNM4AXn7ejTPVXLZ2" style="text-align:center;">‚Äî</div>

                    <div class="rbac-row-cell"><i class="fas fa-hard-hat" style="color:#f57c00;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="97f2e4ffd7e1fee4fafef9b9f4f8fab9e7ff">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell"><span class="adm-admin-tag" style="background:#e65100;">SUPERINTENDENT</span></div>
                    <div class="rbac-row-cell" style="color:var(--text-secondary);">VISAYAS & MINDANAO</div>
                    <div class="rbac-row-cell rbac-status-cell" id="rbac-st-RsOVQnzUh5bDcZCYRrE0I6P2ZCF2" style="text-align:center;">‚Äî</div>

                    <!-- PCO rows -->
                    <div class="rbac-row-cell rbac-alt"><i class="fas fa-leaf" style="color:#00897b;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="7d180e153d131e0f0d1e12531e1210530d15">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell rbac-alt"><span class="adm-admin-tag" style="background:#00695c;">PCO</span></div>
                    <div class="rbac-row-cell rbac-alt" style="color:var(--text-secondary);">NCR</div>
                    <div class="rbac-row-cell rbac-alt rbac-status-cell" id="rbac-st-XZjjCJnanac8B9r6pVUJBdEbvk93" style="text-align:center;">‚Äî</div>

                    <div class="rbac-row-cell"><i class="fas fa-leaf" style="color:#00897b;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ef8a9c87af81809d9b879f8c80c18c8082c19f87">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell"><span class="adm-admin-tag" style="background:#00695c;">PCO</span></div>
                    <div class="rbac-row-cell" style="color:var(--text-secondary);">NORTH LUZON</div>
                    <div class="rbac-row-cell rbac-status-cell" id="rbac-st-vAx6TARdxtfIQsNpNwWLO2YWh622" style="text-align:center;">‚Äî</div>

                    <div class="rbac-row-cell rbac-alt"><i class="fas fa-leaf" style="color:#00897b;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="adc8dec5eddec2d8d9c5ddcec283cec2c083ddc5">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell rbac-alt"><span class="adm-admin-tag" style="background:#00695c;">PCO</span></div>
                    <div class="rbac-row-cell rbac-alt" style="color:var(--text-secondary);">SOUTH LUZON</div>
                    <div class="rbac-row-cell rbac-alt rbac-status-cell" id="rbac-st-m6opwibuujUCci63nUNb6R6Vwse2" style="text-align:center;">‚Äî</div>

                    <div class="rbac-row-cell"><i class="fas fa-leaf" style="color:#00897b;margin-right:6px;font-size:0.65rem;"></i><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6603150e26100f150b0f081605094805090b48160e">[email&#160;protected]</a></div>
                    <div class="rbac-row-cell"><span class="adm-admin-tag" style="background:#00695c;">PCO</span></div>
                    <div class="rbac-row-cell" style="color:var(--text-secondary);">VISAYAS & MINDANAO</div>
                    <div class="rbac-row-cell rbac-status-cell" id="rbac-st-TH12T1L0G2UYrP5iSwuWL7aLHp93" style="text-align:center;">‚Äî</div>
                </div>
            </div>

            <!-- Log output -->
            <div style="padding:0 20px 16px;">
                <div id="rbac-log" style="background:var(--bg-body);border:1px solid var(--border-color);border-radius:6px;padding:10px 14px;min-height:52px;max-height:120px;overflow-y:auto;font-size:0.68rem;font-family:monospace;color:var(--text-secondary);">
                    <span style="opacity:0.4;">// Handa na. I-click ang "Deploy All Roles" para magsimula.</span>
                </div>
            </div>
        </div>
        <!-- ==================== END RBAC ROLES SETUP ==================== -->

    </div>
</div>


<div id="personnel-view" class="hidden" style="padding: 20px;">
    <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color);">

        <!-- Header Banner -->
        <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); padding: 18px 24px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
            <div style="display:flex; align-items:center; gap:10px; position: relative; z-index: 2;">
                <i class="fas fa-users-gear" style="font-size:1.3rem; color:var(--safety-yellow);"></i>
                <div>
                    <div style="font-size:1rem; font-weight:800; color:white; letter-spacing:0.5px;">ESH PERSONNEL MONITORING</div>
                    <div style="font-size:0.65rem; color:#a5d6a7; margin-top:2px;">Environment, Safety &amp; Health Team Registry</div>
                </div>
            </div>
            <div id="p-summary-badges" style="display:flex; gap:8px; flex-wrap:wrap; position: relative; z-index: 2;"></div>
        </div>

        <!-- Controls Bar -->
        <div style="padding: 14px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div style="display:flex; gap:8px; flex:1; min-width:280px;">
                <select id="p-filter-column" style="padding:8px 10px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:0.75rem; min-width:150px;">
                    <option value="all">üîç Filter: All Columns</option>
                    <option value="name">Full Name</option>
                    <option value="pos">Position</option>
                    <option value="id">ID Number</option>
                    <option value="current">Current Assignment</option>
                    <option value="gen">Gender</option>
                </select>
                <input type="text" id="p-filter-value" placeholder="Search personnel..." onkeyup="filterPTable()" style="flex:1; padding:8px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:0.75rem;">
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-primary" onclick="openAddPersonnelModal()" style="padding:8px 16px; display:flex; align-items:center; gap:6px; font-size:0.78rem; border-radius:6px;">
                    <i class="fas fa-user-plus"></i> Add Personnel
                </button>
                <div id="p-global-action" style="display:none; gap:6px;">
                    <button class="p-edit-btn" id="p-global-edit-btn" onclick="pGlobalEdit()" style="padding:8px 14px; border-radius:6px; display:flex; align-items:center; gap:5px; font-size:0.78rem;">
                        <i class="fas fa-edit"></i> Edit All
                    </button>
                    <button class="p-save-btn" id="p-global-save-btn" onclick="pGlobalSave()" style="padding:8px 14px; border-radius:6px; display:flex; align-items:center; gap:5px; font-size:0.78rem; display:none;">
                        <i class="fas fa-save"></i> Save All
                    </button>
                </div>
            </div>
        </div>

        <!-- Project Cards Container ‚Äî each project gets its own collapsible card with its own scrollbar -->
        <div id="p-cards-container" style="padding: 0;">
            <div id="p-empty" style="display:none; padding:40px; text-align:center; color:var(--text-secondary);">
                <i class="fas fa-users" style="font-size:2.5rem; opacity:0.3; margin-bottom:10px;"></i>
                <div style="font-size:0.85rem;">No personnel records yet. Click <strong>Add Personnel</strong> to get started.</div>
            </div>
        </div>

        <!-- Footer stats -->
        <div id="p-footer" style="padding:10px 20px; background:var(--border-color); border-top:1px solid var(--border-color); font-size:0.7rem; color:var(--text-secondary); display:flex; gap:20px; flex-wrap:wrap;"></div>
    </div>

</div>



<!-- ==================== OSH PERSONNEL REQUIREMENT VIEW ==================== -->
<div id="osh-requirement-view" class="hidden" style="padding:20px;">

    <!-- Header Card -->
    <div style="background:var(--bg-card);border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08);border:1px solid var(--border-color);margin-bottom:20px;">
        <div style="background:linear-gradient(135deg,#0d3d0f 0%,#2e7d32 50%,#388e3c 100%);padding:18px 24px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;position:relative;overflow:hidden;">
            <div style="position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,0.06) 50%,transparent 70%);pointer-events:none;"></div>
            <div style="display:flex;align-items:center;gap:10px;position:relative;z-index:2;">
                <i class="fas fa-shield-halved" style="font-size:1.4rem;color:#ffd54f;"></i>
                <div>
                    <div style="font-size:1rem;font-weight:800;color:white;letter-spacing:0.5px;">OSH PERSONNEL REQUIREMENT MONITORING</div>
                    <div style="font-size:0.65rem;color:#a5d6a7;margin-top:2px;">DOLE OSHS Construction ‚Äì Section 22 Auto-Detection &amp; Registry Cross-Reference</div>
                </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;position:relative;z-index:2;">
                <div id="osh2-badge-total" style="background:rgba(255,255,255,0.12);color:white;padding:5px 14px;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid rgba(255,255,255,0.25);">‚Äì</div>
                <div id="osh2-badge-compliant" style="background:rgba(76,175,80,0.25);color:#a5d6a7;padding:5px 14px;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid rgba(76,175,80,0.4);">‚Äì</div>
                <div id="osh2-badge-deficient" style="background:rgba(244,67,54,0.2);color:#ef9a9a;padding:5px 14px;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid rgba(244,67,54,0.35);">‚Äì</div>
            </div>
        </div>

        <!-- Summary stat bar -->
        <div id="osh2-stat-bar" style="display:flex;gap:0;border-bottom:1px solid var(--border-color);overflow:hidden;"></div>
    </div>

    <!-- Reference Matrix -->
    <div style="background:var(--bg-card);border-radius:10px;overflow:hidden;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:16px;">
        <div onclick="toggleOsh2Ref(this)" style="padding:11px 18px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:0.76rem;font-weight:700;color:var(--text-secondary);user-select:none;background:var(--input-bg);border-bottom:1px solid transparent;">
            <i class="fas fa-chevron-right" id="osh2-ref-chevron" style="transition:transform 0.3s;font-size:0.62rem;"></i>
            <i class="fas fa-table-list" style="color:#2e7d32;"></i>
            DO 252-25 Section 22 ‚Äì OSHS for the Construction Industry
        </div>
        <div id="osh2-ref-matrix" style="display:none;overflow-x:auto;padding:12px 16px;">
            <table style="width:100%;border-collapse:collapse;font-size:0.7rem;min-width:650px;">
                <thead>
                    <tr style="background:#1b5e20;">
                        <th style="padding:9px 12px;text-align:center;border:1px solid #2e7d32;color:white;font-weight:700;">No. of Workers</th>
                        <th style="padding:9px 12px;text-align:center;border:1px solid #2e7d32;color:white;font-weight:700;">First Aider</th>
                        <th style="padding:9px 12px;text-align:center;border:1px solid #2e7d32;color:white;font-weight:700;">Safety Officer</th>
                        <th style="padding:9px 12px;text-align:center;border:1px solid #2e7d32;color:white;font-weight:700;">OH Nurse</th>
                        <th style="padding:9px 12px;text-align:center;border:1px solid #2e7d32;color:white;font-weight:700;">OH Dentist</th>
                        <th style="padding:9px 12px;text-align:center;border:1px solid #2e7d32;color:white;font-weight:700;">OH Physician</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;font-weight:600;">1 ‚Äì 9</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 SO2</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td></tr>
                    <tr style="background:#f1f8e9;"><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;font-weight:600;">10 ‚Äì 50</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">2</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">2 SO2</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td></tr>
                    <tr><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;font-weight:600;">51 ‚Äì 99</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">2</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 SO2</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 PT</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td></tr>
                    <tr style="background:#f1f8e9;"><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;font-weight:600;">100 ‚Äì 199</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">3</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">3 SO2 or 2 SO3</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 FT</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 PT</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 PT</td></tr>
                    <tr><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;font-weight:600;">200 ‚Äì 500</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">6</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">2 SO3 + 1 SO4</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">2 PT</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td></tr>
                    <tr style="background:#f1f8e9;"><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;font-weight:600;">501+</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">6 + 1 per 500‚Üë</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">3 SO + 1 per 500‚Üë</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1 FT + 1FT per 250‚Üë</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">‚Äì</td><td style="padding:7px 12px;border:1px solid #e8f5e9;text-align:center;">1FT per 500‚Üë</td></tr>
                </tbody>
            </table>
            <div style="margin-top:10px;padding:8px 12px;background:#fff8e1;border-radius:6px;font-size:0.68rem;color:#795548;border-left:3px solid #fbc02d;">
                <strong>üìå Position Mapping from Registry:</strong> Safety Officer II/III/IV ‚Üí Safety Officer count &nbsp;|&nbsp; First Aider ‚Üí First Aider count &nbsp;|&nbsp; Project Nurse ‚Üí OH Nurse count &nbsp;|&nbsp; Project Physician ‚Üí OH Physician count &nbsp;|&nbsp; OH Dentist positions (if any) ‚Üí OH Dentist count
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div style="background:var(--bg-card);border-radius:10px;padding:12px 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <div style="display:flex;gap:6px;align-items:center;">
            <i class="fas fa-filter" style="color:var(--text-secondary);font-size:0.75rem;"></i>
            <select id="osh2-region-filter" onchange="renderOsh2()" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-primary);font-size:0.74rem;min-width:160px;">
                <option value="all">üìç All Regions</option>
                <option value="NCR">NCR</option>
                <option value="NORTH LUZON">North Luzon</option>
                <option value="SOUTH LUZON">South Luzon</option>
                <option value="VISAYAS & MINDANAO">Visayas &amp; Mindanao</option>
            </select>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
            <select id="osh2-status-filter" onchange="renderOsh2()" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-primary);font-size:0.74rem;min-width:140px;">
                <option value="all">üìä All Status</option>
                <option value="deficient">‚ö†Ô∏è Deficient Only</option>
                <option value="compliant">‚úÖ Compliant Only</option>
                <option value="no-input">‚ùì No Manpower Input</option>
            </select>
        </div>
        <div style="display:flex;gap:4px;margin-left:auto;align-items:center;font-size:0.72rem;color:var(--text-secondary);">
            <span style="display:inline-flex;align-items:center;gap:4px;margin-right:8px;"><span style="width:11px;height:11px;background:#e8f5e9;border:1.5px solid #2e7d32;border-radius:2px;display:inline-block;"></span>Compliant</span>
            <span style="display:inline-flex;align-items:center;gap:4px;margin-right:8px;"><span style="width:11px;height:11px;background:#fff3e0;border:1.5px solid #e65100;border-radius:2px;display:inline-block;"></span>Deficient</span>
            <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:11px;height:11px;background:#f5f5f5;border:1.5px solid #bdbdbd;border-radius:2px;display:inline-block;"></span>Not Required</span>
        </div>
        <button onclick="renderOsh2()" title="Refresh" style="padding:6px 12px;border-radius:6px;background:var(--input-bg);border:1px solid var(--border-color);cursor:pointer;color:var(--text-primary);font-size:0.74rem;display:flex;align-items:center;gap:5px;">
            <i class="fas fa-rotate-right"></i> Refresh
        </button>
    </div>

    <!-- Region Sections (dynamically rendered) -->
    <div id="osh2-regions-container"></div>

</div>
<!-- ==================== END OSH PERSONNEL REQUIREMENT VIEW ==================== -->

<!-- ==================== ENVIRONMENTAL MONITORING VIEW ==================== -->
<div id="env-monitoring-view" class="hidden" style="padding:20px;">

    <!-- Header Card -->
    <div style="background:var(--bg-card);border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08);border:1px solid var(--border-color);margin-bottom:16px;">
        <div style="background:linear-gradient(135deg,#0d3d0f 0%,#1b6e1f 50%,#2e7d32 100%);padding:16px 22px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;position:relative;overflow:hidden;">
            <div style="position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,0.06) 50%,transparent 70%);pointer-events:none;"></div>
            <div style="display:flex;align-items:center;gap:10px;position:relative;z-index:2;">
                <i class="fas fa-seedling" style="font-size:1.4rem;color:#a5d6a7;"></i>
                <div>
                    <div style="font-size:1rem;font-weight:800;color:white;letter-spacing:0.5px;">ENVIRONMENTAL MONITORING</div>
                    <div style="font-size:0.65rem;color:#a5d6a7;margin-top:2px;">Electricity Consumption &amp; GHG Emission Tracker ‚Äî Per Region</div>
                </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;position:relative;z-index:2;">
                <div id="env-badge-kwh" style="background:rgba(255,255,255,0.12);color:white;padding:5px 14px;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid rgba(255,255,255,0.25);">0 kWh Total</div>
                <div id="env-badge-ghg" style="background:rgba(76,175,80,0.25);color:#a5d6a7;padding:5px 14px;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid rgba(76,175,80,0.4);">0.0000 tCO2</div>
                <div id="env-badge-trees" style="background:rgba(255,235,59,0.15);color:#fff176;padding:5px 14px;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid rgba(255,235,59,0.3);">0 Trees Needed</div>
            </div>
        </div>
    </div>

    <!-- Overall Summary (after banner) -->
    <div id="env-overall-summary-container" style="margin-bottom:16px;"></div>

    <!-- Chart Row (compact, top) -->
    <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px;align-items:flex-start;">
        <!-- Pie Chart -->
        <div style="background:var(--bg-card);border-radius:12px;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:14px 16px;flex:0 0 260px;min-width:220px;">
            <div style="font-size:0.7rem;font-weight:700;color:var(--text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;"><i class="fas fa-chart-pie" style="color:#2e7d32;margin-right:5px;"></i>kWh by Region</div>
            <div style="position:relative;width:180px;height:180px;margin:0 auto;">
                <canvas id="env-pie-chart" width="180" height="180"></canvas>
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;">
                    <div style="font-size:1rem;font-weight:800;color:var(--text-primary);" id="env-pie-total">0</div>
                    <div style="font-size:0.58rem;color:var(--text-secondary);">kWh Total</div>
                </div>
            </div>
            <div id="env-pie-legend" style="margin-top:8px;display:flex;flex-direction:column;gap:3px;font-size:0.66rem;"></div>
        </div>
        <!-- Info Panel -->
        <div style="background:var(--bg-card);border-radius:12px;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:14px 16px;flex:1;min-width:200px;display:flex;flex-direction:column;gap:10px;justify-content:center;">
            <div style="font-size:0.7rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;"><i class="fas fa-info-circle" style="color:#2e7d32;margin-right:5px;"></i>How to Use</div>
            <div style="font-size:0.74rem;color:var(--text-primary);line-height:1.6;">
                Each region below has its own <strong>collapsible section</strong> with an entry form and table.<br>
                Click <span style="background:#e8f5e9;color:#2e7d32;padding:1px 7px;border-radius:4px;font-weight:700;font-size:0.7rem;">Ôºã Add Row</span> inside a region to log electricity data for that area.<br>
                Multiple rows per month are supported ‚Äî just add as many as needed.
            </div>
            <div style="font-size:0.66rem;color:var(--text-secondary);background:var(--input-bg);border-radius:6px;padding:8px 10px;border-left:3px solid #2e7d32;">
                <i class="fas fa-calculator" style="color:#2e7d32;"></i> <strong>Auto-calc:</strong> 1 kWh = 0.000694 tCO2 &nbsp;|&nbsp; 1 tree ‚âà 21.77 kg CO2/yr
            </div>
        </div>
    </div>

    <!-- Region Sections (dynamically rendered) -->
    <div id="env-regions-container"></div>

</div>
<!-- ==================== END ENVIRONMENTAL MONITORING VIEW ==================== -->

<!-- ==================== ESH CALENDAR VIEWS ==================== -->
<div id="esh-calendar-env-view" class="hidden" style="padding:0;"></div>
<div id="esh-calendar-safety-view" class="hidden" style="padding:0;"></div>
<div id="esh-calendar-health-view" class="hidden" style="padding:0;"></div>
<div id="esh-calendar-drills-view" class="hidden" style="padding:0;"></div>
<!-- ==================== END ESH CALENDAR VIEWS ==================== -->

        <div id="settings-view" class="hidden">
  <style>
    .settings-page { max-width: 780px; margin: 0 auto; padding: 28px 24px 80px; }
    .settings-hero {
      background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 60%, #2e7d32 100%);
      border-radius: 16px; padding: 28px 30px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px; position: relative; overflow: hidden;
    }
    .settings-hero::before {
      content: ''; position: absolute; top: -30px; right: -30px;
      width: 180px; height: 180px; border-radius: 50%;
      background: rgba(251,192,45,0.08); pointer-events: none;
    }
    .settings-hero::after {
      content: ''; position: absolute; bottom: -50px; right: 60px;
      width: 120px; height: 120px; border-radius: 50%;
      background: rgba(255,255,255,0.04); pointer-events: none;
    }
    .settings-avatar {
      width: 72px; height: 72px; border-radius: 50%;
      background: rgba(255,255,255,0.12); border: 3px solid rgba(251,192,45,0.6);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; color: #fbc02d; flex-shrink: 0;
      box-shadow: 0 0 0 6px rgba(251,192,45,0.1);
    }
    .settings-hero-info { flex: 1; }
    .settings-hero-name { font-size: 1.25rem; font-weight: 800; color: white; letter-spacing: 0.3px; }
    .settings-hero-email { font-size: 0.78rem; color: #a5d6a7; margin-top: 3px; }
    .settings-hero-badge {
      background: rgba(251,192,45,0.2); border: 1px solid rgba(251,192,45,0.4);
      color: #fbc02d; font-size: 0.65rem; font-weight: 700; padding: 3px 10px;
      border-radius: 20px; letter-spacing: 0.5px; margin-top: 8px; display: inline-block;
    }
    .settings-sync-status {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.7rem; color: #a5d6a7; margin-top: 6px;
    }
    .settings-sync-dot {
      width: 7px; height: 7px; border-radius: 50%; background: #4caf50;
      animation: pulse 2s infinite;
    }

    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    @media (max-width: 620px) { .settings-grid { grid-template-columns: 1fr; } }

    .settings-card {
      background: var(--bg-card); border-radius: 14px; overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 12px rgba(0,0,0,0.06); transition: box-shadow 0.2s;
    }
    .settings-card-full { grid-column: 1 / -1; }
    .settings-card-header {
      background: linear-gradient(90deg, #1b5e20 0%, #2e7d32 100%);
      padding: 13px 18px; display: flex; align-items: center; gap: 10px;
    }
    .settings-card-header i { color: #fbc02d; font-size: 0.95rem; }
    .settings-card-title { color: white; font-weight: 700; font-size: 0.82rem; letter-spacing: 0.5px; }
    .settings-card-body { padding: 18px; }

    .settings-input-group { margin-bottom: 14px; position: relative; }
    .settings-input-group:last-child { margin-bottom: 0; }
    .settings-label {
      display: block; font-size: 0.72rem; font-weight: 700;
      color: var(--text-secondary); letter-spacing: 0.5px;
      text-transform: uppercase; margin-bottom: 6px;
    }
    .settings-input {
      width: 100%; padding: 11px 14px; border: 1.5px solid var(--border-color);
      border-radius: 8px; font-size: 0.85rem; background: var(--input-bg);
      color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .settings-input:focus {
      outline: none; border-color: #2e7d32;
      box-shadow: 0 0 0 3px rgba(46,125,50,0.15);
    }
    .settings-input:disabled {
      opacity: 0.65; cursor: not-allowed; background: var(--border-color);
    }
    .settings-input-icon { position: relative; }
    .settings-input-icon .settings-input { padding-right: 42px; }
    .settings-input-icon .icon-btn {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text-secondary);
      font-size: 0.9rem; padding: 4px; transition: color 0.2s;
    }

    .settings-btn {
      width: 100%; padding: 11px; border: none; border-radius: 8px;
      font-size: 0.82rem; font-weight: 700; cursor: pointer;
      letter-spacing: 0.5px; display: flex; align-items: center;
      justify-content: center; gap: 8px; transition: all 0.2s; margin-top: 4px;
    }
    .settings-btn-primary {
      background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
      color: white; box-shadow: 0 3px 10px rgba(27,94,32,0.3);
    }
    .settings-btn-primary:disabled { opacity: 0.6; cursor: wait; transform: none; }
    .settings-btn-danger { background: #ffebee; color: #c62828; border: 1.5px solid #ffcdd2; }
    .settings-btn-outline {
      background: transparent; color: #1b5e20;
      border: 1.5px solid #2e7d32;
    }
    .settings-btn + .settings-btn { margin-top: 8px; }

    .settings-msg {
      margin-top: 10px; padding: 10px 14px; border-radius: 7px;
      font-size: 0.78rem; font-weight: 600; display: none;
    }
    .settings-msg.success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; display: block; }
    .settings-msg.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; display: block; }
    .settings-msg.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; display: block; }
    .settings-msg.loading { background: #f3e5f5; color: #6a1b9a; border-left: 4px solid #9c27b0; display: flex; align-items: center; gap: 8px; }

    .settings-divider { height: 1px; background: var(--border-color); margin: 14px 0; }

    .danger-zone-card .settings-card-header { background: linear-gradient(90deg, #b71c1c 0%, #d32f2f 100%); }

    .theme-options { display: flex; gap: 10px; margin-bottom: 14px; }
    .theme-option {
      flex: 1; padding: 12px 8px; border-radius: 10px; cursor: pointer;
      border: 2px solid var(--border-color); text-align: center;
      transition: all 0.2s; font-size: 0.75rem; font-weight: 600;
    }
    .theme-option.active { border-color: #2e7d32; background: #e8f5e9; color: #1b5e20; }
    body.dark-mode .theme-option.active { background: rgba(46,125,50,0.2); }
    .theme-option .theme-icon { font-size: 1.5rem; margin-bottom: 5px; }

    .info-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.78rem;
    }
    .info-row:last-child { border-bottom: none; padding-bottom: 0; }
    .info-row-label { color: var(--text-secondary); font-weight: 600; }
    .info-row-value { color: var(--text-primary); font-weight: 500; }
    .firebase-status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 700;
    }
    .firebase-status-badge.connected { background: #e8f5e9; color: #2e7d32; }
    .firebase-status-badge.disconnected { background: #ffebee; color: #c62828; }

    .username-display {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: var(--input-bg); border: 1.5px solid var(--border-color);
      border-radius: 8px; margin-bottom: 4px;
    }
    .username-display-text { font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
    .username-edit-btn {
      background: none; border: none; cursor: pointer;
      color: #1976D2; font-size: 0.75rem; font-weight: 600;
      display: flex; align-items: center; gap: 4px;
    }
  </style>

  <div class="settings-page">

    <!-- Hero Header -->
    <div class="settings-hero">
      <div class="settings-avatar"><i class="fas fa-user-shield"></i></div>
      <div class="settings-hero-info">
        <div class="settings-hero-name" id="settings-display-name">ESH User</div>
        <div class="settings-hero-email" id="settings-hero-email">Loading...</div>
        <div class="settings-hero-badge"><i class="fas fa-shield-halved"></i> &nbsp;ESH COMPLIANCE OFFICER</div>
        <div class="settings-sync-status">
          <span class="settings-sync-dot"></span>
          <span id="settings-firebase-sync-label">Connected to Firebase</span>
        </div>
      </div>
    </div>

    <div class="settings-grid">

      <!-- Profile / Display Name -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-id-badge"></i>
          <span class="settings-card-title">DISPLAY NAME</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">Current Display Name</label>
            <div class="username-display">
              <span class="username-display-text" id="current-display-name-text">‚Äî</span>
              <button class="username-edit-btn" onclick="toggleUsernameEdit()">
                <i class="fas fa-pencil"></i> Edit
              </button>
            </div>
          </div>
          <div id="username-edit-fields" style="display:none;">
            <div class="settings-input-group">
              <label class="settings-label">New Display Name</label>
              <input type="text" id="new-display-name" class="settings-input" placeholder="Enter display name" maxlength="40">
            </div>
            <button class="settings-btn settings-btn-primary" id="save-name-btn" onclick="saveDisplayName()">
              <i class="fas fa-save"></i> SAVE NAME
            </button>
          </div>
          <div id="name-msg" class="settings-msg"></div>
        </div>
      </div>

      <!-- Account Info -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-circle-info"></i>
          <span class="settings-card-title">ACCOUNT INFO</span>
        </div>
        <div class="settings-card-body">
          <div class="info-row">
            <span class="info-row-label">Email</span>
            <span class="info-row-value" id="current-email" style="font-size:0.75rem; word-break:break-all;">‚Äî</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Firebase UID</span>
            <span class="info-row-value" id="settings-uid" style="font-size:0.65rem; font-family:monospace; color:var(--text-secondary);">‚Äî</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Firebase Status</span>
            <span id="settings-firebase-status" class="firebase-status-badge connected">
              <i class="fas fa-wifi"></i> Connected
            </span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Last Sync</span>
            <span class="info-row-value" id="settings-last-sync">‚Äî</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Total Projects</span>
            <span class="info-row-value" id="settings-total-projects">‚Äî</span>
          </div>
        </div>
      </div>

      <!-- Change Password - IMPROVED SECURITY -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-lock"></i>
          <span class="settings-card-title">CHANGE PASSWORD</span>
          <span style="font-size: 11px; color: var(--safety-yellow); background: rgba(251, 192, 45, 0.15); padding: 3px 8px; border-radius: 4px; margin-left: 10px;">
            üîê Enhanced Security
          </span>
        </div>
        <div class="settings-card-body">
          
          <!-- SECURITY INFO BOX -->
          <div style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
            <div style="display: flex; align-items: start; gap: 10px;">
              <i class="fas fa-shield-alt" style="font-size: 20px; margin-top: 2px;"></i>
              <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 6px; font-size: 13px;">üîí Security Requirements:</strong>
                <ul style="margin: 0; padding-left: 18px; font-size: 11px; line-height: 1.5;">
                  <li>Must enter your <strong>current password</strong> to verify identity</li>
                  <li>New password: <strong>8+ characters</strong>, include <strong>numbers & special chars</strong></li>
                  <li>All devices will be <strong>logged out automatically</strong></li>
                  <li>You'll receive an <strong>email confirmation</strong></li>
                </ul>
              </div>
            </div>
          </div>

          <!-- CURRENT PASSWORD -->
          <div class="settings-input-group">
            <label class="settings-label">
              <i class="fas fa-lock"></i> Current Password
              <span style="color: #e53935; font-size: 11px; font-weight: normal;">(Required for verification)</span>
            </label>
            <div class="settings-input-icon">
              <input type="password" id="current-password" class="settings-input" placeholder="Enter your current password">
              <button class="icon-btn" onclick="togglePwd('current-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>

          <!-- NEW PASSWORD -->
          <div class="settings-input-group">
            <label class="settings-label">
              <i class="fas fa-key"></i> New Password
              <span style="color: #666; font-size: 11px; font-weight: normal;">(Min. 8 characters)</span>
            </label>
            <div class="settings-input-icon">
              <input type="password" id="new-password" class="settings-input" placeholder="Min. 8 chars, include numbers & special chars">
              <button class="icon-btn" onclick="togglePwd('new-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          
          <!-- PASSWORD STRENGTH INDICATOR -->
          <div id="pwd-strength" style="margin-bottom:10px; font-size:0.75rem; min-height:16px; font-weight: 500;"></div>

          <!-- CONFIRM PASSWORD -->
          <div class="settings-input-group">
            <label class="settings-label">
              <i class="fas fa-check-double"></i> Confirm New Password
            </label>
            <div class="settings-input-icon">
              <input type="password" id="confirm-password" class="settings-input" placeholder="Re-enter new password">
              <button class="icon-btn" onclick="togglePwd('confirm-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>

          <!-- UPDATE BUTTON -->
          <button class="settings-btn settings-btn-primary" id="update-pwd-btn" onclick="updatePasswordSecure()">
            <i class="fas fa-key"></i> UPDATE PASSWORD
          </button>
          
          <!-- PASSWORD RESET OPTION -->
          <div style="margin-top: 12px; padding: 10px; background: rgba(25, 118, 210, 0.05); border-left: 3px solid #1976d2; border-radius: 4px;">
            <strong style="color: #1976d2; display: block; margin-bottom: 4px; font-size: 12px;">
              <i class="fas fa-envelope"></i> Forgot your current password?
            </strong>
            <p style="margin: 0 0 8px 0; font-size: 11px; color: #666;">
              We'll send a password reset link to your email
            </p>
            <button class="settings-btn settings-btn-outline" style="margin-top:0;" onclick="sendPasswordReset()">
              <i class="fas fa-paper-plane"></i> SEND RESET EMAIL
            </button>
          </div>

          <!-- STATUS MESSAGE -->
          <div id="settings-message" class="settings-msg"></div>
        </div>
      </div>

      <!-- Appearance -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-palette"></i>
          <span class="settings-card-title">APPEARANCE</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">Theme</label>
            <div class="theme-options">
              <div class="theme-option" id="theme-light-btn" onclick="applyTheme('light')">
                <div class="theme-icon">‚òÄÔ∏è</div>
                Light Mode
              </div>
              <div class="theme-option" id="theme-dark-btn" onclick="applyTheme('dark')">
                <div class="theme-icon">üåô</div>
                Dark Mode
              </div>
            </div>
          </div>
          <div class="settings-divider"></div>
          <!-- Force Sync - Admin Only -->
          <div class="settings-input-group" style="margin-bottom:0;" id="force-sync-section">
            <label class="settings-label">Firebase Cloud Sync</label>
            <button class="settings-btn settings-btn-primary" onclick="saveToFirebaseMain()">
              <i class="fas fa-cloud-upload-alt"></i> FORCE SYNC TO CLOUD
            </button>
          </div>
        </div>
      </div>

      <!-- Year Data Management - Full Width - Admin Only -->
      <div class="settings-card settings-card-full" id="year-management-section">
        <div class="settings-card-header">
          <i class="fas fa-calendar-check"></i>
          <span class="settings-card-title">YEAR DATA MANAGEMENT</span>
        </div>
        <div class="settings-card-body">
          <div style="background: #e8f5e9; border-left: 4px solid #2e7d32; padding: 14px; border-radius: 6px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <i class="fas fa-info-circle" style="color: #2e7d32;"></i>
              <strong style="color: #1b5e20; font-size: 0.85rem;">Current Year: <span id="settings-current-year">2026</span></strong>
            </div>
            <p style="margin: 0; font-size: 0.75rem; color: #2e7d32;">
              Each year's data is stored separately. You can copy data from previous years to save time.
            </p>
          </div>
          
          <div class="settings-input-group">
            <label class="settings-label">Copy Data From Previous Year</label>
            <div style="display: flex; gap: 10px;">
              <select id="source-year-select" class="settings-input" style="flex: 1;">
                <option value="">Select source year...</option>
              </select>
              <button class="settings-btn settings-btn-primary" style="width: auto; padding: 11px 20px; margin: 0;" onclick="copyDataFromYear()">
                <i class="fas fa-copy"></i> Copy Data
              </button>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px;">
              <i class="fas fa-lightbulb" style="color: #fbc02d;"></i>
              This will copy projects, personnel, and incident data from the selected year to <strong id="target-year-display">2026</strong>.
            </div>
          </div>
          
          <div class="settings-input-group" style="margin-top: 20px;">
            <label class="settings-label">Export Current Year Data</label>
            <button class="settings-btn settings-btn-outline" onclick="exportYearToExcel()">
              <i class="fas fa-file-csv"></i> Export <span id="export-year-display">2026</span> to CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Backup & Recovery - Full Width -->
      <div class="settings-card settings-card-full">
        <div class="settings-card-header">
          <i class="fas fa-database"></i>
          <span class="settings-card-title">BACKUP &amp; RECOVERY</span>
        </div>
        <div class="settings-card-body">
          <div id="backup-recovery-section"></div>
        </div>
      </div>

      <!-- Audit Trail Log - Full Width - Admin Only -->
      <div class="settings-card settings-card-full" id="audit-trail-section">
        <div class="settings-card-header">
          <i class="fas fa-history"></i>
          <span class="settings-card-title">AUDIT TRAIL</span>
          <span style="font-size: 11px; color: var(--safety-yellow); background: rgba(251, 192, 45, 0.15); padding: 3px 8px; border-radius: 4px; margin-left: 10px;">
            üìù Activity Log
          </span>
        </div>
        <div class="settings-card-body">
          <p style="margin: 0 0 15px 0; font-size: 0.85rem; color: var(--text-secondary);">
            Complete log of all actions performed in the system. Changes are tracked automatically for security and compliance.
          </p>
          
          <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <button class="settings-btn settings-btn-secondary" onclick="viewAuditLog()">
              <i class="fas fa-list"></i> VIEW LOG
            </button>
            <button class="settings-btn settings-btn-secondary" onclick="exportAuditLog()">
              <i class="fas fa-download"></i> EXPORT CSV
            </button>
            <button class="settings-btn settings-btn-secondary" onclick="clearAuditLog()">
              <i class="fas fa-trash"></i> CLEAR LOG
            </button>
          </div>
          
          <div style="background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%); padding: 12px 15px; border-radius: 8px; color: white;">
            <div style="display: flex; align-items: start; gap: 10px;">
              <i class="fas fa-info-circle" style="font-size: 20px; margin-top: 2px;"></i>
              <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 6px; font-size: 13px;">What's Logged:</strong>
                <ul style="margin: 0; padding-left: 18px; font-size: 11px; line-height: 1.5;">
                  <li>Project additions, edits, and deletions</li>
                  <li>Data changes and updates</li>
                  <li>User login and logout activities</li>
                  <li>Settings modifications</li>
                  <li>File uploads and downloads</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div id="audit-log-preview" style="margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; background: var(--input-bg); display: none;">
            <!-- Audit log entries will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Danger Zone - Full Width - Admin Only -->
      <div class="settings-card settings-card-full danger-zone-card" id="danger-zone-section">
        <div class="settings-card-header">
          <i class="fas fa-triangle-exclamation"></i>
          <span class="settings-card-title">DANGER ZONE</span>
        </div>
        <div class="settings-card-body">
          <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
            <div>
              <div style="font-size:0.85rem; font-weight:700; color:var(--text-primary); margin-bottom:3px;">Sign Out of All Sessions</div>
              <div style="font-size:0.75rem; color:var(--text-secondary);">Logs you out and clears local session data.</div>
            </div>
            <button class="settings-btn settings-btn-danger" style="width:auto; padding:10px 22px;" onclick="handleLogout()">
              <i class="fas fa-right-from-bracket"></i> LOGOUT SESSION
            </button>
          </div>
          
          <!-- Footer - Copyright (Two-liner, Centered) -->
          <div style="text-align: center; padding: 30px 20px 10px; margin-top: 20px; border-top: 1px solid var(--border-color);">
            <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.8;">
              <div style="opacity: 0.9;">¬© <span id="copyright-year">2026</span> Sta. Clara International Corporation. All rights reserved.</div>
              <div style="opacity: 0.8; font-size: 0.72rem;">Environmental Safety & Health Department</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
            
    </main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>

// ===== BACKUP & RECOVERY SYSTEM =====
// ‚ö†Ô∏è SECURITY: Backups are STRICTLY per-account.
// Each account uses its own isolated localStorage key: esh_backups_<email>
// No account can ever see, restore, or delete another account's backups.
let backupManager = {
    backups: [],
    autoSaveInterval: null,
    maxBackups: 10,
    autoSaveFrequency: 300000, // 5 minutes in milliseconds

    // Returns the storage key for the CURRENT logged-in user only
    _storageKey() {
        if (!state.currentUser?.email) return null;
        // Sanitize email for use as key suffix
        return 'esh_backups_' + state.currentUser.email.replace(/[^a-zA-Z0-9@._-]/g, '_');
    },

    init() {
        this.loadBackupsFromStorage();
        this.startAutoSave();
        console.log('‚úÖ Backup Manager Initialized');
    },

    loadBackupsFromStorage() {
        const key = this._storageKey();
        if (!key) { this.backups = []; return; }
        try {
            const saved = localStorage.getItem(key);
            // Extra safety: only load backups that belong to the current user
            const parsed = saved ? JSON.parse(saved) : [];
            this.backups = parsed.filter(b => b.email === state.currentUser?.email);
        } catch(e) {
            this.backups = [];
        }
    },

    saveBackupsToStorage() {
        const key = this._storageKey();
        if (!key) return;
        // Extra safety: only ever save backups owned by the current user
        const ownBackups = this.backups.filter(b => b.email === state.currentUser?.email);
        localStorage.setItem(key, JSON.stringify(ownBackups));
    },

    createBackup(manual = false) {
        if (!state.currentUser) return false;

        // Reload from storage first so we have the latest list for this user
        this.loadBackupsFromStorage();

        const backup = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            email: state.currentUser.email,  // Always tag with owner
            projects: JSON.parse(JSON.stringify(state.projects)),
            manual: manual,
            size: JSON.stringify(state.projects).length
        };

        this.backups.unshift(backup);

        // Keep only latest 10 backups PER account
        if (this.backups.length > this.maxBackups) {
            this.backups = this.backups.slice(0, this.maxBackups);
        }

        this.saveBackupsToStorage();
        return backup;
    },

    startAutoSave() {
        this.autoSaveInterval = setInterval(() => {
            if (state.isLoggedIn && state.currentUser) {
                this.loadBackupsFromStorage(); // Always reload for current user first
                this.createBackup(false);
                console.log('‚úÖ Auto-backup created for', state.currentUser.email);
            }
        }, this.autoSaveFrequency);
    },

    stopAutoSave() {
        if (this.autoSaveInterval) {
            clearInterval(this.autoSaveInterval);
        }
    },

    getBackupsForUser(email) {
        // Only return backups for the CURRENT logged-in user ‚Äî never for anyone else
        if (!state.currentUser || state.currentUser.email !== email) return [];
        this.loadBackupsFromStorage();
        return this.backups.filter(b => b.email === email);
    },

    restoreBackup(backupId) {
        if (!state.currentUser) return false;
        this.loadBackupsFromStorage();

        // OWNERSHIP CHECK: only restore a backup that belongs to the current user
        const backup = this.backups.find(b => b.id === backupId && b.email === state.currentUser.email);
        if (!backup) {
            console.error('Backup not found or does not belong to current user');
            return false;
        }

        state.projects = JSON.parse(JSON.stringify(backup.projects));
        state.filteredProjects = [...state.projects];
        saveUserData(state.currentUser.email);
        render();
        return true;
    },

    deleteBackup(backupId) {
        if (!state.currentUser) return false;
        this.loadBackupsFromStorage();

        // OWNERSHIP CHECK: only delete a backup that belongs to the current user
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup || backup.email !== state.currentUser.email) {
            console.error('Cannot delete: backup not found or belongs to another account');
            return false;
        }

        this.backups = this.backups.filter(b => b.id !== backupId);
        this.saveBackupsToStorage();
        return true;
    },

    exportBackup(backupId) {
        if (!state.currentUser) return false;
        this.loadBackupsFromStorage();

        // OWNERSHIP CHECK
        const backup = this.backups.find(b => b.id === backupId && b.email === state.currentUser.email);
        if (!backup) return false;

        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `esh_backup_${backup.timestamp.split('T')[0]}_${state.currentUser.email.split('@')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        return true;
    },

    importBackup(file) {
        if (!state.currentUser) return Promise.resolve(false);
        const currentEmail = state.currentUser.email;

        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.projects && Array.isArray(backup.projects)) {
                        // OWNERSHIP CHECK: if the backup file has an email tag, it must match current user
                        if (backup.email && backup.email !== currentEmail) {
                            console.error('Import rejected: backup belongs to a different account:', backup.email);
                            resolve('wrong_account');
                            return;
                        }
                        state.projects = backup.projects;
                        state.filteredProjects = [...state.projects];
                        saveUserData(currentEmail);
                        this.createBackup(true); // Create a restore-point backup
                        render();
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                } catch (error) {
                    console.error('Error importing backup:', error);
                    resolve(false);
                }
            };
            reader.readAsText(file);
        });
    },

    formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('en-PH', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
};

function showBackupRecoveryUI() {
    // Always reload from the current user's isolated storage key before rendering
    backupManager.loadBackupsFromStorage();
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    const lastBackup = userBackups[0];
    const lastBackupTime = lastBackup ? backupManager.formatDate(lastBackup.timestamp) : 'Never';
    
    // Show only 3 backups initially
    const showAllBackups = window.showAllBackupsFlag === true;
    const displayBackups = showAllBackups ? userBackups : userBackups.slice(0, 3);
    const hasMore = userBackups.length > 3;

    let html = `
        <div class="backup-section">
            <h4><i class="fas fa-shield-alt"></i> Backup & Recovery</h4>
            
            <div class="backup-info">
                <strong>Last Auto-Backup:</strong> ${lastBackupTime}<br>
                <strong>Total Backups:</strong> ${userBackups.length} / ${backupManager.maxBackups}<br>
                <strong>Auto-save Frequency:</strong> Every 5 minutes
            </div>

            <div class="backup-buttons">
                <button class="btn btn-primary" onclick="createManualBackup()">
                    <i class="fas fa-download"></i> Create Manual Backup
                </button>
                <button class="btn btn-primary" onclick="exportCurrentBackup()">
                    <i class="fas fa-file-export"></i> Export Backup
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('import-backup-input').click()">
                    <i class="fas fa-file-import"></i> Import Backup
                </button>
            </div>

            <input type="file" id="import-backup-input" accept=".json" style="display:none;" onchange="importBackupFile(this)">

            <div id="backup-status-message"></div>

            <div class="backup-list">
                <h5 style="color: #1b5e20; margin-top: 20px; margin-bottom: 10px;">
                    <i class="fas fa-history"></i> Backup History
                </h5>
                ${userBackups.length > 0 ? displayBackups.map(backup => `
                    <div class="backup-item">
                        <div class="backup-item-info">
                            <div class="backup-item-date">
                                ${backup.manual ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'} 
                                ${backupManager.formatDate(backup.timestamp)}
                            </div>
                            <div class="backup-item-size">
                                ${backupManager.formatSize(backup.size)} ‚Ä¢ 
                                ${backup.projects.length} projects
                            </div>
                        </div>
                        <div class="backup-item-actions">
                            <button class="backup-item-btn backup-item-btn-restore" onclick="restoreBackupConfirm(${backup.id})">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button class="backup-item-btn backup-item-btn-delete" onclick="deleteBackupConfirm(${backup.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('') : '<p style="color: var(--text-secondary); font-size: 0.85rem;">No backups available</p>'}
                
                ${hasMore && !showAllBackups ? `
                    <button class="btn btn-outline" onclick="toggleShowAllBackups()" style="width: 100%; margin-top: 15px; padding: 10px;">
                        <i class="fas fa-chevron-down"></i> See More (${userBackups.length - 3} more backups)
                    </button>
                ` : ''}
                
                ${showAllBackups && hasMore ? `
                    <button class="btn btn-outline" onclick="toggleShowAllBackups()" style="width: 100%; margin-top: 15px; padding: 10px;">
                        <i class="fas fa-chevron-up"></i> Show Less
                    </button>
                ` : ''}
            </div>
        </div>
    `;

    return html;
}

// Toggle show all backups
function toggleShowAllBackups() {
    window.showAllBackupsFlag = !window.showAllBackupsFlag;
    const backupSection = document.getElementById('backup-recovery-section');
    if (backupSection) backupSection.innerHTML = showBackupRecoveryUI();
}

function createManualBackup() {
    const backup = backupManager.createBackup(true);
    if (backup) {
        showBackupStatus('‚úÖ Backup created successfully!', 'success');
        setTimeout(() => {
            changeTab('settings');
        }, 500);
    }
}

function exportCurrentBackup() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    if (userBackups.length === 0) {
        showBackupStatus('‚ö†Ô∏è No backups to export', 'error');
        return;
    }
    backupManager.exportBackup(userBackups[0].id);
    showBackupStatus('‚úÖ Backup exported successfully!', 'success');
}

function importBackupFile(input) {
    const file = input.files[0];
    if (!file) return;

    backupManager.importBackup(file).then(result => {
        if (result === true) {
            showBackupStatus('‚úÖ Backup imported and restored successfully!', 'success');
            setTimeout(() => { changeTab('settings'); }, 500);
        } else if (result === 'wrong_account') {
            showBackupStatus('‚ùå Hindi pwede: Ang backup file na ito ay galing sa ibang account. Pwede ka lang mag-import ng sarili mong backup.', 'error');
        } else {
            showBackupStatus('‚ùå Invalid backup file format', 'error');
        }
    });

    input.value = '';
}

function restoreBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Restore Backup',
        `Restore data from ${backupManager.formatDate(backup.timestamp)}? Your current data will be replaced.`,
        false
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.restoreBackup(backupId)) {
                showBackupStatus('‚úÖ Backup restored successfully!', 'success');
                setTimeout(() => {
                    changeTab('overall');
                }, 500);
            } else {
                showBackupStatus('‚ùå Failed to restore backup', 'error');
            }
        }
    });
}

function deleteBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Delete Backup',
        `Delete backup from ${backupManager.formatDate(backup.timestamp)}? This cannot be undone.`,
        true
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.deleteBackup(backupId)) {
                showBackupStatus('‚úÖ Backup deleted successfully!', 'success');
                setTimeout(() => {
                    changeTab('settings');
                }, 500);
            } else {
                showBackupStatus('‚ùå Failed to delete backup', 'error');
            }
        }
    });
}

function showBackupStatus(message, type) {
    const statusDiv = document.getElementById('backup-status-message');
    if (!statusDiv) return;

    statusDiv.innerHTML = `<div class="backup-status ${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 4000);
}

// ==================== AUDIT LOG FUNCTIONS ====================
function viewAuditLog() {
    const preview = document.getElementById('audit-log-preview');
    if (!preview) return;
    
    if (preview.style.display === 'none') {
        const recentLogs = AuditLogger.getRecent(50);
        
        if (recentLogs.length === 0) {
            preview.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No audit logs yet</p>';
        } else {
            preview.innerHTML = recentLogs.map(log => {
                // Format details in a readable way
                let detailsHTML = '';
                if (Object.keys(log.details).length > 0) {
                    const details = log.details;
                    let detailItems = [];
                    
                    // Format each detail field nicely
                    if (details.projectName) detailItems.push(`Project: ${details.projectName}`);
                    if (details.email) detailItems.push(`Email: ${details.email}`);
                    if (details.status) detailItems.push(`Status: ${details.status}`);
                    if (details.year) detailItems.push(`Year: ${details.year}`);
                    if (details.tab) detailItems.push(`Tab: ${details.tab}`);
                    if (details.step !== undefined) detailItems.push(`Step: ${details.step}`);
                    if (details.totalSteps !== undefined) detailItems.push(`Total Steps: ${details.totalSteps}`);
                    if (details.remainingProjects !== undefined) detailItems.push(`Remaining: ${details.remainingProjects}`);
                    if (details.exportDate) detailItems.push(`Export Date: ${new Date(details.exportDate).toLocaleString()}`);
                    if (details.timestamp) detailItems.push(`Time: ${new Date(details.timestamp).toLocaleString()}`);
                    
                    if (detailItems.length > 0) {
                        detailsHTML = `
                            <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 5px; padding: 5px 10px; background: rgba(0,0,0,0.03); border-radius: 4px;">
                                ${detailItems.join(' ‚Ä¢ ')}
                            </div>
                        `;
                    }
                }
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <strong style="color: var(--text-primary); font-size: 0.85rem;">${formatActionName(log.action)}</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem; white-space: nowrap; margin-left: 10px;">
                                ${new Date(log.timestamp).toLocaleString()}
                            </span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.75rem;">
                            üë§ ${log.userName} | üìÖ Year ${log.year}
                        </div>
                        ${detailsHTML}
                    </div>
                `;
            }).join('');
        }
        
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Helper function to format action names nicely
function formatActionName(action) {
    const actionNames = {
        'USER_LOGIN': 'üîê User Login',
        'USER_LOGOUT': 'üö™ User Logout',
        'USER_ONLINE': 'üåê User Connected',
        'PROJECT_CREATED': '‚ûï Project Created',
        'PROJECT_EDITED': '‚úèÔ∏è Project Edited',
        'PROJECT_DELETED': 'üóëÔ∏è Project Deleted',
        'DATA_SAVED': 'üíæ Data Saved',
        'TUTORIAL_STARTED': 'üéì Tutorial Started',
        'TUTORIAL_COMPLETED': '‚úÖ Tutorial Completed',
        'TUTORIAL_SKIPPED': '‚è≠Ô∏è Tutorial Skipped',
        'HELP_VIEWED': '‚ùì Help Viewed',
        'SYSTEM_ONLINE': 'üåê System Online',
        'SYSTEM_OFFLINE': 'üìµ System Offline',
        'AUDIT_LOG_EXPORTED': 'üì• Audit Log Exported',
        'PASSWORD_CHANGED': 'üîë Password Changed',
        'SETTINGS_UPDATED': '‚öôÔ∏è Settings Updated'
    };
    
    return actionNames[action] || action.replace(/_/g, ' ');
}

function exportAuditLog() {
    const csv = AuditLogger.exportToCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showToast('üì• Audit log exported successfully!', 'success');
    AuditLogger.log('AUDIT_LOG_EXPORTED', { exportDate: new Date().toISOString() });
}

async function clearAuditLog() {
    const confirmed = await showModernDialog(
        'üóëÔ∏è Clear Audit Log',
        'Are you sure you want to clear the audit log? This action cannot be undone.',
        true
    );
    
    if (confirmed) {
        state.auditLog = [];
        localStorage.removeItem('esh_audit_log');
        
        const preview = document.getElementById('audit-log-preview');
        if (preview) {
            preview.style.display = 'none';
        }
        
        showToast('‚úÖ Audit log cleared', 'success');
    }
}

// ==================== MISSING FUNCTION FIXES ====================

// Fix 1: saveToFirebaseMain ‚Äî called from settings menu & sync button
// Was missing entirely ‚Äî caused "saveToFirebaseMain is not defined" console error
async function saveToFirebaseMain() {
    showToast('‚òÅÔ∏è Syncing to cloud...', 'info', 2000);
    const success = await saveToFirebase();
    if (success) {
        showToast('‚úÖ Synced to Firebase successfully!', 'success', 3000);
    } else {
        showToast('‚ùå Sync failed. Check your connection.', 'error', 4000);
    }
}
window.saveToFirebaseMain = saveToFirebaseMain;

// Fix 2: pGlobalEdit & pGlobalSave ‚Äî called from Personnel "Edit All" / "Save All" buttons
function pGlobalEdit() {
    const container = document.getElementById('p-cards-container');
    if (!container) return;
    const rows = container.querySelectorAll('tr[id^="p-row-"]');
    let anyEditable = false;
    rows.forEach(row => {
        const editBtn = row.querySelector('.p-edit-btn');
        if (editBtn) {
            const match = editBtn.id.match(/p-edit-btn-(\d+)/);
            if (match) { openEditPersonnelModal(parseInt(match[1])); anyEditable = true; }
        }
    });
    const editBtn = document.getElementById('p-global-edit-btn');
    const saveBtn = document.getElementById('p-global-save-btn');
    if (editBtn) editBtn.style.display = 'none';
    if (saveBtn) saveBtn.style.display = '';
    if (!anyEditable) showToast('‚ÑπÔ∏è No personnel rows to edit.', 'info');
}
window.pGlobalEdit = pGlobalEdit;

function pGlobalSave() {
    const rows = document.querySelectorAll('.p-project-card tr.p-editing');
    rows.forEach(row => {
        const saveBtn = row.querySelector('.p-save-btn');
        if (saveBtn) {
            const match = saveBtn.id.match(/p-save-btn-(\d+)/);
            if (match) savePersonnel(parseInt(match[1]));
        }
    });
    // Toggle button visibility
    const editBtn = document.getElementById('p-global-edit-btn');
    const saveBtn = document.getElementById('p-global-save-btn');
    if (editBtn) editBtn.style.display = '';
    if (saveBtn) saveBtn.style.display = 'none';
    showToast('‚úÖ All personnel changes saved.', 'success');
}
window.pGlobalSave = pGlobalSave;

// ==================== END MISSING FUNCTION FIXES ====================

// ==================== RBAC ROLES DEPLOYER ====================
const RBAC_ACCOUNTS = [
    { uid: 'fUnXsvKnRYMpuySRbeVYJk7TO452', email: 'esh@scic.com.ph',      role: 'admin',          displayName: 'ESH Admin',                      region: 'ALL',                 module_access: [] },
    { uid: 'hcnqoDM72cQhesbmJpM9SMMGsQb2', email: 'esh@ncr.com.ph',       role: 'superintendent', displayName: 'NCR Superintendent',             region: 'NCR',                 module_access: [] },
    { uid: 'ZkaQ1QiZQSPKfO1VbFk5uW5eldI2', email: 'esh@north.com.ph',     role: 'superintendent', displayName: 'North Luzon Superintendent',     region: 'NORTH LUZON',         module_access: [] },
    { uid: 'TNR2IlOdLreZNM4AXn7ejTPVXLZ2', email: 'esh@south.com.ph',     role: 'superintendent', displayName: 'South Luzon Superintendent',     region: 'SOUTH LUZON',         module_access: [] },
    { uid: 'RsOVQnzUh5bDcZCYRrE0I6P2ZCF2', email: 'esh@vismin.com.ph',   role: 'superintendent', displayName: 'Visayas & Mindanao Superintendent', region: 'VISAYAS & MINDANAO', module_access: [] },
    { uid: 'XZjjCJnanac8B9r6pVUJBdEbvk93', email: 'esh@ncrpco.com.ph',   role: 'pco',            displayName: 'NCR PCO',                        region: 'NCR',                 module_access: ['permits','emb','env-monitoring','env-monthly-report','esh-calendar-env'] },
    { uid: 'vAx6TARdxtfIQsNpNwWLO2YWh622', email: 'esh@northpco.com.ph', role: 'pco',            displayName: 'North Luzon PCO',               region: 'NORTH LUZON',         module_access: ['permits','emb','env-monitoring','env-monthly-report','esh-calendar-env'] },
    { uid: 'm6opwibuujUCci63nUNb6R6Vwse2', email: 'esh@southpco.com.ph', role: 'pco',            displayName: 'South Luzon PCO',               region: 'SOUTH LUZON',         module_access: ['permits','emb','env-monitoring','env-monthly-report','esh-calendar-env'] },
    { uid: 'TH12T1L0G2UYrP5iSwuWL7aLHp93', email: 'esh@visminpco.com.ph',role: 'pco',           displayName: 'Visayas & Mindanao PCO',         region: 'VISAYAS & MINDANAO',  module_access: ['permits','emb','env-monitoring','env-monthly-report','esh-calendar-env'] },
];

async function rbacDeployAll() {
    if (!state.isAdmin) {
        showToast('‚õî Admin access required to deploy roles.', 'error');
        return;
    }
    if (!window.firebaseDb) {
        showToast('‚ùå Firebase not ready. Try again in a moment.', 'error');
        return;
    }

    const btn = document.getElementById('rbac-deploy-btn');
    const logEl = document.getElementById('rbac-log');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deploying‚Ä¶';
    logEl.innerHTML = '';

    function rbacLog(msg, type) {
        const colors = { success: '#2e7d32', error: '#c62828', info: '#888' };
        const div = document.createElement('div');
        div.style.cssText = `color:${colors[type]||'#888'};margin:2px 0;`;
        div.textContent = msg;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(uid, html) {
        const el = document.getElementById('rbac-st-' + uid);
        if (el) el.innerHTML = html;
    }

    let ok = 0, fail = 0;
    rbacLog('// Starting deployment of ' + RBAC_ACCOUNTS.length + ' role documents‚Ä¶', 'info');

    for (const acct of RBAC_ACCOUNTS) {
        setStatus(acct.uid, '<i class="fas fa-spinner fa-spin rbac-spin"></i>');
        try {
            const docRef = window.firebase.doc(window.firebaseDb, 'roles', acct.uid);
            await window.firebase.setDoc(docRef, {
                role:          acct.role,
                displayName:   acct.displayName,
                region:        acct.region,
                module_access: acct.module_access,
                email:         acct.email,
                deployedBy:    state.currentUser?.email || 'admin',
                deployedAt:    new Date().toISOString()
            });
            setStatus(acct.uid, '<span class="rbac-ok"><i class="fas fa-circle-check"></i> OK</span>');
            rbacLog(`‚úì ${acct.email} ‚Üí ${acct.role.toUpperCase()} [${acct.region}]`, 'success');
            ok++;
        } catch (err) {
            setStatus(acct.uid, '<span class="rbac-err"><i class="fas fa-circle-xmark"></i> FAIL</span>');
            rbacLog(`‚úó ${acct.email} ‚Äî ${err.message}`, 'error');
            fail++;
        }
        // Small delay to avoid rate limiting
        await new Promise(r => setTimeout(r, 250));
    }

    rbacLog(`// Done ‚Äî ${ok} deployed, ${fail} failed.`, 'info');

    if (fail === 0) {
        btn.innerHTML = '<i class="fas fa-check-circle"></i> All Roles Deployed!';
        btn.style.background = '#43a047';
        btn.style.color = 'white';
        const statusEl = document.getElementById('rbac-deploy-status');
        if (statusEl) statusEl.style.display = 'flex';
        showToast(`‚úÖ All ${ok} role documents deployed to Firestore!`, 'success', 5000);

        // Audit log
        AuditLogger.log('RBAC_ROLES_DEPLOYED', { deployedCount: ok, by: state.currentUser?.email });
    } else {
        btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${ok} OK, ${fail} Failed`;
        btn.style.background = '#f57f17';
        btn.style.color = '#1b5e20';
        showToast(`‚ö†Ô∏è ${fail} role(s) failed to deploy. Check the log.`, 'warning', 5000);
    }

    btn.disabled = false;
}
window.rbacDeployAll = rbacDeployAll;
// ==================== END RBAC ROLES DEPLOYER ====================

// ==================== ADMIN PANEL FUNCTIONS ====================
function renderAdminPanel() {
    if (!state.isAdmin) {
        showToast('‚õî Access Denied: Admin privileges required', 'error');
        changeTab('overall');
        return;
    }
    
    // Update admin email
    document.getElementById('admin-user-email').textContent = state.currentUser.email;
    
    // Render immediately from localStorage (no spinner)
    updateAdminStats();
    renderLogbook();
    renderUserManagement();
    updateSessionTime();
    
    // Then silently refresh from Firebase in the background
    loadLogbookFromFirebase().then(() => {
        updateAdminStats();
        renderLogbook();
        renderUserManagement();
    }).catch(e => console.warn('Background logbook refresh failed:', e));
}

function updateAdminStats() {
    // Total unique devices (based on IP + User Agent combination)
    const devices = new Set(
        state.loginLogbook.map(entry => `${entry.ip}_${entry.userAgent}`)
    );
    document.getElementById('admin-total-users').textContent = devices.size;
    // Update label
    const label = document.querySelector('#admin-total-users').parentElement.parentElement.querySelector('.stat-secondary');
    if (label) label.textContent = 'Unique Devices';
    
    // Active sessions in last 24 hours
    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
    const logins24h = state.loginLogbook.filter(entry => 
        entry.action === 'LOGIN' && new Date(entry.timestamp).getTime() > oneDayAgo
    ).length;
    document.getElementById('admin-logins-24h').textContent = logins24h;
    
    // Unique IPs in last 7 days
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    const uniqueIps = new Set(
        state.loginLogbook
            .filter(entry => new Date(entry.timestamp).getTime() > sevenDaysAgo)
            .map(entry => entry.ip)
    );
    document.getElementById('admin-unique-ips').textContent = uniqueIps.size;
    
    // Total audit logs
    document.getElementById('admin-total-audits').textContent = state.auditLog.length;
}

function updateSessionTime() {
    // Store session start in localStorage so it persists on refresh
    if (!localStorage.getItem('esh_session_start')) {
        localStorage.setItem('esh_session_start', Date.now().toString());
    }
    
    setInterval(() => {
        const sessionStart = parseInt(localStorage.getItem('esh_session_start'));
        const now = Date.now();
        const diff = now - sessionStart;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        const el = document.getElementById('admin-session-time');
        if (el) {
            el.textContent = hours > 0
                ? `${hours}h ${minutes}m ${seconds}s`
                : `${minutes}m ${seconds}s`;
        }
    }, 1000);
}

function renderLogbook() {
    const container = document.getElementById('logbook-container');
    const logs = state.loginLogbook.filter(entry => {
        if (!entry.email) return false;
        const _ua = window.UserAccounts ? window.UserAccounts.getUserInfo(entry.email) : {role:'admin'};
        return _ua.role === 'superintendent' || _ua.role === 'pco';
    });
    
    if (logs.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                <p style="font-size: 1.1rem; font-weight: 600;">No login records yet</p>
                <p style="font-size: 0.9rem;">Login history will appear here</p>
            </div>
        `;
        return;
    }
    
    // Show max 10 entries only
    const displayLogs = logs.slice(0, 10);
    
    container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 0.78rem; table-layout: fixed;">
            <thead>
                <tr style="background: var(--bg-body);">
                    <th style="width:12%; padding: 9px 14px; text-align: left;   font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Timestamp</th>
                    <th style="width:8%;  padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Action</th>
                    <th style="width:17%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">User</th>
                    <th style="width:21%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">IP Address</th>
                    <th style="width:16%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Location</th>
                    <th style="width:14%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Device</th>
                    <th style="width:12%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Browser</th>
                </tr>
            </thead>
            <tbody id="logbook-tbody">
                ${displayLogs.map((entry, index) => `
                    <tr style="border-bottom: 1px solid var(--border-color); background: ${index % 2 === 0 ? 'var(--bg-card)' : 'var(--bg-body)'};">
                        <td style="padding: 9px 14px; white-space: nowrap; text-align: left; overflow: hidden;">
                            <div style="font-weight: 600; font-size: 0.75rem; color: var(--text-primary);">${new Date(entry.timestamp).toLocaleDateString()}</div>
                            <div style="font-size: 0.68rem; color: var(--text-secondary);">${new Date(entry.timestamp).toLocaleTimeString()}</div>
                        </td>
                        <td style="padding: 9px 14px; text-align: center; overflow: hidden;">
                            <span style="padding: 2px 8px; border-radius: 3px; font-weight: 600; font-size: 0.65rem; letter-spacing: 0.04em; ${entry.action === 'LOGIN' ? 'background: #e8f5e9; color: #2e7d32;' : 'background: #fce4ec; color: #c62828;'}">
                                ${entry.action === 'LOGIN' ? 'LOGIN' : 'LOGOUT'}
                            </span>
                        </td>
                        <td style="padding: 9px 14px; text-align: center; overflow: hidden;">
                            <div style="font-weight: 600; font-size: 0.75rem; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.displayName || 'Unknown'}</div>
                            <div style="font-size: 0.68rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.email}</div>
                        </td>
                        <td style="padding: 9px 14px; text-align: center; overflow: hidden;">
                            <span style="font-family: monospace; font-size: 0.68rem; color: var(--text-secondary); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${entry.ip || 'Unknown'}">${entry.ip || 'Unknown'}</span>
                        </td>
                        <td style="padding: 9px 14px; text-align: center;">
                            <div style="display: inline-flex; align-items: center; gap: 5px;">
                                <span>${getCountryFlag(entry.country)}</span>
                                <div style="text-align: left;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">${entry.city || 'Unknown'}</div>
                                    <div style="font-size: 0.68rem; color: var(--text-secondary);">${entry.country || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 9px 14px; text-align: center; font-size: 0.73rem; color: var(--text-secondary);">${entry.device || '-'} ¬∑ ${entry.os || '-'}</td>
                        <td style="padding: 9px 14px; text-align: center; font-size: 0.73rem; color: var(--text-secondary);">${entry.browser || '-'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        ${logs.length > 10 ? `
            <div style="padding: 10px 14px; text-align: center; background: var(--bg-body); border-top: 1px solid var(--border-color);">
                <span style="font-size:0.72rem;color:var(--text-secondary);"><i class="fas fa-info-circle"></i> Showing latest 10 entries. <a href="#" onclick="exportLogbook(); return false;" style="color: #2e7d32; text-decoration: none; font-weight: 600;">Export All ‚Üí</a></span>
            </div>
        ` : ''}
    `;
}

function toggleLogbookExpand() {
    const container = document.getElementById('logbook-container');
    container.dataset.expanded = container.dataset.expanded === 'true' ? 'false' : 'true';
    renderLogbook();
}

function getCountryFlag(country) {
    const flags = {
        'Philippines': 'üáµüá≠',
        'United States': 'üá∫üá∏',
        'Japan': 'üáØüáµ',
        'Singapore': 'üá∏üá¨',
        'China': 'üá®üá≥',
        'South Korea': 'üá∞üá∑',
        'Australia': 'üá¶üá∫',
        'United Kingdom': 'üá¨üáß',
        'Canada': 'üá®üá¶',
        'Germany': 'üá©üá™'
    };
    return flags[country] || 'üåê';
}

async function renderUserManagement() {
    const container = document.getElementById('user-management-container');
    const users = await AdminSystem.getAllUsers();
    
    if (users.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                <p>No users found</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="adm-users-wrap">
            ${users.map(user => `
                <div class="adm-user-card">
                    <div class="adm-user-avatar">${(user.displayName || user.email).charAt(0).toUpperCase()}</div>
                    <div class="adm-user-info">
                        <div class="adm-user-name">${user.displayName}</div>
                        <div class="adm-user-email">${user.email}</div>
                        <div class="adm-user-meta">
                            <span class="adm-meta-tag">${user.loginCount} logins</span>
                            <span class="adm-meta-tag">${new Date(user.lastLogin).toLocaleDateString()}</span>
                        </div>
                    </div>
                    ${AdminSystem.isAdmin(user.email)
                        ? `<span class="adm-admin-tag">ADMIN</span>`
                        : UserAccounts.isPCO(user.email)
                            ? `<span class="adm-admin-tag" style="background:#00ACC1;">PCO</span>`
                            : `<button class="adm-revoke-btn" onclick="revokeUserAccess('${user.email}')"><i class="fas fa-ban"></i> Revoke</button>`
                    }
                </div>
            `).join('')}
        </div>
    `;
}

async function refreshLogbook() {
    showToast('üîÑ Refreshing logbook from Firebase...', 'info');
    await loadLogbookFromFirebase();
    updateAdminStats();
    renderLogbook();
    renderUserManagement();
    showToast('‚úÖ Logbook refreshed', 'success');
}

async function loadLogbookFromFirebase() {
    try {
        const logbookRef = window.firebase.dbRef(window.firebaseRealtimeDb, 'login-logbook');
        await Promise.race([
            new Promise((resolve) => {
                window.firebase.onValue(logbookRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const entries = Object.values(data);
                        entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        state.loginLogbook = entries;
                        LoginLogbook.saveToStorage();
                        // Live-update admin panel if open
                        if (state.isAdmin) {
                            updateAdminStats();
                            renderLogbook();
                            renderUserManagement();
                        }
                    }
                    resolve();
                }); // removed onlyOnce ‚Äî now real-time!
            }),
            new Promise((resolve) => setTimeout(resolve, 10000)) // 10s timeout
        ]);
    } catch (e) {
        console.warn('‚ö†Ô∏è Could not load logbook from Firebase:', e.message);
    }
}

function exportLogbook() {
    const csv = LoginLogbook.exportToCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `login_logbook_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showToast('üì• Logbook exported successfully!', 'success');
    AuditLogger.log('LOGBOOK_EXPORTED', { admin: state.currentUser.email });
}

async function clearLogbook() {
    const confirmed = await showModernDialog(
        'üóëÔ∏è Clear Login Logbook',
        'Are you sure you want to clear the entire login logbook? This action cannot be undone.',
        true
    );
    
    if (confirmed) {
        // Clear local state and localStorage first
        state.loginLogbook = [];
        localStorage.removeItem('esh_login_logbook');
        renderLogbook();
        updateAdminStats();

        // Also delete from Firebase Realtime Database so it stays cleared on refresh
        try {
            if (window.firebaseRealtimeDb && window.firebase && window.firebase.remove) {
                const logbookRef = window.firebase.dbRef(window.firebaseRealtimeDb, 'login-logbook');
                await window.firebase.remove(logbookRef);
                console.log('‚úÖ Logbook cleared from Firebase Realtime Database');
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è Could not clear Firebase logbook:', e.message);
        }

        showToast('‚úÖ Logbook cleared', 'success');
        AuditLogger.log('LOGBOOK_CLEARED', { admin: state.currentUser.email });
    }
}

function filterLogbook() {
    const searchTerm = document.getElementById('logbook-search').value.toLowerCase();
    const actionFilter = document.getElementById('logbook-action-filter').value;
    
    let filtered = state.loginLogbook;
    
    if (searchTerm) {
        filtered = filtered.filter(entry => 
            entry.email.toLowerCase().includes(searchTerm) ||
            entry.ip.toLowerCase().includes(searchTerm) ||
            (entry.city && entry.city.toLowerCase().includes(searchTerm)) ||
            (entry.country && entry.country.toLowerCase().includes(searchTerm))
        );
    }
    
    if (actionFilter) {
        filtered = filtered.filter(entry => entry.action === actionFilter);
    }
    
    // Re-render with filtered data
    const originalLogbook = state.loginLogbook;
    state.loginLogbook = filtered;
    renderLogbook();
    state.loginLogbook = originalLogbook;
}

function viewUserActivity(email) {
    const userLogs = LoginLogbook.filterByUser(email);
    
    // Create a modal or detailed view
    showToast(`üìä ${userLogs.length} activities found for ${email}`, 'info');
    
    // You can create a custom modal here to show detailed activity
    console.log('User activity:', userLogs);
}

async function revokeUserAccess(email) {
    const confirmed = await showModernDialog(
        'üö´ Revoke Access',
        `Are you sure you want to revoke access for <strong>${email}</strong>?<br><br>This will prevent the user from logging in.`,
        true
    );
    
    if (confirmed) {
        await AdminSystem.revokeAccess(email);
        renderUserManagement();
    }
}



        const REGIONS = ["CORPORATE", "NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       const SCHEMA = {
    'exposures': ["Total Manpower", "Total Exposed Manhour", "Total Exposed Man-hour to date", "No. of Days w/o LTA"],
    'rates': ["LTIR","TRIR","SEVERITY RATE"],
    'medical': ["Medical Treatment","First Aid","LTA","Fatality","High-Potential incident", "Dangerous Occurrences"],
    'nov': ["OSH Internal Issues", "OSH External Issues", "Environmental Internal Issues", "Environmental External Issues"],
    'activities': ["No. of ESH Committee Conducted", "No. of ESH inspection", "No. of Identified Near-Miss","Drills Conducted", "Training Conducted"],
    'kpm': ["KPM&I"],
    'audit': ["Score Implementation", "Documentation and Compliance"],
    'dole': ["WAIR","RSO", "MOM", "AEDR", "AMR"],
    'dole_annual': ["AEDR", "AMR"],
    'permits': ["ECC", "CNC", "Certificate of Accreditation (DENR-EMB)", "Certificate of Accreditation (LLDA)", "Company Registration System", "LLDA Clearance", "Permit to Operate", "Discharge Permit", "Hazardous Waste Generator's ID", "Permit to Transport (Haz Waste)", "Permit to Transport (Logs)", "Tree Cutting Permit (STCP or S/PLTP)", "Permit to Cut Coconut Tree", "NWRB Water Permit"],
    'emb': ["SMR (Quarterly) - Submission Date", "SMR (Quarterly) - Reference No.", "CMR (Semi-Annual) - Submission Date", "CMR (Semi-Annual) - Reference No."],
    'cshp': ["CSHP Approval Date"],
    'reg': ["DOLE Certificate of Registration Date"],
    'doe': ["DOE Quarterly Report Submission Date"],
    'doe-permit': ["DOE Safety Officer Permit"],
    'env-monthly-report': ["EMR"]
};

// ‚îÄ‚îÄ Number formatting helper ‚îÄ‚îÄ
function fmtNum(val) {
    if (val === '' || val === null || val === undefined) return '';
    var n = parseFloat(val);
    if (isNaN(n)) return '';
    if (Number.isInteger(n)) return n.toLocaleString('en-US');
    return parseFloat(n.toFixed(4)).toLocaleString('en-US');
}

// ‚îÄ‚îÄ Comma-formatted input handler ‚îÄ‚îÄ
// Called by oninput on data-num inputs. Formats display with commas, saves raw number.
// Rules: numbers only, no letters, no negative (min = 0)
function numFmtInput(el, saveFn) {
    var cursorPos = el.selectionStart;
    var raw = el.value.replace(/,/g, '');

    // Strip any non-numeric characters except a single dot
    var cleaned = raw.replace(/[^0-9.]/g, '');
    // Keep only first dot
    var dotIdx = cleaned.indexOf('.');
    if (dotIdx !== -1) {
        cleaned = cleaned.slice(0, dotIdx + 1) + cleaned.slice(dotIdx + 1).replace(/\./g, '');
    }

    // If user tried to type something invalid, reset to cleaned
    if (cleaned !== raw) {
        el.value = cleaned;
    }

    // Empty input = clear
    if (cleaned === '' || cleaned === '.') {
        saveFn('');
        return;
    }

    var n = parseFloat(cleaned);
    if (isNaN(n)) { saveFn(''); return; }

    // Enforce minimum of 0 (no negatives)
    if (n < 0) {
        cleaned = '0';
        n = 0;
    }

    // Reformat with commas, preserve trailing dot or decimals while typing
    var parts = cleaned.split('.');
    var intPart = parseInt(parts[0] || '0', 10).toLocaleString('en-US');
    var formatted = parts.length > 1 ? intPart + '.' + parts[1] : intPart;

    // Adjust cursor: account for added commas
    var commasBefore = (el.value.slice(0, cursorPos).match(/,/g) || []).length;
    el.value = formatted;
    var commasAfter = (formatted.slice(0, cursorPos).match(/,/g) || []).length;
    var newCursor = cursorPos + (commasAfter - commasBefore);
    el.setSelectionRange(newCursor, newCursor);

    saveFn(cleaned);
}

// ‚îÄ‚îÄ Format existing values with commas on load/render ‚îÄ‚îÄ
function applyNumFmtToInputs() {
    document.querySelectorAll('input[data-num]').forEach(function(el) {
        // Format existing value with commas
        if (el.value && el.value !== '') {
            var raw = el.value.replace(/,/g, '');
            var n = parseFloat(raw);
            if (!isNaN(n) && n >= 0) {
                var parts = raw.split('.');
                var intPart = parseInt(parts[0] || '0', 10).toLocaleString('en-US');
                el.value = parts.length > 1 ? intPart + '.' + parts[1] : intPart;
            }
        }
        // Block non-numeric keystrokes at keydown level (before oninput)
        if (!el._numFmtKeydownBound) {
            el._numFmtKeydownBound = true;
            el.addEventListener('keydown', function(e) {
                // Allow: backspace, delete, tab, arrows, home, end, ctrl combos
                var allowed = [
                    'Backspace','Delete','Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown',
                    'Home','End','Enter','Escape'
                ];
                if (allowed.includes(e.key)) return;
                if (e.ctrlKey || e.metaKey) return; // allow Ctrl+A, Ctrl+C, Ctrl+V etc.
                // Allow digits 0-9
                if (/^\d$/.test(e.key)) return;
                // Allow one dot for decimals
                if (e.key === '.' && !this.value.includes('.')) return;
                // Block everything else (letters, symbols, minus, etc.)
                e.preventDefault();
            });
        }
    });
}

        // Regions are maintained - users add their own projects via "Add Project" button
        // No hard-coded projects to ensure fresh start for each user

        let state = {
            isLoggedIn: false,
            isEditing: false,
            currentTab: 'overall',
            currentUser: null,
            selectedYear: 2026, // Default year - YEAR SELECTOR FEATURE
            projects: [], // Currently displayed projects (filtered by year)
            masterProjects: [], // ALL projects from ALL years (loaded once)
            personnelData: [],
            incidentRateData: { recordableCases: 0, lostDays: 0, totalHours: 0 },
            filteredProjects: [],
            selectedProjects: [],
            charts: {},
            currentSort: 'name',
            darkMode: false,
            isDataMigrated: false, // Track if data has been migrated to year-based structure
            doePermitData: { permitNumber: '', validityDate: '' }, // NEW: DOE Safety Officer Permit
            auditLog: [], // NEW: Audit trail for all changes
            offlineQueue: [], // NEW: Queue for offline changes
            isOnline: navigator.onLine, // NEW: Online status
            isAdmin: false, // NEW: Admin role flag
            loginLogbook: [], // NEW: Login history with IP and location
            searchTerm: '', // NEW: Preserve search input
            regionFilter: '', // NEW: Preserve region filter
            statusFilter: '', // NEW: Preserve status filter
            // ==================== NEW: MULTI-USER COLLABORATION ====================
            userRole: null, // 'admin' or 'superintendent'
            userRegion: null, // 'ALL', 'NCR', 'NORTH LUZON', 'SOUTH LUZON', 'VISAYAS & MINDANAO'
            userColor: '#FF0000', // Color for user identification
            deviceFingerprint: null, // Unique device identifier
            activeUsers: {}, // Real-time presence tracking {userId: {status, activity, ...}}
            activeDevices: [], // List of active devices
            presenceListener: null, // Firebase listener for presence updates
            deviceListener: null // Firebase listener for device updates
        };

        // ==================== COMPREHENSIVE DEBUG SYSTEM ====================
        window.DEBUG_MODE = true; // Set to false to disable debug logs
        
        // ==================== DEVICE FINGERPRINTING SYSTEM ====================
        const DeviceFingerprint = {
            async generate() {
                const components = {
                    // Canvas fingerprint
                    canvas: await this.getCanvasFingerprint(),
                    // WebGL fingerprint
                    webgl: this.getWebGLFingerprint(),
                    // Screen properties
                    screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    // Timezone
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    // Language
                    language: navigator.language,
                    // Platform
                    platform: navigator.platform,
                    // User agent
                    userAgent: navigator.userAgent,
                    // Hardware concurrency (CPU cores)
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    // Device memory (if available)
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    // Plugins
                    plugins: Array.from(navigator.plugins || []).map(p => p.name).join(','),
                    // Touch support
                    touchSupport: 'ontouchstart' in window
                };
                
                // Create hash from all components
                const fingerprint = await this.hashComponents(components);
                console.log('üîë Device Fingerprint Generated:', fingerprint.substring(0, 16) + '...');
                return fingerprint;
            },
            
            async getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText('ESH Dashboard üõ°Ô∏è', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('Fingerprint Test', 4, 17);
                    
                    return canvas.toDataURL();
                } catch (e) {
                    return 'canvas-error';
                }
            },
            
            getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) return 'no-webgl';
                    
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (!debugInfo) return 'no-debug-info';
                    
                    const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                    const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    
                    return `${vendor}~${renderer}`;
                } catch (e) {
                    return 'webgl-error';
                }
            },
            
            async hashComponents(components) {
                const str = JSON.stringify(components);
                const encoder = new TextEncoder();
                const data = encoder.encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },
            
            getPlatformInfo() {
                const ua = navigator.userAgent;
                let platform = 'Unknown';
                let browser = 'Unknown';
                
                // Detect platform
                if (ua.indexOf('Win') !== -1) platform = 'Windows';
                else if (ua.indexOf('Mac') !== -1) platform = 'MacOS';
                else if (ua.indexOf('Linux') !== -1) platform = 'Linux';
                else if (ua.indexOf('Android') !== -1) platform = 'Android';
                else if (ua.indexOf('iOS') !== -1 || ua.indexOf('iPhone') !== -1 || ua.indexOf('iPad') !== -1) platform = 'iOS';
                
                // Detect browser
                if (ua.indexOf('Chrome') !== -1 && ua.indexOf('Edg') === -1) browser = 'Chrome';
                else if (ua.indexOf('Safari') !== -1 && ua.indexOf('Chrome') === -1) browser = 'Safari';
                else if (ua.indexOf('Firefox') !== -1) browser = 'Firefox';
                else if (ua.indexOf('Edg') !== -1) browser = 'Edge';
                else if (ua.indexOf('MSIE') !== -1 || ua.indexOf('Trident') !== -1) browser = 'IE';
                
                return { platform, browser };
            }
        };
        
        // ==================== AUDIT TRAIL SYSTEM ====================
        const AuditLogger = {
            log(action, details = {}) {
                const entry = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    user: state.currentUser?.email || 'Unknown',
                    userName: state.currentUser?.displayName || 'Unknown User',
                    action: action,
                    details: details,
                    year: state.selectedYear
                };
                
                state.auditLog.unshift(entry); // Add to beginning
                
                // Keep only last 500 entries in memory
                if (state.auditLog.length > 500) {
                    state.auditLog = state.auditLog.slice(0, 500);
                }
                
                // Save to localStorage for persistence
                this.saveToStorage();
                
                console.log('üìù Audit:', action, details);
            },
            
            saveToStorage() {
                try {
                    localStorage.setItem('esh_audit_log', JSON.stringify(state.auditLog));
                } catch (e) {
                    console.error('Failed to save audit log to localStorage:', e);
                }
            },
            
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('esh_audit_log');
                    if (saved) {
                        state.auditLog = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load audit log from localStorage:', e);
                }
            },
            
            
            getRecent(limit = 50) {
                return state.auditLog.slice(0, limit);
            },
            
            filterByAction(action) {
                return state.auditLog.filter(entry => entry.action === action);
            },
            
            filterByDateRange(startDate, endDate) {
                const start = new Date(startDate).getTime();
                const end = new Date(endDate).getTime();
                return state.auditLog.filter(entry => {
                    const timestamp = new Date(entry.timestamp).getTime();
                    return timestamp >= start && timestamp <= end;
                });
            },
            
            exportToCSV() {
                const headers = ['Timestamp', 'User', 'Action', 'Details', 'Year'];
                const rows = state.auditLog.map(entry => {
                    // Format details in a readable way
                    let detailsText = '';
                    if (Object.keys(entry.details).length > 0) {
                        const details = entry.details;
                        let parts = [];
                        
                        if (details.projectName) parts.push(`Project: ${details.projectName}`);
                        if (details.email) parts.push(`Email: ${details.email}`);
                        if (details.status) parts.push(`Status: ${details.status}`);
                        if (details.year) parts.push(`Year: ${details.year}`);
                        if (details.tab) parts.push(`Tab: ${details.tab}`);
                        if (details.step !== undefined) parts.push(`Step: ${details.step}`);
                        if (details.totalSteps !== undefined) parts.push(`Total Steps: ${details.totalSteps}`);
                        if (details.remainingProjects !== undefined) parts.push(`Remaining: ${details.remainingProjects}`);
                        
                        detailsText = parts.join('; ');
                    }
                    
                    return [
                        new Date(entry.timestamp).toLocaleString(),
                        entry.userName,
                        entry.action.replace(/_/g, ' '),
                        detailsText,
                        entry.year
                    ];
                });
                
                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                return csv;
            }
        };
        
        // Load audit log on startup
        AuditLogger.loadFromStorage();
        
        // ==================== LOGIN LOGBOOK SYSTEM ====================
        const LoginLogbook = {
            async logLogin(user) {
                try {
                    const _ui = UserAccounts.getUserInfo(user.email);
                    if (_ui.role === 'admin') return;
                    const ipInfo = await this.getIPInfo();
                    
                    const entry = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        email: user.email,
                        displayName: user.displayName || 'Unknown User',
                        uid: user.uid,
                        ip: ipInfo.ip || 'Unknown',
                        country: ipInfo.country || 'Unknown',
                        region: ipInfo.region || 'Unknown',
                        city: ipInfo.city || 'Unknown',
                        timezone: ipInfo.timezone || 'Unknown',
                        isp: ipInfo.isp || 'Unknown',
                        userAgent: navigator.userAgent,
                        browser: this.getBrowserInfo(),
                        os: this.getOSInfo(),
                        device: this.getDeviceInfo(),
                        screenResolution: `${screen.width}x${screen.height}`,
                        action: 'LOGIN'
                    };
                    
                    state.loginLogbook.unshift(entry);
                    
                    // Keep only last 1000 entries
                    if (state.loginLogbook.length > 1000) {
                        state.loginLogbook = state.loginLogbook.slice(0, 1000);
                    }
                    
                    // Save to localStorage
                    this.saveToStorage();
                    
                    // Save to Firebase (only for admin viewing)
                    await this.saveToFirebase(entry);
                    
                    console.log('‚úÖ Login logged:', entry);
                } catch (error) {
                    console.error('Failed to log login:', error);
                }
            },
            
            async logLogout(user) {
                try {
                    const _ui2 = UserAccounts.getUserInfo(user.email);
                    if (_ui2.role === 'admin') return;
                    const ipInfo = await this.getIPInfo();
                    
                    const entry = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        email: user.email,
                        displayName: user.displayName || 'Unknown User',
                        uid: user.uid,
                        ip: ipInfo.ip || 'Unknown',
                        action: 'LOGOUT'
                    };
                    
                    state.loginLogbook.unshift(entry);
                    if (state.loginLogbook.length > 1000) {
                        state.loginLogbook = state.loginLogbook.slice(0, 1000);
                    }
                    
                    this.saveToStorage();
                    await this.saveToFirebase(entry);
                } catch (error) {
                    console.error('Failed to log logout:', error);
                }
            },
            
            async getIPInfo() {
                // JSONP bypass for file:// CORS restriction
                // fetch() is always blocked on null/file:// origins ‚Äî use <script> tag injection instead
                const jsonpFetch = (url, callbackParam = 'callback') => new Promise((resolve, reject) => {
                    const cbName = '_ipCb_' + Math.random().toString(36).slice(2);
                    const script = document.createElement('script');
                    const timer = setTimeout(() => {
                        cleanup();
                        reject(new Error('JSONP timeout'));
                    }, 7000);
                    const cleanup = () => {
                        clearTimeout(timer);
                        delete window[cbName];
                        if (script.parentNode) script.parentNode.removeChild(script);
                    };
                    window[cbName] = (data) => { cleanup(); resolve(data); };
                    script.onerror = () => { cleanup(); reject(new Error('JSONP script error')); };
                    script.src = `${url}${url.includes('?') ? '&' : '?'}${callbackParam}=${cbName}`;
                    document.head.appendChild(script);
                });

                // JSONP APIs (work on file:// ‚Äî no CORS restriction)
                const jsonpApis = [
                    async () => {
                        // ipinfo.io ‚Äî confirmed working ‚úÖ
                        const d = await jsonpFetch('https://ipinfo.io/json', 'callback');
                        if (!d.ip) throw new Error('ipinfo.io: no ip');
                        return { ip: d.ip, country: d.country, region: d.region, city: d.city, timezone: d.timezone, isp: d.org };
                    },
                    async () => {
                        // ip-api.com ‚Äî JSONP supported, fallback
                        const d = await jsonpFetch('https://ip-api.com/json/?fields=status,country,regionName,city,timezone,isp,query');
                        if (d.status !== 'success') throw new Error('ip-api.com: ' + d.message);
                        return { ip: d.query, country: d.country, region: d.regionName, city: d.city, timezone: d.timezone, isp: d.isp };
                    }
                ];

                // Try JSONP first (works on file://)
                for (const api of jsonpApis) {
                    try {
                        const result = await api();
                        if (result.ip) {
                            console.log('‚úÖ IP info fetched (JSONP):', result.ip, result.city);
                            return result;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è JSONP IP API failed, trying next...', e.message);
                    }
                }

                // Fallback: regular fetch (works when hosted on a real server, not file://)
                const fetchApis = [
                    async () => {
                        const r = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(6000) });
                        if (!r.ok) throw new Error('ipapi.co failed');
                        const d = await r.json();
                        if (d.error) throw new Error(d.reason || 'ipapi.co error');
                        return { ip: d.ip, country: d.country_name, region: d.region, city: d.city, timezone: d.timezone, isp: d.org };
                    },
                    async () => {
                        const r = await fetch('https://ipwho.is/', { signal: AbortSignal.timeout(6000) });
                        if (!r.ok) throw new Error('ipwho.is failed');
                        const d = await r.json();
                        if (!d.success) throw new Error('ipwho.is error');
                        return { ip: d.ip, country: d.country, region: d.region, city: d.city, timezone: d.timezone?.id, isp: d.connection?.isp };
                    },
                    async () => {
                        const r = await fetch('https://freeipapi.com/api/json', { signal: AbortSignal.timeout(6000) });
                        if (!r.ok) throw new Error('freeipapi failed');
                        const d = await r.json();
                        return { ip: d.ipAddress, country: d.countryName, region: d.regionName, city: d.cityName, timezone: d.timeZone, isp: null };
                    }
                ];

                for (const api of fetchApis) {
                    try {
                        const result = await api();
                        if (result.ip) {
                            console.log('‚úÖ IP info fetched (fetch):', result.ip, result.city);
                            return result;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Fetch IP API failed, trying next...', e.message);
                    }
                }

                console.warn('‚ùå All IP APIs failed ‚Äî logging without location');
                return {};
            },
            
            getBrowserInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                if (ua.includes('Opera')) return 'Opera';
                return 'Unknown';
            },
            
            getOSInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'macOS';
                if (ua.includes('Linux')) return 'Linux';
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('iOS')) return 'iOS';
                return 'Unknown';
            },
            
            getDeviceInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Mobile')) return 'Mobile';
                if (ua.includes('Tablet')) return 'Tablet';
                return 'Desktop';
            },
            
            saveToStorage() {
                try {
                    localStorage.setItem('esh_login_logbook', JSON.stringify(state.loginLogbook));
                } catch (e) {
                    console.error('Failed to save logbook to localStorage:', e);
                }
            },
            
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('esh_login_logbook');
                    if (saved) {
                        state.loginLogbook = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load logbook from localStorage:', e);
                }
            },
            
            async saveToFirebase(entry) {
                try {
                    // Force token refresh so Firebase Rules can see auth.token.email
                    const currentUser = window.firebaseAuth.currentUser;
                    if (currentUser) {
                        await currentUser.getIdToken(true); // force refresh
                    }
                    const logbookRef = window.firebase.dbRef(
                        window.firebaseRealtimeDb,
                        `login-logbook/${entry.id}`
                    );
                    await window.firebase.set(logbookRef, entry);
                    console.log('‚úÖ Logbook entry saved to Firebase:', entry.email);
                } catch (e) {
                    console.warn('Could not save to Firebase logbook:', e.message);
                }
            },
            
            getRecent(limit = 100) {
                return state.loginLogbook.slice(0, limit);
            },
            
            filterByUser(email) {
                return state.loginLogbook.filter(entry => entry.email === email);
            },
            
            filterByDateRange(startDate, endDate) {
                const start = new Date(startDate).getTime();
                const end = new Date(endDate).getTime();
                return state.loginLogbook.filter(entry => {
                    const timestamp = new Date(entry.timestamp).getTime();
                    return timestamp >= start && timestamp <= end;
                });
            },
            
            exportToCSV() {
                const headers = ['Timestamp', 'Action', 'Email', 'Display Name', 'IP Address', 'Location', 'Browser', 'OS', 'Device'];
                const rows = state.loginLogbook.map(entry => [
                    new Date(entry.timestamp).toLocaleString(),
                    entry.action,
                    entry.email,
                    entry.displayName,
                    entry.ip,
                    `${entry.city}, ${entry.region}, ${entry.country}`,
                    entry.browser || '-',
                    entry.os || '-',
                    entry.device || '-'
                ]);
                
                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                return csv;
            }
        };
        
        // Load logbook on startup
        LoginLogbook.loadFromStorage();
        
        // ==================== USER ACCOUNT MANAGEMENT SYSTEM ====================
        // ==================== RBAC: ROLE-BASED ACCESS CONTROL ====================
        const UserAccounts = {
            // ‚îÄ‚îÄ Hardcoded non-admin accounts (Superintendent & PCO) ‚îÄ‚îÄ
            // Admin accounts are any authenticated Firebase users NOT listed here.
            superintendents: {
                'esh@ncr.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'superintendent',
                    displayName: 'NCR Superintendent',
                    region: 'NCR',
                    color: '#2196F3'
                },
                'esh@north.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'superintendent',
                    displayName: 'North Luzon Superintendent',
                    region: 'NORTH LUZON',
                    color: '#4CAF50'
                },
                'esh@south.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'superintendent',
                    displayName: 'South Luzon Superintendent',
                    region: 'SOUTH LUZON',
                    color: '#FF9800'
                },
                'esh@vismin.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'superintendent',
                    displayName: 'Visayas & Mindanao Superintendent',
                    region: 'VISAYAS & MINDANAO',
                    color: '#9C27B0'
                },
                // ==================== PCO ACCOUNTS ====================
                'esh@ncrpco.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'pco',
                    displayName: 'NCR PCO',
                    region: 'NCR',
                    color: '#00ACC1'
                },
                'esh@southpco.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'pco',
                    displayName: 'South Luzon PCO',
                    region: 'SOUTH LUZON',
                    color: '#F4511E'
                },
                'esh@northpco.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'pco',
                    displayName: 'North Luzon PCO',
                    region: 'NORTH LUZON',
                    color: '#43A047'
                },
                'esh@visminpco.com.ph': {
                    password: '*** (auth via Firebase Auth)',
                    role: 'pco',
                    displayName: 'Visayas & Mindanao PCO',
                    region: 'VISAYAS & MINDANAO',
                    color: '#8E24AA'
                }
            },

            // ‚îÄ‚îÄ PCO-editable tabs (Environmental modules only) ‚îÄ‚îÄ
            PCO_EDITABLE_TABS: [
                'permits',       // Environmental Permits
                'emb',           // EMB Reportorial
                'env-monitoring',// Environmental Monitoring
                'env-monthly-report', // Monthly Environmental Report
                'esh-calendar-env',   // ESH Calendar - Environment
            ],

            // ‚îÄ‚îÄ Tabs PCO can VIEW but NOT edit ‚îÄ‚îÄ
            PCO_VIEW_TABS: [
                'overall', 'rates', 'exposures', 'medical', 'nov', 'nov-monitoring',
                'activities', 'kpm', 'dole', 'doe', 'doe-permit', 'cshp', 'reg', 'audit',
                'esh-calendar-safety', 'esh-calendar-health', 'esh-calendar-drills',
                'personnel', 'osh-requirement'
            ],

            // ‚îÄ‚îÄ Get user info (role, region, etc.) ‚îÄ‚îÄ
            getUserInfo(email) {
                if (!email) return { role: 'guest', region: null, displayName: 'Guest', color: '#999' };
                if (this.superintendents[email]) return this.superintendents[email];
                // Any Firebase-authenticated user not in the list = Admin
                return { role: 'admin', displayName: 'Administrator', region: 'ALL', color: '#D32F2F' };
            },

            isAdmin(email) {
                if (!email) return false;
                const info = this.getUserInfo(email);
                return info.role === 'admin';
            },

            isSuperintendent(email) {
                const info = this.getUserInfo(email);
                return info.role === 'superintendent';
            },

            isPCO(email) {
                const info = this.getUserInfo(email);
                return info.role === 'pco';
            },

            // ‚îÄ‚îÄ CORE RBAC GATE: Can this user edit a specific project in a specific tab? ‚îÄ‚îÄ
            // Returns: { allowed: bool, reason: string }
            checkPermission(userEmail, action, projectRegion, tab) {
                const info = this.getUserInfo(userEmail);

                // Admin ‚Üí full access
                if (info.role === 'admin') return { allowed: true, reason: 'Admin: full access' };

                // Guest / unauthenticated ‚Üí deny everything
                if (info.role === 'guest') return { allowed: false, reason: '403: Not authenticated' };

                // DELETE is admin-only
                if (action === 'delete') {
                    return { allowed: false, reason: '403: Only Admins can delete records' };
                }

                // ‚îÄ‚îÄ Corporate region is Admin-only ‚îÄ‚îÄ
                if (projectRegion === 'CORPORATE') {
                    return { allowed: false, reason: '403: Corporate region is Admin-only.' };
                }

                // ‚îÄ‚îÄ Superintendent ‚îÄ‚îÄ
                if (info.role === 'superintendent') {
                    // Tab: Supers can edit any tab (except audit which is admin-only)
                    if (tab === 'audit') return { allowed: false, reason: '403: Audit tab is Admin-only' };
                    // Region: Superintendent can only edit their assigned region
                    if (projectRegion && info.region !== projectRegion) {
                        return { allowed: false, reason: `403: You can only edit records in ${info.region}. This project belongs to ${projectRegion}.` };
                    }
                    return { allowed: true, reason: 'Superintendent: region match' };
                }

                // ‚îÄ‚îÄ PCO ‚îÄ‚îÄ
                if (info.role === 'pco') {
                    // Tab check first
                    if (tab && !this.PCO_EDITABLE_TABS.includes(tab)) {
                        return { allowed: false, reason: `403: PCO accounts can only edit Environmental modules. "${tab}" is read-only for your role.` };
                    }
                    // Region check
                    if (projectRegion && info.region !== projectRegion) {
                        return { allowed: false, reason: `403: You can only edit records in ${info.region}.` };
                    }
                    return { allowed: true, reason: 'PCO: env tab + region match' };
                }

                return { allowed: false, reason: '403: Unauthorized Action' };
            },

            // ‚îÄ‚îÄ Legacy helpers (kept for backward compat) ‚îÄ‚îÄ
            canEdit(userEmail, projectRegion) {
                const result = this.checkPermission(userEmail, 'edit', projectRegion, state.currentTab);
                return result.allowed;
            },

            canEditTab(userEmail, tab) {
                const result = this.checkPermission(userEmail, 'edit', null, tab);
                return result.allowed;
            },

            isPCOViewOnly(userEmail, tab) {
                const info = this.getUserInfo(userEmail);
                if (info.role !== 'pco') return false;
                return this.PCO_VIEW_TABS.includes(tab);
            },

            // ‚îÄ‚îÄ Role-specific locked message ‚îÄ‚îÄ
            getLockedReason(userEmail, projectRegion, tab) {
                const result = this.checkPermission(userEmail, 'edit', projectRegion, tab);
                return result.reason;
            },

            getAccessLevel(userEmail) {
                const userInfo = this.getUserInfo(userEmail);
                const isPCO = userInfo.role === 'pco';
                return {
                    role: userInfo.role,
                    region: userInfo.region,
                    permissions: {
                        viewAll: true,
                        editAll: userInfo.role === 'admin',
                        editOwn: userInfo.role === 'superintendent' || isPCO,
                        accessSettings: userInfo.role === 'admin',
                        viewUsers: userInfo.role === 'admin',
                        viewDevices: userInfo.role === 'admin',
                        deleteProjects: userInfo.role === 'admin',
                        createAccounts: userInfo.role === 'admin'
                    }
                };
            }
        };
        window.UserAccounts = UserAccounts;
        // ==================== END RBAC ====================

        
        // ==================== PRESENCE TRACKING SYSTEM ====================
        const PresenceTracker = {
            myPresenceRef: null,
            usersPresenceRef: null,
            devicesRef: null,
            activityTimeout: null,
            lastActivityTime: Date.now(),
            
            async initialize(userId, userEmail) {
                if (!window.firebaseRealtimeDb) {
                    console.warn('Firebase Realtime DB not available');
                    return;
                }
                
                const userInfo = UserAccounts.getUserInfo(userEmail);
                const deviceInfo = DeviceFingerprint.getPlatformInfo();
                
                // Setup my presence
                this.myPresenceRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    `presence/${userId}`
                );
                
                // Setup all users presence listener
                this.usersPresenceRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    'presence'
                );
                
                // Setup devices reference ‚Äî keyed by userId so each logged-in account
                // gets its own Firebase node (fixing same-fingerprint overwrite bug)
                this.devicesRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    `devices/${userId}`
                );
                
                // Initial presence data
                const presenceData = {
                    status: 'online',
                    displayName: userInfo.displayName,
                    email: userEmail,
                    role: userInfo.role,
                    region: userInfo.region,
                    color: userInfo.color,
                    currentActivity: {
                        action: 'viewing',
                        tab: state.currentTab,
                        project: null,
                        cell: null,
                        timestamp: Date.now()
                    },
                    lastSeen: Date.now(),
                    deviceId: state.deviceFingerprint,
                    platform: deviceInfo.platform,
                    browser: deviceInfo.browser
                };
                
                // Set initial presence
                await window.firebase.set(this.myPresenceRef, presenceData);
                
                // Setup disconnect handler ‚Äî removes entry entirely on abrupt disconnect
                const disconnectRef = window.firebase.onDisconnect(this.myPresenceRef);
                disconnectRef.remove();
                
                // Register device
                await this.registerDevice(userId, userEmail, deviceInfo);
                
                // Listen to all users presence (admin only)
                if (userInfo.role === 'admin') {
                    this.startPresenceListener();
                    this.startDeviceListener();
                }
                
                // Setup activity tracking
                this.setupActivityTracking();
                
                console.log('‚úÖ Presence tracking initialized');
            },
            
            async registerDevice(userId, userEmail, deviceInfo) {
                const deviceData = {
                    userId: userId,
                    email: userEmail,
                    fingerprint: state.deviceFingerprint,
                    platform: deviceInfo.platform,
                    browser: deviceInfo.browser,
                    firstSeen: Date.now(),
                    lastSeen: Date.now(),
                    status: 'active'
                };
                
                try {
                    await window.firebase.set(this.devicesRef, deviceData);
                    console.log('‚úÖ Device registered in Firebase:', userEmail);
                } catch (err) {
                    console.error('‚ùå Firebase PERMISSION DENIED ‚Äî registerDevice failed!', err.message);
                    console.error('üëâ Fix: Update Firebase Realtime Database Rules in Firebase Console.');
                }
                
                // Setup disconnect ‚Äî removes device entry entirely on abrupt disconnect
                const disconnectRef = window.firebase.onDisconnect(this.devicesRef);
                disconnectRef.remove();
            },
            
            startPresenceListener() {
                window.firebase.onValue(this.usersPresenceRef, (snapshot) => {
                    const presenceData = snapshot.val() || {};
                    state.activeUsers = presenceData;
                    
                    // FIX: Always update UI when presence data changes (real-time)
                    // Using 'this' bound via arrow function ensures correct context
                    if (state.isAdmin && state.isLoggedIn) {
                        this.updateActiveUsersUI();
                        // Also sync device badge from presence (more reliable count)
                        this.updateDeviceCounterUI();
                        console.log('üîÑ Presence updated:', Object.keys(presenceData).length, 'users in Firebase');
                    }
                });
            },
            
            startDeviceListener() {
                const allDevicesRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    'devices'
                );
                
                window.firebase.onValue(allDevicesRef, (snapshot) => {
                    const devicesData = snapshot.val() || {};
                    state.activeDevices = Object.values(devicesData);
                    
                    // FIX: Always update UI when device data changes (real-time)
                    if (state.isAdmin && state.isLoggedIn) {
                        this.updateDeviceCounterUI();
                        console.log('üîÑ Devices updated:', state.activeDevices.length, 'devices in Firebase');
                    }
                });
            },
            
            setupActivityTracking() {
                // Track user activity
                const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
                
                events.forEach(event => {
                    document.addEventListener(event, () => {
                        this.lastActivityTime = Date.now();
                        this.updateStatus('online');
                    });
                });
                
                // Check for idle status every 30 seconds
                setInterval(() => {
                    const idleTime = Date.now() - this.lastActivityTime;
                    
                    if (idleTime > 5 * 60 * 1000) { // 5 minutes
                        this.updateStatus('idle');
                    }
                }, 30000);
            },
            
            async updateStatus(status) {
                if (!this.myPresenceRef) return;
                
                await window.firebase.update(this.myPresenceRef, {
                    status: status,
                    lastSeen: Date.now()
                });
            },
            
            async updateActivity(action, details = {}) {
                if (!this.myPresenceRef) return;
                
                await window.firebase.update(this.myPresenceRef, {
                    'currentActivity/action': action,
                    'currentActivity/tab': details.tab || state.currentTab,
                    'currentActivity/project': details.project || null,
                    'currentActivity/cell': details.cell || null,
                    'currentActivity/timestamp': Date.now(),
                    lastSeen: Date.now()
                });
            },
            
            updateActiveUsersUI() {
                if (!state.isAdmin) return;
                
                const usersList = document.getElementById('users-list');
                const usersBadge = document.getElementById('users-count-badge');
                const container = document.getElementById('active-users-container');
                
                if (!usersList || !usersBadge || !container) {
                    console.warn('‚ö†Ô∏è Active users UI elements not found');
                    return;
                }
                
                // Show container for admin
                container.style.display = 'inline-block';
                console.log('üë• Active users container shown');
                
                const users = Object.entries(state.activeUsers || {});
                const now = Date.now();
                const STALE_THRESHOLD = 2 * 60 * 1000; // 2 minutes ‚Äî if lastSeen older than this and not actively pinging, consider offline
                
                // Filter: only count as online if status=online AND lastSeen is recent
                const onlineCount = users.filter(([, data]) => {
                    if (data.status !== 'online') return false;
                    // If lastSeen exists and is too old, treat as stale/offline
                    if (data.lastSeen && (now - data.lastSeen) > STALE_THRESHOLD) return false;
                    return true;
                }).length;
                
                // Update badge
                usersBadge.textContent = onlineCount;
                
                if (users.length === 0) {
                    usersList.innerHTML = `
                        <div class="dropdown-empty">
                            <i class="fas fa-user-slash"></i>
                            <div>No users online</div>
                        </div>
                    `;
                    return;
                }
                
                // Sort: online first, then by name
                users.sort((a, b) => {
                    if (a[1].status !== b[1].status) {
                        const statusOrder = { online: 0, idle: 1, offline: 2 };
                        return statusOrder[a[1].status] - statusOrder[b[1].status];
                    }
                    return (a[1].displayName || '').localeCompare(b[1].displayName || '');
                });
                
                usersList.innerHTML = users.map(([userId, data]) => {
                    const initials = (data.displayName || data.email || 'U').substring(0, 2).toUpperCase();
                    const activityText = this.getActivityText(data.currentActivity);
                    const statusClass = `status-${data.status}`;
                    const statusText = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                    
                    return `
                        <div class="dropdown-item">
                            <div class="user-info">
                                <div class="user-avatar" style="background: ${data.color || '#2e7d32'}">
                                    ${initials}
                                </div>
                                <div class="user-details">
                                    <div class="user-name">${data.displayName || 'Unknown User'}</div>
                                    <div class="user-activity">
                                        <i class="fas fa-${this.getActivityIcon(data.currentActivity?.action)}"></i>
                                        ${activityText}
                                    </div>
                                    <span class="user-status ${statusClass}">
                                        <span class="status-indicator"></span>
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            updateDeviceCounterUI() {
                if (!state.isAdmin) return;
                
                const deviceList = document.getElementById('device-list');
                const deviceBadge = document.getElementById('device-count-badge');
                const container = document.getElementById('device-counter-container');
                
                if (!deviceList || !deviceBadge || !container) {
                    console.warn('‚ö†Ô∏è Device counter UI elements not found');
                    return;
                }
                
                // Show container for admin
                container.style.display = 'inline-block';
                console.log('üñ•Ô∏è Device counter container shown');
                
                const devices = state.activeDevices || [];
                const activeDevices = devices.filter(d => d.status === 'active');
                
                // FIX: Use presence data as primary source of truth for LIVE count.
                // Presence is updated instantly on tab close (via cleanup() + onDisconnect).
                // Devices node can lag slightly on network disconnect, so presence is more reliable.
                const now = Date.now();
                const STALE_THRESHOLD = 2 * 60 * 1000; // 2 minutes
                const presenceOnline = Object.values(state.activeUsers || {})
                    .filter(u => {
                        if (u.status !== 'online') return false;
                        if (u.lastSeen && (now - u.lastSeen) > STALE_THRESHOLD) return false;
                        return true;
                    }).length;
                
                // Use presence count ‚Äî it reflects instantly when a tab is closed
                const displayCount = presenceOnline;
                
                // Update badge
                deviceBadge.textContent = displayCount;
                
                if (activeDevices.length === 0) {
                    deviceList.innerHTML = `
                        <div class="dropdown-empty">
                            <i class="fas fa-laptop"></i>
                            <div>No devices connected</div>
                        </div>
                    `;
                    return;
                }
                
                // Sort by last seen (most recent first)
                activeDevices.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));
                
                deviceList.innerHTML = activeDevices.map(device => {
                    const iconObj = this.getDeviceIcon(device.platform);
                    const timeSince = this.getTimeSince(device.lastSeen);
                    
                    return `
                        <div class="dropdown-item">
                            <div class="device-info">
                                <div class="device-icon-box">
                                    <i class="device-icon ${iconObj.prefix} ${iconObj.icon}"></i>
                                </div>
                                <div class="device-details">
                                    <div class="device-name">${device.platform || 'Unknown'} ‚Äî ${device.browser || 'Browser'}</div>
                                    <div class="device-meta"><i class="fas fa-clock" style="font-size:0.6rem"></i> ${timeSince}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            getDeviceIcon(platform) {
                const p = (platform || '').toLowerCase();
                if (p.includes('windows')) return { prefix: 'fab', icon: 'fa-windows' };
                if (p.includes('mac')) return { prefix: 'fab', icon: 'fa-apple' };
                if (p.includes('linux')) return { prefix: 'fab', icon: 'fa-linux' };
                if (p.includes('android')) return { prefix: 'fab', icon: 'fa-android' };
                if (p.includes('iphone') || p.includes('ipad')) return { prefix: 'fab', icon: 'fa-apple' };
                return { prefix: 'fas', icon: 'fa-laptop' };
            },
            
            getTimeSince(timestamp) {
                if (!timestamp) return 'Unknown';
                
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
                return `${Math.floor(seconds / 86400)} days ago`;
            },
            
            getActivityText(activity) {
                if (!activity) return 'Idle';
                
                const action = activity.action || 'viewing';
                const tab = activity.tab || 'dashboard';
                const project = activity.project;
                
                if (action === 'editing' && project) {
                    return `Editing ${tab.toUpperCase()} - ${project}`;
                }
                if (action === 'viewing' && project) {
                    return `Viewing ${project}`;
                }
                return `${action.charAt(0).toUpperCase() + action.slice(1)} ${tab}`;
            },
            
            getActivityIcon(action) {
                const icons = {
                    editing: 'edit',
                    viewing: 'eye',
                    idle: 'moon'
                };
                return icons[action] || 'circle';
            },
            
            async cleanup() {
                // Remove presence and device entries completely on logout/tab close
                // Using remove() is better than status:'offline' ‚Äî no ghost data left in Firebase
                const tasks = [];
                if (this.myPresenceRef) {
                    tasks.push(
                        window.firebase.remove(this.myPresenceRef)
                            .then(() => console.log('‚úÖ Presence removed from Firebase'))
                            .catch(e => console.warn('‚ö†Ô∏è Could not remove presence:', e.message))
                    );
                }
                if (this.devicesRef) {
                    tasks.push(
                        window.firebase.remove(this.devicesRef)
                            .then(() => console.log('‚úÖ Device removed from Firebase'))
                            .catch(e => console.warn('‚ö†Ô∏è Could not remove device:', e.message))
                    );
                }
                // Wait for both to complete before Firebase signs out
                await Promise.all(tasks);
            }
        };
        
        // Load logbook on startup
        LoginLogbook.loadFromStorage();
        
        // ==================== ADMIN SYSTEM (LEGACY - Deprecated) ====================
        // Note: Admin detection now handled by UserAccounts system
        // This AdminSystem is kept for backward compatibility but not used for access control
        const AdminSystem = {
            // Legacy admin email list - NO LONGER USED
            // Admin status is now determined by UserAccounts.getUserInfo()
            adminEmails: [],
            
            isAdmin(email) {
                // Redirect to new system
                return UserAccounts.isAdmin(email);
            },
            
            checkAdminAccess() {
                // Deprecated - admin access now set by UserAccounts
                if (!state.currentUser) return false;
                return state.isAdmin;
            },
            
            showAdminPanel() {
                if (!state.isAdmin) {
                    showToast('‚õî Access Denied: Admin privileges required', 'error');
                    return;
                }
                
                // Switch to admin tab
                changeTab('admin');
            },
            
            async getAllUsers() {
                // Get all unique users from login logbook
                const users = {};
                state.loginLogbook.forEach(entry => {
                    if (!users[entry.email]) {
                        users[entry.email] = {
                            email: entry.email,
                            displayName: entry.displayName,
                            uid: entry.uid,
                            lastLogin: entry.timestamp,
                            loginCount: 0,
                            locations: new Set()
                        };
                    }
                    users[entry.email].loginCount++;
                    if (entry.city && entry.country) {
                        users[entry.email].locations.add(`${entry.city}, ${entry.country}`);
                    }
                    // Keep most recent login
                    if (new Date(entry.timestamp) > new Date(users[entry.email].lastLogin)) {
                        users[entry.email].lastLogin = entry.timestamp;
                    }
                });
                
                return Object.values(users);
            },
            
            async revokeAccess(email) {
                // This would typically involve Firebase Admin SDK
                // For now, just log the action
                AuditLogger.log('ACCESS_REVOKED', { targetUser: email, admin: state.currentUser.email });
                showToast(`üö´ Access revoked for ${email}`, 'warning');
            }
        };
        
        // ==================== OFFLINE MODE SYSTEM ====================
        const OfflineManager = {
            init() {
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
                
                // Check initial status
                state.isOnline = navigator.onLine;
                console.log(`üì° Network status: ${state.isOnline ? 'Online' : 'Offline'}`);
            },
            
            handleOnline() {
                state.isOnline = true;
                showSyncPill('syncing', 'Back online ‚Äî syncing...');
                showToast('Back online! Syncing changes...', 'success');
                this.syncOfflineQueue();
                AuditLogger.log('SYSTEM_ONLINE', { status: 'Connected to internet' });
            },
            
            handleOffline() {
                state.isOnline = false;
                showSyncPill('offline', 'üìµ Offline ‚Äî local saves only');
                showToast('You are offline. Changes will sync when back online.', 'warning');
                AuditLogger.log('SYSTEM_OFFLINE', { status: 'Disconnected from internet' });
            },
            
            addToQueue(action, data) {
                state.offlineQueue.push({
                    id: Date.now(),
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('esh_offline_queue', JSON.stringify(state.offlineQueue));
            },
            
            async syncOfflineQueue() {
                if (state.offlineQueue.length === 0) return;
                
                console.log(`üîÑ Syncing ${state.offlineQueue.length} offline changes...`);
                
                // FIX: Always push current localStorage state to Firebase (it has the latest data)
                try {
                    const success = await saveToFirebase();
                    if (success) {
                        state.offlineQueue = [];
                        localStorage.removeItem('esh_offline_queue');
                        markSyncComplete();
                        showToast('All offline changes synced to cloud!', 'success');
                    } else {
                        showToast('‚ö†Ô∏è Sync failed ‚Äî will retry shortly.', 'warning');
                        setTimeout(() => this.syncOfflineQueue(), 15000);
                    }
                } catch (e) {
                    console.error('Failed to sync offline queue:', e);
                    showToast('‚ö†Ô∏è Sync failed ‚Äî will retry shortly.', 'warning');
                    setTimeout(() => this.syncOfflineQueue(), 15000);
                }
            },
            
            async processQueueItem(item) {
                // Process based on action type
                if (item.action === 'SAVE_DATA' || item.action === 'SAVE_ALL') {
                    await saveToFirebase();
                }
                // Add more action types as needed
            }
        };
        
        // ==================== REAL-TIME COLLABORATION ====================
        
        // ==================== LAZY LOADING SYSTEM ====================
        const LazyLoader = {
            observer: null,
            
            init() {
                this.observer = new IntersectionObserver(
                    (entries) => this.handleIntersection(entries),
                    { rootMargin: '50px' }
                );
            },
            
            handleIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadContent(entry.target);
                        this.observer.unobserve(entry.target);
                    }
                });
            },
            
            observe(elements) {
                elements.forEach(el => this.observer.observe(el));
            },
            
            loadContent(element) {
                // Load data for this element
                const projectName = element.dataset.projectName;
                if (projectName) {
                    console.log('Lazy loading project:', projectName);
                    // Render project details here
                }
            }
        };
        
        
        // Debug logger with timestamp
        function debugLog(category, message, data = null) {
            if (!window.DEBUG_MODE) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const styles = {
                'CRITICAL': 'color: red; font-weight: bold',
                'ERROR': 'color: orange; font-weight: bold',
                'WARNING': 'color: yellow',
                'INFO': 'color: cyan',
                'SUCCESS': 'color: lightgreen',
                'DATA': 'color: lightblue'
            };
            
            console.log(`%c[${timestamp}] [${category}] ${message}`, styles[category] || 'color: white', data || '');
        }
        
        // Validate state integrity
        function validateState() {
            const issues = [];
            
            // Check if projects and masterProjects are in sync
            if (state.projects.length > state.masterProjects.length) {
                issues.push('‚ö†Ô∏è projects has more items than masterProjects - data inconsistency!');
            }
            
            // Check for duplicate projects
            const projectNames = state.projects.map(p => p.name);
            const duplicates = projectNames.filter((name, index) => projectNames.indexOf(name) !== index);
            if (duplicates.length > 0) {
                issues.push(`‚ö†Ô∏è Duplicate projects found: ${duplicates.join(', ')}`);
            }
            
            // Check for projects without required fields
            state.projects.forEach(p => {
                if (!p.name) issues.push(`‚ö†Ô∏è Project without name found`);
                if (!p.region) issues.push(`‚ö†Ô∏è Project "${p.name}" missing region`);
                if (!p.dateStarted) issues.push(`‚ö†Ô∏è Project "${p.name}" missing dateStarted`);
                if (!p.status) issues.push(`‚ö†Ô∏è Project "${p.name}" missing status`);
            });
            
            // Check filtered projects sync
            if (state.filteredProjects.length > state.projects.length) {
                issues.push('‚ö†Ô∏è filteredProjects has more items than projects');
            }
            
            return {
                isValid: issues.length === 0,
                issues: issues,
                stats: {
                    totalProjects: state.projects.length,
                    masterProjects: state.masterProjects.length,
                    filteredProjects: state.filteredProjects.length,
                    selectedYear: state.selectedYear,
                    isLoggedIn: state.isLoggedIn
                }
            };
        }
        
        // Test year filtering logic
        function testYearFiltering() {
            debugLog('INFO', 'üß™ Testing year filtering logic...');
            
            // Create test projects
            const testProjects = [
                { name: 'Test1', dateStarted: '2020-01-01', dateFinished: null, status: 'on-going' },
                { name: 'Test2', dateStarted: '2024-01-01', dateFinished: '2025-12-31', status: 'finished' },
                { name: 'Test3', dateStarted: '2026-01-01', dateFinished: null, status: 'on-going' }
            ];
            
            // Test for different years
            [2020, 2024, 2025, 2026, 2027].forEach(year => {
                const filtered = filterProjectsByYear(testProjects, year);
                debugLog('DATA', `Year ${year}:`, filtered.map(p => p.name));
            });
            
            debugLog('SUCCESS', '‚úÖ Year filtering test complete');
        }
        
        // Monitor Firebase operations
        const originalSaveToFirebase = window.saveToFirebase;
        window.debugSaveToFirebase = async function() {
            debugLog('INFO', 'üíæ saveToFirebase() called');
            debugLog('DATA', 'State before save:', {
                projects: state.projects.length,
                masterProjects: state.masterProjects.length,
                year: state.selectedYear
            });
            
            const result = await originalSaveToFirebase?.();
            
            if (result) {
                debugLog('SUCCESS', '‚úÖ Save to Firebase successful');
            } else {
                debugLog('ERROR', '‚ùå Save to Firebase failed');
            }
            
            return result;
        };
        
        // Debug console commands
        window.debugCommands = {
            state: () => {
                console.log('Current State:', state);
                return state;
            },
            validate: () => {
                const result = validateState();
                console.log('Validation Result:', result);
                if (!result.isValid) {
                    console.error('Issues found:', result.issues);
                }
                return result;
            },
            testFiltering: testYearFiltering,
            projects: () => {
                console.log('Projects:', state.projects);
                console.log('Master Projects:', state.masterProjects);
                console.log('Filtered Projects:', state.filteredProjects);
            },
            clearConsole: () => console.clear(),
            help: () => {
                console.log(`
%cüîç Debug Commands Available:
%cdebugCommands.state() - View current state
debugCommands.validate() - Validate state integrity
debugCommands.testFiltering() - Test year filtering
debugCommands.projects() - View all project arrays
debugCommands.clearConsole() - Clear console
debugCommands.help() - Show this help
                `, 'color: cyan; font-weight: bold', 'color: white');
            }
        };
        
        // Auto-validate on critical operations
        const originalDeleteProject = window.deleteProject;
        
        // Log startup
        debugLog('INFO', 'üöÄ Debug system initialized');
        debugLog('INFO', 'üí° Type debugCommands.help() in console for available commands');

        // ===== DARK MODE FUNCTIONS =====
        function initDarkMode() {
            const savedTheme = localStorage.getItem('esh_theme_preference');
            if (savedTheme === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            state.darkMode = true;
            localStorage.setItem('esh_theme_preference', 'dark');
            updateThemeIcon();
            console.log('‚úÖ Dark mode enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            state.darkMode = false;
            localStorage.setItem('esh_theme_preference', 'light');
            updateThemeIcon();
            console.log('‚úÖ Light mode enabled');
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // ===== YEAR SELECTOR FUNCTIONS =====
        const YEAR_RANGE = { min: 2019, max: 2027 }; // Year range from 2019 to 2027
        let availableYears = [];

        function initializeYears() {
            // Generate default years from 2019 to 2027
            availableYears = [];
            for (let year = YEAR_RANGE.min; year <= YEAR_RANGE.max; year++) {
                availableYears.push(year);
            }
            
            // Load saved year preference
            const savedYear = localStorage.getItem('esh_selected_year');
            if (savedYear && availableYears.includes(parseInt(savedYear))) {
                state.selectedYear = parseInt(savedYear);
            }
            
            renderYearOptions();
            updateYearDisplay();
        }

        function renderYearOptions() {
            const container = document.getElementById('year-options');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Hide "Add Year" button for superintendent accounts
            const addYearBtn = document.querySelector('.year-add-btn');
            if (addYearBtn) {
                addYearBtn.style.display = state.isAdmin ? '' : 'none';
            }
            
            // Sort years in descending order (newest first)
            const sortedYears = [...availableYears].sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const option = document.createElement('div');
                option.className = 'year-option';
                if (year === state.selectedYear) {
                    option.classList.add('active');
                }
                
                option.innerHTML = `<span>${year}</span>`;
                
                option.onclick = () => requestYearSwitch(year);
                container.appendChild(option);
            });
        }

        function toggleYearDropdown() {
            const dropdown = document.getElementById('year-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeYearDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeYearDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('year-dropdown');
            const btn = document.getElementById('year-selector-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeYearDropdownOnClickOutside);
            }
        }

        async function requestYearSwitch(newYear) {
            if (newYear === state.selectedYear) {
                toggleYearDropdown();
                return;
            }
            
            // Show warning dialog
            const confirmed = await showModernDialog(
                '‚ö†Ô∏è Switch Year',
                `Switch from <strong>${state.selectedYear}</strong> to <strong>${newYear}</strong>?<br><br>
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107; margin: 10px 0;">
                    <i class="fas fa-info-circle" style="color: #856404;"></i>
                    Your current ${state.selectedYear} data will remain saved.<br>
                    Any unsaved changes will be lost.
                </div>`,
                false  // Changed to false - this is NOT a dangerous action!
            );
            
            if (confirmed) {
                await switchYear(newYear);
            }
            
            toggleYearDropdown();
        }

        function filterProjectsByYear(projects, selectedYear) {
            // Filter projects to show only those active in the selected year
            return projects.filter(project => {
                // CORPORATE region is a permanent entity ‚Äî always include regardless of dates
                if (project.region === 'CORPORATE') return true;

                // Extract year from dateStarted (format: YYYY-MM-DD)
                const startYear = project.dateStarted ? parseInt(project.dateStarted.split('-')[0]) : null;
                
                // Extract year from dateFinished if it exists
                const finishedYear = project.dateFinished ? parseInt(project.dateFinished.split('-')[0]) : null;
                
                // If no start year, we can't determine if it should appear
                if (!startYear) return false;
                
                // Check if project is active in the selected year
                if (finishedYear) {
                    // Project has a finish date - show only from start year to finish year
                    return selectedYear >= startYear && selectedYear <= finishedYear;
                } else {
                    // Project is ongoing - show from start year onwards
                    return selectedYear >= startYear;
                }
            });
        }
        
        // ==================== DEVICE COUNTER & ACTIVE USERS DROPDOWNS ====================
        
        // ==================== CLEAR STALE PRESENCE/DEVICE DATA ====================
        async function clearStalePresenceData() {
            if (!state.isAdmin) return;

            const STALE_THRESHOLD = 2 * 60 * 1000; // 2 minutes
            const now = Date.now();
            let clearedCount = 0;

            try {
                // Clean stale presence entries
                const presenceData = state.activeUsers || {};
                for (const [uid, data] of Object.entries(presenceData)) {
                    const isStale = data.status === 'offline' ||
                        (data.lastSeen && (now - data.lastSeen) > STALE_THRESHOLD && data.status !== 'online');
                    const isOldOnline = data.status === 'online' && data.lastSeen && (now - data.lastSeen) > STALE_THRESHOLD;

                    if (isStale || isOldOnline) {
                        const ref = window.firebase.dbRef(window.firebaseRealtimeDb, `presence/${uid}`);
                        await window.firebase.remove(ref);
                        clearedCount++;
                    }
                }

                // Clean stale device entries
                const devicesData = state.activeDevices || [];
                for (const device of devicesData) {
                    const isStale = device.status === 'offline' ||
                        (device.lastSeen && (now - device.lastSeen) > STALE_THRESHOLD);
                    if (isStale && device.userId) {
                        const ref = window.firebase.dbRef(window.firebaseRealtimeDb, `devices/${device.userId}`);
                        await window.firebase.remove(ref);
                        clearedCount++;
                    }
                }

                showToast(`üßπ Cleared ${clearedCount} stale entr${clearedCount === 1 ? 'y' : 'ies'} from Firebase`, 'success');
                console.log(`‚úÖ Cleared ${clearedCount} stale presence/device entries`);
            } catch (err) {
                console.error('‚ùå Failed to clear stale data:', err);
                showToast('‚ùå Failed to clear stale data', 'error');
            }
        }

        function toggleDeviceDropdown() {
            const dropdown = document.getElementById('device-dropdown');
            const usersDropdown = document.getElementById('users-dropdown');
            
            // Close users dropdown if open
            if (usersDropdown && !usersDropdown.classList.contains('hidden')) {
                usersDropdown.classList.add('hidden');
            }
            
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeDeviceDropdownOnClickOutside);
                }, 0);
            }
        }
        
        function closeDeviceDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('device-dropdown');
            const btn = document.getElementById('device-counter-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeDeviceDropdownOnClickOutside);
            }
        }
        
        function toggleUsersDropdown() {
            const dropdown = document.getElementById('users-dropdown');
            const deviceDropdown = document.getElementById('device-dropdown');
            
            // Close device dropdown if open
            if (deviceDropdown && !deviceDropdown.classList.contains('hidden')) {
                deviceDropdown.classList.add('hidden');
            }
            
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUsersDropdownOnClickOutside);
                }, 0);
            }
        }
        
        function closeUsersDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('users-dropdown');
            const btn = document.getElementById('active-users-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeUsersDropdownOnClickOutside);
            }
        }

        async function switchYear(newYear) {
            debugLog('INFO', `üîÑ switchYear() called: ${state.selectedYear} ‚Üí ${newYear}`);
            
            const beforeCount = state.projects.length;
            const masterCount = state.masterProjects.length;
            
            // Update selected year
            const oldYear = state.selectedYear;
            state.selectedYear = newYear;
            localStorage.setItem('esh_selected_year', newYear);
            
            debugLog('DATA', 'Before filtering:', {
                masterProjects: masterCount,
                currentProjects: beforeCount,
                targetYear: newYear
            });
            
            // INSTANT: Just filter the master project list locally (no Firebase!)
            state.projects = filterProjectsByYear(state.masterProjects, newYear);
            ensureCorporateProject(); // Keep Corporate always present after year switch
            state.filteredProjects = [...state.projects];
            state.selectedProjects = [];
            
            // Clear search and filters when year changes
            state.searchTerm = '';
            state.regionFilter = '';
            state.statusFilter = '';
            
            const afterCount = state.projects.length;
            
            debugLog('SUCCESS', `‚úÖ Filtered to ${afterCount} projects for year ${newYear}`);
            debugLog('DATA', 'Projects shown:', state.projects.map(p => `${p.name} (${p.dateStarted || 'no date'})`));
            
            // Validate consistency
            if (afterCount > masterCount) {
                debugLog('ERROR', '‚ùå CRITICAL: More projects shown than in master list!');
            }
            
            // Update UI immediately
            updateYearDisplay();
            renderYearOptions();
            render();
            
            showToast(`‚úÖ Switched to year ${newYear}`, 'success');
            
            // Validate after switch
            const validation = validateState();
            if (!validation.isValid) {
                debugLog('WARNING', '‚ö†Ô∏è State validation issues after year switch:', validation.issues);
            }
        }

        // ========== NOTIFICATION BELL DROPDOWN ==========
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Update notifications when opened
            if (!dropdown.classList.contains('hidden')) {
                updateNotifications();
                setTimeout(() => {
                    document.addEventListener('click', closeNotificationDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeNotificationDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-bell-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeNotificationDropdownOnClickOutside);
            }
        }

        function updateNotifications() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth(); // 0-11
            window.updateNotifications = updateNotifications; // expose globally
            // Group overdue reports by project
            let projectOverdues = {};

            // Check each project for overdue reports
            state.projects.forEach(project => {
                let overdueTabs = [];

                // Check KPM reports (monthly)
                let hasKpmOverdue = false;
                const kpmRows = ['KPM&I'];
                kpmRows.forEach(row => {
                    const key = `kpm_${row}`;
                    for (let month = 0; month < currentMonth; month++) {
                        const value = project.vals[key] ? project.vals[key][month + 1] : '';
                        if (!value || value.toString().trim() === '') {
                            hasKpmOverdue = true;
                            break;
                        }
                    }
                });
                if (hasKpmOverdue) {
                    overdueTabs.push({ name: 'Monthly Report', tab: 'kpm' });
                }

                // Check Environmental Monthly Report (monthly)
                let hasEnvMonthlyOverdue = false;
                const envMonthlyRows = ['Environmental Monthly Report (EMR)'];
                envMonthlyRows.forEach(row => {
                    const key = `env-monthly-report_${row}`;
                    for (let month = 0; month < currentMonth; month++) {
                        const value = project.vals[key] ? project.vals[key][month + 1] : '';
                        if (!value || value.toString().trim() === '') {
                            hasEnvMonthlyOverdue = true;
                            break;
                        }
                    }
                });
                if (hasEnvMonthlyOverdue) {
                    overdueTabs.push({ name: 'Environmental Monthly Report', tab: 'env-monthly-report' });
                }

                // Check DOLE reports (monthly)
                let hasDoleOverdue = false;
                const doleRows = ['WAIR', 'RSO', 'MOM'];
                doleRows.forEach(row => {
                    const key = `dole_${row}`;
                    for (let month = 0; month < currentMonth; month++) {
                        const value = project.vals[key] ? project.vals[key][month + 1] : '';
                        if (!value || value.toString().trim() === '') {
                            hasDoleOverdue = true;
                            break;
                        }
                    }
                    if (hasDoleOverdue) return; // Exit early if found
                });
                if (hasDoleOverdue) {
                    overdueTabs.push({ name: 'DOLE Reportorial', tab: 'dole' });
                }

                // Check EMB reports (quarterly) - Due 15th of following month
                let hasEmbOverdue = false;
                const embRows = ['SMR (Quarterly) - Submission Date'];
                embRows.forEach(row => {
                    const key = `emb_${row}`;
                    for (let quarter = 1; quarter <= 4; quarter++) {
                        let isOverdue = false;
                        
                        // Special handling for Q4 (due January 15 of NEXT year)
                        if (quarter === 4) {
                            // Q4 of selectedYear is due January 15 of selectedYear+1
                            const deadlineYear = state.selectedYear + 1;
                            const currentYear = currentDate.getFullYear();
                            
                            if (currentYear > deadlineYear) {
                                isOverdue = true;
                            } else if (currentYear === deadlineYear) {
                                if (currentMonth === 0 && currentDate.getDate() > 15) {
                                    isOverdue = true;
                                } else if (currentMonth > 0) {
                                    isOverdue = true;
                                }
                            }
                            // If currentYear < deadlineYear, not overdue yet
                        } else {
                            // For Q1, Q2, Q3 - normal logic
                            const quarterEndMonth = (quarter * 3) - 1;
                            const deadlineMonth = (quarterEndMonth + 1) % 12;
                            
                            if (currentMonth > deadlineMonth || (currentMonth === deadlineMonth && currentDate.getDate() > 15)) {
                                isOverdue = true;
                            }
                        }
                        
                        if (isOverdue) {
                            const value = project.vals[key] ? project.vals[key][quarter] : '';
                            if (!value || value.toString().trim() === '') {
                                hasEmbOverdue = true;
                                break;
                            }
                        }
                    }
                });
                if (hasEmbOverdue) {
                    overdueTabs.push({ name: 'EMB Reportorial', tab: 'emb' });
                }

                // Check for missing DOE Safety Officer Permit (Renewable Energy projects only)
                if (project.isRenewable === true) {
                    const doePermitKey = 'doe-permit_DOE Safety Officer Permit';
                    const permitNumber = project.vals[doePermitKey] ? project.vals[doePermitKey][1] : '';
                    const validUntil = project.vals[doePermitKey] ? project.vals[doePermitKey][2] : '';
                    
                    if (!permitNumber || permitNumber.trim() === '' || !validUntil || validUntil.trim() === '') {
                        overdueTabs.push({ name: 'DOE Safety Officer Permit (Missing)', tab: 'doe-permit' });
                    }
                }

                // Check for missing Certificate of Registration
                const certKey = 'permits_Certificate of Registration';
                const certNumber = project.vals[certKey] ? project.vals[certKey][1] : '';
                const certIssued = project.vals[certKey] ? project.vals[certKey][2] : '';
                const certExpiry = project.vals[certKey] ? project.vals[certKey][3] : '';
                
                if (!certNumber || certNumber.trim() === '' || !certIssued || certIssued.trim() === '' || !certExpiry || certExpiry.trim() === '') {
                    overdueTabs.push({ name: 'Certificate of Registration (Missing)', tab: 'permits' });
                }

                // Check for missing CSHP
                const cshpKey = 'cshp_CSHP Approval Date';
                const cshpDate = project.vals[cshpKey] ? project.vals[cshpKey][1] : '';
                
                if (!cshpDate || cshpDate.trim() === '') {
                    overdueTabs.push({ name: 'CSHP (Missing)', tab: 'cshp' });
                }

                // ‚îÄ‚îÄ OSH Personnel Requirement Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Only check if manpower has been entered for this project
                if (state.oshData && state.oshData[project.name]) {
                    const oshEntry = state.oshData[project.name];
                    const manpower = parseInt(oshEntry.manpower) || 0;
                    if (manpower > 0) {
                        const req = computeOshRequirements(manpower);
                        if (req) {
                            // Count actual OSH personnel from registry
                            const actual = countActualOshPersonnel(project.name);
                            const deficiencies = [];
                            if (req.firstAider   > 0 && actual.firstAider   < req.firstAider)   deficiencies.push(`First Aider (${actual.firstAider}/${req.firstAider})`);
                            if (req.safetyOfficer > 0 && actual.safetyOfficer < req.safetyOfficer) deficiencies.push(`Safety Officer (${actual.safetyOfficer}/${req.safetyOfficer})`);
                            if (req.ohNurse      > 0 && actual.ohNurse      < req.ohNurse)      deficiencies.push(`OH Nurse (${actual.ohNurse}/${req.ohNurse})`);
                            if (req.ohDentist    > 0 && actual.ohDentist    < req.ohDentist)    deficiencies.push(`OH Dentist (${actual.ohDentist}/${req.ohDentist})`);
                            if (req.ohPhysician  > 0 && actual.ohPhysician  < req.ohPhysician)  deficiencies.push(`OH Physician (${actual.ohPhysician}/${req.ohPhysician})`);

                            if (deficiencies.length > 0) {
                                overdueTabs.push({
                                    name: `OSH Deficiency: ${deficiencies.join(', ')}`,
                                    tab: 'osh-requirement',
                                    isOsh: true
                                });
                            }
                        }
                    }
                }
                // ‚îÄ‚îÄ End OSH Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                // Add to project overdues if any tabs have overdue reports
                if (overdueTabs.length > 0) {
                    projectOverdues[project.name] = overdueTabs;
                }
            });

            // Count total issues (not just projects)
            let totalIssues = 0;
            Object.keys(projectOverdues).forEach(projectName => {
                totalIssues += projectOverdues[projectName].length;
            });
            
            // Update badge
            const badge = document.getElementById('notification-badge');
            if (totalIssues > 0) {
                badge.textContent = totalIssues > 99 ? '99+' : totalIssues;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Update notification list
            const notificationList = document.getElementById('notification-list');
            const totalProjects = Object.keys(projectOverdues).length;
            if (totalIssues === 0) {
                notificationList.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-check-circle"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">All caught up!</div>
                        <div>No overdue reports or missing permits.</div>
                    </div>
                `;
            } else {
                let html = '';
                
                // Add hover effect CSS
                html += `
                    <style>
                    </style>
                `;
                
                // Sort project names alphabetically for consistent notification display
                const sortedProjectNames = Object.keys(projectOverdues).sort((a, b) => a.localeCompare(b));
                
                // Display each project with overdue tabs
                sortedProjectNames.forEach(projectName => {
                    const tabs = projectOverdues[projectName];
                    
                    // Create separate notification item for each overdue report
                    tabs.forEach(tabInfo => {
                        const isMissing = tabInfo.name.includes('Missing');
                        const isOsh = tabInfo.isOsh === true;
                        const iconClass = isOsh ? 'fa-shield-halved' : isMissing ? 'fa-exclamation-triangle' : 'fa-file-circle-exclamation';
                        const statusText = isOsh ? 'OSH Deficient' : isMissing ? 'Missing' : 'Overdue';
                        const statusColor = isOsh ? '#e65100' : isMissing ? '#d32f2f' : '#ff6f00';
                        const displayName = isOsh ? tabInfo.name.replace('OSH Deficiency: ', '') : tabInfo.name.replace(' (Missing)', '');
                        
                        html += `
                            <div class="notification-item" onclick="redirectToProjectTable('${projectName}', '${tabInfo.tab}')">
                                <div class="notif-icon-box" ${isOsh ? 'style="background:rgba(230,81,0,0.1);color:#e65100;"' : ''}>
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div style="flex:1; min-width:0;">
                                    <div class="notification-project">
                                        <i class="fas fa-building" style="font-size:0.7rem; margin-right:4px;"></i>${projectName}
                                    </div>
                                    <div class="notification-message">
                                        <strong style="color:${statusColor};">${statusText}:</strong> ${displayName}
                                    </div>
                                    <div style="font-size:0.68rem; color:#2e7d32; font-weight:600; margin-top:4px;">
                                        <i class="fas fa-hand-pointer" style="font-size:0.6rem"></i> Click to view
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
                
                notificationList.innerHTML = html;
            }
        }

        function redirectToProjectTable(projectName, tabName) {
            // Close notification dropdown
            document.getElementById('notification-dropdown').classList.add('hidden');
            
            // Change to the appropriate tab
            changeTab(tabName);
            
            // Filter/search for the specific project
            setTimeout(() => {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = projectName;
                    // Trigger search/filter
                    if (typeof filterProjects === 'function') {
                        filterProjects();
                    }
                }
                
                // Show toast
                showToast(`üìã Viewing "${projectName}" in ${getTabLabel(tabName)}`, 'info');
            }, 100);
        }
        
        function getTabLabel(tabName) {
            const labels = {
                'kpm': 'Monthly Report',
                'dole': 'DOLE Reportorial',
                'emb': 'EMB Reportorial',
                'env-monthly-report': 'Environmental Monthly Report'
            };
            return labels[tabName] || tabName;
        }

        function redirectToTab(tabName) {
            // Close notification dropdown
            document.getElementById('notification-dropdown').classList.add('hidden');
            
            // Change to the appropriate tab
            changeTab(tabName);
            
            // Show toast
            const tabLabels = {
                'kpm': 'Monthly Report',
                'dole': 'DOLE Reportorial',
                'emb': 'EMB Reportorial',
                'env-monthly-report': 'Environmental Monthly Report'
            };
            showToast(`üìã Viewing ${tabLabels[tabName]} - Check overdue reports`, 'info');
        }

        function closeNotificationAndView(projectName) {
            // Close notification dropdown
            document.getElementById('notification-dropdown').classList.add('hidden');
            
            // Go to overall dashboard
            changeTab('overall');
            
            // Show toast
            showToast(`üìã Viewing overdue reports for: ${projectName}`, 'info');
        }

        // ========== SETTINGS DROPDOWN ==========
        function toggleSettingsDropdown() {
            const dropdown = document.getElementById('settings-dropdown-menu');
            dropdown.classList.toggle('hidden');
            
            // Update theme icon/text
            updateSettingsThemeDisplay();
            
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeSettingsDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeSettingsDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('settings-dropdown-menu');
            const btn = document.getElementById('settings-dropdown-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeSettingsDropdownOnClickOutside);
            }
        }

        function updateSettingsThemeDisplay() {
            const icon = document.getElementById('settings-theme-icon');
            const text = document.getElementById('settings-theme-text');
            const isDark = document.body.classList.contains('dark-mode');
            
            if (icon && text) {
                if (isDark) {
                    icon.className = 'fas fa-sun';
                    text.textContent = 'Light Mode';
                } else {
                    icon.className = 'fas fa-moon';
                    text.textContent = 'Dark Mode';
                }
            }
        }

        function toggleDarkModeFromMenu() {
            toggleDarkMode();
            updateSettingsThemeDisplay();
            // Don't close dropdown so user sees the change
        }

        function openSettingsTab() {
            document.getElementById('settings-dropdown-menu').classList.add('hidden');
            changeTab('settings');
        }

        function handleLogoutFromMenu() {
            document.getElementById('settings-dropdown-menu').classList.add('hidden');
            handleLogout();
        }

        function updateYearDisplay() {
            const yearBtn = document.getElementById('year-selector-btn');
            if (yearBtn) {
                yearBtn.title = `Select Year`;
                const label = document.getElementById('year-selector-label');
                if (label) label.textContent = state.selectedYear;
            }
            
            // Update settings page year displays
            const settingsCurrentYear = document.getElementById('settings-current-year');
            const targetYearDisplay = document.getElementById('target-year-display');
            const exportYearDisplay = document.getElementById('export-year-display');
            
            if (settingsCurrentYear) settingsCurrentYear.textContent = state.selectedYear;
            if (targetYearDisplay) targetYearDisplay.textContent = state.selectedYear;
            if (exportYearDisplay) exportYearDisplay.textContent = state.selectedYear;
            
            // Populate source year dropdown (exclude current year)
            const sourceYearSelect = document.getElementById('source-year-select');
            if (sourceYearSelect) {
                sourceYearSelect.innerHTML = '<option value="">Select source year...</option>';
                const otherYears = availableYears.filter(y => y !== state.selectedYear).sort((a, b) => b - a);
                otherYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    sourceYearSelect.appendChild(option);
                });
            }
        }

        // Copy data from another year to current year
        async function copyDataFromYear() {
            if (!firebaseReady || !window.firebaseDb) {
                showToast('‚ö†Ô∏è Firebase not ready. Please try again.', 'warning');
                return;
            }
            
            const sourceYearSelect = document.getElementById('source-year-select');
            const sourceYear = parseInt(sourceYearSelect.value);
            
            if (!sourceYear) {
                showToast('‚ö†Ô∏è Please select a source year', 'warning');
                return;
            }
            
            const currentYear = state.selectedYear;
            
            // Confirm action
            const confirmed = await showModernDialog(
                'üìã Copy Data',
                `Copy all data from <strong>${sourceYear}</strong> to <strong>${currentYear}</strong>?<br><br>
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107; margin: 10px 0;">
                    <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                    This will <strong>replace all existing ${currentYear} data</strong> with ${sourceYear} data.<br>
                    Projects, personnel, and incident data will be copied.
                </div>`,
                true
            );
            
            if (!confirmed) return;
            
            try {
                showToast(`üìã Copying data from ${sourceYear}...`, 'info');
                
                // Load source year data from Firebase
                const userId = getCurrentUserId();
                const sourceYearRef = window.firebase.doc(window.firebaseDb, 'users', userId, 'years', sourceYear.toString());
                const sourceYearSnap = await window.firebase.getDoc(sourceYearRef);
                
                if (!sourceYearSnap.exists()) {
                    showToast(`‚ùå No data found for year ${sourceYear}`, 'error');
                    return;
                }
                
                const sourceData = sourceYearSnap.data();
                
                // Copy data to current state
                state.projects = JSON.parse(JSON.stringify(sourceData.projects || []));
                state.personnelData = JSON.parse(JSON.stringify(sourceData.personnelData || []));
                state.incidentRateData = JSON.parse(JSON.stringify(sourceData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 }));
                state.oshData = sourceData.oshData || {};
                state.filteredProjects = [...state.projects];
                
                // Save to current year
                await saveToFirebase();
                
                // Update UI
                render();
                renderPTable();
                
                showToast(`‚úÖ Successfully copied data from ${sourceYear} to ${currentYear}!`, 'success');
                
                // Reset dropdown
                sourceYearSelect.value = '';
                
            } catch (error) {
                console.error('‚ùå Error copying data:', error);
                showToast('‚ùå Failed to copy data: ' + error.message, 'error');
            }
        }

        // Export current year data to Excel (CSV format)
        async function exportYearToExcel() {
            const year = state.selectedYear;
            
            showToast(`üìä Generating export for ${year}...`, 'info');
            
            try {
                // Create CSV content
                let csvContent = `ESH COMPLIANCE DASHBOARD - YEAR ${year}\n`;
                csvContent += `Export Date: ${new Date().toLocaleString()}\n`;
                csvContent += `Total Projects: ${state.projects.length}\n`;
                csvContent += `Total Personnel: ${state.personnelData.length}\n\n`;
                
                // Projects data
                csvContent += `PROJECTS\n`;
                csvContent += `Project Name,Region,Date Started,Date Finished,Status\n`;
                
                state.projects.forEach(project => {
                    const name = `"${(project.name || '').replace(/"/g, '""')}"`;
                    const region = project.region || '';
                    const started = project.dateStarted || '';
                    const finished = project.dateFinished || '';
                    const status = project.status || '';
                    csvContent += `${name},${region},${started},${finished},${status}\n`;
                });
                
                csvContent += `\n`;
                
                // Personnel data
                csvContent += `PERSONNEL\n`;
                csvContent += `Name,Position,Gender,Region\n`;
                
                state.personnelData.forEach(person => {
                    const name = `"${(person.name || '').replace(/"/g, '""')}"`;
                    const position = `"${(person.position || '').replace(/"/g, '""')}"`;
                    const gender = person.gender || '';
                    const region = person.region || '';
                    csvContent += `${name},${position},${gender},${region}\n`;
                });
                
                csvContent += `\n`;
                
                // Incident Rate data
                csvContent += `INCIDENT RATE DATA\n`;
                csvContent += `Recordable Cases,Lost Days,Total Hours\n`;
                csvContent += `${state.incidentRateData.recordableCases || 0},${state.incidentRateData.lostDays || 0},${state.incidentRateData.totalHours || 0}\n`;
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `ESH_Dashboard_${year}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`‚úÖ Data for ${year} exported successfully!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showToast('‚ùå Failed to export: ' + error.message, 'error');
            }
        }

        function showAddYearDialog() {
            if (!state.isAdmin) {
                showToast('‚õî Only admins can add years.', 'error');
                return;
            }
            const customYear = prompt('Enter a custom year (e.g., 2040):');
            if (!customYear) return;
            
            const year = parseInt(customYear);
            if (isNaN(year) || year < 2000 || year > 2100) {
                showToast('‚ùå Invalid year. Please enter a year between 2000-2100.', 'error');
                return;
            }
            
            if (availableYears.includes(year)) {
                showToast(`‚ö†Ô∏è Year ${year} already exists.`, 'warning');
                return;
            }
            
            availableYears.push(year);
            availableYears.sort((a, b) => a - b);
            renderYearOptions();
            showToast(`‚úÖ Year ${year} added successfully!`, 'success');
        }

        // ===== LOGIN & AUTH =====
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-user').value.trim();
            const password = document.getElementById('login-pass').value;
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            errorDiv.innerText = '';

            if (!email || !password) {
                errorDiv.innerText = '‚ö†Ô∏è Please enter both email and password';
                return;
            }

            // Security: Email domain validation for SCIC and Superintendents
            const validDomains = [
                '@scic.com.ph',
                '@staclara.com.ph',
                '@ncr.com.ph',
                '@north.com.ph',
                '@south.com.ph',
                '@vismin.com.ph',
                '@ncrpco.com.ph',
                '@southpco.com.ph',
                '@northpco.com.ph',
                '@visminpco.com.ph'
            ];
            
            const emailLower = email.toLowerCase();
            const isValidDomain = validDomains.some(domain => emailLower.endsWith(domain));
            
            if (!isValidDomain) {
                errorDiv.innerText = '‚ö†Ô∏è Access restricted to authorized email addresses only';
                return;
            }

            // Wait for Firebase to be ready
            if (!window.firebase || !window.firebaseAuth) {
                errorDiv.innerText = 'üõ°Ô∏è Securing workspace, please try again...';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading-spinner"></span> Signing in...';

            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                state.currentUser = { email: user.email, uid: user.uid };
                state.isLoggedIn = true;
                console.log('‚úÖ Firebase login successful:', user.email);
                // showUI() will be called by onAuthStateChanged observer
            } catch (error) {
                console.error('‚ùå Firebase login error:', error);
                let msg = '‚ùå Invalid email or password';
                if (error.code === 'auth/user-not-found') msg = '‚ùå No account found with this email';
                else if (error.code === 'auth/wrong-password') msg = '‚ùå Incorrect password';
                else if (error.code === 'auth/invalid-email') msg = '‚ùå Invalid email address';
                else if (error.code === 'auth/too-many-requests') msg = '‚ùå Too many attempts. Try again later.';
                else if (error.code === 'auth/network-request-failed') msg = '‚ùå Network error. Check your connection.';
                errorDiv.innerText = msg;
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }
        }

      function handleLogout() {
    showModernDialog('Logout Confirmation', 'Are you sure you want to logout?').then(async confirmed => {
        if (confirmed) {
            if (state.currentUser) {
                await LoginLogbook.logLogout(state.currentUser);
            }
            // Clear session timer and saved tab on logout
            localStorage.removeItem('esh_session_start');
            localStorage.removeItem('esh_last_tab');
            backupManager.stopAutoSave();
            state.isLoggedIn = false;
            state.currentUser = null;
            await firebaseLogout();
            location.reload();
        }
    });
}

function handleUserBadgeClick() {
    if (state.isAdmin) {
        changeTab('admin');
    }
}

function openAdminQuickView() {
    changeTab('admin');
}


        function loadUserData(email) {
            const year = state.selectedYear || 2026;
            // FIX: Use year-based key to match save function
            const storageKey = `esh_dashboard_${year}_${email}`;
            const savedData = localStorage.getItem(storageKey);

            if (savedData) {
                const data = JSON.parse(savedData);
                state.projects = data.projects || [];
                state.personnelData = data.personnelData || [];
                state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.oshData = data.oshData || {};
                state.currentSort = data.currentSort || 'name';
            } else {
                initializeUserProjects(email);
            }
            state.filteredProjects = [...state.projects];
        }

        function initializeUserProjects(email) {
            // Start with empty projects - users will add their own
            state.projects = [];
            state.filteredProjects = [];
            saveUserData(email);
            console.log('‚úÖ Initialized with empty projects - ready for user to add projects');
        }

        function saveUserData(email) {
            if (!email) return;
            const year = state.selectedYear || 2026;
            // FIX: Use year-based key to match the load function (esh_dashboard_${year}_${email})
            const storageKey = `esh_dashboard_${year}_${email}`;
            const data = {
                year: year,
                projects: state.projects.map(p => {
                    const copy = { ...p };
                    delete copy.selected;
                    return copy;
                }),
                personnelData: state.personnelData || [],
                incidentRateData: state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
                oshData: state.oshData || {},
                currentSort: state.currentSort,
                lastSaved: new Date().toISOString(),
                timestamp: Date.now()
            };
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function sortProjects(sortBy) {
            state.currentSort = sortBy;
            state.projects.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'dateStarted') {
                    const da = new Date(a.dateStarted || '9999-12-31');
                    const db = new Date(b.dateStarted || '9999-12-31');
                    return da - db;
                }
                if (sortBy === 'dateFinished') {
                    const da = new Date(a.dateFinished || '9999-12-31');
                    const db = new Date(b.dateFinished || '9999-12-31');
                    return da - db;
                }
                return 0;
            });
            
            // Reapply current filters after sorting instead of just copying all projects
            reapplyFilters();
            
            saveUserData(state.currentUser?.email);
            render();
        }

        function openAddProjectModal(region) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectNameInput').value = '';
            document.getElementById('projectDateStarted').value = '';
            document.getElementById('projectDateStarted').max = today;
            document.getElementById('projectDateFinished').value = '';
            document.getElementById('projectDateFinished').max = today;
            document.getElementById('projectRegion').value = region || '';
            document.getElementById('projectModalError').innerText = '';
            onProjectRegionChange(region || ''); // Show/hide date fields based on region
            document.getElementById('addProjectModal').classList.add('show');
        }

        function onProjectRegionChange(region) {
            const dateFields = document.getElementById('projectDateFields');
            const dateStarted = document.getElementById('projectDateStarted');
            if (!dateFields) return;
            if (region === 'CORPORATE') {
                dateFields.style.display = 'none';
                dateStarted.removeAttribute('required');
            } else {
                dateFields.style.display = '';
                dateStarted.setAttribute('required', '');
            }
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('show');
        }

        // ==================== CUSTOM CONFIRMATION MODAL FUNCTIONS ====================
        let confirmModalResolve = null;

        function showConfirmModal() {
            return new Promise((resolve) => {
                confirmModalResolve = resolve;
                const modal = document.getElementById('confirmModal');
                modal.classList.add('show');
            });
        }

        function closeConfirmModal(confirmed) {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
            if (confirmModalResolve) {
                confirmModalResolve(confirmed);
                confirmModalResolve = null;
            }
        }

        // Close modal when clicking outside (optional)
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('confirmModal');
            if (e.target === modal) {
                closeConfirmModal(false);
            }
        });

        // Keyboard support for confirmation modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('confirmModal');
            if (modal && modal.classList.contains('show')) {
                if (e.key === 'Escape') {
                    closeConfirmModal(false);
                } else if (e.key === 'Enter') {
                    closeConfirmModal(true);
                }
            }
        });

        // ==================== SUCCESS MODAL FUNCTIONS ====================
        let countdownInterval = null;
        let logoutTimeout = null;

        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('show');
            
            // Start countdown
            let seconds = 3;
            const countdownEl = document.getElementById('countdown-timer');
            countdownEl.textContent = seconds;
            
            countdownInterval = setInterval(() => {
                seconds--;
                if (seconds >= 0) {
                    countdownEl.textContent = seconds;
                }
            }, 1000);
            
            // Auto-logout after 3 seconds
            logoutTimeout = setTimeout(async () => {
                await firebaseLogout();
                location.reload();
            }, 3000);
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('show');
            
            // Clear timers
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (logoutTimeout) {
                clearTimeout(logoutTimeout);
                logoutTimeout = null;
            }
            
            // Logout immediately
            firebaseLogout().then(() => {
                location.reload();
            });
        }

        // Keyboard support for success modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('successModal');
            if (modal && modal.classList.contains('show')) {
                if (e.key === 'Enter' || e.key === 'Escape') {
                    closeSuccessModal();
                }
            }
        });

        function confirmAddProject() {
            const name = document.getElementById('projectNameInput').value.trim();
            const dateStarted = document.getElementById('projectDateStarted').value;
            const dateFinished = document.getElementById('projectDateFinished').value;
            const region = document.getElementById('projectRegion').value;
            const isRenewable = document.getElementById('projectIsRenewable').checked;
            const errorDiv = document.getElementById('projectModalError');

            errorDiv.innerText = '';

            if (!name) { errorDiv.innerText = '‚ö†Ô∏è Project name is required'; return; }
            if (!region) { errorDiv.innerText = '‚ö†Ô∏è Region is required'; return; }
            const today = new Date().toISOString().split('T')[0];
            if (region !== 'CORPORATE') {
                if (!dateStarted) { errorDiv.innerText = '‚ö†Ô∏è Date started is required'; return; }
                if (dateStarted > today) { errorDiv.innerText = '‚ö†Ô∏è Date started cannot be a future date'; return; }
                if (dateFinished && dateFinished > today) { errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be a future date'; return; }
                if (dateFinished && new Date(dateFinished) < new Date(dateStarted)) {
                    errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be before date started'; return;
                }
            }
            if (state.projects.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                errorDiv.innerText = '‚ö†Ô∏è Project name already exists'; return;
            }

            // RBAC: Non-admins can only add projects in their assigned region
            const rbacAdd = UserAccounts.checkPermission(state.currentUser?.email, 'create', region, state.currentTab);
            if (!rbacAdd.allowed) {
                errorDiv.innerText = rbacAdd.reason.replace('403: ', '‚ö†Ô∏è ');
                return;
            }
            // PCO cannot add projects at all (environmental data only, not projects)
            if (UserAccounts.isPCO(state.currentUser?.email)) {
                errorDiv.innerText = '‚ö†Ô∏è PCO accounts cannot add new projects. Contact your Administrator.';
                return;
            }

            const newProject = {
    name, region, status: 'on-going',
    dateStarted, dateFinished, 
    isRenewable: isRenewable,
    vals: {}, selected: false,
    doePdfFiles: {},
    auditData: {
        Q1: { scoreImpl: 0, docuComp: 0 },
        Q2: { scoreImpl: 0, docuComp: 0 },
        Q3: { scoreImpl: 0, docuComp: 0 },
        Q4: { scoreImpl: 0, docuComp: 0 }
    }
};
            state.projects.push(newProject);

            // FIX: Also add to masterProjects immediately so saveToFirebase() includes it
            const masterIdx = state.masterProjects.findIndex(p => p.name === name);
            if (masterIdx >= 0) {
                state.masterProjects[masterIdx] = newProject;
            } else {
                state.masterProjects.push(newProject);
            }

            sortProjects(state.currentSort);
            reapplyFilters(); // Reapply current filters
            saveUserData(state.currentUser.email); // Save to localStorage immediately
            closeAddProjectModal();
            render();

            // FIX: Also save to Firebase immediately so it persists on refresh
            showSyncPill('syncing', 'Saving new project to cloud...');
            saveToFirebaseWithRetry().then(success => {
                if (success) {
                    markSyncComplete();
                } else {
                    markSyncFailed();
                    showToast('Project saved locally but cloud sync failed. Will retry when connection improves.', 'warning');
                }
            }).catch(() => markSyncFailed());
            
            if (isRenewable) {
                showToast(`Project "${name}" added as Renewable Energy project`, 'success');
            } else {
                showToast(`Project "${name}" added successfully`, 'success');
            }
        }

        // Edit Project Modal Functions
        let editingProjectOriginalName = '';

        function openEditProjectModal(projectName, currentRegion) {
            const project = state.projects.find(p => p.name === projectName);
            if (!project) return;

            editingProjectOriginalName = projectName;
            
            // Set today's date as max for both date fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('editProjectDateStarted').setAttribute('max', today);
            document.getElementById('editProjectDateFinished').setAttribute('max', today);
            
            document.getElementById('editProjectNameInput').value = project.name;
            document.getElementById('editProjectDateStarted').value = project.dateStarted || '';
            document.getElementById('editProjectDateFinished').value = project.dateFinished || '';
            document.getElementById('editProjectRegion').value = project.region;
            document.getElementById('editProjectIsRenewable').checked = project.isRenewable || false;
            document.getElementById('editProjectModalError').innerText = '';
            document.getElementById('editProjectModal').classList.add('show');
        }

        function closeEditProjectModal() {
            document.getElementById('editProjectModal').classList.remove('show');
            editingProjectOriginalName = '';
        }

        function confirmEditProject() {
            const newName = document.getElementById('editProjectNameInput').value.trim();
            const dateStarted = document.getElementById('editProjectDateStarted').value;
            const dateFinished = document.getElementById('editProjectDateFinished').value;
            const newRegion = document.getElementById('editProjectRegion').value;
            const isRenewable = document.getElementById('editProjectIsRenewable').checked;
            const errorDiv = document.getElementById('editProjectModalError');

            errorDiv.innerText = '';

            if (!newName) { errorDiv.innerText = '‚ö†Ô∏è Project name is required'; return; }
            if (!dateStarted) { errorDiv.innerText = '‚ö†Ô∏è Date started is required'; return; }
            if (!newRegion) { errorDiv.innerText = '‚ö†Ô∏è Region is required'; return; }
            
            // Validate date finished
            if (dateFinished) {
                const finishedDate = new Date(dateFinished);
                const startDate = new Date(dateStarted);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to compare dates only
                
                if (finishedDate < startDate) {
                    errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be before date started'; 
                    return;
                }
                
                if (finishedDate > today) {
                    errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be in the future'; 
                    return;
                }
            }
            
            // Check if new name conflicts with another project (but allow keeping the same name)
            if (newName.toLowerCase() !== editingProjectOriginalName.toLowerCase()) {
                if (state.projects.some(p => p.name.toLowerCase() === newName.toLowerCase())) {
                    errorDiv.innerText = '‚ö†Ô∏è Project name already exists'; 
                    return;
                }
            }

            // Find and update the project
            const project = state.projects.find(p => p.name === editingProjectOriginalName);
            if (project) {
                project.name = newName;
                project.dateStarted = dateStarted;
                project.dateFinished = dateFinished;
                project.region = newRegion;
                project.isRenewable = isRenewable;
                
                // Auto-update status based on dateFinished
                if (dateFinished) {
                    project.status = 'finished';
                } else if (project.status === 'finished') {
                    // If removing finish date and was finished, set back to on-going
                    project.status = 'on-going';
                }

                // Also update masterProjects immediately
                const mIdx = state.masterProjects.findIndex(p => p.name === editingProjectOriginalName);
                if (mIdx >= 0) state.masterProjects[mIdx] = project;

                sortProjects(state.currentSort);
                reapplyFilters();
                saveUserData(state.currentUser.email);
                closeEditProjectModal();
                render();

                // FIX: Save to Firebase immediately
                showSyncPill('syncing', 'Saving to cloud...');
                saveToFirebaseWithRetry().then(s => s ? markSyncComplete() : markSyncFailed()).catch(() => markSyncFailed());
                showToast(`Project updated${isRenewable ? ' (Renewable Energy)' : ''}`, 'success');
            }
        }

        function handleSearch() {
            try {
                const searchInput = document.getElementById('search-input');
                const regionFilter = document.getElementById('region-filter');
                const statusFilter = document.getElementById('status-filter');
                
                // Check if elements exist
                if (!searchInput || !regionFilter || !statusFilter) {
                    return;
                }
                
                // Store current focus
                const activeElement = document.activeElement;
                const cursorPosition = searchInput.selectionStart;
                
                const search = searchInput.value.toLowerCase().trim();
                const region = regionFilter.value;
                const status = statusFilter.value;

                // Save filter values to state
                state.searchTerm = searchInput.value;
                state.regionFilter = region;
                state.statusFilter = status;

                // Start with all projects
                let filtered = [...state.projects];
                
                // Apply search filter
                if (search) {
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(search)
                    );
                }
                
                // Apply region filter (only if not empty/All Regions)
                if (region && region !== '') {
                    filtered = filtered.filter(p => p.region === region);
                }
                
                // Apply status filter (only if not empty/All Status)
                if (status && status !== '') {
                    filtered = filtered.filter(p => p.status === status);
                }
                
                state.filteredProjects = filtered;
                
                render();
                
                // Restore focus and cursor position
                if (activeElement && activeElement.id === 'search-input') {
                    const newSearchInput = document.getElementById('search-input');
                    if (newSearchInput) {
                        newSearchInput.focus();
                        newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                    }
                }
            } catch (error) {
                console.error('Error in handleSearch:', error);
            }
        }

        function handleFilter() { 
            handleSearch(); 
        }

        // Reapply current filters to the project list (useful after add/edit/delete)
        function reapplyFilters() {
            const search = state.searchTerm.toLowerCase().trim();
            const region = state.regionFilter;
            const status = state.statusFilter;

            let filtered = [...state.projects];
            
            // Apply search filter
            if (search) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(search)
                );
            }
            
            // Apply region filter
            if (region && region !== '') {
                filtered = filtered.filter(p => p.region === region);
            }
            
            // Apply status filter
            if (status && status !== '') {
                filtered = filtered.filter(p => p.status === status);
            }
            
            state.filteredProjects = filtered;
        }

        function toggleEdit() {
            state.isEditing = true;
            
            // Update floating button to SAVE mode
            const floatingBtn = document.getElementById('floating-edit-btn');
            const floatingIcon = document.getElementById('floating-edit-icon');
            const floatingTooltip = document.getElementById('floating-edit-tooltip');
            
            if (floatingBtn) {
                floatingBtn.classList.add('save-mode');
                floatingBtn.setAttribute('onclick', 'saveData()');
                floatingBtn.setAttribute('title', 'Save Changes');
            }
            if (floatingIcon) {
                floatingIcon.className = 'fas fa-save';
            }
            if (floatingTooltip) {
                floatingTooltip.textContent = 'Click to Save';
            }
            
            render();
        }

        async function saveData() {
            const floatingBtn = document.getElementById('floating-edit-btn');
            const floatingIcon = document.getElementById('floating-edit-icon');
            const floatingTooltip = document.getElementById('floating-edit-tooltip');
            
            // Disable editing mode UI
            state.isEditing = false;
            
            // Show saving state on floating button
            if (floatingBtn) {
                floatingBtn.style.pointerEvents = 'none';
                floatingBtn.style.opacity = '0.6';
            }
            if (floatingIcon) {
                floatingIcon.className = 'fas fa-spinner fa-spin';
            }
            if (floatingTooltip) {
                floatingTooltip.textContent = 'Saving...';
            }
            
            // Save to localStorage first (instant, no network)
            saveUserData(state.currentUser.email);
            markPendingSync();

            // Show syncing pill
            showSyncPill('syncing', 'Syncing to cloud...');
            
            // Then sync to Firebase (with offline fallback)
            let success = false;
            if (!navigator.onLine) {
                // Offline: queue the save, localStorage already has it
                state.offlineQueue = state.offlineQueue || [];
                state.offlineQueue.push({ id: Date.now(), action: 'SAVE_ALL', timestamp: new Date().toISOString() });
                localStorage.setItem('esh_offline_queue', JSON.stringify(state.offlineQueue));
                success = true; // treat as success since localStorage is saved
                showSyncPill('offline', 'üìµ Offline ‚Äî saved locally, will sync later');
                hideSyncPill(4000);
                showToast('Saved locally. Will sync to cloud when back online.', 'warning');
            } else {
                success = await saveToFirebaseWithRetry();
                if (!success) {
                    // Firebase failed but localStorage is saved ‚Äî queue for retry
                    state.offlineQueue = state.offlineQueue || [];
                    state.offlineQueue.push({ id: Date.now(), action: 'SAVE_ALL', timestamp: new Date().toISOString() });
                    localStorage.setItem('esh_offline_queue', JSON.stringify(state.offlineQueue));
                    markSyncFailed();
                    showToast('Cloud save failed ‚Äî saved locally. Will retry automatically.', 'warning');
                    success = true; // don't block UI ‚Äî local is saved
                } else {
                    markSyncComplete();
                }
            }
            
            if (success) {
                // Success state
                if (floatingIcon) floatingIcon.className = 'fas fa-check';
                if (floatingTooltip) floatingTooltip.textContent = 'Saved!';
                if (navigator.onLine) showToast('Data saved & synced to cloud!', 'success');
                
                setTimeout(() => {
                    // Return to EDIT mode
                    if (floatingBtn) {
                        floatingBtn.classList.remove('save-mode');
                        floatingBtn.setAttribute('onclick', 'toggleEdit()');
                        floatingBtn.setAttribute('title', 'Edit Mode');
                        floatingBtn.style.pointerEvents = 'auto';
                        floatingBtn.style.opacity = '1';
                    }
                    if (floatingIcon) floatingIcon.className = 'fas fa-edit';
                    if (floatingTooltip) floatingTooltip.textContent = 'Click to Edit';
                    render();
                }, 400);
            } else {
                // Failure state
                if (floatingIcon) floatingIcon.className = 'fas fa-times';
                if (floatingTooltip) floatingTooltip.textContent = 'Failed!';
                showToast('Failed to save data. Please try again.', 'error');
                
                setTimeout(() => {
                    // Return to EDIT mode
                    if (floatingBtn) {
                        floatingBtn.classList.remove('save-mode');
                        floatingBtn.setAttribute('onclick', 'toggleEdit()');
                        floatingBtn.setAttribute('title', 'Edit Mode');
                        floatingBtn.style.pointerEvents = 'auto';
                        floatingBtn.style.opacity = '1';
                    }
                    if (floatingIcon) floatingIcon.className = 'fas fa-edit';
                    if (floatingTooltip) floatingTooltip.textContent = 'Click to Edit';
                    render();
                }, 800);
            }
            
            console.log('üíæ Data saved to localStorage and synced to Firebase');
        }

        // Toggle navigation group expand/collapse
        function toggleNavGroup(header) {
            const items = header.nextElementSibling;
            const isCollapsed = items.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                items.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                // Collapse
                items.classList.add('collapsed');
                header.classList.add('collapsed');
            }
            
            // Save state to localStorage
            // Store true if expanded, false if collapsed
            const groupName = header.querySelector('span').textContent.trim();
            const navGroupStates = JSON.parse(localStorage.getItem('navGroupStates') || '{}');
            const newState = !items.classList.contains('collapsed'); // true if expanded, false if collapsed
            navGroupStates[groupName] = newState;
            localStorage.setItem('navGroupStates', JSON.stringify(navGroupStates));
        }
        
        // Restore navigation group states on load
        function restoreNavGroupStates() {
            const navGroupStates = JSON.parse(localStorage.getItem('navGroupStates') || '{}');
            document.querySelectorAll('.nav-group-header').forEach(header => {
                const groupName = header.querySelector('span').textContent.trim();
                const isExpanded = navGroupStates[groupName];
                
                // Default: all groups collapsed (set in HTML)
                // Only expand if explicitly saved as expanded in localStorage
                if (isExpanded === true) {
                    const items = header.nextElementSibling;
                    items.classList.remove('collapsed');
                    header.classList.remove('collapsed');
                }
            });
        }

        // ‚îÄ‚îÄ Global RBAC Banner ‚Äî renders on ALL tabs ‚îÄ‚îÄ
        function renderRbacBanner() {
            const el = document.getElementById('global-rbac-banner');
            if (!el) return;

            const email = state.currentUser?.email;
            if (!email) { el.style.display = 'none'; return; }

            const info = UserAccounts.getUserInfo(email);
            const tab = state.currentTab;

            // Admin: no banner needed
            if (info.role === 'admin') { el.style.display = 'none'; el.innerHTML = ''; return; }

            let bannerHtml = '';

            if (info.role === 'superintendent') {
                const foreignProjects = (state.projects || []).filter(p => p.region !== info.region);
                if (foreignProjects.length > 0) {
                    bannerHtml = `
                    <div style="display:flex;align-items:center;gap:14px;
                        background:linear-gradient(135deg,#fff8e1,#fffde7);
                        border:1.5px solid #f9a825;border-radius:10px;
                        padding:11px 18px;
                        font-size:0.82rem;color:#e65100;font-weight:600;
                        box-shadow:0 2px 8px rgba(249,168,37,0.1);">
                        <i class="fas fa-eye" style="font-size:1.1rem;color:#f9a825;flex-shrink:0;"></i>
                        <div>
                            <div style="margin-bottom:2px;">üëÅÔ∏è <strong>Read-Only Access</strong> for other regions ‚Äî You are viewing cross-region data.</div>
                            <div style="font-weight:400;font-size:0.76rem;opacity:0.85;">
                                You can only edit records in <strong>${info.region}</strong>. Data from other regions is visible but locked.
                            </div>
                        </div>
                    </div>`;
                }
            }

            if (info.role === 'pco') {
                const isPcoEditableTab = UserAccounts.PCO_EDITABLE_TABS && UserAccounts.PCO_EDITABLE_TABS.includes(tab);
                bannerHtml = `
                <div style="display:flex;align-items:center;gap:14px;
                    background:linear-gradient(135deg,#e3f2fd,#e8f5e9);
                    border:1.5px solid #1976d2;border-radius:10px;
                    padding:11px 18px;
                    font-size:0.82rem;color:#0d47a1;font-weight:600;
                    box-shadow:0 2px 8px rgba(25,118,210,0.1);">
                    <i class="fas fa-${isPcoEditableTab ? 'pen-to-square' : 'lock'}" style="font-size:1.1rem;color:#1976d2;flex-shrink:0;"></i>
                    <div>
                        <div style="margin-bottom:2px;">
                            ${isPcoEditableTab
                                ? `‚úèÔ∏è <strong>Editable</strong> ‚Äî This tab is within your PCO access. Region: <strong>${info.region}</strong>`
                                : `üîí <strong>Read-Only Access</strong> ‚Äî PCO accounts can only edit Environmental modules.`}
                        </div>
                        <div style="font-weight:400;font-size:0.76rem;opacity:0.85;">
                            Editable tabs: Environmental Monitoring ¬∑ EMB Reportorial ¬∑ Environmental Permits ¬∑ ESH Calendar (Env) ¬∑ Emergency Drills &nbsp;|&nbsp; Region: <strong>${info.region}</strong>
                        </div>
                    </div>
                </div>`;
            }

            if (bannerHtml) {
                el.innerHTML = bannerHtml;
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
                el.innerHTML = '';
            }
        }

        function changeTab(t) {
            state.currentTab = t;
            // Persist current tab so page refresh restores it
            localStorage.setItem('esh_last_tab', t);
            document.querySelectorAll('.nav-item').forEach(n => {
                const isActive = n.dataset.tab === t;
                n.classList.toggle('active', isActive);
                
                // Auto-expand parent group if this item is active
                if (isActive && n.parentElement.classList.contains('nav-group-items')) {
                    const groupItems = n.parentElement;
                    const groupHeader = groupItems.previousElementSibling;
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        groupHeader.classList.remove('collapsed');
                        
                        // Save expanded state to localStorage
                        const groupName = groupHeader.querySelector('span').textContent.trim();
                        const navGroupStates = JSON.parse(localStorage.getItem('navGroupStates') || '{}');
                        navGroupStates[groupName] = true; // Expanded
                        localStorage.setItem('navGroupStates', JSON.stringify(navGroupStates));
                    }
                }
            });
            const titles = {
                'overall': 'OVERALL DASHBOARD', 'exposures': 'TOTAL EXPOSURES',
                'rates': 'STATISTICS RATE', 'medical': 'ACCIDENT/ INCIDENT RECORD',
		'nov': 'REGULATORY ISSUED NOV',
                'nov-monitoring': 'ESH NOV MONITORING',
                'activities': 'ESH ACTIVITIES AND PROGRAMS','kpm': 'KEY PERFORMANCE MEASURES REPORT','reg': 'DOLE CERTIFICATE OF REGISTRATION (DATE REGISTERED)','audit': 'INTERNAL ESH AUDIT REPORT',
                'cshp': 'CONSTRUCTION SAFETY & HEALTH PROGRAM (DATE APPROVED)', 'dole': 'DOLE REPORTORIAL','permits': 'ENVIRONMENTAL PERMITS/LICENSES/CLEARANCE','emb': ["EMB REPORTORIAL"],
                'doe': 'DOE REPORTORIAL - RENEWABLE ENERGY PROJECTS', 'doe-permit': 'DOE SAFETY OFFICER PERMIT',
                'personnel': 'ESH PERSONNEL MONITORING', 'settings': 'SETTINGS', 'admin': 'ADMIN CONTROL PANEL',
                'osh-requirement': 'OSH PERSONNEL REQUIREMENT MONITORING',
                'env-monitoring': 'ENVIRONMENTAL MONITORING',
                'env-monthly-report': 'ENVIRONMENTAL MONTHLY REPORT',
                'esh-calendar-env': '2026 ESH CALENDAR ‚Äî ENVIRONMENT TRAININGS',
                'esh-calendar-safety': '2026 ESH CALENDAR ‚Äî SAFETY TRAININGS',
                'esh-calendar-health': '2026 ESH CALENDAR ‚Äî HEALTH TRAININGS',
                'esh-calendar-drills': '2026 ESH CALENDAR ‚Äî EMERGENCY DRILLS'
            };
            document.querySelector('.header-title').innerText = titles[t] || t.toUpperCase();
            document.getElementById('settings-view').classList.toggle('hidden', t !== 'settings');
            document.getElementById('personnel-view').classList.toggle('hidden', t !== 'personnel');
            document.getElementById('admin-view').classList.toggle('hidden', t !== 'admin');
            document.getElementById('osh-requirement-view').classList.toggle('hidden', t !== 'osh-requirement');
            document.getElementById('env-monitoring-view').classList.toggle('hidden', t !== 'env-monitoring');
            document.getElementById('dashboard-content').classList.toggle('hidden', t === 'settings' || t === 'personnel' || t === 'admin' || t === 'osh-requirement' || t === 'env-monitoring');
            
            // ESH Calendar tab visibility
            const eshCalTabs = ['esh-calendar-env','esh-calendar-safety','esh-calendar-health','esh-calendar-drills'];
            eshCalTabs.forEach(ct => {
                const el = document.getElementById(ct + '-view');
                if (el) el.classList.toggle('hidden', t !== ct);
            });
            const isEshCal = eshCalTabs.includes(t);
            if (isEshCal) {
                document.getElementById('dashboard-content').classList.add('hidden');
                try { renderEshCalendar(t); } catch(e) {
                    console.error('‚ùå changeTab renderEshCalendar error:', e);
                }
            }
            
            // If switching to admin tab, render admin panel
            if (t === 'admin') {
                renderAdminPanel();
            }
            
            // Trigger slide animation on tab change
            const dashContent = document.getElementById('dashboard-content');
            const settingsView = document.getElementById('settings-view');
            const personnelView = document.getElementById('personnel-view');
            
            // Animate dashboard content
            if (dashContent && !dashContent.classList.contains('hidden')) {
                dashContent.style.animation = 'none';
                void dashContent.offsetWidth;
                dashContent.style.animation = 'slideRight 0.5s ease-out';
            }
            
            // Animate settings view
            if (settingsView && !settingsView.classList.contains('hidden')) {
                settingsView.style.animation = 'none';
                void settingsView.offsetWidth;
                settingsView.style.animation = 'slideRight 0.5s ease-out';
            }
            
            // Animate personnel view
            if (personnelView && !personnelView.classList.contains('hidden')) {
                personnelView.style.animation = 'none';
                void personnelView.offsetWidth;
                personnelView.style.animation = 'slideRight 0.5s ease-out';
            }
            
            if (t === 'settings') {
                populateSettingsTab();
                updateYearDisplay(); // Update year displays in settings
            }
            
            if (t === 'env-monitoring') { setTimeout(envInitChart, 100); }
            
            if (t === 'personnel') { renderPTable(); }
            if (t === 'osh-requirement') { setTimeout(renderOsh2, 100); }
            
            // ‚îÄ‚îÄ Always refresh the global RBAC banner on every tab switch ‚îÄ‚îÄ
            renderRbacBanner();

            // Block PCO from accessing personnel tab
            if (t === 'personnel' && state.userRole === 'pco') {
                showToast('üîí ESH Personnel Monitoring is not accessible for PCO accounts.', 'warning');
                changeTab('overall');
                return;
            }

            // Block PCO from accessing OSH requirement tab
            if (t === 'osh-requirement' && state.userRole === 'pco') {
                showToast('üîí OSH Personnel Requirement is not accessible for PCO accounts.', 'warning');
                changeTab('overall');
                return;
            }
            
            // PDF Export button visibility control
            const pdfBtn = document.getElementById('export-pdf-btn');
            const xlsBtn = document.getElementById('export-excel-btn');
            if (pdfBtn) {
                // Hide PDF button for non-admins when in personnel tab
                if (t === 'personnel' && !state.isAdmin) {
                    pdfBtn.style.display = 'none';
                    if (xlsBtn) xlsBtn.style.display = 'none';
                } else {
                    pdfBtn.style.display = 'inline-block';
                    if (xlsBtn) xlsBtn.style.display = 'inline-block';
                }
            }
            
            render();
        }

function updateAuditData(pName, qtr, field, val) {
    // RBAC: Check region + tab permissions
    const p = state.projects.find(x => x.name === pName);
    const rbac = UserAccounts.checkPermission(state.currentUser?.email, 'edit', p?.region, 'audit');
    if (!rbac.allowed) {
        showLockedMessage(rbac.reason);
        return;
    }
    
    // Prevent negative numbers
    const numVal = parseFloat(val);
    if (numVal < 0) {
        showToast('‚ö†Ô∏è Negative numbers are not allowed', 'warning');
        // Reset the input field to 0 or empty
        const input = event?.target;
        if (input) input.value = '';
        return;
    }
    
    // Prevent values over 100 for audit scores
    if (numVal > 100) {
        showToast('‚ö†Ô∏è Audit scores cannot exceed 100%', 'warning');
        const input = event?.target;
        if (input) input.value = '100';
        val = '100';
    }
    
    // p is already defined at the top for permission check
    if (p) {
        if (!p.auditData) {
            p.auditData = {
                Q1: { scoreImpl: 0, docuComp: 0 }, Q2: { scoreImpl: 0, docuComp: 0 },
                Q3: { scoreImpl: 0, docuComp: 0 }, Q4: { scoreImpl: 0, docuComp: 0 }
            };
        }
        p.auditData[qtr][field] = parseFloat(val) || 0;
        render(); // Para mag-update ang computation ng average sa screen
    }
}

        // Format phone number: 0977 172 6246 (4-3-4 pattern)
        function fmtPhone(val) {
            const digits = val.replace(/\D/g, '').slice(0, 11);
            if (digits.length <= 4) return digits;
            if (digits.length <= 7) return digits.slice(0,4) + ' ' + digits.slice(4);
            return digits.slice(0,4) + ' ' + digits.slice(4,7) + ' ' + digits.slice(7);
        }

        // Capitalize each word
        function titleCase(val) {
            return val.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
        }

        // Live-update only the "Total Exposed Man-hour to date" monthly cells for a project
        // Called when user edits the Previous column ‚Äî avoids full page re-render
        function updateToDateMonthCells(pName) {
            const p = state.projects.find(x => x.name === pName);
            if (!p) return;
            const key = 'exposures_Total Exposed Man-hour to date';
            const manhourKey = 'exposures_Total Exposed Manhour';
            const prevBase = parseFloat(p.vals[key] ? (p.vals[key][0] ?? 0) : 0) || 0;
            let cumulative = prevBase;

            for (let i = 1; i <= 12; i++) {
                const monthManhour = parseFloat(p.vals[manhourKey] ? (p.vals[manhourKey][i] ?? '') : '') || 0;
                if (monthManhour > 0) cumulative += monthManhour;

                // Find the cell by data attribute and update its text
                const cell = document.querySelector(`[data-todate-proj="${CSS.escape(pName)}"][data-todate-month="${i}"]`);
                if (cell) {
                    cell.textContent = cumulative > 0 ? fmtNum(cumulative) : '';
                    cell.style.color = '';
                    cell.style.fontWeight = '700';
                }
            }

            // Update YTD cell too
            const ytdCell = document.querySelector(`[data-todate-proj="${CSS.escape(pName)}"][data-todate-month="ytd"]`);
            if (ytdCell) {
                let ytdCum = prevBase;
                for (let i = 1; i <= 12; i++) {
                    ytdCum += parseFloat(p.vals[manhourKey] ? (p.vals[manhourKey][i] ?? '') : '') || 0;
                }
                ytdCell.textContent = ytdCum > 0 ? fmtNum(ytdCum) : '';
            }
        }

        function updateVal(pName, key, mIdx, val) {
            // Strip commas from formatted number inputs
            val = String(val).replace(/,/g, '');
            // RBAC: Check both region AND tab permissions
            const p = state.projects.find(x => x.name === pName);
            const rbac = UserAccounts.checkPermission(state.currentUser?.email, 'edit', p?.region, state.currentTab);
            if (!rbac.allowed) {
                showLockedMessage(rbac.reason);
                // Revert the input visually
                render();
                return;
            }
            
            // Prevent negative numbers
            const numVal = parseFloat(val);
            if (numVal < 0) {
                showToast('‚ö†Ô∏è Negative numbers are not allowed', 'warning');
                // Reset the input field to 0 or empty
                const input = event?.target;
                if (input) input.value = '';
                return;
            }
            
            if (p) {
                if (!p.vals[key]) p.vals[key] = new Array(13).fill("");
                p.vals[key][mIdx] = val;
            }
            // Mark that there are unsaved changes pending cloud sync
            if (typeof markPendingSync === 'function') markPendingSync();
            // Live-update the Incident Tabulation panel when relevant data changes
            if (state.currentTab === 'rates') {
                const panel = document.getElementById('incident-tabulation-panel');
                if (panel) {
                    panel.outerHTML = buildIncidentTabulationHTML();
                }
            }
        }

        // ==================== ECC MULTI-ENTRY ====================
        function addEccEntry(pName) {
            const p = state.projects.find(x => x.name === pName);
            const _rbacEcc = UserAccounts.checkPermission(state.currentUser?.email, 'edit', p?.region, 'permits');
            if (!p || !_rbacEcc.allowed) { showLockedMessage(_rbacEcc.reason); return; }
            const key = 'permits_ECC';
            if (!p.vals[key]) p.vals[key] = {};
            if (!p.vals[key].entries) {
                // Migrate old single entry if exists
                const old = { permitNo: p.vals[key][1] ?? '', dateIssued: p.vals[key][2] ?? '', expiryDate: p.vals[key][3] ?? '' };
                p.vals[key].entries = (old.permitNo || old.dateIssued || old.expiryDate) ? [old] : [];
                delete p.vals[key][1]; delete p.vals[key][2]; delete p.vals[key][3];
            }
            p.vals[key].entries.push({ permitNo: '', dateIssued: '', expiryDate: '' });
            saveToFirebase();
            render();
        }

        function removeEccEntry(pName, idx) {
            const p = state.projects.find(x => x.name === pName);
            const _rbacEcc = UserAccounts.checkPermission(state.currentUser?.email, 'delete', p?.region, 'permits');
            if (!p || !_rbacEcc.allowed) { showLockedMessage(_rbacEcc.reason); return; }
            const key = 'permits_ECC';
            if (p.vals[key]?.entries) {
                p.vals[key].entries.splice(idx, 1);
                saveToFirebase();
                render();
            }
        }

        function updateEccEntry(pName, idx, field, value) {
            const p = state.projects.find(x => x.name === pName);
            const _rbacEcc = UserAccounts.checkPermission(state.currentUser?.email, 'edit', p?.region, 'permits');
            if (!p || !_rbacEcc.allowed) { showLockedMessage(_rbacEcc.reason); return; }
            const key = 'permits_ECC';
            if (p.vals[key]?.entries?.[idx] !== undefined) {
                p.vals[key].entries[idx][field] = value;
            }
        }
        function togglePermitNA(pName, key) {
            const p = state.projects.find(x => x.name === pName);
            if (!p) return;
            const _rbacNA = UserAccounts.checkPermission(state.currentUser?.email, 'edit', p?.region, 'permits');
            if (!_rbacNA.allowed) {
                showLockedMessage(_rbacNA.reason);
                return;
            }
            if (!p.vals[key]) p.vals[key] = {};
            p.vals[key]['na'] = !p.vals[key]['na'];
            saveToFirebase();
            render();
        }

        // ==================== PDF UPLOAD FUNCTIONS ====================
        async function uploadPDF(inputElement, projectName, pdfKey, isReplacement = false) {
            const file = inputElement.files[0];
            if (!file) return;

            // Validate file type
            if (file.type !== 'application/pdf') {
                showToast('Please upload only PDF files.', 'error');
                inputElement.value = '';
                return;
            }

            // Validate file size (max 500KB ‚Äî 1 page stamped file only)
            const maxSize = 500 * 1024; // 500KB
            if (file.size > maxSize) {
                showToast('‚ö†Ô∏è File size must be less than 500KB. Please upload the STAMPED FILE PAGE only (1 page), hindi ang buong file.', 'warning');
                inputElement.value = '';
                return;
            }

            // Confirmation for replacement
            if (isReplacement) {
                const confirmed = await showModernDialog(
                    'Replace PDF',
                    'Are you sure you want to replace the existing PDF file with this new one?',
                    true
                );
                if (!confirmed) {
                    inputElement.value = '';
                    return;
                }
            }

            try {
                // Show loading indicator
                const container = inputElement.parentElement;
                const originalHTML = container.innerHTML;
                container.innerHTML = '<span style="color: #1976D2;"><i class="fas fa-spinner fa-spin"></i> Uploading PDF...</span>';

                // Get current project
                const project = state.projects.find(p => p.name === projectName);
                if (!project) {
                    throw new Error('Project not found');
                }

                // Delete old file from Firebase Storage if replacing
                if (isReplacement && project.vals[pdfKey] && project.vals[pdfKey][1]) {
                    const oldPdfData = project.vals[pdfKey][1];
                    if (window.firebaseStorage && window.firebase && oldPdfData.storagePath) {
                        try {
                            const oldStorageRef = window.firebase.ref(window.firebaseStorage, oldPdfData.storagePath);
                            await window.firebase.deleteObject(oldStorageRef);
                            console.log('‚úÖ Old PDF deleted from storage');
                        } catch (deleteError) {
                            console.warn('‚ö†Ô∏è Could not delete old file from storage:', deleteError);
                            // Continue anyway
                        }
                    }
                }

                // Upload to Firebase Storage
                if (!window.firebaseStorage || !window.firebase) {
                    throw new Error('Firebase Storage not initialized');
                }

                // Use current user's UID for storage path so Firebase Storage rules allow the write.
                // The download URL is saved in Firestore (shared admin location) so all users can access it.
                const STORAGE_UID = window.firebaseAuth?.currentUser?.uid || 'fUnXsvKnRYMpuySRbeVYJk7TO452';
                const timestamp = Date.now();
                const fileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_'); // Sanitize filename
                const storagePath = `compliance-pdfs/${STORAGE_UID}/${projectName.replace(/[^a-zA-Z0-9]/g,'_')}_${pdfKey}_${timestamp}_${fileName}`;
                
                const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
                
                // Upload the actual PDF file to Firebase Storage
                await window.firebase.uploadBytes(storageRef, file);
                const downloadURL = await window.firebase.getDownloadURL(storageRef);

                console.log('‚úÖ PDF uploaded to Firebase Storage:', storagePath);
                console.log('üìé Download URL:', downloadURL);

                // Store PDF metadata in project vals
                if (!project.vals[pdfKey]) project.vals[pdfKey] = new Array(13).fill("");
                project.vals[pdfKey][1] = {
                    name: file.name,
                    url: downloadURL,
                    storagePath: storagePath,
                    uploadedAt: new Date().toISOString(),
                    size: file.size
                };
                
                // Save to localStorage and Firebase Firestore
                saveUserData(state.currentUser.email);
                await saveToFirebase();
                
                // Re-render to show the uploaded PDF
                render();

                console.log('‚úÖ PDF metadata saved to Firestore');
                showToast(isReplacement ? 'PDF file replaced successfully!' : 'PDF uploaded successfully!', 'success');
            } catch (error) {
                console.error('‚ùå PDF upload error:', error);
                showToast('Failed to upload PDF: ' + error.message, 'error');
                
                // Re-render to restore UI
                render();
            }

            // Clear file input
            inputElement.value = '';
        }

        async function deletePDF(projectName, pdfKey) {
            const project = state.projects.find(p => p.name === projectName);
            if (!project || !project.vals[pdfKey] || !project.vals[pdfKey][1]) return;

            const confirmed = await showModernDialog(
                'Delete PDF',
                'Are you sure you want to delete this PDF file? This action cannot be undone.',
                true
            );

            if (!confirmed) return;

            try {
                const pdfData = project.vals[pdfKey][1];
                
                // Delete from Firebase Storage
                if (window.firebaseStorage && window.firebase && pdfData.storagePath) {
                    try {
                        const storageRef = window.firebase.ref(window.firebaseStorage, pdfData.storagePath);
                        await window.firebase.deleteObject(storageRef);
                        console.log('‚úÖ PDF deleted from Firebase Storage:', pdfData.name);
                    } catch (storageError) {
                        console.warn('‚ö†Ô∏è Could not delete from storage:', storageError);
                        // Continue anyway to remove from database
                    }
                }

                // Remove from project vals
                project.vals[pdfKey][1] = null;
                
                // Save changes to localStorage and Firebase Firestore
                saveUserData(state.currentUser.email);
                await saveToFirebase();
                
                // Re-render
                render();

                console.log('‚úÖ PDF metadata removed from Firestore');
                showToast('PDF deleted successfully!', 'success');
            } catch (error) {
                console.error('‚ùå PDF deletion error:', error);
                showToast('Failed to delete PDF: ' + error.message, 'error');
            }
        }
        // ==================== END PDF UPLOAD FUNCTIONS ====================


        async function deleteProject(projectName) {
    debugLog('INFO', `üóëÔ∏è deleteProject() called for: ${projectName}`);
    
    // Protect the permanent Corporate project from deletion
    if (projectName === 'Corporate') {
        showToast('üè¢ The Corporate project cannot be deleted ‚Äî it is a permanent entity.', 'warning');
        return;
    }
    
    // RBAC: Delete is Admin-only
    const project = state.projects.find(p => p.name === projectName);
    const rbacDel = UserAccounts.checkPermission(state.currentUser?.email, 'delete', project?.region, state.currentTab);
    if (!rbacDel.allowed) {
        showLockedMessage(rbacDel.reason);
        return;
    }
    
    // Validate before delete
    const beforeValidation = validateState();
    debugLog('DATA', 'State before delete:', beforeValidation.stats);
    
    const confirmed = await showDeleteDialog('Project', projectName);
    
    if (confirmed) {
        // Save copies for undo
        const deletedFromProjects       = state.projects.find(p => p.name === projectName);
        const deletedFromMasterProjects = state.masterProjects.find(p => p.name === projectName);

        state.projects       = state.projects.filter(p => p.name !== projectName);
        state.masterProjects = state.masterProjects.filter(p => p.name !== projectName);
        reapplyFilters();
        saveUserData(state.currentUser.email);
        render();

        // Show undo toast ‚Äî Firebase save is delayed to allow undo
        showUndoToast(`"${projectName}" has been deleted.`, () => {
            // Restore project
            if (deletedFromProjects) state.projects.push(deletedFromProjects);
            if (deletedFromMasterProjects) state.masterProjects.push(deletedFromMasterProjects);
            reapplyFilters();
            saveUserData(state.currentUser.email);
            saveToFirebaseWithRetry().catch(() => {});
            render();
            showToast(`Project "${projectName}" restored!`, 'success');
        });

        // Delay Firebase sync to allow undo
        setTimeout(async () => {
            const saved = await saveToFirebaseWithRetry();
            if (saved) {
                debugLog('SUCCESS', `‚úÖ Project "${projectName}" deleted from Firebase`);
                AuditLogger.log('PROJECT_DELETED', {
                    projectName: projectName,
                    year: state.selectedYear,
                    remainingProjects: state.projects.length
                });
            } else {
                showToast('Deleted locally ‚Äî failed to sync to cloud.', 'warning');
            }
        }, 5500);
    } else {
        debugLog('INFO', 'Delete cancelled by user');
    }
}

     function changeProjectStatus(projectName, event) {
    event.stopPropagation();
    const project = state.projects.find(p => p.name === projectName);
    if (!project) return;
    
    // Close any existing dropdown
    closeAllStatusDropdowns();
    
    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    
    const statuses = [
        { value: 'on-going', label: 'On-Going' },
        { value: 'work-stoppage', label: 'Work Stoppage' },
        { value: 'finished', label: 'Finished' }
    ];
    
    statuses.forEach(status => {
        const btn = document.createElement('button');
        btn.textContent = status.label;
        btn.style.fontWeight = project.status === status.value ? '700' : '400';
        
        // Disable finished if no finished date
        if (status.value === 'finished' && !project.dateFinished) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.title = 'Finished status requires a finished date. Edit the project and add a finished date first.';
        }
        
        btn.onclick = () => {
            // Double-check validation before changing status
            if (status.value === 'finished' && !project.dateFinished) {
                showToast('‚ö†Ô∏è Finished status requires a finished date. Please edit the project and add a finished date first.', 'warning');
                return;
            }
            
            project.status = status.value;
            reapplyFilters(); // Reapply filters after status change
            saveUserData(state.currentUser.email);
            closeAllStatusDropdowns();
            render();
        };
        dropdown.appendChild(btn);
    });
    
    const badge = event.target;
    const rect = badge.getBoundingClientRect();
    
    // Calculate if there's enough space below
    const dropdownHeight = 120; // Approximate height of dropdown with 3 items
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;
    
    dropdown.style.position = 'fixed';
    dropdown.style.left = rect.left + 'px';
    
    // Position above if not enough space below
    if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
        dropdown.style.bottom = (window.innerHeight - rect.top + 5) + 'px';
        dropdown.style.top = 'auto';
    } else {
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.bottom = 'auto';
    }
    
    document.body.appendChild(dropdown);
}

function closeAllStatusDropdowns() {
    document.querySelectorAll('.status-dropdown').forEach(d => d.remove());
}

        function getPerc(proj) {
            let total = 0, filled = 0;
            ["exposures", "rates", "medical", "nov", "activities", "kpm","dole","permits","emb", "cshp","reg","env-monthly-report"].forEach(cat => {
    SCHEMA[cat].forEach(row => {
        const key = `${cat}_${row}`;
        if (cat === 'cshp' || cat === 'reg') {
            total += 1;
            if (proj.vals[key] && proj.vals[key][1]) filled++;
        } else if (cat === 'permits') {
            // Permits have 3 fields: Permit No., Date Issued, Expiry Date
            total += 3;
            if (proj.vals[key]) {
                for (let i = 1; i <= 3; i++) {
                    if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                }
            }
        } else if (cat === 'emb') {
            // EMB has special submission cycles
            if (row === "SMR (Quarterly) - Submission Date") {
                total += 4; // Q1, Q2, Q3, Q4
                if (proj.vals[key]) {
                    for (let i = 1; i <= 4; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            } else if (row === "SMR (Quarterly) - Reference No.") {
                total += 4; // Q1, Q2, Q3, Q4
                if (proj.vals[key]) {
                    for (let i = 1; i <= 4; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            } else if (row === "CMR (Semi-Annual) - Submission Date") {
                total += 2; // Two semi-annual periods
                if (proj.vals[key] && proj.vals[key][1]) filled++;
                if (proj.vals[key] && proj.vals[key][2]) filled++;
            } else if (row === "CMR (Semi-Annual) - Reference No.") {
                total += 2; // Two semi-annual periods
                if (proj.vals[key] && proj.vals[key][1]) filled++;
                if (proj.vals[key] && proj.vals[key][2]) filled++;
            }
        } else {
            // Handle DOLE AEDR/AMR specially - they use only 1 field
            if (cat === 'dole' && (row === 'AEDR' || row === 'AMR')) {
                total += 1;
                if (proj.vals[key] && proj.vals[key][1]) filled++;
            } else {
                total += 12;
                if (proj.vals[key]) {
                    for (let i = 1; i <= 12; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "0" && proj.vals[key][i] !== "") filled++;
                    }
                }
            }
        }
    });
});
            return total > 0 ? Math.round((filled / total) * 100) : 0;
        }

        function calculateYTD(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) sum += val;
            }
            return sum;
        }

        function calculateAverage(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            let count = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) {
                    sum += val;
                    count++;
                }
            }
            return count > 0 ? Math.round(sum / count) : 0;
        }

        function renderCharts() {
            const regionData = {};
            REGIONS.forEach(r => regionData[r] = [0, 0]);
            state.projects.forEach(p => {
                const perc = getPerc(p);
                regionData[p.region][0] += perc;
                regionData[p.region][1] += 1;
            });

            const regionAvgs = REGIONS.map(r => regionData[r][1] > 0 ? Math.round(regionData[r][0] / regionData[r][1]) : 0);
            const statusCounts = { 'on-going': 0, 'work-stoppage': 0, 'finished': 0 };
            state.projects.forEach(p => statusCounts[p.status]++);

            Object.values(state.charts).forEach(chart => { if (chart) chart.destroy(); });
            state.charts = {};

            setTimeout(() => {
                const regionCtx = document.getElementById('regionChart');
                if (regionCtx) {
                    const existingChart = Chart.getChart(regionCtx);
                    if (existingChart) existingChart.destroy();
                    
                    const ctx = regionCtx.getContext('2d');
                    
                    // Create unique gradient for each region
                    const gradients = [];
                    
                    // NCR - Pink/Magenta gradient
                    const gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient1.addColorStop(0, '#ec407a');
                    gradient1.addColorStop(0.5, '#e91e63');
                    gradient1.addColorStop(1, '#c2185b');
                    gradients.push(gradient1);
                    
                    // SOUTH LUZON - Blue gradient
                    const gradient2 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient2.addColorStop(0, '#42a5f5');
                    gradient2.addColorStop(0.5, '#2196f3');
                    gradient2.addColorStop(1, '#1976d2');
                    gradients.push(gradient2);
                    
                    // NORTH LUZON - Green gradient
                    const gradient3 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient3.addColorStop(0, '#66bb6a');
                    gradient3.addColorStop(0.5, '#4caf50');
                    gradient3.addColorStop(1, '#388e3c');
                    gradients.push(gradient3);
                    
                    // VISAYAS & MINDANAO - Orange gradient
                    const gradient4 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient4.addColorStop(0, '#ffa726');
                    gradient4.addColorStop(0.5, '#ff9800');
                    gradient4.addColorStop(1, '#f57c00');
                    gradients.push(gradient4);
                    
                    state.charts.region = new Chart(regionCtx, {
                        type: 'bar',
                        data: {
                            labels: REGIONS,
                            datasets: [{
                                label: 'Compliance %',
                                data: regionAvgs,
                                backgroundColor: gradients,
                                borderWidth: 0,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    cornerRadius: 8
                                }
                            },
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    max: 100,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }

                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    // Destroy existing chart instance before creating new one
                    const existingStatusChart = Chart.getChart(statusCtx);
                    if (existingStatusChart) existingStatusChart.destroy();
                    // Create gradients for modern look
                    const ctx = statusCtx.getContext('2d');
                    
                    // Gradient 1: Blue gradient for On-Going
                    const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient1.addColorStop(0, '#42a5f5');
                    gradient1.addColorStop(0.5, '#1976D2');
                    gradient1.addColorStop(1, '#0d47a1');
                    
                    // Gradient 2: Red gradient for Work Stoppage
                    const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient2.addColorStop(0, '#ef5350');
                    gradient2.addColorStop(0.5, '#d32f2f');
                    gradient2.addColorStop(1, '#b71c1c');
                    
                    // Gradient 3: Gray gradient for Finished
                    const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient3.addColorStop(0, '#9e9e9e');
                    gradient3.addColorStop(0.5, '#616161');
                    gradient3.addColorStop(1, '#424242');
                    
                    // Center text plugin
                    const centerTextPlugin = {
                        id: 'centerText',
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const width = chart.width;
                            const height = chart.height;
                            
                            ctx.restore();
                            
                            // Calculate total and percentage
                            const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((statusCounts['on-going'] / total) * 100) : 0;
                            
                            // Draw percentage
                            const fontSize = (height / 180).toFixed(2);
                            ctx.font = `bold ${fontSize}em Inter, sans-serif`;
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = '#1b5e20';
                            
                            const percentText = percentage + '%';
                            const percentTextX = Math.round((width - ctx.measureText(percentText).width) / 2);
                            const percentTextY = height / 2 - 10;
                            
                            ctx.fillText(percentText, percentTextX, percentTextY);
                            
                            // Draw label
                            const labelFontSize = (height / 320).toFixed(2);
                            ctx.font = `${labelFontSize}em Inter, sans-serif`;
                            ctx.fillStyle = '#666';
                            
                            const labelText = 'On-Going';
                            const labelTextX = Math.round((width - ctx.measureText(labelText).width) / 2);
                            const labelTextY = height / 2 + 18;
                            
                            ctx.fillText(labelText, labelTextX, labelTextY);
                            
                            ctx.save();
                        }
                    };
                    
                    state.charts.status = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['On-Going', 'Work Stoppage', 'Finished'],
                            datasets: [{
                                data: [statusCounts['on-going'], statusCounts['work-stoppage'], statusCounts['finished']],
                                backgroundColor: [gradient1, gradient2, gradient3],
                                borderWidth: 0,
                                borderRadius: 8,
                                spacing: 3
                            }]
                        },
                        options: { 
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            family: 'Inter, sans-serif'
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            }
                        },
                        plugins: [centerTextPlugin]
                    });
                }
            }, 100);
        }

        // PDF EXPORT FUNCTION - DISABLED (removed from UI)
        // Uncomment if needed in the future
        /*
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const tabTitles = {
                'overall': 'OVERALL SUMMARY',
                'exposures': 'SAFETY EXPOSURES',
                'medical': 'ACCIDENT/INCIDENT RECORD',
                'activities': 'SAFETY ACTIVITIES',
                'audit': 'SAFETY AUDIT',
                'nov': 'NOV',
                'rates': 'STATISTICS RATE',
                'personnel': 'ESH PERSONNEL MONITORING'
            };
            
            const title = tabTitles[state.currentTab] || 'ESH COMPLIANCE DASHBOARD';
            
            doc.setFontSize(16);
            doc.setTextColor(27, 94, 32);
            doc.text(title, 14, 15);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated: ' + new Date().toLocaleString(), 14, 22);
            
            let table;
            if (state.currentTab === 'personnel') {
                table = document.getElementById('p-cards-container');
            } else {
                const container = document.getElementById('dashboard-content');
                table = container ? container.querySelector('table') : null;
            }
            
            if (!table) {
                showToast('No table data to export', 'warning');
                return;
            }
            
            const headers = [];
            const rows = [];
            
            const headerCells = table.querySelectorAll('thead th');
            headerCells.forEach(th => {
                headers.push(th.textContent.trim());
            });
            
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(tr => {
                const row = [];
                const cells = tr.querySelectorAll('td');
                cells.forEach(td => {
                    const input = td.querySelector('input[type="text"], input[type="date"], input[type="number"], select');
                    if (input) {
                        row.push(input.value || '');
                    } else {
                        row.push(td.textContent.trim());
                    }
                });
                if (row.length > 0) {
                    rows.push(row);
                }
            });
            
            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 28,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [46, 125, 50],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 'auto', fontStyle: 'bold' }
                },
                margin: { top: 28, left: 14, right: 14 },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text('ESH Compliance Dashboard - SCIC', data.settings.margin.left, doc.internal.pageSize.height - 10);
                    doc.text('Page ' + doc.internal.getNumberOfPages(), doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                }
            });
            
            const filename = `ESH_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }
        */


        function showUI() {
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            const _fBtn = document.getElementById('floating-edit-btn');
            if (_fBtn) _fBtn.style.display = 'flex';

            const isPCO = state.userRole === 'pco';

            // Hide personnel nav item for PCO accounts
            const personnelNavItem = document.querySelector('.nav-item[data-tab="personnel"]');
            if (personnelNavItem) personnelNavItem.style.display = isPCO ? 'none' : '';

            // Hide OSH requirement nav item for PCO accounts
            const oshNavItem = document.querySelector('.nav-item[data-tab="osh-requirement"]');
            if (oshNavItem) oshNavItem.style.display = isPCO ? 'none' : '';

            // For PCO: hide non-environmental nav items and grey out view-only ones
            // PCO can VIEW all remaining tabs, but these are non-env (view-only) ‚Äî mark them
            const pcoNonEnvTabs = ['rates','exposures','activities','kpm','dole','doe','doe-permit',
                                   'medical','nov','nov-monitoring','cshp','reg']; // 'audit' excluded ‚Äî uses #audit-nav-lock instead
            pcoNonEnvTabs.forEach(tab => {
                const el = document.querySelector(`.nav-item[data-tab="${tab}"]`);
                if (!el) return;
                if (isPCO) {
                    el.style.opacity = '0.55';
                    el.style.fontStyle = 'italic';
                    if (!el.querySelector('.pco-lock-icon')) {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-lock pco-lock-icon';
                        icon.style.cssText = 'font-size:0.6rem;margin-left:5px;color:#f57c00;vertical-align:middle;';
                        icon.title = 'View only for PCO';
                        el.appendChild(icon);
                    }
                } else {
                    el.style.opacity = '';
                    el.style.fontStyle = '';
                    const lockIcon = el.querySelector('.pco-lock-icon');
                    if (lockIcon) lockIcon.remove();
                }
            });

            // Apply greyed/italic style to audit nav item separately
            // (its lock icon is handled by #audit-nav-lock ‚Äî no duplicate needed)
            const auditEl = document.querySelector('.nav-item[data-tab="audit"]');
            if (auditEl) {
                auditEl.style.opacity = isPCO ? '0.55' : '';
                auditEl.style.fontStyle = isPCO ? 'italic' : '';
            }

            // Restore last active tab, fallback to 'overall'
            // Validate the stored tab is a real tab to prevent white screen
            const _validTabs = ['overall','rates','exposures','medical','nov','nov-monitoring',
                'activities','kpm','dole','emb','doe','doe-permit','env-monthly-report',
                'permits','env-monitoring','cshp','reg','audit','personnel','osh-requirement',
                'esh-calendar-env','esh-calendar-safety','esh-calendar-health','esh-calendar-drills'];
            const _storedTab = localStorage.getItem('esh_last_tab') || 'overall';
            let lastTab = _validTabs.includes(_storedTab) ? _storedTab : 'overall';
            // PCO: if last tab was a non-env tab that's now blocked, redirect to overall
            if (state.userRole === 'pco' && !UserAccounts.PCO_EDITABLE_TABS.includes(lastTab) && !UserAccounts.PCO_VIEW_TABS.includes(lastTab)) {
                lastTab = 'overall';
            }
            // PCO: blocked from personnel and osh-requirement
            if (state.userRole === 'pco' && (lastTab === 'personnel' || lastTab === 'osh-requirement')) {
                lastTab = 'overall';
            }
            try { changeTab(lastTab); } catch(e) {
                console.error('‚ùå changeTab on load failed, falling back to overall:', e);
                try { changeTab('overall'); } catch(e2) { console.error('‚ùå Fallback also failed:', e2); }
            }
        }

        // Helper function to check if a month should be marked as overdue
        function isOverdueMonth(monthIndex) {
            // monthIndex: 1 = January, 2 = February, ..., 12 = December
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = now.getFullYear();
            
            // Only mark as overdue if the month is before the current month in the current year
            return monthIndex < currentMonth;
        }

        // Helper function to check if a quarter is overdue
        function isOverdueQuarter(quarterIndex) {
            // quarterIndex: 1 = Q1 (Jan-Mar), 2 = Q2 (Apr-Jun), 3 = Q3 (Jul-Sep), 4 = Q4 (Oct-Dec)
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            
            // Determine which quarter we're currently in
            const currentQuarter = Math.ceil(currentMonth / 3);
            
            // Quarter is overdue if it's before the current quarter
            return quarterIndex < currentQuarter;
        }

        // Helper function to check if a half-year is overdue
        function isOverdueHalf(halfIndex) {
            // halfIndex: 1 = 1st Half (Jan-Jun), 2 = 2nd Half (Jul-Dec)
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            
            // 1st half is overdue if we're in month 7 or later (July onwards)
            if (halfIndex === 1) return currentMonth > 6;
            
            // 2nd half is never overdue in current year (only when year changes)
            return false;
        }

        // ===== TOAST NOTIFICATION SYSTEM =====
        function showToast(message, type = 'success', duration = 3500) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const meta = {
                success: { icon: '<i class="fas fa-check"></i>',   title: 'Success' },
                error:   { icon: '<i class="fas fa-times"></i>',   title: 'Error'   },
                warning: { icon: '<i class="fas fa-exclamation"></i>', title: 'Warning' },
                info:    { icon: '<i class="fas fa-info"></i>',    title: 'Info'    },
            };
            const m = meta[type] || meta.info;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-accent"></div>
                <div class="toast-body">
                    <div class="toast-icon-wrap">${m.icon}</div>
                    <div class="toast-text-wrap">
                        <div class="toast-title">${m.title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                </div>
                <button class="toast-close" onclick="this.closest('.toast').remove()">√ó</button>
                <div class="toast-progress" style="animation-duration:${duration}ms"></div>
            `;
            
            container.appendChild(toast);
            
            // Limit to 4 toasts max
            const toasts = container.querySelectorAll('.toast');
            if (toasts.length > 4) toasts[0].remove();

            // Auto remove
            const timer = setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 320);
            }, duration);

            toast.querySelector('.toast-close').addEventListener('click', () => clearTimeout(timer));
        }

        // ‚îÄ‚îÄ Sync Status Pill System ‚îÄ‚îÄ
        let _syncPillTimer = null;
        let _pendingSync = false;

        function showSyncPill(state_str, label) {
            let pill = document.getElementById('sync-status-pill');
            if (!pill) {
                pill = document.createElement('div');
                pill.id = 'sync-status-pill';
                pill.innerHTML = `<div class="pill-dot"></div><span class="pill-label"></span>`;
                document.body.appendChild(pill);
            }
            pill.className = `sync-status-pill`;
            pill.id = 'sync-status-pill';
            pill.classList.add(`pill-${state_str}`, 'visible');
            pill.querySelector('.pill-label').textContent = label;
            clearTimeout(_syncPillTimer);
        }

        function hideSyncPill(delay = 2500) {
            clearTimeout(_syncPillTimer);
            _syncPillTimer = setTimeout(() => {
                const pill = document.getElementById('sync-status-pill');
                if (pill) pill.classList.remove('visible');
            }, delay);
        }

        function markPendingSync() {
            _pendingSync = true;
            showSyncPill('pending', '‚è≥ Unsaved changes ‚Äî not yet synced to cloud');
        }

        function markSyncComplete() {
            _pendingSync = false;
            showSyncPill('synced', '‚úì Synced to cloud');
            hideSyncPill(2500);
        }

        function markSyncFailed() {
            _pendingSync = true;
            showSyncPill('pending', '‚ö† Saved locally ‚Äî waiting to sync');
        }

        // Expose sync/toast functions to global scope so personnel/project functions can use them
        window.showSyncPill    = showSyncPill;
        window.hideSyncPill    = hideSyncPill;
        window.markPendingSync = markPendingSync;
        window.markSyncComplete= markSyncComplete;
        window.markSyncFailed  = markSyncFailed;
        window.showToast       = showToast;

        // Warn user if leaving with pending sync
        window.addEventListener('beforeunload', (e) => {
            if (_pendingSync) {
                e.preventDefault();
                e.returnValue = "You have changes that haven't been synced to the cloud yet. Are you sure you want to leave?";
            }
        });
        
        // Phase 3: Regional Locking - Show locked message
        function showLockedMessage(reason) {
            const userEmail = state.currentUser?.email;
            const info = UserAccounts.getUserInfo(userEmail);
            let msg = reason || 'üîí Read-Only Access ‚Äî You do not have permission to modify this record.';
            if (!reason) {
                if (info.role === 'superintendent') {
                    msg = `üîí Read-Only Access ‚Äî Superintendents can only edit records in their assigned region (${info.region}).`;
                } else if (info.role === 'pco') {
                    msg = 'üîí Read-Only Access ‚Äî PCO accounts can only edit Environmental modules within their region.';
                } else if (info.role === 'guest') {
                    msg = 'üîí Not authenticated. Please log in.';
                }
            }
            showToast(msg, 'warning', 5000);
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S = Save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (state.isEditing) {
                    saveData();
                    showToast('Saving data...', 'info', 1500);
                }
            }
            
            // Ctrl/Cmd + E = Toggle Edit
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (!state.isEditing) {
                    toggleEdit();
                    showToast('Edit mode enabled', 'info', 1500);
                }
            }
            
            // Escape = Cancel edit mode only (not modals)
            if (e.key === 'Escape') {
                // Check if any modal is open
                const modals = document.querySelectorAll('.modal.show');
                if (modals.length > 0) {
                    // Modal is open - ESC key does nothing
                    // User must click Cancel or Save button
                    showToast('‚ÑπÔ∏è Please use Cancel or Save button to close', 'info', 2000);
                    return;
                }
                
                if (state.isEditing) {
                    // No modal open, so cancel edit mode
                    showModernDialog(
                        'Cancel Editing?', 
                        'Unsaved changes will be lost. Are you sure you want to cancel?',
                        true,
                        'Discard',
                        'Cancel'
                    ).then(confirmed => {
                        if (confirmed) {
                            location.reload();
                        }
                    });
                }
            }
        });

        // ==================== REGION COLLAPSE/EXPAND FUNCTIONS ====================
        const collapsedRegions = new Set(JSON.parse(localStorage.getItem('esh_collapsed_regions') || '[]'));
        
        function toggleRegion(regionName, event) {
            // Prevent toggle if clicking on buttons inside banner
            if (event && (event.target.tagName === 'BUTTON' || event.target.tagName === 'SELECT' || 
                         event.target.closest('button') || event.target.closest('select'))) {
                return;
            }
            
            const regionContent = document.getElementById(`region-content-${regionName}`);
            const regionBanner = document.getElementById(`region-banner-${regionName}`);
            
            if (!regionContent || !regionBanner) return;
            
            if (collapsedRegions.has(regionName)) {
                // Expand
                collapsedRegions.delete(regionName);
                regionContent.classList.remove('collapsed');
                regionBanner.classList.remove('collapsed');
            } else {
                // Collapse
                collapsedRegions.add(regionName);
                regionContent.classList.add('collapsed');
                regionBanner.classList.add('collapsed');
            }
            
            // Save to localStorage
            localStorage.setItem('esh_collapsed_regions', JSON.stringify([...collapsedRegions]));
        }
        
        function isRegionCollapsed(regionName) {
            return collapsedRegions.has(regionName);
        }
        // ==================== END REGION COLLAPSE/EXPAND ====================

        function render() {
            try {
            const _eshCalTabs = ['esh-calendar-env','esh-calendar-safety','esh-calendar-health','esh-calendar-drills'];
            if (state.currentTab === 'settings' || state.currentTab === 'personnel' || state.currentTab === 'admin' || _eshCalTabs.includes(state.currentTab)) return;

            // Show/hide the lock icon on the audit nav tab for non-admins
            const auditNavLock = document.getElementById('audit-nav-lock');
            if (auditNavLock) auditNavLock.style.display = state.isAdmin ? 'none' : 'inline';

            const container = document.getElementById('dashboard-content');
            let html = '';

            // (RBAC banner is now rendered globally via renderRbacBanner() in changeTab)

            // ‚îÄ‚îÄ INCIDENT TABULATION RATE summary always shows at the TOP of Statistics Rate ‚îÄ‚îÄ
            if (state.currentTab === 'rates') {
                html += buildIncidentTabulationHTML();
                html += buildTrendChartHTML('rates');
            }

            let grandTotal = 0;
            state.projects.forEach(p => grandTotal += getPerc(p));
            const overallAvg = state.projects.length > 0 ? Math.round(grandTotal / state.projects.length) : 0;

            if (state.currentTab === 'overall') {
                // Add search and filters inside dashboard
                html += `
                <div style="background: var(--bg-card); padding: 8px 16px; margin: 0 20px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="search-input" placeholder="üîç Search projects..." onkeyup="handleSearch()" 
                                   value="${state.searchTerm || ''}"
                                   style="width: 100%; padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-primary);">
                        </div>
                        <div>
                            <select id="region-filter" onchange="handleFilter()" 
                                    style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-primary); min-width: 180px;">
                                <option value="" ${state.regionFilter === '' ? 'selected' : ''}>üìç All Regions</option>
                                <option value="NCR" ${state.regionFilter === 'NCR' ? 'selected' : ''}>NCR</option>
                                <option value="SOUTH LUZON" ${state.regionFilter === 'SOUTH LUZON' ? 'selected' : ''}>South Luzon</option>
                                <option value="NORTH LUZON" ${state.regionFilter === 'NORTH LUZON' ? 'selected' : ''}>North Luzon</option>
                                <option value="VISAYAS & MINDANAO" ${state.regionFilter === 'VISAYAS & MINDANAO' ? 'selected' : ''}>Visayas & Mindanao</option>
                            </select>
                        </div>
                        <div>
                            <select id="status-filter" onchange="handleFilter()" 
                                    style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-primary); min-width: 160px;">
                                <option value="" ${state.statusFilter === '' ? 'selected' : ''}>üìä All Status</option>
                                <option value="on-going" ${state.statusFilter === 'on-going' ? 'selected' : ''}>On-Going</option>
                                <option value="work-stoppage" ${state.statusFilter === 'work-stoppage' ? 'selected' : ''}>Work Stoppage</option>
                                <option value="finished" ${state.statusFilter === 'finished' ? 'selected' : ''}>Finished</option>
                            </select>
                        </div>
                    </div>
                </div>
                `;
                
                html += `<div id="grand-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL PROJECTS</div>
                        <div class="stat-value">${state.projects.length}</div>
                        <div class="particles-container">
                            <div class="particle particle-green-1"></div>
                            <div class="particle particle-green-2"></div>
                            <div class="particle particle-green-3"></div>
                            <div class="particle particle-green-4"></div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--safety-yellow);">
                        <div class="stat-label">OVERALL COMPLIANCE</div>
                        <div class="stat-value">${overallAvg}%</div>
                        <div class="particles-container">
                            <div class="particle particle-yellow-1"></div>
                            <div class="particle particle-yellow-2"></div>
                            <div class="particle particle-yellow-3"></div>
                            <div class="particle particle-yellow-4"></div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #1976D2;">
                        <div class="stat-label">ON-GOING</div>
                        <div class="stat-value">${state.projects.filter(p => p.status === 'on-going').length}</div>
                        <div class="particles-container">
                            <div class="particle particle-blue-1"></div>
                            <div class="particle particle-blue-2"></div>
                            <div class="particle particle-blue-3"></div>
                            <div class="particle particle-blue-4"></div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #d32f2f;">
                        <div class="stat-label">WORK STOPPAGE</div>
                        <div class="stat-value">${state.projects.filter(p => p.status === 'work-stoppage').length}</div>
                        <div class="particles-container">
                            <div class="particle particle-red-1"></div>
                            <div class="particle particle-red-2"></div>
                            <div class="particle particle-red-3"></div>
                            <div class="particle particle-red-4"></div>
                        </div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box"><h3><i class="fas fa-chart-bar"></i> Compliance by Region</h3><canvas id="regionChart"></canvas></div>
                    <div class="chart-box"><h3><i class="fas fa-chart-pie"></i> Project Status</h3><canvas id="statusChart"></canvas></div>
                </div>
                `;
                renderCharts();
            }

            // Always use filteredProjects (it will equal projects when no filters active)
            const displayProjects = state.filteredProjects;

            // Add trend chart for medical tab
            if (state.currentTab === 'medical') {
                html += buildTrendChartHTML('medical');
            }

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // OVERALL SUMMARY - ALL REGIONS (para sa specific tabs)
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (['exposures', 'medical', 'activities', 'nov'].includes(state.currentTab) && displayProjects.length > 0) {
                const hasYTD = ['exposures', 'medical', 'activities', 'nov'].includes(state.currentTab);
                const isNov = state.currentTab === 'nov';
                
                html += `
                <div class="tab-info-bar">
                    <div class="tib-icon"><i class="fas fa-globe"></i></div>
                    <div class="tib-body">
                        <p class="tib-sub">Consolidated data from all projects across all regions</p>
                    </div>
                    <div class="tib-badges">
                        <span class="tib-pill tib-pill-green">${displayProjects.length} PROJECTS</span>
                        <span class="tib-pill tib-pill-yellow">ALL REGIONS</span>
                    </div>
                </div>
                
                <div class="table-container" style="margin: 0 20px 20px;">
                    <table>
                        <tr>
                            <th style="width:250px; text-align:left; background: #2e7d32; position: sticky; left: 0; z-index: 10;">TYPE</th>
                            <th class="prev-year${isNov ? ' nov-narrow-th' : ''}" style="background: #388e3c;">PREVIOUS</th>`;
                
                // Monthly column headers
                MONTHS.forEach(m => {
                    html += `<th${isNov ? ' class="nov-narrow-th"' : ''} style="background: #388e3c;">${m}</th>`;
                });
                
                if (hasYTD) {
                    html += `<th class="ytd-header" style="background: #f9a825;">RUNNING YTD</th>`;
                }
                
                html += `</tr>`;
                
                // Calculate totals for each row
                SCHEMA[state.currentTab].forEach((row, rowIdx) => {
                    const key = `${state.currentTab}_${row}`;
                    html += `<tr><td style="text-align:left; font-weight:700; background:#e8f5e9; color:#1b5e20; position: sticky; left: 0; z-index: 5;">${row}</td>`;
                    
                    // Previous Year Total
                    let prevTotal = 0;
                    displayProjects.forEach(p => {
                        const val = p.vals[key] ? (p.vals[key][0] ?? "") : "";
                        if (val !== "" && !isNaN(val)) prevTotal += parseFloat(val);
                    });
                    html += `<td class="prev-year${isNov ? ' nov-narrow-td' : ''}" style="font-weight: 700; font-size: 0.7rem;">${prevTotal > 0 ? fmtNum(prevTotal) : ''}</td>`;
                    
                    // Monthly Totals
                    for (let i = 1; i <= 12; i++) {
                        let monthTotal = 0;
                        const mi = i - 1; // 0-based month index for ESH calendar
                        if (state.currentTab === 'activities' && (row === 'Drills Conducted' || row === 'Training Conducted')) {
                            const eshStor = getEshStorage();
                            displayProjects.forEach(p => {
                                if (row === 'Drills Conducted') {
                                    ESH_DRILLS.forEach((drill, di) => {
                                        const ak = `esh-calendar-drills|${p.name}|${di}|${mi}|actual`;
                                        if (eshStor[ak]) monthTotal++;
                                    });
                                } else {
                                    ['esh-calendar-env','esh-calendar-safety','esh-calendar-health'].forEach(tt => {
                                        (ESH_TRAININGS[tt] || []).forEach((tr, ti) => {
                                            const ak = `${tt}|${p.name}|${ti}|${mi}|actual`;
                                            if (eshStor[ak]) monthTotal++;
                                        });
                                    });
                                }
                            });
                            // Past/current month with no entry ‚Üí show 0 in summary too
                            const _n = new Date(); const _cy = _n.getFullYear(); const _cm = _n.getMonth();
                            const _sy = state.selectedYear || _cy;
                            const _isPast = _sy < _cy || (_sy === _cy && mi <= _cm);
                            const _disp = monthTotal > 0 ? fmtNum(monthTotal) : (_isPast ? '0' : '');
                            html += `<td class="${isNov ? 'nov-narrow-td' : 'monthly-data'}" style="font-weight:600;background:${monthTotal>0?'#f1f8e9':''};">${_disp}</td>`;
                        } else {
                            displayProjects.forEach(p => {
                                const val = p.vals[key] ? (p.vals[key][i] ?? "") : "";
                                if (val !== "" && !isNaN(val)) monthTotal += parseFloat(val);
                            });
                            html += `<td class="${isNov ? 'nov-narrow-td' : 'monthly-data'}" style="font-weight: 600; background: #f1f8e9;">${monthTotal > 0 ? fmtNum(monthTotal) : ''}</td>`;
                        }
                    }
                    
                    // Running YTD Total
                    if (hasYTD) {
                        let ytdTotal = 0;
                        if (row === "Total Manpower") {
                            // For Total Manpower, calculate average across all projects
                            let totalAvg = 0;
                            let projectCount = 0;
                            displayProjects.forEach(p => {
                                const avg = calculateAverage(p.vals[key], rowIdx);
                                if (avg > 0) {
                                    totalAvg += avg;
                                    projectCount++;
                                }
                            });
                            ytdTotal = projectCount > 0 ? Math.round(totalAvg / projectCount) : 0;
                            html += `<td class="average-cell" style="font-weight: 800; font-size: 0.7rem;">${ytdTotal > 0 ? fmtNum(ytdTotal) : ''}</td>`;
                        } else if (state.currentTab === 'activities' && (row === 'Drills Conducted' || row === 'Training Conducted')) {
                            const eshStor = getEshStorage();
                            displayProjects.forEach(p => {
                                for (let mi = 0; mi < 12; mi++) {
                                    if (row === 'Drills Conducted') {
                                        ESH_DRILLS.forEach((drill, di) => {
                                            const ak = `esh-calendar-drills|${p.name}|${di}|${mi}|actual`;
                                            if (eshStor[ak]) ytdTotal++;
                                        });
                                    } else {
                                        ['esh-calendar-env','esh-calendar-safety','esh-calendar-health'].forEach(tt => {
                                            (ESH_TRAININGS[tt] || []).forEach((tr, ti) => {
                                                const ak = `${tt}|${p.name}|${ti}|${mi}|actual`;
                                                if (eshStor[ak]) ytdTotal++;
                                            });
                                        });
                                    }
                                }
                            });
                            html += `<td class="ytd-cell" style="font-weight: 800; font-size: 0.7rem;">${ytdTotal > 0 ? fmtNum(ytdTotal) : ''}</td>`;
                        } else {
                            // For other rows, sum YTD
                            displayProjects.forEach(p => {
                                const ytd = calculateYTD(p.vals[key], rowIdx);
                                if (ytd > 0) ytdTotal += ytd;
                            });
                            html += `<td class="ytd-cell" style="font-weight: 800; font-size: 0.7rem;">${ytdTotal > 0 ? fmtNum(ytdTotal) : ''}</td>`;
                        }
                    }
                    
                    html += `</tr>`;
                });
                
                html += `</table></div>
                
                <div style="margin: 0 20px 30px; padding: 15px; background: #fff3e0; border-left: 5px solid #ff9800; border-radius: 6px;">
                    <p style="margin: 0; font-size: 0.85rem; color: #e65100; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> This summary aggregates data from <strong>${displayProjects.length} project(s)</strong> across all regions. 
                        Individual project details are shown below by region.
                    </p>
                </div>`;
            }

            // Show welcome message if no projects exist yet
            if (state.projects.length === 0 && state.currentTab === 'overall') {
                html += `<div style="background: var(--bg-card); border-radius: 12px; padding: 40px; text-align: center; margin: 20px 0; border: 2px dashed var(--border-color);">
                    <i class="fas fa-rocket" style="font-size: 3rem; color: #2e7d32; opacity: 0.6; margin-bottom: 15px;"></i>
                    <h3 style="color: var(--text-primary); margin: 10px 0; font-size: 1.2rem;">Welcome to ESH Compliance Dashboard!</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0 20px; font-size: 0.9rem;">Get started by adding your first project. Click the <strong>EDIT</strong> button above, then use <strong>+ ADD PROJECT</strong> in any region below.</p>
                    <button onclick="toggleEdit()" class="btn btn-primary" style="padding: 12px 30px; font-size: 0.9rem;">
                        <i class="fas fa-plus-circle"></i> START ADDING PROJECTS
                    </button>
                </div>`;
            }

            // Skip region-based rendering for DOE tabs (they have their own rendering)
            if (state.currentTab !== 'doe' && state.currentTab !== 'doe-permit') {

                // ‚îÄ‚îÄ Tab header banners (uniform style matching DOE) ‚îÄ‚îÄ
                const tabBanners = {
                    'kpm': {
                        icon: 'fa-file-lines',
                        iconColor: '#fbc02d',
                        title: 'MONTHLY REPORT (KPM&I)',
                        sub1: 'Monthly submission required for each project',
                        sub2: `<i class="fas fa-calendar-check"></i> Tracking ${displayProjects.length} project(s) ‚Äî KPM & Inspection reports`
                    },
                    'emb': {
                        icon: 'fa-leaf',
                        iconColor: '#a5d6a7',
                        title: 'EMB REPORTORIAL',
                        sub1: 'SMR: Quarterly (Due 15th of following month) &nbsp;|&nbsp; CMR: Semi-Annual (Due Jul 15 & Jan 15)',
                        sub2: `<i class="fas fa-seedling"></i> Showing ${displayProjects.length} project(s) ‚Äî Self-Monitoring & Compliance Reports`
                    },
                    'dole': {
                        icon: 'fa-hard-hat',
                        iconColor: '#fbc02d',
                        title: 'DOLE REPORTORIAL',
                        sub1: 'WAIR/RSO/MOM: Monthly &nbsp;|&nbsp; AEDR & AMR: Annual (submitted every January)',
                        sub2: `<i class="fas fa-clipboard-list"></i> Showing ${displayProjects.length} project(s) ‚Äî Department of Labor and Employment reports`
                    },
                    'exposures': {
                        icon: 'fa-users',
                        iconColor: '#a5d6a7',
                        title: 'TOTAL EXPOSURES',
                        sub1: 'Monthly manpower and manhour exposure tracking per project',
                        sub2: `<i class="fas fa-hard-hat"></i> Showing ${displayProjects.length} project(s) ‚Äî Total Manpower, Manhours & LTA-free days`
                    },
                    'activities': {
                        icon: 'fa-calendar-check',
                        iconColor: '#fbc02d',
                        title: 'ESH ACTIVITIES AND PROGRAMS',
                        sub1: 'Monthly ESH activities, inspections, near-miss, drills and training records',
                        sub2: `<i class="fas fa-clipboard-list"></i> Tracking ${displayProjects.length} project(s) ‚Äî ESH Committee, Inspections, Near-Miss, Drills & Trainings`
                    }
                };

                if (tabBanners[state.currentTab]) {
                    const b = tabBanners[state.currentTab];
                    html += `
                    <div class="tab-info-bar">
                        <div class="tib-icon"><i class="fas ${b.icon}"></i></div>
                        <div class="tib-body">
                            <p class="tib-sub">${b.sub1}</p>
                            <p class="tib-sub" style="opacity:0.75;">${b.sub2}</p>
                        </div>
                        <div class="tib-badges">
                            <span class="tib-pill tib-pill-green">${displayProjects.length} PROJECTS</span>
                        </div>
                    </div>`;
                }

                REGIONS.forEach(reg => {
                // ‚îÄ‚îÄ CORPORATE visibility gate ‚îÄ‚îÄ
                // CORPORATE only appears in these 5 tabs; hidden everywhere else.
                const CORPORATE_ALLOWED_TABS = ['overall', 'rates', 'exposures', 'dole', 'medical', 'nov', 'nov-monitoring'];
                if (reg === 'CORPORATE' && !CORPORATE_ALLOWED_TABS.includes(state.currentTab)) return;

                const projs = displayProjects.filter(p => p.region === reg);
                
                // Calculate region average only if there are projects
                const regSum = projs.reduce((sum, p) => sum + getPerc(p), 0);
                const regionAvg = projs.length > 0 ? Math.round(regSum / projs.length) : 0;

                // Always show region banner, even if empty (so user can add projects)
                const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg) && UserAccounts.canEditTab(state.currentUser?.email, state.currentTab);
                const isCollapsed = isRegionCollapsed(reg);
                
                const isCorporateReg = reg === 'CORPORATE';
                const CORP_DATA_TABS = ['overall', 'rates', 'exposures', 'dole', 'medical', 'nov', 'nov-monitoring'];
                const isCorporateDataTab = isCorporateReg && CORP_DATA_TABS.includes(state.currentTab);
                const regIcon = isCorporateReg ? 'fa-building-columns' : 'fa-location-dot';
                const regLabel = isCorporateReg ? 'CORPORATE' : reg;
                html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                    <div class="region-banner-inner">
                        <div class="region-banner-left">
                            <i class="fas ${regIcon} region-icon"></i>
                            <span class="region-name">${regLabel}</span>
                            ${isCorporateReg ? `<span class="rbadge rbadge-admin">ADMIN ONLY</span>` : ''}
                            ${!canEditRegion && !isCorporateReg ? `<i class="fas fa-lock" style="color:#fbc02d;font-size:0.7rem;" title="üîí View Only"></i>` : ''}
                        </div>
                        <div class="region-banner-right">
                            ${(!isCorporateReg || isCorporateDataTab) ? `<span class="rbadge rbadge-count">${projs.length} PROJ</span>` : ''}
                            ${(!isCorporateReg || isCorporateDataTab) && projs.length > 0 ? `<span class="rbadge rbadge-avg">AVG ${regionAvg}%</span>` : ''}
                            ${(!isCorporateReg || isCorporateDataTab) && state.isEditing && canEditRegion ? `<button onclick="event.stopPropagation(); openAddProjectModal('${reg}')" class="btn btn-primary" style="font-size:0.68rem;padding:3px 10px;line-height:1.4;">+ ADD</button>` : ''}
                            ${(!isCorporateReg || isCorporateDataTab) && state.isEditing && !canEditRegion ? `<button disabled style="opacity:0.45;cursor:not-allowed;background:#888;font-size:0.68rem;padding:3px 10px;line-height:1.4;" class="btn btn-primary">LOCKED</button>` : ''}
                            ${!isCorporateReg && state.currentTab === 'overall' && projs.length > 0 ? `<select class="sort-select" onclick="event.stopPropagation()" onchange="sortProjects(this.value)" style="font-size:0.68rem;padding:2px 7px;">
                                <option value="name" ${state.currentSort === 'name' ? 'selected' : ''}>Sort: Name</option>
                                <option value="dateStarted" ${state.currentSort === 'dateStarted' ? 'selected' : ''}>Sort: Date Started</option>
                                <option value="dateFinished" ${state.currentSort === 'dateFinished' ? 'selected' : ''}>Sort: Date Finished</option>
                            </select>` : ''}
                            <i class="fas fa-chevron-down region-toggle-icon"></i>
                        </div>
                    </div>
                </div>`;

                html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;

                {

                // Show empty state message if no projects in this region
                if (projs.length === 0 && state.isEditing) {
                    html += `<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.85rem; font-style: italic;">
                        <i class="fas fa-folder-open" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
                        ${isCorporateDataTab ? 'No CORPORATE entry yet. Click "+ ADD" above to add CORPORATE data.' : 'No projects in this region yet. Click "+ ADD PROJECT" to get started.'}
                    </div>`;
                }

                projs.forEach(p => {
                    const perc = getPerc(p);
                    const statusClass = p.status === 'on-going' ? 'status-ongoing' : p.status === 'work-stoppage' ? 'status-stoppage' : 'status-finished';
                    const statusLabel = p.status === 'on-going' ? 'On-Going' : p.status === 'work-stoppage' ? 'Work Stoppage' : 'Finished';
                    
                    // Check if user can edit this project (Phase 3: Regional Locking)
                    const canEdit = UserAccounts.canEdit(state.currentUser?.email, p.region) && UserAccounts.canEditTab(state.currentUser?.email, state.currentTab);
                    const isLocked = !canEdit;
                    // Audit tab is admin-only for editing
                    const isAuditAdminLocked = state.currentTab === 'audit' && !state.isAdmin;
                    const inputsEditable = state.isEditing && canEdit && !isAuditAdminLocked; // For table inputs

                    html += `<div class="project-row ${isLocked ? 'project-locked' : ''}">
                        ${state.isEditing ? `<input type="checkbox" class="project-checkbox" ${p.selected ? 'checked' : ''} ${isLocked ? 'disabled' : ''} onchange="toggleProjectSelect('${p.name}')">` : ''}
                        <div class="circular-progress" style="--percentage: ${perc * 3.6}deg;">
                            <div class="circular-progress-inner">${perc}%</div>
                        </div>
                        <div class="project-info">
                            <div class="project-name">
                                ${isLocked ? '<i class="fas fa-lock" style="color: #f57c00; margin-right: 6px;" title="View Only - Contact admin to edit"></i>' : ''}
                                ${p.isRenewable ? '<span style="display: inline-flex; align-items: center; gap: 4px; background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; margin-right: 6px;"><i class="fas fa-leaf" style="color: #4caf50;"></i> RE</span>' : ''}
                                ${p.name}
                            </div>
                            <div class="project-meta">Safety Compliance ‚Ä¢ ${p.region || 'No Region'}</div>
                        </div>
                        <div class="project-dates">
                            <div><span class="date-label">Started:</span> ${p.dateStarted ? formatDateDMY(p.dateStarted) : 'Not set'}</div>
                            <div><span class="date-label">Finished:</span> ${p.dateFinished ? formatDateDMY(p.dateFinished) : 'Ongoing'}</div>
                        </div>
                        <span class="status-badge ${statusClass}" onclick="${isLocked ? 'showLockedMessage()' : `changeProjectStatus('${p.name}', event)`}">${statusLabel}</span>
                        ${state.isEditing ? `
                            <button ${isLocked ? 'disabled' : ''} onclick="${isLocked ? 'showLockedMessage()' : `openEditProjectModal('${p.name.replace(/'/g, "\\'")}', '${p.region}')`}" style="background:none;border:none;cursor:pointer;color:#555;font-size:1rem;padding:4px 6px;margin-right:2px;opacity:${isLocked ? '0.5' : '1'};" title="${isLocked ? 'View Only - Contact admin to edit' : 'Edit Project Details'}">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button ${isLocked ? 'disabled' : ''} onclick="${isLocked ? 'showLockedMessage()' : `deleteProject('${p.name}')`}" style="background:none;border:none;cursor:pointer;color:#d32f2f;font-size:1rem;padding:4px 6px;opacity:${isLocked ? '0.5' : '1'};" title="${isLocked ? 'View Only - Contact admin to edit' : 'Delete Project'}"><i class="fas fa-trash"></i></button>
                        ` : ''}
                    </div>`;

if (state.currentTab === 'audit') {
    // Admin-only lock banner for non-admin users
    if (!state.isAdmin) {
        html += `<div style="display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:1.5px solid #fb8c00;border-radius:10px;padding:12px 18px;margin-bottom:14px;font-size:0.85rem;color:#e65100;font-weight:600;"><i class='fas fa-lock' style='font-size:1.1rem;'></i><span>This tab is <strong>view-only</strong>. Only Admins can input data in the Internal ESH Audit Report.</span></div>`;
    }
    html += `<div class="table-container">
        <style>
            .audit-table {
                border-collapse: separate;
                border-spacing: 0;
                width: 100%;
                max-width: 1100px;
                margin: 20px auto;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 8px 24px rgba(27, 94, 32, 0.15), 0 2px 6px rgba(0, 0, 0, 0.08);
                background: white;
            }
            
            /* Enhanced Green Header - Option 4 Style */
            .audit-table thead th {
                background: #1b5e20;
                color: #ffffff;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                font-size: 11px;
                padding: 16px 8px;
                border: none;
                border-bottom: 3px solid var(--safety-yellow);
                position: relative;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }
            
            /* Top row headers - Quarter labels */
            .audit-table thead tr:first-child th {
                font-size: 13px;
                padding: 18px 8px;
                font-weight: 800;
                letter-spacing: 1.2px;
                background: #1b5e20;
            }
            
            /* Second row - Score labels */
            .audit-table thead tr:nth-child(2) th {
                font-size: 12px;
                padding: 14px 8px;
                background: #1b5e20;
            }
            
            /* Column headers with white background */
            .audit-table thead tr:last-child th {
                background: #f8f9fa;
                color: #1b5e20;
                font-size: 10px;
                padding: 12px 6px;
                border-top: 2px solid #2e7d32;
                font-weight: 600;
                letter-spacing: 0.5px;
            }
            
            /* Average column styling */
            .audit-table thead tr:last-child th[style*="background: #808080"],
            .audit-table thead tr:last-child th[style*="background:#808080"] {
                background: linear-gradient(135deg, #616161 0%, #757575 100%) !important;
                color: white !important;
                font-weight: 700;
            }
            
            /* Body cells - Option 4 striped design */
            .audit-table td { 
                border: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                text-align: center; 
                vertical-align: middle; 
                padding: 12px 8px;
                font-size: 13px;
                transition: all 0.2s ease;
            }
            
            /* Row hover effect - Option 4 style with left border */
            .audit-table tbody tr {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-left: 3px solid transparent;
            }
            
            .audit-table tbody tr:nth-child(odd) {
                background-color: #ffffff;
            }
            
            .audit-table tbody tr:nth-child(even) {
                background-color: #f1f8e9;
            }
            
            
            /* Specific cell styles */
            .cell-white { 
                background-color: #ffffff;
            }
            
            .cell-avg-gray { 
                background: linear-gradient(135deg, #616161 0%, #757575 100%) !important;
                color: white !important; 
                font-weight: 700;
                font-size: 14px;
                letter-spacing: 0.3px;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .cell-grand-total { 
                background: linear-gradient(135deg, #ffd54f 0%, #ffeb3b 100%) !important;
                color: #1b5e20 !important; 
                font-weight: 800;
                font-size: 16px;
                letter-spacing: 0.5px;
                box-shadow: inset 0 2px 6px rgba(251, 192, 45, 0.4);
                border: 2px solid #fbc02d !important;
            }
            
            /* Enhanced input styling */
            .audit-table input { 
                text-align: center; 
                width: 52px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                padding: 6px 4px;
                transition: all 0.2s ease;
                background: white;
                color: #1b5e20;
                font-family: 'Inter', sans-serif;
            }
            
            
            .audit-table input:focus {
                outline: none;
                border-color: #2e7d32;
                background: #ffffff;
                box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            }
            
            .audit-table input:disabled {
                background: #f5f5f5;
                color: #757575;
                cursor: not-allowed;
                border-color: #e0e0e0;
            }
            
            .audit-table p { 
                margin: 0; 
                padding: 0; 
                font-size: 11px;
                line-height: 1.4;
            }
            
            /* Dark mode support for audit table */
            body.dark-mode .audit-table {
                background: #2d2d2d;
            }
            
            body.dark-mode .audit-table tbody tr:nth-child(odd) {
                background-color: #2d2d2d;
            }
            
            body.dark-mode .audit-table tbody tr:nth-child(even) {
                background-color: #1f2e1f;
            }
            
            
            body.dark-mode .audit-table td {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            /* Responsive design */
            @media (max-width: 768px) {
                .audit-table {
                    font-size: 10px;
                    max-width: 100%;
                    border-radius: 8px;
                }
                
                .audit-table thead th {
                    padding: 10px 4px;
                    font-size: 9px;
                }
                
                .audit-table td {
                    padding: 8px 4px;
                    font-size: 11px;
                }
                
                .audit-table input {
                    width: 40px;
                    font-size: 11px;
                    padding: 4px 2px;
                }
            }
        </style>
        
        <table class="audit-table">
            <thead>
                <tr>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q1 (JAN-MAR)</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q2 (APR-JUN)</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q3 (JUL-SEP)</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q4 (OCT-DEC)</th>
                    <th rowspan="3" class="cell-grand-total" style="border-left: 3px solid #fbc02d; vertical-align: middle; line-height: 1.3;">GRAND<br>TOTAL<br>AVERAGE</th>
                </tr>
                <tr>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                </tr>
                <tr>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                    
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                    
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                    
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                </tr>
            </thead>
            <tbody>
                <tr>`;

    const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
    let totalYearAvg = 0;
    
    quarters.forEach(q => {
        const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
        const qAvg = (audit.scoreImpl + audit.docuComp) / 2;
        totalYearAvg += qAvg;

        html += `
            <td class="cell-white"><input type="number" min="0" max="100" value="${audit.scoreImpl}" ${inputsEditable ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)" placeholder="0"></td>
            <td class="cell-white"><input type="number" min="0" max="100" value="${audit.docuComp}" ${inputsEditable ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)" placeholder="0"></td>
            <td class="cell-avg-gray" style="border-right: 2px solid #e0e0e0;">${qAvg.toFixed(2)}</td>`;
    });

    html += `<td class="cell-grand-total">${(totalYearAvg / 4).toFixed(2)}</td>
                </tr>
            </tbody>
        </table>
    </div>`;
}

                  // ==================== DOE TABS MOVED AFTER GROUPED TABLES ====================
                  // (See after line ~7687 for DOE Reportorial and DOE Safety Officer Permit rendering)
                  
                  if (state.currentTab === 'nov-monitoring') {
    // Special rendering for ESH NOV Monitoring - all projects grouped per region
    // Skip individual project rendering - will be done at region level
}
else if (state.currentTab !== 'overall' && state.currentTab !== 'audit' && state.currentTab !== 'doe' && state.currentTab !== 'doe-permit') {
    const isDateType = ['kpm','dole','permits','emb','cshp','reg','env-monthly-report'].includes(state.currentTab);
    const isCshp = state.currentTab === 'cshp' || state.currentTab === 'reg';
    const hasYTD = ['exposures', 'rates', 'medical', 'nov', 'activities'].includes(state.currentTab);
    const isNov = state.currentTab === 'nov';

    // Adjust TYPE column width based on tab - narrower for short text tabs
    let typeColumnWidth = '250px';
    if (state.currentTab === 'permits' || state.currentTab === 'dole') {
        typeColumnWidth = '280px'; // Wider for long permit names
    } else if (state.currentTab === 'emb') {
        typeColumnWidth = '220px';
    }

    html += `<div class="table-container"><table>`;
    html += `<tr><th style="width:${typeColumnWidth}; min-width:${typeColumnWidth}; max-width:${typeColumnWidth}; text-align:left; background: #2e7d32; position: sticky; left: 0; z-index: 10; white-space: normal; padding: 10px 12px; line-height: 1.3; vertical-align: middle;">TYPE</th>`;

    if (isCshp) {
        const headerText = (state.currentTab === 'cshp') ? "DATE APPROVED" : "DATE REGISTERED";
        html += `<th style="background: #388e3c;">${headerText}</th>`;
    } else {
        // Previous column header
        if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb' && state.currentTab !== 'permits') {
            html += `<th class="prev-year${isNov ? ' nov-narrow-th' : ''}" style="background: #388e3c;">PREVIOUS</th>`;
        }

        // Main columns
        if (state.currentTab === 'emb') {
            html += `<th style="background: #388e3c;">Q1 (JAN-MAR)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Apr 15</small></th>`;
            html += `<th style="background: #388e3c;">Q2 (APR-JUN)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Jul 15</small></th>`;
            html += `<th style="background: #388e3c;">Q3 (JUL-SEP)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Oct 15</small></th>`;
            html += `<th style="background: #388e3c;">Q4 (OCT-DEC)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Jan 15</small></th>`;
        } else if (state.currentTab === 'permits') {
            html += `<th style="background: #388e3c; min-width: 200px; white-space: normal; padding: 10px 12px;">PERMIT NO. / ACCREDITATION NO.</th>`;
            html += `<th style="background: #388e3c; min-width: 140px; white-space: nowrap;">DATE ISSUED</th>`;
            html += `<th style="background: #388e3c; min-width: 140px; white-space: nowrap;">EXPIRY DATE</th>`;
        } else {
            const isDole = state.currentTab === 'dole';
            MONTHS.forEach(m => html += `<th${isNov ? ' class="nov-narrow-th"' : (isDole ? ' class="dole-narrow-th"' : '')} style="background: #388e3c;">${m}</th>`);
        }

        if (hasYTD) {
            html += `<th class="ytd-header" style="background: #f9a825;">RUNNING YTD</th>`;
        }
    }

    html += `</tr>`;

    // Safety check: Ensure SCHEMA exists for this tab
    if (!SCHEMA[state.currentTab]) {
        console.warn(`‚ö†Ô∏è No SCHEMA defined for tab: ${state.currentTab}`);
        html += `</table></div>`;
        return html;
    }

    SCHEMA[state.currentTab].forEach((row, rowIdx) => {
        const key = `${state.currentTab}_${row}`;
        
        const isPermitNA = state.currentTab === 'permits' && p.vals[key] && p.vals[key]['na'];
        const rowStyle = isPermitNA ? 'opacity:0.4; background:#f5f5f5;' : '';
        const naBtn = state.currentTab === 'permits'
            ? `<span onclick="togglePermitNA('${p.name}','${key}')" title="Mark as Not Applicable" style="
                display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
                font-size:0.63rem; font-weight:700; padding:3px 8px; border-radius:20px; border:1.5px solid;
                white-space:nowrap; user-select:none; transition: all 0.2s; flex-shrink:0; min-width:38px;
                ${isPermitNA
                    ? 'background:#ef5350; color:white; border-color:#ef5350;'
                    : 'background:transparent; color:#9e9e9e; border-color:#bdbdbd;'}
              ">${isPermitNA ? '‚úï N/A' : 'N/A'}</span>`
            : '';
        html += `<tr style="${rowStyle}"><td style="width:${typeColumnWidth}; min-width:${typeColumnWidth}; max-width:${typeColumnWidth}; text-align:left; font-weight:700; background:${isPermitNA ? '#fce4e4' : '#e8f5e9'}; color:${isPermitNA ? '#b71c1c' : '#1b5e20'}; position: sticky; left: 0; z-index: 5; white-space: normal; padding: 10px 12px; line-height: 1.3; vertical-align: middle;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <span style="flex:1;">${row}</span>
                ${naBtn}
            </div>
        </td>`;

        if (isCshp) {
            const v = p.vals[key] ? (p.vals[key][1] ?? "") : "";
            html += `<td><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>`;
        } else {
            // Previous Year Column
            const prevVal = p.vals[key] ? (p.vals[key][0] ?? "") : "";
            const prevValFmt = (!isDateType && prevVal !== '') ? fmtNum(prevVal) : prevVal;
            
            if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb' && state.currentTab !== 'permits') {
                // For "Total Exposed Man-hour to date" Previous column:
                // editable, and monthly cells update live without full re-render
                const _isToDate = state.currentTab === 'exposures' && row === 'Total Exposed Man-hour to date';
                const _onchangeExtra = _isToDate
                    ? `;updateToDateMonthCells('${p.name}')`
                    : ``;

                // Drills Conducted & Training Conducted ‚Äî ALWAYS read-only (auto from ESH Calendar)
                const _isDrillTraining = state.currentTab === 'activities' && (row === 'Drills Conducted' || row === 'Training Conducted');

                if (_isDrillTraining) {
                    // Show computed previous value as read-only display (no manual input allowed)
                    html += `<td class="prev-year${isNov ? ' nov-narrow-td' : ''}" style="text-align:center;background:rgba(46,125,50,0.05);" title="Auto-computed from ESH Calendar & Drills ‚Äî cannot be edited manually">
                        <span style="font-size:0.7rem;color:var(--text-primary);font-weight:700;">${prevValFmt || ''}</span>
                        <i class="fas fa-lock" style="font-size:0.45rem;margin-left:3px;opacity:0.4;vertical-align:middle;"></i>
                    </td>`;
                } else {
                    html += `<td class="prev-year${isNov ? ' nov-narrow-td' : ''}">
                    <input type="${isDateType ? 'date' : 'text'}" ${isDateType ? '' : 'inputmode="decimal" data-num'}
                        value="${prevValFmt}"
                        ${inputsEditable ? '' : 'disabled'}
                        ${isDateType ? `oninput="updateVal('${p.name}','${key}',0,this.value)${_onchangeExtra}"` : `oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',0,v)${_onchangeExtra}})"`}>
                </td>`;
                }
            }
            
            // Main data columns
            if (state.currentTab === 'permits') {
                const naDisabled = isPermitNA ? 'disabled' : (inputsEditable ? '' : 'disabled');
                const naPlaceholder = isPermitNA ? 'N/A' : 'Permit/Accreditation #';

                if (row === 'ECC') {
                    // --- ECC: multi-entry support ---
                    const eccKey = `permits_ECC`;
                    const rawVal = p.vals[eccKey];

                    // Get entries array ‚Äî migrate legacy single entry on-the-fly for display
                    let entries = rawVal?.entries;
                    if (!entries) {
                        const legacyNo   = rawVal ? (rawVal[1] ?? '') : '';
                        const legacyIss  = rawVal ? (rawVal[2] ?? '') : '';
                        const legacyExp  = rawVal ? (rawVal[3] ?? '') : '';
                        entries = (legacyNo || legacyIss || legacyExp)
                            ? [{ permitNo: legacyNo, dateIssued: legacyIss, expiryDate: legacyExp }]
                            : [{ permitNo: '', dateIssued: '', expiryDate: '' }];
                    }
                    if (entries.length === 0) entries = [{ permitNo: '', dateIssued: '', expiryDate: '' }];

                    entries.forEach((entry, idx) => {
                        const isFirst = idx === 0;
                        if (!isFirst) {
                            // Extra rows: repeat the TYPE cell with entry number + remove btn
                            html += `</tr><tr style="${rowStyle}"><td style="width:${typeColumnWidth}; min-width:${typeColumnWidth}; max-width:${typeColumnWidth}; text-align:left; font-weight:700; background:${isPermitNA ? '#fce4e4' : '#e8f5e9'}; color:${isPermitNA ? '#b71c1c' : '#1b5e20'}; position: sticky; left: 0; z-index: 5; white-space: normal; padding: 8px 12px; line-height: 1.3; vertical-align: middle;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                    <span style="flex:1; font-size:0.78rem; color:#555;">ECC #${idx + 1}</span>
                                    ${inputsEditable ? `<span onclick="removeEccEntry('${p.name}',${idx})" title="Remove this entry" style="display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.6rem;font-weight:700;padding:2px 7px;border-radius:20px;border:1.5px solid #ef5350;color:#ef5350;background:transparent;user-select:none;white-space:nowrap;">‚úï Remove</span>` : ''}
                                </div>
                            </td>`;
                        }
                        html += `<td style="min-width:200px;padding:8px 12px;"><input type="text" placeholder="${isPermitNA ? 'N/A' : 'Permit/Accreditation #'}" value="${isPermitNA ? '' : (entry.permitNo ?? '')}" ${naDisabled} oninput="updateEccEntry('${p.name}',${idx},'permitNo',this.value)" style="width:100%;${isPermitNA ? 'background:#f5f5f5;color:#bbb;' : ''}"></td>`;
                        html += `<td style="min-width:140px;padding:8px 12px;"><input type="date" value="${isPermitNA ? '' : (entry.dateIssued ?? '')}" ${naDisabled} oninput="updateEccEntry('${p.name}',${idx},'dateIssued',this.value)" style="width:100%;${isPermitNA ? 'background:#f5f5f5;' : ''}"></td>`;
                        html += `<td style="min-width:140px;padding:8px 12px; position:relative;">
                            <input type="date" value="${isPermitNA ? '' : (entry.expiryDate ?? '')}" ${naDisabled} oninput="updateEccEntry('${p.name}',${idx},'expiryDate',this.value)" style="width:100%;${isPermitNA ? 'background:#f5f5f5;' : ''}">
                            ${isFirst && inputsEditable && !isPermitNA ? `<button onclick="addEccEntry('${p.name}')" title="Add another ECC entry" style="position:absolute;bottom:-12px;right:4px;z-index:10;background:#2e7d32;color:white;border:none;border-radius:12px;padding:2px 10px;font-size:0.65rem;font-weight:700;cursor:pointer;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.2);">+ Add ECC</button>` : ''}
                        </td>`;
                    });
                } else {
                    // --- Normal permit row ---
                    const permitNo  = p.vals[key] ? (p.vals[key][1] ?? "") : "";
                    const dateIssued = p.vals[key] ? (p.vals[key][2] ?? "") : "";
                    const expiryDate = p.vals[key] ? (p.vals[key][3] ?? "") : "";
                    html += `<td style="min-width: 200px; padding: 8px 12px;"><input type="text" placeholder="${naPlaceholder}" value="${isPermitNA ? '' : permitNo}" ${naDisabled} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 100%;${isPermitNA ? 'background:#f5f5f5;color:#bbb;' : ''}"></td>`;
                    html += `<td style="min-width: 140px; padding: 8px 12px;"><input type="date" value="${isPermitNA ? '' : dateIssued}" ${naDisabled} oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 100%;${isPermitNA ? 'background:#f5f5f5;' : ''}"></td>`;
                    html += `<td style="min-width: 140px; padding: 8px 12px;"><input type="date" value="${isPermitNA ? '' : expiryDate}" ${naDisabled} oninput="updateVal('${p.name}','${key}',3,this.value)" style="width: 100%;${isPermitNA ? 'background:#f5f5f5;' : ''}"></td>`;
                }
            } else if (state.currentTab === 'emb') {
                // EMB Reportorial - Simple approach
                if (row === "SMR (Quarterly) - Submission Date") {
                    // SMR: Q1, Q2, Q3, Q4
                    for (let i = 1; i <= 4; i++) {
                        const v = p.vals[key] ? (p.vals[key][i] ?? "") : "";
                        html += `<td class="monthly-data"><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                } else if (row === "SMR (Quarterly) - Reference No.") {
                    // SMR: Q1, Q2, Q3, Q4
                    for (let i = 1; i <= 4; i++) {
                        const v = p.vals[key] ? (p.vals[key][i] ?? "") : "";
                        html += `<td class="monthly-data"><input type="text" placeholder="Ref #" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                } else if (row === "CMR (Semi-Annual) - Submission Date") {
                    // CMR: 2 semi-annual periods with clear labels
                    // Period 1: Jan-June (Q1-Q2 merged) - Due July 15
                    const v1 = p.vals[key] ? (p.vals[key][1] ?? "") : "";
                    html += `<td colspan="2" style="text-align: center; border-right: 2px solid #ddd;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jan-Jun (Due: Jul 15)</div>
                        <input type="date" value="${v1}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 180px;">
                    </td>`;
                    // Period 2: Jul-Dec (Q3-Q4 merged) - Due January 15
                    const v2 = p.vals[key] ? (p.vals[key][2] ?? "") : "";
                    html += `<td colspan="2" style="text-align: center;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jul-Dec (Due: Jan 15)</div>
                        <input type="date" value="${v2}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 180px;">
                    </td>`;
                } else if (row === "CMR (Semi-Annual) - Reference No.") {
                    // CMR: 2 semi-annual periods with clear labels
                    // Period 1: Jan-June (Q1-Q2 merged)
                    const v1 = p.vals[key] ? (p.vals[key][1] ?? "") : "";
                    html += `<td colspan="2" style="text-align: center; border-right: 2px solid #ddd;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jan-Jun</div>
                        <input type="text" placeholder="Ref #" value="${v1}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 180px;">
                    </td>`;
                    // Period 2: Jul-Dec (Q3-Q4 merged)
                    const v2 = p.vals[key] ? (p.vals[key][2] ?? "") : "";
                    html += `<td colspan="2" style="text-align: center;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jul-Dec</div>
                        <input type="text" placeholder="Ref #" value="${v2}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 180px;">
                    </td>`;
                }
            } else {
                // Monthly Columns for other tabs
                const isDole = state.currentTab === 'dole';
                
                // Check if this is AEDR or AMR (annual reports) - use colspan=12
                if (isDole && (row === 'AEDR' || row === 'AMR')) {
                    const v = p.vals[key] ? (p.vals[key][1] ?? "") : "";
                    html += `<td colspan="12" style="text-align: center;"><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 180px;"></td>`;
                } else if (state.currentTab === 'activities' && (row === 'Drills Conducted' || row === 'Training Conducted')) {
                    // AUTO-COMPUTED from ESH Calendar & Drills ‚Äî read-only, no manual input
                    // Past months with no entry = 0, future months = blank
                    const eshStor = getEshStorage();
                    const projName = p.name;
                    const _now = new Date();
                    const _curYear = _now.getFullYear();
                    const _curMonth = _now.getMonth(); // 0-based, same as mi
                    const _selYear = state.selectedYear || _curYear;

                    for (let mi = 0; mi < 12; mi++) {
                        let count = 0;
                        if (row === 'Drills Conducted') {
                            ESH_DRILLS.forEach((drill, di) => {
                                const ak = `esh-calendar-drills|${projName}|${di}|${mi}|actual`;
                                if (eshStor[ak]) count++;
                            });
                        } else {
                            ['esh-calendar-env','esh-calendar-safety','esh-calendar-health'].forEach(tt => {
                                (ESH_TRAININGS[tt] || []).forEach((tr, ti) => {
                                    const ak = `${tt}|${projName}|${ti}|${mi}|actual`;
                                    if (eshStor[ak]) count++;
                                });
                            });
                        }

                        // Determine if this month has already passed
                        const isPast = _selYear < _curYear || (_selYear === _curYear && mi < _curMonth);
                        const isCurrent = _selYear === _curYear && mi === _curMonth;

                        // Past month with no entry ‚Üí show 0; future ‚Üí blank; has entry ‚Üí show count
                        const showZero = (isPast || isCurrent) && count === 0;
                        const disp = count > 0 ? count : (showZero ? '0' : '');
                        const dispColor = count > 0 ? '#2e7d32' : (showZero ? '#999' : '#bbb');
                        const dispWeight = count > 0 ? '700' : (showZero ? '600' : '400');
                        const bgColor = count > 0 ? 'rgba(46,125,50,0.1)' : (showZero ? 'rgba(0,0,0,0.02)' : '');

                        html += `<td class="monthly-data" style="text-align:center;background:${bgColor};cursor:default;" title="Auto-computed from ESH Calendar &amp; Drills ‚Äî cannot be edited manually">
                            <span style="font-weight:${dispWeight};color:${dispColor};font-size:0.8rem;">
                                ${disp}${count>0?'<i class="fas fa-lock" style="font-size:0.5rem;margin-left:3px;opacity:0.5;vertical-align:middle;"></i>':''}
                            </span>
                        </td>`;
                    }
                } else if (state.currentTab === 'exposures' && row === 'Total Exposed Man-hour to date') {
                    // AUTO-COMPUTED: cumulative = Previous (user-input) + JAN manhour + FEB manhour + ...
                    // Base = Previous column of THIS row (index 0), user can edit it freely
                    const manhourKey = `exposures_Total Exposed Manhour`;
                    const prevBase = parseFloat(p.vals[key] ? (p.vals[key][0] ?? 0) : 0) || 0;
                    let cumulative = prevBase;
                    for (let i = 1; i <= 12; i++) {
                        const monthManhour = parseFloat(p.vals[manhourKey] ? (p.vals[manhourKey][i] ?? '') : '') || 0;
                        if (monthManhour > 0) cumulative += monthManhour;
                        const displayVal = cumulative > 0 ? fmtNum(cumulative) : '';
                        html += `<td class="monthly-data" data-todate-proj="${p.name}" data-todate-month="${i}" style="text-align:center;" title="Auto-computed: Previous + sum of Total Exposed Manhour up to this month">
                            <span data-todate-proj="${p.name}" data-todate-month="${i}" style="font-size:0.7rem;color:var(--text-primary);font-weight:700;">
                                ${displayVal}
                            </span>
                        </td>`;
                    }
                } else {
                    // Normal monthly columns - REMOVED RED "NO REPORT", just normal input
                    for (let i = 1; i <= 12; i++) {
                        const v = p.vals[key] ? (p.vals[key][i] ?? "") : "";
                        const vFmt = (!isDateType && v !== '') ? fmtNum(v) : v;
                        html += `<td class="${isNov ? 'nov-narrow-td' : (isDole ? 'dole-narrow-td' : 'monthly-data')}"><input type="${isDateType ? 'date' : 'text'}" ${isDateType ? '' : 'inputmode="decimal" data-num'} value="${vFmt}" ${inputsEditable ? '' : 'disabled'} ${isDateType ? `oninput="updateVal('${p.name}','${key}',${i},this.value)"` : `oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',${i},v)})"`}></td>`;
                    }
                }
            }
            
            // Add Running YTD column
            if (hasYTD) {
                let ytdValue = 0;
                if (row === "Total Manpower") {
                    ytdValue = calculateAverage(p.vals[key], rowIdx);
                    html += `<td class="average-cell">${fmtNum(ytdValue)}</td>`;
                } else if (state.currentTab === 'activities' && (row === 'Drills Conducted' || row === 'Training Conducted')) {
                    // YTD = total count from ESH Calendar across all months
                    const eshStor = getEshStorage();
                    for (let mi = 0; mi < 12; mi++) {
                        if (row === 'Drills Conducted') {
                            ESH_DRILLS.forEach((drill, di) => {
                                if (eshStor[`esh-calendar-drills|${p.name}|${di}|${mi}|actual`]) ytdValue++;
                            });
                        } else {
                            ['esh-calendar-env','esh-calendar-safety','esh-calendar-health'].forEach(tt => {
                                (ESH_TRAININGS[tt] || []).forEach((tr, ti) => {
                                    if (eshStor[`${tt}|${p.name}|${ti}|${mi}|actual`]) ytdValue++;
                                });
                            });
                        }
                    }
                    html += `<td class="ytd-cell" style="color:${ytdValue>0?'#2e7d32':''};">${ytdValue > 0 ? fmtNum(ytdValue) : ''}</td>`;
                } else if (state.currentTab === 'exposures' && row === 'Total Exposed Man-hour to date') {
                    // YTD = final cumulative = Previous (user input) + all monthly manhours
                    const _mhKey = `exposures_Total Exposed Manhour`;
                    const _prevBase = parseFloat(p.vals[key] ? (p.vals[key][0] ?? 0) : 0) || 0;
                    let _cum = _prevBase;
                    for (let _i = 1; _i <= 12; _i++) {
                        _cum += parseFloat(p.vals[_mhKey] ? (p.vals[_mhKey][_i] ?? '') : '') || 0;
                    }
                    html += `<td class="ytd-cell" data-todate-proj="${p.name}" data-todate-month="ytd">${_cum > 0 ? fmtNum(_cum) : ''}</td>`;
                } else {
                    ytdValue = calculateYTD(p.vals[key], rowIdx);
                    html += `<td class="ytd-cell">${fmtNum(ytdValue)}</td>`;
                }
            }
        }
        html += `</tr>`;
    });
    html += `</table></div>`;
    
    // ANNUAL REPORTS SECTION - Now integrated in main table above
    if (false && state.currentTab === 'dole' && SCHEMA.dole_annual) {
        html += `<div style="margin-top: 30px;">`;
        html += `<div style="background: var(--header-grad); color: white; padding: 10px 15px; border-radius: 6px; font-weight: 700; margin-bottom: 10px;">
                    üìÖ ANNUAL REPORTS (Submitted Every January)
                 </div>`;
        html += `<div class="table-container"><table>`;
        html += `<tr><th style="width:120px; text-align:left; position: sticky; left: 0; z-index: 10; background: #2e7d32;">TYPE</th><th class="dole-narrow-th">DATE SUBMITTED</th></tr>`;
        
        SCHEMA.dole_annual.forEach((row, rowIdx) => {
            const key = `dole_annual_${row}`;
            const v = p.vals[key] ? (p.vals[key][1] ?? "") : "";
            html += `<tr>
                <td style="text-align:left; font-weight:600; background:var(--border-color); position: sticky; left: 0; z-index: 5;">${row}</td>
                <td class="dole-narrow-td"><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
            </tr>`;
        });
        
        html += `</table></div></div>`;
    }
}

                }); // end projs.forEach
                } // end else (non-corporate regions)
                html += `</div>`; // Close region-content
                });
            } // End skip for DOE tabs

            // ‚îÄ‚îÄ PER-REGION GROUPED TABLES: kpm, cshp, reg, audit, env-monthly-report ‚îÄ‚îÄ
            if (['kpm','cshp','reg','audit','env-monthly-report'].includes(state.currentTab)) {
                html = ''; // Rebuild cleanly ‚Äî no per-project rows needed

                // ‚îÄ‚îÄ Banner for KPM ‚îÄ‚îÄ
                if (state.currentTab === 'kpm') {
                    html += `
                    <div class="tab-info-bar">
                        <div class="tib-icon"><i class="fas fa-file-lines"></i></div>
                        <div class="tib-body">
                            <p class="tib-sub">Monthly submission required for each project</p>
                            <p class="tib-sub" style="opacity:0.75;"><i class="fas fa-calendar-check"></i> Tracking ${displayProjects.length} project(s) ‚Äî KPM &amp; Inspection reports</p>
                        </div>
                        <div class="tib-badges">
                            <span class="tib-pill tib-pill-green">${displayProjects.length} PROJECTS</span>
                            <span class="tib-pill tib-pill-yellow">MONTHLY</span>
                        </div>
                    </div>`;
                }

                // ‚îÄ‚îÄ Banner for Environmental Monthly Report ‚îÄ‚îÄ
                if (state.currentTab === 'env-monthly-report') {
                    html += `
                    <div class="tab-info-bar">
                        <div class="tib-icon"><i class="fas fa-leaf"></i></div>
                        <div class="tib-body">
                            <p class="tib-sub">Monthly submission required per project ‚Äî Environmental compliance tracking</p>
                            <p class="tib-sub" style="opacity:0.75;"><i class="fas fa-recycle"></i> Waste &bull; Water &bull; Air &bull; Noise &bull; Hazardous Materials</p>
                        </div>
                        <div class="tib-badges">
                            <span class="tib-pill tib-pill-green">${displayProjects.length} PROJECTS</span>
                            <span class="tib-pill tib-pill-yellow">MONTHLY</span>
                        </div>
                    </div>`;
                }

                const isCshpReg = (state.currentTab === 'cshp' || state.currentTab === 'reg');
                const isAudit   = (state.currentTab === 'audit');

                REGIONS.forEach(reg => {
                    if (reg === 'CORPORATE') return; // CORPORATE not shown in this tab
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;

                    const regSum  = projs.reduce((sum, p) => sum + getPerc(p), 0);
                    const regAvg  = Math.round(regSum / projs.length);
                    const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg) && UserAccounts.canEditTab(state.currentUser?.email, state.currentTab);
                    const isCollapsed = isRegionCollapsed(reg);

                    const isCorporateReg2 = reg === 'CORPORATE';
                    const regIcon2 = isCorporateReg2 ? 'fa-building-columns' : 'fa-location-dot';
                    const regLabel2 = isCorporateReg2 ? 'CORPORATE' : reg;
                    html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                        <div class="region-banner-inner">
                            <div class="region-banner-left">
                                <i class="fas ${regIcon2} region-icon"></i>
                                <span class="region-name">${regLabel2}</span>
                                ${isCorporateReg2 ? `<span class="rbadge rbadge-admin">ADMIN ONLY</span>` : ''}
                                ${!canEditRegion && !isCorporateReg2 ? `<i class="fas fa-lock" style="color:#fbc02d;font-size:0.7rem;" title="üîí View Only"></i>` : ''}
                            </div>
                            <div class="region-banner-right">
                                <span class="rbadge rbadge-count">${projs.length} PROJ</span>
                                <span class="rbadge rbadge-avg">AVG ${regAvg}%</span>
                                ${state.isEditing && canEditRegion ? `<button onclick="event.stopPropagation(); openAddProjectModal('${reg}')" class="btn btn-primary" style="font-size:0.68rem;padding:3px 10px;line-height:1.4;">+ ADD</button>` : ''}
                                ${state.isEditing && !canEditRegion ? `<button disabled style="opacity:0.45;cursor:not-allowed;background:#888;font-size:0.68rem;padding:3px 10px;line-height:1.4;" class="btn btn-primary">LOCKED</button>` : ''}
                                <i class="fas fa-chevron-down region-toggle-icon"></i>
                            </div>
                        </div>
                    </div>`;
                    
                    html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;

                    // ‚îÄ‚îÄ CSHP / REG ‚îÄ‚îÄ
                    if (isCshpReg) {
                        const headerText = (state.currentTab === 'cshp') ? 'DATE APPROVED' : 'DATE REGISTERED';
                        const schemaRow  = SCHEMA[state.currentTab][0];
                        const key        = `${state.currentTab}_${schemaRow}`;

                        html += `<div class="table-container"><table>
                            <tr>
                                <th style="width:250px;text-align:left; position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>
                                <th style="width:150px;">${headerText}</th>
                                <th style="width:350px;">PDF DOCUMENT</th>
                            </tr>`;

                        projs.forEach(p => {
                            const v = p.vals[key] ? (p.vals[key][1] ?? "") : "";
                            const pdfKey = `${key}_pdf`;
                            const pdfData = p.vals[pdfKey] ? p.vals[pdfKey][1] : null;
                            
                            let pdfCell = '';
                            if (pdfData) {
                                // PDF exists - show view, replace, and delete buttons
                                pdfCell = `
                                    <div class="pdf-upload-container">
                                        <a href="${pdfData.url}" target="_blank" class="pdf-view-btn" title="View PDF">
                                            <i class="fas fa-file-pdf"></i> View
                                        </a>
                                        <span class="pdf-filename" title="${pdfData.name}">${pdfData.name}</span>
                                        ${state.isEditing && canEditRegion ? `
                                            <input type="file" id="pdf_${p.name}_${state.currentTab}" accept=".pdf" 
                                                style="display:none;" onchange="uploadPDF(this, '${p.name}','${pdfKey}', true)">
                                            <button class="pdf-replace-btn" onclick="document.getElementById('pdf_${p.name}_${state.currentTab}').click()" title="Replace PDF">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button class="pdf-delete-btn" onclick="deletePDF('${p.name}','${pdfKey}')" title="Delete PDF">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>`;
                            } else {
                                // No PDF - show upload button
                                pdfCell = (state.isEditing && canEditRegion) ? `
                                    <div class="pdf-upload-container">
                                        <input type="file" id="pdf_${p.name}_${state.currentTab}" accept=".pdf" 
                                            style="display:none;" onchange="uploadPDF(this, '${p.name}','${pdfKey}', false)">
                                        <button class="pdf-upload-btn" onclick="document.getElementById('pdf_${p.name}_${state.currentTab}').click()">
                                            <i class="fas fa-upload"></i> Upload PDF
                                        </button>
                                        <div style="font-size:10px;color:#e65100;margin-top:3px;font-style:italic;">
                                            üìÑ Stamped file page only<br>(1 page, max 500KB)
                                        </div>
                                    </div>` : '<span style="color: #999; font-style: italic;">No document</span>';
                            }
                            
                            html += `<tr>
                                <td style="text-align:left;font-weight:600;background:var(--border-color); position: sticky; left: 0; z-index: 5;">
                                    ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                    ${p.name}
                                </td>
                                <td><input type="date" value="${v}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
                                <td>${pdfCell}</td>
                            </tr>`;
                        });

                        html += `</table></div>`;

                    // ‚îÄ‚îÄ AUDIT ‚îÄ‚îÄ
                    } else if (isAudit) {
                        html += `<div class="table-container">
                            <table class="audit-table">
                                <thead>
                                    <tr>
                                        <th rowspan="3" style="text-align:left; min-width:200px; padding-left: 12px; border-right: 2px solid rgba(255,255,255,0.3); position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q1 (JAN-MAR)</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q2 (APR-JUN)</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q3 (JUL-SEP)</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q4 (OCT-DEC)</th>
                                        <th rowspan="3" class="cell-grand-total" style="border-left: 3px solid #fbc02d; vertical-align: middle; line-height: 1.3;">GRAND<br>TOTAL<br>AVERAGE</th>
                                    </tr>
                                    <tr>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                    </tr>
                                    <tr>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        projs.forEach(p => {
                            let totalYearAvg = 0;
                            html += `<tr><td style="text-align:left; font-weight:700; background:#f8f9fa; padding:10px 12px; color:#1b5e20; border-right: 2px solid #e0e0e0; position: sticky; left: 0; z-index: 5;">
                                ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                ${p.name}
                            </td>`;
                            ['Q1','Q2','Q3','Q4'].forEach(q => {
                                const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
                                const qAvg  = (audit.scoreImpl + audit.docuComp) / 2;
                                totalYearAvg += qAvg;
                                html += `
                                    <td class="cell-white"><input type="number" min="0" max="100" value="${audit.scoreImpl}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                        oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)" placeholder="0"></td>
                                    <td class="cell-white"><input type="number" min="0" max="100" value="${audit.docuComp}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                        oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)" placeholder="0"></td>
                                    <td class="cell-avg-gray" style="border-right: 2px solid #e0e0e0;">${qAvg.toFixed(2)}</td>`;
                            });
                            html += `<td class="cell-grand-total">${(totalYearAvg/4).toFixed(2)}</td></tr>`;
                        });

                        html += `</tbody></table></div>`;

                    // ‚îÄ‚îÄ KPM (Monthly Report) or Environmental Monthly Report ‚îÄ‚îÄ
                    } else {
                        const schemaKey = state.currentTab === 'env-monthly-report' ? 'env-monthly-report' : 'kpm';
                        html += `<div class="table-container"><table>
                            <tr><th style="width:220px;text-align:left; position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>`;
                        MONTHS.forEach(m => html += `<th style="width:100px;min-width:100px;max-width:100px;">${m}</th>`);
                        html += `</tr>`;

                        projs.forEach(p => {
                            SCHEMA[schemaKey].forEach(row => {
                                const key = `${schemaKey}_${row}`;
                                html += `<tr>
                                    <td style="text-align:left;font-weight:600;background:var(--border-color); position: sticky; left: 0; z-index: 5;">
                                        ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                        ${p.name}
                                    </td>`;
                                for (let i = 1; i <= 12; i++) {
                                    const v = p.vals[key] ? (p.vals[key][i] ?? "") : "";
                                    html += `<td class="monthly-data"><input type="date" value="${v}"
                                        ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                        oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                                }
                                html += `</tr>`;
                            });
                        });

                        html += `</table></div>`;
                    }
                html += `</div>`; // Close region-content
                });
            }

            // ==================== DOE REPORTORIAL TAB ====================
            if (state.currentTab === 'doe') {
                html = ''; // Start fresh
                
                // Filter only renewable energy projects
                const renewableProjects = displayProjects.filter(p => p.isRenewable === true);
                
                if (renewableProjects.length === 0) {
                    html += `
                        <div style="background: var(--bg-card); padding: 40px; margin: 20px; border-radius: 12px; text-align: center; border: 2px dashed var(--border-color);">
                            <i class="fas fa-solar-panel" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">No Renewable Energy Projects</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                DOE Reportorial only applies to Renewable Energy projects.<br>
                                Mark projects as "Renewable Energy" when adding/editing them to see them here.
                            </p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="tab-info-bar">
                            <div class="tib-icon"><i class="fas fa-solar-panel"></i></div>
                            <div class="tib-body">
                                <p class="tib-sub">Quarterly submission ‚Äî Due: 20th of the month after each quarter</p>
                                <p class="tib-sub" style="opacity:0.75;"><i class="fas fa-leaf"></i> Showing ${renewableProjects.length} Renewable Energy project(s)</p>
                            </div>
                            <div class="tib-badges">
                                <span class="tib-pill tib-pill-green">${renewableProjects.length} PROJECTS</span>
                                <span class="tib-pill tib-pill-yellow">QUARTERLY</span>
                            </div>
                        </div>
                    `;
                    
                    // Group by region
                    const key = 'doe_DOE Quarterly Report Submission Date';
                    
                    REGIONS.forEach(reg => {
                        const regProjects = renewableProjects.filter(p => p.region === reg);
                        if (regProjects.length === 0) return;
                        
                        const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg) && UserAccounts.canEditTab(state.currentUser?.email, state.currentTab);
                        const isCollapsed = isRegionCollapsed(reg);
                        
                        // Region banner with lock icon
                        html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                            <div class="region-banner-inner">
                                <div class="region-banner-left">
                                    <i class="fas fa-location-dot region-icon"></i>
                                    <span class="region-name">${reg}</span>
                                    ${!canEditRegion ? `<i class="fas fa-lock" style="color:#fbc02d;font-size:0.7rem;" title="üîí View Only"></i>` : ''}
                                </div>
                                <div class="region-banner-right">
                                    <span class="rbadge rbadge-count">${regProjects.length} PROJ</span>
                                    <i class="fas fa-chevron-down region-toggle-icon"></i>
                                </div>
                            </div>
                        </div>`;
                        
                        html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                        
                        html += `
                        <div class="table-container">
                            <table>
                                <tr>
                                    <th style="width: 280px; text-align: left;">PROJECT NAME</th>
                                    <th>Q1 (JAN-MAR)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Apr 20</small></th>
                                    <th>Q2 (APR-JUN)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Jul 20</small></th>
                                    <th>Q3 (JUL-SEP)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Oct 20</small></th>
                                    <th>Q4 (OCT-DEC)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Jan 20</small></th>
                                </tr>
                        `;
                        
                        regProjects.forEach(p => {
                            html += `<tr>
                                <td style="text-align: left; font-weight: 700; background: #e8f5e9; color: #1b5e20; position: sticky; left: 0; z-index: 5;">
                                    <i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;"></i>
                                    ${p.name}
                                </td>`;
                            
                            for (let q = 1; q <= 4; q++) {
                                const val = p.vals[key] ? (p.vals[key][q] ?? '') : '';
                                const hasPdf = p.doePdfFiles && p.doePdfFiles[`Q${q}`];
                                
                                html += `<td>
                                    <input type="date" 
                                           value="${val}" 
                                           ${(state.isEditing && canEditRegion) ? '' : 'disabled'} 
                                           oninput="updateVal('${p.name}','${key}',${q},this.value)"
                                           style="width: 140px;">
                                    
                                    ${(state.isEditing && canEditRegion) ? `
                                        <div class="pdf-upload-container">
                                            ${hasPdf ? `
                                                <span class="pdf-file-info">
                                                    <i class="fas fa-file-pdf" style="color: #d32f2f;"></i>
                                                    <span style="font-size: 0.65rem; color: var(--text-secondary);">
                                                        ${p.doePdfFiles[`Q${q}`].fileName.substring(0, 12)}...
                                                    </span>
                                                    <button class="pdf-view-btn" 
                                                            onclick="viewDoePdf('${p.name}', ${q})" 
                                                            title="View PDF">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="pdf-delete-btn" 
                                                            onclick="deleteDoePdf('${p.name}', ${q})" 
                                                            title="Delete PDF">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </span>
                                            ` : `
                                                <div>
                                                    <button class="pdf-upload-btn" 
                                                            onclick="uploadDoePdf('${p.name}', ${q})" 
                                                            title="Upload Certificate PDF">
                                                        <i class="fas fa-upload"></i> Upload
                                                    </button>
                                                    <div style="font-size:10px;color:#e65100;margin-top:3px;font-style:italic;">
                                                        üìÑ Stamped file page only<br>(1 page, max 500KB)
                                                    </div>
                                                </div>
                                            `}
                                        </div>
                                    ` : hasPdf ? `
                                        <button class="pdf-view-btn" 
                                                onclick="viewDoePdf('${p.name}', ${q})" 
                                                title="View PDF"
                                                style="margin-left: 10px;">
                                            <i class="fas fa-file-pdf"></i> View
                                        </button>
                                    ` : ''}
                                </td>`;
                            }
                            
                            html += `</tr>`;
                        });
                        
                        html += `
                            </table>
                        </div>
                        `;
                        html += `</div>`; // Close region-content
                    });
                }
            }
            // ==================== END DOE REPORTORIAL ====================

            // ==================== DOE SAFETY OFFICER PERMIT TAB ====================
            if (state.currentTab === 'doe-permit') {
                html = ''; // Start fresh
                
                // Filter only renewable energy projects
                const renewableProjects = displayProjects.filter(p => p.isRenewable === true);
                
                if (renewableProjects.length === 0) {
                    html += `
                        <div style="background: var(--bg-card); padding: 40px; margin: 20px; border-radius: 12px; text-align: center; border: 2px dashed var(--border-color);">
                            <i class="fas fa-id-card" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">No Renewable Energy Projects</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                DOE Safety Officer Permit only applies to Renewable Energy projects.<br>
                                Mark projects as "Renewable Energy" when adding/editing them to see them here.
                            </p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="tab-info-bar">
                            <div class="tib-icon"><i class="fas fa-id-card"></i></div>
                            <div class="tib-body">
                                <p class="tib-sub">Dept. Circular DC2012-11-0009 ‚Äî RE Safety, Health and Environment Rules</p>
                                <p class="tib-sub" style="opacity:0.75;"><i class="fas fa-leaf"></i> Showing ${renewableProjects.length} Renewable Energy project(s)</p>
                            </div>
                            <div class="tib-badges">
                                <span class="tib-pill tib-pill-green">${renewableProjects.length} PROJECTS</span>
                                <span class="tib-pill tib-pill-yellow">RENEWABLE</span>
                            </div>
                        </div>
                    `;
                    
                    // Group by region
                    const key = 'doe-permit_DOE Safety Officer Permit';
                    
                    REGIONS.forEach(reg => {
                        const regProjects = renewableProjects.filter(p => p.region === reg);
                        if (regProjects.length === 0) return;
                        
                        const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg) && UserAccounts.canEditTab(state.currentUser?.email, state.currentTab);
                        const isCollapsed = isRegionCollapsed(reg);
                        
                        // Region banner with lock icon
                        html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                            <div class="region-banner-inner">
                                <div class="region-banner-left">
                                    <i class="fas fa-location-dot region-icon"></i>
                                    <span class="region-name">${reg}</span>
                                    ${!canEditRegion ? `<i class="fas fa-lock" style="color:#fbc02d;font-size:0.7rem;" title="üîí View Only"></i>` : ''}
                                </div>
                                <div class="region-banner-right">
                                    <span class="rbadge rbadge-count">${regProjects.length} PROJ</span>
                                    <i class="fas fa-chevron-down region-toggle-icon"></i>
                                </div>
                            </div>
                        </div>`;
                        
                        html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                        
                        html += `
                        <div class="table-container">
                            <table>
                                <tr>
                                    <th style="width: 280px; text-align: left;">PROJECT NAME</th>
                                    <th style="width: 200px;">SAFETY OFFICER PERMIT NUMBER</th>
                                    <th style="width: 150px;">VALID UNTIL</th>
                                    <th style="width: 200px;">PDF FILE</th>
                                </tr>
                        `;
                        
                        regProjects.forEach(p => {
                            const permitNumber = p.vals[key] ? (p.vals[key][1] ?? "") : "";
                            const validUntil = p.vals[key] ? (p.vals[key][2] ?? "") : "";
                            const hasPdf = p.vals[key] && p.vals[key][3];
                            
                            let pdfCell = '';
                            if (state.isEditing && canEditRegion) {
                                if (hasPdf) {
                                    pdfCell = `
                                        <span class="pdf-file-info">
                                            <button class="pdf-view-btn" onclick="viewDoePermitPdf('${p.name}')" title="View PDF">
                                                <i class="fas fa-file-pdf"></i> View
                                            </button>
                                            <button class="pdf-delete-btn" onclick="deleteDoePermitPdf('${p.name}')" title="Replace PDF">
                                                <i class="fas fa-sync-alt"></i> Replace
                                            </button>
                                        </span>
                                    `;
                                } else {
                                    pdfCell = `
                                        <div>
                                            <button class="pdf-upload-btn" onclick="uploadDoePermitPdf('${p.name}')" title="Upload Permit PDF">
                                                <i class="fas fa-upload"></i> Upload
                                            </button>
                                            <div style="font-size:10px;color:#e65100;margin-top:3px;font-style:italic;">
                                                üìÑ Stamped file page only<br>(1 page, max 500KB)
                                            </div>
                                        </div>
                                    `;
                                }
                            } else {
                                if (hasPdf) {
                                    pdfCell = `
                                        <button class="pdf-view-btn" onclick="viewDoePermitPdf('${p.name}')" title="View PDF">
                                            <i class="fas fa-file-pdf"></i> View
                                        </button>
                                    `;
                                } else {
                                    pdfCell = '<span style="color: var(--text-secondary); font-size: 0.75rem;">No PDF</span>';
                                }
                            }
                            
                            html += `<tr>
                                <td style="text-align: left; font-weight: 700; background: #e8f5e9; color: #1b5e20; position: sticky; left: 0; z-index: 5;">
                                    <i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;"></i>
                                    ${p.name}
                                </td>
                                <td><input type="text" placeholder="e.g., HOEMD-2025-486" value="${permitNumber}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 100%;"></td>
                                <td><input type="date" value="${validUntil}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 100%;"></td>
                                <td style="text-align: center;">${pdfCell}</td>
                            </tr>`;
                        });
                        
                        html += `
                            </table>
                        </div>
                        `;
                        html += `</div>`; // Close region-content
                    });
                }
            }
            // ==================== END DOE SAFETY OFFICER PERMIT ====================

            // ESH NOV MONITORING - Render grouped tables per region
            if (state.currentTab === 'nov-monitoring') {
                html = ''; // Clear previous HTML
                
                // Add CSS styles for NOV Monitoring
                html += `<style>
                    .nov-monitoring-table {
                        border-collapse: collapse;
                        width: 100%;
                        margin: 10px 0;
                        font-family: Arial, sans-serif;
                        border: none;
                    }
                    /* Option 4: Dark green header with yellow accent */
                    .nov-monitoring-table th {
                        background-color: #1b5e20;
                        color: #ffffff;
                        font-weight: bold;
                        text-transform: uppercase;
                        font-size: 10px;
                        padding: 8px 4px;
                        border: none;
                        border-bottom: 3px solid var(--safety-yellow);
                        text-align: center;
                    }
                    /* Striped rows */
                    .nov-monitoring-table tbody tr {
                        transition: all 0.2s ease;
                        border-left: 3px solid transparent;
                    }
                    .nov-monitoring-table tbody tr:nth-child(odd) {
                        background: white;
                    }
                    .nov-monitoring-table tbody tr:nth-child(even) {
                        background: #f1f8e9;
                    }
                    /* Hover effect with left border accent */
                    .nov-monitoring-table td {
                        border: none;
                        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                        text-align: center;
                        vertical-align: middle;
                        padding: 4px;
                        font-size: 11px;
                    }
                    .nov-monitoring-table td.project-name {
                        text-align: left;
                        font-weight: 600;
                        min-width: 150px;
                        position: sticky;
                        left: 0;
                        z-index: 5;
                    }
                    .nov-monitoring-table input {
                        text-align: center;
                        width: 40px;
                        border: 0.5px solid #ccc;
                        border-radius: 2px;
                        font-size: 11px;
                        padding: 2px;
                    }
                    .nov-monitoring-table td.month-col {
                        width: 45px;
                        max-width: 45px;
                    }
                    .nov-monitoring-table td.summary-col {
                        width: 50px;
                        max-width: 50px;
                    }
                    .nov-monitoring-table td.total-col {
                        background: #fff9c4 !important;
                        font-weight: 700;
                    }
                    .nov-monitoring-table tr.regional-total {
                        background: #c8e6c9 !important;
                        font-weight: 700;
                    }
                    .nov-monitoring-table tr.overall-total {
                        background: #a5d6a7 !important;
                        font-weight: 700;
                    }
                    /* Dark mode support for NOV monitoring table */
                    body.dark-mode .nov-monitoring-table tbody tr:nth-child(odd) {
                        background: #2d2d2d;
                    }
                    body.dark-mode .nov-monitoring-table tbody tr:nth-child(even) {
                        background: #1f2e1f;
                    }
                    body.dark-mode .nov-monitoring-table td {
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                    }
                    body.dark-mode .nov-monitoring-table td.total-col {
                        background: #4a4a1f !important;
                    }
                    body.dark-mode .nov-monitoring-table tr.regional-total {
                        background: #2e5d2e !important;
                    }
                    body.dark-mode .nov-monitoring-table tr.overall-total {
                        background: #3d6d3d !important;
                    }
                </style>`;
                
                // Initialize overall totals
                let overallTotals = {
                    prev: 0,
                    months: new Array(12).fill(0),
                    open: 0,
                    pending: 0,
                    closed: 0,
                    total: 0
                };
                
                // First pass: Calculate overall totals
                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;
                    
                    projs.forEach(p => {
                        const key = 'nov-monitoring_data';
                        if (!p.vals[key]) p.vals[key] = new Array(17).fill("");
                        
                        overallTotals.prev += parseFloat(p.vals[key][0]) || 0;
                        
                        for (let i = 1; i <= 12; i++) {
                            const val = parseFloat(p.vals[key][i]) || 0;
                            overallTotals.months[i-1] += val;
                            overallTotals.total += val;
                        }
                        
                        overallTotals.open += parseFloat(p.vals[key][13]) || 0;
                        overallTotals.pending += parseFloat(p.vals[key][14]) || 0;
                        overallTotals.closed += parseFloat(p.vals[key][15]) || 0;
                    });
                });
                
                // Calculate overall percentage
                const overallPercentage = overallTotals.total > 0 
                    ? ((overallTotals.closed / overallTotals.total) * 100).toFixed(2) 
                    : '0.00';
                
                // Render Overall Total Table at the TOP - NEW DESIGN
                html += `
                <div class="tab-info-bar">
                    <div class="tib-icon"><i class="fas fa-globe"></i></div>
                    <div class="tib-body">
                        <p class="tib-sub">ESH NOV Monitoring ‚Äî consolidated data from all projects</p>
                    </div>
                    <div class="tib-badges">
                        <span class="tib-pill tib-pill-green">${displayProjects.length} PROJECTS</span>
                        <span class="tib-pill tib-pill-yellow">ALL REGIONS</span>
                    </div>
                </div>
                
                <div class="table-container" style="margin: 0 20px 20px;">
                    <table class="nov-monitoring-table">
                        <thead>
                            <tr>
                                <th style="min-width: 150px; background: #2e7d32; position: sticky; left: 0; z-index: 10;">TYPE</th>
                                <th class="prev-year" style="background: #388e3c;">PREVIOUS</th>
                                <th style="background: #388e3c;">JAN</th><th style="background: #388e3c;">FEB</th><th style="background: #388e3c;">MAR</th><th style="background: #388e3c;">APR</th>
                                <th style="background: #388e3c;">MAY</th><th style="background: #388e3c;">JUN</th><th style="background: #388e3c;">JUL</th><th style="background: #388e3c;">AUG</th>
                                <th style="background: #388e3c;">SEP</th><th style="background: #388e3c;">OCT</th><th style="background: #388e3c;">NOV</th><th style="background: #388e3c;">DEC</th>
                                <th style="background: #66bb6a;">OPEN</th>
                                <th style="background: #ffa726;">PENDING</th>
                                <th style="background: #42a5f5;">CLOSED</th>
                                <th style="background: #f9a825;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="overall-total">
                                <td style="text-align: left; font-weight: 700; background: #e8f5e9; color: #1b5e20; position: sticky; left: 0; z-index: 5;">OVERALL TOTAL</td>
                                <td style="background: #c8e6c9; font-weight: 700;">${fmtNum(overallTotals.prev)}</td>`;
                
                for (let i = 0; i < 12; i++) {
                    html += `<td style="background: #f1f8e9; font-weight: 600;">${fmtNum(overallTotals.months[i])}</td>`;
                }
                
                html += `<td style="background: #a5d6a7; font-weight: 700;">${fmtNum(overallTotals.open)}</td>
                    <td style="background: #ffcc80; font-weight: 700;">${fmtNum(overallTotals.pending)}</td>
                    <td style="background: #90caf9; font-weight: 700;">${fmtNum(overallTotals.closed)}</td>
                    <td style="background: #fff59d; font-weight: 800; font-size: 0.7rem;">${fmtNum(overallTotals.total)}</td>
                </tr>
                <tr style="background: #c8e6c9;">
                    <td colspan="17" style="text-align: center; font-size: 1.1rem; padding: 15px; font-weight: 700; color: #1b5e20;">
                        <i class="fas fa-chart-line"></i> OVERALL COMPLETION RATE: <span style="font-size: 1.3rem; color: #2e7d32;">${overallPercentage}%</span>
                    </td>
                </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin: 0 20px 30px; padding: 15px; background: #fff3e0; border-left: 5px solid #ff9800; border-radius: 6px;">
                    <p style="margin: 0; font-size: 0.85rem; color: #e65100; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> This summary aggregates ESH NOV data from <strong>${displayProjects.length} project(s)</strong> across all regions. 
                        Individual project details are shown below by region.
                    </p>
                </div>`;
                
                // Now render table for each region
                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;
                    
                    const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg) && UserAccounts.canEditTab(state.currentUser?.email, state.currentTab);
                    const isCollapsed = isRegionCollapsed(reg);
                    
                    html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                        <div class="region-banner-inner">
                            <div class="region-banner-left">
                                <i class="fas fa-location-dot region-icon"></i>
                                <span class="region-name">${reg}</span>
                                ${!canEditRegion ? `<i class="fas fa-lock" style="color:#fbc02d;font-size:0.7rem;" title="üîí View Only"></i>` : ''}
                            </div>
                            <div class="region-banner-right">
                                <span class="rbadge rbadge-count">${projs.length} PROJ</span>
                                <i class="fas fa-chevron-down region-toggle-icon"></i>
                            </div>
                        </div>
                    </div>`;
                    
                    html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                    
                    html += `<div class="table-container">
                        <table class="nov-monitoring-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 150px; position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>
                                    <th class="prev-year">PREVIOUS</th>
                                    <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th>
                                    <th>MAY</th><th>JUN</th><th>JUL</th><th>AUG</th>
                                    <th>SEP</th><th>OCT</th><th>NOV</th><th>DEC</th>
                                    <th style="background: #66bb6a;">OPEN</th>
                                    <th style="background: #ffa726;">PENDING</th>
                                    <th style="background: #42a5f5;">CLOSED</th>
                                    <th style="background: #fbc02d;">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    // Initialize regional totals
                    let regionalTotals = {
                        prev: 0,
                        months: new Array(12).fill(0),
                        open: 0,
                        pending: 0,
                        closed: 0,
                        total: 0
                    };
                    
                    // Render each project in this region
                    projs.forEach(p => {
                        const key = 'nov-monitoring_data';
                        if (!p.vals[key]) p.vals[key] = new Array(17).fill("");
                        
                        html += `<tr>
                            <td class="project-name">
                                ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                ${p.name}
                            </td>
                            <td class="prev-year">
                                <input type="text" inputmode="decimal" data-num min="0" value="${fmtNum(p.vals[key][0] || '')}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'} 
                                    oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',0,v)})">
                            </td>`;
                        
                        // Add to regional prev totals
                        regionalTotals.prev += parseFloat(p.vals[key][0]) || 0;
                        
                        // Monthly columns (1-12)
                        let rowTotal = 0;
                        for (let i = 1; i <= 12; i++) {
                            const val = parseFloat(p.vals[key][i]) || 0;
                            html += `<td class="month-col">
                                <input type="text" inputmode="decimal" data-num min="0" value="${fmtNum(p.vals[key][i] || '')}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',${i},v)})">
                            </td>`;
                            regionalTotals.months[i-1] += val;
                            rowTotal += val;
                        }
                        
                        // Summary columns
                        const openVal = parseFloat(p.vals[key][13]) || 0;
                        const pendingVal = parseFloat(p.vals[key][14]) || 0;
                        const closedVal = parseFloat(p.vals[key][15]) || 0;
                        
                        html += `<td class="summary-col" style="background: #c8e6c9;">
                            <input type="text" inputmode="decimal" data-num min="0" value="${fmtNum(p.vals[key][13] || '')}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',13,v)})">
                        </td>
                        <td class="summary-col" style="background: #ffe0b2;">
                            <input type="text" inputmode="decimal" data-num min="0" value="${fmtNum(p.vals[key][14] || '')}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',14,v)})">
                        </td>
                        <td class="summary-col" style="background: #bbdefb;">
                            <input type="text" inputmode="decimal" data-num min="0" value="${fmtNum(p.vals[key][15] || '')}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                oninput="numFmtInput(this, function(v){updateVal('${p.name}','${key}',15,v)})">
                        </td>
                        <td class="total-col">${fmtNum(rowTotal)}</td>
                        </tr>`;
                        
                        regionalTotals.open += openVal;
                        regionalTotals.pending += pendingVal;
                        regionalTotals.closed += closedVal;
                        regionalTotals.total += rowTotal;
                    });
                    
                    // Calculate regional percentage
                    const regionalPercentage = regionalTotals.total > 0 
                        ? ((regionalTotals.closed / regionalTotals.total) * 100).toFixed(2) 
                        : '0.00';
                    
                    // Regional Total Row
                    html += `<tr class="regional-total">
                        <td class="project-name" style="background: #2e7d32; color: white;">REGIONAL TOTAL</td>
                        <td style="background: #a5d6a7;">${fmtNum(regionalTotals.prev)}</td>`;
                    
                    for (let i = 0; i < 12; i++) {
                        html += `<td style="background: #c8e6c9;">${fmtNum(regionalTotals.months[i])}</td>`;
                    }
                    
                    html += `<td style="background: #81c784;">${fmtNum(regionalTotals.open)}</td>
                        <td style="background: #ffb74d;">${fmtNum(regionalTotals.pending)}</td>
                        <td style="background: #64b5f6;">${fmtNum(regionalTotals.closed)}</td>
                        <td style="background: #fbc02d;">${fmtNum(regionalTotals.total)}</td>
                    </tr>`;
                    
                    // Regional Percentage Row
                    html += `<tr class="regional-total">
                        <td colspan="17" style="text-align: right; padding-right: 10px; background: #e8f5e9;">
                            <strong>${reg} COMPLETION RATE:</strong> ${regionalPercentage}%
                        </td>
                    </tr>`;
                    
                    html += `</tbody></table></div>`;
                    html += `</div>`; // Close region-content
                });
            }

            container.innerHTML = html;

            
            // Apply comma formatting to all data-num inputs
            applyNumFmtToInputs();
            
            // Initialize trend chart if on rates or medical tab
            if (state.currentTab === 'rates' || state.currentTab === 'medical') {
                setTimeout(() => {
                    populateProjectFilter();
                    updateTrendChart(state.currentTab);
                }, 100);
            }
            } catch(renderErr) {
                console.error('‚ùå render() crashed:', renderErr);
                const _rc = document.getElementById('dashboard-content');
                if (_rc) {
                    _rc.innerHTML = `<div style="padding:40px;text-align:center;color:#c62828;">
                        <i class="fas fa-triangle-exclamation" style="font-size:2rem;margin-bottom:12px;display:block;"></i>
                        <div style="font-weight:700;margin-bottom:8px;">Display Error ‚Äî ${renderErr.message}</div>
                        <div style="font-size:0.8rem;color:#888;margin-bottom:16px;">Try switching to another tab or refreshing the page.</div>
                        <button onclick="changeTab('overall')" style="padding:8px 20px;background:#2e7d32;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;">‚Ü© Go to Dashboard</button>
                    </div>`;
                }
            }
        }


        
// Close dropdowns when clicking elsewhere
document.addEventListener('click', closeAllStatusDropdowns);
        function toggleProjectSelect(projectName) {
            const project = state.filteredProjects.find(p => p.name === projectName);
            if (project) project.selected = !project.selected;
        }

        // ===== SETTINGS FUNCTIONS =====

        // Toggle password field visibility
        function togglePwd(fieldId, btn) {
            const input = document.getElementById(fieldId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // IMPROVED: Password strength indicator with detailed feedback
        document.addEventListener('input', function(e) {
            if (e.target.id === 'new-password') {
                const pwd = e.target.value;
                const strengthDiv = document.getElementById('pwd-strength');
                
                if (!strengthDiv) return;
                
                if (!pwd) {
                    strengthDiv.innerHTML = '';
                    return;
                }

                let strength = 0;
                let feedback = [];
                
                // Length check (25 points)
                if (pwd.length >= 8) {
                    strength += 25;
                } else {
                    feedback.push('min 8 characters');
                }
                
                // Number check (25 points)
                if (/[0-9]/.test(pwd)) {
                    strength += 25;
                } else {
                    feedback.push('add numbers');
                }
                
                // Special character check (25 points)
                if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd)) {
                    strength += 25;
                } else {
                    feedback.push('add special chars (!@#$)');
                }
                
                // Uppercase/lowercase check (25 points)
                if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) {
                    strength += 25;
                } else {
                    feedback.push('mix upper & lowercase');
                }

                let color, label;
                if (strength < 50) {
                    color = '#e53935'; label = '‚ùå Weak';
                } else if (strength < 75) {
                    color = '#ff9800'; label = '‚ö†Ô∏è Moderate';
                } else if (strength < 100) {
                    color = '#fbc02d'; label = '‚úì Good';
                } else {
                    color = '#2e7d32'; label = '‚úÖ Strong';
                }

                let html = `<span style="color: ${color}; font-weight: 600;">${label}</span>`;
                if (feedback.length > 0) {
                    html += ` <span style="color: #666; font-size: 11px;">‚Äî Need: ${feedback.join(', ')}</span>`;
                }
                
                strengthDiv.innerHTML = html;
            }
        });

        // Toggle username edit form
        function toggleUsernameEdit() {
            const fields = document.getElementById('username-edit-fields');
            const isVisible = fields.style.display !== 'none';
            fields.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                const current = document.getElementById('current-display-name-text').textContent;
                document.getElementById('new-display-name').value = (current === '‚Äî' || current === 'ESH User') ? '' : current;
                document.getElementById('new-display-name').focus();
            }
        }

        // Save display name to Firebase
        async function saveDisplayName() {
            const nameVal = document.getElementById('new-display-name').value.trim();
            const msgEl = document.getElementById('name-msg');
            const btn = document.getElementById('save-name-btn');

            showSettingsMsg('name-msg', '', '');
            if (!nameVal) { showSettingsMsg('name-msg', '‚ö†Ô∏è Please enter a display name', 'error'); return; }
            if (nameVal.length < 2) { showSettingsMsg('name-msg', '‚ö†Ô∏è Name must be at least 2 characters', 'error'); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
            showSettingsMsg('name-msg', 'Updating display name...', 'loading');

            try {
                // Save to Firebase Firestore user profile
                if (firebaseReady && window.firebaseDb && state.currentUser) {
                    const userId = getCurrentUserId();
                    const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
                    await window.firebase.setDoc(docRef, { displayName: nameVal }, { merge: true });
                }
                // Update state and UI
                state.currentUser.displayName = nameVal;
                localStorage.setItem('esh_displayname_' + state.currentUser.email, nameVal);

                document.getElementById('current-display-name-text').textContent = nameVal;
                document.getElementById('settings-display-name').textContent = nameVal;
                // Update sidebar user badge too
                const badge = document.getElementById('user-badge');
                if (badge) badge.innerHTML = `<i class="fas fa-user-circle"></i> ${nameVal}`;

                document.getElementById('username-edit-fields').style.display = 'none';
                showSettingsMsg('name-msg', '‚úÖ Display name updated successfully!', 'success');
            } catch (err) {
                console.error('‚ùå Name update error:', err);
                showSettingsMsg('name-msg', '‚ùå Failed to update: ' + err.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> SAVE NAME';
        }

        // Update Password via Firebase
        // IMPROVED: Secure password update with re-authentication
        async function updatePasswordSecure() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const btn = document.getElementById('update-pwd-btn');

            showSettingsMsg('settings-message', '', '');

            // Validation checks
            if (!currentPass || !newPass || !confirmPass) {
                showSettingsMsg('settings-message', '‚ö†Ô∏è Please fill all fields', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showSettingsMsg('settings-message', '‚ùå New passwords do not match', 'error');
                return;
            }

            if (newPass.length < 8) {
                showSettingsMsg('settings-message', '‚ùå Password must be at least 8 characters', 'error');
                return;
            }

            // Password strength validation
            const hasNumber = /[0-9]/.test(newPass);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPass);
            
            if (!hasNumber || !hasSpecial) {
                showSettingsMsg('settings-message', '‚ùå Password must contain at least one number and one special character (!@#$%^&*)', 'error');
                return;
            }

            if (currentPass === newPass) {
                showSettingsMsg('settings-message', '‚ö†Ô∏è New password must be different from current password', 'error');
                return;
            }

            // Show custom confirmation dialog
            const confirmChange = await showConfirmModal();

            if (!confirmChange) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING & UPDATING...';
            showSettingsMsg('settings-message', 'üîê Step 1/3: Verifying your identity...', 'loading');

            try {
                // STEP 1: Re-authenticate with current password
                const user = window.firebaseAuth.currentUser;
                const email = user.email;
                
                // Import reauthenticateWithCredential if not already available
                if (!window.firebase.reauthenticateWithCredential) {
                    const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    window.firebase.reauthenticateWithCredential = reauthenticateWithCredential;
                    window.firebase.EmailAuthProvider = EmailAuthProvider;
                }

                const credential = window.firebase.EmailAuthProvider.credential(email, currentPass);
                
                try {
                    await window.firebase.reauthenticateWithCredential(user, credential);
                    console.log('‚úÖ Re-authentication successful');
                } catch (authError) {
                    throw new Error('WRONG_PASSWORD');
                }

                // STEP 2: Update password
                showSettingsMsg('settings-message', 'üîë Step 2/3: Updating password securely...', 'loading');
                await window.firebase.updatePassword(user, newPass);
                console.log('‚úÖ Password updated successfully');

                // STEP 3: Logout for security
                showSettingsMsg('settings-message', '‚úÖ Step 3/3: Password updated! Logging out all sessions...', 'success');
                
                // Clear form
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('pwd-strength').innerHTML = '';

                // Show custom success modal with countdown
                setTimeout(() => {
                    showSuccessModal();
                }, 500);

            } catch (error) {
                console.error('‚ùå Password update error:', error);
                
                if (error.message === 'WRONG_PASSWORD') {
                    showSettingsMsg('settings-message', '‚ùå Current password is incorrect. Please try again.', 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showSettingsMsg('settings-message', '‚ùå For security, please log out and log back in before changing your password.', 'error');
                } else {
                    showSettingsMsg('settings-message', '‚ùå Password update failed: ' + error.message, 'error');
                }
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-key"></i> UPDATE PASSWORD';
            }
        }

        // Legacy function name support (in case called elsewhere)
        async function updatePassword() {
            await updatePasswordSecure();
        }

        // Send password reset email
        async function sendPasswordReset() {
            const email = state.currentUser?.email;
            if (!email) return;
            showSettingsMsg('settings-message', 'Sending reset email...', 'loading');
            const success = await firebaseResetPassword(email);
            if (success) {
                showSettingsMsg('settings-message', '‚úÖ Password reset email sent to ' + email, 'success');
            }
        }

        // Apply theme from settings page
        function applyTheme(mode) {
            if (mode === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
            updateSettingsThemeButtons();
        }

        function updateSettingsThemeButtons() {
            const isDark = document.body.classList.contains('dark-mode');
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');
            if (lightBtn) lightBtn.classList.toggle('active', !isDark);
            if (darkBtn) darkBtn.classList.toggle('active', isDark);
        }

        // Show message helper
        function showSettingsMsg(elId, text, type) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.className = 'settings-msg' + (type ? ' ' + type : '');
            el.innerHTML = type === 'loading'
                ? `<i class="fas fa-spinner fa-spin"></i> ${text}`
                : text;
            if (text && type !== 'loading') {
                setTimeout(() => { el.className = 'settings-msg'; el.innerHTML = ''; }, 4500);
            }
        }

        // Populate settings tab with latest data
        function populateSettingsTab() {
            const user = state.currentUser;
            if (!user) return;

            // Display name: check state, localStorage, then fallback
            const savedName = user.displayName || localStorage.getItem('esh_displayname_' + user.email) || '';
            const displayName = savedName || user.email.split('@')[0];
            document.getElementById('settings-display-name').textContent = displayName;
            document.getElementById('current-display-name-text').textContent = savedName || '‚Äî';
            document.getElementById('settings-hero-email').textContent = user.email;
            document.getElementById('current-email').textContent = user.email;

            // Firebase UID
            const uidEl = document.getElementById('settings-uid');
            if (uidEl) uidEl.textContent = user.uid ? user.uid.substring(0, 20) + '...' : '‚Äî';

            // Firebase status
            const fbStatus = document.getElementById('settings-firebase-status');
            if (fbStatus) {
                if (firebaseReady && window.firebaseDb) {
                    fbStatus.className = 'firebase-status-badge connected';
                    fbStatus.innerHTML = '<i class="fas fa-wifi"></i> Connected';
                } else {
                    fbStatus.className = 'firebase-status-badge disconnected';
                    fbStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Disconnected';
                }
            }

            // Last sync
            const syncEl = document.getElementById('settings-last-sync');
            if (syncEl && state.lastSyncTimestamp) {
                syncEl.textContent = new Date(state.lastSyncTimestamp).toLocaleString('en-PH');
            } else if (syncEl) {
                syncEl.textContent = 'Not yet synced';
            }

            // Total projects
            const projEl = document.getElementById('settings-total-projects');
            if (projEl) projEl.textContent = state.projects.length + ' projects';

            // Theme buttons
            updateSettingsThemeButtons();

            // Backup section
            const backupSection = document.getElementById('backup-recovery-section');
            if (backupSection) backupSection.innerHTML = showBackupRecoveryUI();
            
            // Update copyright year
            const copyrightYear = document.getElementById('copyright-year');
            if (copyrightYear) copyrightYear.textContent = new Date().getFullYear();
            
            // Hide admin-only sections for superintendents
            const isAdmin = UserAccounts.isAdmin(user.email);
            const forceSyncSection = document.getElementById('force-sync-section');
            const yearManagementSection = document.getElementById('year-management-section');
            const auditTrailSection = document.getElementById('audit-trail-section');
            const dangerZoneSection = document.getElementById('danger-zone-section');
            
            if (!isAdmin) {
                // Hide these sections for superintendents
                if (forceSyncSection) forceSyncSection.style.display = 'none';
                if (yearManagementSection) yearManagementSection.style.display = 'none';
                if (auditTrailSection) auditTrailSection.style.display = 'none';
                if (dangerZoneSection) dangerZoneSection.style.display = 'none';
            } else {
                // Show for admins
                if (forceSyncSection) forceSyncSection.style.display = 'block';
                if (yearManagementSection) yearManagementSection.style.display = 'block';
                if (auditTrailSection) auditTrailSection.style.display = 'block';
                if (dangerZoneSection) dangerZoneSection.style.display = 'block';
            }
        }

        setInterval(() => {
            const now = new Date();
            const dateEl = document.getElementById('live-date');
            const clockEl = document.getElementById('live-clock');
            if (dateEl) dateEl.innerText = now.toLocaleDateString('en-PH', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).toUpperCase();
            if (clockEl) clockEl.innerText = now.toLocaleTimeString('en-PH');
        }, 1000);

       window.addEventListener('load', () => {
    initDarkMode();
    backupManager.init();
    // Firebase auth state is handled by setupAuthObserver() in the Firebase integration section below.
    // No session storage check needed ‚Äî Firebase persists login automatically.
});
// ‚îÄ‚îÄ Modern Delete Confirmation with Timer + Undo ‚îÄ‚îÄ
function showDeleteDialog(itemLabel, itemName) {
    return new Promise((resolve) => {
        const COUNTDOWN = 5;
        const circumference = 2 * Math.PI * 7; // r=7

        const overlay = document.createElement('div');
        overlay.className = 'delete-dialog-overlay';
        overlay.innerHTML = `
            <div class="delete-dialog">
                <div class="delete-dialog-icon"><i class="fas fa-trash-alt"></i></div>
                <div class="delete-dialog-title">Delete ${itemLabel}?</div>
                <div class="delete-dialog-message">
                    This will permanently delete
                    <span class="delete-dialog-name">${itemName}</span>
                    <span style="display:block;margin-top:8px;font-size:0.76rem;color:#999;">You can undo within 5 seconds after deleting.</span>
                </div>
                <div class="delete-dialog-btns">
                    <button class="delete-dialog-cancel" id="dd-cancel">Cancel</button>
                    <button class="delete-dialog-confirm" id="dd-confirm" disabled>
                        <svg class="delete-timer-ring" viewBox="0 0 18 18">
                            <circle cx="9" cy="9" r="7"/>
                            <circle class="progress" id="dd-ring" cx="9" cy="9" r="7"
                                stroke-dasharray="${circumference.toFixed(1)}"
                                stroke-dashoffset="0"/>
                        </svg>
                        <span id="dd-label">Delete (${COUNTDOWN})</span>
                    </button>
                </div>
            </div>`;

        document.body.appendChild(overlay);

        const confirmBtn = overlay.querySelector('#dd-confirm');
        const cancelBtn  = overlay.querySelector('#dd-cancel');
        const label      = overlay.querySelector('#dd-label');
        const ring       = overlay.querySelector('#dd-ring');

        let remaining = COUNTDOWN;
        const interval = setInterval(() => {
            remaining--;
            const offset = circumference * (remaining / COUNTDOWN);
            ring.style.strokeDashoffset = (circumference - offset).toFixed(1);
            if (remaining <= 0) {
                clearInterval(interval);
                confirmBtn.disabled = false;
                label.textContent = 'Delete';
                ring.style.strokeDashoffset = circumference.toFixed(1);
                ring.style.stroke = 'rgba(255,255,255,0.7)';
            } else {
                label.textContent = `Delete (${remaining})`;
            }
        }, 1000);

        cancelBtn.onclick = () => {
            clearInterval(interval);
            overlay.remove();
            resolve(false);
        };
        confirmBtn.onclick = () => {
            if (confirmBtn.disabled) return;
            clearInterval(interval);
            overlay.remove();
            resolve(true);
        };
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                clearInterval(interval);
                overlay.remove();
                resolve(false);
            }
        };
    });
}

// Show undo toast after delete ‚Äî calls onUndo() if user clicks Undo within 5s
function showUndoToast(message, onUndo, duration = 5000) {
    const container = document.getElementById('toast-container') || (() => {
        const c = document.createElement('div');
        c.id = 'toast-container';
        document.body.appendChild(c);
        return c;
    })();

    const toast = document.createElement('div');
    toast.className = 'undo-toast';
    toast.innerHTML = `
        <div class="undo-toast-body">
            <div class="undo-toast-icon"><i class="fas fa-trash"></i></div>
            <div class="undo-toast-text">
                <div class="undo-toast-title">Deleted</div>
                <div class="undo-toast-msg">${message}</div>
            </div>
        </div>
        <button class="undo-btn" id="undo-btn-action">‚Ü© Undo</button>
        <div class="undo-toast-progress" style="animation-duration:${duration}ms"></div>
    `;
    container.appendChild(toast);

    let undone = false;
    const timer = setTimeout(() => {
        if (!undone) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 320);
        }
    }, duration);

    toast.querySelector('#undo-btn-action').onclick = () => {
        if (!undone) {
            undone = true;
            clearTimeout(timer);
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 320);
            onUndo();
        }
    };
}

function showModernDialog(title, message, isDanger = false, confirmText = null, cancelText = 'Cancel') {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'modern-dialog-overlay';

        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = isDanger ? 'modern-dialog error' : 'modern-dialog';

        // Icon
        const iconEl = document.createElement('div');
        iconEl.className = 'modern-dialog-icon';
        iconEl.innerHTML = isDanger ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-check-circle"></i>';

        // Title
        const titleEl = document.createElement('h2');
        titleEl.className = 'modern-dialog-title';
        titleEl.textContent = title;

        // Message
        const messageEl = document.createElement('p');
        messageEl.className = 'modern-dialog-message';
        messageEl.innerHTML = message; // Changed to innerHTML to render HTML tags

        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'modern-dialog-buttons';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modern-dialog-btn modern-dialog-btn-cancel';
        cancelBtn.textContent = cancelText;
        cancelBtn.onclick = () => {
            overlay.remove();
            resolve(false);
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.className = isDanger ? 'modern-dialog-btn modern-dialog-btn-danger' : 'modern-dialog-btn modern-dialog-btn-confirm';
        
        // Set button text based on parameter or default
        if (confirmText) {
            confirmBtn.textContent = confirmText;
        } else {
            confirmBtn.textContent = isDanger ? 'Delete' : 'OK';
        }
        
        confirmBtn.onclick = () => {
            overlay.remove();
            resolve(true);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(iconEl);
        dialog.appendChild(titleEl);
        dialog.appendChild(messageEl);
        dialog.appendChild(buttonsDiv);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Modal is locked - no overlay click close
        // User must use CANCEL or CONFIRM buttons
        
        confirmBtn.focus();
    });
}

// Custom confirm dialog with customizable button labels and icon
function showCustomConfirm(title, message, confirmText = 'CONFIRM', cancelText = 'CANCEL', iconClass = 'fa-graduation-cap', isInfo = true) {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'modern-dialog-overlay';

        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = isInfo ? 'modern-dialog info' : 'modern-dialog';

        // Icon
        const iconEl = document.createElement('div');
        iconEl.className = 'modern-dialog-icon';
        iconEl.style.background = isInfo ? 'linear-gradient(135deg, #1976d2, #2196f3)' : 'linear-gradient(135deg, #2e7d32, #4caf50)';
        iconEl.innerHTML = `<i class="fas ${iconClass}"></i>`;

        // Title
        const titleEl = document.createElement('h2');
        titleEl.className = 'modern-dialog-title';
        titleEl.textContent = title;

        // Message
        const messageEl = document.createElement('p');
        messageEl.className = 'modern-dialog-message';
        messageEl.innerHTML = message;

        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'modern-dialog-buttons';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modern-dialog-btn modern-dialog-btn-cancel';
        cancelBtn.innerHTML = `<i class="fas fa-times"></i> ${cancelText}`;
        cancelBtn.onclick = () => {
            overlay.remove();
            resolve(false);
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'modern-dialog-btn modern-dialog-btn-confirm';
        confirmBtn.innerHTML = `<i class="fas fa-check"></i> ${confirmText}`;
        confirmBtn.onclick = () => {
            overlay.remove();
            resolve(true);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(iconEl);
        dialog.appendChild(titleEl);
        dialog.appendChild(messageEl);
        dialog.appendChild(buttonsDiv);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        confirmBtn.focus();
    });
}

// --- ESH PERSONNEL MONITORING SYSTEM ---

/**
 * Calculate years of service from hire date to current date
 */
function formatDateDMY(isoStr) {
    if (!isoStr) return '';
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const parts = isoStr.split('-');
    if (parts.length !== 3) return isoStr;
    const d = parseInt(parts[2], 10);
    const m = parseInt(parts[1], 10) - 1;
    const y = parts[0];
    if (isNaN(d) || isNaN(m) || m < 0 || m > 11) return isoStr;
    return `${d} ${months[m]} ${y}`;
}

function calculateYearsOfService(hireDate) {
    if (!hireDate) return '';
    
    const hired = new Date(hireDate);
    const today = new Date();
    
    // Calculate the difference in years
    let years = today.getFullYear() - hired.getFullYear();
    const monthDiff = today.getMonth() - hired.getMonth();
    
    // Adjust if birthday hasn't occurred this year yet
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < hired.getDate())) {
        years--;
    }
    
    // Return 0 if negative (future date)
    return years < 0 ? 0 : years;
}

function addPRow() {
    if (!state.personnelData) state.personnelData = [];
    state.personnelData.push({ name: '', pos: '', id: '', hired: '', current: '', age: '', gen: '', mail: '', num: '', addr: '', len: '' });
    renderPTable();
    // Auto-open edit mode on the newly added row
    const newIdx = state.personnelData.length - 1;
    setTimeout(() => pRowEdit(newIdx), 50);
    saveUserData(state.currentUser.email);
}

// Add Personnel Modal Functions
function openAddPersonnelModal() {
    // Populate assignment dropdown with projects
    const assignmentSelect = document.getElementById('personnelAssignmentInput');
    let options = '<option value="">Select Assignment</option>';
    // Corporate Office assignment: Admin only
    if (state.isAdmin) {
        options += '<option value="Corporate Office">Corporate Office</option>';
    }
    
    if (state.projects && state.projects.length > 0) {
        // For non-admin users, only show projects from their region (excluding CORPORATE region)
        let projectsList = state.projects;
        if (!state.isAdmin && state.userRegion) {
            projectsList = state.projects.filter(p => p.region === state.userRegion && p.region !== 'CORPORATE');
        } else if (state.isAdmin) {
            projectsList = state.projects; // Admin sees all (including CORPORATE)
        }
        
        projectsList.forEach(p => {
            if (p.region === 'CORPORATE') return; // Corporate Office covers this
            options += `<option value="${p.name}">${p.name}</option>`;
        });
    }
    
    assignmentSelect.innerHTML = options;
    
    // Clear all inputs
    document.getElementById('personnelLastNameInput').value = '';
    document.getElementById('personnelFirstNameInput').value = '';
    document.getElementById('personnelMiddleNameInput').value = '';
    document.getElementById('personnelNameExtInput').value = '';
    document.getElementById('personnelPositionInput').value = '';
    document.getElementById('personnelIdInput').value = '';
    document.getElementById('personnelHiredInput').value = '';
    document.getElementById('personnelAssignmentInput').value = '';
    document.getElementById('personnelAgeInput').value = '';
    document.getElementById('personnelGenderInput').value = '';
    document.getElementById('personnelEmailInput').value = '';
    document.getElementById('personnelContactInput').value = '';
    document.getElementById('personnelAddressInput').value = '';
    document.getElementById('personnelModalError').textContent = '';
    
    // Show modal
    document.getElementById('addPersonnelModal').classList.add('show');
}

function closeAddPersonnelModal() {
    document.getElementById('addPersonnelModal').classList.remove('show');
}

function confirmAddPersonnel() {
    const lastName = document.getElementById('personnelLastNameInput').value.trim().toUpperCase();
    const firstName = document.getElementById('personnelFirstNameInput').value.trim().toUpperCase();
    const middleName = document.getElementById('personnelMiddleNameInput').value.trim().toUpperCase();
    const nameExt = document.getElementById('personnelNameExtInput').value;
    
    // Build full name: LAST NAME, FIRST NAME MIDDLE NAME EXT
    let fullName = `${lastName}, ${firstName}`;
    if (middleName) {
        fullName += ` ${middleName}`;
    }
    if (nameExt) {
        fullName += ` ${nameExt}`;
    }
    
    const pos = document.getElementById('personnelPositionInput').value;
    const id = document.getElementById('personnelIdInput').value.trim();
    const hired = document.getElementById('personnelHiredInput').value;
    const current = document.getElementById('personnelAssignmentInput').value;
    const age = document.getElementById('personnelAgeInput').value;
    const gen = document.getElementById('personnelGenderInput').value;
    const mail = document.getElementById('personnelEmailInput').value.trim();
    const num = document.getElementById('personnelContactInput').value.trim();
    const addr = document.getElementById('personnelAddressInput').value.trim();
    
    const errorEl = document.getElementById('personnelModalError');
    
    // Validation
    if (!lastName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter last name';
        return;
    }
    if (!firstName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter first name';
        return;
    }
    if (!pos) {
        errorEl.textContent = '‚ö†Ô∏è Please select position';
        return;
    }
    if (!id) {
        errorEl.textContent = '‚ö†Ô∏è Please enter ID number';
        return;
    }
    if (!hired) {
        errorEl.textContent = '‚ö†Ô∏è Please enter date hired';
        return;
    }
    if (!current) {
        errorEl.textContent = '‚ö†Ô∏è Please select current assignment';
        return;
    }
    if (!age || age < 18 || age > 100) {
        errorEl.textContent = '‚ö†Ô∏è Please enter valid age (18-100)';
        return;
    }
    if (!gen) {
        errorEl.textContent = '‚ö†Ô∏è Please select gender';
        return;
    }
    
    // Corporate assignment: Admin only
    if (!state.isAdmin && current === 'Corporate Office') {
        errorEl.textContent = 'üîí Only Admin can assign personnel to Corporate Office';
        return;
    }
    // Corporate region projects: Admin only
    if (!state.isAdmin) {
        const assignedProject = (state.masterProjects || state.projects || []).find(p => p.name === current);
        if (assignedProject && assignedProject.region === 'CORPORATE') {
            errorEl.textContent = 'üîí Only Admin can assign personnel to Corporate region projects';
            return;
        }
    }

    // Check for duplicate ID
    if (state.personnelData && state.personnelData.some(p => p.id === id)) {
        errorEl.textContent = '‚ö†Ô∏è ID Number already exists';
        return;
    }
    
    // Calculate years of service
    const len = calculateYearsOfService(hired);
    
    // Add personnel
    if (!state.personnelData) state.personnelData = [];
    state.personnelData.push({
        name: fullName,
        pos: pos,
        id: id,
        hired: hired,
        current: current,
        age: age,
        gen: gen,
        mail: mail,
        num: num,
        addr: addr,
        len: len
    });
    
    // Save and refresh
    saveUserData(state.currentUser.email);
    renderPTable();
    updatePersonnelSummary();
    closeAddPersonnelModal();
    if (window.showToast) window.showToast('Personnel added successfully!', 'success');
    // Save to Firebase immediately
    if (window.showSyncPill) window.showSyncPill('syncing', 'Saving to cloud...');
    saveToFirebaseWithRetry()
        .then(s => {
            if (s) { if (window.markSyncComplete) window.markSyncComplete(); }
            else   { if (window.markSyncFailed)   window.markSyncFailed(); }
        })
        .catch(err => {
            console.error('Personnel add Firebase save failed:', err);
            if (window.markSyncFailed) window.markSyncFailed();
        });
}

// Edit Personnel Modal Functions
function openEditPersonnelModal(index) {
    const person = state.personnelData[index];
    if (!person) return;
    
    // Check permission for non-admin users
    if (!state.isAdmin) {
        // Corporate Office personnel: Admin only
        if (person.current === 'Corporate Office') {
            showToast('üîí Access Denied ‚Äî Corporate personnel can only be edited by Admin.', 'warning');
            return;
        }
        // Corporate region projects: Admin only
        const personProject = (state.masterProjects || state.projects || []).find(p => p.name === person.current);
        if (personProject && personProject.region === 'CORPORATE') {
            showToast('üîí Access Denied ‚Äî Corporate region personnel can only be edited by Admin.', 'warning');
            return;
        }
        if (state.userRegion) {
            const userProjects = (state.masterProjects || [])
                .filter(p => p.region === state.userRegion)
                .map(p => p.name);
            if (!userProjects.includes(person.current)) {
                showToast('‚ö†Ô∏è Access Denied - You can only edit personnel from your region', 'error');
                return;
            }
        }
    }
    
    // Populate assignment dropdown with projects
    const assignmentSelect = document.getElementById('editPersonnelAssignmentInput');
    let options = '<option value="">Select Assignment</option>';
    // Corporate Office: Admin only
    if (state.isAdmin) {
        options += '<option value="Corporate Office">Corporate Office</option>';
    }
    
    if (state.projects && state.projects.length > 0) {
        // For non-admin users, only show projects from their region (no CORPORATE)
        let projectsList = state.projects;
        if (!state.isAdmin && state.userRegion) {
            projectsList = state.projects.filter(p => p.region === state.userRegion && p.region !== 'CORPORATE');
        }

        projectsList.forEach(p => {
            if (p.region === 'CORPORATE') return; // Corporate Office covers this
            options += `<option value="${p.name}">${p.name}</option>`;
        });
    }
    
    assignmentSelect.innerHTML = options;
    
    // Fill form with current data
    document.getElementById('editPersonnelIndex').value = index;
    
    // Parse the full name into components: LAST NAME, FIRST NAME MIDDLE NAME EXT
    const fullName = person.name || '';
    const nameParts = fullName.split(',').map(s => s.trim());
    
    let lastName = '';
    let firstName = '';
    let middleName = '';
    let nameExt = '';
    
    if (nameParts.length >= 1) {
        lastName = nameParts[0];
        
        if (nameParts.length >= 2) {
            const restOfName = nameParts[1].trim().split(' ');
            firstName = restOfName[0] || '';
            
            // Check for name extensions
            const extensions = ['JR.', 'SR.', 'II', 'III', 'IV', 'V'];
            const lastPart = restOfName[restOfName.length - 1];
            
            if (extensions.includes(lastPart.toUpperCase())) {
                nameExt = lastPart.toUpperCase();
                // Middle name is everything between first name and extension
                if (restOfName.length > 2) {
                    middleName = restOfName.slice(1, -1).join(' ');
                }
            } else {
                // No extension, so everything after first name is middle name
                if (restOfName.length > 1) {
                    middleName = restOfName.slice(1).join(' ');
                }
            }
        }
    }
    
    document.getElementById('editPersonnelLastNameInput').value = lastName;
    document.getElementById('editPersonnelFirstNameInput').value = firstName;
    document.getElementById('editPersonnelMiddleNameInput').value = middleName;
    document.getElementById('editPersonnelNameExtInput').value = nameExt;
    document.getElementById('editPersonnelPositionInput').value = person.pos || '';
    document.getElementById('editPersonnelIdInput').value = person.id || '';
    document.getElementById('editPersonnelHiredInput').value = person.hired || '';
    document.getElementById('editPersonnelAssignmentInput').value = person.current || '';
    document.getElementById('editPersonnelAgeInput').value = person.age || '';
    document.getElementById('editPersonnelGenderInput').value = person.gen || '';
    document.getElementById('editPersonnelEmailInput').value = person.mail || '';
    document.getElementById('editPersonnelContactInput').value = fmtPhone(person.num || '');
    document.getElementById('editPersonnelAddressInput').value = titleCase(person.addr || '');
    document.getElementById('editPersonnelModalError').textContent = '';
    
    // Show modal
    document.getElementById('editPersonnelModal').classList.add('show');

    // Show/hide delete button based on permissions
    const deleteBtn = document.getElementById('editPersonnelDeleteBtn');
    if (deleteBtn) {
        let canDelete = true;
        if (!state.isAdmin) {
            if (person.current === 'Corporate Office') canDelete = false;
            const personProject = (state.masterProjects || state.projects || []).find(p => p.name === person.current);
            if (personProject && personProject.region === 'CORPORATE') canDelete = false;
            if (state.userRegion) {
                const userProjects = (state.masterProjects || []).filter(p => p.region === state.userRegion).map(p => p.name);
                if (!userProjects.includes(person.current)) canDelete = false;
            }
        }
        deleteBtn.style.display = canDelete ? '' : 'none';
    }
}

function closeEditPersonnelModal() {
    document.getElementById('editPersonnelModal').classList.remove('show');
}

function deletePersonnelFromModal() {
    const index = parseInt(document.getElementById('editPersonnelIndex').value);
    closeEditPersonnelModal();
    // Small delay so modal closes cleanly before delete dialog appears
    setTimeout(() => pRowDelete(index), 200);
}

function confirmEditPersonnel() {
    const index = parseInt(document.getElementById('editPersonnelIndex').value);
    const lastName = document.getElementById('editPersonnelLastNameInput').value.trim().toUpperCase();
    const firstName = document.getElementById('editPersonnelFirstNameInput').value.trim().toUpperCase();
    const middleName = document.getElementById('editPersonnelMiddleNameInput').value.trim().toUpperCase();
    const nameExt = document.getElementById('editPersonnelNameExtInput').value;
    
    // Build full name: LAST NAME, FIRST NAME MIDDLE NAME EXT
    let fullName = `${lastName}, ${firstName}`;
    if (middleName) {
        fullName += ` ${middleName}`;
    }
    if (nameExt) {
        fullName += ` ${nameExt}`;
    }
    
    const pos = document.getElementById('editPersonnelPositionInput').value;
    const id = document.getElementById('editPersonnelIdInput').value.trim();
    const hired = document.getElementById('editPersonnelHiredInput').value;
    const current = document.getElementById('editPersonnelAssignmentInput').value;
    const age = document.getElementById('editPersonnelAgeInput').value;
    const gen = document.getElementById('editPersonnelGenderInput').value;
    const mail = document.getElementById('editPersonnelEmailInput').value.trim();
    const num = document.getElementById('editPersonnelContactInput').value.trim();
    const addr = document.getElementById('editPersonnelAddressInput').value.trim();
    
    const errorEl = document.getElementById('editPersonnelModalError');
    
    // Validation
    if (!lastName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter last name';
        return;
    }
    if (!firstName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter first name';
        return;
    }
    if (!pos) {
        errorEl.textContent = '‚ö†Ô∏è Please select position';
        return;
    }
    if (!id) {
        errorEl.textContent = '‚ö†Ô∏è Please enter ID number';
        return;
    }
    if (!hired) {
        errorEl.textContent = '‚ö†Ô∏è Please enter date hired';
        return;
    }
    if (!current) {
        errorEl.textContent = '‚ö†Ô∏è Please select current assignment';
        return;
    }
    if (!age || age < 18 || age > 100) {
        errorEl.textContent = '‚ö†Ô∏è Please enter valid age (18-100)';
        return;
    }
    if (!gen) {
        errorEl.textContent = '‚ö†Ô∏è Please select gender';
        return;
    }
    
    // Corporate assignment: Admin only
    if (!state.isAdmin && current === 'Corporate Office') {
        errorEl.textContent = 'üîí Only Admin can assign personnel to Corporate Office';
        return;
    }
    if (!state.isAdmin) {
        const assignedProject2 = (state.masterProjects || state.projects || []).find(p => p.name === current);
        if (assignedProject2 && assignedProject2.region === 'CORPORATE') {
            errorEl.textContent = 'üîí Only Admin can assign personnel to Corporate region projects';
            return;
        }
    }

    // Check for duplicate ID (excluding current record)
    if (state.personnelData && state.personnelData.some((p, idx) => p.id === id && idx !== index)) {
        errorEl.textContent = '‚ö†Ô∏è ID Number already exists';
        return;
    }
    
    // Calculate years of service
    const len = calculateYearsOfService(hired);
    
    // Update personnel
    state.personnelData[index] = {
        name: fullName,
        pos: pos,
        id: id,
        hired: hired,
        current: current,
        age: age,
        gen: gen,
        mail: mail,
        num: num,
        addr: addr,
        len: len
    };
    
    // Save and refresh
    saveUserData(state.currentUser.email);
    renderPTable();
    updatePersonnelSummary();
    closeEditPersonnelModal();
    if (window.showToast) window.showToast('Personnel updated successfully!', 'success');
    // Save to Firebase immediately
    if (window.showSyncPill) window.showSyncPill('syncing', 'Saving to cloud...');
    saveToFirebaseWithRetry()
        .then(s => {
            if (s) { if (window.markSyncComplete) window.markSyncComplete(); }
            else   { if (window.markSyncFailed)   window.markSyncFailed(); }
        })
        .catch(err => {
            console.error('Personnel edit Firebase save failed:', err);
            if (window.markSyncFailed) window.markSyncFailed();
        });
}

// Track collapsed project/group cards
const _pCollapsedProjects = new Set();

// Toggle project card by safeKey (used by delegated listener)
function _pToggleProjectBySafeKey(safeKey) {
    const body = document.getElementById('p-proj-body-' + safeKey);
    const chev = document.getElementById('p-proj-chev-' + safeKey);
    if (!body) return;
    const isVisible = body.style.display !== 'none';
    body.style.display = isVisible ? 'none' : '';
    if (chev) chev.style.transform = isVisible ? 'rotate(-90deg)' : 'rotate(0deg)';
    if (isVisible) _pCollapsedProjects.add(safeKey);
    else _pCollapsedProjects.delete(safeKey);
}

// Delegated click handler on cards container ‚Äî catches all project header clicks
document.addEventListener('click', function(e) {
    const toggle = e.target.closest('.p-proj-toggle');
    if (!toggle) return;
    const safeKey = toggle.getAttribute('data-proj-key');
    if (safeKey) _pToggleProjectBySafeKey(safeKey);
});

// Keep window.pToggleProject for any legacy inline calls (shouldn't be needed)
window.pToggleProject = function(projKey) {
    const safeKey = projKey.replace(/[^a-zA-Z0-9]/g, '_');
    _pToggleProjectBySafeKey(safeKey);
};

window.pToggleGroup = function(grpKey) {
    const safeKey = grpKey.replace(/[^a-zA-Z0-9]/g, '_');
    const body = document.getElementById('p-grp-body-' + safeKey);
    const chev = document.getElementById('p-grp-chev-' + safeKey);
    if (!body) return;
    const isVisible = body.style.display !== 'none';
    body.style.display = isVisible ? 'none' : '';
    if (chev) chev.style.transform = isVisible ? 'rotate(-90deg)' : 'rotate(0deg)';
};

// Safe version: key is already sanitized, no need to re-process
window.pToggleGroupSafe = function(safeKey) {
    const body = document.getElementById('p-grp-body-' + safeKey);
    const chev = document.getElementById('p-grp-chev-' + safeKey);
    if (!body) return;
    const isVisible = body.style.display !== 'none';
    body.style.display = isVisible ? 'none' : '';
    if (chev) chev.style.transform = isVisible ? 'rotate(-90deg)' : 'rotate(0deg)';
};

const P_TABLE_THEAD = `
<tr style="background:linear-gradient(90deg,#1b5e20 0%,#388e3c 100%);">
    <th style="padding:8px 12px;color:white;text-align:left;white-space:nowrap;font-weight:700;letter-spacing:0.3px;border:none;position:sticky;left:0;z-index:10;background:#1b5e20;">#&nbsp;&nbsp;Full Name</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:180px;">Position</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:95px;">ID Number</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:110px;">Date Hired</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;min-width:180px;">Current Assignment</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:48px;">Age</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:80px;">Gender</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;min-width:180px;">Email</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:115px;">Contact No.</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;min-width:200px;">Home Address</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:70px;">Yrs. of Svc</th>
    <th style="padding:8px 8px;color:white;text-align:center;white-space:nowrap;font-weight:700;border:none;width:100px;">Action</th>
</tr>`;

function buildProjectCard(projName, personnel, projOptions, displayIndexRef, isCorporateCard) {
    const safeKey = projName.replace(/[^a-zA-Z0-9]/g, '_');
    const isCollapsed = _pCollapsedProjects.has(projName);
    const count = personnel.length;
    // Corporate Office uses same green styling as regular project cards ‚Äî no blue
    const headerBg = 'background:linear-gradient(90deg,#1b5e20 0%,#2e7d32 60%,#388e3c 100%);border-left:3px solid #fbc02d;';
    const iconEl = isCorporateCard ? 'fa-building-columns' : 'fa-solar-panel';
    const badgeBg = 'rgba(251,192,45,0.25)';

    let rows = '';
    personnel.forEach(item => {
        const origIdx = item._origIdx;
        const p = state.personnelData[origIdx];
        if (!p) return;
        displayIndexRef.n++;
        const di = displayIndexRef.n;
        const genderClass = p.gen === 'Male' ? 'p-gender-m' : p.gen === 'Female' ? 'p-gender-f' : '';
        const posDisplay  = p.pos && p.pos !== 'Select' ? `<span class="p-pos-badge">${p.pos}</span>` : '';
        const genDisplay  = p.gen && p.gen !== 'Select' ? `<span class="p-pos-badge ${genderClass}">${p.gen}</span>` : '';
        const yearsOfService = calculateYearsOfService(p.hired);
        if (p.hired && yearsOfService !== '' && p.len !== yearsOfService.toString()) {
            state.personnelData[origIdx].len = yearsOfService.toString();
        }
        const rowBg = di % 2 === 0 ? 'background:#ffffff;' : 'background:#f4f6f8;';
        rows += `
        <tr id="p-row-${origIdx}" style="${rowBg}">
            <td style="text-align:left;position:sticky;left:0;z-index:5;${di%2===1?'background:#f4f6f8;':'background:#ffffff;'}white-space:nowrap;padding:6px 10px 6px 12px;">
                <span class="p-row-num">${di}</span>
                <div class="p-view-text" style="display:inline-block;white-space:nowrap;vertical-align:middle;font-size:0.72rem;text-transform:uppercase;padding-right:6px;">${(p.name||'').toUpperCase()}</div>
                <input type="text" value="${(p.name||'').toUpperCase()}" onchange="state.personnelData[${origIdx}].name=this.value.toUpperCase()" style="min-width:190px;text-align:left;text-transform:uppercase;display:none;" disabled>
            </td>
            <td style="width:180px;text-align:center;">
                ${posDisplay}
                <select onchange="state.personnelData[${origIdx}].pos=this.value;renderPTable();" style="width:170px;display:none;text-align:center;" disabled>
                    <option value="${p.pos||''}">${p.pos||'Select'}</option>
                    <optgroup label="Project-Based Positions">
                        <option>ESH Superintendent</option><option>ESH Head</option>
                        <option>Safety Officer I</option><option>Safety Officer II</option>
                        <option>Safety Officer III</option><option>Safety Officer IV</option>
                        <option>PCO</option><option>Project Physician</option>
                        <option>Project Nurse</option><option>First Aider</option>
                    </optgroup>
                    <optgroup label="Corporate Positions">
                        <option>QESH Group Manager</option><option>QESH Deputy Manager</option>
                        <option>ESH Manager for Regulation &amp; Compliance</option>
                        <option>ESH Manager for Project Implementation</option>
                        <option>Environmental and Sustainability Head</option>
                        <option>Corporate Physician</option><option>Corporate Nurse</option>
                        <option>QESH Corp. DC</option>
                    </optgroup>
                    <optgroup label="Other"><option>Others</option></optgroup>
                </select>
            </td>
            <td style="width:95px;text-align:center;"><input type="text" value="${p.id||''}" onchange="state.personnelData[${origIdx}].id=this.value" style="width:80px;text-align:center;" disabled></td>
            <td style="width:110px;text-align:center;">
                <div class="p-view-text p-hired-display" style="font-size:0.72rem;white-space:nowrap;">${formatDateDMY(p.hired)}</div>
                <input type="date" value="${p.hired||''}" onchange="state.personnelData[${origIdx}].hired=this.value;renderPTable();" style="width:100px;display:none;" disabled>
            </td>
            <td style="min-width:180px;text-align:center;">
                <select onchange="state.personnelData[${origIdx}].current=this.value" style="min-width:170px;text-align:center;text-align-last:center;" disabled>
                    <option value="${p.current||''}">${p.current||'Select Assignment'}</option>
                    ${projOptions}
                </select>
            </td>
            <td style="width:48px;text-align:center;"><input type="number" value="${p.age||''}" onchange="state.personnelData[${origIdx}].age=this.value" style="width:38px;text-align:center;" min="0" max="99" disabled></td>
            <td style="width:80px;text-align:center;">
                ${genDisplay}
                <select onchange="state.personnelData[${origIdx}].gen=this.value;renderPTable();" style="width:70px;display:none;" disabled>
                    <option value="${p.gen||''}">${p.gen||'Select'}</option>
                    <option>Male</option><option>Female</option>
                </select>
            </td>
            <td style="min-width:180px;text-align:center;">
                <div class="p-view-text" style="white-space:normal;word-break:break-all;font-size:0.72rem;">${p.mail||''}</div>
                <input type="email" value="${p.mail||''}" onchange="state.personnelData[${origIdx}].mail=this.value" style="min-width:165px;text-align:center;display:none;" disabled>
            </td>
            <td style="width:115px;text-align:center;"><input type="text" value="${p.num||''}" onchange="state.personnelData[${origIdx}].num=fmtPhone(this.value);this.value=fmtPhone(this.value)" style="width:105px;text-align:center;" disabled></td>
            <td style="min-width:200px;text-align:left;">
                <div class="p-view-text" style="white-space:normal;word-break:break-word;font-size:0.72rem;padding:2px 0;">${p.addr||''}</div>
                <input type="text" value="${p.addr||''}" onchange="state.personnelData[${origIdx}].addr=this.value" style="min-width:185px;text-align:center;display:none;" disabled>
            </td>
            <td style="width:70px;text-align:center;"><input type="number" value="${yearsOfService!==''?yearsOfService:(p.len||'')}" style="width:50px;text-align:center;background:#f0f0f0;color:#666;font-weight:600;" min="0" max="99" disabled readonly title="Auto-calculated from Date Hired"></td>
            <td style="width:100px;text-align:center;white-space:nowrap;">
                <button class="p-edit-btn" id="p-edit-btn-${origIdx}" onclick="openEditPersonnelModal(${origIdx})"><i class="fas fa-edit"></i></button>
            </td>
        </tr>`;
    });

    return `
    <div class="p-project-card" style="margin-bottom:2px;">
        <div class="p-proj-toggle" data-proj-key="${safeKey}" style="${headerBg}cursor:pointer;user-select:none;">
            <div style="display:flex;align-items:center;gap:8px;padding:7px 16px 7px 18px;color:white;font-weight:700;font-size:0.71rem;letter-spacing:0.4px;">
                <i class="fas ${iconEl}" style="font-size:0.65rem;opacity:0.85;color:#fbc02d;"></i>
                <span style="flex:1;">${projName}</span>
                <span style="background:${badgeBg};color:#fbc02d;padding:2px 9px;border-radius:10px;font-size:0.6rem;font-weight:800;border:1px solid rgba(251,192,45,0.4);">${count}</span>
                <i id="p-proj-chev-${safeKey}" class="fas fa-chevron-down" style="font-size:0.6rem;opacity:0.8;transition:transform 0.2s;transform:${isCollapsed?'rotate(-90deg)':'rotate(0deg)'}"></i>
            </div>
        </div>
        <div id="p-proj-body-${safeKey}" style="overflow-x:auto;display:${isCollapsed?'none':''};">
            <table style="width:max-content;min-width:100%;border-collapse:collapse;font-size:0.72rem;">
                <thead>${P_TABLE_THEAD}</thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    </div>`;
}

function renderPTable() {
    const container = document.getElementById('p-cards-container');
    if (!container) return;

    // Show global Edit All / Save All action bar
    const pGlobalAction = document.getElementById('p-global-action');
    if (pGlobalAction) {
        pGlobalAction.style.display = 'flex';
        const editBtn = document.getElementById('p-global-edit-btn');
        const saveBtn = document.getElementById('p-global-save-btn');
        if (editBtn) editBtn.style.display = '';
        if (saveBtn) saveBtn.style.display = 'none';
    }

    // Build project assignment dropdown options
    let projOptions = '<optgroup label="Corporate/Head Office">';
    if (state.isAdmin) projOptions += '<option value="Corporate Office">Corporate Office</option>';
    projOptions += '</optgroup>';
    if (state.projects && state.projects.length > 0) {
        let projectsList = state.projects;
        if (!state.isAdmin && state.userRegion) {
            projectsList = state.projects.filter(p => p.region === state.userRegion && p.region !== 'CORPORATE');
        }
        projOptions += '<optgroup label="Project Sites">';
        projOptions += projectsList.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        projOptions += '</optgroup>';
    }

    // Raw data with original indices
    let rawData = (state.personnelData || []).map((p, i) => ({ ...p, _origIdx: i }));

    // Regional filtering for non-admins
    if (!state.isAdmin && state.userRegion) {
        const userProjects = (state.masterProjects || []).filter(p => p.region === state.userRegion).map(p => p.name);
        rawData = rawData.filter(p => userProjects.includes(p.current));
    }

    // Position rank helpers
    const CORP_POS_ORDER = ['QESH Group Manager','QESH Deputy Manager','ESH Manager for Regulation & Compliance','ESH Manager for Project Implementation','Environmental and Sustainability Head','Corporate Physician','Corporate Nurse','QESH Corp. DC','Others'];
    const PROJECT_POS_ORDER = ['ESH Superintendent','ESH Head','Safety Officer IV','Safety Officer III','Safety Officer II','Safety Officer I','PCO','Project Physician','Project Nurse','First Aider','Others'];
    const REGION_ORDER = ['CORPORATE','NCR','SOUTH LUZON','NORTH LUZON','VISAYAS & MINDANAO'];

    const corpPosRank = pos => { const i = CORP_POS_ORDER.indexOf(pos); return i >= 0 ? i : CORP_POS_ORDER.length; };
    const projPosRank = pos => { const i = PROJECT_POS_ORDER.indexOf(pos); return i >= 0 ? i : PROJECT_POS_ORDER.length; };
    const regionRank  = r   => { const i = REGION_ORDER.indexOf((r||'').toUpperCase()); return i >= 0 ? i : REGION_ORDER.length; };

    // Build project‚Üíregion map (needed early)
    const projectRegionMap = {};
    (state.masterProjects || state.projects || []).forEach(p => { if (p.name) projectRegionMap[p.name] = (p.region||'').toUpperCase(); });

    // Separate corporate vs project personnel
    // Corporate group = "Corporate Office" OR any project assigned to CORPORATE region
    const corpPersonnel    = rawData.filter(p => p.current === 'Corporate Office' || projectRegionMap[p.current] === 'CORPORATE').sort((a,b) => corpPosRank(a.pos)-corpPosRank(b.pos));
    const projectPersonnel = rawData.filter(p => p.current !== 'Corporate Office' && projectRegionMap[p.current] !== 'CORPORATE');
    projectPersonnel.forEach(p => { p._region = projectRegionMap[p.current] || 'OTHER'; });

    // Group by region ‚Üí project
    const regionGroups = {};
    projectPersonnel.forEach(p => {
        const r = p._region;
        if (!regionGroups[r]) regionGroups[r] = {};
        if (!regionGroups[r][p.current]) regionGroups[r][p.current] = [];
        regionGroups[r][p.current].push(p);
    });

    // Sort within each project
    Object.values(regionGroups).forEach(projMap => Object.values(projMap).forEach(arr => arr.sort((a,b)=>projPosRank(a.pos)-projPosRank(b.pos))));

    if ((state.personnelData||[]).length === 0) {
        container.innerHTML = '';
        const emptyEl = document.getElementById('p-empty');
        if (emptyEl) emptyEl.style.display = 'block';
        updatePersonnelSummary();
        return;
    }
    const emptyEl = document.getElementById('p-empty');
    if (emptyEl) emptyEl.style.display = 'none';

    const displayIndexRef = { n: 0 };
    let html = '';

    // ‚îÄ‚îÄ GROUP 1: CORPORATE ‚Äî region-style banner, table shown directly (no sub-header) ‚îÄ‚îÄ
    if (corpPersonnel.length > 0) {
        const grpSafe = 'CORP_OFFICE';
        // Build rows directly
        let _corpRows = '';
        corpPersonnel.forEach(item => {
            const origIdx = item._origIdx;
            const p = state.personnelData[origIdx];
            if (!p) return;
            displayIndexRef.n++;
            const di = displayIndexRef.n;
            const genderClass = p.gen === 'Male' ? 'p-gender-m' : p.gen === 'Female' ? 'p-gender-f' : '';
            const posDisplay  = p.pos && p.pos !== 'Select' ? `<span class="p-pos-badge">${p.pos}</span>` : '';
            const genDisplay  = p.gen && p.gen !== 'Select' ? `<span class="p-pos-badge ${genderClass}">${p.gen}</span>` : '';
            const yearsOfService = calculateYearsOfService(p.hired);
            if (p.hired && yearsOfService !== '' && p.len !== yearsOfService.toString()) {
                state.personnelData[origIdx].len = yearsOfService.toString();
            }
            _corpRows += `
            <tr id="p-row-${origIdx}" style="${di%2===0?'background:#ffffff;':'background:#f4f6f8;'}">
                <td style="text-align:left;position:sticky;left:0;z-index:5;${di%2===1?'background:#f4f6f8;':'background:#ffffff;'}white-space:nowrap;padding:6px 10px 6px 12px;">
                    <span class="p-row-num">${di}</span>
                    <div class="p-view-text" style="display:inline-block;white-space:nowrap;vertical-align:middle;font-size:0.72rem;text-transform:uppercase;padding-right:6px;">${(p.name||'').toUpperCase()}</div>
                    <input type="text" value="${(p.name||'').toUpperCase()}" onchange="state.personnelData[${origIdx}].name=this.value.toUpperCase()" style="min-width:190px;text-align:left;text-transform:uppercase;display:none;" disabled>
                </td>
                <td style="width:180px;text-align:center;">${posDisplay}</td>
                <td style="width:95px;text-align:center;"><input type="text" value="${p.id||''}" onchange="state.personnelData[${origIdx}].id=this.value" style="width:80px;text-align:center;" disabled></td>
                <td style="width:110px;text-align:center;">
                    <div class="p-view-text p-hired-display" style="font-size:0.72rem;white-space:nowrap;">${formatDateDMY(p.hired)}</div>
                    <input type="date" value="${p.hired||''}" onchange="state.personnelData[${origIdx}].hired=this.value;renderPTable();" style="width:100px;display:none;" disabled>
                </td>
                <td style="min-width:180px;text-align:center;">
                    <select onchange="state.personnelData[${origIdx}].current=this.value" style="min-width:170px;" disabled>
                        <option value="${p.current||''}">${p.current||'Select Assignment'}</option>
                        ${projOptions}
                    </select>
                </td>
                <td style="width:48px;text-align:center;"><input type="number" value="${p.age||''}" onchange="state.personnelData[${origIdx}].age=this.value" style="width:38px;text-align:center;" min="0" max="99" disabled></td>
                <td style="width:80px;text-align:center;">${genDisplay}</td>
                <td style="min-width:180px;text-align:center;">
                    <div class="p-view-text" style="white-space:normal;word-break:break-all;font-size:0.72rem;">${p.mail||''}</div>
                </td>
                <td style="width:115px;text-align:center;"><input type="text" value="${p.num||''}" onchange="state.personnelData[${origIdx}].num=fmtPhone(this.value);this.value=fmtPhone(this.value)" style="width:105px;text-align:center;" disabled></td>
                <td style="min-width:200px;text-align:left;">
                    <div class="p-view-text" style="white-space:normal;word-break:break-word;font-size:0.72rem;padding:2px 0;">${p.addr||''}</div>
                </td>
                <td style="width:70px;text-align:center;"><input type="number" value="${yearsOfService!==''?yearsOfService:(p.len||'')}" style="width:50px;text-align:center;background:#f0f0f0;color:#666;font-weight:600;" min="0" max="99" disabled readonly></td>
                <td style="width:100px;text-align:center;white-space:nowrap;">
                    <button class="p-edit-btn" id="p-edit-btn-${origIdx}" onclick="openEditPersonnelModal(${origIdx})"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`;
        });
        html += `
        <div style="background:linear-gradient(90deg,#1b5e20 0%,#2e7d32 60%,#388e3c 100%);cursor:pointer;user-select:none;" onclick="pToggleGroup('CORP_OFFICE')">
            <div style="display:flex;align-items:center;gap:8px;padding:10px 16px;color:white;font-weight:800;font-size:0.75rem;letter-spacing:1px;">
                <span style="flex:1;">üè¢ CORPORATE</span>
                <i id="p-grp-chev-${grpSafe}" class="fas fa-chevron-down" style="font-size:0.65rem;opacity:0.8;transition:transform 0.2s;"></i>
            </div>
        </div>
        <div id="p-grp-body-${grpSafe}" style="overflow-x:auto;">
            <table style="width:max-content;min-width:100%;border-collapse:collapse;font-size:0.72rem;">
                <thead>${P_TABLE_THEAD}</thead>
                <tbody>${_corpRows}</tbody>
            </table>
        </div>`;
    }

    // ‚îÄ‚îÄ GROUP 2: Project regions ‚îÄ‚îÄ
    const sortedRegionKeys = Object.keys(regionGroups).filter(r => r !== 'CORPORATE').sort((a,b) => regionRank(a)-regionRank(b));

    sortedRegionKeys.forEach(region => {
        const projMap = regionGroups[region];
        const regionLabelMap = { 'NCR':'üìç NCR','SOUTH LUZON':'üìç SOUTH LUZON','NORTH LUZON':'üìç NORTH LUZON','VISAYAS & MINDANAO':'üìç VISAYAS & MINDANAO','CORPORATE':'üè¢ CORPORATE' };
        const regionLabel = regionLabelMap[region] || `üìç ${region}`;
        // All regions use same green ‚Äî no special blue for corporate
        const regionIcon = region === 'CORPORATE' ? 'fa-building-columns' : 'fa-map-marker-alt';
        const regionCount = Object.values(projMap).reduce((acc,arr) => acc+arr.length, 0);
        const grpSafe = region.replace(/[^a-zA-Z0-9]/g,'_');

        // Superintendent project first
        const supEntry = projectPersonnel.find(p => p._region === region && p.pos === 'ESH Superintendent');
        const supProj  = supEntry ? supEntry.current : null;
        const projectNames = Object.keys(projMap).sort((a,b) => a===supProj?-1:b===supProj?1:a.localeCompare(b));

        html += `<div style="background:linear-gradient(90deg,#1b5e20 0%,#2e7d32 60%,#388e3c 100%);cursor:pointer;user-select:none;" onclick="pToggleGroupSafe('${grpSafe}')">
            <div style="display:flex;align-items:center;gap:8px;padding:10px 16px;color:white;font-weight:800;font-size:0.75rem;letter-spacing:1px;">
                <span style="flex:1;">${regionLabel}</span>
                <span style="background:rgba(255,255,255,0.18);padding:2px 10px;border-radius:10px;font-size:0.62rem;font-weight:700;">${regionCount} personnel</span>
                <i id="p-grp-chev-${grpSafe}" class="fas fa-chevron-down" style="font-size:0.65rem;opacity:0.8;transition:transform 0.2s;transform:rotate(-90deg);"></i>
            </div>
        </div>
        <div id="p-grp-body-${grpSafe}" style="display:none;">
        ${projectNames.map(projName => {
            const personnel = projMap[projName].sort((a,b) => projPosRank(a.pos)-projPosRank(b.pos));
            return buildProjectCard(projName, personnel, projOptions, displayIndexRef, false);
        }).join('')}
        </div>`;
    });

    container.innerHTML = html;
    updatePersonnelSummary();
}

function updatePersonnelSummary() {
    const data = state.personnelData || [];
    const badgesEl = document.getElementById('p-summary-badges');
    const footerEl = document.getElementById('p-footer');
    if (!badgesEl) return;

    const total  = data.length;
    const male   = data.filter(p => p.gen === 'Male').length;
    const female = data.filter(p => p.gen === 'Female').length;

    badgesEl.innerHTML = `
        <span style="background:rgba(255,255,255,0.2);color:white;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            <i class="fas fa-users"></i> ${total} Total
        </span>
        <span style="background:rgba(33,150,243,0.3);color:#bbdefb;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            ‚ôÇ ${male} Male
        </span>
        <span style="background:rgba(233,30,99,0.3);color:#f8bbd0;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            ‚ôÄ ${female} Female
        </span>`;

    if (footerEl) {
        const positions = {};
        data.forEach(p => { if (p.pos && p.pos !== 'Select') positions[p.pos] = (positions[p.pos]||0)+1; });
        const posStr = Object.entries(positions).map(([k,v]) => `${k}: ${v}`).join(' &nbsp;|&nbsp; ');
        footerEl.innerHTML = posStr
            ? `<i class="fas fa-id-badge" style="color:#2e7d32;"></i> &nbsp; ${posStr}`
            : '';
    }
}

function pRowEdit(i) {
    const row = document.getElementById('p-row-' + i);
    if (!row) return;
    // Hide view-only text divs, show inputs
    row.querySelectorAll('.p-view-text').forEach(el => el.style.display = 'none');
    row.querySelectorAll('input').forEach(el => { el.disabled = false; el.style.display = ''; });
    row.querySelectorAll('select').forEach(el => { el.disabled = false; el.style.display = ''; });
    row.querySelectorAll('.p-pos-badge').forEach(el => el.style.display = 'none');
    row.classList.add('p-editing');
    const editBtn = document.getElementById('p-edit-btn-' + i);
    const saveBtn = document.getElementById('p-save-btn-' + i);
    if (editBtn) editBtn.style.display = 'none';
    if (saveBtn) { saveBtn.style.display = 'inline-flex'; }
}

function pRowSave(i) {
    const row = document.getElementById('p-row-' + i);
    if (!row) return;
    
    // Recalculate years of service before saving
    if (state.personnelData[i] && state.personnelData[i].hired) {
        const yearsOfService = calculateYearsOfService(state.personnelData[i].hired);
        if (yearsOfService !== '') {
            state.personnelData[i].len = yearsOfService.toString();
        }
    }
    
    row.querySelectorAll('input').forEach(el => el.disabled = true);
    row.querySelectorAll('select').forEach(el => { el.disabled = true; el.style.display = 'none'; });
    row.querySelectorAll('.p-pos-badge').forEach(el => el.style.display = '');
    row.classList.remove('p-editing');
    const editBtn = document.getElementById('p-edit-btn-' + i);
    const saveBtn = document.getElementById('p-save-btn-' + i);
    if (editBtn) editBtn.style.display = 'inline-flex';
    if (saveBtn) saveBtn.style.display = 'none';
    saveUserData(state.currentUser.email);
    renderPTable(); // refresh badges and recalculate years
}

function pRowDelete(i) {
    const person = state.personnelData[i];
    if (!person) return;
    
    // Check permission for non-admin users
    if (!state.isAdmin) {
        // Corporate Office personnel: Admin only
        if (person.current === 'Corporate Office') {
            showToast('üîí Access Denied ‚Äî Corporate personnel can only be deleted by Admin.', 'warning');
            return;
        }
        // Corporate region projects: Admin only
        const personProj = (state.masterProjects || state.projects || []).find(p => p.name === person.current);
        if (personProj && personProj.region === 'CORPORATE') {
            showToast('üîí Access Denied ‚Äî Corporate region personnel can only be deleted by Admin.', 'warning');
            return;
        }
        if (state.userRegion) {
            const userProjects = (state.masterProjects || [])
                .filter(p => p.region === state.userRegion)
                .map(p => p.name);
            if (!userProjects.includes(person.current)) {
                showToast('‚ö†Ô∏è Access Denied - You can only delete personnel from your region', 'error');
                return;
            }
        }
    }
    
    const personName = person.name || 'this personnel';

    showDeleteDialog('Personnel', personName).then(confirmed => {
        if (!confirmed) return;

        // Save a copy for undo
        const deletedPerson = { ...state.personnelData[i] };
        const deletedIndex  = i;

        state.personnelData.splice(i, 1);
        renderPTable();
        saveUserData(state.currentUser.email);

        // Show undo toast
        showUndoToast(`"${personName}" has been removed.`, () => {
            // Restore at original position (or end if index out of range)
            const restoreAt = Math.min(deletedIndex, state.personnelData.length);
            state.personnelData.splice(restoreAt, 0, deletedPerson);
            renderPTable();
            saveUserData(state.currentUser.email);
            saveToFirebaseWithRetry().catch(() => {});
            if (window.showToast) window.showToast('Personnel restored successfully!', 'success');
        });

        // Save to Firebase after a short delay (allows undo window)
        setTimeout(() => {
            saveToFirebaseWithRetry().catch(() => {});
        }, 5500);
    });
}

function filterPTable() {
    const column = document.getElementById('p-filter-column').value;
    const filterValue = (document.getElementById('p-filter-value').value || '').toLowerCase();
    const container = document.getElementById('p-cards-container');
    if (!container || !state.personnelData) return;

    // No filter ‚Äî restore everything
    if (!filterValue) {
        // Re-render to restore collapse state properly
        renderPTable();
        return;
    }

    // With filter: expand all cards and show only matching rows
    container.querySelectorAll('[id^="p-proj-body-"], [id^="p-grp-body-"]').forEach(el => el.style.display = '');

    container.querySelectorAll('tr[id^="p-row-"]').forEach(row => {
        const origIdx = parseInt(row.id.replace('p-row-', ''));
        const person = state.personnelData[origIdx];
        if (!person) { row.style.display = 'none'; return; }

        let shouldShow = false;
        if (column === 'all') {
            shouldShow = ['name','pos','id','current','gen','mail','num','addr']
                .some(k => (person[k]||'').toLowerCase().includes(filterValue));
        } else {
            shouldShow = (person[column]||'').toLowerCase().includes(filterValue);
        }
        row.style.display = shouldShow ? '' : 'none';
    });

    // Hide project cards where all rows are hidden
    container.querySelectorAll('.p-project-card').forEach(card => {
        const visibleRows = card.querySelectorAll('tr[id^="p-row-"]:not([style*="display: none"]):not([style*="display:none"])');
        const cardBody = card.querySelector('[id^="p-proj-body-"]');
        if (cardBody) cardBody.style.display = visibleRows.length ? '' : 'none';
    });
}

// --- INCIDENT TABULATION RATE SYSTEM (merged into Statistics Rate tab) ---

/**
 * Computes aggregate tabulation stats from all projects' rates + exposures data.
 */
function computeAggregateTabulation() {
    // Aggregate across ALL projects and ALL 12 months
    let totalManHours   = 0;   // from exposures_Total Exposed Manhour
    let ltaCases        = 0;   // from medical_LTA  (Lost Time Accidents)
    let medTreatment    = 0;   // from medical_Medical Treatment
    let firstAid        = 0;   // from medical_First Aid
    let fatality        = 0;   // from medical_Fatality
    let highPotential   = 0;   // from medical_High-Potential incident
    let lostDaysTotal   = 0;   // from exposures_No. of Days w/o LTA (inverse: total days - days without LTA)
    // Also try to get lost days from a dedicated field if present
    // We'll approximate: No. of Days w/o LTA is NOT the same as lost days.
    // For lost days we use the SEVERITY RATE √ó TotalHours / 1,000,000 approach as fallback.
    let totalSeveritySum = 0;  // sum of Severity Rate values per month (fallback for lost days)

    state.projects.forEach(p => {
        for (let i = 1; i <= 12; i++) {
            totalManHours   += parseFloat(p.vals['exposures_Total Exposed Manhour']?.[i]) || 0;
            ltaCases        += parseFloat(p.vals['medical_LTA']?.[i])                     || 0;
            medTreatment    += parseFloat(p.vals['medical_Medical Treatment']?.[i])       || 0;
            firstAid        += parseFloat(p.vals['medical_First Aid']?.[i])               || 0;
            fatality        += parseFloat(p.vals['medical_Fatality']?.[i])                || 0;
            highPotential   += parseFloat(p.vals['medical_High-Potential incident']?.[i]) || 0;
            totalSeveritySum+= parseFloat(p.vals['rates_SEVERITY RATE']?.[i])             || 0;
        }
    });

    // Recordable Cases = LTA + Medical Treatment + Fatality + High-Potential
    // (First Aid is typically NOT recordable under OSHS, but included if needed)
    const recordableCases = ltaCases + medTreatment + fatality + highPotential;

    // Lost Days: back-calculate from Severity Rate if no direct field
    // SR (OSHS) = LostDays √ó 1,000,000 / ManHours  ‚Üí  LostDays = SR √ó ManHours / 1,000,000
    // We use the average SR per month that has data, multiplied by total hours
    let lostDays = 0;
    if (totalManHours > 0 && totalSeveritySum > 0) {
        // Count months that have severity data
        let srMonthCount = 0;
        state.projects.forEach(p => {
            for (let i = 1; i <= 12; i++) {
                if (parseFloat(p.vals['rates_SEVERITY RATE']?.[i]) > 0) srMonthCount++;
            }
        });
        const avgSR = srMonthCount > 0 ? totalSeveritySum / srMonthCount : totalSeveritySum;
        lostDays = Math.round((avgSR * totalManHours) / 1000000);
    }

    // OSHS Formula (Philippines standard) ‚Äî base: 1,000,000 man-hours
    // LTIR = LTA Cases √ó 1,000,000 / Total Man-hours
    // TRIR = Recordable Cases √ó 1,000,000 / Total Man-hours
    // SR   = Lost Days √ó 1,000,000 / Total Man-hours
    // OSHA Formula ‚Äî base: 200,000 man-hours
    // LTIR = LTA Cases √ó 200,000 / Total Man-hours
    // TRIR = Recordable Cases √ó 200,000 / Total Man-hours
    // SR   = Lost Days √ó 200,000 / Total Man-hours

    let ltirOsha = 0, ltirOshs = 0, trirOsha = 0, trirOshs = 0, srOsha = 0, srOshs = 0;
    if (totalManHours > 0) {
        ltirOsha = (ltaCases        * 200000)   / totalManHours;
        ltirOshs = (ltaCases        * 1000000)  / totalManHours;
        trirOsha = (recordableCases * 200000)   / totalManHours;
        trirOshs = (recordableCases * 1000000)  / totalManHours;
        srOsha   = (lostDays        * 200000)   / totalManHours;
        srOshs   = (lostDays        * 1000000)  / totalManHours;
    }

    return {
        recordableCases: recordableCases,
        lostDays:        lostDays,
        totalHours:      Math.round(totalManHours),
        ltaCases:        ltaCases,
        fatalCases:      fatality,
        ltirOsha:  ltirOsha.toFixed(4), ltirOshs:  ltirOshs.toFixed(4),
        trirOsha:  trirOsha.toFixed(4), trirOshs:  trirOshs.toFixed(4),
        srOsha:    srOsha.toFixed(4),   srOshs:    srOshs.toFixed(4)
    };
}

/**
 * Returns the HTML string for the Incident Tabulation Rate panel.
 * Injected at the TOP of the Statistics Rate tab on every render.
 */
function buildIncidentTabulationHTML() {
    const d = computeAggregateTabulation();
    return `
    <div id="incident-tabulation-panel" style="padding: 12px 20px 0 20px;">
      <div style="background: var(--bg-card); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid var(--border-color); margin-bottom: 6px;">

        <!-- Panel header -->
        <div style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #43a047 100%); color: white; padding: 8px 14px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <i class="fas fa-calculator" style="font-size: 0.9rem;"></i>
          <span style="font-weight: 700; font-size: 0.85rem; letter-spacing: 0.4px;">INCIDENT TABULATION RATE</span>
          <span style="background: var(--safety-yellow); color: #1b5e20; padding: 2px 8px; border-radius: 20px; font-size: 0.62rem; font-weight: 800; margin-left: 2px;">AUTO-COMPUTED FROM ALL PROJECTS</span>
        </div>

        <!-- 4 summary cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">

          <div style="padding: 10px 14px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.58rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 3px;">No. of LTA Cases</div>
            <div style="font-size: 1.5rem; font-weight: 900; color: #1b5e20; line-height: 1;">${d.ltaCases}</div>
            <div style="font-size: 0.57rem; color: var(--text-secondary); margin-top: 2px;">Lost Time Accidents YTD</div>
          </div>

          <div style="padding: 10px 14px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.58rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 3px;">No. of Recordable Cases</div>
            <div style="font-size: 1.5rem; font-weight: 900; color: #e65100; line-height: 1;">${d.recordableCases}</div>
            <div style="font-size: 0.57rem; color: var(--text-secondary); margin-top: 2px;">LTA + Medical + Fatality + High-Pot.</div>
          </div>

          <div style="padding: 10px 14px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.58rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 3px;">No. of Lost Days</div>
            <div style="font-size: 1.5rem; font-weight: 900; color: #1565c0; line-height: 1;">${d.lostDays}</div>
            <div style="font-size: 0.57rem; color: var(--text-secondary); margin-top: 2px;">From Severity Rate data</div>
          </div>

          <div style="padding: 10px 14px; text-align: center;">
            <div style="font-size: 0.58rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 3px;">Total Man-hours Exposure</div>
            <div style="font-size: 1.5rem; font-weight: 900; color: #b71c1c; line-height: 1;">${d.totalHours.toLocaleString()}</div>
            <div style="font-size: 0.57rem; color: var(--text-secondary); margin-top: 2px;">Total Exposed Manhour YTD</div>
          </div>

        </div>

        <!-- Rates results table -->
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
            <thead>
              <tr>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 8px 12px; text-align: left; border: none; width: 40%;">INJURY / ILLNESS</th>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 8px 12px; text-align: center; border: none; width: 22%;">OSHA<br><span style="font-size:0.65rem;font-weight:400;">200,000 hrs base</span></th>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 8px 12px; text-align: center; border: none; width: 22%;">OSHS<br><span style="font-size:0.65rem;font-weight:400;">1,000,000 hrs base</span></th>
                <th style="background: linear-gradient(135deg, #f9a825 0%, #fbc02d 100%); color: #1b5e20; padding: 8px 12px; text-align: center; border: none; width: 16%; font-weight: 800; letter-spacing: 0.5px;">TARGET</th>
              </tr>
            </thead>
            <tbody>
              <!-- Fatality row -->
              <tr style="border-bottom: 2px solid #fbc02d;">
                <td style="background:linear-gradient(135deg,#f57f17 0%,#f9a825 100%);color:#1b5e20;padding:8px 12px;border:none;">
                  <div style="font-weight:800;font-size:0.78rem;display:flex;align-items:center;gap:6px;"><i class="fas fa-skull-crossbones" style="font-size:0.78rem;"></i> Fatality</div>
                  <div style="font-size:0.61rem;opacity:0.85;margin-top:2px;">Zero fatality target for all projects</div>
                </td>
                <td colspan="2" style="background:#fff8e1;padding:8px;text-align:center;border:1px solid #fbc02d;">
                  <div style="font-size:1.3rem;font-weight:900;color:#e65100;">0</div>
                  <div style="font-size:0.58rem;color:#e65100;font-weight:700;">ACTUAL: ${d.fatalCases ?? 0}</div>
                </td>
                <td style="background:#fff9c4;padding:8px;text-align:center;border:1px solid #fbc02d;">
                  <div style="font-size:1.3rem;font-weight:900;color:#f9a825;">0</div>
                  <div style="display:inline-flex;align-items:center;gap:3px;margin-top:3px;padding:2px 8px;border-radius:20px;font-size:0.6rem;font-weight:800;
                    ${(d.fatalCases ?? 0) === 0 ? 'background:#e8f5e9;color:#2e7d32;' : 'background:#ffebee;color:#c62828;'}">
                    ${(d.fatalCases ?? 0) === 0 ? '‚úÖ ON TARGET' : '‚ö† EXCEEDED'}
                  </div>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:8px 12px;border:none;">
                  <div style="font-weight:700;font-size:0.78rem;">LTIR ‚Äî Lost Time Incident Rate</div>
                  <div style="font-size:0.61rem;opacity:0.9;margin-top:2px;">LTA Cases √ó 200K or 1M √∑ Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:8px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.3rem;font-weight:800;color:#1b5e20;">${d.ltirOsha}</div>
                  <div style="font-size:0.58rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:8px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.3rem;font-weight:800;color:#1b5e20;">${d.ltirOshs}</div>
                  <div style="font-size:0.58rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
                <td style="background:#fff9c4;padding:8px;text-align:center;border:1px solid #fbc02d;">
                  <div style="font-size:1.3rem;font-weight:900;color:#f9a825;">0.50</div>
                  <div style="display:inline-flex;align-items:center;gap:3px;margin-top:3px;padding:2px 8px;border-radius:20px;font-size:0.6rem;font-weight:800;
                    ${parseFloat(d.ltirOsha) <= 0.50 ? 'background:#e8f5e9;color:#2e7d32;' : 'background:#ffebee;color:#c62828;'}">
                    ${parseFloat(d.ltirOsha) <= 0.50 ? '‚úÖ ON TARGET' : '‚ö† EXCEEDED'}
                  </div>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:8px 12px;border:none;">
                  <div style="font-weight:700;font-size:0.78rem;">TRIR ‚Äî Total Recordable Incident Rate</div>
                  <div style="font-size:0.61rem;opacity:0.9;margin-top:2px;">Recordable Cases √ó 200K or 1M √∑ Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:8px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.3rem;font-weight:800;color:#1565c0;">${d.trirOsha}</div>
                  <div style="font-size:0.58rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:8px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.3rem;font-weight:800;color:#1565c0;">${d.trirOshs}</div>
                  <div style="font-size:0.58rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
                <td style="background:#fff9c4;padding:8px;text-align:center;border:1px solid #fbc02d;">
                  <div style="font-size:1.3rem;font-weight:900;color:#f9a825;">0.25</div>
                  <div style="display:inline-flex;align-items:center;gap:3px;margin-top:3px;padding:2px 8px;border-radius:20px;font-size:0.6rem;font-weight:800;
                    ${parseFloat(d.trirOsha) <= 0.25 ? 'background:#e8f5e9;color:#2e7d32;' : 'background:#ffebee;color:#c62828;'}">
                    ${parseFloat(d.trirOsha) <= 0.25 ? '‚úÖ ON TARGET' : '‚ö† EXCEEDED'}
                  </div>
                </td>
              </tr>
              <tr>
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:8px 12px;border:none;">
                  <div style="font-weight:700;font-size:0.78rem;">SR ‚Äî Severity Rate</div>
                  <div style="font-size:0.61rem;opacity:0.9;margin-top:2px;">Total Days Lost √ó 200K or 1M √∑ Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:8px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.3rem;font-weight:800;color:#b71c1c;">${d.srOsha}</div>
                  <div style="font-size:0.58rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:8px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.3rem;font-weight:800;color:#b71c1c;">${d.srOshs}</div>
                  <div style="font-size:0.58rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
                <td style="background:#fff9c4;padding:8px;text-align:center;border:1px solid #fbc02d;">
                  <div style="font-size:1.1rem;font-weight:700;color:#9e9e9e;">‚Äî</div>
                  <div style="font-size:0.58rem;color:#9e9e9e;">No target set</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>`;
}

// ==================== TREND LINE CHART FUNCTIONS ====================

function buildTrendChartHTML(tabType) {
    const chartId = `trendChart_${tabType}`;
    const title = tabType === 'rates' ? 'STATISTICS RATE TRENDS' : 'ACCIDENT/INCIDENT TRENDS';
    const icon = tabType === 'rates' ? 'fa-chart-line' : 'fa-chart-area';
    
    return `
    <div id="trend-chart-panel" style="padding: 20px 20px 0 20px;">
      <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); margin-bottom: 20px;">
        
        <!-- Chart header with filters -->
        <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); color: white; padding: 14px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
          <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; position: relative; z-index: 2;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <i class="fas ${icon}" style="font-size: 1.1rem;"></i>
              <span style="font-weight: 700; font-size: 1rem; letter-spacing: 0.5px;">${title}</span>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <!-- Region Filter -->
              <select id="trendRegionFilter" onchange="updateTrendChart('${tabType}')" 
                      style="padding: 6px 12px; border-radius: 6px; border: none; font-size: 0.75rem; font-weight: 600; background: white; color: #1b5e20; cursor: pointer;">
                <option value="all">ALL REGIONS</option>
                <option value="NCR">NCR</option>
                <option value="SOUTH LUZON">SOUTH LUZON</option>
                <option value="NORTH LUZON">NORTH LUZON</option>
                <option value="VISAYAS & MINDANAO">VISMIN</option>
              </select>
              
              <!-- Project Filter -->
              <select id="trendProjectFilter" onchange="updateTrendChart('${tabType}')" 
                      style="padding: 6px 12px; border-radius: 6px; border: none; font-size: 0.75rem; font-weight: 600; background: white; color: #1b5e20; cursor: pointer;">
                <option value="all">All Projects</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Chart canvas -->
        <div style="padding: 20px;">
          <canvas id="${chartId}" style="max-height: 400px;"></canvas>
        </div>
        
      </div>
    </div>`;
}

function populateProjectFilter() {
    const projectFilter = document.getElementById('trendProjectFilter');
    if (!projectFilter) return;
    
    // Keep the "All Projects" option
    projectFilter.innerHTML = '<option value="all">All Projects</option>';
    
    // Add each project
    state.projects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.textContent = p.name;
        projectFilter.appendChild(option);
    });
}

let trendChartInstance = null;

function updateTrendChart(tabType) {
    const regionFilter = document.getElementById('trendRegionFilter')?.value || 'all';
    const projectFilter = document.getElementById('trendProjectFilter')?.value || 'all';
    const chartId = `trendChart_${tabType}`;
    const canvas = document.getElementById(chartId);
    
    if (!canvas) return;
    
    // Destroy existing chart
    if (trendChartInstance) {
        trendChartInstance.destroy();
        trendChartInstance = null;
    }
    
    // Filter projects based on selection
    let filteredProjects = state.projects;
    
    if (regionFilter !== 'all') {
        filteredProjects = filteredProjects.filter(p => p.region === regionFilter);
    }
    
    if (projectFilter !== 'all') {
        filteredProjects = filteredProjects.filter(p => p.name === projectFilter);
    }
    
    // Prepare data
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const datasets = [];
    
    if (tabType === 'rates') {
        // Statistics Rate data
        const rateTypes = ['LTIR', 'TRIR', 'SEVERITY RATE'];
        const colors = ['#1b5e20', '#1565c0', '#b71c1c'];
        
        rateTypes.forEach((rateType, idx) => {
            const data = new Array(12).fill(0);
            const counts = new Array(12).fill(0);
            
            filteredProjects.forEach(p => {
                const key = `rates_${rateType}`;
                if (p.vals && p.vals[key]) {
                    for (let i = 1; i <= 12; i++) {
                        const val = parseFloat(p.vals[key][i]) || 0;
                        if (val > 0) {
                            data[i-1] += val;
                            counts[i-1]++;
                        }
                    }
                }
            });
            
            // Calculate averages
            const avgData = data.map((sum, i) => counts[i] > 0 ? (sum / counts[i]).toFixed(2) : 0);
            
            datasets.push({
                label: rateType,
                data: avgData,
                borderColor: colors[idx],
                backgroundColor: colors[idx] + '20',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        });
        
        // Add target reference lines for LTIR and TRIR
        datasets.push({
            label: 'LTIR Target (0.50)',
            data: new Array(12).fill(0.50),
            borderColor: '#1b5e20',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [8, 4],
            pointRadius: 0,
            fill: false,
            tension: 0
        });
        datasets.push({
            label: 'TRIR Target (0.25)',
            data: new Array(12).fill(0.25),
            borderColor: '#1565c0',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [8, 4],
            pointRadius: 0,
            fill: false,
            tension: 0
        });
        datasets.push({
            label: 'Fatality Target (0)',
            data: new Array(12).fill(0),
            borderColor: '#e65100',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [4, 4],
            pointRadius: 0,
            fill: false,
            tension: 0
        });
        
    } else if (tabType === 'medical') {
        // Accident/Incident Record data
        const incidentTypes = ['Medical Treatment', 'First Aid', 'LTA', 'Fatality', 'High-Potential incident', 'Dangerous Occurrences'];
        const colors = ['#1b5e20', '#2e7d32', '#1565c0', '#b71c1c', '#e65100', '#f57c00'];
        
        incidentTypes.forEach((incidentType, idx) => {
            const data = new Array(12).fill(0);
            
            filteredProjects.forEach(p => {
                const key = `medical_${incidentType}`;
                if (p.vals && p.vals[key]) {
                    for (let i = 1; i <= 12; i++) {
                        const val = parseFloat(p.vals[key][i]) || 0;
                        data[i-1] += val;
                    }
                }
            });
            
            datasets.push({
                label: incidentType,
                data: data,
                borderColor: colors[idx],
                backgroundColor: colors[idx] + '20',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        });
    }
    
    // Create chart with gradient fills
    const ctx = canvas.getContext('2d');
    
    // Create gradients for each dataset
    const datasetsWithGradients = datasets.map(ds => {
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, ds.borderColor + '40');
        gradient.addColorStop(1, ds.borderColor + '00');
        
        return {
            label: ds.label,
            data: ds.data,
            borderColor: ds.borderColor,
            backgroundColor: gradient,
            borderWidth: 2,
            pointRadius: 5,
            pointBackgroundColor: ds.borderColor,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            tension: 0.4,
            fill: true
        };
    });
    
    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: datasetsWithGradients
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        padding: 10,
                        font: {
                            size: 11,
                            weight: 600
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || '#333'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 13,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#666'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#666'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}



// ==================== LOCAL STORAGE FUNCTIONS ====================

// Save to localStorage only (called internally, no Firebase trigger)
function saveUserDataLocal(email) {
    if (!email) return;
    
    const year = state.selectedYear || 2026;
    const userData = {
        year: year,
        projects: state.projects.map(p => { const c = {...p}; delete c.selected; return c; }),
        personnelData: state.personnelData,
        incidentRateData: state.incidentRateData,
        darkMode: state.darkMode,
        lastSaved: new Date().toISOString(),
        timestamp: Date.now(),
        lastModified: new Date().toISOString()
    };
    
    // Save with year-based key
    localStorage.setItem(`esh_dashboard_${year}_${email}`, JSON.stringify(userData));
    console.log(`üíæ Saved to localStorage (local only) for year ${year}`);
}

// Main Firebase Save Button Handler
// ==================== OPTIMIZED FIREBASE INTEGRATION ====================

let firebaseReady = false;
let firebaseUnsubscribe = null;

function getCurrentUserId() {
    return window.firebaseAuth?.currentUser?.uid || 'local-user';
}

// NEW: Get the UID to read data from (always admin's UID for shared data)
function getDataSourceUserId() {
    // HARDCODED: Admin's UID from Firebase
    const ADMIN_UID = 'fUnXsvKnRYMpuySRbeVYJk7TO452';
    
    // All users read from admin's data location
    return ADMIN_UID;
}

function waitForFirebase() {
    return new Promise((resolve) => {
        if (window.firebase && window.firebaseDb && window.firebaseAuth) {
            firebaseReady = true;
            resolve();
            return;
        }
        const checkInterval = setInterval(() => {
            if (window.firebase && window.firebaseDb && window.firebaseAuth) {
                clearInterval(checkInterval);
                clearTimeout(timeoutId);
                firebaseReady = true;
                resolve();
            }
        }, 100);
        const timeoutId = setTimeout(() => {
            clearInterval(checkInterval);
            firebaseReady = false;
            console.warn('‚ö†Ô∏è Firebase timed out ‚Äî running in offline/local mode');
            resolve();
        }, 5000);
    });
}

// Save to Firebase with automatic retry on first failure
async function saveToFirebaseWithRetry(maxRetries = 2, delayMs = 2000) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        // Wait for Firebase to be ready if it isn't yet
        if (!firebaseReady || !window.firebaseDb || !state.currentUser) {
            console.log(`‚è≥ Attempt ${attempt}: Firebase not ready ‚Äî waiting...`);
            await new Promise(r => setTimeout(r, 1500));
        }
        const success = await saveToFirebase();
        if (success) return true;
        if (attempt < maxRetries) {
            console.log(`‚ö†Ô∏è Save attempt ${attempt} failed ‚Äî retrying in ${delayMs}ms...`);
            await new Promise(r => setTimeout(r, delayMs));
        }
    }
    return false;
}

// OPTIMIZED: Save to Firebase - MANUAL ONLY
async function saveToFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('‚è≥ Firebase not ready');
        return false;
    }

    // ‚îÄ‚îÄ RBAC PRE-SAVE VALIDATION (server-layer equivalent) ‚îÄ‚îÄ
    // Only validate the CURRENT TAB + CURRENT USER combination.
    // We do NOT block all projects (superintendents legitimately load cross-region data read-only).
    const currentEmail = state.currentUser?.email;
    const userInfo = UserAccounts.getUserInfo(currentEmail);

    if (userInfo.role !== 'admin' && state.currentTab) {
        // Check if this user can write to the current tab at all
        const tabCheck = UserAccounts.checkPermission(currentEmail, 'edit', userInfo.region, state.currentTab);
        if (!tabCheck.allowed) {
            console.warn('‚ö†Ô∏è RBAC: Save skipped ‚Äî user cannot edit tab:', state.currentTab, tabCheck.reason);
            // Don't block the save entirely ‚Äî just skip silently (read-only tabs trigger auto-saves on preference changes)
            // Only block if the user is actively trying to save data (not preference-only saves)
        }
    }
    // ‚îÄ‚îÄ END RBAC PRE-SAVE VALIDATION ‚îÄ‚îÄ

    try {
        const dataUserId = getDataSourceUserId(); // Save to admin's UID (shared location)
        const currentUserId = getCurrentUserId(); // Current user's UID for preferences
        const currentYear = state.selectedYear || 2026;
        
        // Update masterProjects with current changes
        // Remove old versions and add updated versions
        state.projects.forEach(project => {
            const index = state.masterProjects.findIndex(p => p.name === project.name);
            if (index >= 0) {
                state.masterProjects[index] = project;
            } else {
                state.masterProjects.push(project);
            }
        });
        
        // Now save ALL master projects to ALL their relevant years
        // Group projects by year they should appear in
        const projectsByYear = new Map();
        
        state.masterProjects.forEach(project => {
            const startYear = project.dateStarted ? parseInt(project.dateStarted.split('-')[0]) : null;
            const finishedYear = project.dateFinished ? parseInt(project.dateFinished.split('-')[0]) : null;

            // CORPORATE projects have no dates ‚Äî save them to the current year only
            if (project.region === 'CORPORATE' && !startYear) {
                if (!projectsByYear.has(currentYear)) projectsByYear.set(currentYear, []);
                projectsByYear.get(currentYear).push(project);
                return;
            }
            
            if (startYear) {
                const endYear = finishedYear || YEAR_RANGE.max;
                
                for (let year = Math.max(startYear, YEAR_RANGE.min); year <= Math.min(endYear, YEAR_RANGE.max); year++) {
                    if (!projectsByYear.has(year)) {
                        projectsByYear.set(year, []);
                    }
                    projectsByYear.get(year).push(project);
                }
            }
        });
        
        // Build save payload helper
        function buildYearPayload(year, projects) {
            const payload = {
                year: year,
                email: state.currentUser?.email || 'local-user',
                displayName: state.currentUser?.displayName || localStorage.getItem('esh_displayname_' + state.currentUser?.email) || '',
                projects: projects,
                lastUpdated: new Date().toISOString(),
                timestamp: Date.now()
            };
            if (year === currentYear) {
                payload.personnelData = state.personnelData || [];
                payload.incidentRateData = state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                payload.oshData = state.oshData || {};
            }
            return payload;
        }

        // FAST PATH: Save current year first (this is what the spinner waits for)
        const currentYearProjects = projectsByYear.get(currentYear) || [];
        const currentYearRef = window.firebase.doc(window.firebaseDb, 'users', dataUserId, 'years', currentYear.toString());
        
        // Add 8-second timeout so spinner never hangs forever
        const saveWithTimeout = (promise, ms = 8000) =>
            Promise.race([promise, new Promise((_, rej) => setTimeout(() => rej(new Error('Save timeout')), ms))]);

        await saveWithTimeout(window.firebase.setDoc(currentYearRef, buildYearPayload(currentYear, currentYearProjects), { merge: true }));

        // Also save user preferences (non-blocking, runs in parallel)
        const userDocRef = window.firebase.doc(window.firebaseDb, 'users', currentUserId);
        window.firebase.setDoc(userDocRef, {
            email: state.currentUser?.email,
            displayName: state.currentUser?.displayName || '',
            darkMode: state.darkMode || false,
            lastActiveYear: currentYear,
            isDataMigrated: true
        }, { merge: true }).catch(e => console.warn('Preferences save failed:', e));

        state.lastSyncTimestamp = Date.now();
        console.log(`‚úÖ Current year (${currentYear}) saved to Firebase:`, new Date().toLocaleTimeString());

        // BACKGROUND: Save other years silently after spinner is done (non-blocking)
        setTimeout(() => {
            const bgPromises = [];
            projectsByYear.forEach((projects, year) => {
                if (year === currentYear) return; // already saved
                const ref = window.firebase.doc(window.firebaseDb, 'users', dataUserId, 'years', year.toString());
                bgPromises.push(window.firebase.setDoc(ref, buildYearPayload(year, projects), { merge: true }));
            });
            if (bgPromises.length > 0) {
                Promise.all(bgPromises)
                    .then(() => console.log(`‚òÅÔ∏è Background save complete for ${bgPromises.length} other year(s)`))
                    .catch(e => console.warn('Background year save failed:', e));
            }
        }, 500);

        return true;
        
    } catch (error) {
        console.error('‚ùå Error saving to Firebase:', error);
        showToast('Failed to save: ' + error.message, 'error');
        return false;
    }
}

// OPTIMIZED: Load from Firebase - ONCE on login only with YEAR SUPPORT + AUTO MIGRATION
// ‚îÄ‚îÄ Auto-ensure Corporate project exists ‚îÄ‚îÄ
// Ensures a project named "Corporate" in region "CORPORATE" is always present
// so CORPORATE region tables render properly in the 5 allowed data tabs.
function ensureCorporateProject() {
    const corpProject = {
        name: 'Corporate',
        region: 'CORPORATE',
        status: 'on-going',
        dateStarted: '',
        dateFinished: '',
        isRenewable: false,
        vals: {}
    };

    // Ensure in masterProjects first (source of truth)
    const masterExists = state.masterProjects.some(p => p.name === 'Corporate' && p.region === 'CORPORATE');
    if (!masterExists) {
        state.masterProjects.unshift({ ...corpProject });
        console.log('‚úÖ Corporate project added to masterProjects');
    }

    // Ensure in state.projects (filtered list)
    const exists = state.projects.some(p => p.name === 'Corporate' && p.region === 'CORPORATE');
    if (!exists) {
        state.projects.unshift({ ...corpProject });
        console.log('‚úÖ Corporate project added to state.projects');
    }

    state.filteredProjects = [...state.projects];
}

async function loadFromFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('‚è≥ Firebase not ready, loading from localStorage only');
        loadFromLocalStorage();
        return;
    }

    try {
        const userId = getCurrentUserId();
        const userEmail = state.currentUser?.email;
        const year = state.selectedYear || 2026;
        
        // Load user preferences first
        const userDocRef = window.firebase.doc(window.firebaseDb, 'users', userId);
        const userDocSnap = await window.firebase.getDoc(userDocRef);
        
        // üîÑ AUTO-MIGRATION: Check if old data structure exists and migrate
        if (userDocSnap.exists()) {
            const userData = userDocSnap.data();
            
            // Load dark mode preference
            if (userData.darkMode !== undefined) {
                state.darkMode = userData.darkMode;
            }
            
            // Load display name
            if (userData.displayName) {
                state.currentUser.displayName = userData.displayName;
                localStorage.setItem('esh_displayname_' + userEmail, userData.displayName);
                const badge = document.getElementById('user-badge');
                if (badge) badge.innerHTML = `<i class="fas fa-user-circle"></i> ${userData.displayName}`;
            }
            
            // üö® MIGRATION: If old structure detected (has projects array at root), migrate to 2026
            if (userData.projects && !userData.isDataMigrated) {
                console.log('üîÑ OLD STRUCTURE DETECTED - Migrating to year-based structure...');
                
                // Create backup
                const backupDocRef = window.firebase.doc(window.firebaseDb, 'users', userId, 'backups', 'pre_migration');
                await window.firebase.setDoc(backupDocRef, {
                    ...userData,
                    migratedAt: new Date().toISOString(),
                    backupNote: 'Auto-backup before year-based migration'
                });
                console.log('‚úÖ Backup created at /backups/pre_migration');
                
                // Migrate to 2026
                const year2026Ref = window.firebase.doc(window.firebaseDb, 'users', userId, 'years', '2026');
                await window.firebase.setDoc(year2026Ref, {
                    year: 2026,
                    email: userData.email,
                    displayName: userData.displayName || '',
                    projects: userData.projects || [],
                    personnelData: userData.personnelData || [],
                    incidentRateData: userData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
                    lastUpdated: new Date().toISOString(),
                    timestamp: Date.now(),
                    migratedFrom: 'old_structure'
                });
                console.log('‚úÖ Data migrated to /years/2026');
                
                // Mark as migrated
                await window.firebase.setDoc(userDocRef, { isDataMigrated: true }, { merge: true });
                
                showToast('‚úÖ Your data has been migrated to year-based structure (2026)', 'success');
            }
        }
        
        // Load year-specific data
        const yearDocRef = window.firebase.doc(window.firebaseDb, 'users', userId, 'years', year.toString());
        const yearDocSnap = await window.firebase.getDoc(yearDocRef);
        
        // Check localStorage for newer unsaved data for this year
        const localKey = `esh_dashboard_${year}_${userEmail}`;
        const localRaw = localStorage.getItem(localKey);
        const localData = localRaw ? JSON.parse(localRaw) : null;
        const localTimestamp = localData?.lastSaved ? new Date(localData.lastSaved).getTime() : 0;

        if (yearDocSnap.exists()) {
            const fbData = yearDocSnap.data();
            const fbTimestamp = fbData.timestamp || 0;

            // Use whichever is newer: localStorage or Firebase
            if (localTimestamp > fbTimestamp) {
                console.log(`üíæ localStorage is newer for year ${year} ‚Äî loading from localStorage`);
                state.projects = localData.projects || [];
                state.personnelData = localData.personnelData || [];
                state.incidentRateData = localData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.oshData = localData.oshData || {};
                state.lastSyncTimestamp = fbTimestamp;
                // Push local data up to Firebase so it's in sync
                await saveToFirebase();
            } else {
                console.log(`‚òÅÔ∏è Firebase is newer for year ${year} ‚Äî loading from Firebase`);
                state.projects = fbData.projects || [];
                state.personnelData = fbData.personnelData || [];
                state.incidentRateData = fbData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.oshData = fbData.oshData || {};
                state.lastSyncTimestamp = fbTimestamp;
                // Sync Firebase data down to localStorage
                saveUserDataLocal(userEmail);
            }
            
            state.filteredProjects = [...state.projects];
            console.log(`‚úÖ Data loaded for year ${year}. Projects:`, state.projects.length, '| Personnel:', state.personnelData.length);

        } else {
            // No Firebase doc for this year ‚Äî use localStorage if available, else start fresh
            if (localData) {
                console.log(`üìù No Firebase doc for year ${year} ‚Äî restoring from localStorage`);
                state.projects = localData.projects || [];
                state.personnelData = localData.personnelData || [];
                state.incidentRateData = localData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.oshData = localData.oshData || {};
                state.filteredProjects = [...state.projects];
                await saveToFirebase(); // Save to create the year doc
            } else {
                console.log(`üìù No data for year ${year} ‚Äî starting fresh`);
                state.projects = [];
                state.personnelData = [];
                state.incidentRateData = { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.filteredProjects = [];
            }
        }

        // Apply dark mode
        if (state.darkMode) {
            document.body.classList.add('dark-mode');
        }
        
        // Ensure Corporate project always exists
        ensureCorporateProject();
        
        // Update UI
        render();
        renderPTable();
        
    } catch (error) {
        console.error('‚ùå Error loading from Firebase:', error);
        // Fallback to localStorage on error
        loadFromLocalStorage();
    }
}

// Fallback: load from localStorage only
function loadFromLocalStorage() {
    const userEmail = state.currentUser?.email;
    if (!userEmail) return;
    
    const year = state.selectedYear || 2026;
    const localKey = `esh_dashboard_${year}_${userEmail}`;
    const localRaw = localStorage.getItem(localKey);
    
    if (localRaw) {
        const data = JSON.parse(localRaw);
        state.projects = data.projects || [];
        state.personnelData = data.personnelData || [];
        state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
        state.oshData = data.oshData || {};
        state.filteredProjects = [...state.projects];
        console.log(`üíæ Loaded from localStorage fallback for year ${year}`);
        ensureCorporateProject();
        render();
        renderPTable();
    }
}

// Load all projects ONCE and filter by selected year (called only on login)
async function loadAllProjectsAndFilter() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('‚è≥ Firebase not ready');
        return;
    }

    try {
        const dataUserId = getDataSourceUserId();
        const selectedYear = state.selectedYear;
        const CACHE_KEY = `esh_projects_cache_${dataUserId}`;
        const CACHE_TS_KEY = `esh_projects_cache_ts_${dataUserId}`;
        const CACHE_TTL = 60 * 1000; // 60 seconds cache

        // ‚îÄ‚îÄ INSTANT RENDER from cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const cached = localStorage.getItem(CACHE_KEY);
        const cachedTs = parseInt(localStorage.getItem(CACHE_TS_KEY) || '0');
        const cacheAge = Date.now() - cachedTs;

        if (cached) {
            try {
                const cachedData = JSON.parse(cached);
                state.masterProjects = cachedData.masterProjects || [];
                state.personnelData = cachedData.personnelData || [];
                state.incidentRateData = cachedData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.oshData = cachedData.oshData || {};
                state.projects = filterProjectsByYear(state.masterProjects, selectedYear);
                state.filteredProjects = [...state.projects];
                render();
                renderPTable();
                console.log(`‚ö° Instant render from cache (${Math.round(cacheAge/1000)}s old)`);

                // If cache is fresh enough, skip Firebase fetch
                if (cacheAge < CACHE_TTL) {
                    console.log('‚úÖ Cache fresh ‚Äî skipping Firebase fetch');
                    return;
                }
            } catch(e) {
                console.warn('Cache parse error, loading fresh');
            }
        }

        // ‚îÄ‚îÄ PARALLEL Firebase fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        console.log(`üî• Fetching all years in parallel...`);
        const yearRefs = availableYears.map(year =>
            window.firebase.doc(window.firebaseDb, 'users', dataUserId, 'years', year.toString())
        );

        // Fire ALL requests simultaneously
        const snapshots = await Promise.all(yearRefs.map(ref => window.firebase.getDoc(ref)));

        const projectMap = new Map();
        let personnelData = [];
        let incidentRateData = { recordableCases: 0, lostDays: 0, totalHours: 0 };
        let oshData = {};

        snapshots.forEach((snap, i) => {
            if (!snap.exists()) return;
            const year = availableYears[i];
            const data = snap.data();
            const projects = data.projects || [];
            console.log(`   Year ${year}: ${projects.length} projects`);
            projects.forEach(p => { if (!projectMap.has(p.name)) projectMap.set(p.name, p); });
            if (year === selectedYear) {
                personnelData = data.personnelData || [];
                incidentRateData = data.incidentRateData || incidentRateData;
                oshData = data.oshData || {};
            }
        });

        state.masterProjects = Array.from(projectMap.values());
        state.personnelData = personnelData;
        state.incidentRateData = incidentRateData;
        state.oshData = oshData;
        state.projects = filterProjectsByYear(state.masterProjects, selectedYear);
        state.filteredProjects = [...state.projects];

        console.log(`‚úÖ Loaded ${state.masterProjects.length} projects`);

        // Save to cache
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                masterProjects: state.masterProjects,
                personnelData: state.personnelData,
                incidentRateData: state.incidentRateData,
                oshData: state.oshData
            }));
            localStorage.setItem(CACHE_TS_KEY, Date.now().toString());
        } catch(e) { console.warn('Cache save failed:', e.message); }

        // Re-render with fresh data
        render();
        renderPTable();
        console.log(`‚úÖ UI updated with fresh Firebase data`);

    } catch (error) {
        console.error('‚ùå Error loading projects:', error);
        showToast('‚ùå Error loading data: ' + error.message, 'error');
    }
}

// REMOVED: Real-time listener completely - saves lots of Firebase reads!
// No setupFirebaseListener() function = no continuous reads

// Firebase Authentication Handlers
async function firebaseLogin(email, password) {
    if (!window.firebase) {
        showToast('Firebase not initialized. Please refresh the page.', 'error');
        return false;
    }

    try {
        const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('‚úÖ Login successful:', userCredential.user.email);
        return true;
    } catch (error) {
        console.error('‚ùå Login error:', error);
        showToast('Login failed: ' + error.message, 'error');
        return false;
    }
}

async function firebaseSignup(email, password) {
    if (!window.firebase) {
        showToast('Firebase not initialized. Please refresh the page.', 'error');
        return false;
    }

    // ‚ö†Ô∏è SECURITY WARNING: Password Validation
    // Wala pang minimum requirements para sa password strength
    // Dapat mag-implement ng:
    // - Minimum 8+ characters
    // - May numbers at special characters
    // - May uppercase at lowercase letters
    // Halimbawa:
    // if (password.length < 8) {
    //     showToast('Password must be at least 8 characters long', 'warning');
    //     return false;
    // }
    // if (!/(?=.*[0-9])(?=.*[!@#$%^&*])/.test(password)) {
    //     showToast('Password must contain at least one number and one special character', 'warning');
    //     return false;
    // }

    try {
        const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('‚úÖ Signup successful:', userCredential.user.email);
        
        // Initialize user data
        await saveToFirebase();
        
        return true;
    } catch (error) {
        console.error('‚ùå Signup error:', error);
        showToast('Signup failed: ' + error.message, 'error');
        return false;
    }
}

async function firebaseLogout() {
    if (!window.firebase) {
        return;
    }

    try {
        // Cleanup presence before signing out
        if (state.currentUser && state.currentUser.uid) {
            await PresenceTracker.cleanup(); // ‚Üê MUST await ‚Äî cleanup writes to Firebase before signOut
        }
        
        // üîä Play logout sound before signing out
        playLogoutSound();
        
        // ‚è±Ô∏è Clear work timer on logout
        clearWorkTimerOnLogout();
        
        await window.firebase.signOut(window.firebaseAuth);
        
        // Unsubscribe from listener (if any exists)
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
            firebaseUnsubscribe = null;
        }
        
        console.log('‚úÖ Logout successful');
    } catch (error) {
        console.error('‚ùå Logout error:', error);
    }
}

async function firebaseChangePassword(newPassword) {
    if (!window.firebase || !window.firebaseAuth.currentUser) {
        alert('Not authenticated');
        return false;
    }

    try {
        await window.firebase.updatePassword(window.firebaseAuth.currentUser, newPassword);
        console.log('‚úÖ Password changed successfully');
        return true;
    } catch (error) {
        console.error('‚ùå Password change error:', error);
        return false;
    }
}

async function firebaseResetPassword(email) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        await window.firebase.sendPasswordResetEmail(window.firebaseAuth, email);
        console.log('‚úÖ Password reset email sent');
        return true;
    } catch (error) {
        console.error('‚ùå Password reset error:', error);
        return false;
    }
}


// Auth State Observer - OPTIMIZED: No real-time listener!
function setupAuthObserver() {
    // If Firebase is not available (offline/local mode), show login screen directly
    if (!window.firebase || !window.firebaseAuth) {
        console.warn('‚ö†Ô∏è Firebase unavailable ‚Äî showing login screen in offline mode');
        const loadingOverlay = document.getElementById('firebase-loading-overlay');
        if (loadingOverlay) loadingOverlay.style.display = 'none';
        const loginOverlay = document.getElementById('login-overlay');
        if (loginOverlay) loginOverlay.style.display = 'flex';
        return;
    }

    window.firebase.onAuthStateChanged(window.firebaseAuth, async (user) => {
        // Always hide the loading overlay once Firebase responds
        const loadingOverlay = document.getElementById('firebase-loading-overlay');
        if (loadingOverlay) loadingOverlay.style.display = 'none';

        if (user) {
            console.log('üë§ User authenticated:', user.email);
            
            // Load displayName from Firestore
            let displayName = user.email; // Default to email
            try {
                const userDocRef = window.firebase.doc(window.firebaseDb, 'users', user.uid);
                const userDocSnap = await window.firebase.getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    displayName = userData.displayName || user.email;
                    console.log('‚úÖ Loaded display name:', displayName);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not load display name, using email');
            }
            
            state.currentUser = { 
                email: user.email, 
                uid: user.uid,
                displayName: displayName 
            };
            state.isLoggedIn = true;

            // ==================== INITIALIZE USER ROLE & REGION ====================
            const userInfo = UserAccounts.getUserInfo(user.email);
            state.userRole = userInfo.role;
            state.userRegion = userInfo.region;
            state.userColor = userInfo.color;
            state.isAdmin = userInfo.role === 'admin';
            
            console.log(`üé≠ Role: ${state.userRole} | Region: ${state.userRegion}`);
            
            // ==================== GENERATE DEVICE FINGERPRINT ====================
            if (!state.deviceFingerprint) {
                state.deviceFingerprint = await DeviceFingerprint.generate();
                console.log('üîë Device fingerprint generated');
            }

            // Hide login, show main UI
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';

            // Update user badge with role
            const userBadge = document.getElementById('user-badge');
            if (userBadge) {
                let roleIcon = 'fa-user-tie';
                if (state.isAdmin) roleIcon = 'fa-user-shield';
                else if (userInfo.role === 'pco') roleIcon = 'fa-leaf';
                // Use custom displayName if available, otherwise use default role name
                const roleLabel = state.currentUser.displayName || (state.isAdmin ? 'ESH Admin' : userInfo.displayName);
                
                // Only update the name part, not the whole innerHTML to preserve dropdown
                const nameDiv = userBadge.querySelector('.name');
                if (nameDiv) {
                    nameDiv.innerHTML = `
                        <i class="fas ${roleIcon}"></i>
                        ${roleLabel}
                    `;
                }
                
                // Show admin menu in user profile dropdown if admin
                if (state.isAdmin) {
                    console.log('üõ°Ô∏è Admin badge active');
                }
                // Show PCO restriction notice
                if (userInfo.role === 'pco') {
                    setTimeout(() => {
                        showToast(`üåø PCO Access: You can only edit Environmental Permits & EMB Reportorial for ${userInfo.region} region.`, 'info');
                    }, 2000);
                }
            }

            // Update user-email field (settings page)
            const userEmailEl = document.getElementById('user-email');
            if (userEmailEl) {
                userEmailEl.textContent = user.email;
            }

            // Show dashboard UI
            showUI();
            initDarkMode();
            initializeYears(); // Initialize year selector

            // Show flash reminder screen IMMEDIATELY on fresh login (before any async ops)
            const _isFirstLogin = !sessionStorage.getItem('esh_login_logged_' + user.uid);
            if (_isFirstLogin) {
                const flashName = state.currentUser.displayName || user.email.split('@')[0];
                showLoginFlash(flashName);
            }

            // Load user data with year-based filtering
            await loadAllProjectsAndFilter();
            
            // üîä Play login sound
            playLoginSound();
            
            // ==================== INITIALIZE NEW SYSTEMS ====================
            // Initialize Offline Mode Management
            OfflineManager.init();
            
            // Initialize Lazy Loading
            LazyLoader.init();
            
            // Note: AdminSystem.checkAdminAccess() removed - now using UserAccounts system
            // state.isAdmin already set correctly by UserAccounts.getUserInfo()
            
            // Show admin menu in user profile dropdown if admin
            if (state.isAdmin) {
                console.log('üõ°Ô∏è Admin access granted');
            } else {
                // Hide settings tab for superintendents
                const settingsTab = document.querySelector('[onclick*="settings"]');
                if (settingsTab) {
                    settingsTab.style.display = 'none';
                }
                console.log('üëî Superintendent access - restricted mode');
            }
            
            // Initialize presence tracking
            await PresenceTracker.initialize(user.uid, user.email);
            console.log('üü¢ Presence tracking active');
            
            // Show admin UI elements (device counter & active users)
            if (state.isAdmin) {
                // Start real-time logbook listener immediately
                loadLogbookFromFirebase();
                // Small delay to ensure Firebase listeners are ready
                setTimeout(() => {
                    PresenceTracker.updateDeviceCounterUI();
                    PresenceTracker.updateActiveUsersUI();
                }, 500);
            }
            
            // Log login to logbook with IP and location
            // Guard: only log once per session (not on every page refresh)
            if (_isFirstLogin) {
                sessionStorage.setItem('esh_login_logged_' + user.uid, '1');
                await LoginLogbook.logLogin(user);
            }
            
            // Log user login in audit trail
            AuditLogger.log('USER_LOGIN', { 
                email: user.email, 
                role: state.userRole,
                region: state.userRegion,
                timestamp: new Date().toISOString(),
                isAdmin: state.isAdmin,
                deviceId: state.deviceFingerprint
            });
            
            // Start ESH Calendar real-time sync so plan changes are visible to all accounts instantly
            startEshCalendarSync();
            
            console.log('‚úÖ All systems initialized successfully!');
            // ==================== END NEW SYSTEMS ====================


        } else {
            console.log('üë§ No user authenticated ‚Äî showing login screen');
            
            // Cleanup presence tracking
            if (state.currentUser) {
                PresenceTracker.cleanup();
            }
            
            state.currentUser = null;
            state.isLoggedIn = false;
            state.userRole = null;
            state.userRegion = null;
            state.isAdmin = false;

            // Show login overlay
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'flex';

            // Hide main UI
            const sidebar = document.getElementById('main-sidebar');
            const content = document.getElementById('main-content');
            if (sidebar) sidebar.classList.add('hidden');
            if (content) content.classList.add('hidden');

            // Reset login button state if it got stuck
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }
        }
    });
}

// CRITICAL FIX: saveUserData now saves to BOTH localStorage AND Firebase
// so data is never lost on refresh
const originalSaveUserData = window.saveUserData || function() {};

window.saveUserData = function(email) {
    // Save to localStorage only ‚Äî Firebase is called explicitly after this
    // to avoid double-save race conditions
    originalSaveUserData(email);
};

// Initialize Firebase Integration
waitForFirebase().then(async () => {
    console.log('üî• Firebase Ready! (OPTIMIZED MODE)');
    
    // Setup auth observer ‚Äî handles login state, UI show/hide, and data loading
    setupAuthObserver();
    
    // Setup inactivity auto-logout
    setupInactivityTimer();
});

// ==================== AUTO-LOGOUT AFTER INACTIVITY ====================
let inactivityTimer = null;
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

function setupInactivityTimer() {
    console.log('‚è∞ Inactivity timer initialized (30 minutes)');
    
    // Events that indicate user activity
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    
    // Reset the timer on any user activity
    function resetAutoLogoutTimer() {
        // Only track if user is logged in
        if (!state.isLoggedIn) return;
        
        // Clear existing timer
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }
        
        // Set new timer
        inactivityTimer = setTimeout(() => {
            handleInactivityLogout();
        }, INACTIVITY_TIMEOUT);
    }
    
    // Handle logout due to inactivity
    async function handleInactivityLogout() {
        console.log('‚è∞ User inactive for 30 minutes - logging out...');
        
        // Show warning
        showToast('‚è∞ You have been logged out due to inactivity (30 minutes)', 'warning');
        
        // Wait a moment for the toast to show
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Perform logout
        if (window.firebaseAuth) {
            try {
                await window.firebase.signOut(window.firebaseAuth);
                console.log('‚úÖ Auto-logout successful');
            } catch (error) {
                console.error('‚ùå Error during auto-logout:', error);
            }
        }
    }
    
    // Attach event listeners
    activityEvents.forEach(event => {
        document.addEventListener(event, resetAutoLogoutTimer, true);
    });
    
    // Start the initial timer
    resetAutoLogoutTimer();
}

// Cleanup presence when page is closed or refreshed
window.addEventListener('beforeunload', () => {
    // Note: async/await doesn't work in beforeunload ‚Äî browser won't wait for promises.
    // onDisconnect (set up at login) handles this server-side reliably via Firebase.
    // cleanup() is called here as a best-effort attempt for faster cleanup.
    if (state.currentUser && state.currentUser.uid) {
        PresenceTracker.cleanup(); // fire-and-forget is fine here ‚Äî onDisconnect is the real safety net
    }
});

console.log('üî• Firebase integration loaded - OPTIMIZED: Save button only!');

// ==================== MOBILE MENU FUNCTIONALITY ====================
// Absolute fallback: hide loading overlay after 7s no matter what
setTimeout(function() {
    const lo = document.getElementById('firebase-loading-overlay');
    if (lo && lo.style.display !== 'none') {
        lo.style.display = 'none';
        const loginOverlay = document.getElementById('login-overlay');
        if (loginOverlay && loginOverlay.style.display !== 'none') {
            loginOverlay.style.display = 'flex';
        } else if (loginOverlay) {
            loginOverlay.style.display = 'flex';
        }
        console.warn('üö® Loading overlay force-closed after timeout');
    }
}, 7000);

// Restore navigation states on load
document.addEventListener('DOMContentLoaded', function() {
    // Restore navigation group collapse states
    restoreNavGroupStates();
    
    // PREVENT NEGATIVE NUMBERS IN ALL NUMBER INPUTS
    document.addEventListener('keydown', function(e) {
        // Check if the target is a number input
        if (e.target.type === 'number') {
            // Prevent minus sign (-), plus sign (+), and 'e' (scientific notation)
            if (e.key === '-' || e.key === '+' || e.key === 'e' || e.key === 'E') {
                e.preventDefault();
                showToast('‚ö†Ô∏è Only positive numbers are allowed', 'warning');
            }
        }
    });
    
    // ALSO PREVENT PASTE OF NEGATIVE NUMBERS
    document.addEventListener('paste', function(e) {
        if (e.target.type === 'number') {
            const pasteData = e.clipboardData.getData('text');
            const number = parseFloat(pasteData);
            if (number < 0) {
                e.preventDefault();
                showToast('‚ö†Ô∏è Cannot paste negative numbers', 'warning');
            }
        }
    });
    
    // ALSO VALIDATE ON INPUT CHANGE
    document.addEventListener('input', function(e) {
        if (e.target.type === 'number') {
            const value = parseFloat(e.target.value);
            if (value < 0) {
                e.target.value = '';
                showToast('‚ö†Ô∏è Negative numbers are not allowed', 'warning');
            }
        }
    });
});

// ==================== AUDIO CONTEXT INITIALIZATION ====================
// Create global AudioContext for sound effects (needed for browser autoplay policies)
let globalAudioContext = null;
let audioContextReady = false;

function initAudioContext() {
    if (!globalAudioContext) {
        try {
            globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('üîä AudioContext initialized');
        } catch (e) {
            console.warn('Could not initialize AudioContext:', e);
            return null;
        }
    }
    
    // Resume AudioContext if suspended (required by browsers)
    if (globalAudioContext && globalAudioContext.state === 'suspended') {
        globalAudioContext.resume().then(() => {
            console.log('üîä AudioContext resumed');
            audioContextReady = true;
        }).catch(err => {
            console.warn('Could not resume AudioContext:', err);
        });
    } else if (globalAudioContext && globalAudioContext.state === 'running') {
        audioContextReady = true;
    }
    
    return globalAudioContext;
}

// Initialize on first user interaction
document.addEventListener('click', initAudioContext, { once: true });
document.addEventListener('keydown', initAudioContext, { once: true });
document.addEventListener('touchstart', initAudioContext, { once: true });

// ==================== SAFETY REMINDER SYSTEM ====================
// Load work start time from localStorage or initialize
let workStartTime = parseInt(localStorage.getItem('workStartTime')) || Date.now();
// Save to localStorage
localStorage.setItem('workStartTime', workStartTime);

let timerInterval = null;
let reminderTimeout = null;
let currentReminderType = null;
let soundInterval = null; // For looping sound

// Reminder configurations (in milliseconds)
const REMINDERS = {
    EYES_20: {
        interval: 20 * 60 * 1000, // 20 minutes
        icon: 'üëÄ',
        title: '20-20-20 Rule',
        text: 'Tumingin sa malayo (20 feet) sa loob ng 20 segundo para maiwasan ang eye strain!',
        sound: true
    },
    MICRO_BREAK: {
        interval: 60 * 60 * 1000, // 1 hour
        icon: 'üßò',
        title: 'Micro Break Time',
        text: 'Tumayo, mag-unat ng likod at balikat, at maglakad kahit ilang hakbang lang para iwas stiff muscles!',
        sound: true
    },
    LONG_BREAK: {
        interval: 2 * 60 * 60 * 1000, // 2 hours
        icon: '‚òï',
        title: 'Longer Break Time',
        text: 'Mag-break ng 10-15 minuto. Lumayo sa workstation, uminom ng tubig, at huwag mag-cellphone!',
        sound: true
    },
    EXTENDED_BREAK: {
        interval: 3 * 60 * 60 * 1000, // 3 hours
        icon: 'üå≥',
        title: 'Extended Break',
        text: 'Maglakad-lakad sa labas, huminga ng fresh air, at mag-relax. Importante ang kalusugan mo!',
        sound: true
    }
};

// Update timer display (no visual display, but keeps timer running for reminders)
function updateTimerDisplay() {
    // Timer runs silently in background for reminder calculations
    // No visual display needed
}

// Determine which reminder to show based on elapsed time
function getAppropriateReminder() {
    const elapsed = Date.now() - workStartTime;
    
    // Check in reverse order (longest to shortest) to show the most relevant reminder
    if (elapsed >= REMINDERS.EXTENDED_BREAK.interval && elapsed % REMINDERS.EXTENDED_BREAK.interval < 60000) {
        return 'EXTENDED_BREAK';
    } else if (elapsed >= REMINDERS.LONG_BREAK.interval && elapsed % REMINDERS.LONG_BREAK.interval < 60000) {
        return 'LONG_BREAK';
    } else if (elapsed >= REMINDERS.MICRO_BREAK.interval && elapsed % REMINDERS.MICRO_BREAK.interval < 60000) {
        return 'MICRO_BREAK';
    } else if (elapsed >= REMINDERS.EYES_20.interval && elapsed % REMINDERS.EYES_20.interval < 60000) {
        return 'EYES_20';
    }
    
    return null;
}

// Show reminder
function showReminder(type) {
    if (!REMINDERS[type]) return;
    
    const reminder = REMINDERS[type];
    const container = document.getElementById('safety-reminder-container');
    const iconEl = document.getElementById('reminder-icon');
    const titleEl = document.getElementById('reminder-title');
    const textEl = document.getElementById('reminder-text');
    
    if (!container || !iconEl || !titleEl || !textEl) return;
    
    // Update content
    iconEl.textContent = reminder.icon;
    titleEl.textContent = reminder.title;
    textEl.textContent = reminder.text;
    
    // Show the reminder with animation
    container.classList.add('show');
    currentReminderType = type;
    
    // Play sound notification (simple beep using Web Audio API)
    if (reminder.sound) {
        playNotificationSound();
    }
    
    // Auto-dismiss after 30 seconds if not manually dismissed
    if (reminderTimeout) {
        clearTimeout(reminderTimeout);
    }
    reminderTimeout = setTimeout(() => {
        dismissReminder();
    }, 30000);
    
    console.log(`üîî Reminder shown: ${reminder.title}`);
}

// Dismiss reminder
function dismissReminder() {
    const container = document.getElementById('safety-reminder-container');
    if (container) {
        container.classList.remove('show');
    }
    currentReminderType = null;
    
    // Stop the looping sound
    stopNotificationSound();
    
    if (reminderTimeout) {
        clearTimeout(reminderTimeout);
        reminderTimeout = null;
    }
}

// Play notification sound - loops continuously
function playNotificationSound() {
    // Clear any existing sound interval
    if (soundInterval) {
        clearInterval(soundInterval);
    }
    
    // Function to play one beep based on reminder type
    function playBeep() {
        try {
            // Don't call initAudioContext() - just check if it exists and is ready
            if (!globalAudioContext || !audioContextReady) {
                console.log('üîá Reminder sound skipped (AudioContext not ready)');
                return;
            }
            
            // Play different sounds based on reminder type
            if (currentReminderType === 'EYES_20') {
                // Option 2: Gentle Chime - C-E-G notes
                playNote(globalAudioContext, 523, 0.2, 0.25, 0.01, 0.15); // C
                setTimeout(() => playNote(globalAudioContext, 659, 0.2, 0.25, 0.01, 0.15), 150); // E
                setTimeout(() => playNote(globalAudioContext, 784, 0.3, 0.25, 0.01, 0.2), 300); // G
            } else if (currentReminderType === 'MICRO_BREAK') {
                // Option 1: Rising Melody - Do-Re-Mi-Fa-Sol
                playNote(globalAudioContext, 523, 0.15, 0.3, 0.01, 0.1); // C
                setTimeout(() => playNote(globalAudioContext, 587, 0.15, 0.3, 0.01, 0.1), 120); // D
                setTimeout(() => playNote(globalAudioContext, 659, 0.15, 0.3, 0.01, 0.1), 240); // E
                setTimeout(() => playNote(globalAudioContext, 698, 0.15, 0.3, 0.01, 0.1), 360); // F
                setTimeout(() => playNote(globalAudioContext, 784, 0.25, 0.4, 0.01, 0.15), 480); // G
            } else if (currentReminderType === 'LONG_BREAK') {
                // Option 2: Alarm Clock - 4 repeating beeps
                playNote(globalAudioContext, 1047, 0.2, 0.45, 0.01, 0.15);
                setTimeout(() => playNote(globalAudioContext, 1047, 0.2, 0.45, 0.01, 0.15), 250);
                setTimeout(() => playNote(globalAudioContext, 1047, 0.2, 0.45, 0.01, 0.15), 500);
                setTimeout(() => playNote(globalAudioContext, 1047, 0.3, 0.5, 0.01, 0.2), 750);
            } else if (currentReminderType === 'EXTENDED_BREAK') {
                // Option 1: Emergency Alert - alternating high-low siren
                playNote(globalAudioContext, 880, 0.3, 0.5, 0.01, 0.2);
                setTimeout(() => playNote(globalAudioContext, 660, 0.3, 0.5, 0.01, 0.2), 350);
                setTimeout(() => playNote(globalAudioContext, 880, 0.3, 0.5, 0.01, 0.2), 700);
                setTimeout(() => playNote(globalAudioContext, 660, 0.3, 0.5, 0.01, 0.2), 1050);
            }
        } catch (e) {
            console.warn('Could not play notification sound:', e);
        }
    }
    
    // Helper function to play a single note

    
    // Play first beep immediately
    playBeep();
    
    // Then repeat every 2 seconds
    soundInterval = setInterval(() => {
        playBeep();
    }, 2000);
}

// Stop notification sound
function stopNotificationSound() {
    if (soundInterval) {
        clearInterval(soundInterval);
        soundInterval = null;
    }
}

// ==================== EXPORT TO PDF FUNCTIONALITY ====================

// ==================== EXPORT FUNCTIONS (PDF + EXCEL) ====================

// ---- Shared: collect export data for current tab ----
function getExportData() {
    const tabName  = state.currentTab || 'overall';
    const year     = state.selectedYear || new Date().getFullYear();

    // Region order + color map
    const REGION_ORDER = ['NCR', 'NORTH LUZON', 'SOUTH LUZON', 'VISAYAS & MINDANAO'];
    const REGION_COLORS_HEX = {
        'NCR':                  { header: '1565C0', light: 'E3F2FD' },
        'NORTH LUZON':          { header: '2E7D32', light: 'E8F5E9' },
        'SOUTH LUZON':          { header: 'E65100', light: 'FFF3E0' },
        'VISAYAS & MINDANAO':   { header: '6A1B9A', light: 'F3E5F5' },
    };

    const tabTitles = {
        overall: 'OVERALL SUMMARY',
        exposures: 'TOTAL EXPOSURES',
        medical: 'ACCIDENT / INCIDENT RECORD',
        activities: 'ESH ACTIVITIES & PROGRAMS',
        audit: 'INTERNAL ESH AUDIT RESULT',
        nov: 'REGULATORY ISSUED NOV',
        'nov-monitoring': 'ESH NOV MONITORING',
        rates: 'STATISTICS RATE',
        personnel: 'ESH PERSONNEL MONITORING',
        kpm: 'MONTHLY REPORT (KPM)',
        dole: 'DOLE REPORTORIAL',
        emb: 'EMB REPORTORIAL',
        doe: 'DOE REPORTORIAL',
        'doe-permit': 'DOE SAFETY OFFICER PERMIT',
        permits: 'ENVIRONMENTAL PERMITS / LICENSES / CLEARANCE',
        cshp: 'CSHP',
        reg: 'CERTIFICATE OF REGISTRATION',
        'env-monthly-report': 'ENVIRONMENTAL MONTHLY REPORT',
    };

    const title = tabTitles[tabName] || 'ESH COMPLIANCE REPORT';

    // Sort projects: by region order, then alphabetically within region
    const rawProjects = [...(state.projects || [])];
    rawProjects.sort((a, b) => {
        const ri = REGION_ORDER.indexOf((a.region||'').toUpperCase());
        const rj = REGION_ORDER.indexOf((b.region||'').toUpperCase());
        const regionDiff = (ri < 0 ? 99 : ri) - (rj < 0 ? 99 : rj);
        if (regionDiff !== 0) return regionDiff;
        return (a.name||'').localeCompare(b.name||'');
    });

    let headers = [], rows = [];
    // rowMeta carries per-row metadata for PDF region grouping
    let rowMeta = []; // { region, isGroupHeader }

    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    // Helper: group projects by region, sorted alpha within
    function groupedRows(buildRow) {
        let result = [];
        let meta = [];
        REGION_ORDER.forEach(region => {
            const regionProjects = rawProjects.filter(p => (p.region||'').toUpperCase() === region);
            if (!regionProjects.length) return;
            regionProjects.forEach((p, pi) => {
                result.push(buildRow(p, pi));
                meta.push({ region });
            });
        });
        return { result, meta };
    }

    if (tabName === 'personnel') {
        headers = ['#','Full Name','Position','ID No.','Date Hired','Assignment','Age','Gender','Email','Contact No.','Address','Yrs of Svc'];
        rows = (state.personnelData || []).map((p, i) => [
            i+1, p.name||'', p.pos||'', p.id||'', p.hired||'',
            p.current||'', p.age||'', p.gen||'',
            p.mail||'', p.num||'', p.addr||'', p.len||''
        ]);

    } else if (tabName === 'overall') {
        headers = ['#','Project Name','Region','Date Started','Status','Completion %'];
        const { result, meta } = groupedRows((p, pi) => [
            pi+1, p.name||'', p.region||'', p.start||'',
            p.status||'On-going', (getPerc(p)||0)+'%'
        ]);
        rows = result; rowMeta = meta;

    } else if (tabName === 'rates') {
        headers = ['#','Project Name','Region','TRIR','LTIR','Severity Rate'];
        const { result, meta } = groupedRows((p, pi) => [
            pi+1, p.name||'', p.region||'',
            p.vals?.['rates_TRIR']?.[1]||'‚Äî',
            p.vals?.['rates_LTIR']?.[1]||'‚Äî',
            p.vals?.['rates_Severity Rate']?.[1]||'‚Äî'
        ]);
        rows = result; rowMeta = meta;

    } else if (tabName === 'audit') {
        headers = ['#','Project Name','Region',
            'Q1 Score Impl.','Q1 Doc Comp.',
            'Q2 Score Impl.','Q2 Doc Comp.',
            'Q3 Score Impl.','Q3 Doc Comp.',
            'Q4 Score Impl.','Q4 Doc Comp.'];
        const { result, meta } = groupedRows((p, pi) => {
            const a = p.audit || {};
            return [
                pi+1, p.name||'', p.region||'',
                a.Q1?.scoreImpl||'‚Äî', a.Q1?.docuComp||'‚Äî',
                a.Q2?.scoreImpl||'‚Äî', a.Q2?.docuComp||'‚Äî',
                a.Q3?.scoreImpl||'‚Äî', a.Q3?.docuComp||'‚Äî',
                a.Q4?.scoreImpl||'‚Äî', a.Q4?.docuComp||'‚Äî'
            ];
        });
        rows = result; rowMeta = meta;

    } else if (tabName === 'doe-permit') {
        headers = ['#','Project Name','Region','Permit No.','Valid Until','PDF Status'];
        const { result, meta } = groupedRows((p, pi) => {
            const v = p.vals?.['doe-permit_DOE Safety Officer Permit'] || {};
            return [ pi+1, p.name||'', p.region||'', v[1]||'‚Äî', v[2]||'‚Äî', v[3]?'Uploaded':'No PDF' ];
        });
        rows = result; rowMeta = meta;

    } else if (tabName === 'doe') {
        headers = ['#','Project Name','Region','Q1','Q2','Q3','Q4'];
        const doePrj = rawProjects.filter(p => p.isRenewable);
        doePrj.forEach((p, pi) => {
            const df = p.doePdfFiles || {};
            rows.push([ pi+1, p.name||'', p.region||'',
                df.Q1?'Uploaded':'Pending', df.Q2?'Uploaded':'Pending',
                df.Q3?'Uploaded':'Pending', df.Q4?'Uploaded':'Pending' ]);
            rowMeta.push({ region: p.region||'' });
        });

    } else if (tabName === 'nov-monitoring') {
        headers = ['#','Project Name','Region','NOV Reference','Date Issued','Agency','Status','Remarks'];
        rawProjects.forEach((p, pi) => {
            (p.novMonitoring || []).forEach(nov => {
                rows.push([ pi+1, p.name||'', p.region||'',
                    nov.ref||'', nov.date||'', nov.agency||'', nov.status||'', nov.remarks||'' ]);
                rowMeta.push({ region: p.region||'' });
            });
        });
        if (!rows.length) {
            const { result, meta } = groupedRows((p, pi) => [pi+1, p.name||'', p.region||'','No NOV records','','','','']);
            rows = result; rowMeta = meta;
        }

    } else if (SCHEMA && SCHEMA[tabName]) {
        const schema = SCHEMA[tabName];
        const isMonthly = ['kpm','dole','emb','exposures','activities','medical','nov','env-monthly-report'].includes(tabName);
        if (isMonthly) {
            headers = ['#','Project Name','Region','Category',...months,'Annual Total'];
        } else {
            headers = ['#','Project Name','Region','Category','Value / Date','Ref No. / Status'];
        }
        rawProjects.forEach((p, pi) => {
            schema.forEach(row => {
                const key = `${tabName}_${row}`;
                const vals = p.vals?.[key] || {};
                if (isMonthly) {
                    const monthVals = months.map((_,mi) => vals[mi+1]||'');
                    const nonEmpty = monthVals.filter(v => v !== '');
                    const total = nonEmpty.length
                        ? (nonEmpty.every(v => !isNaN(Number(v)))
                            ? nonEmpty.reduce((a,b)=>a+Number(b),0)
                            : nonEmpty[nonEmpty.length-1])
                        : '‚Äî';
                    rows.push([ pi+1, p.name||'', p.region||'', row, ...monthVals, total ]);
                } else {
                    rows.push([ pi+1, p.name||'', p.region||'', row, vals[1]||'‚Äî', vals[2]||'‚Äî' ]);
                }
                rowMeta.push({ region: p.region||'' });
            });
        });

    } else {
        const table = document.querySelector('#dashboard-content table');
        if (table) {
            table.querySelectorAll('thead th').forEach(th => headers.push(th.textContent.trim().replace(/\s+/g,' ')));
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    const inp = td.querySelector('input,select,textarea');
                    row.push(inp ? inp.value||'' : td.textContent.trim().replace(/\s+/g,' ').replace(/(Edit|Save|Delete|Cancel|View|Upload)/gi,'').trim());
                });
                if (row.some(c=>c!=='')) rows.push(row);
            });
        }
        if (!headers.length) {
            headers = ['#','Project Name','Region','Status'];
            const { result, meta } = groupedRows((p, pi) => [pi+1, p.name||'', p.region||'', p.status||'']);
            rows = result; rowMeta = meta;
        }
    }

    return { title, tabName, year, headers, rows, rowMeta, REGION_ORDER, REGION_COLORS_HEX };
}

// ---- PDF EXPORT ----
async function exportCurrentTabToPDF() {
    showToast('üìÑ Generating PDF...', 'info');
    try {
        const { jsPDF } = window.jspdf;
        const { title, tabName, year, headers, rows, rowMeta, REGION_ORDER, REGION_COLORS_HEX } = getExportData();
        const filename = `ESH_${tabName.toUpperCase()}_${year}_${new Date().toISOString().split('T')[0]}.pdf`;
        const isWide = headers.length > 8;
        const doc = new jsPDF({ orientation: isWide ? 'landscape' : 'portrait', unit: 'mm', format: 'a4' });

        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const M = 12; // margin

        // ‚îÄ‚îÄ‚îÄ COVER HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Dark green top bar
        doc.setFillColor(13, 61, 15);
        doc.rect(0, 0, pageW, 32, 'F');
        // Accent stripe
        doc.setFillColor(251, 192, 45);
        doc.rect(0, 32, pageW, 1.5, 'F');

        // Company name
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.text('STA. CLARA INTERNATIONAL CORPORATION', pageW / 2, 10, { align: 'center' });

        // Report title
        doc.setFontSize(15);
        doc.setTextColor(251, 192, 45);
        doc.text(title, pageW / 2, 20, { align: 'center' });

        // Sub info
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(180, 230, 180);
        const genDate = new Date().toLocaleDateString('en-PH', { year:'numeric', month:'long', day:'numeric' });
        const genTime = new Date().toLocaleTimeString('en-PH', { hour:'2-digit', minute:'2-digit' });
        doc.text(
            `Fiscal Year: ${year}   ‚Ä¢   Generated: ${genDate} ${genTime}   ‚Ä¢   Total Projects: ${rows.length > 0 ? (state.projects||[]).length : 0}`,
            pageW / 2, 28, { align: 'center' }
        );

        // ‚îÄ‚îÄ‚îÄ REGION LEGEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let legendY = 38;
        const hasRegions = rowMeta.length > 0;
        if (hasRegions) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(7);
            doc.setTextColor(60, 60, 60);
            doc.text('REGION LEGEND:', M, legendY);
            let lx = M + 28;
            REGION_ORDER.forEach(r => {
                const col = REGION_COLORS_HEX[r];
                if (!col) return;
                const [rr, gg, bb] = [parseInt(col.header.slice(0,2),16), parseInt(col.header.slice(2,4),16), parseInt(col.header.slice(4,6),16)];
                doc.setFillColor(rr, gg, bb);
                doc.roundedRect(lx, legendY - 3.5, 3.5, 3.5, 0.5, 0.5, 'F');
                doc.setTextColor(60, 60, 60);
                doc.setFont('helvetica', 'normal');
                doc.text(r, lx + 5, legendY);
                lx += doc.getTextWidth(r) + 12;
            });
            legendY += 5;
        }

        // ‚îÄ‚îÄ‚îÄ GROUP by REGION then render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const tableStartY = hasRegions ? legendY + 2 : 38;
        const fontSize = rows.length > 100 ? 5.5 : rows.length > 50 ? 6 : 7;
        const headFontSize = fontSize + 0.5;

        // Build body with region-color styling per row
        const bodyWithStyle = rows.map((r, i) => r.map(v => String(v === null || v === undefined ? '' : v)));

        // didParseCell for region row coloring
        const regionCellColors = {}; // key: "row_col" ‚Üí fillColor
        rows.forEach((_, ri) => {
            const meta = rowMeta[ri];
            if (!meta) return;
            const col = REGION_COLORS_HEX[(meta.region||'').toUpperCase()];
            if (col && ri > 0 && rowMeta[ri - 1]?.region !== meta.region) {
                regionCellColors[`${ri}_group`] = col.header; // first row of new region
            }
        });

        // Track current region for coloring
        let lastRegionPDF = null;
        doc.autoTable({
            startY: tableStartY,
            head: [headers],
            body: bodyWithStyle,
            theme: 'grid',
            styles: {
                fontSize,
                cellPadding: { top: 2, right: 2.5, bottom: 2, left: 2.5 },
                lineColor: [220, 220, 220],
                lineWidth: 0.15,
                overflow: 'linebreak',
                valign: 'middle',
                textColor: [25, 25, 25],
                font: 'helvetica',
            },
            headStyles: {
                fillColor: [13, 61, 15],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: headFontSize,
                halign: 'center',
                valign: 'middle',
                minCellHeight: 8,
            },
            columnStyles: (() => {
                // Auto-fit: measure content
                const usableW = pageW - M * 2;
                const colW = headers.map((h, ci) => {
                    let max = String(h).length;
                    rows.forEach(r => { const l = String(r[ci]||'').length; if(l > max) max = l; });
                    return Math.min(Math.max(max * 1.6, 10), 55);
                });
                const total = colW.reduce((a,b)=>a+b,0);
                const scale = total > usableW ? usableW / total : 1;
                const styles = {};
                colW.forEach((w, i) => { styles[i] = { cellWidth: w * scale }; });
                return styles;
            })(),
            didParseCell: (data) => {
                if (data.section !== 'body') return;
                const meta = rowMeta[data.row.index];
                if (!meta) return;
                const region = (meta.region || '').toUpperCase();
                const col = REGION_COLORS_HEX[region];
                if (!col) return;

                // Alternate shading within same region
                const prevMeta = rowMeta[data.row.index - 1];
                const prevRegion = prevMeta ? (prevMeta.region||'').toUpperCase() : null;
                const isNewRegion = region !== prevRegion;

                const [lr, lg, lb] = [parseInt(col.light.slice(0,2),16), parseInt(col.light.slice(2,4),16), parseInt(col.light.slice(4,6),16)];
                const [lr2, lg2, lb2] = [Math.min(lr+12,255), Math.min(lg+12,255), Math.min(lb+12,255)];

                // Slightly darker alt rows within region
                const withinRegionIdx = (() => {
                    let idx = 0;
                    for (let ri = data.row.index - 1; ri >= 0; ri--) {
                        if ((rowMeta[ri]?.region||'').toUpperCase() !== region) break;
                        idx++;
                    }
                    return idx;
                })();

                data.cell.styles.fillColor = withinRegionIdx % 2 === 0 ? [lr,lg,lb] : [lr2,lg2,lb2];

                // Bold project name column (col 1) and region (col 2)
                if (data.column.index <= 2) {
                    data.cell.styles.fontStyle = 'bold';
                    if (data.column.index === 1 || data.column.index === 2) {
                        const [rr, gg, bb] = [parseInt(col.header.slice(0,2),16), parseInt(col.header.slice(2,4),16), parseInt(col.header.slice(4,6),16)];
                        data.cell.styles.textColor = [rr, gg, bb];
                    }
                }
            },
            willDrawCell: (data) => {
                if (data.section !== 'body') return;
                const meta = rowMeta[data.row.index];
                if (!meta) return;
                const region = (meta.region||'').toUpperCase();
                const prevMeta = rowMeta[data.row.index - 1];
                const prevRegion = prevMeta ? (prevMeta.region||'').toUpperCase() : null;

                // Draw thick top border at region boundary
                if (region !== prevRegion && data.column.index === 0) {
                    const col = REGION_COLORS_HEX[region];
                    if (col) {
                        const x1 = data.cell.x;
                        const y1 = data.cell.y;
                        const tableWidth = (data.table && typeof data.table.width === 'number' && data.table.width > 0)
                            ? data.table.width
                            : (pageW - M * 2);
                        const x2 = x1 + tableWidth;
                        const y2 = y1;
                        // Guard: only draw if all coordinates are finite numbers
                        if (isFinite(x1) && isFinite(y1) && isFinite(x2) && isFinite(y2)) {
                            const [rr, gg, bb] = [parseInt(col.header.slice(0,2),16), parseInt(col.header.slice(2,4),16), parseInt(col.header.slice(4,6),16)];
                            doc.setDrawColor(rr, gg, bb);
                            doc.setLineWidth(0.6);
                            doc.line(x1, y1, x2, y2);
                            doc.setLineWidth(0.15);
                            doc.setDrawColor(220, 220, 220);
                        }
                    }
                }
            },
            didDrawPage: (data) => {
                const pg = doc.internal.getCurrentPageInfo().pageNumber;
                // Continuation header
                if (pg > 1) {
                    doc.setFillColor(13, 61, 15);
                    doc.rect(0, 0, pageW, 12, 'F');
                    doc.setFillColor(251, 192, 45);
                    doc.rect(0, 12, pageW, 0.8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.text(`${title}  ‚Äî  Year ${year}  (continued)`, pageW / 2, 8.5, { align: 'center' });
                }
                // Footer
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6.5);
                doc.setTextColor(150, 150, 150);
                doc.text('ESH Compliance Dashboard  ‚Ä¢  STA. CLARA INTERNATIONAL CORPORATION  ‚Ä¢  CONFIDENTIAL', M, pageH - 5);
                doc.setTextColor(80, 80, 80);
                doc.setFont('helvetica', 'bold');
                doc.text(`Page ${pg}`, pageW - M, pageH - 5, { align: 'right' });
            },
            margin: { left: M, right: M, top: hasRegions ? legendY + 4 : 38, bottom: 12 },
        });

        if (typeof doc.putTotalPages === 'function') doc.putTotalPages('{total_pages_count_string}');
        doc.save(filename);
        showToast('‚úÖ PDF exported!', 'success');
    } catch(err) {
        console.error('PDF error:', err);
        showToast('‚ùå PDF export failed: ' + err.message, 'error');
    }
}

// ---- EXCEL EXPORT ----
async function exportCurrentTabToExcel() {
    showToast('üìä Generating Excel file...', 'info');
    try {
        if (!window.XLSX) { showToast('‚ùå Excel library not loaded. Try again.', 'error'); return; }
        const { title, tabName, year, headers, rows, rowMeta, REGION_ORDER, REGION_COLORS_HEX } = getExportData();
        const filename = `ESH_${tabName.toUpperCase()}_${year}_${new Date().toISOString().split('T')[0]}.xlsx`;
        const wb = XLSX.utils.book_new();

        const colCount = headers.length;
        const encode = (r, c) => XLSX.utils.encode_cell({ r, c });

        // ‚îÄ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const S = {
            company: {
                font: { bold: true, sz: 13, color: { rgb: 'FFFFFF' }, name: 'Calibri' },
                fill: { fgColor: { rgb: '0D3D0F' } },
                alignment: { horizontal: 'center', vertical: 'center' },
            },
            reportTitle: {
                font: { bold: true, sz: 14, color: { rgb: 'FBC02D' }, name: 'Calibri' },
                fill: { fgColor: { rgb: '0D3D0F' } },
                alignment: { horizontal: 'center', vertical: 'center' },
            },
            meta: {
                font: { italic: true, sz: 9, color: { rgb: '555555' }, name: 'Calibri' },
                fill: { fgColor: { rgb: 'E8F5E9' } },
                alignment: { horizontal: 'center', vertical: 'center' },
            },
            blank: {
                fill: { fgColor: { rgb: 'F5F5F5' } },
            },
            colHeader: {
                font: { bold: true, sz: 10, color: { rgb: 'FFFFFF' }, name: 'Calibri' },
                fill: { fgColor: { rgb: '1B5E20' } },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                border: {
                    top:    { style: 'thin', color: { rgb: '145214' } },
                    bottom: { style: 'medium', color: { rgb: '0D3D0F' } },
                    left:   { style: 'thin', color: { rgb: '145214' } },
                    right:  { style: 'thin', color: { rgb: '145214' } },
                },
            },
        };

        function borderFor(hex) {
            return {
                top:    { style: 'thin', color: { rgb: hex } },
                bottom: { style: 'thin', color: { rgb: hex } },
                left:   { style: 'thin', color: { rgb: hex } },
                right:  { style: 'thin', color: { rgb: hex } },
            };
        }

        function regionRowStyle(regionKey, isAlt) {
            const col = REGION_COLORS_HEX[regionKey] || { header: '2E7D32', light: 'E8F5E9' };
            const fill = isAlt ? col.header.replace(/(..)(..)(..)/, (_, r,g,b) => {
                // slightly lighter alt row
                return col.light;
            }) : col.light;
            return {
                font: { sz: 9, name: 'Calibri' },
                fill: { fgColor: { rgb: fill } },
                alignment: { vertical: 'center', wrapText: false },
                border: borderFor(col.header),
            };
        }

        function regionNameStyle(regionKey, isAlt) {
            const col = REGION_COLORS_HEX[regionKey] || { header: '2E7D32', light: 'E8F5E9' };
            return {
                font: { bold: true, sz: 9, color: { rgb: col.header }, name: 'Calibri' },
                fill: { fgColor: { rgb: col.light } },
                alignment: { vertical: 'center' },
                border: borderFor(col.header),
            };
        }

        function regionBannerStyle(regionKey) {
            const col = REGION_COLORS_HEX[regionKey] || { header: '2E7D32', light: 'E8F5E9' };
            return {
                font: { bold: true, sz: 10, color: { rgb: 'FFFFFF' }, name: 'Calibri' },
                fill: { fgColor: { rgb: col.header } },
                alignment: { horizontal: 'left', vertical: 'center' },
                border: borderFor(col.header),
            };
        }

        // ‚îÄ‚îÄ‚îÄ BUILD WORKSHEET DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Meta rows: 0=company, 1=title, 2=meta, 3=blank, 4=col headers, 5+=data
        const HEADER_ROW = 4;
        const DATA_START = 5;

        // Generate data with region banners inserted
        const wsData = [];
        const wsStyles = [];
        const merges = [
            { s:{r:0,c:0}, e:{r:0,c:colCount-1} },
            { s:{r:1,c:0}, e:{r:1,c:colCount-1} },
            { s:{r:2,c:0}, e:{r:2,c:colCount-1} },
            { s:{r:3,c:0}, e:{r:3,c:colCount-1} },
        ];

        wsData.push(
            ['STA. CLARA INTERNATIONAL CORPORATION'],
            [`ESH COMPLIANCE DASHBOARD  ‚Äî  ${title}`],
            [`Fiscal Year: ${year}   |   Generated: ${new Date().toLocaleString()}   |   Total Projects: ${(state.projects||[]).length}`],
            [''],
            headers,
        );
        wsStyles.push(
            Array(colCount).fill(S.company),
            Array(colCount).fill(S.reportTitle),
            Array(colCount).fill(S.meta),
            Array(colCount).fill(S.blank),
            Array(colCount).fill(S.colHeader),
        );

        // Group rows by region with banner rows
        let currentWsRow = DATA_START;
        let lastRegion = null;
        const regionCounters = {}; // for alt-row within region

        rows.forEach((row, ri) => {
            const meta = rowMeta[ri];
            const region = meta ? (meta.region||'').toUpperCase() : '';
            const col = REGION_COLORS_HEX[region] || null;

            // Insert region banner when region changes
            if (region && region !== lastRegion) {
                wsData.push([`  ‚ñé ${region}`, ...Array(colCount-1).fill('')]);
                const bannerStyle = regionBannerStyle(region);
                wsStyles.push(Array(colCount).fill(bannerStyle));
                merges.push({ s:{r:currentWsRow,c:0}, e:{r:currentWsRow,c:colCount-1} });
                currentWsRow++;
                lastRegion = region;
                regionCounters[region] = 0;
            }

            regionCounters[region] = (regionCounters[region] || 0);
            const isAlt = regionCounters[region] % 2 === 1;
            regionCounters[region]++;

            wsData.push(row);

            // Build per-cell styles for this row
            const rowStyle = row.map((_, ci) => {
                if (ci === 1 || ci === 2) return regionNameStyle(region, isAlt); // project name + region col
                return regionRowStyle(region, isAlt);
            });
            wsStyles.push(rowStyle);
            currentWsRow++;
        });

        // ‚îÄ‚îÄ‚îÄ CREATE WORKSHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Apply styles cell by cell
        wsStyles.forEach((rowStyle, ri) => {
            rowStyle.forEach((style, ci) => {
                const cellRef = encode(ri, ci);
                if (ws[cellRef]) ws[cellRef].s = style;
            });
        });

        // ‚îÄ‚îÄ‚îÄ COLUMN WIDTHS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        ws['!cols'] = headers.map((h, ci) => {
            let max = String(h).length + 3;
            rows.forEach(r => {
                const l = String(r[ci]||'').length;
                if (l + 2 > max) max = l + 2;
            });
            return { wch: Math.min(Math.max(max, 10), 48) };
        });

        // ‚îÄ‚îÄ‚îÄ ROW HEIGHTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        ws['!rows'] = [
            { hpt: 24 }, // company
            { hpt: 22 }, // report title
            { hpt: 14 }, // meta
            { hpt: 6  }, // blank
            { hpt: 20 }, // col headers
            ...wsData.slice(DATA_START).map((r, i) => {
                // Banner rows taller
                const isBanner = typeof r[0] === 'string' && r[0].startsWith('  ‚ñé');
                return { hpt: isBanner ? 16 : 15 };
            })
        ];

        ws['!merges'] = merges;

        XLSX.utils.book_append_sheet(wb, ws, title.substring(0, 31));
        XLSX.writeFile(wb, filename, { bookType: 'xlsx', type: 'binary', cellStyles: true });
        showToast('‚úÖ Excel exported!', 'success');
    } catch(err) {
        console.error('Excel error:', err);
        showToast('‚ùå Excel export failed: ' + err.message, 'error');
    }
}

// ==================== END EXPORT FUNCTIONS ====================


// Shared audio helper ‚Äî used by reminder, login, and logout sounds
function playNote(ctx, frequency, duration, volume, attackTime, releaseTime) {
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    const now = ctx.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(volume, now + attackTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration + releaseTime);
    oscillator.start(now);
    oscillator.stop(now + duration + releaseTime);
}

// Play login sound (once, no loop)
function playLoginSound() {
    try {
        // Don't call initAudioContext() here - just check if it exists
        if (!globalAudioContext || !audioContextReady) {
            console.log('üîá Login sound skipped (waiting for user interaction)');
            return;
        }
        
        // Option 2: Success Jingle - E-G-C-E
        playNote(globalAudioContext, 659, 0.15, 0.3, 0.01, 0.1); // E
        setTimeout(() => playNote(globalAudioContext, 784, 0.15, 0.3, 0.01, 0.1), 120); // G
        setTimeout(() => playNote(globalAudioContext, 1047, 0.2, 0.35, 0.01, 0.15), 240); // C
        setTimeout(() => playNote(globalAudioContext, 1319, 0.25, 0.4, 0.01, 0.18), 360); // E
        
        console.log('üîä Login sound played');
    } catch (e) {
        console.warn('Could not play login sound:', e);
    }
    

}

// Play logout sound (once, no loop)
function playLogoutSound() {
    try {
        // Don't call initAudioContext() - just check if it exists
        if (!globalAudioContext || !audioContextReady) {
            console.log('üîá Logout sound skipped (AudioContext not ready)');
            return;
        }
        
        // Option 1: Goodbye Tone - G-E-C descending
        playNote(globalAudioContext, 784, 0.15, 0.3, 0.01, 0.1); // G
        setTimeout(() => playNote(globalAudioContext, 659, 0.15, 0.3, 0.01, 0.1), 150); // E
        setTimeout(() => playNote(globalAudioContext, 523, 0.25, 0.35, 0.01, 0.18), 300); // C
        
        console.log('üîä Logout sound played');
    } catch (e) {
        console.warn('Could not play logout sound:', e);
    }
    

}

// Clear work timer on logout
function clearWorkTimerOnLogout() {
    // Stop any active reminders
    dismissReminder();
    
    // Clear the timer interval
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // Clear localStorage
    localStorage.removeItem('workStartTime');
    
    console.log('‚è±Ô∏è Work timer cleared on logout');
}

// Check if reminder should be shown
function checkReminders() {
    const elapsed = Date.now() - workStartTime;
    
    // Don't check if a reminder is currently showing
    if (currentReminderType) return;
    
    // Check reminders in PRIORITY ORDER (longer breaks override shorter ones)
    // When multiple reminders are due at the same time, show the most important one
    const checkIntervals = [
        { type: 'EXTENDED_BREAK', interval: REMINDERS.EXTENDED_BREAK.interval },   // 3 hours - HIGHEST PRIORITY
        { type: 'LONG_BREAK', interval: REMINDERS.LONG_BREAK.interval },           // 2 hours
        { type: 'MICRO_BREAK', interval: REMINDERS.MICRO_BREAK.interval },         // 1 hour
        { type: 'EYES_20', interval: REMINDERS.EYES_20.interval }                  // 20 minutes - LOWEST PRIORITY
    ];
    
    for (const check of checkIntervals) {
        // Check if we've hit this interval (within 2 second tolerance for reliability)
        if (elapsed >= check.interval) {
            const timeSinceInterval = elapsed % check.interval;
            
            // Trigger within 2 seconds of the interval mark
            if (timeSinceInterval < 2000) {
                console.log(`üîî Reminder triggered: ${check.type} at ${Math.floor(elapsed/60000)} minutes`);
                showReminder(check.type);
                break; // Show only one reminder at a time (highest priority wins)
            }
        }
    }
}

// Initialize safety reminder system
function initSafetyReminder() {
    // Load existing start time from localStorage or set new one
    const savedTime = localStorage.getItem('workStartTime');
    if (savedTime) {
        workStartTime = parseInt(savedTime);
    } else {
        workStartTime = Date.now();
        localStorage.setItem('workStartTime', workStartTime);
    }
    
    // Update timer every second
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    timerInterval = setInterval(() => {
        updateTimerDisplay();
        checkReminders();
    }, 1000);
    
    // Initial display update
    updateTimerDisplay();
    
    // Log reminder schedule
    const elapsed = Date.now() - workStartTime;
    console.log('‚úÖ Safety reminder system initialized');
    console.log(`‚è±Ô∏è Current work time: ${Math.floor(elapsed/60000)} minutes`);
    console.log('üìÖ Reminder Schedule:');
    console.log(`  üëÄ 20-20-20 Rule: Every 20 minutes (20, 40, 60, 80, 100, 120...)`);
    console.log(`  üßò Micro Break: Every 60 minutes (60, 120, 180...)`);
    console.log(`  ‚òï Longer Break: Every 120 minutes (120, 240...)`);
    console.log(`  üå≥ Extended Break: Every 180 minutes (180, 360...)`);
    console.log('');
    console.log('üîß Test Commands (paste in console):');
    console.log('  testReminder("EYES_20")    - Test 20-20-20 reminder');
    console.log('  testReminder("MICRO_BREAK") - Test micro break');
    console.log('  testReminder("LONG_BREAK")  - Test longer break');
    console.log('  testReminder("EXTENDED_BREAK") - Test extended break');
    console.log('  resetWorkTimer()            - Reset timer to 0');
    console.log('  setWorkTimer(minutes)       - Set timer to specific minutes');
}

// TEST FUNCTIONS for debugging
window.testReminder = function(type) {
    if (REMINDERS[type]) {
        console.log(`üß™ Testing reminder: ${type}`);
        showReminder(type);
    } else {
        console.error(`‚ùå Unknown reminder type: ${type}`);
        console.log('Available types: EYES_20, MICRO_BREAK, LONG_BREAK, EXTENDED_BREAK');
    }
};

window.resetWorkTimer = function() {
    workStartTime = Date.now();
    localStorage.setItem('workStartTime', workStartTime);
    updateTimerDisplay();
    console.log('üîÑ Work timer reset to 0:00:00');
};

window.setWorkTimer = function(minutes) {
    const targetTime = Date.now() - (minutes * 60 * 1000);
    workStartTime = targetTime;
    localStorage.setItem('workStartTime', workStartTime);
    updateTimerDisplay();
    console.log(`‚è±Ô∏è Work timer set to ${minutes} minutes`);
    console.log(`Next reminder should trigger at:`);
    
    // Calculate next reminder
    if (minutes < 20) {
        console.log(`  üëÄ 20-20-20 Rule in ${20 - minutes} minutes`);
    } else if (minutes < 60) {
        const nextEyes = Math.ceil(minutes / 20) * 20;
        console.log(`  üëÄ 20-20-20 Rule in ${nextEyes - minutes} minutes`);
    } else if (minutes < 120) {
        const nextMicro = Math.ceil(minutes / 60) * 60;
        console.log(`  üßò Micro Break in ${nextMicro - minutes} minutes`);
    } else if (minutes < 180) {
        const nextLong = Math.ceil(minutes / 120) * 120;
        console.log(`  ‚òï Longer Break in ${nextLong - minutes} minutes`);
    } else {
        const nextExtended = Math.ceil(minutes / 180) * 180;
        console.log(`  üå≥ Extended Break in ${nextExtended - minutes} minutes`);
    }
};

// Make dismiss function globally available
window.dismissReminder = dismissReminder;

// Start the system when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for the page to settle, then start
    setTimeout(() => {
        initSafetyReminder();
    }, 2000);
});

// Reset timer when user becomes active again after being away
let lastActivityTime = Date.now();
let inactivityTimeout = null;

function resetInactivityTimer() {
    lastActivityTime = Date.now();
    
    // If user was inactive for more than 10 minutes, reset the work timer
    if (inactivityTimeout) {
        clearTimeout(inactivityTimeout);
    }
    
    inactivityTimeout = setTimeout(() => {
        const inactiveTime = Date.now() - lastActivityTime;
        if (inactiveTime >= 10 * 60 * 1000) { // 10 minutes
            console.log('üîÑ User was inactive, resetting work timer');
            workStartTime = Date.now();
            localStorage.setItem('workStartTime', workStartTime);
            dismissReminder();
        }
    }, 10 * 60 * 1000);
}

// Track user activity
['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, true);
});

console.log('‚úÖ Safety reminder character loaded!');
// ==================== END SAFETY REMINDER SYSTEM ====================

// ==================== PRESENCE DEBUGGING ====================
// ==================== END FIREBASE INTEGRATION ====================

// ==================== AUTOMATIC COLOR CODING FOR REPORTORIAL TABLES ====================
function updateReportorialColors() {
    // Only apply colors when on the relevant tabs
    if (!['kpm', 'dole', 'emb', 'doe', 'doe-permit', 'env-monthly-report'].includes(state.currentTab)) return;
    
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth(); // 0-11 (0=January)
    const currentYear = currentDate.getFullYear();
    
    // Helper function to check if a month/quarter is overdue
    function isOverdue(monthIndex) {
        // If the month has already passed (strictly less than current month)
        if (monthIndex < currentMonth) {
            return true;
        }
        return false;
    }
    
    // Wait for table to be rendered
    setTimeout(() => {
        const tables = document.querySelectorAll('.table-container table');
        
        tables.forEach(table => {
            const rows = table.querySelectorAll('tbody tr, tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                
                // Skip header rows
                if (cells.length === 0) return;
                
                // For KPM and DOLE and Environmental Monthly Report - monthly columns (1-12)
                if (state.currentTab === 'kpm' || state.currentTab === 'dole' || state.currentTab === 'env-monthly-report') {
                    // Check if this is a merged cell row (AEDR, AMR) - skip color coding
                    const firstDataCell = cells[1];
                    if (firstDataCell && firstDataCell.getAttribute('colspan') === '12') {
                        return; // Skip annual report rows
                    }
                    
                    // Process cells 1-12 (January to December)
                    for (let i = 1; i <= 12 && i < cells.length; i++) {
                        const cell = cells[i];
                        const input = cell.querySelector('input[type="date"]');
                        
                        if (input) {
                            const monthIndex = i - 1; // Convert to 0-based index (0=Jan, 11=Dec)
                            const inputValue = input.value.trim();
                            
                            // If input is empty and month is overdue
                            if (inputValue === '' && isOverdue(monthIndex)) {
                                cell.style.backgroundColor = '#ffcdd2'; // Light red
                                input.style.backgroundColor = '#ffcdd2';
                                input.style.color = '#c62828'; // Dark red text
                            } 
                            // If input has a date - mark as green (submitted)
                            else if (inputValue !== '') {
                                cell.style.backgroundColor = '#c8e6c9'; // Light green
                                input.style.backgroundColor = '#c8e6c9';
                                input.style.color = '#2e7d32'; // Dark green text
                            }
                            // Future months - no special color
                            else {
                                cell.style.backgroundColor = '';
                                input.style.backgroundColor = '';
                                input.style.color = '';
                            }
                        }
                    }
                }
                
                // For EMB - quarterly columns (Q1-Q4)
                else if (state.currentTab === 'emb') {
                    const rowType = cells[0]?.textContent.trim() || '';
                    
                    // Only apply to "Submission Date" rows, not "Reference No." rows
                    if (rowType.includes('Submission Date')) {
                        // Check if this is CMR Semi-Annual (has colspan="2")
                        const firstDataCell = cells[1];
                        const secondDataCell = cells[2];
                        
                        if (firstDataCell && firstDataCell.getAttribute('colspan') === '2' && 
                            secondDataCell && secondDataCell.getAttribute('colspan') === '2') {
                            // CMR Semi-Annual with 2 periods
                            
                            // Period 1: Jan-June, Due July 15
                            const input1 = firstDataCell.querySelector('input[type="date"]');
                            if (input1) {
                                const inputValue1 = input1.value.trim();
                                let isOverdue1 = false;
                                
                                // Due July 15 of the selected year
                                if (currentDate.getFullYear() > state.selectedYear) {
                                    // Past the deadline year
                                    isOverdue1 = true;
                                } else if (currentDate.getFullYear() === state.selectedYear) {
                                    if (currentMonth > 6) { // After July
                                        isOverdue1 = true;
                                    } else if (currentMonth === 6 && currentDate.getDate() > 15) { // After July 15
                                        isOverdue1 = true;
                                    }
                                }
                                
                                if (inputValue1 === '' && isOverdue1) {
                                    firstDataCell.style.backgroundColor = '#ffcdd2';
                                    input1.style.backgroundColor = '#ffcdd2';
                                    input1.style.color = '#c62828';
                                } else if (inputValue1 !== '') {
                                    firstDataCell.style.backgroundColor = '#c8e6c9';
                                    input1.style.backgroundColor = '#c8e6c9';
                                    input1.style.color = '#2e7d32';
                                } else {
                                    firstDataCell.style.backgroundColor = '';
                                    input1.style.backgroundColor = '';
                                    input1.style.color = '';
                                }
                            }
                            
                            // Period 2: Jul-Dec, Due January 15 of NEXT year
                            const input2 = secondDataCell.querySelector('input[type="date"]');
                            if (input2) {
                                const inputValue2 = input2.value.trim();
                                let isOverdue2 = false;
                                
                                // CMR Jul-Dec 2026 is due January 15, 2027
                                // Using EXACT same logic as Q4 SMR
                                const deadlineYear = state.selectedYear + 1; // Deadline is in the next year
                                const currentYear = currentDate.getFullYear();
                                
                                // Check if we've passed the deadline
                                if (currentYear > deadlineYear) {
                                    // Already past the deadline year
                                    isOverdue2 = true;
                                } else if (currentYear === deadlineYear) {
                                    // In the deadline year - check month and day
                                    if (currentMonth === 0 && currentDate.getDate() > 15) {
                                        // January 16+ of deadline year
                                        isOverdue2 = true;
                                    } else if (currentMonth > 0) {
                                        // February or later of deadline year
                                        isOverdue2 = true;
                                    }
                                }
                                // If currentYear < deadlineYear, not overdue yet
                                
                                if (inputValue2 === '' && isOverdue2) {
                                    secondDataCell.style.backgroundColor = '#ffcdd2';
                                    input2.style.backgroundColor = '#ffcdd2';
                                    input2.style.color = '#c62828';
                                } else if (inputValue2 !== '') {
                                    secondDataCell.style.backgroundColor = '#c8e6c9';
                                    input2.style.backgroundColor = '#c8e6c9';
                                    input2.style.color = '#2e7d32';
                                } else {
                                    secondDataCell.style.backgroundColor = '';
                                    input2.style.backgroundColor = '';
                                    input2.style.color = '';
                                }
                            }
                        } else {
                            // SMR Quarterly - Due 15th of following month after quarter
                            // Q1 (Jan-Mar) due April 15, Q2 (Apr-Jun) due July 15
                            // Q3 (Jul-Sep) due October 15, Q4 (Oct-Dec) due January 15 NEXT YEAR
                            for (let q = 1; q <= 4 && q < cells.length; q++) {
                                const cell = cells[q];
                                const input = cell.querySelector('input[type="date"]');
                                
                                if (input) {
                                    // Deadline is 15th of month after quarter ends
                                    // Q1 ends March (month 2), due April 15 (month 3, day 15)
                                    // Q2 ends June (month 5), due July 15 (month 6, day 15)
                                    // Q3 ends September (month 8), due October 15 (month 9, day 15)
                                    // Q4 ends December (month 11), due January 15 NEXT YEAR (month 0, day 15)
                                    const quarterEndMonth = (q * 3) - 1; // Q1->2(Mar), Q2->5(Jun), Q3->8(Sep), Q4->11(Dec)
                                    const deadlineMonth = (quarterEndMonth + 1) % 12; // Next month: Q1->3(Apr), Q2->6(Jul), Q3->9(Oct), Q4->0(Jan)
                                    const inputValue = input.value.trim();
                                    
                                    let isOverdue = false;
                                    
                                    // Special handling for Q4 (due January 15 of NEXT year)
                                    if (q === 4) {
                                        // Q4 2026 is due January 15, 2027
                                        const deadlineYear = state.selectedYear + 1; // Q4's deadline is in the next year
                                        const currentYear = currentDate.getFullYear();
                                        
                                        // Check if we've passed the deadline
                                        if (currentYear > deadlineYear) {
                                            // Already past the deadline year
                                            isOverdue = true;
                                        } else if (currentYear === deadlineYear) {
                                            // In the deadline year - check month and day
                                            if (currentMonth === 0 && currentDate.getDate() > 15) {
                                                // January 16+ of deadline year
                                                isOverdue = true;
                                            } else if (currentMonth > 0) {
                                                // February or later of deadline year
                                                isOverdue = true;
                                            }
                                        }
                                        // If currentYear < deadlineYear, not overdue yet
                                    } else {
                                        // For Q1, Q2, Q3 - normal logic
                                        if (currentMonth > deadlineMonth) {
                                            isOverdue = true;
                                        } else if (currentMonth === deadlineMonth && currentDate.getDate() > 15) {
                                            isOverdue = true;
                                        }
                                    }
                                    
                                    // If input is empty and deadline has passed
                                    if (inputValue === '' && isOverdue) {
                                        cell.style.backgroundColor = '#ffcdd2';
                                        input.style.backgroundColor = '#ffcdd2';
                                        input.style.color = '#c62828';
                                    }
                                    // If input has a date - mark as green
                                    else if (inputValue !== '') {
                                        cell.style.backgroundColor = '#c8e6c9';
                                        input.style.backgroundColor = '#c8e6c9';
                                        input.style.color = '#2e7d32';
                                    }
                                    // Future quarters - no color
                                    else {
                                        cell.style.backgroundColor = '';
                                        input.style.backgroundColor = '';
                                        input.style.color = '';
                                    }
                                }
                            }
                        }
                    }
                }
                
                // For DOE - quarterly columns (Q1-Q4) - due 20th of following month
                else if (state.currentTab === 'doe') {
                    const rowType = cells[0]?.textContent.trim() || '';
                    
                    // DOE only has submission date row now
                    if (rowType.includes('Submission Date')) {
                        // DOE Quarterly - Q1, Q2, Q3, Q4
                        for (let q = 1; q <= 4 && q < cells.length; q++) {
                            const cell = cells[q];
                            const input = cell.querySelector('input[type="date"]');
                            
                            if (input) {
                                const inputValue = input.value.trim();
                                let isOverdue = false;
                                
                                // Special handling for Q4 (due January 20 of NEXT year)
                                if (q === 4) {
                                    // Q4 2026 is due January 20, 2027
                                    const deadlineYear = state.selectedYear + 1;
                                    const currentYear = currentDate.getFullYear();
                                    
                                    if (currentYear > deadlineYear) {
                                        isOverdue = true;
                                    } else if (currentYear === deadlineYear) {
                                        if (currentMonth === 0 && currentDate.getDate() > 20) {
                                            isOverdue = true;
                                        } else if (currentMonth > 0) {
                                            isOverdue = true;
                                        }
                                    }
                                } else {
                                    // For Q1, Q2, Q3 - normal logic
                                    const quarterLastMonth = (q * 3) - 1;
                                    const deadlineMonth = quarterLastMonth + 1;
                                    
                                    if (currentMonth > deadlineMonth) {
                                        isOverdue = true;
                                    } else if (currentMonth === deadlineMonth && currentDate.getDate() > 20) {
                                        isOverdue = true;
                                    }
                                }
                                
                                if (inputValue === '' && isOverdue) {
                                    cell.style.backgroundColor = '#ffcdd2';
                                    input.style.backgroundColor = '#ffcdd2';
                                    input.style.color = '#c62828';
                                }
                                else if (inputValue !== '') {
                                    cell.style.backgroundColor = '#c8e6c9';
                                    input.style.backgroundColor = '#c8e6c9';
                                    input.style.color = '#2e7d32';
                                }
                                else {
                                    cell.style.backgroundColor = '';
                                    input.style.backgroundColor = '';
                                    input.style.color = '';
                                }
                            }
                        }
                    }
                }
                
                // For DOE Safety Officer Permit - check expiry dates
                else if (state.currentTab === 'doe-permit') {
                    // Find "Valid Until" column (index 2)
                    if (cells.length >= 3) {
                        const validUntilCell = cells[2];
                        const dateInput = validUntilCell.querySelector('input[type="date"]');
                        
                        if (dateInput) {
                            const validUntilValue = dateInput.value.trim();
                            
                            if (validUntilValue !== '') {
                                const expiryDate = new Date(validUntilValue);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                expiryDate.setHours(0, 0, 0, 0);
                                
                                // Check if expired
                                if (expiryDate < today) {
                                    // EXPIRED - Red
                                    validUntilCell.style.backgroundColor = '#ffcdd2';
                                    dateInput.style.backgroundColor = '#ffcdd2';
                                    dateInput.style.color = '#c62828';
                                    dateInput.style.fontWeight = '700';
                                } 
                                // Check if expiring within 30 days
                                else {
                                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                                    
                                    if (daysUntilExpiry <= 30) {
                                        // Expiring soon - Yellow
                                        validUntilCell.style.backgroundColor = '#fff9c4';
                                        dateInput.style.backgroundColor = '#fff9c4';
                                        dateInput.style.color = '#f57c00';
                                        dateInput.style.fontWeight = '600';
                                    } else {
                                        // Valid - Green
                                        validUntilCell.style.backgroundColor = '#c8e6c9';
                                        dateInput.style.backgroundColor = '#c8e6c9';
                                        dateInput.style.color = '#2e7d32';
                                    }
                                }
                            } else {
                                // No date entered - leave default
                                validUntilCell.style.backgroundColor = '';
                                dateInput.style.backgroundColor = '';
                                dateInput.style.color = '';
                            }
                        }
                    }
                }
            });
        });
        
        console.log(`‚úÖ Color coding applied for ${state.currentTab.toUpperCase()}`);
    }, 100);
}

// Hook into the render function to update colors AND notifications after rendering
// (Combining both hooks to avoid duplicate originalRender declaration)
const originalRenderBase = render;
render = function() {
    originalRenderBase();
    updateReportorialColors();
    if (typeof updateNotifications === 'function') {
        updateNotifications();
    }
    checkExpiredPermits(); // Check for expired DOE permits
};

// Check for expired DOE Safety Officer Permits and show notification
function checkExpiredPermits() {
    if (state.currentTab !== 'doe-permit') return;
    
    const renewableProjects = state.projects.filter(p => p.isRenewable === true);
    const key = 'doe-permit_DOE Safety Officer Permit';
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const expiredPermits = [];
    const expiringSoon = [];
    
    renewableProjects.forEach(p => {
        const validUntil = p.vals[key] ? (p.vals[key][2] ?? "") : "";
        
        if (validUntil) {
            const expiryDate = new Date(validUntil);
            expiryDate.setHours(0, 0, 0, 0);
            
            if (expiryDate < today) {
                expiredPermits.push({
                    project: p.name,
                    expiryDate: validUntil
                });
            } else {
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry <= 30) {
                    expiringSoon.push({
                        project: p.name,
                        expiryDate: validUntil,
                        daysLeft: daysUntilExpiry
                    });
                }
            }
        }
    });
    
    // Show notifications for expired permits
    if (expiredPermits.length > 0) {
        const message = expiredPermits.length === 1
            ? `‚ö†Ô∏è DOE Safety Officer Permit for "${expiredPermits[0].project}" has EXPIRED!`
            : `‚ö†Ô∏è ${expiredPermits.length} DOE Safety Officer Permits have EXPIRED!`;
        
        showToast(message, 'error');
    }
    
    // Show notification for expiring soon
    if (expiringSoon.length > 0) {
        const message = expiringSoon.length === 1
            ? `‚è∞ DOE Safety Officer Permit for "${expiringSoon[0].project}" expires in ${expiringSoon[0].daysLeft} day(s)`
            : `‚è∞ ${expiringSoon.length} DOE Safety Officer Permits expiring within 30 days`;
        
        showToast(message, 'warning');
    }
}

// Run color update when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateReportorialColors();
        console.log('‚úÖ Reportorial color coding system initialized');
    }, 1500);
});

// Re-run color update whenever cells are edited
function refreshReportorialColors() {
    updateReportorialColors();
}

// Make the function globally available
window.refreshReportorialColors = refreshReportorialColors;

// Also update colors when input values change
document.addEventListener('input', function(e) {
    if (e.target.tagName === 'INPUT' && e.target.type === 'date') {
        if (['kpm', 'dole', 'emb', 'doe', 'env-monthly-report'].includes(state.currentTab)) {
            setTimeout(updateReportorialColors, 50);
        }
    }
});

// ==================== END AUTOMATIC COLOR CODING ====================



// ==================== DOE REPORTORIAL & SAFETY OFFICER PERMIT FUNCTIONS ====================

// PDF Upload Functions for DOE Reportorial
async function uploadDoePdf(projectName, quarter) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type !== 'application/pdf') {
            showToast('‚ö†Ô∏è Please select a PDF file', 'warning');
            return;
        }
        
        // Limit to 500KB ‚Äî 1 page stamped file only
        if (file.size > 500 * 1024) {
            showToast('‚ö†Ô∏è File size must be less than 500KB. Please upload the STAMPED FILE PAGE only (1 page), hindi ang buong file.', 'warning');
            return;
        }
        
        try {
            showToast(`üì§ Uploading PDF for Q${quarter}...`, 'info');
            
            const STORAGE_UID = window.firebaseAuth?.currentUser?.uid || 'fUnXsvKnRYMpuySRbeVYJk7TO452'; // Use current user's UID for Storage rule compliance
            const year = state.selectedYear;
            const fileName = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_Q${quarter}_${Date.now()}.pdf`;
            const storagePath = `doe-reports/${STORAGE_UID}/${year}/${fileName}`;
            
            const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
            await window.firebase.uploadBytes(storageRef, file);
            const downloadURL = await window.firebase.getDownloadURL(storageRef);
            
            const project = state.projects.find(p => p.name === projectName);
            if (project) {
                if (!project.doePdfFiles) project.doePdfFiles = {};
                project.doePdfFiles[`Q${quarter}`] = {
                    url: downloadURL,
                    fileName: file.name,
                    storagePath: storagePath,
                    uploadedAt: new Date().toISOString()
                };
                
                await saveToFirebase();
                render();
                showToast(`‚úÖ PDF uploaded for Q${quarter}`, 'success');
            }
        } catch (error) {
            console.error('Error uploading PDF:', error);
            showToast('‚ùå Failed to upload PDF: ' + error.message, 'error');
        }
    };
    
    input.click();
}

async function viewDoePdf(projectName, quarter) {
    const project = state.projects.find(p => p.name === projectName);
    if (!project || !project.doePdfFiles || !project.doePdfFiles[`Q${quarter}`]) {
        showToast('‚ö†Ô∏è No PDF file found', 'warning');
        return;
    }
    
    const pdfData = project.doePdfFiles[`Q${quarter}`];
    window.open(pdfData.url, '_blank');
}

async function deleteDoePdf(projectName, quarter) {
    const confirmed = await showModernDialog(
        'üóëÔ∏è Delete PDF',
        `Delete the uploaded PDF for Q${quarter}?<br><br>This action cannot be undone.`,
        true
    );
    
    if (!confirmed) return;
    
    try {
        const project = state.projects.find(p => p.name === projectName);
        if (!project || !project.doePdfFiles || !project.doePdfFiles[`Q${quarter}`]) {
            showToast('‚ö†Ô∏è No PDF file found', 'warning');
            return;
        }
        
        const pdfData = project.doePdfFiles[`Q${quarter}`];
        
        const storageRef = window.firebase.ref(window.firebaseStorage, pdfData.storagePath);
        await window.firebase.deleteObject(storageRef);
        
        delete project.doePdfFiles[`Q${quarter}`];
        
        await saveToFirebase();
        render();
        showToast(`‚úÖ PDF deleted for Q${quarter}`, 'success');
    } catch (error) {
        console.error('Error deleting PDF:', error);
        showToast('‚ùå Failed to delete PDF: ' + error.message, 'error');
    }
}

// DOE Safety Officer Permit PDF Functions
async function uploadDoePermitPdf(projectName) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type !== 'application/pdf') {
            showToast('‚ö†Ô∏è Please select a PDF file', 'warning');
            return;
        }
        
        // Limit to 500KB ‚Äî 1 page stamped file only
        if (file.size > 500 * 1024) {
            showToast('‚ö†Ô∏è File size must be less than 500KB. Please upload the STAMPED FILE PAGE only (1 page), hindi ang buong file.', 'warning');
            return;
        }
        
        try {
            showToast('üì§ Uploading DOE Safety Officer Permit...', 'info');
            
            const STORAGE_UID = window.firebaseAuth?.currentUser?.uid || 'fUnXsvKnRYMpuySRbeVYJk7TO452'; // Use current user's UID for Storage rule compliance
            const year = state.selectedYear;
            const fileName = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_DOE_Permit_${Date.now()}.pdf`;
            const storagePath = `doe-permits/${STORAGE_UID}/${year}/${fileName}`;
            
            const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
            await window.firebase.uploadBytes(storageRef, file);
            const downloadURL = await window.firebase.getDownloadURL(storageRef);
            
            const project = state.projects.find(p => p.name === projectName);
            if (project) {
                const key = 'doe-permit_DOE Safety Officer Permit';
                if (!project.vals[key]) project.vals[key] = {};
                
                // Store PDF URL in index 3
                project.vals[key][3] = downloadURL;
                project.vals[key].pdfFileName = file.name;
                project.vals[key].pdfStoragePath = storagePath;
                
                await saveToFirebase();
                render();
                showToast('‚úÖ DOE Safety Officer Permit PDF uploaded', 'success');
            }
        } catch (error) {
            console.error('Error uploading PDF:', error);
            showToast('‚ùå Failed to upload PDF: ' + error.message, 'error');
        }
    };
    
    input.click();
}

async function viewDoePermitPdf(projectName) {
    const project = state.projects.find(p => p.name === projectName);
    const key = 'doe-permit_DOE Safety Officer Permit';
    
    if (!project || !project.vals[key] || !project.vals[key][3]) {
        showToast('‚ö†Ô∏è No PDF file found', 'warning');
        return;
    }
    
    window.open(project.vals[key][3], '_blank');
}

async function deleteDoePermitPdf(projectName) {
    const confirmed = await showModernDialog(
        'üîÑ Replace PDF',
        'This will delete the current PDF so you can upload a new one. Continue?',
        true
    );
    
    if (!confirmed) return;
    
    try {
        const project = state.projects.find(p => p.name === projectName);
        const key = 'doe-permit_DOE Safety Officer Permit';
        
        if (!project || !project.vals[key] || !project.vals[key][3]) {
            showToast('‚ö†Ô∏è No PDF file found', 'warning');
            return;
        }
        
        const storagePath = project.vals[key].pdfStoragePath;
        if (storagePath) {
            const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
            await window.firebase.deleteObject(storageRef);
        }
        
        delete project.vals[key][3];
        delete project.vals[key].pdfFileName;
        delete project.vals[key].pdfStoragePath;
        
        await saveToFirebase();
        render();
        showToast('‚úÖ PDF deleted. You can now upload a new one.', 'success');
    } catch (error) {
        console.error('Error deleting PDF:', error);
        showToast('‚ùå Failed to delete PDF: ' + error.message, 'error');
    }
}

// DOE Safety Officer Permit Functions (deprecated - now using table format)

// ==================== OSH PERSONNEL REQUIREMENT MONITORING ====================

/**
 * DO 252-25 Section 22 - OSHS for the Construction Industry - Compute required OSH personnel.
 */
function computeOshRequirements(manpower) {
    const n = Math.max(0, parseInt(manpower) || 0);
    if (n === 0) return null;

    let firstAider = 0, safetyOfficer = 0, ohNurse = 0, ohDentist = 0, ohPhysician = 0;
    let soLabel = '', nurseLabel = '', physLabel = '';

    if (n >= 1 && n <= 9) {
        firstAider = 1; safetyOfficer = 1; soLabel = '1 SO2';
    } else if (n >= 10 && n <= 50) {
        firstAider = 2; safetyOfficer = 2; soLabel = '2 SO2';
    } else if (n >= 51 && n <= 99) {
        firstAider = 2; safetyOfficer = 1; soLabel = '1 SO2';
        ohNurse = 1; nurseLabel = '1 PT';
    } else if (n >= 100 && n <= 199) {
        firstAider = 3; safetyOfficer = 3; soLabel = '3 SO2 / 2 SO3';
        ohNurse = 1; nurseLabel = '1 FT';
        ohDentist = 1; ohPhysician = 1;
        physLabel = '1 PT';
    } else if (n >= 200 && n <= 500) {
        firstAider = 6; safetyOfficer = 3; soLabel = '2 SO3 + 1 SO4';
        ohNurse = 2; nurseLabel = '2 PT';
    } else {
        // 501+
        const over500 = n - 500;
        firstAider   = 6 + Math.floor(over500 / 500);
        safetyOfficer = 3 + Math.floor(over500 / 500);
        ohNurse      = 1 + Math.floor(over500 / 250);
        ohPhysician  = Math.floor(over500 / 500);
        soLabel = safetyOfficer + ' SO';
        nurseLabel = ohNurse + ' FT';
        physLabel = ohPhysician > 0 ? ohPhysician + ' FT' : '‚Äì';
    }

    return { firstAider, safetyOfficer, ohNurse, ohDentist, ohPhysician, soLabel, nurseLabel, physLabel };
}

/**
 * Classify a personnel position into OSH category.
 * Returns: 'firstAider' | 'safetyOfficer' | 'ohNurse' | 'ohDentist' | 'ohPhysician' | null
 */
function classifyOshPosition(pos) {
    if (!pos) return null;
    const p = pos.toLowerCase();
    if (p.includes('first aid')) return 'firstAider';
    if (p.includes('safety officer') || p === 'esh superintendent' || p === 'esh head') return 'safetyOfficer';
    if (p.includes('nurse')) return 'ohNurse';
    if (p.includes('dentist')) return 'ohDentist';
    if (p.includes('physician') || p.includes('doctor')) return 'ohPhysician';
    return null;
}

/** Get or initialize oshData for a project */
function getOshData(projectName) {
    if (!state.oshData) state.oshData = {};
    if (!state.oshData[projectName]) {
        state.oshData[projectName] = { manpower: 0 };
    }
    return state.oshData[projectName];
}

function saveOshData() {
    if (typeof saveToFirebase === 'function') saveToFirebase();
}

/**
 * Count actual OSH personnel assigned to a project from the ESH Personnel Registry.
 */
function countActualOshPersonnel(projectName) {
    const data = state.personnelData || [];
    const counts = { firstAider: 0, safetyOfficer: 0, ohNurse: 0, ohDentist: 0, ohPhysician: 0, names: [] };
    data.forEach(p => {
        if (p.current === projectName) {
            const cat = classifyOshPosition(p.pos);
            if (cat) {
                counts[cat]++;
                counts.names.push({ name: p.name || '?', pos: p.pos, cat });
            }
        }
    });
    return counts;
}

/**
 * Main render function for the new OSH tab - grouped by region.
 */
function renderOsh2() {
    const container = document.getElementById('osh2-regions-container');
    if (!container) return;

    const regionFilter = (document.getElementById('osh2-region-filter') || {}).value || 'all';
    const statusFilter = (document.getElementById('osh2-status-filter') || {}).value || 'all';

    const allProjects = state.filteredProjects && state.filteredProjects.length
        ? state.filteredProjects
        : (state.projects || []);

    // Group by region
    const REGIONS = ['NCR', 'NORTH LUZON', 'SOUTH LUZON', 'VISAYAS & MINDANAO'];
    const grouped = {};
    REGIONS.forEach(r => grouped[r] = []);

    allProjects.forEach(p => {
        const r = (p.region || '').trim().toUpperCase();
        if (grouped[r] !== undefined) grouped[r].push(p);
        // CORPORATE and other non-region projects are intentionally excluded
    });

    let totalProjects = 0, totalCompliant = 0, totalDeficient = 0, totalNoInput = 0;
    let html = '';

    const REGIONS_TO_SHOW = [...REGIONS];

    REGIONS_TO_SHOW.forEach(region => {
        if (regionFilter !== 'all' && regionFilter.toUpperCase() !== region) return;

        let projects = grouped[region] || [];
        if (!projects.length) return;

        // Build rows for this region
        let regionRows = '';
        let rCompliant = 0, rDeficient = 0, rNoInput = 0;

        projects.forEach((proj, idx) => {
            const d = getOshData(proj.name);
            const manpower = parseInt(d.manpower) || 0;
            const req = computeOshRequirements(manpower);
            const actual = countActualOshPersonnel(proj.name);

            // Determine row status
            let rowStatus = 'no-input';
            let defGaps = [];

            if (req) {
                const cats = ['firstAider','safetyOfficer','ohNurse','ohDentist','ohPhysician'];
                let hasDeficiency = false;
                cats.forEach(cat => {
                    if (req[cat] > 0 && actual[cat] < req[cat]) {
                        hasDeficiency = true;
                        defGaps.push(cat);
                    }
                });
                rowStatus = hasDeficiency ? 'deficient' : 'compliant';
                if (hasDeficiency) rDeficient++; else rCompliant++;
            } else {
                rNoInput++;
            }

            totalProjects++;

            // Apply status filter
            if (statusFilter !== 'all' && statusFilter !== rowStatus) return;

            // Build personnel names tooltip for each project
            const safeN = (proj.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

            // Region access control: Superintendents can only edit their own region
            const canEditThisRegion = UserAccounts.canEdit(state.currentUser?.email, region);

            // Cell builder
            function makeCell(cat, reqCount, actCount, label) {
                if (reqCount === 0) {
                    return `<td style="text-align:center;background:var(--input-bg);color:#9e9e9e;font-size:0.7rem;padding:8px 6px;">
                        <span style="opacity:0.5;">N/R</span>
                    </td>`;
                }
                const ok = actCount >= reqCount;
                const bg = ok ? '#e8f5e9' : '#fff3e0';
                const bord = ok ? '#a5d6a7' : '#ffcc80';
                const icon = ok ? '‚úì' : '‚ö†';
                const icolor = ok ? '#2e7d32' : '#e65100';

                // Get names of people in this category assigned to this project
                const peopleInCat = actual.names.filter(n => n.cat === cat);
                const namesTooltip = peopleInCat.length
                    ? peopleInCat.map(n => n.name + ' (' + n.pos + ')').join('\n')
                    : 'None assigned';

                return `<td style="text-align:center;background:${bg};border-left:1px solid ${bord};padding:8px 6px;" title="${namesTooltip}">
                    <div style="display:flex;flex-direction:column;align-items:center;gap:2px;">
                        <span style="font-size:0.75rem;font-weight:800;color:${icolor};">${icon} ${actCount}/${reqCount}</span>
                        <span style="font-size:0.6rem;color:#5d4037;font-weight:600;">${label || ''}</span>
                    </div>
                </td>`;
            }

            const statusBadge = !req
                ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:10px;background:#f5f5f5;color:#9e9e9e;font-size:0.62rem;font-weight:700;border:1px solid #e0e0e0;">‚ùì NO INPUT</span>`
                : rowStatus === 'compliant'
                    ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:10px;background:#e8f5e9;color:#2e7d32;font-size:0.62rem;font-weight:700;border:1px solid #a5d6a7;">‚úì COMPLIANT</span>`
                    : `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:10px;background:#fff3e0;color:#e65100;font-size:0.62rem;font-weight:700;border:1px solid #ffcc80;animation:osh-pulse 2s infinite;">‚ö† DEFICIENT</span>`;

            // Personnel list column - show all assigned ESH personnel
            const allAssigned = actual.names;
            const assignedHtml = allAssigned.length
                ? allAssigned.slice(0,4).map(n=>`<div style="font-size:0.58rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;">${n.name} <span style="color:#2e7d32;">[${n.pos}]</span></div>`).join('')
                    + (allAssigned.length > 4 ? `<div style="font-size:0.58rem;color:#9e9e9e;">+${allAssigned.length-4} more‚Ä¶</div>` : '')
                : `<span style="font-size:0.6rem;color:#bdbdbd;">No ESH personnel tagged</span>`;

            const rowBg = idx % 2 === 0 ? '' : 'background:rgba(0,0,0,0.015);';

            regionRows += `<tr style="${rowBg}">
                <td style="padding:8px 10px;font-weight:600;font-size:0.72rem;min-width:190px;position:sticky;left:0;z-index:5;background:var(--bg-card);${idx%2===1?'background:rgba(0,0,0,0.015);':''}">
                    <span style="color:var(--text-secondary);font-size:0.63rem;margin-right:4px;">${idx+1}</span>
                    ${proj.name}
                    <div style="font-size:0.6rem;color:var(--text-secondary);font-weight:400;margin-top:1px;">${proj.status||'on-going'}</div>
                </td>
                <td style="text-align:center;padding:6px;min-width:80px;">
                    ${canEditThisRegion
                        ? `<input class="osh2-mp-input" type="number" min="0" value="${manpower||''}" placeholder="0"
                            onchange="updateOsh2Manpower('${safeN}',this.value)"
                            style="width:65px;padding:5px 6px;border:1.5px solid ${manpower>0?'#2e7d32':'var(--border-color)'};border-radius:6px;background:var(--input-bg);color:var(--text-primary);font-size:0.78rem;text-align:center;font-weight:700;" />`
                        : `<div style="width:65px;padding:5px 6px;border:1.5px solid var(--border-color);border-radius:6px;background:rgba(0,0,0,0.04);color:var(--text-secondary);font-size:0.78rem;text-align:center;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:4px;cursor:not-allowed;" title="You can only edit your assigned region">
                            <i class="fas fa-lock" style="font-size:0.6rem;opacity:0.5;"></i>
                            <span>${manpower > 0 ? manpower : '‚Äì'}</span>
                          </div>`
                    }
                </td>
                ${req ? makeCell('firstAider', req.firstAider, actual.firstAider, req.soLabel ? '' : '') : '<td style="text-align:center;color:#bdbdbd;font-size:0.7rem;">‚Äì</td>'}
                ${req ? makeCell('safetyOfficer', req.safetyOfficer, actual.safetyOfficer, req.soLabel) : '<td style="text-align:center;color:#bdbdbd;font-size:0.7rem;">‚Äì</td>'}
                ${req ? makeCell('ohNurse', req.ohNurse, actual.ohNurse, req.nurseLabel) : '<td style="text-align:center;color:#bdbdbd;font-size:0.7rem;">‚Äì</td>'}
                ${req ? makeCell('ohDentist', req.ohDentist, actual.ohDentist, '') : '<td style="text-align:center;color:#bdbdbd;font-size:0.7rem;">‚Äì</td>'}
                ${req ? makeCell('ohPhysician', req.ohPhysician, actual.ohPhysician, req.physLabel) : '<td style="text-align:center;color:#bdbdbd;font-size:0.7rem;">‚Äì</td>'}
                <td style="padding:8px 6px;text-align:center;">${statusBadge}</td>
                <td style="padding:6px 8px;min-width:150px;">
                    <div style="font-size:0.6rem;">${assignedHtml}</div>
                </td>
            </tr>`;
        });

        // Track totals
        totalCompliant += rCompliant;
        totalDeficient += rDeficient;
        totalNoInput += rNoInput;

        if (!regionRows) return; // All filtered out

        const regionTotal = rCompliant + rDeficient + rNoInput;
        const rPct = regionTotal > 0 ? Math.round((rCompliant / (rCompliant + rDeficient)) * 100) : 0;
        const rPctColor = rPct >= 80 ? '#2e7d32' : rPct >= 50 ? '#e65100' : '#c62828';

        const regionColors = {
            'NCR': '#1b5e20',
            'NORTH LUZON': '#2e7d32',
            'SOUTH LUZON': '#388e3c',
            'VISAYAS & MINDANAO': '#43a047',
        };
        const rColor = regionColors[region] || '#2e7d32';
        const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, region);

        html += `
        <div style="background:var(--bg-card);border-radius:10px;overflow:hidden;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:16px;">
            <!-- Region header -->
            <div style="background:linear-gradient(90deg,${rColor} 0%,${rColor}dd 100%);padding:10px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;" onclick="toggleOsh2Region(this,'osh2-region-${region.replace(/[^a-z0-9]/gi,'_')}')">
                <div style="display:flex;align-items:center;gap:10px;">
                    <i class="fas fa-chevron-down" style="color:rgba(255,255,255,0.7);font-size:0.65rem;transition:transform 0.3s;"></i>
                    <i class="fas fa-map-marker-alt" style="color:rgba(255,255,255,0.8);font-size:0.8rem;"></i>
                    <span style="font-weight:800;color:white;font-size:0.85rem;letter-spacing:0.5px;">${region}</span>
                    <span style="background:rgba(255,255,255,0.18);color:white;padding:2px 10px;border-radius:12px;font-size:0.65rem;font-weight:700;">${projects.length} project${projects.length!==1?'s':''}</span>
                    ${!canEditRegion ? `<span style="background:rgba(0,0,0,0.25);color:rgba(255,255,255,0.7);padding:2px 10px;border-radius:12px;font-size:0.63rem;display:inline-flex;align-items:center;gap:4px;"><i class="fas fa-lock" style="font-size:0.55rem;"></i> View Only</span>` : ''}
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span style="background:rgba(76,175,80,0.3);color:#a5d6a7;padding:2px 10px;border-radius:10px;font-size:0.65rem;font-weight:700;">${rCompliant} OK</span>
                    ${rDeficient > 0 ? `<span style="background:rgba(255,82,82,0.3);color:#ff8a80;padding:2px 10px;border-radius:10px;font-size:0.65rem;font-weight:700;animation:osh-pulse 2s infinite;">${rDeficient} Deficient</span>` : ''}
                    ${rNoInput > 0 ? `<span style="background:rgba(255,255,255,0.15);color:rgba(255,255,255,0.7);padding:2px 10px;border-radius:10px;font-size:0.65rem;">${rNoInput} No Input</span>` : ''}
                    <span style="color:white;font-size:0.72rem;font-weight:700;">${(rCompliant+rDeficient)>0?rPct+'% Compliant':''}</span>
                </div>
            </div>

            <!-- Region table -->
            <div id="osh2-region-${region.replace(/[^a-z0-9]/gi,'_')}" style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.72rem;">
                    <thead>
                        <tr style="background:linear-gradient(90deg,${rColor} 0%,${rColor}cc 100%);">
                            <th style="padding:9px 10px;text-align:left;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;position:sticky;left:0;background:${rColor};">PROJECT</th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">MANPOWER<br><span style="font-weight:400;opacity:0.85;">(Input)</span></th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">FIRST AIDER<br><span style="font-weight:400;opacity:0.85;">Req / Act</span></th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">SAFETY OFFICER<br><span style="font-weight:400;opacity:0.85;">Req / Act</span></th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">OH NURSE<br><span style="font-weight:400;opacity:0.85;">Req / Act</span></th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">OH DENTIST<br><span style="font-weight:400;opacity:0.85;">Req / Act</span></th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">OH PHYSICIAN<br><span style="font-weight:400;opacity:0.85;">Req / Act</span></th>
                            <th style="padding:9px 6px;text-align:center;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;">STATUS</th>
                            <th style="padding:9px 6px;text-align:left;font-weight:700;color:white;font-size:0.68rem;white-space:nowrap;min-width:150px;">ASSIGNED ESH PERSONNEL<br><span style="font-weight:400;opacity:0.85;font-size:0.6rem;">(from registry)</span></th>
                        </tr>
                    </thead>
                    <tbody>${regionRows}</tbody>
                </table>
            </div>
        </div>`;
    });

    container.innerHTML = html || `<div style="padding:50px;text-align:center;color:var(--text-secondary);background:var(--bg-card);border-radius:10px;border:1px solid var(--border-color);">
        <i class="fas fa-hard-hat" style="font-size:2.5rem;opacity:0.25;margin-bottom:12px;"></i>
        <div style="font-weight:600;">No projects match the current filter.</div>
    </div>`;
    applyNumFmtToInputs();

    // Update badges
    const tot = totalCompliant + totalDeficient;
    const pct = tot > 0 ? Math.round((totalCompliant / tot) * 100) : 0;
    const b1 = document.getElementById('osh2-badge-total');
    const b2 = document.getElementById('osh2-badge-compliant');
    const b3 = document.getElementById('osh2-badge-deficient');
    if (b1) b1.textContent = `${allProjects.length} Projects`;
    if (b2) b2.textContent = `‚úÖ ${totalCompliant} Compliant`;
    if (b3) b3.textContent = totalDeficient > 0 ? `‚ö† ${totalDeficient} Deficient` : `‚úì All Checked`;

    // Stat bar
    const statBar = document.getElementById('osh2-stat-bar');
    if (statBar && allProjects.length > 0) {
        const pctC = Math.round((totalCompliant / allProjects.length) * 100);
        const pctD = Math.round((totalDeficient / allProjects.length) * 100);
        const pctN = 100 - pctC - pctD;
        statBar.innerHTML = `
            <div title="${totalCompliant} Compliant" style="height:6px;width:${pctC}%;background:#4caf50;transition:width 0.5s;"></div>
            <div title="${totalDeficient} Deficient" style="height:6px;width:${pctD}%;background:#ff7043;transition:width 0.5s;"></div>
            <div title="${totalNoInput} No Input" style="height:6px;flex:1;background:#e0e0e0;"></div>`;
    }
}

function updateOsh2Manpower(projectName, value) {
    if (!state.oshData) state.oshData = {};
    if (!state.oshData[projectName]) state.oshData[projectName] = {};
    state.oshData[projectName].manpower = Math.max(0, parseInt(value) || 0);
    saveOshData();
    clearTimeout(window._osh2Timer);
    window._osh2Timer = setTimeout(() => {
        renderOsh2();
        if (typeof updateNotifications === 'function') updateNotifications();
    }, 600);
}

function toggleOsh2Region(headerEl, contentId) {
    const content = document.getElementById(contentId);
    if (!content) return;
    const chevron = headerEl.querySelector('.fa-chevron-down,.fa-chevron-right');
    const isOpen = content.style.display !== 'none';
    content.style.display = isOpen ? 'none' : '';
    if (chevron) {
        chevron.classList.toggle('fa-chevron-down', !isOpen);
        chevron.classList.toggle('fa-chevron-right', isOpen);
    }
}

function toggleOsh2Ref(headerEl) {
    const panel = document.getElementById('osh2-ref-matrix');
    const chevron = document.getElementById('osh2-ref-chevron');
    if (!panel) return;
    const open = panel.style.display === 'none';
    panel.style.display = open ? 'block' : 'none';
    if (chevron) chevron.style.transform = open ? 'rotate(90deg)' : '';
}

// Legacy stubs (kept for any residual calls)
function renderOshTable() {}
function toggleOshRef() {}

// ==================== END OSH REQUIREMENT MONITORING ====================

// ==================== MODAL OVERLAY HANDLERS ====================
// Modals are now LOCKED - cannot close by clicking outside
// Users must explicitly click Cancel or Save buttons to exit
// This prevents accidental data loss during editing
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîí Modal safety enabled: Click-outside disabled');
    console.log('üí° Use Cancel or Save buttons to close modals');
});



// ==================== ENVIRONMENTAL MONITORING ====================
(function() {
    const GHG_FACTOR = 0.000694;   // tCO2 per kWh
    const TREE_FACTOR = 0.02177;   // tCO2 absorbed per tree per year

    const ENV_REGIONS = ['NCR', 'SOUTH LUZON', 'NORTH LUZON', 'VISAYAS & MINDANAO'];
    const ENV_MONTHS  = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    const REGION_COLORS = {
        'NCR':                  { bg: '#1b5e20', light: '#e8f5e9', badge: '#66bb6a' },
        'NORTH LUZON':          { bg: '#2e7d32', light: '#f1f8e9', badge: '#81c784' },
        'SOUTH LUZON':          { bg: '#388e3c', light: '#f9fbe7', badge: '#a5d6a7' },
        'VISAYAS & MINDANAO':   { bg: '#43a047', light: '#f1f8e9', badge: '#c8e6c9' }
    };
    const PIE_COLORS = ['#1b5e20','#2e7d32','#558b2f','#43a047'];

    // envData: flat array of {id, region, month, location, kwh, amount, ghg, trees}
    let envData = [];
    // collapsed state per region
    let envCollapsed = {};

    /* ‚îÄ‚îÄ helpers ‚îÄ‚îÄ */
    function calc(kwh) {
        const ghg   = kwh * GHG_FACTOR;
        const trees = ghg / TREE_FACTOR;
        return { ghg, trees };
    }
    function regionKey(r) { return r.replace(/[^a-z0-9]/gi,'_'); }

    /* ‚îÄ‚îÄ auto-calc in form ‚îÄ‚îÄ */
    window.envCalc = function(regionRaw, pi) {
        const rk     = regionKey(regionRaw);
        const suffix = pi !== undefined ? `${rk}-${pi}` : rk;
        const kwh    = parseFloat(document.getElementById('env-kwh-'+suffix)?.value) || 0;
        const { ghg, trees } = calc(kwh);
        const gEl = document.getElementById('env-ghg-'+suffix);
        const tEl = document.getElementById('env-trees-'+suffix);
        if (gEl) gEl.value = ghg.toFixed(4);
        if (tEl) tEl.value = trees.toFixed(4);
    };

    /* ‚îÄ‚îÄ add row ‚îÄ‚îÄ */
    window.envAddRow = function(regionRaw, pi, projName) {
        const userEmail = (typeof state !== 'undefined') ? state.currentUser?.email : null;
        if (!UserAccounts.canEdit(userEmail, regionRaw) || !UserAccounts.canEditTab(userEmail, 'env-monitoring')) {
            if (typeof showToast === 'function') showToast('üîí You do not have permission to add entries here.', 'warning');
            return;
        }
        const rk     = regionKey(regionRaw);
        const suffix = pi !== undefined ? `${rk}-${pi}` : rk;
        const month  = document.getElementById('env-month-'+suffix)?.value || 'January';
        const loc    = (document.getElementById('env-loc-'+suffix)?.value || '').trim() || '‚Äî';
        const kwh    = parseFloat(document.getElementById('env-kwh-'+suffix)?.value) || 0;
        const amount = parseFloat(document.getElementById('env-amt-'+suffix)?.value) || 0;
        const { ghg, trees } = calc(kwh);

        envData.push({ id: Date.now() + Math.random(), region: regionRaw, project: projName || '', month, location: loc, kwh, amount, ghg, trees });

        // clear form
        ['env-loc-','env-kwh-','env-amt-','env-ghg-','env-trees-'].forEach(p => {
            const el = document.getElementById(p+suffix);
            if (el) el.value = '';
        });

        envRender();
    };

    /* ‚îÄ‚îÄ delete row ‚îÄ‚îÄ */
    window.envDeleteRow = function(id) {
        const row = envData.find(r => r.id === id);
        const userEmail = (typeof state !== 'undefined') ? state.currentUser?.email : null;
        if (row && (!UserAccounts.canEdit(userEmail, row.region) || !UserAccounts.canEditTab(userEmail, 'env-monitoring'))) {
            if (typeof showToast === 'function') showToast('üîí You do not have permission to delete entries in this region.', 'warning');
            return;
        }
        envData = envData.filter(r => r.id !== id);
        envRender();
    };

    /* ‚îÄ‚îÄ clear region ‚îÄ‚îÄ */
    window.envClearRegion = function(regionRaw) {
        const userEmail = (typeof state !== 'undefined') ? state.currentUser?.email : null;
        if (!UserAccounts.canEdit(userEmail, regionRaw) || !UserAccounts.canEditTab(userEmail, 'env-monitoring')) {
            if (typeof showToast === 'function') showToast('üîí You do not have permission to clear entries in this region.', 'warning');
            return;
        }
        if (!envData.some(r => r.region === regionRaw)) return;
        if (!confirm(`Clear all records for ${regionRaw}?`)) return;
        envData = envData.filter(r => r.region !== regionRaw);
        envRender();
    };

    /* ‚îÄ‚îÄ toggle collapse ‚îÄ‚îÄ */
    window.envToggleRegion = function(regionRaw) {
        envCollapsed[regionRaw] = !envCollapsed[regionRaw];
        const rk = regionKey(regionRaw);
        const body = document.getElementById('env-region-body-'+rk);
        const icon = document.getElementById('env-region-chevron-'+rk);
        if (body) body.style.display = envCollapsed[regionRaw] ? 'none' : '';
        if (icon) {
            icon.classList.toggle('fa-chevron-down', !envCollapsed[regionRaw]);
            icon.classList.toggle('fa-chevron-right', !!envCollapsed[regionRaw]);
        }
    };

    /* ‚îÄ‚îÄ master render ‚îÄ‚îÄ */
    window.envRender = function() {
        envRenderRegions();
        envUpdateChart();
        envUpdateBadges();
    };

    function envRenderRegions() {
        const container = document.getElementById('env-regions-container');
        if (!container) return;

        const allProjects = (typeof state !== 'undefined' && state.projects) ? state.projects : [];
        const userEmail   = (typeof state !== 'undefined') ? state.currentUser?.email : null;
        const canEditEnv  = UserAccounts.canEditTab(userEmail, 'env-monitoring');

        // Accumulators for Overall Summary
        const overallSummary = []; // { region, kwh, amount, ghg, trees, projCount }

        let html = '';

        ENV_REGIONS.forEach(region => {
            const rk               = regionKey(region);
            const rc               = REGION_COLORS[region] || { bg:'#2e7d32', light:'#e8f5e9' };
            const projs            = allProjects.filter(p => p.region === region);
            const regionRows       = envData.filter(r => r.region === region);
            const isOpen           = !envCollapsed[region];
            const canEditRegionEnv = canEditEnv && UserAccounts.canEdit(userEmail, region);

            // Region totals
            const rKwh   = regionRows.reduce((s,r)=>s+r.kwh,0);
            const rAmt   = regionRows.reduce((s,r)=>s+r.amount,0);
            const rGhg   = regionRows.reduce((s,r)=>s+r.ghg,0);
            const rTrees = regionRows.reduce((s,r)=>s+r.trees,0);

            overallSummary.push({ region, kwh: rKwh, amount: rAmt, ghg: rGhg, trees: rTrees, projCount: projs.length, color: rc.bg });

            // Build per-project tables
            let projTablesHtml = '';
            if (projs.length === 0) {
                projTablesHtml = `<div style="padding:20px;text-align:center;color:var(--text-secondary);font-size:0.75rem;font-style:italic;">
                    <i class="fas fa-folder-open" style="opacity:0.25;font-size:1.5rem;display:block;margin-bottom:6px;"></i>No projects in this region yet.
                </div>`;
            } else {
                projs.forEach((proj, pi) => {
                    const projRows = regionRows.filter(r => r.project === proj.name);
                    const pKwh   = projRows.reduce((s,r)=>s+r.kwh,0);
                    const pAmt   = projRows.reduce((s,r)=>s+r.amount,0);
                    const pGhg   = projRows.reduce((s,r)=>s+r.ghg,0);
                    const pTrees = projRows.reduce((s,r)=>s+r.trees,0);
                    const cols   = canEditRegionEnv ? 7 : 6;

                    projTablesHtml += `
                    <!-- Project: ${proj.name} -->
                    <div style="margin:12px 14px;border-radius:8px;overflow:hidden;border:1px solid #c8e6c9;box-shadow:0 1px 4px rgba(0,0,0,0.04);">

                        <!-- Project sub-header -->
                        <div style="background:linear-gradient(90deg,${rc.bg}22,${rc.bg}11);padding:8px 14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #c8e6c9;">
                            ${proj.isRenewable ? `<i class="fas fa-leaf" style="color:#4caf50;font-size:0.75rem;"></i>` : `<i class="fas fa-hard-hat" style="color:${rc.bg};font-size:0.75rem;"></i>`}
                            <span style="font-weight:700;font-size:0.76rem;color:${rc.bg};">${proj.name}</span>
                            <span style="background:${proj.status==='completed'?'#e8f5e9':proj.status==='on-hold'?'#fff3e0':'#e8f5e9'};color:${proj.status==='completed'?'#2e7d32':proj.status==='on-hold'?'#e65100':'#2e7d32'};padding:1px 8px;border-radius:10px;font-size:0.62rem;font-weight:700;">${proj.status||'on-going'}</span>
                            ${projRows.length>0?`<span style="margin-left:auto;font-size:0.66rem;color:var(--text-secondary);">${projRows.length} entr${projRows.length!==1?'ies':'y'} &nbsp;|&nbsp; <strong style="color:${rc.bg};">${pKwh.toLocaleString()} kWh</strong></span>`:''}
                        </div>

                        <!-- Add entry form for this project -->
                        ${canEditRegionEnv ? `
                        <div style="padding:10px 14px;background:${rc.light};border-bottom:1px solid #c8e6c9;">
                            <div style="display:flex;flex-wrap:wrap;gap:7px;align-items:flex-end;">
                                <div>
                                    <label style="font-size:0.63rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:2px;">Month</label>
                                    <select id="env-month-${rk}-${pi}" style="padding:5px 7px;border-radius:5px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-primary);font-size:0.7rem;min-width:110px;">
                                        ${ENV_MONTHS.map(m=>`<option value="${m}">${m}</option>`).join('')}
                                    </select>
                                </div>
                                <div style="flex:1;min-width:120px;">
                                    <label style="font-size:0.63rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:2px;">Office / Building &amp; Floor Area</label>
                                    <input type="text" id="env-loc-${rk}-${pi}" placeholder="e.g. Office 1 / 100m2" style="width:100%;box-sizing:border-box;padding:5px 7px;border-radius:5px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-primary);font-size:0.7rem;">
                                </div>
                                <div style="min-width:75px;">
                                    <label style="font-size:0.63rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:2px;">kWh</label>
                                    <input type="number" id="env-kwh-${rk}-${pi}" placeholder="0" min="0" oninput="envCalc('${region}',${pi})" style="width:100%;box-sizing:border-box;padding:5px 7px;border-radius:5px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-primary);font-size:0.7rem;">
                                </div>
                                <div style="min-width:85px;">
                                    <label style="font-size:0.63rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:2px;">Amount (Php)</label>
                                    <input type="number" id="env-amt-${rk}-${pi}" placeholder="0" min="0" style="width:100%;box-sizing:border-box;padding:5px 7px;border-radius:5px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-primary);font-size:0.7rem;">
                                </div>
                                <div style="min-width:75px;">
                                    <label style="font-size:0.63rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:2px;">GHG (tCO2)</label>
                                    <input type="number" id="env-ghg-${rk}-${pi}" readonly style="width:100%;box-sizing:border-box;padding:5px 7px;border-radius:5px;border:1px solid #c8e6c9;background:#e8f5e9;color:#2e7d32;font-size:0.7rem;font-weight:700;">
                                </div>
                                <div style="min-width:75px;">
                                    <label style="font-size:0.63rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:2px;">Trees Offset</label>
                                    <input type="number" id="env-trees-${rk}-${pi}" readonly style="width:100%;box-sizing:border-box;padding:5px 7px;border-radius:5px;border:1px solid #c8e6c9;background:#e8f5e9;color:#2e7d32;font-size:0.7rem;font-weight:700;">
                                </div>
                                <button onclick="envAddRow('${region}',${pi},'${proj.name.replace(/'/g,"\\'")}')" style="padding:5px 12px;background:linear-gradient(135deg,${rc.bg},${rc.bg}cc);color:white;border:none;border-radius:5px;font-size:0.7rem;font-weight:700;cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:4px;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>` : ''}

                        <!-- Project table -->
                        <div style="overflow-x:auto;">
                            <table style="width:100%;border-collapse:collapse;font-size:0.7rem;">
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="padding:7px 11px;text-align:center;background:#b7ddb5;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;vertical-align:middle;white-space:nowrap;font-size:0.65rem;">Month</th>
                                        <th rowspan="2" style="padding:7px 11px;text-align:center;background:#b7ddb5;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;vertical-align:middle;font-size:0.65rem;">Office/Building<br>Floor Area</th>
                                        <th colspan="4" style="padding:6px 11px;text-align:center;background:#9ecf9b;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.65rem;">Electricity Consumption</th>
                                        ${canEditRegionEnv ? `<th rowspan="2" style="padding:7px 7px;text-align:center;background:#b7ddb5;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.65rem;"></th>` : ''}
                                    </tr>
                                    <tr>
                                        <th style="padding:6px 11px;text-align:center;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.65rem;">kWh</th>
                                        <th style="padding:6px 11px;text-align:center;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.65rem;">Amount, Php</th>
                                        <th style="padding:6px 11px;text-align:center;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.65rem;">Eq. GHG Emission<br>(tCO2)</th>
                                        <th style="padding:6px 11px;text-align:center;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.65rem;">Offset Emission<br>(No. of Trees)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${envBuildRows(projRows, canEditRegionEnv)}
                                </tbody>
                                ${projRows.length ? `
                                <tfoot>
                                    <tr style="background:#e8f5e9;">
                                        <td colspan="2" style="padding:7px 11px;font-weight:700;color:#1b5e20;border:1px solid #c8e6c9;font-size:0.67rem;">
                                            <i class="fas fa-sigma" style="font-size:0.6rem;"></i> TOTAL ‚Äî ${proj.name}
                                        </td>
                                        <td style="padding:7px 11px;text-align:right;font-weight:700;color:#1b5e20;border:1px solid #c8e6c9;">${pKwh.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
                                        <td style="padding:7px 11px;text-align:right;font-weight:700;color:#1b5e20;border:1px solid #c8e6c9;">${pAmt.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
                                        <td style="padding:7px 11px;text-align:right;font-weight:700;color:#1b5e20;border:1px solid #c8e6c9;">${pGhg.toFixed(4)}</td>
                                        <td style="padding:7px 11px;text-align:right;font-weight:700;color:#1b5e20;border:1px solid #c8e6c9;">${pTrees.toFixed(4)}</td>
                                        ${canEditRegionEnv ? `<td style="border:1px solid #c8e6c9;"></td>` : ''}
                                    </tr>
                                </tfoot>` : ''}
                            </table>
                        </div>
                    </div>`;
                });

                // Region Total row (all projects combined)
                if (regionRows.length > 0) {
                    projTablesHtml += `
                    <div style="margin:8px 14px 14px;border-radius:8px;overflow:hidden;border:2px solid ${rc.bg}44;">
                        <table style="width:100%;border-collapse:collapse;font-size:0.72rem;">
                            <tr style="background:${rc.bg}18;">
                                <td colspan="2" style="padding:9px 14px;font-weight:800;color:${rc.bg};border:1px solid ${rc.bg}33;font-size:0.72rem;">
                                    <i class="fas fa-map-marker-alt" style="margin-right:5px;"></i>REGION TOTAL ‚Äî ${region}
                                    <span style="font-weight:400;font-size:0.65rem;opacity:0.75;margin-left:6px;">(${projs.length} project${projs.length!==1?'s':''})</span>
                                </td>
                                <td style="padding:9px 14px;text-align:right;font-weight:800;color:${rc.bg};border:1px solid ${rc.bg}33;">${rKwh.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
                                <td style="padding:9px 14px;text-align:right;font-weight:800;color:${rc.bg};border:1px solid ${rc.bg}33;">${rAmt.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
                                <td style="padding:9px 14px;text-align:right;font-weight:800;color:${rc.bg};border:1px solid ${rc.bg}33;">${rGhg.toFixed(4)}</td>
                                <td style="padding:9px 14px;text-align:right;font-weight:800;color:${rc.bg};border:1px solid ${rc.bg}33;">${rTrees.toFixed(4)}</td>
                                ${canEditRegionEnv ? `<td style="border:1px solid ${rc.bg}33;width:40px;"></td>` : ''}
                            </tr>
                        </table>
                    </div>`;
                }
            }

            html += `
            <div style="background:var(--bg-card);border-radius:10px;overflow:hidden;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:14px;">

                <!-- Region Header -->
                <div onclick="envToggleRegion('${region}')" style="background:linear-gradient(90deg,${rc.bg} 0%,${rc.bg}dd 100%);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <i id="env-region-chevron-${rk}" class="fas ${isOpen?'fa-chevron-down':'fa-chevron-right'}" style="color:rgba(255,255,255,0.7);font-size:0.65rem;"></i>
                        <i class="fas fa-map-marker-alt" style="color:rgba(255,255,255,0.8);font-size:0.8rem;"></i>
                        <span style="font-weight:800;color:white;font-size:0.85rem;letter-spacing:0.5px;">${region}</span>
                        <span style="background:rgba(255,255,255,0.18);color:white;padding:2px 10px;border-radius:12px;font-size:0.65rem;font-weight:700;">${projs.length} project${projs.length!==1?'s':''}</span>
                        ${!canEditRegionEnv ? `<span style="background:rgba(0,0,0,0.25);color:rgba(255,255,255,0.75);padding:2px 10px;border-radius:12px;font-size:0.63rem;display:inline-flex;align-items:center;gap:4px;"><i class="fas fa-lock" style="font-size:0.55rem;"></i> View Only</span>` : ''}
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        ${rKwh>0?`<span style="background:rgba(255,255,255,0.2);color:white;padding:2px 10px;border-radius:10px;font-size:0.65rem;font-weight:700;">${rKwh.toLocaleString()} kWh</span>`:''}
                        ${rGhg>0?`<span style="background:rgba(100,255,100,0.2);color:#c8f7c5;padding:2px 10px;border-radius:10px;font-size:0.65rem;font-weight:700;">${rGhg.toFixed(4)} tCO2</span>`:''}
                    </div>
                </div>

                <!-- Region Body -->
                <div id="env-region-body-${rk}" style="display:${isOpen?'':'none'};">
                    ${!canEditRegionEnv ? `
                    <div style="padding:9px 14px;background:${rc.light};border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:7px;font-size:0.71rem;color:${rc.bg};font-weight:600;">
                        <i class="fas fa-lock"></i> This region is <strong>view-only</strong> for your account.
                    </div>` : ''}
                    ${projTablesHtml}
                </div>
            </div>`;
        });

        // ‚îÄ‚îÄ OVERALL SUMMARY (rendered into separate top container) ‚îÄ‚îÄ
        const grandKwh   = overallSummary.reduce((s,r)=>s+r.kwh,0);
        const grandAmt   = overallSummary.reduce((s,r)=>s+r.amount,0);
        const grandGhg   = overallSummary.reduce((s,r)=>s+r.ghg,0);
        const grandTrees = overallSummary.reduce((s,r)=>s+r.trees,0);
        const hasAnyData = grandKwh > 0 || overallSummary.some(r=>r.kwh>0);

        const summaryContainer = document.getElementById('env-overall-summary-container');
        if (summaryContainer) {
            summaryContainer.innerHTML = `
        <div style="background:var(--bg-card);border-radius:12px;overflow:hidden;border:2px solid #2e7d32;box-shadow:0 4px 16px rgba(46,125,50,0.12);">
            <div style="background:linear-gradient(135deg,#0d3d0f 0%,#1b5e20 60%,#2e7d32 100%);padding:12px 18px;display:flex;align-items:center;gap:10px;">
                <i class="fas fa-globe" style="color:#a5d6a7;font-size:1.1rem;"></i>
                <span style="font-weight:800;color:white;font-size:0.88rem;letter-spacing:0.5px;">OVERALL SUMMARY ‚Äî ALL REGIONS</span>
                <span style="background:rgba(255,255,255,0.15);color:white;padding:2px 10px;border-radius:12px;font-size:0.65rem;margin-left:auto;">${allProjects.length} Total Projects</span>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.72rem;">
                    <thead>
                        <tr>
                            <th style="padding:9px 14px;text-align:left;background:#b7ddb5;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">Region</th>
                            <th style="padding:9px 14px;text-align:center;background:#b7ddb5;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">Projects</th>
                            <th style="padding:9px 14px;text-align:right;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">kWh</th>
                            <th style="padding:9px 14px;text-align:right;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">Amount (Php)</th>
                            <th style="padding:9px 14px;text-align:right;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">Eq. GHG (tCO2)</th>
                            <th style="padding:9px 14px;text-align:right;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">Offset (Trees)</th>
                            <th style="padding:9px 14px;text-align:right;background:#c5e8c3;color:#1b5e20;font-weight:700;border:1px solid #c8e6c9;font-size:0.68rem;">% of Total kWh</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${overallSummary.map((s,i) => `
                        <tr style="background:${i%2===0?'var(--bg-card)':'var(--input-bg)'};">
                            <td style="padding:8px 14px;border:1px solid #e8f5e9;font-weight:700;display:flex;align-items:center;gap:7px;">
                                <span style="width:10px;height:10px;border-radius:2px;background:${s.color};flex-shrink:0;display:inline-block;"></span>
                                ${s.region}
                            </td>
                            <td style="padding:8px 14px;text-align:center;border:1px solid #e8f5e9;color:var(--text-secondary);">${s.projCount}</td>
                            <td style="padding:8px 14px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);font-weight:${s.kwh>0?'600':'400'};">${s.kwh>0?s.kwh.toLocaleString(undefined,{maximumFractionDigits:2}):'‚Äî'}</td>
                            <td style="padding:8px 14px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${s.amount>0?s.amount.toLocaleString(undefined,{maximumFractionDigits:2}):'‚Äî'}</td>
                            <td style="padding:8px 14px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${s.ghg>0?s.ghg.toFixed(4):'‚Äî'}</td>
                            <td style="padding:8px 14px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${s.trees>0?s.trees.toFixed(4):'‚Äî'}</td>
                            <td style="padding:8px 14px;text-align:right;border:1px solid #e8f5e9;">
                                ${grandKwh>0 ? `
                                <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;">
                                    <div style="flex:1;max-width:80px;background:#e8f5e9;border-radius:3px;height:6px;overflow:hidden;">
                                        <div style="width:${Math.round((s.kwh/grandKwh)*100)}%;height:100%;background:${s.color};border-radius:3px;"></div>
                                    </div>
                                    <span style="font-weight:700;color:${s.color};min-width:32px;text-align:right;">${Math.round((s.kwh/grandKwh)*100)}%</span>
                                </div>` : '<span style="color:var(--text-secondary);">‚Äî</span>'}
                            </td>
                        </tr>`).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="background:linear-gradient(90deg,#e8f5e9,#f1f8e9);">
                            <td style="padding:10px 14px;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;font-size:0.73rem;"><i class="fas fa-globe" style="margin-right:5px;"></i>GRAND TOTAL</td>
                            <td style="padding:10px 14px;text-align:center;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;">${allProjects.length}</td>
                            <td style="padding:10px 14px;text-align:right;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;font-size:0.74rem;">${grandKwh>0?grandKwh.toLocaleString(undefined,{maximumFractionDigits:2}):'‚Äî'}</td>
                            <td style="padding:10px 14px;text-align:right;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;font-size:0.74rem;">${grandAmt>0?grandAmt.toLocaleString(undefined,{maximumFractionDigits:2}):'‚Äî'}</td>
                            <td style="padding:10px 14px;text-align:right;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;font-size:0.74rem;">${grandGhg>0?grandGhg.toFixed(4):'‚Äî'}</td>
                            <td style="padding:10px 14px;text-align:right;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;font-size:0.74rem;">${grandTrees>0?grandTrees.toFixed(4):'‚Äî'}</td>
                            <td style="padding:10px 14px;text-align:center;font-weight:800;color:#1b5e20;border:1px solid #c8e6c9;">100%</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            ${!hasAnyData ? `<div style="padding:24px;text-align:center;color:var(--text-secondary);font-size:0.78rem;font-style:italic;"><i class="fas fa-seedling" style="opacity:0.2;font-size:1.8rem;display:block;margin-bottom:8px;"></i>No electricity data entered yet. Add entries per project in each region above.</div>` : ''}
        </div>`;
        }

        container.innerHTML = html;
    }

    function envBuildRows(rows, canEdit) {
        if (!rows.length) {
            return `<tr><td colspan="${canEdit ? 7 : 6}" style="padding:18px;text-align:center;color:var(--text-secondary);font-size:0.72rem;font-style:italic;">
                <i class="fas fa-seedling" style="opacity:0.2;margin-right:5px;"></i>No entries yet${canEdit ? ' ‚Äî use the form above' : ''}.
            </td></tr>`;
        }
        const grouped = {};
        ENV_MONTHS.forEach(m => { grouped[m] = []; });
        rows.forEach(r => { if (grouped[r.month]) grouped[r.month].push(r); });

        let html = '';
        ENV_MONTHS.forEach(month => {
            const mRows = grouped[month];
            if (!mRows.length) return;
            mRows.forEach((r, i) => {
                html += `<tr style="background:${i%2===0?'var(--bg-card)':'var(--input-bg)'};">
                    ${i===0 ? `<td rowspan="${mRows.length}" style="padding:6px 11px;text-align:center;font-weight:700;color:#1b5e20;border:1px solid #e8f5e9;vertical-align:middle;white-space:nowrap;">${month}</td>` : ''}
                    <td style="padding:6px 11px;border:1px solid #e8f5e9;color:var(--text-primary);">${r.location}</td>
                    <td style="padding:6px 11px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${r.kwh.toLocaleString()}</td>
                    <td style="padding:6px 11px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${r.amount.toLocaleString()}</td>
                    <td style="padding:6px 11px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${r.ghg.toFixed(4)}</td>
                    <td style="padding:6px 11px;text-align:right;border:1px solid #e8f5e9;color:var(--text-primary);">${r.trees.toFixed(4)}</td>
                    ${canEdit ? `<td style="padding:5px 7px;text-align:center;border:1px solid #e8f5e9;">
                        <button onclick="envDeleteRow(${r.id})" style="padding:2px 7px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:4px;font-size:0.6rem;cursor:pointer;"><i class="fas fa-times"></i></button>
                    </td>` : ''}
                </tr>`;
            });
        });
        return html;
    }

    /* ‚îÄ‚îÄ badges ‚îÄ‚îÄ */
    function envUpdateBadges() {
        const totKwh  = envData.reduce((s,r)=>s+r.kwh,0);
        const totGhg  = envData.reduce((s,r)=>s+r.ghg,0);
        const totTrees= envData.reduce((s,r)=>s+r.trees,0);
        const b1 = document.getElementById('env-badge-kwh');
        const b2 = document.getElementById('env-badge-ghg');
        const b3 = document.getElementById('env-badge-trees');
        if (b1) b1.textContent = `${totKwh.toLocaleString()} kWh Total`;
        if (b2) b2.textContent = `${totGhg.toFixed(4)} tCO2`;
        if (b3) b3.textContent = `${Math.ceil(totTrees)} Trees Needed`;
    }

    /* ‚îÄ‚îÄ pie chart (by region) ‚îÄ‚îÄ */
    let envChart = null;
    function envUpdateChart() {
        const ctx = document.getElementById('env-pie-chart');
        if (!ctx) return;

        const labels = [], data = [], colors = [];
        ENV_REGIONS.forEach((region, i) => {
            const tot = envData.filter(r=>r.region===region).reduce((s,r)=>s+r.kwh,0);
            if (tot > 0) { labels.push(region); data.push(tot); colors.push(PIE_COLORS[i]); }
        });

        if (envChart) {
            envChart.data.labels = labels;
            envChart.data.datasets[0].data = data;
            envChart.data.datasets[0].backgroundColor = colors;
            envChart.update();
        } else {
            envChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
                options: {
                    responsive: false, cutout: '60%',
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ${c.label}: ${c.parsed.toLocaleString()} kWh` } } },
                    animation: { duration: 500 }
                }
            });
        }

        const total = data.reduce((s,v)=>s+v,0);
        const ctr = document.getElementById('env-pie-total');
        if (ctr) ctr.textContent = total > 0 ? total.toLocaleString() : '0';

        const leg = document.getElementById('env-pie-legend');
        if (leg) {
            leg.innerHTML = labels.length
                ? labels.map((l,i)=>`<div style="display:flex;align-items:center;gap:5px;"><span style="width:9px;height:9px;border-radius:2px;background:${colors[i]};flex-shrink:0;"></span><span style="color:var(--text-secondary);flex:1;font-size:0.65rem;">${l}</span><span style="font-weight:700;color:var(--text-primary);font-size:0.65rem;">${data[i].toLocaleString()}</span></div>`).join('')
                : `<div style="color:var(--text-secondary);font-size:0.65rem;font-style:italic;">No data yet</div>`;
        }
    }

    /* ‚îÄ‚îÄ init on tab open ‚îÄ‚îÄ */
    window.envInitChart = function() {
        // Re-render with current data (chart re-initializes if canvas was hidden)
        if (envChart) { envChart.destroy(); envChart = null; }
        envRender();
    };

})();
// ==================== END ENVIRONMENTAL MONITORING ====================

// ==================== END DOE FUNCTIONS ====================

// ==================== ESH CALENDAR & DRILLS MATRIX ====================
(function() {

const ESH_MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

const ESH_TRAININGS = {
    'esh-calendar-env': [
        'Chemicals & Hazardous Waste Management including PPE management',
        'Ecological Solid Waste Management',
        'Water Pollution Prevention and Control',
        'Aspect and Impact Identification Training',
        'Chemical and Oil Spill Handling with drills',
        '5S and Good Housekeeping',
        'Biodiversity Management',
        'Use and Conservation of Resources (Energy, Water, Fuel and Materials)',
        'Air Pollution Prevention and Control',
        'Climate Change Awareness',
        'Safety Data Sheets and GHS Labelling',
    ],
    'esh-calendar-safety': [
        '8-Hr Mandatory OSH Training',
        'Emergency Preparedness and Response',
        'Accident/Incident Notification, Investigation, Classification, Reporting and Recording',
        'Fire Prevention and Control Awareness',
        'HIRAC Awareness',
        'Behavioral Based Safety',
        'Permit to Work System',
        'ESH Standard Practices',
        'Personal Protective Equipment (PPE), usage, limitation and proper disposal',
        'Weather (Disaster) Management',
        'Using of Electrical Power Tools including Electrical Safety',
        'Defensive Driving Seminar',
        'Confined Space and/or Tunneling Safety including Gas Test Awareness',
        'Spotter & Flagman Training',
        'Heavy Equipment Safety Training',
        'Safe Operation Procedure (SOP) for Retrieval & Rescue of Equipment/Vehicle Training',
    ],
    'esh-calendar-health': [
        'Hepatitis B (Viral Hepatitis Awareness Month)',
        'Heart Awareness',
        'Oral Health Awareness',
        'Tuberculosis Awareness',
        'Heat Stress Awareness',
        'Immunization Awareness Month, and Reiteration of Heat Stress Awareness',
        'Covid-19 Awareness',
        'Hypertension Awareness, and Reiteration of Heat Stress Awareness',
        'HIV-AIDS Awareness, and Reiteration of Heat Stress Awareness',
        'Water-born Disease Awareness',
        'Blood Donation Awareness',
        'Nutrition Awareness',
        'Diabetes Awareness',
        'Sight Saving Awareness',
        'Breastfeeding Awareness',
        'Generic Medicine Awareness',
        'Blood Disease Awareness',
        'Mental Health Awareness',
        'Breast Cancer Awareness',
        'Consciousness Against Counterfeit Medicine',
        'Anti-Sexual Harassment',
        'Ear, Nose, and Throat Consciousness',
    ],
};

const ESH_DRILLS = [
    { name:'Earthquake', freq:'Quarterly' },
    { name:'Fire', freq:'Quarterly' },
    { name:'Chemical and Oil Spillage', freq:'Twice a year' },
    { name:'Serious Injury', freq:'Once a year' },
    { name:'Death Cause by Accident', freq:'Once a year' },
    { name:'Death by Natural Cases', freq:'Once a year' },
    { name:'Medical Emergency', freq:'Twice a year' },
    { name:'Explosion', freq:'Once a year' },
    { name:'Bomb Threat', freq:'Once a year' },
    { name:'Un-exploded Ordnance', freq:'Once a year' },
    { name:'Weather Disturbance (Typhoons, Heavy Rains, Strong Winds and Flooding)', freq:'Quarterly' },
    { name:'Weather Emergency (Lightning)', freq:'Quarterly' },
    { name:'Confined Space and Tunnel Emergency', freq:'Twice a year' },
    { name:'Volcanic Eruption', freq:'Once a year' },
    { name:'Tsunami/Storm Surge', freq:'Once a year' },
    { name:'In case of active shooting', freq:'Once a year' },
    { name:'Riot', freq:'Once a year' },
    { name:'Workplace Violence', freq:'Once a year' },
    { name:'Labor Strike', freq:'Once a year' },
];

const TAB_COLORS = {
    'esh-calendar-env':    { header:'#1b5e20', light:'#e8f5e9', accent:'#2e7d32', icon:'fa-leaf', label:'ENVIRONMENT' },
    'esh-calendar-safety': { header:'#2e7d32', light:'#e8f5e9', accent:'#388e3c', icon:'fa-hard-hat', label:'SAFETY' },
    'esh-calendar-health': { header:'#1b5e20', light:'#e8f5e9', accent:'#2e7d32', icon:'fa-heart-pulse', label:'HEALTH' },
    'esh-calendar-drills': { header:'#2e7d32', light:'#e8f5e9', accent:'#388e3c', icon:'fa-person-running', label:'EMERGENCY DRILLS' },
};

// ==================== ESH CALENDAR FIREBASE REALTIME SYNC ====================
// ESH calendar data is stored in Firebase Realtime DB so ALL accounts see the same data instantly.
// Path: esh-calendar/data  (shared ‚Äî not per-user)

let _eshCalendarUnsubscribe = null; // holds the onValue unsubscribe fn

function getEshStorage() {
    try { return JSON.parse(localStorage.getItem('esh_calendar_data') || '{}'); } catch(e) { return {}; }
}

function setEshStorage(data) {
    // 1. Write to localStorage immediately (instant local render)
    localStorage.setItem('esh_calendar_data', JSON.stringify(data));

    // 2. Push to Firebase Realtime DB (broadcast to all accounts)
    _eshSaveToFirebase(data);
}

function _eshSaveToFirebase(data) {
    try {
        if (!window.firebaseRealtimeDb || !window.firebase || !window.firebase.dbRef || !window.firebase.set) return;
        _eshLastLocalWrite = Date.now(); // Mark that WE wrote this ‚Äî suppress self re-render
        const ref = window.firebase.dbRef(window.firebaseRealtimeDb, 'esh-calendar/data');
        window.firebase.set(ref, data).catch(e => console.warn('ESH calendar Firebase save failed:', e));
    } catch(e) { console.warn('ESH calendar Firebase save error:', e); }
}

// Call this once after login to start listening for remote changes from other accounts
let _eshLastLocalWrite = 0; // timestamp of last local write ‚Äî used to skip self-triggered re-renders

function startEshCalendarSync() {
    if (!window.firebaseRealtimeDb || !window.firebase || !window.firebase.dbRef || !window.firebase.onValue) return;
    if (_eshCalendarUnsubscribe) { try { _eshCalendarUnsubscribe(); } catch(e){} }

    const ref = window.firebase.dbRef(window.firebaseRealtimeDb, 'esh-calendar/data');
    _eshCalendarUnsubscribe = window.firebase.onValue(ref, (snapshot) => {
        const remoteData = snapshot.val();
        if (!remoteData || typeof remoteData !== 'object') return;

        // Merge remote into local
        const local = getEshStorage();
        const merged = Object.assign({}, local, remoteData);

        // Write merged back to localStorage silently (no Firebase re-push ‚Äî avoid loop)
        try { localStorage.setItem('esh_calendar_data', JSON.stringify(merged)); } catch(e){}

        // SKIP re-render if this update was triggered by OUR OWN write (within 2s)
        // eshSetPlan already does in-place DOM update ‚Äî no need to re-render
        const now = Date.now();
        if (now - _eshLastLocalWrite < 2000) return;

        // This is a REMOTE change from another account ‚Äî re-render table contents only
        // WITHOUT calling renderEshCalendar() which rebuilds the full HTML and collapses all regions
        const eshTabs = ['esh-calendar-env','esh-calendar-safety','esh-calendar-health','esh-calendar-drills'];
        if (state && eshTabs.includes(state.currentTab)) {
            const tabType = state.currentTab;
            const allProjects = (state && state.projects) ? state.projects : [];
            const regionOrder = ["NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
            regionOrder.forEach(region => {
                const regProjects = allProjects.filter(p => p.region === region);
                if (!regProjects.length) return;
                // Only re-render if the region content is currently VISIBLE (expanded)
                const safeRegion = region.replace(/[^a-z0-9]/gi, '_');
                const contentEl = document.getElementById(tabType + '-' + safeRegion + '-content');
                if (contentEl && contentEl.style.display !== 'none') {
                    const projIdx = _eshRegionProjectIdx[eshGetRegionKey(tabType, region)] || 0;
                    try { eshRenderRegionTable(tabType, region, regProjects, projIdx); } catch(e){}
                }
            });
        }
    }, (err) => { console.warn('ESH calendar sync error:', err); });

    console.log('‚úÖ ESH Calendar real-time sync started');
}
window.startEshCalendarSync = startEshCalendarSync;
// ==================== END ESH CALENDAR FIREBASE REALTIME SYNC ====================

// ‚îÄ‚îÄ Migrate old per-project plan keys -> new GLOBAL_PLAN keys ‚îÄ‚îÄ
// Old: "tabType|ProjectName|ti|mi|plan"  New: "tabType|GLOBAL_PLAN|ti|mi|plan"
function migrateEshPlanKeys() {
    if (localStorage.getItem('esh_plan_migrated_v2') === '1') return;
    try {
        const storage = getEshStorage();
        const newStorage = {};
        let migrated = 0;
        Object.entries(storage).forEach(function([key, val]) {
            const parts = key.split('|');
            if (parts.length === 5 && parts[4] === 'plan' && parts[1] !== 'GLOBAL_PLAN') {
                const globalKey = parts[0] + '|GLOBAL_PLAN|' + parts[2] + '|' + parts[3] + '|plan';
                if (!(globalKey in newStorage)) { newStorage[globalKey] = val; migrated++; }
            } else {
                newStorage[key] = val;
            }
        });
        if (migrated > 0) { setEshStorage(newStorage); console.log('ESH migration: ' + migrated + ' plan keys -> GLOBAL_PLAN'); }
        localStorage.setItem('esh_plan_migrated_v2', '1');
    } catch(e) { console.warn('ESH migration failed:', e); }
}
migrateEshPlanKeys();

// Expose to window so other parts of the app (e.g. render()) can access these
window.getEshStorage = getEshStorage;
window.ESH_DRILLS = ESH_DRILLS;
window.ESH_TRAININGS = ESH_TRAININGS;

function getEshKey(tabType, projName, trainIdx, monthIdx, field) {
    // Plans are GLOBAL (same for all projects) ‚Äî use shared key regardless of project name
    if (field === 'plan') {
        return `${tabType}|GLOBAL_PLAN|${trainIdx}|${monthIdx}|plan`;
    }
    // Actuals are per-project (each project records its own completion date)
    return `${tabType}|${projName}|${trainIdx}|${monthIdx}|${field}`;
}

function isMonthOverdue(monthIdx) {
    // monthIdx is 0-based (0=Jan). Month is overdue if it ENDED before today.
    const now = new Date();
    const curYear = now.getFullYear();
    const curMonth = now.getMonth(); // 0-based
    // For 2026: overdue if monthIdx < current month (e.g. Jan=0 < Feb=1)
    return (curYear > 2026) || (curYear === 2026 && monthIdx < curMonth);
}

function isMonthFuture(monthIdx) {
    // Cannot enter dates for future months
    const now = new Date();
    const curYear = now.getFullYear();
    const curMonth = now.getMonth(); // 0-based
    return (curYear < 2026) || (curYear === 2026 && monthIdx > curMonth);
}

// Get the max allowed date for a given month (last day of that month, or today if current month)
function getMaxDateForMonth(monthIdx) {
    const now = new Date();
    const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
    const curMonth = now.getMonth();
    const curYear = now.getFullYear();
    if (monthIdx === curMonth && curYear === 2026) {
        return today; // Can only enter up to today in current month
    }
    if (monthIdx < curMonth || curYear < 2026) {
        // Past month: allow any date within that month
        const lastDay = new Date(2026, monthIdx + 1, 0).getDate();
        const mm = String(monthIdx + 1).padStart(2, '0');
        return `2026-${mm}-${lastDay}`;
    }
    return ''; // Future month: no date allowed
}

function getMinDateForMonth(monthIdx) {
    const mm = String(monthIdx + 1).padStart(2, '0');
    return `2026-${mm}-01`;
}

// RBAC: Can this user input data for this tabType + region?
function eshCanEdit(tabType, projectRegion) {
    const email = state && state.currentUser ? state.currentUser.email : null;
    if (!email) return false;
    const info = UserAccounts.getUserInfo(email);

    // Admin: full access
    if (info.role === 'admin') return true;

    // Corporate region: Admin only ‚Äî block everyone else
    if (projectRegion === 'CORPORATE') return false;

    // Superintendent: only their region, ALL ESH calendar tabs
    if (info.role === 'superintendent') {
        return info.region === projectRegion;
    }

    // PCO: only env trainings tab + drills, only their region
    if (info.role === 'pco') {
        const pcoAllowed = ['esh-calendar-env', 'esh-calendar-drills'];
        return pcoAllowed.includes(tabType) && info.region === projectRegion;
    }

    return false;
}

// Track current project index per region per tabType
const _eshRegionProjectIdx = {};

function eshGetRegionKey(tabType, region) { return tabType + '|' + region; }

function eshNavigateProject(tabType, region, delta) {
    const key = eshGetRegionKey(tabType, region);
    const allProjects = (state && state.projects) ? state.projects : [];
    const regProjects = allProjects.filter(p => p.region === region);
    if (!regProjects.length) return;
    let cur = _eshRegionProjectIdx[key] || 0;
    cur = Math.max(0, Math.min(regProjects.length - 1, cur + delta));
    _eshRegionProjectIdx[key] = cur;
    eshRenderRegionTable(tabType, region, regProjects, cur);
}
window.eshNavigateProject = eshNavigateProject;

function eshToggleRegion(regionId) {
    const contentEl = document.getElementById(regionId);
    const icon = document.getElementById(regionId + '-icon');
    if (!contentEl) return;
    const wasCollapsed = contentEl.style.display === 'none';
    contentEl.style.display = wasCollapsed ? '' : 'none';
    if (icon) icon.style.transform = wasCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
    const banner = contentEl.previousElementSibling;
    if (banner) banner.style.borderRadius = wasCollapsed ? '8px 8px 0 0' : '8px';

    // When EXPANDING: re-render from latest storage so plan/overdue states are current
    if (wasCollapsed) {
        // Parse regionId: format is "tabType-safeRegion-content"
        // e.g. "esh-calendar-env-NCR-content" or "esh-calendar-env-SOUTH_LUZON-content"
        // We need to find tabType and region from the id
        const allProjects = (state && state.projects) ? state.projects : [];
        const regionOrder = ["CORPORATE", "NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
        const tabTypes = ['esh-calendar-env','esh-calendar-safety','esh-calendar-health','esh-calendar-drills'];
        tabTypes.forEach(function(tabType) {
            regionOrder.forEach(function(region) {
                const safeRegion = region.replace(/[^a-z0-9]/gi, '_');
                const expectedId = tabType + '-' + safeRegion + '-content';
                if (expectedId === regionId) {
                    const regProjects = allProjects.filter(function(p) { return p.region === region; });
                    if (!regProjects.length) return;
                    const projIdx = _eshRegionProjectIdx[eshGetRegionKey(tabType, region)] || 0;
                    eshRenderRegionTable(tabType, region, regProjects, projIdx);
                }
            });
        });
    }
}
window.eshToggleRegion = eshToggleRegion;

function eshRenderRegionTable(tabType, region, regProjects, projIdx) {
    const isDrills = tabType === 'esh-calendar-drills';
    const col = TAB_COLORS[tabType] || TAB_COLORS['esh-calendar-env'];
    const trainings = ESH_TRAININGS[tabType] || [];
    const storage = getEshStorage();
    const proj = regProjects[projIdx];
    const safeRegion = region.replace(/[^a-z0-9]/gi,'_');
    const tableContainerId = tabType + '-' + safeRegion + '-table';
    const container = document.getElementById(tableContainerId);
    if (!container || !proj) return;

    const navHtml = `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:${col.light};border-bottom:1px solid ${col.accent}33;">
            <button onclick="eshNavigateProject('${tabType}','${region}',-1)" ${projIdx===0?'disabled':''} style="background:${projIdx===0?'#ccc':col.header};color:white;border:none;border-radius:6px;padding:5px 14px;font-size:0.72rem;font-weight:700;opacity:${projIdx===0?'0.4':'1'};">
                <i class="fas fa-chevron-left"></i> Prev
            </button>
            <div style="text-align:center;">
                <div style="font-size:0.72rem;font-weight:800;color:${col.header};">
                    <i class="fas fa-building" style="margin-right:5px;"></i>${proj.name}
                </div>
                <div style="font-size:0.62rem;color:#888;margin-top:2px;">Project ${projIdx+1} of ${regProjects.length}</div>
            </div>
            <button onclick="eshNavigateProject('${tabType}','${region}',1)" ${projIdx===regProjects.length-1?'disabled':''} style="background:${projIdx===regProjects.length-1?'#ccc':col.header};color:white;border:none;border-radius:6px;padding:5px 14px;font-size:0.72rem;font-weight:700;opacity:${projIdx===regProjects.length-1?'0.4':'1'};">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>`;

    let tableHtml = '';
    if (isDrills) {
        tableHtml = buildDrillsSingleTable([proj], storage, col);
    } else {
        tableHtml = buildTrainingSingleTable(tabType, [proj], trainings, storage, col);
    }

    // Preserve scroll position of the overflow-x wrapper before re-rendering
    const existingWrapper = container.querySelector('div[style*="overflow-x"]');
    const savedScrollLeft = existingWrapper ? existingWrapper.scrollLeft : 0;

    container.innerHTML = navHtml + `<div class="esh-table-scroll" style="overflow-x:auto;">${tableHtml}</div>`;

    // Restore scroll position after render
    if (savedScrollLeft > 0) {
        const newWrapper = container.querySelector('.esh-table-scroll');
        if (newWrapper) newWrapper.scrollLeft = savedScrollLeft;
    }
}
window.eshRenderRegionTable = eshRenderRegionTable;

function renderEshCalendar(tabType) {
    const viewId = tabType + '-view';
    const container = document.getElementById(viewId);
    if (!container) return;

    const col = TAB_COLORS[tabType] || TAB_COLORS['esh-calendar-env'];
    const regionOrder = ["NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
    const allProjects = (state && state.projects) ? state.projects : [];

    let html = `<style>
    .esh-cal-wrap { padding: 16px 20px; }
    .esh-cal-header {
        background: linear-gradient(135deg, ${col.header} 0%, ${col.accent} 100%);
        border-radius: 10px; padding: 14px 20px; margin-bottom: 14px;
        display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    }
    .esh-cal-header-icon { font-size: 1.5rem; color: rgba(255,255,255,0.85); }
    .esh-cal-header-title { font-size: 0.95rem; font-weight: 800; color: white; letter-spacing: 0.5px; }
    .esh-cal-header-sub { font-size: 0.65rem; color: rgba(255,255,255,0.7); margin-top: 2px; }
    .esh-cal-legend {
        display: flex; gap: 16px; align-items: center; flex-wrap: wrap;
        padding: 10px 16px; background: var(--bg-card); border-radius: 8px;
        border: 1px solid var(--border-color); margin-bottom: 14px; font-size: 0.72rem;
    }
    .esh-cal-legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-secondary); }
    .esh-cal-legend-box { width: 16px; height: 12px; border-radius: 3px; }
    .esh-region-banner {
        background: ${col.header}; color: white;
        padding: 9px 16px; font-weight: 800; font-size: 0.82rem;
        letter-spacing: 0.8px; display: flex; align-items: center; gap: 8px;
        border-radius: 8px 8px 0 0; cursor: pointer; user-select: none;
        transition: background 0.2s;
    }
    .esh-region-banner:hover { background: ${col.accent}; }
    .esh-region-toggle { margin-left: auto; font-size: 0.8rem; transition: transform 0.25s; }
    .esh-region-content {
        border: 1px solid ${col.accent}44;
        border-top: none; border-radius: 0 0 8px 8px;
        overflow: hidden; margin-bottom: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    /* FIX: spacing between region blocks (banner + content together) */
    .esh-region-block { margin-bottom: 14px; }
    .esh-table {
        border-collapse: collapse; width: 100%;
        min-width: 1400px; font-size: 0.71rem;
        font-family: 'Inter', sans-serif;
    }
    .esh-table th {
        background: ${col.header}; color: white;
        padding: 7px 5px; border: 1px solid ${col.accent}44;
        font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.6px;
        font-weight: 700; text-align: center; white-space: nowrap;
    }
    .esh-table th.esh-th-name {
        text-align: left; min-width: 220px; padding: 7px 10px;
        position: sticky; left: 0; z-index: 4; background: ${col.header};
    }
    .esh-table th.esh-th-freq { min-width: 88px; }
    .esh-table th.esh-th-plan { color: #fbc02d; }
    .esh-table th.esh-th-actual { color: #a5d6a7; }
    .esh-table td {
        border: 1px solid var(--border-color);
        padding: 4px 5px; vertical-align: middle;
        background: var(--bg-card);
    }
    .esh-table tr:nth-child(even) td { background: var(--input-bg); }
    /* FIX: hover must NOT override filled colors ‚Äî lower specificity via :not() */
    .esh-table tr:hover td:not(.esh-planned):not(.esh-done):not(.esh-overdue) { background: ${col.light} !important; }
    .esh-table td.esh-td-name {
        font-size: 0.71rem; color: var(--text-primary);
        padding: 6px 10px; min-width: 220px;
        position: sticky; left: 0; z-index: 3;
        background: var(--bg-card); line-height: 1.4;
        border-right: 2px solid ${col.accent}44;
    }
    .esh-table tr:nth-child(even) td.esh-td-name { background: var(--input-bg); }
    .esh-table tr:hover td.esh-td-name { background: ${col.light} !important; }
    .esh-td-plan {
        background: rgba(251,192,45,0.08) !important; text-align: center;
        min-width: 50px; cursor: pointer; user-select: none;
        transition: background 0.15s;
    }
    .esh-td-plan:hover { background: rgba(251,192,45,0.22) !important; }
    /* FIX: solid yellow fill ‚Äî readable contrast */
    .esh-td-plan.esh-planned { background: #f9a825 !important; }
    .esh-td-plan.esh-planned:hover { background: #f57f17 !important; }
    .esh-td-plan.esh-plan-locked { cursor: not-allowed; opacity: 0.65; }
    .esh-td-plan.esh-plan-locked:hover { background: rgba(251,192,45,0.08) !important; }
    .esh-td-actual { min-width: 100px; text-align: center; }
    /* FIX: solid fills with full contrast ‚Äî no rgba transparency */
    .esh-td-actual.esh-done   { background: #2e7d32 !important; }
    .esh-td-actual.esh-overdue { background: #c62828 !important; }
    /* FIX: no red border ‚Äî fill color is enough */
    .esh-td-actual input[type="date"]:disabled { opacity: 0.4; cursor: not-allowed; background: transparent; }
    .esh-td-actual input[type="date"] {
        background: transparent; border: none;
        color: var(--text-primary); font-size: 0.66rem;
        width: 100%; padding: 2px; font-family: monospace;
    }
    /* FIX: white text on solid colored fills for maximum readability */
    .esh-td-actual.esh-done   input[type="date"] { color: #fff; font-weight: 700; }
    .esh-td-actual.esh-overdue input[type="date"] { color: #fff; font-weight: 700; }
    .esh-td-actual input[type="date"]::-webkit-calendar-picker-indicator { filter: opacity(0.5) invert(1); cursor: pointer; }
    .esh-td-actual.esh-done input[type="date"]::-webkit-calendar-picker-indicator,
    .esh-td-actual.esh-overdue input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) opacity(0.8); }
    .esh-freq-badge {
        display: inline-block; padding: 2px 7px; border-radius: 10px;
        font-size: 0.61rem; font-weight: 700; white-space: nowrap;
    }
    .esh-no-projects {
        padding: 36px 20px; text-align: center; color: var(--text-secondary);
        background: var(--bg-card); border-radius: 8px;
        border: 1px dashed var(--border-color); margin-bottom: 16px;
    }
    </style>
    <div class="esh-cal-wrap">
        <div class="esh-cal-header">
            <i class="fas ${col.icon} esh-cal-header-icon"></i>
            <div>
                <div class="esh-cal-header-title">2026 ESH CALENDAR ‚Äî ${col.label}</div>
                <div class="esh-cal-header-sub">Per Region ¬∑ Per Project ¬∑ Plan = Yellow ‚úì | Actual = Date Input (Green=Done, Red=Overdue) ¬∑ Plan applies to ALL projects</div>
            </div>
        </div>
        <div class="esh-cal-legend">
            <span style="font-weight:700;color:var(--text-primary);font-size:0.72rem;">LEGEND:</span>
            <div class="esh-cal-legend-item"><div class="esh-cal-legend-box" style="background:#fbc02d;"></div> Planned (applies to all projects)</div>
            <div class="esh-cal-legend-item"><div class="esh-cal-legend-box" style="background:#2e7d32;"></div> Actual ‚Äì Completed</div>
            <div class="esh-cal-legend-item"><div class="esh-cal-legend-box" style="background:#c62828;"></div> Actual ‚Äì Overdue / Not Yet Done</div>
            <div class="esh-cal-legend-item" style="margin-left:auto;"><i class="fas fa-chevron-down" style="color:${col.header};margin-right:4px;"></i> Click region banner to collapse/expand</div>
        </div>
    `;

    if (allProjects.length === 0) {
        html += `<div class="esh-no-projects">
            <i class="fas fa-folder-open" style="font-size:2rem;margin-bottom:10px;opacity:0.3;display:block;"></i>
            <strong>No projects found.</strong><br>
            <span style="font-size:0.75rem;">Add projects via the Overall Dashboard to see them here.</span>
        </div>`;
    }

    regionOrder.forEach(region => {
        const regProjects = allProjects.filter(p => p.region === region);
        if (regProjects.length === 0) return;
        const safeRegion = region.replace(/[^a-z0-9]/gi,'_');
        const regionContentId = tabType + '-' + safeRegion + '-content';
        const regionIconId = tabType + '-' + safeRegion + '-icon';
        const tableContainerId = tabType + '-' + safeRegion + '-table';
        const projIdx = _eshRegionProjectIdx[eshGetRegionKey(tabType, region)] || 0;

        html += `
        <div class="esh-region-block">
            <div class="esh-region-banner" onclick="eshToggleRegion('${regionContentId}')" style="border-radius:8px;">
                <i class="fas fa-location-dot"></i> ${region}
                <span style="background:rgba(255,255,255,0.18);padding:2px 10px;border-radius:10px;font-size:0.65rem;font-weight:700;margin-left:8px;">${regProjects.length} PROJECT${regProjects.length!==1?'S':''}</span>
                <i class="fas fa-chevron-down esh-region-toggle" id="${regionIconId}" style="transform:rotate(-90deg);"></i>
            </div>
            <div id="${regionContentId}" class="esh-region-content" style="display:none;">
                <div id="${tableContainerId}"></div>
            </div>
        </div>`;
    });

    html += `</div>`;
    container.innerHTML = html;

    // Now populate each region's table
    regionOrder.forEach(region => {
        const regProjects = allProjects.filter(p => p.region === region);
        if (regProjects.length === 0) return;
        const projIdx = _eshRegionProjectIdx[eshGetRegionKey(tabType, region)] || 0;
        eshRenderRegionTable(tabType, region, regProjects, projIdx);
    });
}

function buildTrainingSingleTable(tabType, projects, trainings, storage, col) {
    const canEdit = projects.length > 0 ? eshCanEdit(tabType, projects[0].region) : false;

    let html = `<table class="esh-table">
        <thead>
            <tr>
                <th class="esh-th-name" rowspan="2">Training / Awareness</th>`;
    ESH_MONTHS.forEach(m => {
        html += `<th colspan="2" style="text-align:center;border-left:2px solid rgba(255,255,255,0.15);">${m.substring(0,3)}</th>`;
    });
    html += `</tr><tr>`;
    ESH_MONTHS.forEach(() => {
        html += `<th class="esh-th-plan">Plan</th><th class="esh-th-actual">Actual</th>`;
    });
    html += `</tr></thead><tbody>`;

    projects.forEach(proj => {
        trainings.forEach((training, ti) => {
            html += `<tr><td class="esh-td-name">${training}</td>`;
            ESH_MONTHS.forEach((m, mi) => {
                const planKey = getEshKey(tabType, proj.name, ti, mi, 'plan');
                const actualKey = getEshKey(tabType, proj.name, ti, mi, 'actual');
                const isPlanned = !!(storage[planKey]);
                const actualVal = storage[actualKey] || '';
                const isFuture = isMonthFuture(mi);
                const overdue = isPlanned && !actualVal && isMonthOverdue(mi);
                const done = !!actualVal;
                const maxDate = getMaxDateForMonth(mi);
                const minDate = getMinDateForMonth(mi);
                // Disabled if: no edit rights, or future month
                // Plan column: Admin ONLY can set/unset the schedule
                const planDisabled = !(state && state.isAdmin) ? 'disabled title="üîí Admin lang ang pwedeng mag-set ng Plan/Schedule"' : '';
                const dateDisabled = (!canEdit || isFuture) ? `disabled title="${!canEdit ? 'üîí Read-only for your role/region' : 'üìÖ Cannot enter future dates'}"` : '';

                // Cell bg: red if planned+overdue, green if done, yellow if planned+current/past+no actual
                let actualClass = 'esh-td-actual';
                let actualBg = '';
                if (done) { actualClass += ' esh-done'; actualBg = ''; }
                else if (overdue) { actualClass += ' esh-overdue'; actualBg = ''; }

                html += `<td class="esh-td-plan${isPlanned?' esh-planned':''}${!(state && state.isAdmin)?' esh-plan-locked':''}"
                    data-tabtype="${tabType}" data-ti="${ti}" data-mi="${mi}"
                    onclick="event.stopPropagation();eshSetPlan('${tabType}','${proj.name}',${ti},${mi},null,this)"
                    title="${!(state && state.isAdmin) ? 'üîí Admin lang ang pwedeng mag-set ng Plan/Schedule' : isPlanned ? 'Click para i-unschedule' : 'Click para i-schedule'}">
                </td>`;
                html += `<td class="${actualClass}">
                    <input type="date" value="${actualVal}" ${dateDisabled}
                        ${maxDate ? `max="${maxDate}"` : ''} min="${minDate}"
                        onchange="eshSetActual('${tabType}','${proj.name}',${ti},${mi},this.value,this.closest('td'))">
                </td>`;
            });
            html += `</tr>`;
        });
    });

    html += `</tbody></table>`;
    return html;
}

function buildDrillsSingleTable(projects, storage, col) {
    const freqColors = { 'Once a year':'#bf360c', 'Twice a year':'#6a1b9a', 'Quarterly':'#1b5e20' };
    // PCO can edit drills too; superintendent can edit their own region's drills
    const canEdit = projects.length > 0 ? eshCanEdit('esh-calendar-drills', projects[0].region) : false;

    let html = `<table class="esh-table">
        <thead>
            <tr>
                <th class="esh-th-name" rowspan="2">Emergency Drill Type</th>
                <th class="esh-th-freq" rowspan="2" style="text-align:center;">Frequency</th>`;
    ESH_MONTHS.forEach(m => {
        html += `<th colspan="2" style="text-align:center;border-left:2px solid rgba(255,255,255,0.15);">${m.substring(0,3)}</th>`;
    });
    html += `</tr><tr>`;
    ESH_MONTHS.forEach(() => {
        html += `<th class="esh-th-plan">Plan</th><th class="esh-th-actual">Actual</th>`;
    });
    html += `</tr></thead><tbody>`;

    projects.forEach(proj => {
        ESH_DRILLS.forEach((drill, di) => {
            const fc = freqColors[drill.freq] || '#555';
            html += `<tr><td class="esh-td-name">${drill.name}</td>
            <td style="text-align:center;padding:4px 6px;">
                <span class="esh-freq-badge" style="background:${fc};color:white;">${drill.freq}</span>
            </td>`;
            ESH_MONTHS.forEach((m, mi) => {
                const tabType = 'esh-calendar-drills';
                const planKey = getEshKey(tabType, proj.name, di, mi, 'plan');
                const actualKey = getEshKey(tabType, proj.name, di, mi, 'actual');
                const isPlanned = !!(storage[planKey]);
                const actualVal = storage[actualKey] || '';
                const isFuture = isMonthFuture(mi);
                const overdue = isPlanned && !actualVal && isMonthOverdue(mi);
                const done = !!actualVal;
                const maxDate = getMaxDateForMonth(mi);
                const minDate = getMinDateForMonth(mi);
                // Plan column: Admin ONLY can set/unset the schedule
                const planDisabled = !(state && state.isAdmin) ? 'disabled title="üîí Admin lang ang pwedeng mag-set ng Plan/Schedule"' : '';
                const dateDisabled = (!canEdit || isFuture) ? `disabled title="${!canEdit ? 'üîí Read-only for your role/region' : 'üìÖ Cannot enter future dates'}"` : '';

                let actualClass = 'esh-td-actual';
                let actualBg = '';
                if (done) { actualClass += ' esh-done'; actualBg = ''; }
                else if (overdue) { actualClass += ' esh-overdue'; actualBg = ''; }

                html += `<td class="esh-td-plan${isPlanned?' esh-planned':''}${!(state && state.isAdmin)?' esh-plan-locked':''}"
                    data-tabtype="esh-calendar-drills" data-ti="${di}" data-mi="${mi}"
                    onclick="event.stopPropagation();eshSetPlan('esh-calendar-drills','${proj.name}',${di},${mi},null,this)"
                    title="${!(state && state.isAdmin) ? 'üîí Admin lang ang pwedeng mag-set ng Plan/Schedule' : isPlanned ? 'Click para i-unschedule' : 'Click para i-schedule'}">
                </td>`;
                html += `<td class="${actualClass}">
                    <input type="date" value="${actualVal}" ${dateDisabled}
                        ${maxDate ? `max="${maxDate}"` : ''} min="${minDate}"
                        onchange="eshSetActual('esh-calendar-drills','${proj.name}',${di},${mi},this.value,this.closest('td'))">
                </td>`;
            });
            html += `</tr>`;
        });
    });

    html += `</tbody></table>`;
    return html;
}

window.eshSetPlan = function(tabType, projName, ti, mi, _unused, tdEl) {
    // Plan column: ADMIN ONLY ‚Äî no superintendent/PCO can set the plan schedule
    if (!(state && state.isAdmin)) {
        showToast('üîí Admin lang ang pwedeng mag-set ng Plan/Schedule.', 'warning', 3000);
        return;
    }
    // RBAC: find the project's region and validate
    const allProjects = (state && state.projects) ? state.projects : [];
    const proj = allProjects.find(p => p.name === projName);
    if (proj && !eshCanEdit(tabType, proj.region)) {
        showToast('üîí Read-Only ‚Äî You cannot edit this region/tab.', 'warning', 3000);
        return;
    }

    // Toggle: read current state from storage then flip it
    const storage = getEshStorage();
    const key = getEshKey(tabType, projName, ti, mi, 'plan');
    const wasPlanned = !!(storage[key]);
    const nowPlanned = !wasPlanned;
    storage[key] = nowPlanned;
    setEshStorage(storage);

    // In-place DOM update: toggle ALL matching plan cells on the page
    // without re-rendering tables (which resets display:none and collapses regions)
    const planTitle = nowPlanned ? 'Click para i-unschedule' : 'Click para i-schedule';

    document.querySelectorAll(
        `.esh-td-plan[data-tabtype="${tabType}"][data-ti="${ti}"][data-mi="${mi}"]`
    ).forEach(cell => {
        cell.classList.toggle('esh-planned', nowPlanned);
        cell.title = planTitle;
    });

    // Also update clicked cell directly (safety fallback)
    if (tdEl) {
        tdEl.classList.toggle('esh-planned', nowPlanned);
        tdEl.title = planTitle;
    }
};

window.eshSetActual = function(tabType, projName, ti, mi, value, tdEl) {
    // RBAC: find the project's region and validate
    const allProjects = (state && state.projects) ? state.projects : [];
    const proj = allProjects.find(p => p.name === projName);
    if (proj && !eshCanEdit(tabType, proj.region)) {
        showToast('üîí Read-Only ‚Äî You cannot edit this region/tab.', 'warning', 3000);
        if (tdEl) { const inp = tdEl.querySelector('input[type="date"]'); if (inp) inp.value = ''; }
        return;
    }

    // Validate: cannot enter future dates
    if (value) {
        const today = new Date().toISOString().split('T')[0];
        if (value > today) {
            showToast('‚ö†Ô∏è Hindi pwedeng maglagay ng future na date. Ngayon lang o nakaraang petsa.', 'warning', 4000);
            if (tdEl) { const inp = tdEl.querySelector('input[type="date"]'); if (inp) inp.value = ''; }
            return;
        }
        // Also validate it's within the correct month
        const expectedYear = 2026;
        const expectedMonth = String(mi + 1).padStart(2, '0');
        const expectedPrefix = `${expectedYear}-${expectedMonth}`;
        if (!value.startsWith(expectedPrefix)) {
            showToast(`‚ö†Ô∏è Ang petsa ay dapat nasa tamang buwan (${ESH_MONTHS[mi]} 2026).`, 'warning', 4000);
            if (tdEl) { const inp = tdEl.querySelector('input[type="date"]'); if (inp) inp.value = ''; }
            return;
        }
    }

    const storage = getEshStorage();
    const actualKey = getEshKey(tabType, projName, ti, mi, 'actual');
    storage[actualKey] = value;
    setEshStorage(storage);

    // Update cell color in-place via CSS classes (no re-render = no scroll reset)
    if (tdEl) {
        tdEl.classList.remove('esh-done', 'esh-overdue');
        tdEl.style.background = ''; // Clear any inline override
        if (value) {
            tdEl.classList.add('esh-done');
            const inp = tdEl.querySelector('input[type="date"]');
            if (inp) { inp.style.color = '#fff'; inp.style.fontWeight = '700'; }
        } else {
            const planKey = getEshKey(tabType, projName, ti, mi, 'plan');
            const isPlanned = !!(storage[planKey]);
            if (isPlanned && isMonthOverdue(mi)) {
                tdEl.classList.add('esh-overdue');
                const inp = tdEl.querySelector('input[type="date"]');
                if (inp) { inp.style.color = '#fff'; inp.style.fontWeight = '700'; }
            } else {
                const inp = tdEl.querySelector('input[type="date"]');
                if (inp) { inp.style.color = ''; inp.style.fontWeight = ''; }
            }
        }
    }
};

// Close the try block opened at the start of renderEshCalendar
const _origRenderEshCalendar = renderEshCalendar;
window.renderEshCalendar = function(tabType) {
    try {
        _origRenderEshCalendar(tabType);
    } catch(eshErr) {
        console.error('‚ùå renderEshCalendar crashed:', eshErr);
        const _ec = document.getElementById(tabType + '-view');
        if (_ec) {
            _ec.innerHTML = `<div style="padding:40px;text-align:center;color:#c62828;">
                <i class="fas fa-triangle-exclamation" style="font-size:2rem;margin-bottom:12px;display:block;"></i>
                <div style="font-weight:700;margin-bottom:8px;">ESH Calendar Error ‚Äî ${eshErr.message}</div>
                <div style="font-size:0.8rem;color:#888;margin-bottom:16px;">Try switching to another tab or refreshing.</div>
                <button onclick="changeTab('overall')" style="padding:8px 20px;background:#2e7d32;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;">‚Ü© Go to Dashboard</button>
            </div>`;
        }
    }
};

})();
// ==================== END ESH CALENDAR & DRILLS MATRIX ====================

// ==================== LOGIN FLASH SCREEN ====================
let _flashTimer = null;
let _flashInterval = null;

function showLoginFlash(displayName) {
    const screen = document.getElementById('login-flash-screen');
    if (!screen) return;

    // Set welcome name
    const nameEl = document.getElementById('flash-welcome-name');
    if (nameEl) nameEl.textContent = `Welcome, ${displayName || 'ESH User'}!`;

    screen.classList.add('active');

    // Progress bar + countdown
    const DURATION = 20000; // 20 seconds
    const bar = document.getElementById('flash-progress-bar');
    const countdownEl = document.getElementById('flash-countdown');
    let elapsed = 0;
    const TICK = 100;

    _flashInterval = setInterval(() => {
        elapsed += TICK;
        const pct = Math.min((elapsed / DURATION) * 100, 100);
        if (bar) bar.style.width = pct + '%';
        const remaining = Math.ceil((DURATION - elapsed) / 1000);
        if (countdownEl) countdownEl.innerHTML = `Auto-closes in <strong style="color:rgba(255,255,255,0.75);">${remaining}s</strong>`;
        if (elapsed >= DURATION) dismissLoginFlash();
    }, TICK);
}

function dismissLoginFlash() {
    if (_flashInterval) { clearInterval(_flashInterval); _flashInterval = null; }
    if (_flashTimer)    { clearTimeout(_flashTimer);    _flashTimer = null; }
    const screen = document.getElementById('login-flash-screen');
    if (screen) {
        screen.style.transition = 'opacity 0.4s ease';
        screen.style.opacity = '0';
        setTimeout(() => {
            screen.classList.remove('active');
            screen.style.opacity = '';
            screen.style.transition = '';
        }, 400);
    }
}
// ==================== END LOGIN FLASH SCREEN ===========
    </script>
<!-- ==================== FLOATING EDIT/SAVE BUTTON ==================== -->
<button id="floating-edit-btn" class="floating-edit-btn" onclick="toggleEdit()" title="Edit Mode" style="display:none;">
    <i id="floating-edit-icon" class="fas fa-edit"></i>
    <span id="floating-edit-tooltip" class="edit-tooltip">Click to Edit</span>
</button>
    <div id="toast-container"></div>
</body>
</html>
