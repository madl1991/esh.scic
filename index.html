<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESH COMPLIANCE DASHBOARD - SCIC</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>


    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getDatabase, ref as dbRef, set, push, update, onValue, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‚ö†Ô∏è SECURITY WARNING: API Keys Exposed
        // Dapat gamitin ang Firebase Security Rules at gawing private ang sensitive credentials.
        // I-configure ang Firestore/Database rules sa Firebase Console para sa proper access control.
        const firebaseConfig = {
            apiKey: "AIzaSyBdqVEm3PWPuFTVbrxaP4JAZNXl2bmNUg4",
            authDomain: "esh-dashboard.firebaseapp.com",
            databaseURL: "https://esh-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "esh-dashboard",
            storageBucket: "esh-dashboard.firebasestorage.app",
            messagingSenderId: "121684914529",
            appId: "1:121684914529:web:d5292a3c30f1bba2959520",
            measurementId: "G-TXYB9T0T3W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const storage = getStorage(app);
        const realtimeDb = getDatabase(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseRealtimeDb = realtimeDb;
        window.firebase = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            sendPasswordResetEmail,
            doc,
            setDoc,
            getDoc,
            ref,
            uploadBytes,
            getDownloadURL,
            deleteObject,
            dbRef,
            set,
            push,
            update,
            remove,
            onValue,
            onDisconnect,
            serverTimestamp
        };

        console.log("‚úÖ Firebase initialized!");
    </script>
    <style>
        :root {
            --safety-green-grad: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            --header-grad: linear-gradient(90deg, #1b5e20 0%, #388e3c 100%);
            --safety-yellow: #fbc02d;
            --bg-body: #ced4da;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-card: #ffffff;
            --border-color: #eee;
            --table-header: #2e7d32;
            --input-bg: #fdfdfd;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --text-primary: #e4e4e4;
            --text-secondary: #b0b0b0;
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --border-color: #444;
            --table-header: #1b5e20;
            --input-bg: #3a3a3a;
        }

        /* ==================== SAFETY REMINDER CHARACTER ==================== */
        #safety-reminder-container {
            position: fixed;
            bottom: -300px;
            right: 30px;
            z-index: 9999;
            transition: bottom 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #safety-reminder-container.show {
            bottom: 30px;
        }

        .safety-character {
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        /* 3D Emoji Character */
        .character-emoji {
            font-size: 100px;
            animation: walk 0.6s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
            user-select: none;
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0px) rotate(-2deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        /* Speech Bubble */
        .reminder-bubble {
            background: white;
            padding: 20px 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 300px;
            max-width: 360px;
            position: relative;
            border: 3px solid #2e7d32;
        }

        body.dark-mode .reminder-bubble {
            background: #2d2d2d;
            color: #e4e4e4;
            border-color: #4caf50;
        }

        .reminder-bubble::before {
            content: '';
            position: absolute;
            bottom: 30px;
            right: -15px;
            width: 0;
            height: 0;
            border-left: 20px solid #2e7d32;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
        }

        body.dark-mode .reminder-bubble::before {
            border-left-color: #4caf50;
        }

        .reminder-bubble::after {
            content: '';
            position: absolute;
            bottom: 30px;
            right: -11px;
            width: 0;
            height: 0;
            border-left: 16px solid white;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        body.dark-mode .reminder-bubble::after {
            border-left-color: #2d2d2d;
        }

        .reminder-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .reminder-icon {
            font-size: 28px;
        }

        .reminder-title {
            font-weight: 700;
            font-size: 18px;
            color: #2e7d32;
        }

        body.dark-mode .reminder-title {
            color: #81c784;
        }

        .reminder-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }

        body.dark-mode .reminder-text {
            color: #e4e4e4;
        }

        .reminder-dismiss {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }

        .reminder-dismiss:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
        }

        body.dark-mode .reminder-dismiss {
            background: #4caf50;
        }

        body.dark-mode .reminder-dismiss:hover {
            background: #388e3c;
        }

        /* ==================== END SAFETY REMINDER CHARACTER ==================== */

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        /* Smooth scrolling for all devices */
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }
        
        body { 
            margin: 0; 
            background: var(--bg-body); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Prevent text selection on buttons for better UX */
        button,
        .btn,
        .nav-item {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #login-overlay {
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 40%, #2e7d32 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000; 
            padding: 20px;
            overflow: hidden;
        }

        /* Animated background circles */
        #login-overlay::before {
            content: '';
            position: absolute;
            top: -20%;
            right: -10%;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(251,192,45,0.15) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        #login-overlay::after {
            content: '';
            position: absolute;
            bottom: -25%;
            left: -15%;
            width: 700px;
            height: 700px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-30px, -40px) scale(1.05); }
            50% { transform: translate(20px, 30px) scale(0.95); }
            75% { transform: translate(-20px, 20px) scale(1.02); }
        }

        /* Safety & Health Background Icons */
        .safety-bg-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.06;
            overflow: hidden;
        }

        .safety-icon-float {
            position: absolute;
            font-size: 80px;
            color: #ffffff;
            animation: floatIcon 15s ease-in-out infinite;
        }

        .safety-icon-float:nth-child(1) {
            top: 10%;
            left: 8%;
            animation-delay: 0s;
            animation-duration: 18s;
        }

        .safety-icon-float:nth-child(2) {
            top: 15%;
            right: 12%;
            animation-delay: 2s;
            animation-duration: 22s;
        }

        .safety-icon-float:nth-child(3) {
            bottom: 20%;
            left: 15%;
            animation-delay: 4s;
            animation-duration: 20s;
        }

        .safety-icon-float:nth-child(4) {
            bottom: 15%;
            right: 10%;
            animation-delay: 1s;
            animation-duration: 19s;
        }

        .safety-icon-float:nth-child(5) {
            top: 50%;
            left: 5%;
            animation-delay: 3s;
            animation-duration: 21s;
        }

        .safety-icon-float:nth-child(6) {
            top: 45%;
            right: 8%;
            animation-delay: 5s;
            animation-duration: 17s;
        }

        @keyframes floatIcon {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.06;
            }
            25% {
                transform: translateY(-30px) rotate(5deg);
                opacity: 0.08;
            }
            50% {
                transform: translateY(-20px) rotate(-5deg);
                opacity: 0.04;
            }
            75% {
                transform: translateY(-35px) rotate(3deg);
                opacity: 0.07;
            }
        }

        /* Active Users Pulse Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.3);
            }
        }

        /* Construction/Safety Pattern Overlay */
        .safety-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.04;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(251, 192, 45, 0.3) 10px,
                    rgba(251, 192, 45, 0.3) 12px
                ),
                repeating-linear-gradient(
                    -45deg,
                    transparent,
                    transparent 10px,
                    rgba(251, 192, 45, 0.3) 10px,
                    rgba(251, 192, 45, 0.3) 12px
                );
            background-size: 100px 100px;
            background-position: 0 0, 50px 50px;
        }

        /* Warning Stripes Accent (bottom) */
        .warning-stripe {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                45deg,
                #fbc02d,
                #fbc02d 20px,
                #1b5e20 20px,
                #1b5e20 40px
            );
            opacity: 0.7;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 35px 35px;
            border-radius: 20px;
            width: 100%;
            max-width: 460px;
            position: relative;
            z-index: 1;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 -5px 30px rgba(251, 192, 45, 0.2) inset;
            border-top: 4px solid #fbc02d;
            color: var(--text-primary);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tab entrance animation - Slide from Right */
        @keyframes slideRight {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        body.dark-mode .login-card {
            background: rgba(45, 45, 45, 0.95);
        }

        .login-header {
            position: relative;
            margin-bottom: 25px;
            text-align: center;
        }

        .login-shield {
            width: 70px;
            height: 70px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 50%, #2e7d32 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(27, 94, 32, 0.4),
                0 0 0 8px rgba(251, 192, 45, 0.1);
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 
                    0 10px 30px rgba(27, 94, 32, 0.4),
                    0 0 0 8px rgba(251, 192, 45, 0.1);
            }
            50% {
                box-shadow: 
                    0 15px 40px rgba(27, 94, 32, 0.6),
                    0 0 0 12px rgba(251, 192, 45, 0.2);
            }
        }

        .login-shield::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbc02d, transparent, #fbc02d);
            opacity: 0.4;
            z-index: -1;
            animation: rotate 8s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .login-shield i {
            font-size: 2.5rem;
            color: #fbc02d;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .login-title {
            color: #1b5e20;
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: 0.8px;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            text-align: center;
        }

        .login-subtitle {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 0 8px 0;
            letter-spacing: 0.5px;
            text-align: center;
        }

        body.dark-mode .login-subtitle {
            color: #999;
        }

        .login-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%);
            color: #1b5e20;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 5px 16px;
            border-radius: 20px;
            letter-spacing: 1px;
            margin-top: 5px;
            box-shadow: 0 2px 8px rgba(251, 192, 45, 0.3);
        }

        .login-form {
            margin-top: 30px;
        }

        .login-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .login-input-group i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #2e7d32;
            font-size: 1rem;
            z-index: 1;
        }

        .login-card input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.95rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .login-card input:focus {
            outline: none;
            border-color: #2e7d32;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .login-card input::placeholder {
            color: #999;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            margin-top: 25px;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(27, 94, 32, 0.3);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(27, 94, 32, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: wait;
            transform: none;
        }

        .disclaimer-box {
            background: linear-gradient(135deg, #fffbea 0%, #fff9e6 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            padding: 16px;
            margin-top: 30px;
            font-size: 0.75rem;
            color: #333;
            line-height: 1.6;
            position: relative;
            overflow: hidden;
            text-align: justify;
        }

        .disclaimer-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #fbc02d;
        }

        body.dark-mode .disclaimer-box {
            background: linear-gradient(135deg, #4a4a2d 0%, #3d3d25 100%);
            color: #e4e4e4;
        }

        .disclaimer-box strong {
            color: #1b5e20;
            font-size: 0.8rem;
        }

        body.dark-mode .disclaimer-box strong {
            color: #fbc02d;
        }

        /* ============================================
           RESPONSIVE DESIGN - MOBILE FIRST
           ============================================ */

        /* Tablet Styles (768px and below) - REMOVED */

        /* Small Mobile Styles (480px and below) - REMOVED */

        /* Large Desktop (1920px and above) */
        @media screen and (min-width: 1920px) {
            aside {
                width: 300px;
            }

            .login-card {
                max-width: 550px;
                padding: 60px 50px;
            }

            .header-title {
                font-size: 1.3rem;
            }

            .project-row {
                padding: 15px 20px;
            }

            .region-banner {
                padding: 20px 25px;
            }
        }

        /* Landscape Mode Adjustments */
        @media screen and (max-height: 600px) and (orientation: landscape) {
            .login-card {
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .login-shield {
                width: 60px;
                height: 60px;
            }

            .login-shield i {
                font-size: 1.8rem;
            }

            .login-title {
                font-size: 1rem;
                margin-bottom: 5px;
            }

            .login-subtitle {
                font-size: 0.75rem;
            }

            .disclaimer-box {
                margin-top: 15px;
                padding: 10px;
            }
        }

        /* Print Styles */
        @media print {
            aside,
            .mobile-menu-toggle,
            .theme-toggle,
            header .header-controls,
            .btn {
                display: none !important;
            }

            main {
                margin-left: 0;
            }

            body {
                background: white;
                color: black;
            }

            .project-row {
                page-break-inside: avoid;
                border: 1px solid #ccc;
            }
        }

        /* Reduce Motion for Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            body {
                background: white;
                color: black;
            }

            .btn-primary {
                background: #006400;
                border: 2px solid black;
            }

            .project-row {
                border: 2px solid black;
            }
        }

        /* Firebase init loading overlay */
        #firebase-loading-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            display: flex; align-items: center; justify-content: center; z-index: 20000; flex-direction: column; gap: 20px;
        }
        /* Shield Pulse Loader */
        #firebase-loading-overlay .shield-loader {
            width: 80px; 
            height: 80px; 
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: shieldPulse 1.5s ease-in-out infinite;
        }
        
        #firebase-loading-overlay .shield-loader i {
            font-size: 60px;
            color: #fbc02d;
            filter: drop-shadow(0 0 20px rgba(251, 192, 45, 0.6));
            animation: shieldGlow 2s ease-in-out infinite;
        }
        
        @keyframes shieldPulse {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.1);
            }
        }
        
        @keyframes shieldGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(251, 192, 45, 0.6));
                color: #fbc02d;
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(251, 192, 45, 0.9));
                color: #fdd835;
            }
        }
        
        #firebase-loading-overlay p {
            color: #a5d6a7; font-size: 0.95rem; font-weight: 700; letter-spacing: 1.5px; margin: 0;
            text-shadow: 0 0 10px rgba(165, 214, 167, 0.5);
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
            border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px;
        }

        aside {
            width: 260px; 
            background: linear-gradient(180deg, #1b5e20 0%, #2e7d32 50%, #43a047 100%);
            color: white;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            overflow-y: auto;
            padding: 20px 15px;
        }

        .sidebar-header { 
            padding-bottom: 20px; 
            margin-bottom: 20px;
            text-align: center; 
        }
        .nav-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.75rem;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            pointer-events: auto !important;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-item:hover { 
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        .nav-item.active { 
            background: linear-gradient(135deg, #fbc02d, #f57f17);
            color: #1b5e20;
            border-left: 3px solid #fff;
            font-weight: 700;
        }
        
        /* Collapsible Navigation Groups */
        .nav-group {
            margin-bottom: 5px;
        }
        
        .nav-group-header {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 12px;
            margin-bottom: 3px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.65rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s;
            user-select: none;
        }
        
        .nav-group-header:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .nav-group-header i.chevron {
            font-size: 0.7rem;
            transition: transform 0.3s;
        }
        
        .nav-group-header.collapsed i.chevron {
            transform: rotate(-90deg);
        }
        
        .nav-group-items {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
        }
        
        .nav-group-items.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .nav-group-items .nav-item {
            padding-left: 25px;
            font-size: 0.72rem;
        }
        
        main { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; background: var(--bg-body); }
        
        header {
            background: var(--bg-card); padding: 12px 15px; border-bottom: 1px solid var(--border-color); position: sticky;
            top: 0; z-index: 90; display: flex; gap: 15px; align-items: center; justify-content: space-between;
            flex-wrap: wrap;
        }

        .header-title { font-size: 1.1rem; color: #1b5e20; font-weight: 600; }
        .header-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .header-controls input, .header-controls select {
            padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;
            background: var(--input-bg); color: var(--text-primary);
        }

        /* Dark Mode Toggle Button */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1rem;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }


        /* Year Selector Styles */
        .year-selector-container {
            position: relative;
            display: inline-block;
        }

        .year-selector-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .year-selector-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           UNIFIED DROPDOWN SYSTEM ‚Äî Option B Style
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .year-dropdown,
        .device-dropdown,
        .users-dropdown,
        .notification-dropdown,
        .settings-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06);
            z-index: 1000;
            overflow: hidden;
            animation: dropdownSlideIn 0.2s ease-out;
        }

        body.dark-mode .year-dropdown,
        body.dark-mode .device-dropdown,
        body.dark-mode .users-dropdown,
        body.dark-mode .notification-dropdown,
        body.dark-mode .settings-dropdown {
            box-shadow: 0 8px 30px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Shared header */
        .ud-header {
            padding: 13px 15px 11px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ud-header-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: #e8f5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        body.dark-mode .ud-header-icon { background: rgba(46,125,50,0.2); }
        .ud-header-icon i { color: #2e7d32; font-size: 0.75rem; }
        body.dark-mode .ud-header-icon i { color: #66bb6a; }
        .ud-header-text { font-size: 0.82rem; font-weight: 700; color: var(--text-primary); }
        .ud-header-sub  { font-size: 0.67rem; color: var(--text-secondary); margin-top: 1px; }

        /* Shared item */
        .ud-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .ud-item:hover { background: #f0f7f0; }
        body.dark-mode .ud-item:hover { background: rgba(46,125,50,0.12); }
        .ud-item-icon {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        .ud-item-label { flex: 1; font-size: 0.8rem; font-weight: 500; color: var(--text-primary); }
        .ud-item-arrow { font-size: 0.58rem; color: #ccc; }
        .ud-divider { height: 1px; background: var(--border-color); margin: 4px 0; }
        .ud-body { padding: 8px; }

        /* Logout item */
        .ud-item.logout .ud-item-label { color: #c62828; }
        .ud-item.logout .ud-item-icon  { background: #fff0f0 !important; }
        .ud-item.logout .ud-item-icon i { color: #c62828 !important; }
        .ud-item.logout:hover { background: #fff5f5; }
        body.dark-mode .ud-item.logout:hover { background: rgba(198,40,40,0.12); }

        /* Year sizing */
        .year-dropdown { min-width: 160px; }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Year options */

        .year-options {
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .year-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 7px;
            margin: 2px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: background 0.15s;
        }

        .year-option:hover { background: #f0f7f0; }
        body.dark-mode .year-option:hover { background: rgba(46,125,50,0.12); }

        .year-option.active {
            background: #e8f5e9;
            color: #1b5e20;
            font-weight: 700;
        }

        body.dark-mode .year-option.active {
            background: rgba(46,125,50,0.2);
            color: #66bb6a;
        }

        .year-add-btn {
            width: 100%;
            padding: 9px;
            background: none;
            border: none;
            border-top: 1px solid var(--border-color);
            color: #2e7d32;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: inherit;
        }

        .year-add-btn:hover { background: #f0f7f0; }
        body.dark-mode .year-add-btn { color: #66bb6a; }
        body.dark-mode .year-add-btn:hover { background: rgba(46,125,50,0.12); }


        /* ========== DEVICE COUNTER & ACTIVE USERS ========== */
        .device-counter-container,
        .active-users-container {
            position: relative;
            display: inline-block;
        }

        .device-counter-btn,
        .active-users-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .device-counter-btn:hover,
        .active-users-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .counter-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #2e7d32;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0 4px;
        }

        .device-dropdown,
        .users-dropdown { min-width: 300px; max-width: 380px; }

        .dropdown-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 8px;
        }

        /* dropdown-item: used by device & users rendered lists */
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 7px;
            margin: 2px 0;
            transition: background 0.15s;
        }

        .dropdown-item:hover { background: #f0f7f0; }
        body.dark-mode .dropdown-item:hover { background: rgba(46,125,50,0.12); }

        /* device item inner */
        .device-info { display: flex; align-items: center; gap: 10px; flex: 1; }

        .device-icon-box {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            background: #e8f5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        body.dark-mode .device-icon-box { background: rgba(46,125,50,0.2); }

        .device-icon { font-size: 0.82rem; color: #2e7d32; }
        body.dark-mode .device-icon { color: #66bb6a; }

        .device-details { flex: 1; }
        .device-name { font-weight: 600; font-size: 0.78rem; color: var(--text-primary); margin-bottom: 1px; }
        .device-meta  { font-size: 0.68rem; color: var(--text-secondary); }

        /* user item inner */
        .user-info { display: flex; align-items: center; gap: 10px; flex: 1; }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.72rem;
            color: white;
            flex-shrink: 0;
        }

        .user-details { flex: 1; }
        .user-name     { font-weight: 600; font-size: 0.78rem; color: var(--text-primary); margin-bottom: 1px; }
        .user-activity { font-size: 0.68rem; color: var(--text-secondary); margin-bottom: 3px; }

        .user-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status-online  { background: #e8f5e9; color: #2e7d32; }
        .status-idle    { background: #fff8e1; color: #f57c00; }
        .status-offline { background: #fce4ec; color: #c62828; }

        body.dark-mode .status-online  { background: rgba(76,175,80,0.2);  color: #81c784; }
        body.dark-mode .status-idle    { background: rgba(255,152,0,0.2);   color: #ffb74d; }
        body.dark-mode .status-offline { background: rgba(244,67,54,0.2);   color: #e57373; }


        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online .status-indicator {
            background: #2e7d32;
        }

        .status-idle .status-indicator {
            background: #f57c00;
        }

        .status-offline .status-indicator {
            background: #c62828;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dropdown-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .dropdown-empty i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* ========== NOTIFICATION BELL DROPDOWN ========== */
        .notification-bell-container {
            position: relative;
            display: inline-block;
        }

        .notification-bell-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            position: relative;
        }

        .notification-bell-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #d32f2f;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .notification-dropdown {
            min-width: 320px;
            max-width: 380px;
        }

        .notification-list {
            max-height: 380px;
            overflow-y: auto;
            padding: 5px;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-item:last-child { border-bottom: none; }

        .notification-item:hover { background: #f0f7f0; }
        body.dark-mode .notification-item:hover { background: rgba(46,125,50,0.12); }

        .notif-icon-box {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            background: #fff3e0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .notif-icon-box i { font-size: 0.72rem; color: #e65100; }

        .notification-project {
            font-weight: 700;
            color: #c62828;
            font-size: 0.78rem;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-empty {
            padding: 30px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .notification-empty i {
            font-size: 2.5rem;
            color: #4caf50;
            margin-bottom: 10px;
            display: block;
        }

        /* ========== DEVICE COUNTER & ACTIVE USERS (ADMIN ONLY) ========== */
        .device-counter-container,
        .active-users-container {
            position: relative;
            display: inline-block;
        }

        .device-counter-btn,
        .active-users-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .device-counter-btn:hover,
        .active-users-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .device-count,
        .users-count {
            background: #2e7d32;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .device-dropdown,
        .active-users-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-card);
            border: 2px solid #2e7d32;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(46, 125, 50, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            overflow: hidden;
            animation: dropdownSlideIn 0.2s ease-out;
        }

        .device-dropdown-header,
        .active-users-dropdown-header {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            padding: 12px 15px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-list,
        .active-users-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 5px;
        }

        .device-item,
        .active-user-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .device-item:hover,
        .active-user-item:hover {
            background: #e8f5e9;
        }

        body.dark-mode .device-item:hover,
        body.dark-mode .active-user-item:hover {
            background: rgba(27, 94, 32, 0.15);
        }

        .device-item:last-child,
        .active-user-item:last-child {
            border-bottom: none;
        }

        .device-platform {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-details {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .user-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online {
            background: #4caf50;
            box-shadow: 0 0 6px #4caf50;
        }

        .status-idle {
            background: #ff9800;
        }

        .status-offline {
            background: #9e9e9e;
        }

        .user-activity {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-activity-icon {
            font-size: 0.7rem;
        }

        /* ========== SETTINGS DROPDOWN (FACEBOOK STYLE) ========== */
        .settings-dropdown-container {
            position: relative;
            display: inline-block;
        }

        .settings-dropdown-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .settings-dropdown-btn:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        .settings-dropdown { min-width: 230px; }

        /* settings-menu-item kept for backwards compat but now uses ud-item style */
        .settings-menu { padding: 8px; }

        .settings-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-menu-item:hover { background: #f0f7f0; }
        body.dark-mode .settings-menu-item:hover { background: rgba(46,125,50,0.12); }

        .settings-menu-item .smi-icon {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .settings-menu-item .smi-label { flex: 1; }
        .settings-menu-item .smi-arrow { font-size: 0.58rem; color: #ccc; }

        .settings-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

        .settings-menu-item.logout { color: #c62828; }
        .settings-menu-item.logout .smi-icon { background: #fff0f0 !important; }
        .settings-menu-item.logout .smi-icon i { color: #c62828 !important; }
        .settings-menu-item.logout:hover { background: #fff5f5; }
        body.dark-mode .settings-menu-item.logout:hover { background: rgba(198,40,40,0.12); }

        /* ========== FLOATING EDIT/SAVE BUTTON ========== */
        .floating-edit-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: rgba(46, 125, 50, 0.9);
            border: 3px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 
                        0 0 0 0 rgba(46, 125, 50, 0.7);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
        }

        .floating-edit-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.4),
                        0 0 0 10px rgba(46, 125, 50, 0.2);
            background: rgba(46, 125, 50, 1);
        }

        .floating-edit-btn:active {
            transform: scale(0.95);
        }

        .floating-edit-btn.save-mode {
            background: rgba(251, 192, 45, 0.95);
        }

        .floating-edit-btn.save-mode:hover {
            background: rgba(251, 192, 45, 1);
            box-shadow: 0 6px 30px rgba(251, 192, 45, 0.5),
                        0 0 0 10px rgba(251, 192, 45, 0.2);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3),
                            0 0 0 0 rgba(251, 192, 45, 0.7);
            }
            50% { 
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3),
                            0 0 20px 10px rgba(251, 192, 45, 0.4);
            }
        }

        .floating-edit-btn .edit-tooltip {
            position: absolute;
            right: 75px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .floating-edit-btn:hover .edit-tooltip {
            opacity: 1;
        }

        .floating-edit-btn .edit-tooltip::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid rgba(0, 0, 0, 0.8);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        body.dark-mode .floating-edit-btn {
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Save button with Firebase sync indicator */
        .btn-primary.saving {
            background: #666;
            cursor: wait;
        }

        .btn-primary .save-icon {
            font-size: 1rem;
            margin-right: 5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }


        .btn {
            padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600;
            font-size: 0.75rem; white-space: nowrap;
        }
        .btn-primary { background: var(--safety-green-grad); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background: #ccc; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-danger:hover { background: #b71c1c; }

        /* PDF Upload Styles */
        .pdf-upload-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }
        .pdf-upload-btn {
            padding: 6px 12px;
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        .pdf-upload-btn:hover {
            background: #1565C0;
        }
        .pdf-upload-btn i {
            font-size: 0.8rem;
        }
        .pdf-view-btn {
            padding: 6px 12px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            transition: background 0.2s;
        }
        .pdf-view-btn:hover {
            background: #1b5e20;
        }
        .pdf-replace-btn {
            padding: 6px 10px;
            background: #f57c00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        .pdf-replace-btn:hover {
            background: #e65100;
        }
        .pdf-delete-btn {
            padding: 6px 10px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        .pdf-delete-btn:hover {
            background: #b71c1c;
        }
        .pdf-filename {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-style: italic;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .region-banner {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #43a047 100%);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 20px 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            user-select: none;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            color: white;
            font-weight: 700;
            flex-wrap: wrap;
        }
        
        /* Glass effect overlay */
        .region-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Ensure content is above glass effect */
        .region-banner > * {
            position: relative;
            z-index: 2;
        }
        
        .region-banner:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 32px rgba(46, 125, 50, 0.3);
        }
        
        .region-banner.collapsed {
            margin-bottom: 10px;
        }
        
        .region-toggle-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 10px;
            font-size: 0.9rem;
            will-change: transform;
        }
        
        .region-banner.collapsed .region-toggle-icon {
            transform: rotate(-180deg);
        }
        
        .region-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease;
            opacity: 1;
            will-change: max-height, opacity;
        }
        
        .region-content.collapsed {
            max-height: 0;
            opacity: 0;
            transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease;
        }
        
        /* Region banner left section */
        .region-banner > div:first-child {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Region banner right section */
        .region-banner > div:last-child {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* Glass effect for AVG badge */
        .region-banner .badge[style*="background:#1b5e20"] {
            background: rgba(255,255,255,0.15) !important;
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
        }
        .badge { background: var(--safety-yellow); color: #1b5e20; padding: 4px 12px;
            border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .sort-select {
            background: rgba(255,255,255,0.2); color: white; padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 4px;
        }
        .sort-select option { background: #1b5e20; color: white; }

        .project-row {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(241, 248, 233, 0.3) 100%);
            border: 1px solid var(--border-color); 
            padding: 14px 18px; 
            border-radius: 10px;
            margin: 0 20px 10px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .project-row {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(31, 46, 31, 0.5) 100%);
        }
        
        /* Phase 3: Regional Locking - Locked Project Styling */
        .project-locked {
            opacity: 0.7;
            background: linear-gradient(135deg, rgba(245, 245, 245, 0.5) 0%, rgba(224, 224, 224, 0.3) 100%) !important;
            border: 1px dashed #bdbdbd !important;
        }
        
        body.dark-mode .project-locked {
            background: linear-gradient(135deg, rgba(60, 60, 60, 0.5) 0%, rgba(45, 45, 45, 0.3) 100%) !important;
            border: 1px dashed #666 !important;
        }
        
        .project-locked .project-checkbox {
            cursor: not-allowed;
        }
        
        .project-locked .status-badge {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .project-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .circular-progress {
            width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; 
            background: conic-gradient(
                from 0deg,
                #1b5e20 0deg,
                #2e7d32 calc(var(--percentage) * 0.5),
                #4caf50 var(--percentage),
                #e0e0e0 var(--percentage)
            );
            box-shadow: 0 3px 12px rgba(27, 94, 32, 0.3), 
                        inset 0 0 0 2px rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            position: relative;
        }
        
        .circular-progress::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
            pointer-events: none;
        }
        
        .circular-progress-inner {
            width: 46px; height: 46px; border-radius: 50%; background: var(--bg-card); display: flex;
            align-items: center; justify-content: center; font-weight: 800; font-size: 0.82rem; 
            color: #1b5e20;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        
        body.dark-mode .circular-progress-inner {
            color: #66bb6a;
        }
        .project-info { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; min-width: 150px; }
        .project-name { 
            font-size: 0.95rem; 
            font-weight: 700; 
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        .project-meta { 
            font-size: 0.68rem; 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .project-dates { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            min-width: 200px; 
            font-size: 0.68rem;
            background: rgba(76, 175, 80, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 2px solid #4caf50;
        }
        
        .project-dates > div {
            display: flex;
            align-items: center;
        }
        
        body.dark-mode .project-dates {
            background: rgba(76, 175, 80, 0.1);
        }
        
        .date-label { 
            font-weight: 700; 
            color: #1b5e20;
            text-transform: uppercase;
            font-size: 0.6rem;
            letter-spacing: 0.3px;
            display: inline-block;
            width: 75px;
            flex-shrink: 0;
        }
        
        body.dark-mode .date-label {
            color: #66bb6a;
        }
        .status-badge {
            padding: 8px 12px; 
            border-radius: 6px; 
            color: white; 
            font-weight: 700; 
            font-size: 0.6rem;
            cursor: pointer; 
            text-transform: uppercase; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
            min-width: 130px;
            text-align: center;
        }
        
        .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        }
        
        .status-ongoing { 
            background: linear-gradient(135deg, #1565c0 0%, #1976D2 100%);
        }
        
        .status-stoppage { 
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
        }
        
        .status-finished { 
            background: linear-gradient(135deg, #424242 0%, #616161 100%);
        }

        /* ==================== MODAL STYLE 5 DESIGN ==================== */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0; 
            width: 100%;
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            align-items: center; 
            justify-content: center;
            animation: fadeIn 0.2s;
            padding: 20px;
        }
        .modal.show { 
            display: flex; 
        }
        .modal-content {
            background: var(--bg-card); 
            padding: 40px 35px 35px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25); 
            color: var(--text-primary);
            animation: scaleIn 0.3s;
            position: relative;
        }
        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #2e7d32;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #1b5e20;
        }
        .modal-header { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            margin-bottom: 8px;
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
        }
        .modal-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            margin: 0 auto 20px;
            box-shadow: 0 5px 20px rgba(46, 125, 50, 0.3);
        }
        .modal-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 25px;
        }
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 1.8rem; 
            cursor: pointer; 
            color: var(--text-secondary);
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: rgba(0,0,0,0.1);
            color: var(--text-primary);
        }
        body.dark-mode .modal-close:hover {
            background: rgba(255,255,255,0.1);
        }
        .form-group { 
            margin-bottom: 18px; 
        }
        .form-group label { 
            display: block; 
            font-size: 0.85rem; 
            font-weight: 600; 
            margin-bottom: 6px; 
            color: var(--text-primary); 
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 0.9rem;
            background: var(--input-bg); 
            color: var(--text-primary);
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; 
            border-color: #2e7d32; 
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .error-message { color: #d32f2f; font-size: 0.8rem; margin-top: 10px; }
        .success-message { color: #1b5e20; font-size: 0.8rem; margin-top: 10px; font-weight: 600; }
        .hidden { display: none !important; }

        /* ==================== CUSTOM CONFIRMATION MODAL ==================== */
        .confirm-modal-icon.warning {
            background: linear-gradient(135deg, #f57c00, #ff9800);
            box-shadow: 0 5px 20px rgba(245, 124, 0, 0.3);
        }
        
        .confirm-modal-content {
            background: var(--bg-card);
            padding: 35px 30px 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            color: var(--text-primary);
            animation: scaleIn 0.3s;
            position: relative;
        }

        .confirm-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .confirm-modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 15px 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirm-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .confirm-modal-body {
            background: rgba(255, 152, 0, 0.08);
            border-left: 4px solid #ff9800;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        body.dark-mode .confirm-modal-body {
            background: rgba(255, 152, 0, 0.12);
        }

        .confirm-modal-body ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .confirm-modal-body li {
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .confirm-modal-body li::before {
            content: "‚Ä¢";
            color: #ff9800;
            font-size: 1.2rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .confirm-modal-question {
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-modal-buttons .btn {
            flex: 1;
            max-width: 180px;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .confirm-modal-buttons .btn-cancel {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .confirm-modal-buttons .btn-cancel:hover {
            background: #bbb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        body.dark-mode .confirm-modal-buttons .btn-cancel {
            background: #444;
            color: var(--text-primary);
        }

        body.dark-mode .confirm-modal-buttons .btn-cancel:hover {
            background: #555;
        }

        .confirm-modal-buttons .btn-proceed {
            background: var(--header-grad);
            color: white;
        }

        .confirm-modal-buttons .btn-proceed:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 94, 32, 0.3);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ==================== SUCCESS MODAL ==================== */
        .success-modal-icon.success {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            box-shadow: 0 5px 20px rgba(46, 125, 50, 0.4);
        }

        .success-modal-content {
            background: var(--bg-card);
            padding: 35px 30px 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            color: var(--text-primary);
            animation: scaleIn 0.3s;
            position: relative;
        }

        .success-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .success-modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 15px 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .success-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .success-modal-body {
            background: rgba(46, 125, 50, 0.08);
            border-left: 4px solid #4caf50;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        body.dark-mode .success-modal-body {
            background: rgba(46, 125, 50, 0.15);
        }

        .success-modal-body ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .success-modal-body li {
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .success-modal-body li::before {
            content: "‚úì";
            color: #4caf50;
            font-size: 1.2rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .success-modal-footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .success-modal-countdown {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.1rem;
        }

        body.dark-mode .success-modal-countdown {
            color: #4caf50;
        }

        .success-modal-button {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
            display: block;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--header-grad);
            color: white;
        }

        .success-modal-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 94, 32, 0.3);
        }
        
/* Backup & Recovery Styles */
.backup-section {
    background: var(--bg-card);
    border-left: 5px solid #1b5e20;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.backup-section h4 {
    margin-top: 0;
    color: #1b5e20;
    font-size: 1rem;
}

.backup-info {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 6px;
    margin: 12px 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

body.dark-mode .backup-info {
    background: #3a3a3a;
}

.backup-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.backup-status {
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.8rem;
    margin-top: 10px;
    font-weight: 600;
}

.backup-status.success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #4caf50;
}

.backup-status.error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #f44336;
}

.backup-status.info {
    background: #e3f2fd;
    color: #1565c0;
    border-left: 4px solid #2196f3;
}

body.dark-mode .backup-status.success {
    background: #1b5e20;
    color: #81c784;
}

body.dark-mode .backup-status.error {
    background: #5a1414;
    color: #ef5350;
}

body.dark-mode .backup-status.info {
    background: #1a3a52;
    color: #64b5f6;
}

.backup-list {
    margin-top: 15px;
}

.backup-item {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    border-left: 3px solid #fbc02d;
}

body.dark-mode .backup-item {
    background: #3a3a3a;
}

.backup-item-info {
    flex-grow: 1;
}

.backup-item-date {
    font-weight: 600;
    color: var(--text-primary);
}

.backup-item-size {
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.backup-item-actions {
    display: flex;
    gap: 8px;
}

.backup-item-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: 0.2s;
}

.backup-item-btn-restore {
    background: #1b5e20;
    color: white;
}

.backup-item-btn-restore:hover {
    background: #0a2e10;
}

.backup-item-btn-delete {
    background: #d32f2f;
    color: white;
}

.backup-item-btn-delete:hover {
    background: #b71c1c;
}

.backup-progress {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    margin: 10px 0;
    overflow: hidden;
}

.backup-progress-bar {
    height: 100%;
    background: var(--safety-green-grad);
    border-radius: 3px;
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0%; }
    50% { width: 100%; }
    100% { width: 0%; }
}


/* Modern Dialog Styles */
/* ==================== STYLE 5: Success/Error/Warning Dialog ==================== */
@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modern-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s;
}

.modern-dialog {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 40px 30px 30px;
    max-width: 420px;
    width: 90%;
    box-shadow: 0 15px 50px rgba(0,0,0,0.25);
    text-align: center;
    animation: scaleIn 0.3s;
}

.modern-dialog-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 40px;
    margin: 0 auto 20px;
    box-shadow: 0 5px 20px rgba(46, 125, 50, 0.3);
}

.modern-dialog.error .modern-dialog-icon {
    background: linear-gradient(135deg, #d32f2f, #f44336);
    box-shadow: 0 5px 20px rgba(211, 47, 47, 0.3);
}

.modern-dialog.info .modern-dialog-icon {
    background: linear-gradient(135deg, #1976d2, #2196f3);
    box-shadow: 0 5px 20px rgba(25, 118, 210, 0.3);
}

.modern-dialog.warning .modern-dialog-icon {
    background: linear-gradient(135deg, #f57c00, #fbc02d);
    box-shadow: 0 5px 20px rgba(245, 124, 0, 0.3);
}

.modern-dialog-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 15px 0;
}

.modern-dialog-message {
    color: var(--text-secondary);
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 30px;
}

.modern-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.modern-dialog-btn {
    padding: 12px 40px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modern-dialog-btn-cancel {
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid var(--border-color);
}

.modern-dialog-btn-cancel:hover {
    background: rgba(0,0,0,0.05);
    border-color: #999;
    color: var(--text-primary);
}

.modern-dialog-btn-confirm {
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    color: white;
    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
}

.modern-dialog-btn-confirm:hover {
    background: linear-gradient(135deg, #1b5e20, #2e7d32);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
}

.modern-dialog-btn-danger {
    background: linear-gradient(135deg, #d32f2f, #f44336);
    color: white;
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
}

.modern-dialog-btn-danger:hover {
    background: linear-gradient(135deg, #b71c1c, #d32f2f);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);
}

body.dark-mode .modern-dialog-btn-cancel {
    background: transparent;
    border-color: #555;
    color: #b0b0b0;
}

body.dark-mode .modern-dialog-btn-cancel:hover {
    background: rgba(255,255,255,0.05);
    border-color: #777;
    color: #e4e4e4;
}

	.status-dropdown {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 150px;
}

.status-dropdown button {
    display: block;
    width: 100%;
    padding: 10px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-primary);
    transition: 0.2s;
}

.status-dropdown button:hover {
    background: var(--border-color);
}

        /* IMPROVED TABLE STYLES - OPTION 4: STRIPED WITH ACCENT */
        .table-container {
            margin: 10px 20px; overflow-x: auto; padding: 10px; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 8px;
        }
        
        table { 
            width: auto;
            min-width: 100%;
            border-collapse: collapse; 
            font-size: 0.7rem;
            table-layout: auto;
            color: var(--text-primary);
        }
        
        /* Option 4: Dark green header with yellow accent */
        th { 
            background: #1b5e20; 
            color: white; 
            padding: 10px 8px; 
            border: none;
            border-bottom: 3px solid var(--safety-yellow);
            white-space: nowrap;
            min-width: auto;
            width: auto;
            font-weight: 600;
        }
        
        /* Striped rows - white and very light green */
        tbody tr {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        tbody tr:nth-child(odd) {
            background: white;
        }
        
        tbody tr:nth-child(even) {
            background: #f1f8e9;
        }
        
        /* Dark mode striped rows */
        body.dark-mode tbody tr:nth-child(odd) {
            background: #2d2d2d;
        }
        
        body.dark-mode tbody tr:nth-child(even) {
            background: #1f2e1f;
        }
        
        /* Hover effect with left border accent */
        tbody tr:hover {
            border-left: 3px solid #4caf50;
            background: #e8f5e9 !important;
        }
        
        body.dark-mode tbody tr:hover {
            background: #1b3d1b !important;
        }
        
        td { 
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 8px 6px; 
            text-align: center;
            min-width: 90px;
            width: auto;
            white-space: nowrap;
        }
        
        body.dark-mode td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        td:first-child {
            text-align: left;
            min-width: 200px;
            font-weight: 600;
        }
        
        /* Previous Year Column */
        td.prev-year {
            font-weight: 700;
            color: #2e7d32;
            min-width: auto;
            width: auto;
            background: rgba(76, 175, 80, 0.05);
        }

        body.dark-mode td.prev-year {
            color: #a5d6a7;
            background: rgba(76, 175, 80, 0.1);
        }
        
        td.prev-year {
            min-width: 90px;
            max-width: 110px;
            width: 100px;
            padding: 8px 6px;
            font-size: 0.7rem;
            text-align: center;
        }
        
        th.prev-year {
            background: #2e7d32;
            min-width: 90px;
            max-width: 110px;
            width: 100px;
            padding: 6px 4px;
            font-size: 0.7rem;
        }
        
        /* Monthly Columns - Default - NARROWER */
       /* Monthly Columns - Default - WIDER FOR 7 DIGITS */
td.monthly-data, th.monthly-header {
    min-width: 100px;
    max-width: none;
    width: auto;
    padding: 8px 12px;
    font-size: 0.7rem;
    text-align: center;
}

/* Style all month header columns - WIDER */
th:not(.prev-year):not(.ytd-header):not([colspan]) {
    min-width: 90px;
    max-width: none;
    width: auto;
    padding: 8px 12px;
    font-size: 0.7rem;
}
        
        /* YTD Column - Yellow - WIDER FOR "Running YTD" HEADER */
        /* YTD Column - Yellow highlight maintained for emphasis */
td.ytd-cell {
    background: #fff59d !important;
    font-weight: 700;
    color: #f57f17;
    min-width: 120px;
    max-width: none;
    width: auto;
    padding: 8px 12px;
    font-size: 0.7rem;
}
        }

        body.dark-mode td.ytd-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.ytd-header {
            background: #f9a825;
            color: white;
            min-width: 120px;
            max-width: none;
            width: auto;
            padding: 8px 12px;
            font-size: 0.7rem;
        }

        body.dark-mode th.ytd-header {
            background: #e65100;
            color: white;
        }
        
        /* Average Column - Light Yellow highlight maintained */
       /* Average Column - Light Yellow */
td.average-cell {
    background: #fffde7 !important;
    font-weight: 700;
    color: #f57f17;
    min-width: auto;
    width: auto;
    padding: 8px 12px;
}

        body.dark-mode td.average-cell {
            background: #4a4a1f;
            color: #ffd54f;
        }
        
        th.average-header {
            background: #fbc02d;
            color: #333;
            min-width: 90px;
        }

        body.dark-mode th.average-header {
            background: #e65100;
            color: white;
        }
        
        /* Dark mode for striped rows - Option 4 */
        body.dark-mode tbody tr:nth-child(odd) {
            background: #2d2d2d;
        }
        
        body.dark-mode tbody tr:nth-child(even) {
            background: #1f2e1f;
        }
        
        body.dark-mode tbody tr:hover {
            background: #1b3d1b !important;
        }
        
        body.dark-mode td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* ==================== DOE REPORTORIAL STYLES ==================== */
        .pdf-upload-container {
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .pdf-upload-btn {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(27, 94, 32, 0.3);
        }
        
        .pdf-upload-btn:hover {
            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(27, 94, 32, 0.4);
        }
        
        .pdf-file-info {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            padding: 4px 8px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
        }
        
        body.dark-mode .pdf-file-info {
            background: rgba(76, 175, 80, 0.2);
        }
        
        .pdf-view-btn, .pdf-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 3px 7px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        
        .pdf-view-btn {
            color: #1976D2;
        }
        
        .pdf-view-btn:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
        }
        
        body.dark-mode .pdf-view-btn:hover {
            background: #1a3a52;
        }
        
        .pdf-delete-btn {
            color: #d32f2f;
        }
        
        .pdf-delete-btn:hover {
            background: #ffebee;
            transform: translateY(-1px);
        }
        
        body.dark-mode .pdf-delete-btn:hover {
            background: #5a1414;
        }
        
        /* Renewable Energy Badge */
        .re-badge {
            display: inline-block;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 4px rgba(46, 125, 50, 0.3);
            animation: subtlePulse 2s ease-in-out infinite;
        }
        
        @keyframes subtlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        /* ==================== END DOE REPORTORIAL STYLES ==================== */
        
        table input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 6px 4px;
            font-size: 0.7rem;
            text-align: center;
            font-weight: 500;
            box-sizing: border-box;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        
        table input:disabled { 
            background: transparent; 
            border: none; 
            color: var(--text-primary); 
            font-weight: 600;
        }
        
        table input[type="number"] {
    min-width: 60px;
    max-width: 100px;
    width: 85px;
    padding: 6px 4px;
    box-sizing: border-box;
    font-size: 0.7rem;
}

table input[type="date"] {
    min-width: 110px;
    width: 110px;
    max-width: 120px;
    padding: 6px 8px;
    cursor: pointer;
    box-sizing: border-box;
}

/* Always show calendar icon for date inputs */
table input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.7;
}

table input[type="date"]::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
}

/* Style for empty date inputs - show cleaner appearance */
table input[type="date"]:not(:focus):invalid,
table input[type="date"]:not(:focus):not([value]),
table input[type="date"]:not(:focus)[value=""] {
    color: #999;
    font-style: italic;
}
        
        #grand-stats {
            margin: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        
        .stat-card {
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); 
            color: #ffffff;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
        }
        
        /* Vibrant gradient backgrounds with stronger contrast */
        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%);
        }
        
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #c17900 0%, #f57f17 25%, #fbc02d 50%, #fdd835 75%, #ffeb3b 100%);
        }
        
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #01579b 0%, #0d47a1 25%, #1976D2 50%, #2196F3 75%, #64b5f6 100%);
        }
        
        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #7f0000 0%, #b71c1c 25%, #d32f2f 50%, #e53935 75%, #ef5350 100%);
        }
        
        /* Add subtle shine effect to enhance gradient visibility */
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 16px 40px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        
        .stat-card:hover::after {
            animation: shine 1.5s ease-in-out;
        }
        
        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        /* Ripple effect - only on hover */
        .stat-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .stat-card:nth-child(1)::before {
            background: radial-gradient(circle, rgba(27, 94, 32, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:nth-child(2)::before {
            background: radial-gradient(circle, rgba(251, 192, 45, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:nth-child(3)::before {
            background: radial-gradient(circle, rgba(25, 118, 210, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:nth-child(4)::before {
            background: radial-gradient(circle, rgba(211, 47, 47, 0.3) 0%, transparent 70%);
        }
        
        .stat-card:hover::before {
            animation: rippleEffect 0.6s ease-out;
        }
        
        @keyframes rippleEffect {
            0% {
                width: 0;
                height: 0;
                opacity: 0.8;
            }
            100% {
                width: 400px;
                height: 400px;
                opacity: 0;
            }
        }
        
        /* Ensure content is above all background layers */
        .stat-card > * {
            position: relative;
            z-index: 2;
        }
        
        .stat-value { 
            font-size: 1.5rem; 
            font-weight: 900; 
            color: #ffffff; 
            margin-top: 5px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 20px rgba(0,0,0,0.2);
        }
        .stat-label { 
            font-size: 0.65rem; 
            color: rgba(255, 255, 255, 0.95); 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        /* ============================================
           FLOATING PARTICLES ANIMATIONS FOR STAT CARDS
           ============================================ */
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            pointer-events: none;
        }
        
        /* Green particles for TOTAL PROJECTS (card 1) */
        .particle-green-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(102, 187, 106, 0.6);
            box-shadow: 0 0 10px rgba(102, 187, 106, 0.4);
            animation: float-particle-1 25.5s ease-in-out infinite;
        }
        
        .particle-green-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(76, 175, 80, 0.5);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
            animation: float-particle-2 32.4s ease-in-out infinite 7.5s;
        }
        
        .particle-green-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(129, 199, 132, 0.4);
            box-shadow: 0 0 8px rgba(129, 199, 132, 0.3);
            animation: float-particle-3 28.1s ease-in-out infinite 15.2s;
        }
        
        .particle-green-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(102, 187, 106, 0.5);
            box-shadow: 0 0 12px rgba(102, 187, 106, 0.4);
            animation: float-particle-4 38.2s ease-in-out infinite 3.9s;
        }
        
        /* Yellow particles for OVERALL COMPLIANCE (card 2) */
        .particle-yellow-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(255, 235, 59, 0.6);
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
            animation: float-particle-1 30.6s ease-in-out infinite 5.4s;
        }
        
        .particle-yellow-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(255, 202, 40, 0.5);
            box-shadow: 0 0 15px rgba(255, 202, 40, 0.3);
            animation: float-particle-2 35.8s ease-in-out infinite 12.9s;
        }
        
        .particle-yellow-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(255, 238, 88, 0.4);
            box-shadow: 0 0 8px rgba(255, 238, 88, 0.3);
            animation: float-particle-3 26.7s ease-in-out infinite;
        }
        
        .particle-yellow-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(255, 235, 59, 0.5);
            box-shadow: 0 0 12px rgba(255, 235, 59, 0.4);
            animation: float-particle-4 33.9s ease-in-out infinite 9.6s;
        }
        
        /* Blue particles for ON-GOING (card 3) */
        .particle-blue-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(100, 181, 246, 0.6);
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.4);
            animation: float-particle-1 32.4s ease-in-out infinite 8.7s;
        }
        
        .particle-blue-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(33, 150, 243, 0.5);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
            animation: float-particle-2 36.3s ease-in-out infinite;
        }
        
        .particle-blue-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(144, 202, 249, 0.4);
            box-shadow: 0 0 8px rgba(144, 202, 249, 0.3);
            animation: float-particle-3 27.6s ease-in-out infinite 14.1s;
        }
        
        .particle-blue-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(100, 181, 246, 0.5);
            box-shadow: 0 0 12px rgba(100, 181, 246, 0.4);
            animation: float-particle-4 41.1s ease-in-out infinite 5.7s;
        }
        
        /* Red particles for WORK STOPPAGE (card 4) */
        .particle-red-1 {
            width: 12px;
            height: 12px;
            top: 70%;
            left: 15%;
            background: rgba(239, 83, 80, 0.6);
            box-shadow: 0 0 10px rgba(239, 83, 80, 0.4);
            animation: float-particle-1 34.5s ease-in-out infinite 2.4s;
        }
        
        .particle-red-2 {
            width: 18px;
            height: 18px;
            top: 40%;
            left: 65%;
            background: rgba(229, 57, 53, 0.5);
            box-shadow: 0 0 15px rgba(229, 57, 53, 0.3);
            animation: float-particle-2 30.3s ease-in-out infinite 11.1s;
        }
        
        .particle-red-3 {
            width: 10px;
            height: 10px;
            top: 55%;
            left: 40%;
            background: rgba(244, 143, 177, 0.4);
            box-shadow: 0 0 8px rgba(244, 143, 177, 0.3);
            animation: float-particle-3 42.6s ease-in-out infinite 15.3s;
        }
        
        .particle-red-4 {
            width: 14px;
            height: 14px;
            top: 25%;
            left: 80%;
            background: rgba(239, 83, 80, 0.5);
            box-shadow: 0 0 12px rgba(239, 83, 80, 0.4);
            animation: float-particle-4 24.9s ease-in-out infinite;
        }
        
        /* Floating particle animations - 4 unique variations */
        @keyframes float-particle-1 {
            0%, 100% {
                transform: translateY(0px) translateX(0px);
                opacity: 0.8;
            }
            25% {
                transform: translateY(-25px) translateX(10px);
                opacity: 1;
            }
            50% {
                transform: translateY(-15px) translateX(-8px);
                opacity: 0.6;
            }
            75% {
                transform: translateY(-30px) translateX(5px);
                opacity: 0.9;
            }
        }
        
        @keyframes float-particle-2 {
            0%, 100% {
                transform: translateY(0px) translateX(0px) rotate(0deg);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-20px) translateX(-12px) rotate(5deg);
                opacity: 0.95;
            }
            60% {
                transform: translateY(-28px) translateX(7px) rotate(-3deg);
                opacity: 0.55;
            }
            80% {
                transform: translateY(-18px) translateX(-5px) rotate(2deg);
                opacity: 0.85;
            }
        }
        
        @keyframes float-particle-3 {
            0%, 100% {
                transform: translateY(0px) translateX(0px) scale(1);
                opacity: 0.75;
            }
            20% {
                transform: translateY(-32px) translateX(6px) scale(1.1);
                opacity: 0.9;
            }
            55% {
                transform: translateY(-12px) translateX(-10px) scale(0.95);
                opacity: 0.5;
            }
            85% {
                transform: translateY(-22px) translateX(8px) scale(1.05);
                opacity: 1;
            }
        }
        
        @keyframes float-particle-4 {
            0%, 100% {
                transform: translateY(0px) translateX(0px);
                opacity: 0.65;
            }
            35% {
                transform: translateY(-18px) translateX(-7px);
                opacity: 0.85;
            }
            65% {
                transform: translateY(-35px) translateX(12px);
                opacity: 1;
            }
            90% {
                transform: translateY(-10px) translateX(-4px);
                opacity: 0.7;
            }
        }
        .charts-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;
            padding: 20px; margin-top: 0;
        }
        .chart-box {
            background: var(--bg-card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            color: var(--text-primary);
        }
        .chart-box h3 {
            color: #1b5e20; margin-top: 0; font-size: 0.95rem; border-bottom: 2px solid var(--safety-yellow);
            padding-bottom: 10px;
        }
        .chart-box canvas { 
            max-height: 300px; 
            width: 100% !important;
            height: auto !important;
        }
        
        .chart-box {
            position: relative;
            width: 100%;
            min-height: 250px;
        }
        
        /* Better table scrolling on mobile */
        div[style*="overflow-x:auto"],
        div[style*="overflow-x: auto"] {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(27, 94, 32, 0.5) transparent;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar,
        div[style*="overflow-x: auto"]::-webkit-scrollbar {
            height: 8px;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar-track,
        div[style*="overflow-x: auto"]::-webkit-scrollbar-track {
            background: transparent;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar-thumb,
        div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb {
            background: rgba(27, 94, 32, 0.5);
            border-radius: 4px;
        }
        
        div[style*="overflow-x:auto"]::-webkit-scrollbar-thumb:hover,
        div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb:hover {
            background: rgba(27, 94, 32, 0.7);
        }
        
        .loading-spinner {
            display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .logout-btn {
            width: 100%; background: rgba(255,255,255,0.1); color: white;
            border: 1px solid rgba(255,255,255,0.2); padding: 10px; cursor: pointer;
            font-size: 0.75rem; border-radius: 4px;
        }
        .user-badge { 
            background: linear-gradient(135deg, #fbc02d, #f57f17);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(251, 192, 45, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-align: center;
            position: relative;
        }
        
        .user-badge:hover {
            box-shadow: 0 4px 12px rgba(251, 192, 45, 0.3);
        }
        
        .user-badge .name {
            font-size: 0.85rem;
            font-weight: 800;
            color: #1b5e20;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* User Profile Dropdown */
        .user-profile-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 10px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .user-profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-profile-header {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            padding: 15px;
            color: white;
            text-align: center;
        }
        
        .user-profile-email {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .user-profile-menu {
            padding: 8px 0;
        }
        
        .user-profile-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-primary);
            border-left: 3px solid transparent;
        }
        
        .user-profile-item:hover {
            background: rgba(27, 94, 32, 0.08);
            border-left-color: #2e7d32;
        }
        
        .user-profile-item i {
            width: 20px;
            text-align: center;
            color: #2e7d32;
        }
        
        .user-profile-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }
        
        .user-profile-item.admin-only {
            border-left-color: #d32f2f;
        }
        
        .user-profile-item.admin-only i {
            color: #d32f2f;
        }
        
        .user-profile-item.admin-only:hover {
            background: rgba(211, 47, 47, 0.08);
            border-left-color: #d32f2f;
        }
        
        .admin-badge-small {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: auto;
        }

        #dashboard-content {
            color: var(--text-primary);
            padding-bottom: 200px; /* Extra space at bottom for dropdowns and scrolling */
            animation: slideRight 0.5s ease-out;
        }

/* ========== TOAST NOTIFICATIONS ========== */
#toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 320px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid;
}

.toast-success {
    border-left-color: #4caf50;
    background: #f1f8f4;
}

.toast-error {
    border-left-color: #f44336;
    background: #fef5f5;
}

.toast-warning {
    border-left-color: #ff9800;
    background: #fff8f0;
}

.toast-info {
    border-left-color: #2196f3;
    background: #f0f7ff;
}

.toast-icon {
    font-size: 20px;
    flex-shrink: 0;
}

.toast-success .toast-icon { color: #4caf50; }
.toast-error .toast-icon { color: #f44336; }
.toast-warning .toast-icon { color: #ff9800; }
.toast-info .toast-icon { color: #2196f3; }

.toast-message {
    flex: 1;
    font-size: 14px;
    color: #333;
    font-weight: 500;
    line-height: 1.4;
}

.toast-close {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    padding: 0;
    font-size: 20px;
    line-height: 1;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toast-close:hover {
    background: rgba(0,0,0,0.1);
    color: #333;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

.toast.hiding {
    animation: slideOut 0.3s ease-out forwards;
}

body.dark-mode .toast {
    background: #2d2d2d;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

body.dark-mode .toast-success { background: #1a3a1f; }
body.dark-mode .toast-error { background: #3a1a1a; }
body.dark-mode .toast-warning { background: #3a2a1a; }
body.dark-mode .toast-info { background: #1a2a3a; }

body.dark-mode .toast-message {
    color: #e4e4e4;
}

body.dark-mode .toast-close {
    color: #b0b0b0;
}

body.dark-mode .toast-close:hover {
    background: rgba(255,255,255,0.1);
    color: #e4e4e4;
}

/* ========== END TOAST ========== */

/* ========== SMOOTH TRANSITIONS ========== */
.project-row {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}



.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:active {
    transform: translateY(0);
}

input[type="date"]:focus,
input[type="text"]:focus,
input[type="number"]:focus {
    transform: scale(1.01);
    transition: all 0.2s ease;
}

/* ========== END TRANSITIONS ========== */

/* ========== TOOLTIPS ========== */
.tooltip-trigger {
    position: relative;
    cursor: help;
    color: #2e7d32;
    margin-left: 4px;
    display: inline-flex;
    align-items: center;
}

.tooltip-content {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: #333;
}

.tooltip-trigger:hover .tooltip-content {
    opacity: 1;
}

body.dark-mode .tooltip-content {
    background: #1a1a1a;
    border: 1px solid #444;
}

body.dark-mode .tooltip-content::after {
    border-top-color: #1a1a1a;
}
/* ========== END TOOLTIPS ========== */



/* I-adjust ang width ng specific DOLE columns */
.col-narrow {
    width: 1%;
    white-space: nowrap;
    padding-left: 10px !important;
    padding-right: 10px !important;
}

/* Kulay para sa disabled cells */
.cell-disabled {
    background-color: var(--border-color) !important;
    cursor: not-allowed;
    opacity: 0.6;
}

/* NOV tab: slim columns since values are 3-digit max */
.nov-narrow-th {
    min-width: 0 !important;
    width: 42px !important;
    padding: 8px 3px !important;
    font-size: 0.62rem !important;
}
.nov-narrow-td {
    min-width: 0 !important;
    width: 42px !important;
    padding: 5px 2px !important;
}
.nov-narrow-td input[type="number"] {
    width: 36px !important;
    min-width: 0 !important;
    padding: 4px 2px !important;
    font-size: 0.68rem !important;
}

/* DOLE Reportorial: narrower columns for RSO, MOM (monthly) and AEDR, AMR (annual) */
.dole-narrow-th {
    min-width: 0 !important;
    width: 100px !important;
    max-width: 100px !important;
    padding: 8px 4px !important;
    font-size: 0.7rem !important;
}
.dole-narrow-td {
    min-width: 0 !important;
    width: 100px !important;
    max-width: 100px !important;
    padding: 5px 2px !important;
}
.dole-narrow-td input[type="date"] {
    width: 95px !important;
    max-width: 95px !important;
    min-width: 0 !important;
    padding: 4px 2px !important;
    font-size: 0.7rem !important;
}

/* Personnel table: locked by default, per-row Edit/Save */
#p-body td input,
#p-body td select {
    pointer-events: none;
    background: transparent !important;
    border: none !important;
    color: var(--text-primary);
    cursor: default;
    font-size: 0.72rem;
}
#p-body tr.p-editing td input,
#p-body tr.p-editing td select {
    pointer-events: auto;
    background: var(--input-bg) !important;
    border: 1px solid #2e7d32 !important;
    border-radius: 4px !important;
    cursor: text;
    padding: 4px 6px !important;
}
#p-body tr {
    border-bottom: 1px solid var(--border-color);
    transition: background 0.15s;
}
#p-body tr:nth-child(even) { background: rgba(0,0,0,0.018); }
body.dark-mode #p-body tr:nth-child(even) { background: rgba(255,255,255,0.03); }
#p-body tr:hover { background: #e8f5e9 !important; }
body.dark-mode #p-body tr:hover { background: rgba(27,94,32,0.18) !important; }
#p-body tr:hover td:first-child { background: #e8f5e9 !important; }
body.dark-mode #p-body tr:hover td:first-child { background: rgba(27,94,32,0.18) !important; }
#p-body tr.p-editing { background: #f1f8e9 !important; box-shadow: inset 3px 0 0 #2e7d32; }
body.dark-mode #p-body tr.p-editing { background: rgba(27,94,32,0.25) !important; }
#p-body tr.p-editing td:first-child { background: #f1f8e9 !important; }
body.dark-mode #p-body tr.p-editing td:first-child { background: rgba(27,94,32,0.25) !important; }
#p-body tr:nth-child(even) td:first-child { background: rgba(0,0,0,0.018); }
body.dark-mode #p-body tr:nth-child(even) td:first-child { background: rgba(255,255,255,0.03); }
#p-body td { padding: 8px 10px; vertical-align: middle; border: none; color: var(--text-primary); }
#p-body td:first-child { font-weight: 600; }
.p-row-num {
    display: inline-flex; align-items:center; justify-content:center;
    width: 20px; height: 20px; border-radius: 50%;
    background: #e8f5e9; color: #2e7d32;
    font-size: 0.65rem; font-weight: 700; margin-right: 6px;
    flex-shrink: 0; vertical-align: middle;
}
body.dark-mode .p-row-num { background: #1b5e20; color: #a5d6a7; }
.p-pos-badge {
    display: inline-block; padding: 2px 7px;
    border-radius: 10px; font-size: 0.65rem; font-weight: 600;
    background: #e3f2fd; color: #1565c0; white-space: nowrap;
}
body.dark-mode .p-pos-badge { background: #1a3a52; color: #64b5f6; }
.p-gender-m { background: #e3f2fd !important; color: #1565c0 !important; }
.p-gender-f { background: #fce4ec !important; color: #c2185b !important; }
.p-edit-btn {
    padding: 5px 10px;
    background: #1976D2;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 0.68rem;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex; align-items:center; gap:4px;
    transition: 0.2s;
}
.p-edit-btn:hover { background: #1565c0; }
.p-save-btn {
    display: none;
    padding: 5px 10px;
    background: #2e7d32;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 0.68rem;
    cursor: pointer;
    font-weight: 600;
    margin-left: 3px;
    align-items:center; gap:4px;
    transition: 0.2s;
}
.p-save-btn:hover { background: #1b5e20; }
.p-del-btn {
    padding: 5px 8px;
    background: #ffebee;
    color: #d32f2f;
    border: 1px solid #ffcdd2;
    border-radius: 5px;
    font-size: 0.68rem;
    cursor: pointer;
    margin-left: 3px;
    transition: 0.2s;
}
.p-del-btn:hover { background: #d32f2f; color: white; border-color: #d32f2f; }

    </style>
</head>
<body>

    <!-- Firebase initialization loading screen -->
    <div id="firebase-loading-overlay">
        <div class="shield-loader">
            <i class="fas fa-shield-halved"></i>
        </div>
        <p>üõ°Ô∏è SECURING YOUR WORKSPACE...</p>
    </div>

	
    <div id="login-overlay" style="display:none;">
        <!-- Safety Background Elements -->
        <div class="safety-bg-icons">
            <i class="fas fa-hard-hat safety-icon-float"></i>
            <i class="fas fa-user-shield safety-icon-float"></i>
            <i class="fas fa-briefcase-medical safety-icon-float"></i>
            <i class="fas fa-fire-extinguisher safety-icon-float"></i>
            <i class="fas fa-vest safety-icon-float"></i>
            <i class="fas fa-triangle-exclamation safety-icon-float"></i>
        </div>
        <div class="safety-pattern"></div>
        <div class="warning-stripe"></div>
        
        <div class="login-card">
            <div class="login-header">
                <div class="login-shield">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <h1 class="login-title">ESH Compliance Dashboard</h1>
                <p class="login-subtitle">STA. CLARA INTERNATIONAL CORPORATION</p>
                <div class="login-badge">
                    <i class="fas fa-users-gear"></i> MANAGER ACCESS PORTAL
                </div>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)" autocomplete="off">
                <div class="login-input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="login-user" placeholder="Corporate Email Address" required autocomplete="off">
                </div>
                <div class="login-input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-pass" placeholder="Password" required autocomplete="off">
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM
                </button>
            </form>
            
            <div id="login-error" class="error-message"></div>
            
            <div class="disclaimer-box">
                <strong><i class="fas fa-shield-halved"></i> AUTHORIZED ACCESS ONLY</strong><br>
                This system is exclusively for ESH Department managers and authorized personnel. 
                For account access, please contact your system administrator.
            </div>
        </div>
    </div>

    <!-- ==================== CUSTOM CONFIRMATION MODAL ==================== -->
    <div id="confirmModal" class="modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <div class="modal-icon confirm-modal-icon warning">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="confirm-modal-title">
                    <i class="fas fa-lock"></i> SECURITY CONFIRMATION
                </div>
                <div class="confirm-modal-subtitle">Please review the following before proceeding</div>
            </div>

            <div class="confirm-modal-body">
                <strong style="display: block; margin-bottom: 10px; color: var(--text-primary);">
                    ‚ö†Ô∏è After changing your password:
                </strong>
                <ul>
                    <li>You will be logged out automatically</li>
                    <li>All other devices will be logged out</li>
                    <li>You'll need to login again with new password</li>
                    <li>You'll receive an email confirmation</li>
                </ul>
            </div>

            <div class="confirm-modal-question">
                Do you want to proceed?
            </div>

            <div class="confirm-modal-buttons">
                <button class="btn btn-cancel" onclick="closeConfirmModal(false)">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-proceed" onclick="closeConfirmModal(true)">
                    <i class="fas fa-check"></i> Yes, Proceed
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== SUCCESS MODAL ==================== -->
    <div id="successModal" class="modal">
        <div class="success-modal-content">
            <div class="success-modal-header">
                <div class="modal-icon success-modal-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="success-modal-title">
                    ‚úÖ PASSWORD CHANGED SUCCESSFULLY!
                </div>
                <div class="success-modal-subtitle">Your password has been updated securely</div>
            </div>

            <div class="success-modal-body">
                <strong style="display: block; margin-bottom: 10px; color: var(--text-primary);">
                    üîê For your security:
                </strong>
                <ul>
                    <li>All sessions have been logged out</li>
                    <li>Please login again with your new password</li>
                    <li>Check your email for confirmation</li>
                </ul>
            </div>

            <div class="success-modal-footer">
                <div style="margin-bottom: 10px;">You will be redirected to login in</div>
                <div class="success-modal-countdown" id="countdown-timer">3</div>
                <div style="margin-top: 5px; font-size: 0.85rem;">seconds...</div>
            </div>

            <button class="success-modal-button" onclick="closeSuccessModal()">
                <i class="fas fa-sign-in-alt"></i> Login Now
            </button>
        </div>
    </div>

    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-folder-plus"></i>
            </div>
            <div class="modal-header">
                <span>Add New Project</span>
                <button class="modal-close" onclick="closeAddProjectModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Create a new project site to track ESH compliance</div>
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="projectNameInput" placeholder="Enter project name" required>
            </div>
            <div class="form-group">
                <label>Date Started *</label>
                <input type="date" id="projectDateStarted" required>
            </div>
            <div class="form-group">
                <label>Date Finished</label>
                <input type="date" id="projectDateFinished">
            </div>
            <div class="form-group">
                <label>Region *</label>
                <select id="projectRegion" required>
                    <option value="">Select Region</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="projectIsRenewable" style="width: auto; cursor: pointer;">
                    <span>Renewable Energy Project</span>
                    <i class="fas fa-leaf" style="color: #4caf50;"></i>
                </label>
                <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> Check if this is a Renewable Energy project (required for DOE Reportorial)
                </small>
            </div>


            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddProject()">Add Project</button>
            </div>
            <div id="projectModalError" class="error-message"></div>
        </div>
    </div>

    <!-- Add Personnel Modal -->
    <div id="addPersonnelModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="modal-header">
                <span>Add New Personnel</span>
                <button class="modal-close" onclick="closeAddPersonnelModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Add a new ESH team member to the registry</div>
            <div class="form-group">
                <label>Last Name *</label>
                <input type="text" id="personnelLastNameInput" placeholder="Enter last name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" id="personnelFirstNameInput" placeholder="Enter first name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Middle Name</label>
                <input type="text" id="personnelMiddleNameInput" placeholder="Enter middle name" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Name Extension (if applicable)</label>
                <select id="personnelNameExtInput">
                    <option value="">None</option>
                    <option value="JR.">Jr.</option>
                    <option value="SR.">Sr.</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                </select>
            </div>
            <div class="form-group">
                <label>Position *</label>
                <select id="personnelPositionInput" required>
                    <option value="">Select Position</option>
                    <optgroup label="Project-Based Positions">
                        <option value="ESH Superintendent">ESH Superintendent</option>
                        <option value="ESH Head">ESH Head</option>
                        <option value="Safety Officer I">Safety Officer I</option>
                        <option value="Safety Officer II">Safety Officer II</option>
                        <option value="Safety Officer III">Safety Officer III</option>
                        <option value="Safety Officer IV">Safety Officer IV</option>
                        <option value="PCO">PCO</option>
                        <option value="Project Physician">Project Physician</option>
                        <option value="Project Nurse">Project Nurse</option>
                        <option value="First Aider">First Aider</option>
                    </optgroup>
                    <optgroup label="Corporate Positions">
                        <option value="QESH Group Manager">QESH Group Manager</option>
                        <option value="QESH Deputy Manager">QESH Deputy Manager</option>
                        <option value="ESH Manager for Regulation & Compliance">ESH Manager for Regulation & Compliance</option>
                        <option value="ESH Manager for Project Implementation">ESH Manager for Project Implementation</option>
                        <option value="Environmental and Sustainability Head">Environmental and Sustainability Head</option>
                        <option value="Corporate Physician">Corporate Physician</option>
                        <option value="Corporate Nurse">Corporate Nurse</option>
                        <option value="QESH Corp. DC">QESH Corp. DC</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="Others">Others</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group">
                <label>ID Number *</label>
                <input type="text" id="personnelIdInput" placeholder="Enter ID number" required>
            </div>
            <div class="form-group">
                <label>Date Hired *</label>
                <input type="date" id="personnelHiredInput" required>
            </div>
            <div class="form-group">
                <label>Current Assignment *</label>
                <select id="personnelAssignmentInput" required>
                    <option value="">Select Assignment</option>
                    <option value="Corporate Office">Corporate Office</option>
                </select>
            </div>
            <div class="form-group">
                <label>Age *</label>
                <input type="number" id="personnelAgeInput" placeholder="Enter age" min="18" max="100" required>
            </div>
            <div class="form-group">
                <label>Gender *</label>
                <select id="personnelGenderInput" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="personnelEmailInput" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Contact Number</label>
                <input type="tel" id="personnelContactInput" placeholder="09XX-XXX-XXXX">
            </div>
            <div class="form-group">
                <label>Home Address</label>
                <textarea id="personnelAddressInput" placeholder="Enter home address"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddPersonnelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddPersonnel()">Add Personnel</button>
            </div>
            <div id="personnelModalError" class="error-message"></div>
        </div>
    </div>

    <!-- Edit Personnel Modal -->
    <div id="editPersonnelModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-edit"></i>
            </div>
            <div class="modal-header">
                <span>Edit Personnel</span>
                <button class="modal-close" onclick="closeEditPersonnelModal()">&times;</button>
            </div>
            <div class="modal-subtitle">Update personnel information</div>
            <input type="hidden" id="editPersonnelIndex">
            <div class="form-group">
                <label>Last Name *</label>
                <input type="text" id="editPersonnelLastNameInput" placeholder="Enter last name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" id="editPersonnelFirstNameInput" placeholder="Enter first name" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Middle Name</label>
                <input type="text" id="editPersonnelMiddleNameInput" placeholder="Enter middle name" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label>Name Extension (if applicable)</label>
                <select id="editPersonnelNameExtInput">
                    <option value="">None</option>
                    <option value="JR.">Jr.</option>
                    <option value="SR.">Sr.</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                    <option value="V">V</option>
                </select>
            </div>
            <div class="form-group">
                <label>Position *</label>
                <select id="editPersonnelPositionInput" required>
                    <option value="">Select Position</option>
                    <optgroup label="Project-Based Positions">
                        <option value="ESH Superintendent">ESH Superintendent</option>
                        <option value="ESH Head">ESH Head</option>
                        <option value="Safety Officer I">Safety Officer I</option>
                        <option value="Safety Officer II">Safety Officer II</option>
                        <option value="Safety Officer III">Safety Officer III</option>
                        <option value="Safety Officer IV">Safety Officer IV</option>
                        <option value="PCO">PCO</option>
                        <option value="Project Physician">Project Physician</option>
                        <option value="Project Nurse">Project Nurse</option>
                        <option value="First Aider">First Aider</option>
                    </optgroup>
                    <optgroup label="Corporate Positions">
                        <option value="QESH Group Manager">QESH Group Manager</option>
                        <option value="QESH Deputy Manager">QESH Deputy Manager</option>
                        <option value="ESH Manager for Regulation & Compliance">ESH Manager for Regulation & Compliance</option>
                        <option value="ESH Manager for Project Implementation">ESH Manager for Project Implementation</option>
                        <option value="Environmental and Sustainability Head">Environmental and Sustainability Head</option>
                        <option value="Corporate Physician">Corporate Physician</option>
                        <option value="Corporate Nurse">Corporate Nurse</option>
                        <option value="QESH Corp. DC">QESH Corp. DC</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="Others">Others</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group">
                <label>ID Number *</label>
                <input type="text" id="editPersonnelIdInput" placeholder="Enter ID number" required>
            </div>
            <div class="form-group">
                <label>Date Hired *</label>
                <input type="date" id="editPersonnelHiredInput" required>
            </div>
            <div class="form-group">
                <label>Current Assignment *</label>
                <select id="editPersonnelAssignmentInput" required>
                    <option value="">Select Assignment</option>
                    <option value="Corporate Office">Corporate Office</option>
                </select>
            </div>
            <div class="form-group">
                <label>Age *</label>
                <input type="number" id="editPersonnelAgeInput" placeholder="Enter age" min="18" max="100" required>
            </div>
            <div class="form-group">
                <label>Gender *</label>
                <select id="editPersonnelGenderInput" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editPersonnelEmailInput" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Contact Number</label>
                <input type="tel" id="editPersonnelContactInput" placeholder="09XX-XXX-XXXX">
            </div>
            <div class="form-group">
                <label>Home Address</label>
                <textarea id="editPersonnelAddressInput" placeholder="Enter home address"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeEditPersonnelModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditPersonnel()">Save Changes</button>
            </div>
            <div id="editPersonnelModalError" class="error-message"></div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Edit Project Details</span>
                <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="editProjectNameInput" placeholder="Enter project name" required>
            </div>
            <div class="form-group">
                <label>Date Started *</label>
                <input type="date" id="editProjectDateStarted" required>
            </div>
            <div class="form-group">
                <label>Date Finished</label>
                <input type="date" id="editProjectDateFinished">
                <small style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 5px; display: block;">
                    <i class="fas fa-info-circle"></i> Adding a finish date will automatically set status to "Finished"
                </small>
            </div>
            <div class="form-group">
                <label>Region *</label>
                <select id="editProjectRegion" required>
                    <option value="">Select Region</option>
                    <option value="NCR">NCR</option>
                    <option value="SOUTH LUZON">South Luzon</option>
                    <option value="NORTH LUZON">North Luzon</option>
                    <option value="VISAYAS & MINDANAO">Visayas & Mindanao</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="editProjectIsRenewable" style="width: auto; cursor: pointer;">
                    <span>Renewable Energy Project</span>
                    <i class="fas fa-leaf" style="color: #4caf50;"></i>
                </label>
                <small style="color: var(--text-secondary); font-size: 0.75rem; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> Check if this is a Renewable Energy project (required for DOE Reportorial)
                </small>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeEditProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditProject()">Save Changes</button>
            </div>
            <div id="editProjectModalError" class="error-message"></div>
        </div>
    </div>

    <aside id="main-sidebar" class="hidden">
        <div class="sidebar-header">
            <div style="font-size: 1.4rem; font-weight: 900; line-height: 1.1; margin-top: 5px;">ESH <span style="color:var(--safety-yellow)">COMPLIANCE</span><br>DASHBOARD</div>
            <div id="live-date" style="font-size: 0.6rem; color: #a5d6a7; margin-top: 10px;"></div>
            <div id="live-clock" style="color: var(--safety-yellow); font-size: 0.8rem; font-weight: 700;"></div>
            <div id="user-badge" class="user-badge" onclick="handleUserBadgeClick()">
                <div class="name">
                    <i class="fas fa-user-circle"></i> Loading...
                </div>
            </div>
        </div>
        <nav style="flex-grow: 1; padding-top: 10px;">
            <!-- DASHBOARD & ANALYTICS -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-chart-bar" style="margin-right: 6px;"></i> Dashboard & Analytics</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item active" data-tab="overall" onclick="changeTab('overall')"><i class="fas fa-gauge-high"></i> Overall Dashboard</div>
                    <div class="nav-item" data-tab="rates" onclick="changeTab('rates')"><i class="fas fa-chart-line"></i> Statistics Rate</div>
                </div>
            </div>

            <!-- MONITORING -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-eye" style="margin-right: 6px;"></i> Monitoring</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="exposures" onclick="changeTab('exposures')"><i class="fas fa-stopwatch"></i> Total Exposures</div>
                    <div class="nav-item" data-tab="personnel" onclick="changeTab('personnel')"><i class="fas fa-users-viewfinder"></i> ESH Personnel Monitoring</div>
                    <div class="nav-item" data-tab="activities" onclick="changeTab('activities')"><i class="fas fa-clipboard-check"></i> ESH Activities & Programs</div>
                </div>
            </div>

            <!-- REPORTORIAL -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-file-alt" style="margin-right: 6px;"></i> Reportorial</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="kpm" onclick="changeTab('kpm')"><i class="fas fa-file-lines"></i> Monthly Report</div>
                    <div class="nav-item" data-tab="dole" onclick="changeTab('dole')"><i class="fas fa-file-contract"></i> DOLE Reportorial</div>
                    <div class="nav-item" data-tab="emb" onclick="changeTab('emb')"><i class="fas fa-industry"></i> EMB Reportorial</div>
                    <div class="nav-item" data-tab="doe" onclick="changeTab('doe')"><i class="fas fa-solar-panel"></i> DOE Reportorial</div>
                </div>
            </div>

            <!-- SAFETY RECORDS -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fas fa-triangle-exclamation" style="margin-right: 6px;"></i> Safety Records</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="medical" onclick="changeTab('medical')"><i class="fas fa-triangle-exclamation"></i> Accident/Incident Record</div>
                    <div class="nav-item" data-tab="nov" onclick="changeTab('nov')"><i class="fas fa-gavel"></i> Regulatory Issued NOV</div>
                    <div class="nav-item" data-tab="nov-monitoring" onclick="changeTab('nov-monitoring')"><i class="fas fa-chart-gantt"></i> ESH NOV Monitoring</div>
                </div>
            </div>

            <!-- COMPLIANCE & AUDIT -->
            <div class="nav-group">
                <div class="nav-group-header collapsed" onclick="toggleNavGroup(this)">
                    <span><i class="fa-solid fa-magnifying-glass-chart" style="margin-right: 6px;"></i> Compliance & Audit</span>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="nav-group-items collapsed">
                    <div class="nav-item" data-tab="audit" onclick="changeTab('audit')"><i class="fas fa-magnifying-glass-dollar"></i> Internal ESH Audit Result</div>
                    <div class="nav-item" data-tab="cshp" onclick="changeTab('cshp')"><i class="fas fa-shield-heart"></i> CSHP</div>
                    <div class="nav-item" data-tab="reg" onclick="changeTab('reg')"><i class="fas fa-certificate"></i> Certificate of Registration</div>
                    <div class="nav-item" data-tab="doe-permit" onclick="changeTab('doe-permit')"><i class="fas fa-id-card"></i> DOE Safety Officer Permit</div>
                    <div class="nav-item" data-tab="permits" onclick="changeTab('permits')"><i class="fas fa-leaf"></i> Environmental Permits</div>
                </div>
            </div>

            <!-- Hidden Settings Tab -->
            <div class="nav-item" data-tab="settings" onclick="changeTab('settings')" style="display: none;"><i class="fas fa-sliders"></i> Settings</div>
        </nav>
    </aside>

    <main id="main-content" class="hidden">
        <header>
            <h2 class="header-title">OVERALL DASHBOARD</h2>
            <div class="header-controls">
                <!-- Search and filters removed from header - moved to dashboard content area -->
                
                <!-- Always visible controls -->
                
                <!-- EXPORT PDF BUTTON -->
                <button id="export-pdf-btn" class="year-selector-btn" onclick="exportCurrentTabToPDF()" title="Export to PDF Report">
                    <i class="fas fa-file-pdf"></i>
                </button>
                
                <!-- DEVICE COUNTER (Admin Only) -->
                <div class="device-counter-container" id="device-counter-container" style="display: none;">
                    <button class="device-counter-btn" onclick="toggleDeviceDropdown()" id="device-counter-btn" title="Active Devices">
                        <i class="fas fa-laptop"></i>
                        <span class="counter-badge" id="device-count-badge">0</span>
                    </button>
                    <div class="device-dropdown hidden" id="device-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-laptop"></i></div>
                            <div>
                                <div class="ud-header-text">Active Devices</div>
                                <div class="ud-header-sub">Connected sessions</div>
                            </div>
                        </div>
                        <div class="dropdown-list" id="device-list"></div>
                    </div>
                </div>

                <!-- ACTIVE USERS (Admin Only) -->
                <div class="active-users-container" id="active-users-container" style="display: none;">
                    <button class="active-users-btn" onclick="toggleUsersDropdown()" id="active-users-btn" title="Active Users">
                        <i class="fas fa-users"></i>
                        <span class="counter-badge" id="users-count-badge">0</span>
                    </button>
                    <div class="users-dropdown hidden" id="users-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-users"></i></div>
                            <div>
                                <div class="ud-header-text">Active Users</div>
                                <div class="ud-header-sub">Currently online</div>
                            </div>
                        </div>
                        <div class="dropdown-list" id="users-list"></div>
                    </div>
                </div>

                <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode" style="display: none;">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>

                <!-- YEAR SELECTOR -->
                <div class="year-selector-container" style="position: relative;">
                    <button class="year-selector-btn" onclick="toggleYearDropdown()" id="year-selector-btn" title="Select Year (Currently: 2026)">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                    <div class="year-dropdown hidden" id="year-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-calendar-alt"></i></div>
                            <div>
                                <div class="ud-header-text">Select Year</div>
                                <div class="ud-header-sub">Filter data by year</div>
                            </div>
                        </div>
                        <div class="year-options" id="year-options"></div>
                        <button class="year-add-btn" onclick="showAddYearDialog()" title="Add Custom Year">
                            <i class="fas fa-plus"></i> Add Year
                        </button>
                    </div>
                </div>

                <!-- NOTIFICATION BELL -->
                <div class="notification-bell-container">
                    <button class="notification-bell-btn" onclick="toggleNotificationDropdown()" id="notification-bell-btn" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge hidden" id="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown hidden" id="notification-dropdown">
                        <div class="ud-header">
                            <div class="ud-header-icon" style="background:#fff3e0"><i class="fas fa-bell" style="color:#e65100"></i></div>
                            <div>
                                <div class="ud-header-text">Overdue Reports</div>
                                <div class="ud-header-sub">Requires your attention</div>
                            </div>
                        </div>
                        <div class="notification-list" id="notification-list"></div>
                    </div>
                </div>

                <!-- SETTINGS DROPDOWN -->
                <div class="settings-dropdown-container">
                    <button class="settings-dropdown-btn" onclick="toggleSettingsDropdown()" id="settings-dropdown-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="settings-dropdown hidden" id="settings-dropdown-menu">
                        <div class="ud-header">
                            <div class="ud-header-icon"><i class="fas fa-cog"></i></div>
                            <div>
                                <div class="ud-header-text">Settings</div>
                                <div class="ud-header-sub">ESH Dashboard</div>
                            </div>
                        </div>
                        <div class="settings-menu">
                            <div class="settings-menu-item" onclick="openSettingsTab()">
                                <div class="smi-icon" style="background:#e8f5e9"><i class="fas fa-sliders-h" style="color:#2e7d32"></i></div>
                                <span class="smi-label">Account Settings</span>
                                <i class="fas fa-chevron-right smi-arrow"></i>
                            </div>
                            <div class="settings-menu-item" onclick="toggleDarkModeFromMenu()">
                                <div class="smi-icon" style="background:#e3f2fd"><i class="fas fa-moon" id="settings-theme-icon" style="color:#1976d2"></i></div>
                                <span class="smi-label" id="settings-theme-text">Dark Mode</span>
                                <i class="fas fa-chevron-right smi-arrow"></i>
                            </div>
                            <div class="settings-menu-item" onclick="saveToFirebaseMain()">
                                <div class="smi-icon" style="background:#fff8e1"><i class="fas fa-cloud-upload-alt" style="color:#f57f17"></i></div>
                                <span class="smi-label">Sync to Cloud</span>
                                <i class="fas fa-chevron-right smi-arrow"></i>
                            </div>
                            <div class="settings-divider"></div>
                            <div class="settings-menu-item logout" onclick="handleLogoutFromMenu()">
                                <div class="smi-icon"><i class="fas fa-right-from-bracket"></i></div>
                                <span class="smi-label">Logout Session</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </header>
       

 <div id="dashboard-content" style="margin-top: 20px;"></div>



<!-- ==================== ADMIN PANEL ==================== -->
<style>
    /* ‚îÄ‚îÄ Admin Panel: Option A + ESH Green/Yellow ‚îÄ‚îÄ */
    #admin-view {
        padding: 28px 32px;
        background: var(--bg-body);
    }

    .adm-wrap {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Top bar */
    .adm-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-bottom: 18px;
        border-bottom: 2px solid #2e7d32;
        margin-bottom: 22px;
    }

    .adm-topbar-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .adm-topbar-left i {
        font-size: 0.9rem;
        color: #2e7d32;
    }

    .adm-topbar-title {
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-primary);
    }

    .adm-topbar-badge {
        font-size: 0.6rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: #2e7d32;
        color: #fff;
        padding: 3px 8px;
        border-radius: 4px;
    }

    .adm-topbar-right {
        display: flex;
        align-items: center;
        gap: 20px;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .adm-topbar-right span strong {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Stats row */
    .adm-stats {
        display: flex;
        gap: 0;
        margin-bottom: 26px;
        background: var(--bg-card);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .adm-stat {
        flex: 1;
        padding: 16px 20px;
        border-right: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .adm-stat:last-child { border-right: none; }

    .adm-stat-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .adm-stat-body {}

    .adm-stat-num {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .adm-stat-label {
        font-size: 0.68rem;
        color: var(--text-secondary);
        margin-top: 3px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    /* Section label */
    .adm-section-label {
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .adm-section-label::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border-color);
    }

    /* Logbook action row */
    .adm-action-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .adm-btn-group {
        display: flex;
        gap: 4px;
    }

    .adm-btn {
        font-size: 0.72rem;
        color: var(--text-secondary);
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 11px;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.15s;
        background: var(--bg-card);
    }

    .adm-btn:hover {
        border-color: #2e7d32;
        color: #2e7d32;
    }

    .adm-btn.danger:hover {
        border-color: #c62828;
        color: #c62828;
    }

    .adm-btn i { font-size: 0.65rem; }

    /* Search row */
    .adm-search-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .adm-input {
        flex: 1;
        padding: 7px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.75rem;
        font-family: inherit;
        background: var(--input-bg);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.15s;
    }

    .adm-input:focus { border-color: #2e7d32; }

    .adm-select {
        padding: 7px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.75rem;
        font-family: inherit;
        background: var(--input-bg);
        color: var(--text-primary);
        outline: none;
    }

    /* Table */
    .adm-table-wrap {
        border: 1px solid var(--border-color);
        border-radius: 7px;
        overflow: hidden;
        margin-bottom: 28px;
    }

    /* User management */
    .adm-users-wrap {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 10px;
    }

    .adm-user-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 14px 16px;
        background: var(--bg-card);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: border-color 0.15s;
    }

    .adm-user-card:hover { border-color: #2e7d32; }

    .adm-user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #e8f5e9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        color: #2e7d32;
        flex-shrink: 0;
    }

    .adm-user-info { flex: 1; min-width: 0; }

    .adm-user-name {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .adm-user-email {
        font-size: 0.68rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
    }

    .adm-user-meta {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }

    .adm-meta-tag {
        font-size: 0.62rem;
        padding: 2px 6px;
        background: var(--bg-body);
        border-radius: 3px;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .adm-revoke-btn {
        font-size: 0.68rem;
        padding: 5px 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.15s;
        flex-shrink: 0;
    }

    .adm-revoke-btn:hover {
        border-color: #c62828;
        color: #c62828;
        background: #fff5f5;
    }

    body.dark-mode .adm-revoke-btn:hover {
        background: rgba(198,40,40,0.1);
    }

    .adm-admin-tag {
        font-size: 0.58rem;
        font-weight: 700;
        padding: 2px 7px;
        background: #2e7d32;
        color: #fff;
        border-radius: 3px;
        letter-spacing: 0.05em;
        flex-shrink: 0;
    }

    /* Yellow accent line on stat hover */
    .adm-stat:hover .adm-stat-dot {
        box-shadow: 0 0 0 3px rgba(251,192,45,0.3);
    }
</style>

<div id="admin-view" class="hidden">
    <div class="adm-wrap">

        <!-- Top bar -->
        <div class="adm-topbar">
            <div class="adm-topbar-left">
                <i class="fas fa-shield-halved"></i>
                <span class="adm-topbar-title">Admin Panel</span>
                <span class="adm-topbar-badge">Full Access</span>
            </div>
            <div class="adm-topbar-right">
                <span><strong id="admin-user-email">‚Äî</strong></span>
                <span>Session: <strong id="admin-session-time">‚Äî</strong></span>
            </div>
        </div>

        <!-- Stats row -->
        <div class="adm-stats">
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#2e7d32;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-total-users">0</div>
                    <div class="adm-stat-label">Total Users</div>
                </div>
            </div>
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#fbc02d;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-logins-24h">0</div>
                    <div class="adm-stat-label">Logins (24h)</div>
                </div>
            </div>
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#1b5e20;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-unique-ips">0</div>
                    <div class="adm-stat-label">Unique IPs (7d)</div>
                </div>
            </div>
            <div class="adm-stat">
                <div class="adm-stat-dot" style="background:#fbc02d;"></div>
                <div class="adm-stat-body">
                    <div class="adm-stat-num" id="admin-total-audits">0</div>
                    <div class="adm-stat-label">Audit Logs</div>
                </div>
            </div>
        </div>

        <!-- Login Logbook -->
        <div class="adm-section-label">Login Logbook</div>

        <div class="adm-action-row">
            <div style="font-size:0.75rem; color:var(--text-secondary);">Complete history of user logins with IP addresses and locations</div>
            <div class="adm-btn-group">
                <button class="adm-btn" onclick="refreshLogbook()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="adm-btn" onclick="exportLogbook()"><i class="fas fa-download"></i> Export CSV</button>
                <button class="adm-btn danger" onclick="clearLogbook()"><i class="fas fa-trash"></i> Clear Log</button>
            </div>
        </div>

        <div class="adm-search-row">
            <input type="text" class="adm-input" id="logbook-search" placeholder="Search by email, IP, or location‚Ä¶" onkeyup="filterLogbook()">
            <select class="adm-select" id="logbook-action-filter" onchange="filterLogbook()">
                <option value="">All Actions</option>
                <option value="LOGIN">Login Only</option>
                <option value="LOGOUT">Logout Only</option>
            </select>
        </div>

        <div class="adm-table-wrap">
            <div id="logbook-container">
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 20px; margin-bottom: 10px;"></i>
                    <p style="font-size:0.8rem;">Loading logbook...</p>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="adm-section-label">User Management</div>

        <div id="user-management-container" class="adm-users-wrap">
            <div style="padding: 30px; text-align: center; color: var(--text-secondary); grid-column: 1/-1;">
                <i class="fas fa-spinner fa-spin" style="font-size: 20px; margin-bottom: 10px;"></i>
                <p style="font-size:0.8rem;">Loading users...</p>
            </div>
        </div>

    </div>
</div>


<div id="personnel-view" class="hidden" style="padding: 20px;">
    <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color);">

        <!-- Header Banner -->
        <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); padding: 18px 24px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
            <div style="display:flex; align-items:center; gap:10px; position: relative; z-index: 2;">
                <i class="fas fa-users-gear" style="font-size:1.3rem; color:var(--safety-yellow);"></i>
                <div>
                    <div style="font-size:1rem; font-weight:800; color:white; letter-spacing:0.5px;">ESH PERSONNEL MONITORING</div>
                    <div style="font-size:0.65rem; color:#a5d6a7; margin-top:2px;">Environment, Safety &amp; Health Team Registry</div>
                </div>
            </div>
            <div id="p-summary-badges" style="display:flex; gap:8px; flex-wrap:wrap; position: relative; z-index: 2;"></div>
        </div>

        <!-- Controls Bar -->
        <div style="padding: 14px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div style="display:flex; gap:8px; flex:1; min-width:280px;">
                <select id="p-filter-column" style="padding:8px 10px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:0.75rem; min-width:150px;">
                    <option value="all">üîç Filter: All Columns</option>
                    <option value="name">Full Name</option>
                    <option value="pos">Position</option>
                    <option value="id">ID Number</option>
                    <option value="current">Current Assignment</option>
                    <option value="gen">Gender</option>
                </select>
                <input type="text" id="p-filter-value" placeholder="Search personnel..." onkeyup="filterPTable()" style="flex:1; padding:8px 12px; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-size:0.75rem;">
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-primary" onclick="openAddPersonnelModal()" style="padding:8px 16px; display:flex; align-items:center; gap:6px; font-size:0.78rem; border-radius:6px;">
                    <i class="fas fa-user-plus"></i> Add Personnel
                </button>
                <div id="p-global-action" style="display:none; gap:6px;">
                    <button class="p-edit-btn" id="p-global-edit-btn" onclick="pGlobalEdit()" style="padding:8px 14px; border-radius:6px; display:flex; align-items:center; gap:5px; font-size:0.78rem;">
                        <i class="fas fa-edit"></i> Edit All
                    </button>
                    <button class="p-save-btn" id="p-global-save-btn" onclick="pGlobalSave()" style="padding:8px 14px; border-radius:6px; display:flex; align-items:center; gap:5px; font-size:0.78rem; display:none;">
                        <i class="fas fa-save"></i> Save All
                    </button>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div style="overflow-x:auto; padding: 0;">
            <table id="p-table" style="width:100%; border-collapse:collapse; font-size:0.72rem;">
                <thead>
                    <tr style="background: linear-gradient(90deg,#1b5e20 0%,#388e3c 100%);">
                        <th style="padding:10px 12px; color:white; text-align:left; white-space:nowrap; font-weight:700; letter-spacing:0.3px; border:none; min-width:160px; position: sticky; left: 0; z-index: 10; background: #1b5e20;">#&nbsp;&nbsp;Full Name</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; width:180px;">Position</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:95px;">ID Number</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:110px;">Date Hired</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; min-width:180px;">Current Assignment</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:48px;">Age</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:80px;">Gender</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; min-width:180px;">Email</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:115px;">Contact No.</th>
                        <th style="padding:10px 8px; color:white; text-align:left; white-space:nowrap; font-weight:700; border:none; min-width:200px;">Home Address</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:70px;">Yrs. of Svc</th>
                        <th style="padding:10px 8px; color:white; text-align:center; white-space:nowrap; font-weight:700; border:none; width:100px;">Action</th>
                    </tr>
                </thead>
                <tbody id="p-body"></tbody>
            </table>
            <div id="p-empty" style="display:none; padding:40px; text-align:center; color:var(--text-secondary);">
                <i class="fas fa-users" style="font-size:2.5rem; opacity:0.3; margin-bottom:10px;"></i>
                <div style="font-size:0.85rem;">No personnel records yet. Click <strong>Add Personnel</strong> to get started.</div>
            </div>
        </div>

        <!-- Footer stats -->
        <div id="p-footer" style="padding:10px 20px; background:var(--border-color); border-top:1px solid var(--border-color); font-size:0.7rem; color:var(--text-secondary); display:flex; gap:20px; flex-wrap:wrap;"></div>
    </div>
</div>



        <div id="settings-view" class="hidden">
  <style>
    .settings-page { max-width: 780px; margin: 0 auto; padding: 28px 24px 80px; }
    .settings-hero {
      background: linear-gradient(135deg, #0a2e10 0%, #1b5e20 60%, #2e7d32 100%);
      border-radius: 16px; padding: 28px 30px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px; position: relative; overflow: hidden;
    }
    .settings-hero::before {
      content: ''; position: absolute; top: -30px; right: -30px;
      width: 180px; height: 180px; border-radius: 50%;
      background: rgba(251,192,45,0.08); pointer-events: none;
    }
    .settings-hero::after {
      content: ''; position: absolute; bottom: -50px; right: 60px;
      width: 120px; height: 120px; border-radius: 50%;
      background: rgba(255,255,255,0.04); pointer-events: none;
    }
    .settings-avatar {
      width: 72px; height: 72px; border-radius: 50%;
      background: rgba(255,255,255,0.12); border: 3px solid rgba(251,192,45,0.6);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.8rem; color: #fbc02d; flex-shrink: 0;
      box-shadow: 0 0 0 6px rgba(251,192,45,0.1);
    }
    .settings-hero-info { flex: 1; }
    .settings-hero-name { font-size: 1.25rem; font-weight: 800; color: white; letter-spacing: 0.3px; }
    .settings-hero-email { font-size: 0.78rem; color: #a5d6a7; margin-top: 3px; }
    .settings-hero-badge {
      background: rgba(251,192,45,0.2); border: 1px solid rgba(251,192,45,0.4);
      color: #fbc02d; font-size: 0.65rem; font-weight: 700; padding: 3px 10px;
      border-radius: 20px; letter-spacing: 0.5px; margin-top: 8px; display: inline-block;
    }
    .settings-sync-status {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.7rem; color: #a5d6a7; margin-top: 6px;
    }
    .settings-sync-dot {
      width: 7px; height: 7px; border-radius: 50%; background: #4caf50;
      animation: pulse 2s infinite;
    }

    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    @media (max-width: 620px) { .settings-grid { grid-template-columns: 1fr; } }

    .settings-card {
      background: var(--bg-card); border-radius: 14px; overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 12px rgba(0,0,0,0.06); transition: box-shadow 0.2s;
    }
    .settings-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .settings-card-full { grid-column: 1 / -1; }
    .settings-card-header {
      background: linear-gradient(90deg, #1b5e20 0%, #2e7d32 100%);
      padding: 13px 18px; display: flex; align-items: center; gap: 10px;
    }
    .settings-card-header i { color: #fbc02d; font-size: 0.95rem; }
    .settings-card-title { color: white; font-weight: 700; font-size: 0.82rem; letter-spacing: 0.5px; }
    .settings-card-body { padding: 18px; }

    .settings-input-group { margin-bottom: 14px; position: relative; }
    .settings-input-group:last-child { margin-bottom: 0; }
    .settings-label {
      display: block; font-size: 0.72rem; font-weight: 700;
      color: var(--text-secondary); letter-spacing: 0.5px;
      text-transform: uppercase; margin-bottom: 6px;
    }
    .settings-input {
      width: 100%; padding: 11px 14px; border: 1.5px solid var(--border-color);
      border-radius: 8px; font-size: 0.85rem; background: var(--input-bg);
      color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .settings-input:focus {
      outline: none; border-color: #2e7d32;
      box-shadow: 0 0 0 3px rgba(46,125,50,0.15);
    }
    .settings-input:disabled {
      opacity: 0.65; cursor: not-allowed; background: var(--border-color);
    }
    .settings-input-icon { position: relative; }
    .settings-input-icon .settings-input { padding-right: 42px; }
    .settings-input-icon .icon-btn {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text-secondary);
      font-size: 0.9rem; padding: 4px; transition: color 0.2s;
    }
    .settings-input-icon .icon-btn:hover { color: #1b5e20; }

    .settings-btn {
      width: 100%; padding: 11px; border: none; border-radius: 8px;
      font-size: 0.82rem; font-weight: 700; cursor: pointer;
      letter-spacing: 0.5px; display: flex; align-items: center;
      justify-content: center; gap: 8px; transition: all 0.2s; margin-top: 4px;
    }
    .settings-btn-primary {
      background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
      color: white; box-shadow: 0 3px 10px rgba(27,94,32,0.3);
    }
    .settings-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(27,94,32,0.4); }
    .settings-btn-primary:disabled { opacity: 0.6; cursor: wait; transform: none; }
    .settings-btn-danger { background: #ffebee; color: #c62828; border: 1.5px solid #ffcdd2; }
    .settings-btn-danger:hover { background: #c62828; color: white; border-color: #c62828; }
    .settings-btn-outline {
      background: transparent; color: #1b5e20;
      border: 1.5px solid #2e7d32;
    }
    .settings-btn-outline:hover { background: #e8f5e9; }
    .settings-btn + .settings-btn { margin-top: 8px; }

    .settings-msg {
      margin-top: 10px; padding: 10px 14px; border-radius: 7px;
      font-size: 0.78rem; font-weight: 600; display: none;
    }
    .settings-msg.success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; display: block; }
    .settings-msg.error { background: #ffebee; color: #c62828; border-left: 4px solid #f44336; display: block; }
    .settings-msg.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; display: block; }
    .settings-msg.loading { background: #f3e5f5; color: #6a1b9a; border-left: 4px solid #9c27b0; display: flex; align-items: center; gap: 8px; }

    .settings-divider { height: 1px; background: var(--border-color); margin: 14px 0; }

    .danger-zone-card .settings-card-header { background: linear-gradient(90deg, #b71c1c 0%, #d32f2f 100%); }

    .theme-options { display: flex; gap: 10px; margin-bottom: 14px; }
    .theme-option {
      flex: 1; padding: 12px 8px; border-radius: 10px; cursor: pointer;
      border: 2px solid var(--border-color); text-align: center;
      transition: all 0.2s; font-size: 0.75rem; font-weight: 600;
    }
    .theme-option:hover { border-color: #2e7d32; }
    .theme-option.active { border-color: #2e7d32; background: #e8f5e9; color: #1b5e20; }
    body.dark-mode .theme-option.active { background: rgba(46,125,50,0.2); }
    .theme-option .theme-icon { font-size: 1.5rem; margin-bottom: 5px; }

    .info-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.78rem;
    }
    .info-row:last-child { border-bottom: none; padding-bottom: 0; }
    .info-row-label { color: var(--text-secondary); font-weight: 600; }
    .info-row-value { color: var(--text-primary); font-weight: 500; }
    .firebase-status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 700;
    }
    .firebase-status-badge.connected { background: #e8f5e9; color: #2e7d32; }
    .firebase-status-badge.disconnected { background: #ffebee; color: #c62828; }

    .username-display {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: var(--input-bg); border: 1.5px solid var(--border-color);
      border-radius: 8px; margin-bottom: 4px;
    }
    .username-display-text { font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
    .username-edit-btn {
      background: none; border: none; cursor: pointer;
      color: #1976D2; font-size: 0.75rem; font-weight: 600;
      display: flex; align-items: center; gap: 4px;
    }
    .username-edit-btn:hover { color: #1565c0; }
  </style>

  <div class="settings-page">

    <!-- Hero Header -->
    <div class="settings-hero">
      <div class="settings-avatar"><i class="fas fa-user-shield"></i></div>
      <div class="settings-hero-info">
        <div class="settings-hero-name" id="settings-display-name">ESH User</div>
        <div class="settings-hero-email" id="settings-hero-email">Loading...</div>
        <div class="settings-hero-badge"><i class="fas fa-shield-halved"></i> &nbsp;ESH COMPLIANCE OFFICER</div>
        <div class="settings-sync-status">
          <span class="settings-sync-dot"></span>
          <span id="settings-firebase-sync-label">Connected to Firebase</span>
        </div>
      </div>
    </div>

    <div class="settings-grid">

      <!-- Profile / Display Name -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-id-badge"></i>
          <span class="settings-card-title">DISPLAY NAME</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">Current Display Name</label>
            <div class="username-display">
              <span class="username-display-text" id="current-display-name-text">‚Äî</span>
              <button class="username-edit-btn" onclick="toggleUsernameEdit()">
                <i class="fas fa-pencil"></i> Edit
              </button>
            </div>
          </div>
          <div id="username-edit-fields" style="display:none;">
            <div class="settings-input-group">
              <label class="settings-label">New Display Name</label>
              <input type="text" id="new-display-name" class="settings-input" placeholder="Enter display name" maxlength="40">
            </div>
            <button class="settings-btn settings-btn-primary" id="save-name-btn" onclick="saveDisplayName()">
              <i class="fas fa-save"></i> SAVE NAME
            </button>
          </div>
          <div id="name-msg" class="settings-msg"></div>
        </div>
      </div>

      <!-- Account Info -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-circle-info"></i>
          <span class="settings-card-title">ACCOUNT INFO</span>
        </div>
        <div class="settings-card-body">
          <div class="info-row">
            <span class="info-row-label">Email</span>
            <span class="info-row-value" id="current-email" style="font-size:0.75rem; word-break:break-all;">‚Äî</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Firebase UID</span>
            <span class="info-row-value" id="settings-uid" style="font-size:0.65rem; font-family:monospace; color:var(--text-secondary);">‚Äî</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Firebase Status</span>
            <span id="settings-firebase-status" class="firebase-status-badge connected">
              <i class="fas fa-wifi"></i> Connected
            </span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Last Sync</span>
            <span class="info-row-value" id="settings-last-sync">‚Äî</span>
          </div>
          <div class="info-row">
            <span class="info-row-label">Total Projects</span>
            <span class="info-row-value" id="settings-total-projects">‚Äî</span>
          </div>
        </div>
      </div>

      <!-- Change Password - IMPROVED SECURITY -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-lock"></i>
          <span class="settings-card-title">CHANGE PASSWORD</span>
          <span style="font-size: 11px; color: var(--safety-yellow); background: rgba(251, 192, 45, 0.15); padding: 3px 8px; border-radius: 4px; margin-left: 10px;">
            üîê Enhanced Security
          </span>
        </div>
        <div class="settings-card-body">
          
          <!-- SECURITY INFO BOX -->
          <div style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
            <div style="display: flex; align-items: start; gap: 10px;">
              <i class="fas fa-shield-alt" style="font-size: 20px; margin-top: 2px;"></i>
              <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 6px; font-size: 13px;">üîí Security Requirements:</strong>
                <ul style="margin: 0; padding-left: 18px; font-size: 11px; line-height: 1.5;">
                  <li>Must enter your <strong>current password</strong> to verify identity</li>
                  <li>New password: <strong>8+ characters</strong>, include <strong>numbers & special chars</strong></li>
                  <li>All devices will be <strong>logged out automatically</strong></li>
                  <li>You'll receive an <strong>email confirmation</strong></li>
                </ul>
              </div>
            </div>
          </div>

          <!-- CURRENT PASSWORD -->
          <div class="settings-input-group">
            <label class="settings-label">
              <i class="fas fa-lock"></i> Current Password
              <span style="color: #e53935; font-size: 11px; font-weight: normal;">(Required for verification)</span>
            </label>
            <div class="settings-input-icon">
              <input type="password" id="current-password" class="settings-input" placeholder="Enter your current password">
              <button class="icon-btn" onclick="togglePwd('current-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>

          <!-- NEW PASSWORD -->
          <div class="settings-input-group">
            <label class="settings-label">
              <i class="fas fa-key"></i> New Password
              <span style="color: #666; font-size: 11px; font-weight: normal;">(Min. 8 characters)</span>
            </label>
            <div class="settings-input-icon">
              <input type="password" id="new-password" class="settings-input" placeholder="Min. 8 chars, include numbers & special chars">
              <button class="icon-btn" onclick="togglePwd('new-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          
          <!-- PASSWORD STRENGTH INDICATOR -->
          <div id="pwd-strength" style="margin-bottom:10px; font-size:0.75rem; min-height:16px; font-weight: 500;"></div>

          <!-- CONFIRM PASSWORD -->
          <div class="settings-input-group">
            <label class="settings-label">
              <i class="fas fa-check-double"></i> Confirm New Password
            </label>
            <div class="settings-input-icon">
              <input type="password" id="confirm-password" class="settings-input" placeholder="Re-enter new password">
              <button class="icon-btn" onclick="togglePwd('confirm-password', this)" tabindex="-1"><i class="fas fa-eye"></i></button>
            </div>
          </div>

          <!-- UPDATE BUTTON -->
          <button class="settings-btn settings-btn-primary" id="update-pwd-btn" onclick="updatePasswordSecure()">
            <i class="fas fa-key"></i> UPDATE PASSWORD
          </button>
          
          <!-- PASSWORD RESET OPTION -->
          <div style="margin-top: 12px; padding: 10px; background: rgba(25, 118, 210, 0.05); border-left: 3px solid #1976d2; border-radius: 4px;">
            <strong style="color: #1976d2; display: block; margin-bottom: 4px; font-size: 12px;">
              <i class="fas fa-envelope"></i> Forgot your current password?
            </strong>
            <p style="margin: 0 0 8px 0; font-size: 11px; color: #666;">
              We'll send a password reset link to your email
            </p>
            <button class="settings-btn settings-btn-outline" style="margin-top:0;" onclick="sendPasswordReset()">
              <i class="fas fa-paper-plane"></i> SEND RESET EMAIL
            </button>
          </div>

          <!-- STATUS MESSAGE -->
          <div id="settings-message" class="settings-msg"></div>
        </div>
      </div>

      <!-- Appearance -->
      <div class="settings-card">
        <div class="settings-card-header">
          <i class="fas fa-palette"></i>
          <span class="settings-card-title">APPEARANCE</span>
        </div>
        <div class="settings-card-body">
          <div class="settings-input-group">
            <label class="settings-label">Theme</label>
            <div class="theme-options">
              <div class="theme-option" id="theme-light-btn" onclick="applyTheme('light')">
                <div class="theme-icon">‚òÄÔ∏è</div>
                Light Mode
              </div>
              <div class="theme-option" id="theme-dark-btn" onclick="applyTheme('dark')">
                <div class="theme-icon">üåô</div>
                Dark Mode
              </div>
            </div>
          </div>
          <div class="settings-divider"></div>
          <!-- Force Sync - Admin Only -->
          <div class="settings-input-group" style="margin-bottom:0;" id="force-sync-section">
            <label class="settings-label">Firebase Cloud Sync</label>
            <button class="settings-btn settings-btn-primary" onclick="saveToFirebaseMain()">
              <i class="fas fa-cloud-upload-alt"></i> FORCE SYNC TO CLOUD
            </button>
          </div>
        </div>
      </div>

      <!-- Year Data Management - Full Width - Admin Only -->
      <div class="settings-card settings-card-full" id="year-management-section">
        <div class="settings-card-header">
          <i class="fas fa-calendar-check"></i>
          <span class="settings-card-title">YEAR DATA MANAGEMENT</span>
        </div>
        <div class="settings-card-body">
          <div style="background: #e8f5e9; border-left: 4px solid #2e7d32; padding: 14px; border-radius: 6px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <i class="fas fa-info-circle" style="color: #2e7d32;"></i>
              <strong style="color: #1b5e20; font-size: 0.85rem;">Current Year: <span id="settings-current-year">2026</span></strong>
            </div>
            <p style="margin: 0; font-size: 0.75rem; color: #2e7d32;">
              Each year's data is stored separately. You can copy data from previous years to save time.
            </p>
          </div>
          
          <div class="settings-input-group">
            <label class="settings-label">Copy Data From Previous Year</label>
            <div style="display: flex; gap: 10px;">
              <select id="source-year-select" class="settings-input" style="flex: 1;">
                <option value="">Select source year...</option>
              </select>
              <button class="settings-btn settings-btn-primary" style="width: auto; padding: 11px 20px; margin: 0;" onclick="copyDataFromYear()">
                <i class="fas fa-copy"></i> Copy Data
              </button>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px;">
              <i class="fas fa-lightbulb" style="color: #fbc02d;"></i>
              This will copy projects, personnel, and incident data from the selected year to <strong id="target-year-display">2026</strong>.
            </div>
          </div>
          
          <div class="settings-input-group" style="margin-top: 20px;">
            <label class="settings-label">Export Current Year Data</label>
            <button class="settings-btn settings-btn-outline" onclick="exportYearToExcel()">
              <i class="fas fa-file-csv"></i> Export <span id="export-year-display">2026</span> to CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Backup & Recovery - Full Width -->
      <div class="settings-card settings-card-full">
        <div class="settings-card-header">
          <i class="fas fa-database"></i>
          <span class="settings-card-title">BACKUP &amp; RECOVERY</span>
        </div>
        <div class="settings-card-body">
          <div id="backup-recovery-section"></div>
        </div>
      </div>

      <!-- Audit Trail Log - Full Width - Admin Only -->
      <div class="settings-card settings-card-full" id="audit-trail-section">
        <div class="settings-card-header">
          <i class="fas fa-history"></i>
          <span class="settings-card-title">AUDIT TRAIL</span>
          <span style="font-size: 11px; color: var(--safety-yellow); background: rgba(251, 192, 45, 0.15); padding: 3px 8px; border-radius: 4px; margin-left: 10px;">
            üìù Activity Log
          </span>
        </div>
        <div class="settings-card-body">
          <p style="margin: 0 0 15px 0; font-size: 0.85rem; color: var(--text-secondary);">
            Complete log of all actions performed in the system. Changes are tracked automatically for security and compliance.
          </p>
          
          <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <button class="settings-btn settings-btn-secondary" onclick="viewAuditLog()">
              <i class="fas fa-list"></i> VIEW LOG
            </button>
            <button class="settings-btn settings-btn-secondary" onclick="exportAuditLog()">
              <i class="fas fa-download"></i> EXPORT CSV
            </button>
            <button class="settings-btn settings-btn-secondary" onclick="clearAuditLog()">
              <i class="fas fa-trash"></i> CLEAR LOG
            </button>
          </div>
          
          <div style="background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%); padding: 12px 15px; border-radius: 8px; color: white;">
            <div style="display: flex; align-items: start; gap: 10px;">
              <i class="fas fa-info-circle" style="font-size: 20px; margin-top: 2px;"></i>
              <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 6px; font-size: 13px;">What's Logged:</strong>
                <ul style="margin: 0; padding-left: 18px; font-size: 11px; line-height: 1.5;">
                  <li>Project additions, edits, and deletions</li>
                  <li>Data changes and updates</li>
                  <li>User login and logout activities</li>
                  <li>Settings modifications</li>
                  <li>File uploads and downloads</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div id="audit-log-preview" style="margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; background: var(--input-bg); display: none;">
            <!-- Audit log entries will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Danger Zone - Full Width - Admin Only -->
      <div class="settings-card settings-card-full danger-zone-card" id="danger-zone-section">
        <div class="settings-card-header">
          <i class="fas fa-triangle-exclamation"></i>
          <span class="settings-card-title">DANGER ZONE</span>
        </div>
        <div class="settings-card-body">
          <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
            <div>
              <div style="font-size:0.85rem; font-weight:700; color:var(--text-primary); margin-bottom:3px;">Sign Out of All Sessions</div>
              <div style="font-size:0.75rem; color:var(--text-secondary);">Logs you out and clears local session data.</div>
            </div>
            <button class="settings-btn settings-btn-danger" style="width:auto; padding:10px 22px;" onclick="handleLogout()">
              <i class="fas fa-right-from-bracket"></i> LOGOUT SESSION
            </button>
          </div>
          
          <!-- Footer - Copyright (Two-liner, Centered) -->
          <div style="text-align: center; padding: 30px 20px 10px; margin-top: 20px; border-top: 1px solid var(--border-color);">
            <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.8;">
              <div style="opacity: 0.9;">¬© <span id="copyright-year">2026</span> Sta. Clara International Corporation. All rights reserved.</div>
              <div style="opacity: 0.8; font-size: 0.72rem;">Environmental Safety & Health Department</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
            
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>

// ===== BACKUP & RECOVERY SYSTEM =====
let backupManager = {
    backups: [],
    autoSaveInterval: null,
    maxBackups: 10,
    autoSaveFrequency: 300000, // 5 minutes in milliseconds

    init() {
        this.loadBackupsFromStorage();
        this.startAutoSave();
        console.log('‚úÖ Backup Manager Initialized');
    },

    loadBackupsFromStorage() {
        const saved = localStorage.getItem('esh_backups');
        this.backups = saved ? JSON.parse(saved) : [];
    },

    saveBackupsToStorage() {
        localStorage.setItem('esh_backups', JSON.stringify(this.backups));
    },

    createBackup(manual = false) {
        if (!state.currentUser) return false;

        const backup = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            email: state.currentUser.email,
            projects: JSON.parse(JSON.stringify(state.projects)),
            manual: manual,
            size: JSON.stringify(state.projects).length
        };

        this.backups.unshift(backup);

        // Keep only latest backups
        if (this.backups.length > this.maxBackups) {
            this.backups = this.backups.slice(0, this.maxBackups);
        }

        this.saveBackupsToStorage();
        return backup;
    },

    startAutoSave() {
        this.autoSaveInterval = setInterval(() => {
            if (state.isLoggedIn) {
                this.createBackup(false);
                console.log('‚úÖ Auto-backup created');
            }
        }, this.autoSaveFrequency);
    },

    stopAutoSave() {
        if (this.autoSaveInterval) {
            clearInterval(this.autoSaveInterval);
        }
    },

    getBackupsForUser(email) {
        return this.backups.filter(b => b.email === email);
    },

    restoreBackup(backupId) {
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup) {
            console.error('Backup not found');
            return false;
        }

        state.projects = JSON.parse(JSON.stringify(backup.projects));
        state.filteredProjects = [...state.projects];
        saveUserData(state.currentUser.email);
        render();
        return true;
    },

    deleteBackup(backupId) {
        this.backups = this.backups.filter(b => b.id !== backupId);
        this.saveBackupsToStorage();
        return true;
    },

    exportBackup(backupId) {
        const backup = this.backups.find(b => b.id === backupId);
        if (!backup) return false;

        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `esh_backup_${backup.timestamp.split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        return true;
    },

    importBackup(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.projects && Array.isArray(backup.projects)) {
                        state.projects = backup.projects;
                        state.filteredProjects = [...state.projects];
                        saveUserData(state.currentUser.email);
                        this.createBackup(true);
                        render();
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                } catch (error) {
                    console.error('Error importing backup:', error);
                    resolve(false);
                }
            };
            reader.readAsText(file);
        });
    },

    formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('en-PH', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
};

function showBackupRecoveryUI() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    const lastBackup = userBackups[0];
    const lastBackupTime = lastBackup ? backupManager.formatDate(lastBackup.timestamp) : 'Never';
    
    // Show only 3 backups initially
    const showAllBackups = window.showAllBackupsFlag === true;
    const displayBackups = showAllBackups ? userBackups : userBackups.slice(0, 3);
    const hasMore = userBackups.length > 3;

    let html = `
        <div class="backup-section">
            <h4><i class="fas fa-shield-alt"></i> Backup & Recovery</h4>
            
            <div class="backup-info">
                <strong>Last Auto-Backup:</strong> ${lastBackupTime}<br>
                <strong>Total Backups:</strong> ${userBackups.length} / ${backupManager.maxBackups}<br>
                <strong>Auto-save Frequency:</strong> Every 5 minutes
            </div>

            <div class="backup-buttons">
                <button class="btn btn-primary" onclick="createManualBackup()">
                    <i class="fas fa-download"></i> Create Manual Backup
                </button>
                <button class="btn btn-primary" onclick="exportCurrentBackup()">
                    <i class="fas fa-file-export"></i> Export Backup
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('import-backup-input').click()">
                    <i class="fas fa-file-import"></i> Import Backup
                </button>
            </div>

            <input type="file" id="import-backup-input" accept=".json" style="display:none;" onchange="importBackupFile(this)">

            <div id="backup-status-message"></div>

            <div class="backup-list">
                <h5 style="color: #1b5e20; margin-top: 20px; margin-bottom: 10px;">
                    <i class="fas fa-history"></i> Backup History
                </h5>
                ${userBackups.length > 0 ? displayBackups.map(backup => `
                    <div class="backup-item">
                        <div class="backup-item-info">
                            <div class="backup-item-date">
                                ${backup.manual ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'} 
                                ${backupManager.formatDate(backup.timestamp)}
                            </div>
                            <div class="backup-item-size">
                                ${backupManager.formatSize(backup.size)} ‚Ä¢ 
                                ${backup.projects.length} projects
                            </div>
                        </div>
                        <div class="backup-item-actions">
                            <button class="backup-item-btn backup-item-btn-restore" onclick="restoreBackupConfirm(${backup.id})">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button class="backup-item-btn backup-item-btn-delete" onclick="deleteBackupConfirm(${backup.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('') : '<p style="color: var(--text-secondary); font-size: 0.85rem;">No backups available</p>'}
                
                ${hasMore && !showAllBackups ? `
                    <button class="btn btn-outline" onclick="toggleShowAllBackups()" style="width: 100%; margin-top: 15px; padding: 10px;">
                        <i class="fas fa-chevron-down"></i> See More (${userBackups.length - 3} more backups)
                    </button>
                ` : ''}
                
                ${showAllBackups && hasMore ? `
                    <button class="btn btn-outline" onclick="toggleShowAllBackups()" style="width: 100%; margin-top: 15px; padding: 10px;">
                        <i class="fas fa-chevron-up"></i> Show Less
                    </button>
                ` : ''}
            </div>
        </div>
    `;

    return html;
}

// Toggle show all backups
function toggleShowAllBackups() {
    window.showAllBackupsFlag = !window.showAllBackupsFlag;
    const backupSection = document.getElementById('backup-recovery-section');
    if (backupSection) backupSection.innerHTML = showBackupRecoveryUI();
}

function createManualBackup() {
    const backup = backupManager.createBackup(true);
    if (backup) {
        showBackupStatus('‚úÖ Backup created successfully!', 'success');
        setTimeout(() => {
            changeTab('settings');
        }, 500);
    }
}

function exportCurrentBackup() {
    const userBackups = backupManager.getBackupsForUser(state.currentUser.email);
    if (userBackups.length === 0) {
        showBackupStatus('‚ö†Ô∏è No backups to export', 'error');
        return;
    }
    backupManager.exportBackup(userBackups[0].id);
    showBackupStatus('‚úÖ Backup exported successfully!', 'success');
}

function importBackupFile(input) {
    const file = input.files[0];
    if (!file) return;

    backupManager.importBackup(file).then(success => {
        if (success) {
            showBackupStatus('‚úÖ Backup imported and restored successfully!', 'success');
            setTimeout(() => {
                changeTab('settings');
            }, 500);
        } else {
            showBackupStatus('‚ùå Invalid backup file format', 'error');
        }
    });

    input.value = '';
}

function restoreBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Restore Backup',
        `Restore data from ${backupManager.formatDate(backup.timestamp)}? Your current data will be replaced.`,
        false
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.restoreBackup(backupId)) {
                showBackupStatus('‚úÖ Backup restored successfully!', 'success');
                setTimeout(() => {
                    changeTab('overall');
                }, 500);
            } else {
                showBackupStatus('‚ùå Failed to restore backup', 'error');
            }
        }
    });
}

function deleteBackupConfirm(backupId) {
    const backup = backupManager.backups.find(b => b.id === backupId);
    if (!backup) return;

    showModernDialog(
        'Delete Backup',
        `Delete backup from ${backupManager.formatDate(backup.timestamp)}? This cannot be undone.`,
        true
    ).then(confirmed => {
        if (confirmed) {
            if (backupManager.deleteBackup(backupId)) {
                showBackupStatus('‚úÖ Backup deleted successfully!', 'success');
                setTimeout(() => {
                    changeTab('settings');
                }, 500);
            } else {
                showBackupStatus('‚ùå Failed to delete backup', 'error');
            }
        }
    });
}

function showBackupStatus(message, type) {
    const statusDiv = document.getElementById('backup-status-message');
    if (!statusDiv) return;

    statusDiv.innerHTML = `<div class="backup-status ${type}">${message}</div>`;
    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, 4000);
}

// ==================== AUDIT LOG FUNCTIONS ====================
function viewAuditLog() {
    const preview = document.getElementById('audit-log-preview');
    if (!preview) return;
    
    if (preview.style.display === 'none') {
        const recentLogs = AuditLogger.getRecent(50);
        
        if (recentLogs.length === 0) {
            preview.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No audit logs yet</p>';
        } else {
            preview.innerHTML = recentLogs.map(log => {
                // Format details in a readable way
                let detailsHTML = '';
                if (Object.keys(log.details).length > 0) {
                    const details = log.details;
                    let detailItems = [];
                    
                    // Format each detail field nicely
                    if (details.projectName) detailItems.push(`Project: ${details.projectName}`);
                    if (details.email) detailItems.push(`Email: ${details.email}`);
                    if (details.status) detailItems.push(`Status: ${details.status}`);
                    if (details.year) detailItems.push(`Year: ${details.year}`);
                    if (details.tab) detailItems.push(`Tab: ${details.tab}`);
                    if (details.step !== undefined) detailItems.push(`Step: ${details.step}`);
                    if (details.totalSteps !== undefined) detailItems.push(`Total Steps: ${details.totalSteps}`);
                    if (details.remainingProjects !== undefined) detailItems.push(`Remaining: ${details.remainingProjects}`);
                    if (details.exportDate) detailItems.push(`Export Date: ${new Date(details.exportDate).toLocaleString()}`);
                    if (details.timestamp) detailItems.push(`Time: ${new Date(details.timestamp).toLocaleString()}`);
                    
                    if (detailItems.length > 0) {
                        detailsHTML = `
                            <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 5px; padding: 5px 10px; background: rgba(0,0,0,0.03); border-radius: 4px;">
                                ${detailItems.join(' ‚Ä¢ ')}
                            </div>
                        `;
                    }
                }
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border-color); font-size: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <strong style="color: var(--text-primary); font-size: 0.85rem;">${formatActionName(log.action)}</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem; white-space: nowrap; margin-left: 10px;">
                                ${new Date(log.timestamp).toLocaleString()}
                            </span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.75rem;">
                            üë§ ${log.userName} | üìÖ Year ${log.year}
                        </div>
                        ${detailsHTML}
                    </div>
                `;
            }).join('');
        }
        
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Helper function to format action names nicely
function formatActionName(action) {
    const actionNames = {
        'USER_LOGIN': 'üîê User Login',
        'USER_LOGOUT': 'üö™ User Logout',
        'USER_ONLINE': 'üåê User Connected',
        'PROJECT_CREATED': '‚ûï Project Created',
        'PROJECT_EDITED': '‚úèÔ∏è Project Edited',
        'PROJECT_DELETED': 'üóëÔ∏è Project Deleted',
        'DATA_SAVED': 'üíæ Data Saved',
        'TUTORIAL_STARTED': 'üéì Tutorial Started',
        'TUTORIAL_COMPLETED': '‚úÖ Tutorial Completed',
        'TUTORIAL_SKIPPED': '‚è≠Ô∏è Tutorial Skipped',
        'HELP_VIEWED': '‚ùì Help Viewed',
        'SYSTEM_ONLINE': 'üåê System Online',
        'SYSTEM_OFFLINE': 'üìµ System Offline',
        'AUDIT_LOG_EXPORTED': 'üì• Audit Log Exported',
        'PASSWORD_CHANGED': 'üîë Password Changed',
        'SETTINGS_UPDATED': '‚öôÔ∏è Settings Updated'
    };
    
    return actionNames[action] || action.replace(/_/g, ' ');
}

function exportAuditLog() {
    const csv = AuditLogger.exportToCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showToast('üì• Audit log exported successfully!', 'success');
    AuditLogger.log('AUDIT_LOG_EXPORTED', { exportDate: new Date().toISOString() });
}

async function clearAuditLog() {
    const confirmed = await showModernDialog(
        'üóëÔ∏è Clear Audit Log',
        'Are you sure you want to clear the audit log? This action cannot be undone.',
        true
    );
    
    if (confirmed) {
        state.auditLog = [];
        localStorage.removeItem('esh_audit_log');
        
        const preview = document.getElementById('audit-log-preview');
        if (preview) {
            preview.style.display = 'none';
        }
        
        showToast('‚úÖ Audit log cleared', 'success');
    }
}

// ==================== ADMIN PANEL FUNCTIONS ====================
function renderAdminPanel() {
    if (!state.isAdmin) {
        showToast('‚õî Access Denied: Admin privileges required', 'error');
        changeTab('overall');
        return;
    }
    
    // Update admin email
    document.getElementById('admin-user-email').textContent = state.currentUser.email;
    
    // Update stats
    updateAdminStats();
    
    // Render logbook
    renderLogbook();
    
    // Render user management
    renderUserManagement();
    
    // Update session time every second
    updateSessionTime();
}

function updateAdminStats() {
    // Total unique devices (based on IP + User Agent combination)
    const devices = new Set(
        state.loginLogbook.map(entry => `${entry.ip}_${entry.userAgent}`)
    );
    document.getElementById('admin-total-users').textContent = devices.size;
    // Update label
    const label = document.querySelector('#admin-total-users').parentElement.parentElement.querySelector('.stat-secondary');
    if (label) label.textContent = 'Unique Devices';
    
    // Active sessions in last 24 hours
    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
    const logins24h = state.loginLogbook.filter(entry => 
        entry.action === 'LOGIN' && new Date(entry.timestamp).getTime() > oneDayAgo
    ).length;
    document.getElementById('admin-logins-24h').textContent = logins24h;
    
    // Unique IPs in last 7 days
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    const uniqueIps = new Set(
        state.loginLogbook
            .filter(entry => new Date(entry.timestamp).getTime() > sevenDaysAgo)
            .map(entry => entry.ip)
    );
    document.getElementById('admin-unique-ips').textContent = uniqueIps.size;
    
    // Total audit logs
    document.getElementById('admin-total-audits').textContent = state.auditLog.length;
}

function updateSessionTime() {
    // Store session start in localStorage so it persists on refresh
    if (!localStorage.getItem('esh_session_start')) {
        localStorage.setItem('esh_session_start', Date.now().toString());
    }
    
    setInterval(() => {
        const sessionStart = parseInt(localStorage.getItem('esh_session_start'));
        const now = Date.now();
        const diff = now - sessionStart;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        const el = document.getElementById('admin-session-time');
        if (el) {
            el.textContent = hours > 0
                ? `${hours}h ${minutes}m ${seconds}s`
                : `${minutes}m ${seconds}s`;
        }
    }, 1000);
}

function renderLogbook() {
    const container = document.getElementById('logbook-container');
    const logs = state.loginLogbook;
    
    if (logs.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                <p style="font-size: 1.1rem; font-weight: 600;">No login records yet</p>
                <p style="font-size: 0.9rem;">Login history will appear here</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 0.78rem; table-layout: fixed;">
            <thead>
                <tr style="background: var(--bg-body);">
                    <th style="width:13%; padding: 9px 14px; text-align: left;   font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Timestamp</th>
                    <th style="width:9%;  padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Action</th>
                    <th style="width:18%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">User</th>
                    <th style="width:13%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">IP Address</th>
                    <th style="width:17%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Location</th>
                    <th style="width:16%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Device</th>
                    <th style="width:14%; padding: 9px 14px; text-align: center; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">Browser</th>
                </tr>
            </thead>
            <tbody id="logbook-tbody">
                ${logs.slice(0, 100).map((entry, index) => `
                    <tr style="border-bottom: 1px solid var(--border-color); background: ${index % 2 === 0 ? 'var(--bg-card)' : 'var(--bg-body)'};">
                        <td style="padding: 9px 14px; white-space: nowrap; text-align: left;">
                            <div style="font-weight: 600; font-size: 0.75rem; color: var(--text-primary);">${new Date(entry.timestamp).toLocaleDateString()}</div>
                            <div style="font-size: 0.68rem; color: var(--text-secondary);">${new Date(entry.timestamp).toLocaleTimeString()}</div>
                        </td>
                        <td style="padding: 9px 14px; text-align: center;">
                            <span style="padding: 2px 8px; border-radius: 3px; font-weight: 600; font-size: 0.65rem; letter-spacing: 0.04em; ${entry.action === 'LOGIN' ? 'background: #e8f5e9; color: #2e7d32;' : 'background: #fce4ec; color: #c62828;'}">
                                ${entry.action === 'LOGIN' ? 'LOGIN' : 'LOGOUT'}
                            </span>
                        </td>
                        <td style="padding: 9px 14px; text-align: center;">
                            <div style="font-weight: 600; font-size: 0.75rem; color: var(--text-primary);">${entry.displayName || 'Unknown'}</div>
                            <div style="font-size: 0.68rem; color: var(--text-secondary);">${entry.email}</div>
                        </td>
                        <td style="padding: 9px 14px; text-align: center;">
                            <span style="font-family: monospace; font-size: 0.72rem; color: var(--text-secondary);">${entry.ip || 'Unknown'}</span>
                        </td>
                        <td style="padding: 9px 14px; text-align: center;">
                            <div style="display: inline-flex; align-items: center; gap: 5px;">
                                <span>${getCountryFlag(entry.country)}</span>
                                <div style="text-align: left;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">${entry.city || 'Unknown'}</div>
                                    <div style="font-size: 0.68rem; color: var(--text-secondary);">${entry.country || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 9px 14px; text-align: center; font-size: 0.73rem; color: var(--text-secondary);">${entry.device || '-'} ¬∑ ${entry.os || '-'}</td>
                        <td style="padding: 9px 14px; text-align: center; font-size: 0.73rem; color: var(--text-secondary);">${entry.browser || '-'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        ${logs.length > 100 ? `
            <div style="padding: 12px 14px; text-align: center; background: var(--bg-body); border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.75rem;">
                Showing 100 of ${logs.length} entries. <a href="#" onclick="exportLogbook(); return false;" style="color: #2e7d32; text-decoration: none; font-weight: 600;">Export all ‚Üí</a>
            </div>
        ` : ''}
    `;
}

function getCountryFlag(country) {
    const flags = {
        'Philippines': 'üáµüá≠',
        'United States': 'üá∫üá∏',
        'Japan': 'üáØüáµ',
        'Singapore': 'üá∏üá¨',
        'China': 'üá®üá≥',
        'South Korea': 'üá∞üá∑',
        'Australia': 'üá¶üá∫',
        'United Kingdom': 'üá¨üáß',
        'Canada': 'üá®üá¶',
        'Germany': 'üá©üá™'
    };
    return flags[country] || 'üåê';
}

async function renderUserManagement() {
    const container = document.getElementById('user-management-container');
    const users = await AdminSystem.getAllUsers();
    
    if (users.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                <p>No users found</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="adm-users-wrap">
            ${users.map(user => `
                <div class="adm-user-card">
                    <div class="adm-user-avatar">${(user.displayName || user.email).charAt(0).toUpperCase()}</div>
                    <div class="adm-user-info">
                        <div class="adm-user-name">${user.displayName}</div>
                        <div class="adm-user-email">${user.email}</div>
                        <div class="adm-user-meta">
                            <span class="adm-meta-tag">${user.loginCount} logins</span>
                            <span class="adm-meta-tag">${new Date(user.lastLogin).toLocaleDateString()}</span>
                        </div>
                    </div>
                    ${AdminSystem.isAdmin(user.email)
                        ? `<span class="adm-admin-tag">ADMIN</span>`
                        : `<button class="adm-revoke-btn" onclick="revokeUserAccess('${user.email}')"><i class="fas fa-ban"></i> Revoke</button>`
                    }
                </div>
            `).join('')}
        </div>
    `;
}

function refreshLogbook() {
    showToast('üîÑ Refreshing logbook...', 'info');
    updateAdminStats();
    renderLogbook();
    renderUserManagement();
    showToast('‚úÖ Logbook refreshed', 'success');
}

function exportLogbook() {
    const csv = LoginLogbook.exportToCSV();
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `login_logbook_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showToast('üì• Logbook exported successfully!', 'success');
    AuditLogger.log('LOGBOOK_EXPORTED', { admin: state.currentUser.email });
}

async function clearLogbook() {
    const confirmed = await showModernDialog(
        'üóëÔ∏è Clear Login Logbook',
        'Are you sure you want to clear the entire login logbook? This action cannot be undone.',
        true
    );
    
    if (confirmed) {
        state.loginLogbook = [];
        localStorage.removeItem('esh_login_logbook');
        renderLogbook();
        updateAdminStats();
        showToast('‚úÖ Logbook cleared', 'success');
        AuditLogger.log('LOGBOOK_CLEARED', { admin: state.currentUser.email });
    }
}

function filterLogbook() {
    const searchTerm = document.getElementById('logbook-search').value.toLowerCase();
    const actionFilter = document.getElementById('logbook-action-filter').value;
    
    let filtered = state.loginLogbook;
    
    if (searchTerm) {
        filtered = filtered.filter(entry => 
            entry.email.toLowerCase().includes(searchTerm) ||
            entry.ip.toLowerCase().includes(searchTerm) ||
            (entry.city && entry.city.toLowerCase().includes(searchTerm)) ||
            (entry.country && entry.country.toLowerCase().includes(searchTerm))
        );
    }
    
    if (actionFilter) {
        filtered = filtered.filter(entry => entry.action === actionFilter);
    }
    
    // Re-render with filtered data
    const originalLogbook = state.loginLogbook;
    state.loginLogbook = filtered;
    renderLogbook();
    state.loginLogbook = originalLogbook;
}

function viewUserActivity(email) {
    const userLogs = LoginLogbook.filterByUser(email);
    
    // Create a modal or detailed view
    showToast(`üìä ${userLogs.length} activities found for ${email}`, 'info');
    
    // You can create a custom modal here to show detailed activity
    console.log('User activity:', userLogs);
}

async function revokeUserAccess(email) {
    const confirmed = await showModernDialog(
        'üö´ Revoke Access',
        `Are you sure you want to revoke access for <strong>${email}</strong>?<br><br>This will prevent the user from logging in.`,
        true
    );
    
    if (confirmed) {
        await AdminSystem.revokeAccess(email);
        renderUserManagement();
    }
}



        const REGIONS = ["NCR", "SOUTH LUZON", "NORTH LUZON", "VISAYAS & MINDANAO"];
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       const SCHEMA = {
    'exposures': ["Total Manpower", "Total Exposed Manhour", "Total Exposed Man-hour to date", "No. of Days w/o LTA"],
    'rates': ["LTIR","TRIR","SEVERITY RATE"],
    'medical': ["Medical Treatment","First Aid","LTA","Fatality","High-Potential incident", "Dangerous Occurrences"],
    'nov': ["OSH Internal Issues", "OSH External Issues", "Environmental Internal Issues", "Environmental External Issues"],
    'activities': ["No. of ESH Committee Conducted", "No. of ESH inspection", "No. of Identified Near-Miss","Drills Conducted", "Training Conducted"],
    'kpm': ["KPM&I"],
    'audit': ["Score Implementation", "Documentation and Compliance"],
    'dole': ["WAIR","RSO", "MOM", "AEDR", "AMR"],
    'dole_annual': ["AEDR", "AMR"],
    'permits': ["ECC", "CNC", "Certificate of Accreditation (DENR-EMB)", "Certificate of Accreditation (LLDA)", "Company Registration System", "LLDA Clearance", "Permit to Operate", "Discharge Permit", "Hazardous Waste Generator's ID", "Permit to Transport (Haz Waste)", "Permit to Transport (Logs)", "Tree Cutting Permit (STCP or S/PLTP)", "Permit to Cut Coconut Tree", "NWRB Water Permit"],
    'emb': ["SMR (Quarterly) - Submission Date", "SMR (Quarterly) - Reference No.", "CMR (Semi-Annual) - Submission Date", "CMR (Semi-Annual) - Reference No."],
    'cshp': ["CSHP Approval Date"],
    'reg': ["DOLE Certificate of Registration Date"],
    'doe': ["DOE Quarterly Report Submission Date"],
    'doe-permit': ["DOE Safety Officer Permit"]
};

        // Regions are maintained - users add their own projects via "Add Project" button
        // No hard-coded projects to ensure fresh start for each user

        let state = {
            isLoggedIn: false,
            isEditing: false,
            currentTab: 'overall',
            currentUser: null,
            selectedYear: 2026, // Default year - YEAR SELECTOR FEATURE
            projects: [], // Currently displayed projects (filtered by year)
            masterProjects: [], // ALL projects from ALL years (loaded once)
            personnelData: [],
            incidentRateData: { recordableCases: 0, lostDays: 0, totalHours: 0 },
            filteredProjects: [],
            selectedProjects: [],
            charts: {},
            currentSort: 'name',
            darkMode: false,
            isDataMigrated: false, // Track if data has been migrated to year-based structure
            doePermitData: { permitNumber: '', validityDate: '' }, // NEW: DOE Safety Officer Permit
            auditLog: [], // NEW: Audit trail for all changes
            offlineQueue: [], // NEW: Queue for offline changes
            isOnline: navigator.onLine, // NEW: Online status
            isAdmin: false, // NEW: Admin role flag
            loginLogbook: [], // NEW: Login history with IP and location
            searchTerm: '', // NEW: Preserve search input
            regionFilter: '', // NEW: Preserve region filter
            statusFilter: '', // NEW: Preserve status filter
            // ==================== NEW: MULTI-USER COLLABORATION ====================
            userRole: null, // 'admin' or 'superintendent'
            userRegion: null, // 'ALL', 'NCR', 'NORTH LUZON', 'SOUTH LUZON', 'VISAYAS & MINDANAO'
            userColor: '#FF0000', // Color for user identification
            deviceFingerprint: null, // Unique device identifier
            activeUsers: {}, // Real-time presence tracking {userId: {status, activity, ...}}
            activeDevices: [], // List of active devices
            presenceListener: null, // Firebase listener for presence updates
            deviceListener: null // Firebase listener for device updates
        };

        // ==================== COMPREHENSIVE DEBUG SYSTEM ====================
        window.DEBUG_MODE = true; // Set to false to disable debug logs
        
        // ==================== DEVICE FINGERPRINTING SYSTEM ====================
        const DeviceFingerprint = {
            async generate() {
                const components = {
                    // Canvas fingerprint
                    canvas: await this.getCanvasFingerprint(),
                    // WebGL fingerprint
                    webgl: this.getWebGLFingerprint(),
                    // Screen properties
                    screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    // Timezone
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    // Language
                    language: navigator.language,
                    // Platform
                    platform: navigator.platform,
                    // User agent
                    userAgent: navigator.userAgent,
                    // Hardware concurrency (CPU cores)
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    // Device memory (if available)
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    // Plugins
                    plugins: Array.from(navigator.plugins || []).map(p => p.name).join(','),
                    // Touch support
                    touchSupport: 'ontouchstart' in window
                };
                
                // Create hash from all components
                const fingerprint = await this.hashComponents(components);
                console.log('üîë Device Fingerprint Generated:', fingerprint.substring(0, 16) + '...');
                return fingerprint;
            },
            
            async getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    ctx.textBaseline = 'top';
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText('ESH Dashboard üõ°Ô∏è', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('Fingerprint Test', 4, 17);
                    
                    return canvas.toDataURL();
                } catch (e) {
                    return 'canvas-error';
                }
            },
            
            getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) return 'no-webgl';
                    
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (!debugInfo) return 'no-debug-info';
                    
                    const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                    const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    
                    return `${vendor}~${renderer}`;
                } catch (e) {
                    return 'webgl-error';
                }
            },
            
            async hashComponents(components) {
                const str = JSON.stringify(components);
                const encoder = new TextEncoder();
                const data = encoder.encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },
            
            getPlatformInfo() {
                const ua = navigator.userAgent;
                let platform = 'Unknown';
                let browser = 'Unknown';
                
                // Detect platform
                if (ua.indexOf('Win') !== -1) platform = 'Windows';
                else if (ua.indexOf('Mac') !== -1) platform = 'MacOS';
                else if (ua.indexOf('Linux') !== -1) platform = 'Linux';
                else if (ua.indexOf('Android') !== -1) platform = 'Android';
                else if (ua.indexOf('iOS') !== -1 || ua.indexOf('iPhone') !== -1 || ua.indexOf('iPad') !== -1) platform = 'iOS';
                
                // Detect browser
                if (ua.indexOf('Chrome') !== -1 && ua.indexOf('Edg') === -1) browser = 'Chrome';
                else if (ua.indexOf('Safari') !== -1 && ua.indexOf('Chrome') === -1) browser = 'Safari';
                else if (ua.indexOf('Firefox') !== -1) browser = 'Firefox';
                else if (ua.indexOf('Edg') !== -1) browser = 'Edge';
                else if (ua.indexOf('MSIE') !== -1 || ua.indexOf('Trident') !== -1) browser = 'IE';
                
                return { platform, browser };
            }
        };
        
        // ==================== AUDIT TRAIL SYSTEM ====================
        const AuditLogger = {
            log(action, details = {}) {
                const entry = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    user: state.currentUser?.email || 'Unknown',
                    userName: state.currentUser?.displayName || 'Unknown User',
                    action: action,
                    details: details,
                    year: state.selectedYear
                };
                
                state.auditLog.unshift(entry); // Add to beginning
                
                // Keep only last 500 entries in memory
                if (state.auditLog.length > 500) {
                    state.auditLog = state.auditLog.slice(0, 500);
                }
                
                // Save to localStorage for persistence
                this.saveToStorage();
                
                console.log('üìù Audit:', action, details);
            },
            
            saveToStorage() {
                try {
                    localStorage.setItem('esh_audit_log', JSON.stringify(state.auditLog));
                } catch (e) {
                    console.error('Failed to save audit log to localStorage:', e);
                }
            },
            
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('esh_audit_log');
                    if (saved) {
                        state.auditLog = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load audit log from localStorage:', e);
                }
            },
            
            
            getRecent(limit = 50) {
                return state.auditLog.slice(0, limit);
            },
            
            filterByAction(action) {
                return state.auditLog.filter(entry => entry.action === action);
            },
            
            filterByDateRange(startDate, endDate) {
                const start = new Date(startDate).getTime();
                const end = new Date(endDate).getTime();
                return state.auditLog.filter(entry => {
                    const timestamp = new Date(entry.timestamp).getTime();
                    return timestamp >= start && timestamp <= end;
                });
            },
            
            exportToCSV() {
                const headers = ['Timestamp', 'User', 'Action', 'Details', 'Year'];
                const rows = state.auditLog.map(entry => {
                    // Format details in a readable way
                    let detailsText = '';
                    if (Object.keys(entry.details).length > 0) {
                        const details = entry.details;
                        let parts = [];
                        
                        if (details.projectName) parts.push(`Project: ${details.projectName}`);
                        if (details.email) parts.push(`Email: ${details.email}`);
                        if (details.status) parts.push(`Status: ${details.status}`);
                        if (details.year) parts.push(`Year: ${details.year}`);
                        if (details.tab) parts.push(`Tab: ${details.tab}`);
                        if (details.step !== undefined) parts.push(`Step: ${details.step}`);
                        if (details.totalSteps !== undefined) parts.push(`Total Steps: ${details.totalSteps}`);
                        if (details.remainingProjects !== undefined) parts.push(`Remaining: ${details.remainingProjects}`);
                        
                        detailsText = parts.join('; ');
                    }
                    
                    return [
                        new Date(entry.timestamp).toLocaleString(),
                        entry.userName,
                        entry.action.replace(/_/g, ' '),
                        detailsText,
                        entry.year
                    ];
                });
                
                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                return csv;
            }
        };
        
        // Load audit log on startup
        AuditLogger.loadFromStorage();
        
        // ==================== LOGIN LOGBOOK SYSTEM ====================
        const LoginLogbook = {
            async logLogin(user) {
                try {
                    // Get IP address and location info
                    const ipInfo = await this.getIPInfo();
                    
                    const entry = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        email: user.email,
                        displayName: user.displayName || 'Unknown User',
                        uid: user.uid,
                        ip: ipInfo.ip || 'Unknown',
                        country: ipInfo.country || 'Unknown',
                        region: ipInfo.region || 'Unknown',
                        city: ipInfo.city || 'Unknown',
                        timezone: ipInfo.timezone || 'Unknown',
                        isp: ipInfo.isp || 'Unknown',
                        userAgent: navigator.userAgent,
                        browser: this.getBrowserInfo(),
                        os: this.getOSInfo(),
                        device: this.getDeviceInfo(),
                        screenResolution: `${screen.width}x${screen.height}`,
                        action: 'LOGIN'
                    };
                    
                    state.loginLogbook.unshift(entry);
                    
                    // Keep only last 1000 entries
                    if (state.loginLogbook.length > 1000) {
                        state.loginLogbook = state.loginLogbook.slice(0, 1000);
                    }
                    
                    // Save to localStorage
                    this.saveToStorage();
                    
                    // Save to Firebase (only for admin viewing)
                    await this.saveToFirebase(entry);
                    
                    console.log('‚úÖ Login logged:', entry);
                } catch (error) {
                    console.error('Failed to log login:', error);
                }
            },
            
            async logLogout(user) {
                try {
                    const ipInfo = await this.getIPInfo();
                    
                    const entry = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        email: user.email,
                        displayName: user.displayName || 'Unknown User',
                        uid: user.uid,
                        ip: ipInfo.ip || 'Unknown',
                        action: 'LOGOUT'
                    };
                    
                    state.loginLogbook.unshift(entry);
                    if (state.loginLogbook.length > 1000) {
                        state.loginLogbook = state.loginLogbook.slice(0, 1000);
                    }
                    
                    this.saveToStorage();
                    await this.saveToFirebase(entry);
                } catch (error) {
                    console.error('Failed to log logout:', error);
                }
            },
            
            async getIPInfo() {
                try {
                    // Using ipapi.co for IP geolocation (free, no API key needed)
                    const response = await fetch('https://ipapi.co/json/');
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            ip: data.ip,
                            country: data.country_name,
                            region: data.region,
                            city: data.city,
                            timezone: data.timezone,
                            isp: data.org
                        };
                    }
                } catch (error) {
                    console.warn('Failed to get IP info:', error);
                }
                return {};
            },
            
            getBrowserInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                if (ua.includes('Opera')) return 'Opera';
                return 'Unknown';
            },
            
            getOSInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'macOS';
                if (ua.includes('Linux')) return 'Linux';
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('iOS')) return 'iOS';
                return 'Unknown';
            },
            
            getDeviceInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Mobile')) return 'Mobile';
                if (ua.includes('Tablet')) return 'Tablet';
                return 'Desktop';
            },
            
            saveToStorage() {
                try {
                    localStorage.setItem('esh_login_logbook', JSON.stringify(state.loginLogbook));
                } catch (e) {
                    console.error('Failed to save logbook to localStorage:', e);
                }
            },
            
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('esh_login_logbook');
                    if (saved) {
                        state.loginLogbook = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load logbook from localStorage:', e);
                }
            },
            
            async saveToFirebase(entry) {
                // Only save to Firebase if feature is enabled
                // Admin can view all login logs from Firebase
                try {
                    const logbookRef = window.firebase.dbRef(
                        window.firebaseRealtimeDb,
                        `login-logbook/${entry.id}`
                    );
                    await window.firebase.set(logbookRef, entry);
                } catch (e) {
                    // Silently fail if no permission
                    console.warn('Could not save to Firebase logbook:', e.message);
                }
            },
            
            getRecent(limit = 100) {
                return state.loginLogbook.slice(0, limit);
            },
            
            filterByUser(email) {
                return state.loginLogbook.filter(entry => entry.email === email);
            },
            
            filterByDateRange(startDate, endDate) {
                const start = new Date(startDate).getTime();
                const end = new Date(endDate).getTime();
                return state.loginLogbook.filter(entry => {
                    const timestamp = new Date(entry.timestamp).getTime();
                    return timestamp >= start && timestamp <= end;
                });
            },
            
            exportToCSV() {
                const headers = ['Timestamp', 'Action', 'Email', 'Display Name', 'IP Address', 'Location', 'Browser', 'OS', 'Device'];
                const rows = state.loginLogbook.map(entry => [
                    new Date(entry.timestamp).toLocaleString(),
                    entry.action,
                    entry.email,
                    entry.displayName,
                    entry.ip,
                    `${entry.city}, ${entry.region}, ${entry.country}`,
                    entry.browser || '-',
                    entry.os || '-',
                    entry.device || '-'
                ]);
                
                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                return csv;
            }
        };
        
        // Load logbook on startup
        LoginLogbook.loadFromStorage();
        
        // ==================== USER ACCOUNT MANAGEMENT SYSTEM ====================
        const UserAccounts = {
            // Predefined superintendent accounts with credentials
            superintendents: {
                'esh@ncr.com.ph': {
                    password: 'NCR2026!',
                    role: 'superintendent',
                    displayName: 'NCR Superintendent',
                    region: 'NCR',
                    color: '#2196F3' // Blue
                },
                'esh@north.com.ph': {
                    password: 'NORTH2026!',
                    role: 'superintendent',
                    displayName: 'North Luzon Superintendent',
                    region: 'NORTH LUZON',
                    color: '#4CAF50' // Green
                },
                'esh@south.com.ph': {
                    password: 'SOUTH2026!',
                    role: 'superintendent',
                    displayName: 'South Luzon Superintendent',
                    region: 'SOUTH LUZON',
                    color: '#FF9800' // Orange
                },
                'esh@vismin.com.ph': {
                    password: 'VISMIN2026!',
                    role: 'superintendent',
                    displayName: 'Visayas & Mindanao Superintendent',
                    region: 'VISAYAS & MINDANAO',
                    color: '#9C27B0' // Purple
                }
            },
            
            getUserInfo(email) {
                // Check if superintendent
                if (this.superintendents[email]) {
                    return this.superintendents[email];
                }
                
                // Otherwise, it's admin
                return {
                    role: 'admin',
                    displayName: 'Administrator',
                    region: 'ALL',
                    color: '#D32F2F' // Red
                };
            },
            
            isAdmin(email) {
                return !this.superintendents[email];
            },
            
            isSuperintendent(email) {
                return !!this.superintendents[email];
            },
            
            canEdit(userEmail, projectRegion) {
                const userInfo = this.getUserInfo(userEmail);
                
                // Admin can edit everything
                if (userInfo.role === 'admin') return true;
                
                // Superintendent can only edit their region
                return userInfo.region === projectRegion;
            },
            
            getAccessLevel(userEmail) {
                const userInfo = this.getUserInfo(userEmail);
                return {
                    role: userInfo.role,
                    region: userInfo.region,
                    permissions: {
                        viewAll: true,
                        editAll: userInfo.role === 'admin',
                        editOwn: userInfo.role === 'superintendent',
                        accessSettings: userInfo.role === 'admin',
                        viewUsers: userInfo.role === 'admin',
                        viewDevices: userInfo.role === 'admin',
                        deleteProjects: userInfo.role === 'admin',
                        createAccounts: userInfo.role === 'admin'
                    }
                };
            }
        };
        
        // ==================== PRESENCE TRACKING SYSTEM ====================
        const PresenceTracker = {
            myPresenceRef: null,
            usersPresenceRef: null,
            devicesRef: null,
            activityTimeout: null,
            lastActivityTime: Date.now(),
            
            async initialize(userId, userEmail) {
                if (!window.firebaseRealtimeDb) {
                    console.warn('Firebase Realtime DB not available');
                    return;
                }
                
                const userInfo = UserAccounts.getUserInfo(userEmail);
                const deviceInfo = DeviceFingerprint.getPlatformInfo();
                
                // Setup my presence
                this.myPresenceRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    `presence/${userId}`
                );
                
                // Setup all users presence listener
                this.usersPresenceRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    'presence'
                );
                
                // Setup devices reference
                this.devicesRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    `devices/${state.deviceFingerprint}`
                );
                
                // Initial presence data
                const presenceData = {
                    status: 'online',
                    displayName: userInfo.displayName,
                    email: userEmail,
                    role: userInfo.role,
                    region: userInfo.region,
                    color: userInfo.color,
                    currentActivity: {
                        action: 'viewing',
                        tab: state.currentTab,
                        project: null,
                        cell: null,
                        timestamp: Date.now()
                    },
                    lastSeen: Date.now(),
                    deviceId: state.deviceFingerprint,
                    platform: deviceInfo.platform,
                    browser: deviceInfo.browser
                };
                
                // Set initial presence
                await window.firebase.set(this.myPresenceRef, presenceData);
                
                // Setup disconnect handler
                const disconnectRef = window.firebase.onDisconnect(this.myPresenceRef);
                disconnectRef.set({
                    ...presenceData,
                    status: 'offline',
                    lastSeen: window.firebase.serverTimestamp()
                });
                
                // Register device
                await this.registerDevice(userId, userEmail, deviceInfo);
                
                // Listen to all users presence (admin only)
                if (userInfo.role === 'admin') {
                    this.startPresenceListener();
                    this.startDeviceListener();
                }
                
                // Setup activity tracking
                this.setupActivityTracking();
                
                console.log('‚úÖ Presence tracking initialized');
            },
            
            async registerDevice(userId, userEmail, deviceInfo) {
                const deviceData = {
                    userId: userId,
                    email: userEmail,
                    fingerprint: state.deviceFingerprint,
                    platform: deviceInfo.platform,
                    browser: deviceInfo.browser,
                    firstSeen: Date.now(),
                    lastSeen: Date.now(),
                    status: 'active'
                };
                
                await window.firebase.set(this.devicesRef, deviceData);
                
                // Setup disconnect
                const disconnectRef = window.firebase.onDisconnect(this.devicesRef);
                disconnectRef.update({
                    status: 'offline',
                    lastSeen: window.firebase.serverTimestamp()
                });
            },
            
            startPresenceListener() {
                window.firebase.onValue(this.usersPresenceRef, (snapshot) => {
                    const presenceData = snapshot.val() || {};
                    state.activeUsers = presenceData;
                    
                    // Update UI if admin is viewing
                    if (state.userRole === 'admin' && state.isLoggedIn) {
                        this.updateActiveUsersUI();
                    }
                });
            },
            
            startDeviceListener() {
                const allDevicesRef = window.firebase.dbRef(
                    window.firebaseRealtimeDb,
                    'devices'
                );
                
                window.firebase.onValue(allDevicesRef, (snapshot) => {
                    const devicesData = snapshot.val() || {};
                    state.activeDevices = Object.values(devicesData);
                    
                    // Update device counter UI
                    if (state.userRole === 'admin' && state.isLoggedIn) {
                        this.updateDeviceCounterUI();
                    }
                });
            },
            
            setupActivityTracking() {
                // Track user activity
                const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
                
                events.forEach(event => {
                    document.addEventListener(event, () => {
                        this.lastActivityTime = Date.now();
                        this.updateStatus('online');
                    });
                });
                
                // Check for idle status every 30 seconds
                setInterval(() => {
                    const idleTime = Date.now() - this.lastActivityTime;
                    
                    if (idleTime > 5 * 60 * 1000) { // 5 minutes
                        this.updateStatus('idle');
                    }
                }, 30000);
            },
            
            async updateStatus(status) {
                if (!this.myPresenceRef) return;
                
                await window.firebase.update(this.myPresenceRef, {
                    status: status,
                    lastSeen: Date.now()
                });
            },
            
            async updateActivity(action, details = {}) {
                if (!this.myPresenceRef) return;
                
                await window.firebase.update(this.myPresenceRef, {
                    'currentActivity/action': action,
                    'currentActivity/tab': details.tab || state.currentTab,
                    'currentActivity/project': details.project || null,
                    'currentActivity/cell': details.cell || null,
                    'currentActivity/timestamp': Date.now(),
                    lastSeen: Date.now()
                });
            },
            
            updateActiveUsersUI() {
                if (!state.isAdmin) return;
                
                const usersList = document.getElementById('users-list');
                const usersBadge = document.getElementById('users-count-badge');
                const container = document.getElementById('active-users-container');
                
                if (!usersList || !usersBadge || !container) {
                    console.warn('‚ö†Ô∏è Active users UI elements not found');
                    return;
                }
                
                // Show container for admin
                container.style.display = 'inline-block';
                console.log('üë• Active users container shown');
                
                const users = Object.entries(state.activeUsers || {});
                const onlineCount = users.filter(([, data]) => data.status === 'online').length;
                
                // Update badge
                usersBadge.textContent = onlineCount;
                
                if (users.length === 0) {
                    usersList.innerHTML = `
                        <div class="dropdown-empty">
                            <i class="fas fa-user-slash"></i>
                            <div>No users online</div>
                        </div>
                    `;
                    return;
                }
                
                // Sort: online first, then by name
                users.sort((a, b) => {
                    if (a[1].status !== b[1].status) {
                        const statusOrder = { online: 0, idle: 1, offline: 2 };
                        return statusOrder[a[1].status] - statusOrder[b[1].status];
                    }
                    return (a[1].displayName || '').localeCompare(b[1].displayName || '');
                });
                
                usersList.innerHTML = users.map(([userId, data]) => {
                    const initials = (data.displayName || data.email || 'U').substring(0, 2).toUpperCase();
                    const activityText = this.getActivityText(data.currentActivity);
                    const statusClass = `status-${data.status}`;
                    const statusText = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                    
                    return `
                        <div class="dropdown-item">
                            <div class="user-info">
                                <div class="user-avatar" style="background: ${data.color || '#2e7d32'}">
                                    ${initials}
                                </div>
                                <div class="user-details">
                                    <div class="user-name">${data.displayName || 'Unknown User'}</div>
                                    <div class="user-activity">
                                        <i class="fas fa-${this.getActivityIcon(data.currentActivity?.action)}"></i>
                                        ${activityText}
                                    </div>
                                    <span class="user-status ${statusClass}">
                                        <span class="status-indicator"></span>
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            updateDeviceCounterUI() {
                if (!state.isAdmin) return;
                
                const deviceList = document.getElementById('device-list');
                const deviceBadge = document.getElementById('device-count-badge');
                const container = document.getElementById('device-counter-container');
                
                if (!deviceList || !deviceBadge || !container) {
                    console.warn('‚ö†Ô∏è Device counter UI elements not found');
                    return;
                }
                
                // Show container for admin
                container.style.display = 'inline-block';
                console.log('üñ•Ô∏è Device counter container shown');
                
                const devices = state.activeDevices || [];
                const activeDevices = devices.filter(d => d.status === 'active');
                
                // Update badge
                deviceBadge.textContent = activeDevices.length;
                
                if (activeDevices.length === 0) {
                    deviceList.innerHTML = `
                        <div class="dropdown-empty">
                            <i class="fas fa-laptop"></i>
                            <div>No devices connected</div>
                        </div>
                    `;
                    return;
                }
                
                // Sort by last seen (most recent first)
                activeDevices.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));
                
                deviceList.innerHTML = activeDevices.map(device => {
                    const icon = this.getDeviceIcon(device.platform);
                    const timeSince = this.getTimeSince(device.lastSeen);
                    
                    return `
                        <div class="dropdown-item">
                            <div class="device-info">
                                <div class="device-icon-box">
                                    <i class="device-icon fas fa-${icon}"></i>
                                </div>
                                <div class="device-details">
                                    <div class="device-name">${device.platform || 'Unknown'} ‚Äî ${device.browser || 'Browser'}</div>
                                    <div class="device-meta"><i class="fas fa-clock" style="font-size:0.6rem"></i> ${timeSince}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            getDeviceIcon(platform) {
                const p = (platform || '').toLowerCase();
                if (p.includes('windows')) return 'windows';
                if (p.includes('mac')) return 'apple';
                if (p.includes('linux')) return 'linux';
                if (p.includes('android')) return 'mobile-alt';
                if (p.includes('iphone') || p.includes('ipad')) return 'mobile-alt';
                return 'laptop';
            },
            
            getTimeSince(timestamp) {
                if (!timestamp) return 'Unknown';
                
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
                return `${Math.floor(seconds / 86400)} days ago`;
            },
            
            getActivityText(activity) {
                if (!activity) return 'Idle';
                
                const action = activity.action || 'viewing';
                const tab = activity.tab || 'dashboard';
                const project = activity.project;
                
                if (action === 'editing' && project) {
                    return `Editing ${tab.toUpperCase()} - ${project}`;
                }
                if (action === 'viewing' && project) {
                    return `Viewing ${project}`;
                }
                return `${action.charAt(0).toUpperCase() + action.slice(1)} ${tab}`;
            },
            
            getActivityIcon(action) {
                const icons = {
                    editing: 'edit',
                    viewing: 'eye',
                    idle: 'moon'
                };
                return icons[action] || 'circle';
            },
            
            cleanup() {
                if (this.myPresenceRef) {
                    window.firebase.set(this.myPresenceRef, {
                        status: 'offline',
                        lastSeen: Date.now()
                    });
                }
            }
        };
        
        // Load logbook on startup
        LoginLogbook.loadFromStorage();
        
        // ==================== ADMIN SYSTEM (LEGACY - Deprecated) ====================
        // Note: Admin detection now handled by UserAccounts system
        // This AdminSystem is kept for backward compatibility but not used for access control
        const AdminSystem = {
            // Legacy admin email list - NO LONGER USED
            // Admin status is now determined by UserAccounts.getUserInfo()
            adminEmails: [],
            
            isAdmin(email) {
                // Redirect to new system
                return UserAccounts.isAdmin(email);
            },
            
            checkAdminAccess() {
                // Deprecated - admin access now set by UserAccounts
                if (!state.currentUser) return false;
                return state.isAdmin;
            },
            
            showAdminPanel() {
                if (!state.isAdmin) {
                    showToast('‚õî Access Denied: Admin privileges required', 'error');
                    return;
                }
                
                // Switch to admin tab
                changeTab('admin');
            },
            
            async getAllUsers() {
                // Get all unique users from login logbook
                const users = {};
                state.loginLogbook.forEach(entry => {
                    if (!users[entry.email]) {
                        users[entry.email] = {
                            email: entry.email,
                            displayName: entry.displayName,
                            uid: entry.uid,
                            lastLogin: entry.timestamp,
                            loginCount: 0,
                            locations: new Set()
                        };
                    }
                    users[entry.email].loginCount++;
                    if (entry.city && entry.country) {
                        users[entry.email].locations.add(`${entry.city}, ${entry.country}`);
                    }
                    // Keep most recent login
                    if (new Date(entry.timestamp) > new Date(users[entry.email].lastLogin)) {
                        users[entry.email].lastLogin = entry.timestamp;
                    }
                });
                
                return Object.values(users);
            },
            
            async revokeAccess(email) {
                // This would typically involve Firebase Admin SDK
                // For now, just log the action
                AuditLogger.log('ACCESS_REVOKED', { targetUser: email, admin: state.currentUser.email });
                showToast(`üö´ Access revoked for ${email}`, 'warning');
            }
        };
        
        // ==================== OFFLINE MODE SYSTEM ====================
        const OfflineManager = {
            init() {
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
                
                // Check initial status
                state.isOnline = navigator.onLine;
                console.log(`üì° Network status: ${state.isOnline ? 'Online' : 'Offline'}`);
            },
            
            handleOnline() {
                state.isOnline = true;
                showToast('üåê Back online! Syncing changes...', 'success');
                this.syncOfflineQueue();
                AuditLogger.log('SYSTEM_ONLINE', { status: 'Connected to internet' });
            },
            
            handleOffline() {
                state.isOnline = false;
                showToast('üìµ You are offline. Changes will sync when online.', 'warning');
                AuditLogger.log('SYSTEM_OFFLINE', { status: 'Disconnected from internet' });
            },
            
            addToQueue(action, data) {
                state.offlineQueue.push({
                    id: Date.now(),
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('esh_offline_queue', JSON.stringify(state.offlineQueue));
            },
            
            async syncOfflineQueue() {
                if (state.offlineQueue.length === 0) return;
                
                console.log(`üîÑ Syncing ${state.offlineQueue.length} offline changes...`);
                
                for (const item of state.offlineQueue) {
                    try {
                        await this.processQueueItem(item);
                    } catch (e) {
                        console.error('Failed to sync item:', item, e);
                    }
                }
                
                state.offlineQueue = [];
                localStorage.removeItem('esh_offline_queue');
                showToast('‚úÖ All offline changes synced!', 'success');
            },
            
            async processQueueItem(item) {
                // Process based on action type
                if (item.action === 'SAVE_DATA') {
                    await saveToFirebase();
                }
                // Add more action types as needed
            }
        };
        
        // ==================== REAL-TIME COLLABORATION ====================
        
        // ==================== LAZY LOADING SYSTEM ====================
        const LazyLoader = {
            observer: null,
            
            init() {
                this.observer = new IntersectionObserver(
                    (entries) => this.handleIntersection(entries),
                    { rootMargin: '50px' }
                );
            },
            
            handleIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadContent(entry.target);
                        this.observer.unobserve(entry.target);
                    }
                });
            },
            
            observe(elements) {
                elements.forEach(el => this.observer.observe(el));
            },
            
            loadContent(element) {
                // Load data for this element
                const projectName = element.dataset.projectName;
                if (projectName) {
                    console.log('Lazy loading project:', projectName);
                    // Render project details here
                }
            }
        };
        
        
        // Debug logger with timestamp
        function debugLog(category, message, data = null) {
            if (!window.DEBUG_MODE) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const styles = {
                'CRITICAL': 'color: red; font-weight: bold',
                'ERROR': 'color: orange; font-weight: bold',
                'WARNING': 'color: yellow',
                'INFO': 'color: cyan',
                'SUCCESS': 'color: lightgreen',
                'DATA': 'color: lightblue'
            };
            
            console.log(`%c[${timestamp}] [${category}] ${message}`, styles[category] || 'color: white', data || '');
        }
        
        // Validate state integrity
        function validateState() {
            const issues = [];
            
            // Check if projects and masterProjects are in sync
            if (state.projects.length > state.masterProjects.length) {
                issues.push('‚ö†Ô∏è projects has more items than masterProjects - data inconsistency!');
            }
            
            // Check for duplicate projects
            const projectNames = state.projects.map(p => p.name);
            const duplicates = projectNames.filter((name, index) => projectNames.indexOf(name) !== index);
            if (duplicates.length > 0) {
                issues.push(`‚ö†Ô∏è Duplicate projects found: ${duplicates.join(', ')}`);
            }
            
            // Check for projects without required fields
            state.projects.forEach(p => {
                if (!p.name) issues.push(`‚ö†Ô∏è Project without name found`);
                if (!p.region) issues.push(`‚ö†Ô∏è Project "${p.name}" missing region`);
                if (!p.dateStarted) issues.push(`‚ö†Ô∏è Project "${p.name}" missing dateStarted`);
                if (!p.status) issues.push(`‚ö†Ô∏è Project "${p.name}" missing status`);
            });
            
            // Check filtered projects sync
            if (state.filteredProjects.length > state.projects.length) {
                issues.push('‚ö†Ô∏è filteredProjects has more items than projects');
            }
            
            return {
                isValid: issues.length === 0,
                issues: issues,
                stats: {
                    totalProjects: state.projects.length,
                    masterProjects: state.masterProjects.length,
                    filteredProjects: state.filteredProjects.length,
                    selectedYear: state.selectedYear,
                    isLoggedIn: state.isLoggedIn
                }
            };
        }
        
        // Test year filtering logic
        function testYearFiltering() {
            debugLog('INFO', 'üß™ Testing year filtering logic...');
            
            // Create test projects
            const testProjects = [
                { name: 'Test1', dateStarted: '2020-01-01', dateFinished: null, status: 'on-going' },
                { name: 'Test2', dateStarted: '2024-01-01', dateFinished: '2025-12-31', status: 'finished' },
                { name: 'Test3', dateStarted: '2026-01-01', dateFinished: null, status: 'on-going' }
            ];
            
            // Test for different years
            [2020, 2024, 2025, 2026, 2027].forEach(year => {
                const filtered = filterProjectsByYear(testProjects, year);
                debugLog('DATA', `Year ${year}:`, filtered.map(p => p.name));
            });
            
            debugLog('SUCCESS', '‚úÖ Year filtering test complete');
        }
        
        // Monitor Firebase operations
        const originalSaveToFirebase = window.saveToFirebase;
        window.debugSaveToFirebase = async function() {
            debugLog('INFO', 'üíæ saveToFirebase() called');
            debugLog('DATA', 'State before save:', {
                projects: state.projects.length,
                masterProjects: state.masterProjects.length,
                year: state.selectedYear
            });
            
            const result = await originalSaveToFirebase?.();
            
            if (result) {
                debugLog('SUCCESS', '‚úÖ Save to Firebase successful');
            } else {
                debugLog('ERROR', '‚ùå Save to Firebase failed');
            }
            
            return result;
        };
        
        // Debug console commands
        window.debugCommands = {
            state: () => {
                console.log('Current State:', state);
                return state;
            },
            validate: () => {
                const result = validateState();
                console.log('Validation Result:', result);
                if (!result.isValid) {
                    console.error('Issues found:', result.issues);
                }
                return result;
            },
            testFiltering: testYearFiltering,
            projects: () => {
                console.log('Projects:', state.projects);
                console.log('Master Projects:', state.masterProjects);
                console.log('Filtered Projects:', state.filteredProjects);
            },
            clearConsole: () => console.clear(),
            help: () => {
                console.log(`
%cüîç Debug Commands Available:
%cdebugCommands.state() - View current state
debugCommands.validate() - Validate state integrity
debugCommands.testFiltering() - Test year filtering
debugCommands.projects() - View all project arrays
debugCommands.clearConsole() - Clear console
debugCommands.help() - Show this help
                `, 'color: cyan; font-weight: bold', 'color: white');
            }
        };
        
        // Auto-validate on critical operations
        const originalDeleteProject = window.deleteProject;
        
        // Log startup
        debugLog('INFO', 'üöÄ Debug system initialized');
        debugLog('INFO', 'üí° Type debugCommands.help() in console for available commands');

        // ===== DARK MODE FUNCTIONS =====
        function initDarkMode() {
            const savedTheme = localStorage.getItem('esh_theme_preference');
            if (savedTheme === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            state.darkMode = true;
            localStorage.setItem('esh_theme_preference', 'dark');
            updateThemeIcon();
            console.log('‚úÖ Dark mode enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            state.darkMode = false;
            localStorage.setItem('esh_theme_preference', 'light');
            updateThemeIcon();
            console.log('‚úÖ Light mode enabled');
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // ===== YEAR SELECTOR FUNCTIONS =====
        const YEAR_RANGE = { min: 2019, max: 2027 }; // Year range from 2019 to 2027
        let availableYears = [];

        function initializeYears() {
            // Generate default years from 2019 to 2027
            availableYears = [];
            for (let year = YEAR_RANGE.min; year <= YEAR_RANGE.max; year++) {
                availableYears.push(year);
            }
            
            // Load saved year preference
            const savedYear = localStorage.getItem('esh_selected_year');
            if (savedYear && availableYears.includes(parseInt(savedYear))) {
                state.selectedYear = parseInt(savedYear);
            }
            
            renderYearOptions();
            updateYearDisplay();
        }

        function renderYearOptions() {
            const container = document.getElementById('year-options');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Sort years in descending order (newest first)
            const sortedYears = [...availableYears].sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const option = document.createElement('div');
                option.className = 'year-option';
                if (year === state.selectedYear) {
                    option.classList.add('active');
                }
                
                option.innerHTML = `
                    <span>${year}</span>
                    ${year === state.selectedYear ? '<i class="fas fa-check"></i>' : ''}
                `;
                
                option.onclick = () => requestYearSwitch(year);
                container.appendChild(option);
            });
        }

        function toggleYearDropdown() {
            const dropdown = document.getElementById('year-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeYearDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeYearDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('year-dropdown');
            const btn = document.getElementById('year-selector-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeYearDropdownOnClickOutside);
            }
        }

        async function requestYearSwitch(newYear) {
            if (newYear === state.selectedYear) {
                toggleYearDropdown();
                return;
            }
            
            // Show warning dialog
            const confirmed = await showModernDialog(
                '‚ö†Ô∏è Switch Year',
                `Switch from <strong>${state.selectedYear}</strong> to <strong>${newYear}</strong>?<br><br>
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107; margin: 10px 0;">
                    <i class="fas fa-info-circle" style="color: #856404;"></i>
                    Your current ${state.selectedYear} data will remain saved.<br>
                    Any unsaved changes will be lost.
                </div>`,
                false  // Changed to false - this is NOT a dangerous action!
            );
            
            if (confirmed) {
                await switchYear(newYear);
            }
            
            toggleYearDropdown();
        }

        function filterProjectsByYear(projects, selectedYear) {
            // Filter projects to show only those active in the selected year
            return projects.filter(project => {
                // Extract year from dateStarted (format: YYYY-MM-DD)
                const startYear = project.dateStarted ? parseInt(project.dateStarted.split('-')[0]) : null;
                
                // Extract year from dateFinished if it exists
                const finishedYear = project.dateFinished ? parseInt(project.dateFinished.split('-')[0]) : null;
                
                // If no start year, we can't determine if it should appear
                if (!startYear) return false;
                
                // Check if project is active in the selected year
                if (finishedYear) {
                    // Project has a finish date - show only from start year to finish year
                    return selectedYear >= startYear && selectedYear <= finishedYear;
                } else {
                    // Project is ongoing - show from start year onwards
                    return selectedYear >= startYear;
                }
            });
        }
        
        // ==================== DEVICE COUNTER & ACTIVE USERS DROPDOWNS ====================
        
        function toggleDeviceDropdown() {
            const dropdown = document.getElementById('device-dropdown');
            const usersDropdown = document.getElementById('users-dropdown');
            
            // Close users dropdown if open
            if (usersDropdown && !usersDropdown.classList.contains('hidden')) {
                usersDropdown.classList.add('hidden');
            }
            
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeDeviceDropdownOnClickOutside);
                }, 0);
            }
        }
        
        function closeDeviceDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('device-dropdown');
            const btn = document.getElementById('device-counter-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeDeviceDropdownOnClickOutside);
            }
        }
        
        function toggleUsersDropdown() {
            const dropdown = document.getElementById('users-dropdown');
            const deviceDropdown = document.getElementById('device-dropdown');
            
            // Close device dropdown if open
            if (deviceDropdown && !deviceDropdown.classList.contains('hidden')) {
                deviceDropdown.classList.add('hidden');
            }
            
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUsersDropdownOnClickOutside);
                }, 0);
            }
        }
        
        function closeUsersDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('users-dropdown');
            const btn = document.getElementById('active-users-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeUsersDropdownOnClickOutside);
            }
        }

        async function switchYear(newYear) {
            debugLog('INFO', `üîÑ switchYear() called: ${state.selectedYear} ‚Üí ${newYear}`);
            
            const beforeCount = state.projects.length;
            const masterCount = state.masterProjects.length;
            
            // Update selected year
            const oldYear = state.selectedYear;
            state.selectedYear = newYear;
            localStorage.setItem('esh_selected_year', newYear);
            
            debugLog('DATA', 'Before filtering:', {
                masterProjects: masterCount,
                currentProjects: beforeCount,
                targetYear: newYear
            });
            
            // INSTANT: Just filter the master project list locally (no Firebase!)
            state.projects = filterProjectsByYear(state.masterProjects, newYear);
            state.filteredProjects = [...state.projects];
            state.selectedProjects = [];
            
            // Clear search and filters when year changes
            state.searchTerm = '';
            state.regionFilter = '';
            state.statusFilter = '';
            
            const afterCount = state.projects.length;
            
            debugLog('SUCCESS', `‚úÖ Filtered to ${afterCount} projects for year ${newYear}`);
            debugLog('DATA', 'Projects shown:', state.projects.map(p => `${p.name} (${p.dateStarted || 'no date'})`));
            
            // Validate consistency
            if (afterCount > masterCount) {
                debugLog('ERROR', '‚ùå CRITICAL: More projects shown than in master list!');
            }
            
            // Update UI immediately
            updateYearDisplay();
            renderYearOptions();
            render();
            
            showToast(`‚úÖ Switched to year ${newYear}`, 'success');
            
            // Validate after switch
            const validation = validateState();
            if (!validation.isValid) {
                debugLog('WARNING', '‚ö†Ô∏è State validation issues after year switch:', validation.issues);
            }
        }

        function updateYearDisplay() {
            const yearBtn = document.getElementById('year-selector-btn');
            if (yearBtn) {
                yearBtn.title = `Select Year (Currently: ${state.selectedYear})`;
            }
        }

        // ========== NOTIFICATION BELL DROPDOWN ==========
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Update notifications when opened
            if (!dropdown.classList.contains('hidden')) {
                updateNotifications();
                setTimeout(() => {
                    document.addEventListener('click', closeNotificationDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeNotificationDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-bell-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeNotificationDropdownOnClickOutside);
            }
        }

        function updateNotifications() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth(); // 0-11
            
            // Group overdue reports by project
            let projectOverdues = {};

            // Check each project for overdue reports
            state.projects.forEach(project => {
                let overdueTabs = [];

                // Check KPM reports (monthly)
                let hasKpmOverdue = false;
                const kpmRows = ['KPM&I'];
                kpmRows.forEach(row => {
                    const key = `kpm_${row}`;
                    for (let month = 0; month < currentMonth; month++) {
                        const value = project.vals[key] ? project.vals[key][month + 1] : '';
                        if (!value || value.toString().trim() === '') {
                            hasKpmOverdue = true;
                            break;
                        }
                    }
                });
                if (hasKpmOverdue) {
                    overdueTabs.push({ name: 'Monthly Report', tab: 'kpm' });
                }

                // Check DOLE reports (monthly)
                let hasDoleOverdue = false;
                const doleRows = ['WAIR', 'RSO', 'MOM'];
                doleRows.forEach(row => {
                    const key = `dole_${row}`;
                    for (let month = 0; month < currentMonth; month++) {
                        const value = project.vals[key] ? project.vals[key][month + 1] : '';
                        if (!value || value.toString().trim() === '') {
                            hasDoleOverdue = true;
                            break;
                        }
                    }
                    if (hasDoleOverdue) return; // Exit early if found
                });
                if (hasDoleOverdue) {
                    overdueTabs.push({ name: 'DOLE Reportorial', tab: 'dole' });
                }

                // Check EMB reports (quarterly) - Due 15th of following month
                let hasEmbOverdue = false;
                const embRows = ['SMR (Quarterly) - Submission Date'];
                embRows.forEach(row => {
                    const key = `emb_${row}`;
                    for (let quarter = 1; quarter <= 4; quarter++) {
                        let isOverdue = false;
                        
                        // Special handling for Q4 (due January 15 of NEXT year)
                        if (quarter === 4) {
                            // Q4 of selectedYear is due January 15 of selectedYear+1
                            const deadlineYear = state.selectedYear + 1;
                            const currentYear = currentDate.getFullYear();
                            
                            if (currentYear > deadlineYear) {
                                isOverdue = true;
                            } else if (currentYear === deadlineYear) {
                                if (currentMonth === 0 && currentDate.getDate() > 15) {
                                    isOverdue = true;
                                } else if (currentMonth > 0) {
                                    isOverdue = true;
                                }
                            }
                            // If currentYear < deadlineYear, not overdue yet
                        } else {
                            // For Q1, Q2, Q3 - normal logic
                            const quarterEndMonth = (quarter * 3) - 1;
                            const deadlineMonth = (quarterEndMonth + 1) % 12;
                            
                            if (currentMonth > deadlineMonth || (currentMonth === deadlineMonth && currentDate.getDate() > 15)) {
                                isOverdue = true;
                            }
                        }
                        
                        if (isOverdue) {
                            const value = project.vals[key] ? project.vals[key][quarter] : '';
                            if (!value || value.toString().trim() === '') {
                                hasEmbOverdue = true;
                                break;
                            }
                        }
                    }
                });
                if (hasEmbOverdue) {
                    overdueTabs.push({ name: 'EMB Reportorial', tab: 'emb' });
                }

                // Check for missing DOE Safety Officer Permit (Renewable Energy projects only)
                if (project.isRenewable === true) {
                    const doePermitKey = 'doe-permit_DOE Safety Officer Permit';
                    const permitNumber = project.vals[doePermitKey] ? project.vals[doePermitKey][1] : '';
                    const validUntil = project.vals[doePermitKey] ? project.vals[doePermitKey][2] : '';
                    
                    if (!permitNumber || permitNumber.trim() === '' || !validUntil || validUntil.trim() === '') {
                        overdueTabs.push({ name: 'DOE Safety Officer Permit (Missing)', tab: 'doe-permit' });
                    }
                }

                // Check for missing Certificate of Registration
                const certKey = 'permits_Certificate of Registration';
                const certNumber = project.vals[certKey] ? project.vals[certKey][1] : '';
                const certIssued = project.vals[certKey] ? project.vals[certKey][2] : '';
                const certExpiry = project.vals[certKey] ? project.vals[certKey][3] : '';
                
                if (!certNumber || certNumber.trim() === '' || !certIssued || certIssued.trim() === '' || !certExpiry || certExpiry.trim() === '') {
                    overdueTabs.push({ name: 'Certificate of Registration (Missing)', tab: 'permits' });
                }

                // Check for missing CSHP
                const cshpKey = 'cshp_CSHP Approval Date';
                const cshpDate = project.vals[cshpKey] ? project.vals[cshpKey][1] : '';
                
                if (!cshpDate || cshpDate.trim() === '') {
                    overdueTabs.push({ name: 'CSHP (Missing)', tab: 'cshp' });
                }

                // Add to project overdues if any tabs have overdue reports
                if (overdueTabs.length > 0) {
                    projectOverdues[project.name] = overdueTabs;
                }
            });

            // Count total issues (not just projects)
            let totalIssues = 0;
            Object.keys(projectOverdues).forEach(projectName => {
                totalIssues += projectOverdues[projectName].length;
            });
            
            // Update badge
            const badge = document.getElementById('notification-badge');
            if (totalIssues > 0) {
                badge.textContent = totalIssues > 99 ? '99+' : totalIssues;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // Update notification list
            const notificationList = document.getElementById('notification-list');
            const totalProjects = Object.keys(projectOverdues).length;
            if (totalIssues === 0) {
                notificationList.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-check-circle"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">All caught up!</div>
                        <div>No overdue reports or missing permits.</div>
                    </div>
                `;
            } else {
                let html = '';
                
                // Add hover effect CSS
                html += `
                    <style>
                        .notification-project-item:hover {
                            background: #fff3e0 !important;
                        }
                        body.dark-mode .notification-project-item:hover {
                            background: #3a2f1f !important;
                        }
                    </style>
                `;
                
                // Sort project names alphabetically for consistent notification display
                const sortedProjectNames = Object.keys(projectOverdues).sort((a, b) => a.localeCompare(b));
                
                // Display each project with overdue tabs
                sortedProjectNames.forEach(projectName => {
                    const tabs = projectOverdues[projectName];
                    
                    // Create separate notification item for each overdue report
                    tabs.forEach(tabInfo => {
                        const isMissing = tabInfo.name.includes('Missing');
                        const iconClass = isMissing ? 'fa-exclamation-triangle' : 'fa-file-circle-exclamation';
                        const statusText = isMissing ? 'Missing' : 'Overdue';
                        const statusColor = isMissing ? '#d32f2f' : '#ff6f00';
                        
                        html += `
                            <div class="notification-item" onclick="redirectToProjectTable('${projectName}', '${tabInfo.tab}')">
                                <div class="notif-icon-box">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div style="flex:1; min-width:0;">
                                    <div class="notification-project">
                                        <i class="fas fa-building" style="font-size:0.7rem; margin-right:4px;"></i>${projectName}
                                    </div>
                                    <div class="notification-message">
                                        <strong style="color:var(--text-primary);">${statusText}:</strong> ${tabInfo.name.replace(' (Missing)', '')}
                                    </div>
                                    <div style="font-size:0.68rem; color:#2e7d32; font-weight:600; margin-top:4px;">
                                        <i class="fas fa-hand-pointer" style="font-size:0.6rem"></i> Click to view
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
                
                notificationList.innerHTML = html;
            }
        }

        function redirectToProjectTable(projectName, tabName) {
            // Close notification dropdown
            document.getElementById('notification-dropdown').classList.add('hidden');
            
            // Change to the appropriate tab
            changeTab(tabName);
            
            // Filter/search for the specific project
            setTimeout(() => {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = projectName;
                    // Trigger search/filter
                    if (typeof filterProjects === 'function') {
                        filterProjects();
                    }
                }
                
                // Show toast
                showToast(`üìã Viewing "${projectName}" in ${getTabLabel(tabName)}`, 'info');
            }, 100);
        }
        
        function getTabLabel(tabName) {
            const labels = {
                'kpm': 'Monthly Report',
                'dole': 'DOLE Reportorial',
                'emb': 'EMB Reportorial'
            };
            return labels[tabName] || tabName;
        }

        function redirectToTab(tabName) {
            // Close notification dropdown
            document.getElementById('notification-dropdown').classList.add('hidden');
            
            // Change to the appropriate tab
            changeTab(tabName);
            
            // Show toast
            const tabLabels = {
                'kpm': 'Monthly Report',
                'dole': 'DOLE Reportorial',
                'emb': 'EMB Reportorial'
            };
            showToast(`üìã Viewing ${tabLabels[tabName]} - Check overdue reports`, 'info');
        }

        function closeNotificationAndView(projectName) {
            // Close notification dropdown
            document.getElementById('notification-dropdown').classList.add('hidden');
            
            // Go to overall dashboard
            changeTab('overall');
            
            // Show toast
            showToast(`üìã Viewing overdue reports for: ${projectName}`, 'info');
        }

        // ========== SETTINGS DROPDOWN ==========
        function toggleSettingsDropdown() {
            const dropdown = document.getElementById('settings-dropdown-menu');
            dropdown.classList.toggle('hidden');
            
            // Update theme icon/text
            updateSettingsThemeDisplay();
            
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeSettingsDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeSettingsDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('settings-dropdown-menu');
            const btn = document.getElementById('settings-dropdown-btn');
            
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeSettingsDropdownOnClickOutside);
            }
        }

        function updateSettingsThemeDisplay() {
            const icon = document.getElementById('settings-theme-icon');
            const text = document.getElementById('settings-theme-text');
            const isDark = document.body.classList.contains('dark-mode');
            
            if (icon && text) {
                if (isDark) {
                    icon.className = 'fas fa-sun';
                    text.textContent = 'Light Mode';
                } else {
                    icon.className = 'fas fa-moon';
                    text.textContent = 'Dark Mode';
                }
            }
        }

        function toggleDarkModeFromMenu() {
            toggleDarkMode();
            updateSettingsThemeDisplay();
            // Don't close dropdown so user sees the change
        }

        function openSettingsTab() {
            document.getElementById('settings-dropdown-menu').classList.add('hidden');
            changeTab('settings');
        }

        function handleLogoutFromMenu() {
            document.getElementById('settings-dropdown-menu').classList.add('hidden');
            handleLogout();
        }

        function updateYearDisplay() {
            const yearBtn = document.getElementById('year-selector-btn');
            if (yearBtn) {
                yearBtn.title = `Select Year (Currently: ${state.selectedYear})`;
            }
            
            // Update settings page year displays
            const settingsCurrentYear = document.getElementById('settings-current-year');
            const targetYearDisplay = document.getElementById('target-year-display');
            const exportYearDisplay = document.getElementById('export-year-display');
            
            if (settingsCurrentYear) settingsCurrentYear.textContent = state.selectedYear;
            if (targetYearDisplay) targetYearDisplay.textContent = state.selectedYear;
            if (exportYearDisplay) exportYearDisplay.textContent = state.selectedYear;
            
            // Populate source year dropdown (exclude current year)
            const sourceYearSelect = document.getElementById('source-year-select');
            if (sourceYearSelect) {
                sourceYearSelect.innerHTML = '<option value="">Select source year...</option>';
                const otherYears = availableYears.filter(y => y !== state.selectedYear).sort((a, b) => b - a);
                otherYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    sourceYearSelect.appendChild(option);
                });
            }
        }

        // Copy data from another year to current year
        async function copyDataFromYear() {
            if (!firebaseReady || !window.firebaseDb) {
                showToast('‚ö†Ô∏è Firebase not ready. Please try again.', 'warning');
                return;
            }
            
            const sourceYearSelect = document.getElementById('source-year-select');
            const sourceYear = parseInt(sourceYearSelect.value);
            
            if (!sourceYear) {
                showToast('‚ö†Ô∏è Please select a source year', 'warning');
                return;
            }
            
            const currentYear = state.selectedYear;
            
            // Confirm action
            const confirmed = await showModernDialog(
                'üìã Copy Data',
                `Copy all data from <strong>${sourceYear}</strong> to <strong>${currentYear}</strong>?<br><br>
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107; margin: 10px 0;">
                    <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                    This will <strong>replace all existing ${currentYear} data</strong> with ${sourceYear} data.<br>
                    Projects, personnel, and incident data will be copied.
                </div>`,
                true
            );
            
            if (!confirmed) return;
            
            try {
                showToast(`üìã Copying data from ${sourceYear}...`, 'info');
                
                // Load source year data from Firebase
                const userId = getCurrentUserId();
                const sourceYearRef = window.firebase.doc(window.firebaseDb, 'users', userId, 'years', sourceYear.toString());
                const sourceYearSnap = await window.firebase.getDoc(sourceYearRef);
                
                if (!sourceYearSnap.exists()) {
                    showToast(`‚ùå No data found for year ${sourceYear}`, 'error');
                    return;
                }
                
                const sourceData = sourceYearSnap.data();
                
                // Copy data to current state
                state.projects = JSON.parse(JSON.stringify(sourceData.projects || []));
                state.personnelData = JSON.parse(JSON.stringify(sourceData.personnelData || []));
                state.incidentRateData = JSON.parse(JSON.stringify(sourceData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 }));
                state.filteredProjects = [...state.projects];
                
                // Save to current year
                await saveToFirebase();
                
                // Update UI
                render();
                renderPTable();
                
                showToast(`‚úÖ Successfully copied data from ${sourceYear} to ${currentYear}!`, 'success');
                
                // Reset dropdown
                sourceYearSelect.value = '';
                
            } catch (error) {
                console.error('‚ùå Error copying data:', error);
                showToast('‚ùå Failed to copy data: ' + error.message, 'error');
            }
        }

        // Export current year data to Excel (CSV format)
        async function exportYearToExcel() {
            const year = state.selectedYear;
            
            showToast(`üìä Generating export for ${year}...`, 'info');
            
            try {
                // Create CSV content
                let csvContent = `ESH COMPLIANCE DASHBOARD - YEAR ${year}\n`;
                csvContent += `Export Date: ${new Date().toLocaleString()}\n`;
                csvContent += `Total Projects: ${state.projects.length}\n`;
                csvContent += `Total Personnel: ${state.personnelData.length}\n\n`;
                
                // Projects data
                csvContent += `PROJECTS\n`;
                csvContent += `Project Name,Region,Date Started,Date Finished,Status\n`;
                
                state.projects.forEach(project => {
                    const name = `"${(project.name || '').replace(/"/g, '""')}"`;
                    const region = project.region || '';
                    const started = project.dateStarted || '';
                    const finished = project.dateFinished || '';
                    const status = project.status || '';
                    csvContent += `${name},${region},${started},${finished},${status}\n`;
                });
                
                csvContent += `\n`;
                
                // Personnel data
                csvContent += `PERSONNEL\n`;
                csvContent += `Name,Position,Gender,Region\n`;
                
                state.personnelData.forEach(person => {
                    const name = `"${(person.name || '').replace(/"/g, '""')}"`;
                    const position = `"${(person.position || '').replace(/"/g, '""')}"`;
                    const gender = person.gender || '';
                    const region = person.region || '';
                    csvContent += `${name},${position},${gender},${region}\n`;
                });
                
                csvContent += `\n`;
                
                // Incident Rate data
                csvContent += `INCIDENT RATE DATA\n`;
                csvContent += `Recordable Cases,Lost Days,Total Hours\n`;
                csvContent += `${state.incidentRateData.recordableCases || 0},${state.incidentRateData.lostDays || 0},${state.incidentRateData.totalHours || 0}\n`;
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `ESH_Dashboard_${year}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`‚úÖ Data for ${year} exported successfully!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showToast('‚ùå Failed to export: ' + error.message, 'error');
            }
        }

        function showAddYearDialog() {
            const customYear = prompt('Enter a custom year (e.g., 2040):');
            if (!customYear) return;
            
            const year = parseInt(customYear);
            if (isNaN(year) || year < 2000 || year > 2100) {
                showToast('‚ùå Invalid year. Please enter a year between 2000-2100.', 'error');
                return;
            }
            
            if (availableYears.includes(year)) {
                showToast(`‚ö†Ô∏è Year ${year} already exists.`, 'warning');
                return;
            }
            
            availableYears.push(year);
            availableYears.sort((a, b) => a - b);
            renderYearOptions();
            showToast(`‚úÖ Year ${year} added successfully!`, 'success');
        }

        // ===== LOGIN & AUTH =====
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-user').value.trim();
            const password = document.getElementById('login-pass').value;
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            errorDiv.innerText = '';

            if (!email || !password) {
                errorDiv.innerText = '‚ö†Ô∏è Please enter both email and password';
                return;
            }

            // Security: Email domain validation for SCIC and Superintendents
            const validDomains = [
                '@scic.com.ph',
                '@staclara.com.ph',
                '@ncr.com.ph',
                '@north.com.ph',
                '@south.com.ph',
                '@vismin.com.ph'
            ];
            
            const emailLower = email.toLowerCase();
            const isValidDomain = validDomains.some(domain => emailLower.endsWith(domain));
            
            if (!isValidDomain) {
                errorDiv.innerText = '‚ö†Ô∏è Access restricted to authorized email addresses only';
                return;
            }

            // Wait for Firebase to be ready
            if (!window.firebase || !window.firebaseAuth) {
                errorDiv.innerText = 'üõ°Ô∏è Securing workspace, please try again...';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading-spinner"></span> Signing in...';

            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                state.currentUser = { email: user.email, uid: user.uid };
                state.isLoggedIn = true;
                console.log('‚úÖ Firebase login successful:', user.email);
                // showUI() will be called by onAuthStateChanged observer
            } catch (error) {
                console.error('‚ùå Firebase login error:', error);
                let msg = '‚ùå Invalid email or password';
                if (error.code === 'auth/user-not-found') msg = '‚ùå No account found with this email';
                else if (error.code === 'auth/wrong-password') msg = '‚ùå Incorrect password';
                else if (error.code === 'auth/invalid-email') msg = '‚ùå Invalid email address';
                else if (error.code === 'auth/too-many-requests') msg = '‚ùå Too many attempts. Try again later.';
                else if (error.code === 'auth/network-request-failed') msg = '‚ùå Network error. Check your connection.';
                errorDiv.innerText = msg;
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }
        }

      function handleLogout() {
    showModernDialog('Logout Confirmation', 'Are you sure you want to logout?').then(async confirmed => {
        if (confirmed) {
            if (state.currentUser) {
                await LoginLogbook.logLogout(state.currentUser);
            }
            // Clear session timer and saved tab on logout
            localStorage.removeItem('esh_session_start');
            localStorage.removeItem('esh_last_tab');
            backupManager.stopAutoSave();
            state.isLoggedIn = false;
            state.currentUser = null;
            await firebaseLogout();
            location.reload();
        }
    });
}

function handleUserBadgeClick() {
    if (state.isAdmin) {
        changeTab('admin');
    }
}

function openAdminQuickView() {
    changeTab('admin');
}


        function loadUserData(email) {
            const storageKey = `esh_dashboard_${email}`;
            const savedData = localStorage.getItem(storageKey);

            if (savedData) {
                const data = JSON.parse(savedData);
                state.projects = data.projects || [];
                state.personnelData = data.personnelData || [];
                state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.currentSort = data.currentSort || 'name';
            } else {
                initializeUserProjects(email);
            }
            state.filteredProjects = [...state.projects];
        }

        function initializeUserProjects(email) {
            // Start with empty projects - users will add their own
            state.projects = [];
            state.filteredProjects = [];
            saveUserData(email);
            console.log('‚úÖ Initialized with empty projects - ready for user to add projects');
        }

        function saveUserData(email) {
            if (!email) return;
            const storageKey = `esh_dashboard_${email}`;
            const data = {
                projects: state.projects.map(p => {
                    const copy = { ...p };
                    delete copy.selected;
                    return copy;
                }),
                personnelData: state.personnelData || [],
                incidentRateData: state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
                currentSort: state.currentSort,
                lastSaved: new Date().toISOString(),
                timestamp: Date.now()
            };
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function sortProjects(sortBy) {
            state.currentSort = sortBy;
            state.projects.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'dateStarted') {
                    const da = new Date(a.dateStarted || '9999-12-31');
                    const db = new Date(b.dateStarted || '9999-12-31');
                    return da - db;
                }
                if (sortBy === 'dateFinished') {
                    const da = new Date(a.dateFinished || '9999-12-31');
                    const db = new Date(b.dateFinished || '9999-12-31');
                    return da - db;
                }
                return 0;
            });
            
            // Reapply current filters after sorting instead of just copying all projects
            reapplyFilters();
            
            saveUserData(state.currentUser?.email);
            render();
        }

        function openAddProjectModal(region) {
            document.getElementById('projectNameInput').value = '';
            document.getElementById('projectDateStarted').value = '';
            document.getElementById('projectDateFinished').value = '';
            document.getElementById('projectRegion').value = region || '';
            document.getElementById('projectModalError').innerText = '';
            document.getElementById('addProjectModal').classList.add('show');
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('show');
        }

        // ==================== CUSTOM CONFIRMATION MODAL FUNCTIONS ====================
        let confirmModalResolve = null;

        function showConfirmModal() {
            return new Promise((resolve) => {
                confirmModalResolve = resolve;
                const modal = document.getElementById('confirmModal');
                modal.classList.add('show');
            });
        }

        function closeConfirmModal(confirmed) {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
            if (confirmModalResolve) {
                confirmModalResolve(confirmed);
                confirmModalResolve = null;
            }
        }

        // Close modal when clicking outside (optional)
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('confirmModal');
            if (e.target === modal) {
                closeConfirmModal(false);
            }
        });

        // Keyboard support for confirmation modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('confirmModal');
            if (modal && modal.classList.contains('show')) {
                if (e.key === 'Escape') {
                    closeConfirmModal(false);
                } else if (e.key === 'Enter') {
                    closeConfirmModal(true);
                }
            }
        });

        // ==================== SUCCESS MODAL FUNCTIONS ====================
        let countdownInterval = null;
        let logoutTimeout = null;

        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('show');
            
            // Start countdown
            let seconds = 3;
            const countdownEl = document.getElementById('countdown-timer');
            countdownEl.textContent = seconds;
            
            countdownInterval = setInterval(() => {
                seconds--;
                if (seconds >= 0) {
                    countdownEl.textContent = seconds;
                }
            }, 1000);
            
            // Auto-logout after 3 seconds
            logoutTimeout = setTimeout(async () => {
                await firebaseLogout();
                location.reload();
            }, 3000);
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('show');
            
            // Clear timers
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (logoutTimeout) {
                clearTimeout(logoutTimeout);
                logoutTimeout = null;
            }
            
            // Logout immediately
            firebaseLogout().then(() => {
                location.reload();
            });
        }

        // Keyboard support for success modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('successModal');
            if (modal && modal.classList.contains('show')) {
                if (e.key === 'Enter' || e.key === 'Escape') {
                    closeSuccessModal();
                }
            }
        });

        function confirmAddProject() {
            const name = document.getElementById('projectNameInput').value.trim();
            const dateStarted = document.getElementById('projectDateStarted').value;
            const dateFinished = document.getElementById('projectDateFinished').value;
            const region = document.getElementById('projectRegion').value;
            const isRenewable = document.getElementById('projectIsRenewable').checked;
            const errorDiv = document.getElementById('projectModalError');

            errorDiv.innerText = '';

            if (!name) { errorDiv.innerText = '‚ö†Ô∏è Project name is required'; return; }
            if (!dateStarted) { errorDiv.innerText = '‚ö†Ô∏è Date started is required'; return; }
            if (!region) { errorDiv.innerText = '‚ö†Ô∏è Region is required'; return; }
            if (dateFinished && new Date(dateFinished) < new Date(dateStarted)) {
                errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be before date started'; return;
            }
            if (state.projects.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                errorDiv.innerText = '‚ö†Ô∏è Project name already exists'; return;
            }

            state.projects.push({
    name, region, status: 'on-going',
    dateStarted, dateFinished, 
    isRenewable: isRenewable,
    vals: {}, selected: false,
    doePdfFiles: {},
    auditData: {
        Q1: { scoreImpl: 0, docuComp: 0 },
        Q2: { scoreImpl: 0, docuComp: 0 },
        Q3: { scoreImpl: 0, docuComp: 0 },
        Q4: { scoreImpl: 0, docuComp: 0 }
    }
});

            sortProjects(state.currentSort);
            reapplyFilters(); // Reapply current filters
            saveUserData(state.currentUser.email);
            closeAddProjectModal();
            render();
            
            if (isRenewable) {
                showToast(`‚úÖ Project "${name}" added as Renewable Energy project`, 'success');
            } else {
                showToast(`‚úÖ Project "${name}" added successfully`, 'success');
            }
        }

        // Edit Project Modal Functions
        let editingProjectOriginalName = '';

        function openEditProjectModal(projectName, currentRegion) {
            const project = state.projects.find(p => p.name === projectName);
            if (!project) return;

            editingProjectOriginalName = projectName;
            
            // Set today's date as max for date finished
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('editProjectDateFinished').setAttribute('max', today);
            
            document.getElementById('editProjectNameInput').value = project.name;
            document.getElementById('editProjectDateStarted').value = project.dateStarted || '';
            document.getElementById('editProjectDateFinished').value = project.dateFinished || '';
            document.getElementById('editProjectRegion').value = project.region;
            document.getElementById('editProjectIsRenewable').checked = project.isRenewable || false;
            document.getElementById('editProjectModalError').innerText = '';
            document.getElementById('editProjectModal').classList.add('show');
        }

        function closeEditProjectModal() {
            document.getElementById('editProjectModal').classList.remove('show');
            editingProjectOriginalName = '';
        }

        function confirmEditProject() {
            const newName = document.getElementById('editProjectNameInput').value.trim();
            const dateStarted = document.getElementById('editProjectDateStarted').value;
            const dateFinished = document.getElementById('editProjectDateFinished').value;
            const newRegion = document.getElementById('editProjectRegion').value;
            const isRenewable = document.getElementById('editProjectIsRenewable').checked;
            const errorDiv = document.getElementById('editProjectModalError');

            errorDiv.innerText = '';

            if (!newName) { errorDiv.innerText = '‚ö†Ô∏è Project name is required'; return; }
            if (!dateStarted) { errorDiv.innerText = '‚ö†Ô∏è Date started is required'; return; }
            if (!newRegion) { errorDiv.innerText = '‚ö†Ô∏è Region is required'; return; }
            
            // Validate date finished
            if (dateFinished) {
                const finishedDate = new Date(dateFinished);
                const startDate = new Date(dateStarted);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to compare dates only
                
                if (finishedDate < startDate) {
                    errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be before date started'; 
                    return;
                }
                
                if (finishedDate > today) {
                    errorDiv.innerText = '‚ö†Ô∏è Date finished cannot be in the future'; 
                    return;
                }
            }
            
            // Check if new name conflicts with another project (but allow keeping the same name)
            if (newName.toLowerCase() !== editingProjectOriginalName.toLowerCase()) {
                if (state.projects.some(p => p.name.toLowerCase() === newName.toLowerCase())) {
                    errorDiv.innerText = '‚ö†Ô∏è Project name already exists'; 
                    return;
                }
            }

            // Find and update the project
            const project = state.projects.find(p => p.name === editingProjectOriginalName);
            if (project) {
                project.name = newName;
                project.dateStarted = dateStarted;
                project.dateFinished = dateFinished;
                project.region = newRegion;
                project.isRenewable = isRenewable;
                
                // Auto-update status based on dateFinished
                if (dateFinished) {
                    project.status = 'finished';
                } else if (project.status === 'finished') {
                    // If removing finish date and was finished, set back to on-going
                    project.status = 'on-going';
                }

                sortProjects(state.currentSort);
                reapplyFilters(); // Reapply current filters
                saveUserData(state.currentUser.email);
                closeEditProjectModal();
                render();
                
                showToast(`‚úÖ Project updated${isRenewable ? ' (Renewable Energy)' : ''}`, 'success');
            }
        }

        function handleSearch() {
            try {
                const searchInput = document.getElementById('search-input');
                const regionFilter = document.getElementById('region-filter');
                const statusFilter = document.getElementById('status-filter');
                
                // Check if elements exist
                if (!searchInput || !regionFilter || !statusFilter) {
                    return;
                }
                
                // Store current focus
                const activeElement = document.activeElement;
                const cursorPosition = searchInput.selectionStart;
                
                const search = searchInput.value.toLowerCase().trim();
                const region = regionFilter.value;
                const status = statusFilter.value;

                // Save filter values to state
                state.searchTerm = searchInput.value;
                state.regionFilter = region;
                state.statusFilter = status;

                // Start with all projects
                let filtered = [...state.projects];
                
                // Apply search filter
                if (search) {
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(search)
                    );
                }
                
                // Apply region filter (only if not empty/All Regions)
                if (region && region !== '') {
                    filtered = filtered.filter(p => p.region === region);
                }
                
                // Apply status filter (only if not empty/All Status)
                if (status && status !== '') {
                    filtered = filtered.filter(p => p.status === status);
                }
                
                state.filteredProjects = filtered;
                
                render();
                
                // Restore focus and cursor position
                if (activeElement && activeElement.id === 'search-input') {
                    const newSearchInput = document.getElementById('search-input');
                    if (newSearchInput) {
                        newSearchInput.focus();
                        newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                    }
                }
            } catch (error) {
                console.error('Error in handleSearch:', error);
            }
        }

        function handleFilter() { 
            handleSearch(); 
        }

        // Reapply current filters to the project list (useful after add/edit/delete)
        function reapplyFilters() {
            const search = state.searchTerm.toLowerCase().trim();
            const region = state.regionFilter;
            const status = state.statusFilter;

            let filtered = [...state.projects];
            
            // Apply search filter
            if (search) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(search)
                );
            }
            
            // Apply region filter
            if (region && region !== '') {
                filtered = filtered.filter(p => p.region === region);
            }
            
            // Apply status filter
            if (status && status !== '') {
                filtered = filtered.filter(p => p.status === status);
            }
            
            state.filteredProjects = filtered;
        }

        function toggleEdit() {
            state.isEditing = true;
            
            // Update floating button to SAVE mode
            const floatingBtn = document.getElementById('floating-edit-btn');
            const floatingIcon = document.getElementById('floating-edit-icon');
            const floatingTooltip = document.getElementById('floating-edit-tooltip');
            
            if (floatingBtn) {
                floatingBtn.classList.add('save-mode');
                floatingBtn.setAttribute('onclick', 'saveData()');
                floatingBtn.setAttribute('title', 'Save Changes');
            }
            if (floatingIcon) {
                floatingIcon.className = 'fas fa-save';
            }
            if (floatingTooltip) {
                floatingTooltip.textContent = 'Click to Save';
            }
            
            render();
        }

        async function saveData() {
            const floatingBtn = document.getElementById('floating-edit-btn');
            const floatingIcon = document.getElementById('floating-edit-icon');
            const floatingTooltip = document.getElementById('floating-edit-tooltip');
            
            // Disable editing mode UI
            state.isEditing = false;
            
            // Show saving state on floating button
            if (floatingBtn) {
                floatingBtn.style.pointerEvents = 'none';
                floatingBtn.style.opacity = '0.6';
            }
            if (floatingIcon) {
                floatingIcon.className = 'fas fa-spinner fa-spin';
            }
            if (floatingTooltip) {
                floatingTooltip.textContent = 'Saving...';
            }
            
            // Save to localStorage first (instant, no network)
            saveUserData(state.currentUser.email);
            
            // Then sync to Firebase
            const success = await saveToFirebase();
            
            if (success) {
                // Success state
                if (floatingIcon) floatingIcon.className = 'fas fa-check';
                if (floatingTooltip) floatingTooltip.textContent = 'Saved!';
                showToast('‚úì Data saved successfully!', 'success');
                
                setTimeout(() => {
                    // Return to EDIT mode
                    if (floatingBtn) {
                        floatingBtn.classList.remove('save-mode');
                        floatingBtn.setAttribute('onclick', 'toggleEdit()');
                        floatingBtn.setAttribute('title', 'Edit Mode');
                        floatingBtn.style.pointerEvents = 'auto';
                        floatingBtn.style.opacity = '1';
                    }
                    if (floatingIcon) floatingIcon.className = 'fas fa-edit';
                    if (floatingTooltip) floatingTooltip.textContent = 'Click to Edit';
                    render();
                }, 1500);
            } else {
                // Failure state
                if (floatingIcon) floatingIcon.className = 'fas fa-times';
                if (floatingTooltip) floatingTooltip.textContent = 'Failed!';
                showToast('Failed to save data. Please try again.', 'error');
                
                setTimeout(() => {
                    // Return to EDIT mode
                    if (floatingBtn) {
                        floatingBtn.classList.remove('save-mode');
                        floatingBtn.setAttribute('onclick', 'toggleEdit()');
                        floatingBtn.setAttribute('title', 'Edit Mode');
                        floatingBtn.style.pointerEvents = 'auto';
                        floatingBtn.style.opacity = '1';
                    }
                    if (floatingIcon) floatingIcon.className = 'fas fa-edit';
                    if (floatingTooltip) floatingTooltip.textContent = 'Click to Edit';
                    render();
                }, 2000);
            }
            
            console.log('üíæ Data saved to localStorage and synced to Firebase');
        }

        // Toggle navigation group expand/collapse
        function toggleNavGroup(header) {
            const items = header.nextElementSibling;
            const isCollapsed = items.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                items.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                // Collapse
                items.classList.add('collapsed');
                header.classList.add('collapsed');
            }
            
            // Save state to localStorage
            // Store true if expanded, false if collapsed
            const groupName = header.querySelector('span').textContent.trim();
            const navGroupStates = JSON.parse(localStorage.getItem('navGroupStates') || '{}');
            const newState = !items.classList.contains('collapsed'); // true if expanded, false if collapsed
            navGroupStates[groupName] = newState;
            localStorage.setItem('navGroupStates', JSON.stringify(navGroupStates));
        }
        
        // Restore navigation group states on load
        function restoreNavGroupStates() {
            const navGroupStates = JSON.parse(localStorage.getItem('navGroupStates') || '{}');
            document.querySelectorAll('.nav-group-header').forEach(header => {
                const groupName = header.querySelector('span').textContent.trim();
                const isExpanded = navGroupStates[groupName];
                
                // Default: all groups collapsed (set in HTML)
                // Only expand if explicitly saved as expanded in localStorage
                if (isExpanded === true) {
                    const items = header.nextElementSibling;
                    items.classList.remove('collapsed');
                    header.classList.remove('collapsed');
                }
            });
        }

        function changeTab(t) {
            state.currentTab = t;
            // Persist current tab so page refresh restores it
            localStorage.setItem('esh_last_tab', t);
            document.querySelectorAll('.nav-item').forEach(n => {
                const isActive = n.dataset.tab === t;
                n.classList.toggle('active', isActive);
                
                // Auto-expand parent group if this item is active
                if (isActive && n.parentElement.classList.contains('nav-group-items')) {
                    const groupItems = n.parentElement;
                    const groupHeader = groupItems.previousElementSibling;
                    
                    if (groupItems.classList.contains('collapsed')) {
                        groupItems.classList.remove('collapsed');
                        groupHeader.classList.remove('collapsed');
                        
                        // Save expanded state to localStorage
                        const groupName = groupHeader.querySelector('span').textContent.trim();
                        const navGroupStates = JSON.parse(localStorage.getItem('navGroupStates') || '{}');
                        navGroupStates[groupName] = true; // Expanded
                        localStorage.setItem('navGroupStates', JSON.stringify(navGroupStates));
                    }
                }
            });
            const titles = {
                'overall': 'OVERALL DASHBOARD', 'exposures': 'TOTAL EXPOSURES',
                'rates': 'STATISTICS RATE', 'medical': 'ACCIDENT/ INCIDENT RECORD',
		'nov': 'REGULATORY ISSUED NOV',
                'nov-monitoring': 'ESH NOV MONITORING',
                'activities': 'ESH ACTIVITIES AND PROGRAMS','kpm': 'KEY PERFORMANCE MEASURES REPORT','reg': 'DOLE CERTIFICATE OF REGISTRATION (DATE REGISTERED)','audit': 'INTERNAL ESH AUDIT REPORT',
                'cshp': 'CONSTRUCTION SAFETY & HEALTH PROGRAM (DATE APPROVED)', 'dole': 'DOLE REPORTORIAL','permits': 'ENVIRONMENTAL PERMITS/LICENSES/CLEARANCE','emb': ["EMB REPORTORIAL"],
                'doe': 'DOE REPORTORIAL - RENEWABLE ENERGY PROJECTS', 'doe-permit': 'DOE SAFETY OFFICER PERMIT',
                'personnel': 'ESH PERSONNEL MONITORING', 'settings': 'SETTINGS', 'admin': 'ADMIN CONTROL PANEL'
            };
            document.querySelector('.header-title').innerText = titles[t] || t.toUpperCase();
            document.getElementById('settings-view').classList.toggle('hidden', t !== 'settings');
            document.getElementById('personnel-view').classList.toggle('hidden', t !== 'personnel');
            document.getElementById('admin-view').classList.toggle('hidden', t !== 'admin');
            document.getElementById('dashboard-content').classList.toggle('hidden', t === 'settings' || t === 'personnel' || t === 'admin');
            
            // If switching to admin tab, render admin panel
            if (t === 'admin') {
                renderAdminPanel();
            }
            
            // Trigger slide animation on tab change
            const dashContent = document.getElementById('dashboard-content');
            const settingsView = document.getElementById('settings-view');
            const personnelView = document.getElementById('personnel-view');
            
            // Animate dashboard content
            if (dashContent && !dashContent.classList.contains('hidden')) {
                dashContent.style.animation = 'none';
                void dashContent.offsetWidth;
                dashContent.style.animation = 'slideRight 0.5s ease-out';
            }
            
            // Animate settings view
            if (settingsView && !settingsView.classList.contains('hidden')) {
                settingsView.style.animation = 'none';
                void settingsView.offsetWidth;
                settingsView.style.animation = 'slideRight 0.5s ease-out';
            }
            
            // Animate personnel view
            if (personnelView && !personnelView.classList.contains('hidden')) {
                personnelView.style.animation = 'none';
                void personnelView.offsetWidth;
                personnelView.style.animation = 'slideRight 0.5s ease-out';
            }
            
            if (t === 'settings') {
                populateSettingsTab();
                updateYearDisplay(); // Update year displays in settings
            }
            
            if (t === 'personnel') renderPTable();
            
            // PDF Export button visibility control
            const pdfBtn = document.getElementById('export-pdf-btn');
            if (pdfBtn) {
                // Hide PDF button for non-admins when in personnel tab
                if (t === 'personnel' && !state.isAdmin) {
                    pdfBtn.style.display = 'none';
                } else {
                    pdfBtn.style.display = 'inline-block';
                }
            }
            
            render();
        }

function updateAuditData(pName, qtr, field, val) {
    // Phase 3: Regional Locking - Check permission
    const p = state.projects.find(x => x.name === pName);
    if (p && !UserAccounts.canEdit(state.currentUser?.email, p.region)) {
        showLockedMessage();
        return;
    }
    
    // Prevent negative numbers
    const numVal = parseFloat(val);
    if (numVal < 0) {
        showToast('‚ö†Ô∏è Negative numbers are not allowed', 'warning');
        // Reset the input field to 0 or empty
        const input = event?.target;
        if (input) input.value = '';
        return;
    }
    
    // Prevent values over 100 for audit scores
    if (numVal > 100) {
        showToast('‚ö†Ô∏è Audit scores cannot exceed 100%', 'warning');
        const input = event?.target;
        if (input) input.value = '100';
        val = '100';
    }
    
    // p is already defined at the top for permission check
    if (p) {
        if (!p.auditData) {
            p.auditData = {
                Q1: { scoreImpl: 0, docuComp: 0 }, Q2: { scoreImpl: 0, docuComp: 0 },
                Q3: { scoreImpl: 0, docuComp: 0 }, Q4: { scoreImpl: 0, docuComp: 0 }
            };
        }
        p.auditData[qtr][field] = parseFloat(val) || 0;
        render(); // Para mag-update ang computation ng average sa screen
    }
}

        function updateVal(pName, key, mIdx, val) {
            // Phase 3: Regional Locking - Check permission
            const p = state.projects.find(x => x.name === pName);
            if (p && !UserAccounts.canEdit(state.currentUser?.email, p.region)) {
                showLockedMessage();
                return;
            }
            
            // Prevent negative numbers
            const numVal = parseFloat(val);
            if (numVal < 0) {
                showToast('‚ö†Ô∏è Negative numbers are not allowed', 'warning');
                // Reset the input field to 0 or empty
                const input = event?.target;
                if (input) input.value = '';
                return;
            }
            
            if (p) {
                if (!p.vals[key]) p.vals[key] = new Array(13).fill("");
                p.vals[key][mIdx] = val;
            }
            // Live-update the Incident Tabulation panel when relevant data changes
            if (state.currentTab === 'rates') {
                const panel = document.getElementById('incident-tabulation-panel');
                if (panel) {
                    panel.outerHTML = buildIncidentTabulationHTML();
                }
            }
        }

        // ==================== PDF UPLOAD FUNCTIONS ====================
        async function uploadPDF(inputElement, projectName, pdfKey, isReplacement = false) {
            const file = inputElement.files[0];
            if (!file) return;

            // Validate file type
            if (file.type !== 'application/pdf') {
                showToast('Please upload only PDF files.', 'error');
                inputElement.value = '';
                return;
            }

            // Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('File size must be less than 10MB.', 'error');
                inputElement.value = '';
                return;
            }

            // Confirmation for replacement
            if (isReplacement) {
                const confirmed = await showModernDialog(
                    'Replace PDF',
                    'Are you sure you want to replace the existing PDF file with this new one?',
                    true
                );
                if (!confirmed) {
                    inputElement.value = '';
                    return;
                }
            }

            try {
                // Show loading indicator
                const container = inputElement.parentElement;
                const originalHTML = container.innerHTML;
                container.innerHTML = '<span style="color: #1976D2;"><i class="fas fa-spinner fa-spin"></i> Uploading PDF...</span>';

                // Get current project
                const project = state.projects.find(p => p.name === projectName);
                if (!project) {
                    throw new Error('Project not found');
                }

                // Delete old file from Firebase Storage if replacing
                if (isReplacement && project.vals[pdfKey] && project.vals[pdfKey][1]) {
                    const oldPdfData = project.vals[pdfKey][1];
                    if (window.firebaseStorage && window.firebase && oldPdfData.storagePath) {
                        try {
                            const oldStorageRef = window.firebase.ref(window.firebaseStorage, oldPdfData.storagePath);
                            await window.firebase.deleteObject(oldStorageRef);
                            console.log('‚úÖ Old PDF deleted from storage');
                        } catch (deleteError) {
                            console.warn('‚ö†Ô∏è Could not delete old file from storage:', deleteError);
                            // Continue anyway
                        }
                    }
                }

                // Upload to Firebase Storage
                if (!window.firebaseStorage || !window.firebase) {
                    throw new Error('Firebase Storage not initialized');
                }

                const userId = state.currentUser.uid;
                const timestamp = Date.now();
                const fileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_'); // Sanitize filename
                const storagePath = `users/${userId}/pdfs/${projectName}_${pdfKey}_${timestamp}_${fileName}`;
                
                const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
                
                // Upload the actual PDF file to Firebase Storage
                await window.firebase.uploadBytes(storageRef, file);
                const downloadURL = await window.firebase.getDownloadURL(storageRef);

                console.log('‚úÖ PDF uploaded to Firebase Storage:', storagePath);
                console.log('üìé Download URL:', downloadURL);

                // Store PDF metadata in project vals
                if (!project.vals[pdfKey]) project.vals[pdfKey] = new Array(13).fill("");
                project.vals[pdfKey][1] = {
                    name: file.name,
                    url: downloadURL,
                    storagePath: storagePath,
                    uploadedAt: new Date().toISOString(),
                    size: file.size
                };
                
                // Save to localStorage and Firebase Firestore
                saveUserData(state.currentUser.email);
                await saveToFirebase();
                
                // Re-render to show the uploaded PDF
                render();

                console.log('‚úÖ PDF metadata saved to Firestore');
                showToast(isReplacement ? 'PDF file replaced successfully!' : 'PDF uploaded successfully!', 'success');
            } catch (error) {
                console.error('‚ùå PDF upload error:', error);
                showToast('Failed to upload PDF: ' + error.message, 'error');
                
                // Re-render to restore UI
                render();
            }

            // Clear file input
            inputElement.value = '';
        }

        async function deletePDF(projectName, pdfKey) {
            const project = state.projects.find(p => p.name === projectName);
            if (!project || !project.vals[pdfKey] || !project.vals[pdfKey][1]) return;

            const confirmed = await showModernDialog(
                'Delete PDF',
                'Are you sure you want to delete this PDF file? This action cannot be undone.',
                true
            );

            if (!confirmed) return;

            try {
                const pdfData = project.vals[pdfKey][1];
                
                // Delete from Firebase Storage
                if (window.firebaseStorage && window.firebase && pdfData.storagePath) {
                    try {
                        const storageRef = window.firebase.ref(window.firebaseStorage, pdfData.storagePath);
                        await window.firebase.deleteObject(storageRef);
                        console.log('‚úÖ PDF deleted from Firebase Storage:', pdfData.name);
                    } catch (storageError) {
                        console.warn('‚ö†Ô∏è Could not delete from storage:', storageError);
                        // Continue anyway to remove from database
                    }
                }

                // Remove from project vals
                project.vals[pdfKey][1] = null;
                
                // Save changes to localStorage and Firebase Firestore
                saveUserData(state.currentUser.email);
                await saveToFirebase();
                
                // Re-render
                render();

                console.log('‚úÖ PDF metadata removed from Firestore');
                showToast('PDF deleted successfully!', 'success');
            } catch (error) {
                console.error('‚ùå PDF deletion error:', error);
                showToast('Failed to delete PDF: ' + error.message, 'error');
            }
        }
        // ==================== END PDF UPLOAD FUNCTIONS ====================


        async function deleteProject(projectName) {
    debugLog('INFO', `üóëÔ∏è deleteProject() called for: ${projectName}`);
    
    // Phase 3: Regional Locking - Check permission
    const project = state.projects.find(p => p.name === projectName);
    if (project && !UserAccounts.canEdit(state.currentUser?.email, project.region)) {
        showLockedMessage();
        return;
    }
    
    // Validate before delete
    const beforeValidation = validateState();
    debugLog('DATA', 'State before delete:', beforeValidation.stats);
    
    const confirmed = await showModernDialog('Delete Project', `Are you sure you want to delete "${projectName}"? This action cannot be undone.`, true);
    
    if (confirmed) {
        // Remove from both projects arrays
        const beforeCount = {
            projects: state.projects.length,
            masterProjects: state.masterProjects.length,
            filtered: state.filteredProjects.length
        };
        
        state.projects = state.projects.filter(p => p.name !== projectName);
        
        // Also remove from masterProjects
        state.masterProjects = state.masterProjects.filter(p => p.name !== projectName);
        
        // Reapply filters to update filteredProjects correctly
        reapplyFilters();
        
        const afterCount = {
            projects: state.projects.length,
            masterProjects: state.masterProjects.length,
            filtered: state.filteredProjects.length
        };
        
        debugLog('DATA', 'Delete counts:', { before: beforeCount, after: afterCount });
        
        // Validate deletions
        if (afterCount.projects !== beforeCount.projects - 1) {
            debugLog('ERROR', '‚ùå projects array: deletion count mismatch!');
        }
        if (afterCount.masterProjects !== beforeCount.masterProjects - 1) {
            debugLog('ERROR', '‚ùå masterProjects array: deletion count mismatch!');
        }
        
        // Save to localStorage first
        saveUserData(state.currentUser.email);
        debugLog('SUCCESS', '‚úÖ Saved to localStorage');
        
        // Save to Firebase immediately
        showToast('üíæ Saving deletion to server...', 'info');
        debugLog('INFO', '‚òÅÔ∏è Syncing to Firebase...');
        
        const saved = await saveToFirebase();
        
        if (saved) {
            showToast(`‚úÖ Project "${projectName}" deleted successfully`, 'success');
            debugLog('SUCCESS', `‚úÖ Project "${projectName}" deleted from Firebase`);
            
            // Audit log the deletion
            AuditLogger.log('PROJECT_DELETED', {
                projectName: projectName,
                year: state.selectedYear,
                remainingProjects: state.projects.length
            });
        } else {
            showToast('‚ö†Ô∏è Deleted locally, but failed to sync to server', 'warning');
            debugLog('ERROR', '‚ùå Firebase sync failed');
        }
        
        // Validate after delete
        const afterValidation = validateState();
        if (!afterValidation.isValid) {
            debugLog('ERROR', '‚ùå State validation failed after delete:', afterValidation.issues);
        } else {
            debugLog('SUCCESS', '‚úÖ State validation passed after delete');
        }
        
        render();
    } else {
        debugLog('INFO', 'Delete cancelled by user');
    }
}

     function changeProjectStatus(projectName, event) {
    event.stopPropagation();
    const project = state.projects.find(p => p.name === projectName);
    if (!project) return;
    
    // Close any existing dropdown
    closeAllStatusDropdowns();
    
    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    
    const statuses = [
        { value: 'on-going', label: 'On-Going' },
        { value: 'work-stoppage', label: 'Work Stoppage' },
        { value: 'finished', label: 'Finished' }
    ];
    
    statuses.forEach(status => {
        const btn = document.createElement('button');
        btn.textContent = status.label;
        btn.style.fontWeight = project.status === status.value ? '700' : '400';
        
        // Disable finished if no finished date
        if (status.value === 'finished' && !project.dateFinished) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.title = 'Finished status requires a finished date. Edit the project and add a finished date first.';
        }
        
        btn.onclick = () => {
            // Double-check validation before changing status
            if (status.value === 'finished' && !project.dateFinished) {
                showToast('‚ö†Ô∏è Finished status requires a finished date. Please edit the project and add a finished date first.', 'warning');
                return;
            }
            
            project.status = status.value;
            reapplyFilters(); // Reapply filters after status change
            saveUserData(state.currentUser.email);
            closeAllStatusDropdowns();
            render();
        };
        dropdown.appendChild(btn);
    });
    
    const badge = event.target;
    const rect = badge.getBoundingClientRect();
    
    // Calculate if there's enough space below
    const dropdownHeight = 120; // Approximate height of dropdown with 3 items
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;
    
    dropdown.style.position = 'fixed';
    dropdown.style.left = rect.left + 'px';
    
    // Position above if not enough space below
    if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
        dropdown.style.bottom = (window.innerHeight - rect.top + 5) + 'px';
        dropdown.style.top = 'auto';
    } else {
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.bottom = 'auto';
    }
    
    document.body.appendChild(dropdown);
}

function closeAllStatusDropdowns() {
    document.querySelectorAll('.status-dropdown').forEach(d => d.remove());
}

        function getPerc(proj) {
            let total = 0, filled = 0;
            ["exposures", "rates", "medical", "nov", "activities", "kpm","dole","permits","emb", "cshp","reg"].forEach(cat => {
    SCHEMA[cat].forEach(row => {
        const key = `${cat}_${row}`;
        if (cat === 'cshp' || cat === 'reg') {
            total += 1;
            if (proj.vals[key] && proj.vals[key][1]) filled++;
        } else if (cat === 'permits') {
            // Permits have 3 fields: Permit No., Date Issued, Expiry Date
            total += 3;
            if (proj.vals[key]) {
                for (let i = 1; i <= 3; i++) {
                    if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                }
            }
        } else if (cat === 'emb') {
            // EMB has special submission cycles
            if (row === "SMR (Quarterly) - Submission Date") {
                total += 4; // Q1, Q2, Q3, Q4
                if (proj.vals[key]) {
                    for (let i = 1; i <= 4; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            } else if (row === "SMR (Quarterly) - Reference No.") {
                total += 4; // Q1, Q2, Q3, Q4
                if (proj.vals[key]) {
                    for (let i = 1; i <= 4; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "") filled++;
                    }
                }
            } else if (row === "CMR (Semi-Annual) - Submission Date") {
                total += 2; // Two semi-annual periods
                if (proj.vals[key] && proj.vals[key][1]) filled++;
                if (proj.vals[key] && proj.vals[key][2]) filled++;
            } else if (row === "CMR (Semi-Annual) - Reference No.") {
                total += 2; // Two semi-annual periods
                if (proj.vals[key] && proj.vals[key][1]) filled++;
                if (proj.vals[key] && proj.vals[key][2]) filled++;
            }
        } else {
            // Handle DOLE AEDR/AMR specially - they use only 1 field
            if (cat === 'dole' && (row === 'AEDR' || row === 'AMR')) {
                total += 1;
                if (proj.vals[key] && proj.vals[key][1]) filled++;
            } else {
                total += 12;
                if (proj.vals[key]) {
                    for (let i = 1; i <= 12; i++) {
                        if (proj.vals[key][i] && proj.vals[key][i] !== "0" && proj.vals[key][i] !== "") filled++;
                    }
                }
            }
        }
    });
});
            return total > 0 ? Math.round((filled / total) * 100) : 0;
        }

        function calculateYTD(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) sum += val;
            }
            return sum;
        }

        function calculateAverage(vals, rowIndex) {
            if (!vals) return 0;
            let sum = 0;
            let count = 0;
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(vals[i]) || 0;
                if (val > 0) {
                    sum += val;
                    count++;
                }
            }
            return count > 0 ? Math.round(sum / count) : 0;
        }

        function renderCharts() {
            const regionData = {};
            REGIONS.forEach(r => regionData[r] = [0, 0]);
            state.projects.forEach(p => {
                const perc = getPerc(p);
                regionData[p.region][0] += perc;
                regionData[p.region][1] += 1;
            });

            const regionAvgs = REGIONS.map(r => regionData[r][1] > 0 ? Math.round(regionData[r][0] / regionData[r][1]) : 0);
            const statusCounts = { 'on-going': 0, 'work-stoppage': 0, 'finished': 0 };
            state.projects.forEach(p => statusCounts[p.status]++);

            Object.values(state.charts).forEach(chart => { if (chart) chart.destroy(); });
            state.charts = {};

            setTimeout(() => {
                const regionCtx = document.getElementById('regionChart');
                if (regionCtx) {
                    const existingChart = Chart.getChart(regionCtx);
                    if (existingChart) existingChart.destroy();
                    
                    const ctx = regionCtx.getContext('2d');
                    
                    // Create unique gradient for each region
                    const gradients = [];
                    
                    // NCR - Pink/Magenta gradient
                    const gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient1.addColorStop(0, '#ec407a');
                    gradient1.addColorStop(0.5, '#e91e63');
                    gradient1.addColorStop(1, '#c2185b');
                    gradients.push(gradient1);
                    
                    // SOUTH LUZON - Blue gradient
                    const gradient2 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient2.addColorStop(0, '#42a5f5');
                    gradient2.addColorStop(0.5, '#2196f3');
                    gradient2.addColorStop(1, '#1976d2');
                    gradients.push(gradient2);
                    
                    // NORTH LUZON - Green gradient
                    const gradient3 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient3.addColorStop(0, '#66bb6a');
                    gradient3.addColorStop(0.5, '#4caf50');
                    gradient3.addColorStop(1, '#388e3c');
                    gradients.push(gradient3);
                    
                    // VISAYAS & MINDANAO - Orange gradient
                    const gradient4 = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient4.addColorStop(0, '#ffa726');
                    gradient4.addColorStop(0.5, '#ff9800');
                    gradient4.addColorStop(1, '#f57c00');
                    gradients.push(gradient4);
                    
                    state.charts.region = new Chart(regionCtx, {
                        type: 'bar',
                        data: {
                            labels: REGIONS,
                            datasets: [{
                                label: 'Compliance %',
                                data: regionAvgs,
                                backgroundColor: gradients,
                                borderWidth: 0,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    cornerRadius: 8
                                }
                            },
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    max: 100,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }

                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    // Create gradients for modern look
                    const ctx = statusCtx.getContext('2d');
                    
                    // Gradient 1: Blue gradient for On-Going
                    const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient1.addColorStop(0, '#42a5f5');
                    gradient1.addColorStop(0.5, '#1976D2');
                    gradient1.addColorStop(1, '#0d47a1');
                    
                    // Gradient 2: Red gradient for Work Stoppage
                    const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient2.addColorStop(0, '#ef5350');
                    gradient2.addColorStop(0.5, '#d32f2f');
                    gradient2.addColorStop(1, '#b71c1c');
                    
                    // Gradient 3: Gray gradient for Finished
                    const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient3.addColorStop(0, '#9e9e9e');
                    gradient3.addColorStop(0.5, '#616161');
                    gradient3.addColorStop(1, '#424242');
                    
                    // Center text plugin
                    const centerTextPlugin = {
                        id: 'centerText',
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const width = chart.width;
                            const height = chart.height;
                            
                            ctx.restore();
                            
                            // Calculate total and percentage
                            const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((statusCounts['on-going'] / total) * 100) : 0;
                            
                            // Draw percentage
                            const fontSize = (height / 180).toFixed(2);
                            ctx.font = `bold ${fontSize}em Inter, sans-serif`;
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = '#1b5e20';
                            
                            const percentText = percentage + '%';
                            const percentTextX = Math.round((width - ctx.measureText(percentText).width) / 2);
                            const percentTextY = height / 2 - 10;
                            
                            ctx.fillText(percentText, percentTextX, percentTextY);
                            
                            // Draw label
                            const labelFontSize = (height / 320).toFixed(2);
                            ctx.font = `${labelFontSize}em Inter, sans-serif`;
                            ctx.fillStyle = '#666';
                            
                            const labelText = 'On-Going';
                            const labelTextX = Math.round((width - ctx.measureText(labelText).width) / 2);
                            const labelTextY = height / 2 + 18;
                            
                            ctx.fillText(labelText, labelTextX, labelTextY);
                            
                            ctx.save();
                        }
                    };
                    
                    state.charts.status = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['On-Going', 'Work Stoppage', 'Finished'],
                            datasets: [{
                                data: [statusCounts['on-going'], statusCounts['work-stoppage'], statusCounts['finished']],
                                backgroundColor: [gradient1, gradient2, gradient3],
                                borderWidth: 0,
                                borderRadius: 8,
                                spacing: 3
                            }]
                        },
                        options: { 
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            family: 'Inter, sans-serif'
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            }
                        },
                        plugins: [centerTextPlugin]
                    });
                }
            }, 100);
        }

        // PDF EXPORT FUNCTION - DISABLED (removed from UI)
        // Uncomment if needed in the future
        /*
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const tabTitles = {
                'overall': 'OVERALL SUMMARY',
                'exposures': 'SAFETY EXPOSURES',
                'medical': 'ACCIDENT/INCIDENT RECORD',
                'activities': 'SAFETY ACTIVITIES',
                'audit': 'SAFETY AUDIT',
                'nov': 'NOV',
                'rates': 'STATISTICS RATE',
                'personnel': 'ESH PERSONNEL MONITORING'
            };
            
            const title = tabTitles[state.currentTab] || 'ESH COMPLIANCE DASHBOARD';
            
            doc.setFontSize(16);
            doc.setTextColor(27, 94, 32);
            doc.text(title, 14, 15);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated: ' + new Date().toLocaleString(), 14, 22);
            
            let table;
            if (state.currentTab === 'personnel') {
                table = document.getElementById('p-table');
            } else {
                const container = document.getElementById('dashboard-content');
                table = container ? container.querySelector('table') : null;
            }
            
            if (!table) {
                showToast('No table data to export', 'warning');
                return;
            }
            
            const headers = [];
            const rows = [];
            
            const headerCells = table.querySelectorAll('thead th');
            headerCells.forEach(th => {
                headers.push(th.textContent.trim());
            });
            
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(tr => {
                const row = [];
                const cells = tr.querySelectorAll('td');
                cells.forEach(td => {
                    const input = td.querySelector('input[type="text"], input[type="date"], input[type="number"], select');
                    if (input) {
                        row.push(input.value || '');
                    } else {
                        row.push(td.textContent.trim());
                    }
                });
                if (row.length > 0) {
                    rows.push(row);
                }
            });
            
            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 28,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [46, 125, 50],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 'auto', fontStyle: 'bold' }
                },
                margin: { top: 28, left: 14, right: 14 },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text('ESH Compliance Dashboard - SCIC', data.settings.margin.left, doc.internal.pageSize.height - 10);
                    doc.text('Page ' + doc.internal.getNumberOfPages(), doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                }
            });
            
            const filename = `ESH_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }
        */


        function showUI() {
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            // Restore last active tab, fallback to 'overall'
            const lastTab = localStorage.getItem('esh_last_tab') || 'overall';
            changeTab(lastTab);
        }

        // Helper function to check if a month should be marked as overdue
        function isOverdueMonth(monthIndex) {
            // monthIndex: 1 = January, 2 = February, ..., 12 = December
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = now.getFullYear();
            
            // Only mark as overdue if the month is before the current month in the current year
            return monthIndex < currentMonth;
        }

        // Helper function to check if a quarter is overdue
        function isOverdueQuarter(quarterIndex) {
            // quarterIndex: 1 = Q1 (Jan-Mar), 2 = Q2 (Apr-Jun), 3 = Q3 (Jul-Sep), 4 = Q4 (Oct-Dec)
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            
            // Determine which quarter we're currently in
            const currentQuarter = Math.ceil(currentMonth / 3);
            
            // Quarter is overdue if it's before the current quarter
            return quarterIndex < currentQuarter;
        }

        // Helper function to check if a half-year is overdue
        function isOverdueHalf(halfIndex) {
            // halfIndex: 1 = 1st Half (Jan-Jun), 2 = 2nd Half (Jul-Dec)
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            
            // 1st half is overdue if we're in month 7 or later (July onwards)
            if (halfIndex === 1) return currentMonth > 6;
            
            // 2nd half is never overdue in current year (only when year changes)
            return false;
        }

        // ===== TOAST NOTIFICATION SYSTEM =====
        function showToast(message, type = 'success', duration = 3500) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // Phase 3: Regional Locking - Show locked message
        function showLockedMessage() {
            showToast('üîí View Only - You can only edit projects in your assigned region. Contact admin for access.', 'warning', 4000);
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S = Save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (state.isEditing) {
                    saveData();
                    showToast('Saving data...', 'info', 1500);
                }
            }
            
            // Ctrl/Cmd + E = Toggle Edit
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (!state.isEditing) {
                    toggleEdit();
                    showToast('Edit mode enabled', 'info', 1500);
                }
            }
            
            // Escape = Cancel edit mode only (not modals)
            if (e.key === 'Escape') {
                // Check if any modal is open
                const modals = document.querySelectorAll('.modal.show');
                if (modals.length > 0) {
                    // Modal is open - ESC key does nothing
                    // User must click Cancel or Save button
                    showToast('‚ÑπÔ∏è Please use Cancel or Save button to close', 'info', 2000);
                    return;
                }
                
                if (state.isEditing) {
                    // No modal open, so cancel edit mode
                    showModernDialog(
                        'Cancel Editing?', 
                        'Unsaved changes will be lost. Are you sure you want to cancel?',
                        true,
                        'Yes, Discard Changes',
                        'No, Continue Editing'
                    ).then(confirmed => {
                        if (confirmed) {
                            location.reload();
                        }
                    });
                }
            }
        });

        // ==================== REGION COLLAPSE/EXPAND FUNCTIONS ====================
        const collapsedRegions = new Set(JSON.parse(localStorage.getItem('esh_collapsed_regions') || '[]'));
        
        function toggleRegion(regionName, event) {
            // Prevent toggle if clicking on buttons inside banner
            if (event && (event.target.tagName === 'BUTTON' || event.target.tagName === 'SELECT' || 
                         event.target.closest('button') || event.target.closest('select'))) {
                return;
            }
            
            const regionContent = document.getElementById(`region-content-${regionName}`);
            const regionBanner = document.getElementById(`region-banner-${regionName}`);
            
            if (!regionContent || !regionBanner) return;
            
            if (collapsedRegions.has(regionName)) {
                // Expand
                collapsedRegions.delete(regionName);
                regionContent.classList.remove('collapsed');
                regionBanner.classList.remove('collapsed');
            } else {
                // Collapse
                collapsedRegions.add(regionName);
                regionContent.classList.add('collapsed');
                regionBanner.classList.add('collapsed');
            }
            
            // Save to localStorage
            localStorage.setItem('esh_collapsed_regions', JSON.stringify([...collapsedRegions]));
        }
        
        function isRegionCollapsed(regionName) {
            return collapsedRegions.has(regionName);
        }
        // ==================== END REGION COLLAPSE/EXPAND ====================

        function render() {
            if (state.currentTab === 'settings' || state.currentTab === 'personnel' || state.currentTab === 'admin') return;

            const container = document.getElementById('dashboard-content');
            let html = '';

            // ‚îÄ‚îÄ INCIDENT TABULATION RATE summary always shows at the TOP of Statistics Rate ‚îÄ‚îÄ
            if (state.currentTab === 'rates') {
                html += buildIncidentTabulationHTML();
                html += buildTrendChartHTML('rates');
            }

            let grandTotal = 0;
            state.projects.forEach(p => grandTotal += getPerc(p));
            const overallAvg = state.projects.length > 0 ? Math.round(grandTotal / state.projects.length) : 0;

            if (state.currentTab === 'overall') {
                // Add search and filters inside dashboard
                html += `
                <div style="background: var(--bg-card); padding: 15px 20px; margin: 0 20px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="search-input" placeholder="üîç Search projects..." onkeyup="handleSearch()" 
                                   value="${state.searchTerm || ''}"
                                   style="width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-primary);">
                        </div>
                        <div>
                            <select id="region-filter" onchange="handleFilter()" 
                                    style="padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-primary); min-width: 180px;">
                                <option value="" ${state.regionFilter === '' ? 'selected' : ''}>üìç All Regions</option>
                                <option value="NCR" ${state.regionFilter === 'NCR' ? 'selected' : ''}>NCR</option>
                                <option value="SOUTH LUZON" ${state.regionFilter === 'SOUTH LUZON' ? 'selected' : ''}>South Luzon</option>
                                <option value="NORTH LUZON" ${state.regionFilter === 'NORTH LUZON' ? 'selected' : ''}>North Luzon</option>
                                <option value="VISAYAS & MINDANAO" ${state.regionFilter === 'VISAYAS & MINDANAO' ? 'selected' : ''}>Visayas & Mindanao</option>
                            </select>
                        </div>
                        <div>
                            <select id="status-filter" onchange="handleFilter()" 
                                    style="padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-primary); min-width: 160px;">
                                <option value="" ${state.statusFilter === '' ? 'selected' : ''}>üìä All Status</option>
                                <option value="on-going" ${state.statusFilter === 'on-going' ? 'selected' : ''}>On-Going</option>
                                <option value="work-stoppage" ${state.statusFilter === 'work-stoppage' ? 'selected' : ''}>Work Stoppage</option>
                                <option value="finished" ${state.statusFilter === 'finished' ? 'selected' : ''}>Finished</option>
                            </select>
                        </div>
                    </div>
                </div>
                `;
                
                html += `<div id="grand-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL PROJECTS</div>
                        <div class="stat-value">${state.projects.length}</div>
                        <div class="particles-container">
                            <div class="particle particle-green-1"></div>
                            <div class="particle particle-green-2"></div>
                            <div class="particle particle-green-3"></div>
                            <div class="particle particle-green-4"></div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--safety-yellow);">
                        <div class="stat-label">OVERALL COMPLIANCE</div>
                        <div class="stat-value">${overallAvg}%</div>
                        <div class="particles-container">
                            <div class="particle particle-yellow-1"></div>
                            <div class="particle particle-yellow-2"></div>
                            <div class="particle particle-yellow-3"></div>
                            <div class="particle particle-yellow-4"></div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #1976D2;">
                        <div class="stat-label">ON-GOING</div>
                        <div class="stat-value">${state.projects.filter(p => p.status === 'on-going').length}</div>
                        <div class="particles-container">
                            <div class="particle particle-blue-1"></div>
                            <div class="particle particle-blue-2"></div>
                            <div class="particle particle-blue-3"></div>
                            <div class="particle particle-blue-4"></div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-left-color: #d32f2f;">
                        <div class="stat-label">WORK STOPPAGE</div>
                        <div class="stat-value">${state.projects.filter(p => p.status === 'work-stoppage').length}</div>
                        <div class="particles-container">
                            <div class="particle particle-red-1"></div>
                            <div class="particle particle-red-2"></div>
                            <div class="particle particle-red-3"></div>
                            <div class="particle particle-red-4"></div>
                        </div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box"><h3><i class="fas fa-chart-bar"></i> Compliance by Region</h3><canvas id="regionChart"></canvas></div>
                    <div class="chart-box"><h3><i class="fas fa-chart-pie"></i> Project Status</h3><canvas id="statusChart"></canvas></div>
                </div>`;
                renderCharts();
            }

            // Always use filteredProjects (it will equal projects when no filters active)
            const displayProjects = state.filteredProjects;

            // Add trend chart for medical tab
            if (state.currentTab === 'medical') {
                html += buildTrendChartHTML('medical');
            }

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // OVERALL SUMMARY - ALL REGIONS (para sa specific tabs)
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (['exposures', 'medical', 'activities', 'nov'].includes(state.currentTab) && displayProjects.length > 0) {
                const hasYTD = ['exposures', 'medical', 'activities', 'nov'].includes(state.currentTab);
                const isNov = state.currentTab === 'nov';
                
                html += `
                <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); color: white; padding: 20px; margin: 20px 20px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; position: relative; z-index: 2;">
                        <i class="fas fa-globe" style="font-size: 1.8rem; color: #fbc02d;"></i>
                        <div>
                            <h2 style="margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: 0.5px;">OVERALL SUMMARY - ALL REGIONS</h2>
                            <p style="margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9;">Consolidated data from all projects across all regions</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-container" style="margin: 0 20px 20px;">
                    <table>
                        <tr>
                            <th style="width:250px; text-align:left; background: #2e7d32; position: sticky; left: 0; z-index: 10;">TYPE</th>
                            <th class="prev-year${isNov ? ' nov-narrow-th' : ''}" style="background: #388e3c;">PREVIOUS</th>`;
                
                // Monthly column headers
                MONTHS.forEach(m => {
                    html += `<th${isNov ? ' class="nov-narrow-th"' : ''} style="background: #388e3c;">${m}</th>`;
                });
                
                if (hasYTD) {
                    html += `<th class="ytd-header" style="background: #f9a825;">RUNNING YTD</th>`;
                }
                
                html += `</tr>`;
                
                // Calculate totals for each row
                SCHEMA[state.currentTab].forEach((row, rowIdx) => {
                    const key = `${state.currentTab}_${row}`;
                    html += `<tr><td style="text-align:left; font-weight:700; background:#e8f5e9; color:#1b5e20; position: sticky; left: 0; z-index: 5;">${row}</td>`;
                    
                    // Previous Year Total
                    let prevTotal = 0;
                    displayProjects.forEach(p => {
                        const val = p.vals[key] ? p.vals[key][0] : "";
                        if (val !== "" && !isNaN(val)) prevTotal += parseFloat(val);
                    });
                    html += `<td class="prev-year${isNov ? ' nov-narrow-td' : ''}" style="font-weight: 700; font-size: 0.95rem;">${prevTotal > 0 ? prevTotal : ''}</td>`;
                    
                    // Monthly Totals
                    for (let i = 1; i <= 12; i++) {
                        let monthTotal = 0;
                        displayProjects.forEach(p => {
                            const val = p.vals[key] ? p.vals[key][i] : "";
                            if (val !== "" && !isNaN(val)) monthTotal += parseFloat(val);
                        });
                        html += `<td class="${isNov ? 'nov-narrow-td' : 'monthly-data'}" style="font-weight: 600; background: #f1f8e9;">${monthTotal > 0 ? monthTotal : ''}</td>`;
                    }
                    
                    // Running YTD Total
                    if (hasYTD) {
                        let ytdTotal = 0;
                        if (row === "Total Manpower") {
                            // For Total Manpower, calculate average across all projects
                            let totalAvg = 0;
                            let projectCount = 0;
                            displayProjects.forEach(p => {
                                const avg = calculateAverage(p.vals[key], rowIdx);
                                if (avg > 0) {
                                    totalAvg += avg;
                                    projectCount++;
                                }
                            });
                            ytdTotal = projectCount > 0 ? Math.round(totalAvg / projectCount) : 0;
                            html += `<td class="average-cell" style="font-weight: 800; font-size: 1rem;">${ytdTotal > 0 ? ytdTotal : ''}</td>`;
                        } else {
                            // For other rows, sum YTD
                            displayProjects.forEach(p => {
                                const ytd = calculateYTD(p.vals[key], rowIdx);
                                if (ytd > 0) ytdTotal += ytd;
                            });
                            html += `<td class="ytd-cell" style="font-weight: 800; font-size: 1rem;">${ytdTotal > 0 ? ytdTotal : ''}</td>`;
                        }
                    }
                    
                    html += `</tr>`;
                });
                
                html += `</table></div>
                
                <div style="margin: 0 20px 30px; padding: 15px; background: #fff3e0; border-left: 5px solid #ff9800; border-radius: 6px;">
                    <p style="margin: 0; font-size: 0.85rem; color: #e65100; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> This summary aggregates data from <strong>${displayProjects.length} project(s)</strong> across all regions. 
                        Individual project details are shown below by region.
                    </p>
                </div>`;
            }

            // Show welcome message if no projects exist yet
            if (state.projects.length === 0 && state.currentTab === 'overall') {
                html += `<div style="background: var(--bg-card); border-radius: 12px; padding: 40px; text-align: center; margin: 20px 0; border: 2px dashed var(--border-color);">
                    <i class="fas fa-rocket" style="font-size: 3rem; color: #2e7d32; opacity: 0.6; margin-bottom: 15px;"></i>
                    <h3 style="color: var(--text-primary); margin: 10px 0; font-size: 1.2rem;">Welcome to ESH Compliance Dashboard!</h3>
                    <p style="color: var(--text-secondary); margin: 10px 0 20px; font-size: 0.9rem;">Get started by adding your first project. Click the <strong>EDIT</strong> button above, then use <strong>+ ADD PROJECT</strong> in any region below.</p>
                    <button onclick="toggleEdit()" class="btn btn-primary" style="padding: 12px 30px; font-size: 0.9rem;">
                        <i class="fas fa-plus-circle"></i> START ADDING PROJECTS
                    </button>
                </div>`;
            }

            // Skip region-based rendering for DOE tabs (they have their own rendering)
            if (state.currentTab !== 'doe' && state.currentTab !== 'doe-permit') {
                REGIONS.forEach(reg => {
                const projs = displayProjects.filter(p => p.region === reg);
                
                // Calculate region average only if there are projects
                const regSum = projs.reduce((sum, p) => sum + getPerc(p), 0);
                const regionAvg = projs.length > 0 ? Math.round(regSum / projs.length) : 0;

                // Always show region banner, even if empty (so user can add projects)
                const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg);
                const isCollapsed = isRegionCollapsed(reg);
                
                html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                    <div>
                        <i class="fas fa-location-dot"></i> ${reg}
                        ${!canEditRegion ? `<i class="fas fa-lock" style="color: #f57c00; margin-left: 8px;" title="üîí View Only - This region is locked for you"></i>` : ''}
                        <span class="badge">${projs.length} PROJ</span>
                        ${projs.length > 0 ? `<span class="badge" style="background:#1b5e20; color:var(--safety-yellow);">AVG: ${regionAvg}%</span>` : ''}
                        <i class="fas fa-chevron-down region-toggle-icon"></i>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${state.isEditing && canEditRegion ? `<button onclick="event.stopPropagation(); openAddProjectModal('${reg}')" class="btn btn-primary">+ ADD PROJECT</button>` : ''}
                        ${state.isEditing && !canEditRegion ? `<button disabled style="opacity: 0.5; cursor: not-allowed; background: #999;" class="btn btn-primary" title="You can only add projects to your assigned region">LOCKED</button>` : ''}
                        ${state.currentTab === 'overall' && projs.length > 0 ? `<select class="sort-select" onclick="event.stopPropagation()" onchange="sortProjects(this.value)">
                            <option value="name" ${state.currentSort === 'name' ? 'selected' : ''}>Sort: Name</option>
                            <option value="dateStarted" ${state.currentSort === 'dateStarted' ? 'selected' : ''}>Sort: Date Started</option>
                            <option value="dateFinished" ${state.currentSort === 'dateFinished' ? 'selected' : ''}>Sort: Date Finished</option>
                        </select>` : ''}
                    </div>
                </div>`;
                
                html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                
                // Show empty state message if no projects in this region
                if (projs.length === 0 && state.isEditing) {
                    html += `<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.85rem; font-style: italic;">
                        <i class="fas fa-folder-open" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
                        No projects in this region yet. Click "+ ADD PROJECT" to get started.
                    </div>`;
                }

                projs.forEach(p => {
                    const perc = getPerc(p);
                    const statusClass = p.status === 'on-going' ? 'status-ongoing' : p.status === 'work-stoppage' ? 'status-stoppage' : 'status-finished';
                    const statusLabel = p.status === 'on-going' ? 'On-Going' : p.status === 'work-stoppage' ? 'Work Stoppage' : 'Finished';
                    
                    // Check if user can edit this project (Phase 3: Regional Locking)
                    const canEdit = UserAccounts.canEdit(state.currentUser?.email, p.region);
                    const isLocked = !canEdit;
                    const inputsEditable = state.isEditing && canEdit; // For table inputs

                    html += `<div class="project-row ${isLocked ? 'project-locked' : ''}">
                        ${state.isEditing ? `<input type="checkbox" class="project-checkbox" ${p.selected ? 'checked' : ''} ${isLocked ? 'disabled' : ''} onchange="toggleProjectSelect('${p.name}')">` : ''}
                        <div class="circular-progress" style="--percentage: ${perc * 3.6}deg;">
                            <div class="circular-progress-inner">${perc}%</div>
                        </div>
                        <div class="project-info">
                            <div class="project-name">
                                ${isLocked ? '<i class="fas fa-lock" style="color: #f57c00; margin-right: 6px;" title="View Only - Contact admin to edit"></i>' : ''}
                                ${p.isRenewable ? '<span style="display: inline-flex; align-items: center; gap: 4px; background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; margin-right: 6px;"><i class="fas fa-leaf" style="color: #4caf50;"></i> RE</span>' : ''}
                                ${p.name}
                            </div>
                            <div class="project-meta">Safety Compliance ‚Ä¢ ${p.region || 'No Region'}</div>
                        </div>
                        <div class="project-dates">
                            <div><span class="date-label">Started:</span> ${p.dateStarted ? new Date(p.dateStarted).toLocaleDateString() : 'Not set'}</div>
                            <div><span class="date-label">Finished:</span> ${p.dateFinished ? new Date(p.dateFinished).toLocaleDateString() : 'Ongoing'}</div>
                        </div>
                        <span class="status-badge ${statusClass}" onclick="${isLocked ? 'showLockedMessage()' : `changeProjectStatus('${p.name}', event)`}">${statusLabel}</span>
                        ${state.isEditing ? `
                            <button class="btn btn-secondary" ${isLocked ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onclick="${isLocked ? 'showLockedMessage()' : `openEditProjectModal('${p.name.replace(/'/g, "\\'")}', '${p.region}')`}" style="margin-right: 5px;" title="${isLocked ? 'View Only - Contact admin to edit' : 'Edit Project Details'}">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="btn btn-danger" ${isLocked ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onclick="${isLocked ? 'showLockedMessage()' : `deleteProject('${p.name}')`}" title="${isLocked ? 'View Only - Contact admin to edit' : 'Delete Project'}"><i class="fas fa-trash"></i></button>
                        ` : ''}
                    </div>`;

if (state.currentTab === 'audit') {
    html += `<div class="table-container">
        <style>
            .audit-table {
                border-collapse: separate;
                border-spacing: 0;
                width: 100%;
                max-width: 1100px;
                margin: 20px auto;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 8px 24px rgba(27, 94, 32, 0.15), 0 2px 6px rgba(0, 0, 0, 0.08);
                background: white;
            }
            
            /* Enhanced Green Header - Option 4 Style */
            .audit-table thead th {
                background: #1b5e20;
                color: #ffffff;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                font-size: 11px;
                padding: 16px 8px;
                border: none;
                border-bottom: 3px solid var(--safety-yellow);
                position: relative;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }
            
            /* Top row headers - Quarter labels */
            .audit-table thead tr:first-child th {
                font-size: 13px;
                padding: 18px 8px;
                font-weight: 800;
                letter-spacing: 1.2px;
                background: #1b5e20;
            }
            
            /* Second row - Score labels */
            .audit-table thead tr:nth-child(2) th {
                font-size: 12px;
                padding: 14px 8px;
                background: #1b5e20;
            }
            
            /* Column headers with white background */
            .audit-table thead tr:last-child th {
                background: #f8f9fa;
                color: #1b5e20;
                font-size: 10px;
                padding: 12px 6px;
                border-top: 2px solid #2e7d32;
                font-weight: 600;
                letter-spacing: 0.5px;
            }
            
            /* Average column styling */
            .audit-table thead tr:last-child th[style*="background: #808080"],
            .audit-table thead tr:last-child th[style*="background:#808080"] {
                background: linear-gradient(135deg, #616161 0%, #757575 100%) !important;
                color: white !important;
                font-weight: 700;
            }
            
            /* Body cells - Option 4 striped design */
            .audit-table td { 
                border: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                text-align: center; 
                vertical-align: middle; 
                padding: 12px 8px;
                font-size: 13px;
                transition: all 0.2s ease;
            }
            
            /* Row hover effect - Option 4 style with left border */
            .audit-table tbody tr {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-left: 3px solid transparent;
            }
            
            .audit-table tbody tr:nth-child(odd) {
                background-color: #ffffff;
            }
            
            .audit-table tbody tr:nth-child(even) {
                background-color: #f1f8e9;
            }
            
            .audit-table tbody tr:hover {
                border-left: 3px solid #4caf50;
                background-color: #e8f5e9 !important;
            }
            
            /* Specific cell styles */
            .cell-white { 
                background-color: #ffffff;
            }
            
            .cell-avg-gray { 
                background: linear-gradient(135deg, #616161 0%, #757575 100%) !important;
                color: white !important; 
                font-weight: 700;
                font-size: 14px;
                letter-spacing: 0.3px;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .cell-grand-total { 
                background: linear-gradient(135deg, #ffd54f 0%, #ffeb3b 100%) !important;
                color: #1b5e20 !important; 
                font-weight: 800;
                font-size: 16px;
                letter-spacing: 0.5px;
                box-shadow: inset 0 2px 6px rgba(251, 192, 45, 0.4);
                border: 2px solid #fbc02d !important;
            }
            
            /* Enhanced input styling */
            .audit-table input { 
                text-align: center; 
                width: 52px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                padding: 6px 4px;
                transition: all 0.2s ease;
                background: white;
                color: #1b5e20;
                font-family: 'Inter', sans-serif;
            }
            
            .audit-table input:hover {
                border-color: #66bb6a;
                background: #f1f8f4;
            }
            
            .audit-table input:focus {
                outline: none;
                border-color: #2e7d32;
                background: #ffffff;
                box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            }
            
            .audit-table input:disabled {
                background: #f5f5f5;
                color: #757575;
                cursor: not-allowed;
                border-color: #e0e0e0;
            }
            
            .audit-table p { 
                margin: 0; 
                padding: 0; 
                font-size: 11px;
                line-height: 1.4;
            }
            
            /* Dark mode support for audit table */
            body.dark-mode .audit-table {
                background: #2d2d2d;
            }
            
            body.dark-mode .audit-table tbody tr:nth-child(odd) {
                background-color: #2d2d2d;
            }
            
            body.dark-mode .audit-table tbody tr:nth-child(even) {
                background-color: #1f2e1f;
            }
            
            body.dark-mode .audit-table tbody tr:hover {
                background-color: #1b3d1b !important;
            }
            
            body.dark-mode .audit-table td {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            /* Responsive design */
            @media (max-width: 768px) {
                .audit-table {
                    font-size: 10px;
                    max-width: 100%;
                    border-radius: 8px;
                }
                
                .audit-table thead th {
                    padding: 10px 4px;
                    font-size: 9px;
                }
                
                .audit-table td {
                    padding: 8px 4px;
                    font-size: 11px;
                }
                
                .audit-table input {
                    width: 40px;
                    font-size: 11px;
                    padding: 4px 2px;
                }
            }
        </style>
        
        <table class="audit-table">
            <thead>
                <tr>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q1 (JAN-MAR)</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q2 (APR-JUN)</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q3 (JUL-SEP)</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q4 (OCT-DEC)</th>
                    <th rowspan="3" class="cell-grand-total" style="border-left: 3px solid #fbc02d; vertical-align: middle; line-height: 1.3;">GRAND<br>TOTAL<br>AVERAGE</th>
                </tr>
                <tr>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                    <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                </tr>
                <tr>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                    
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                    
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                    
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Implementation</th>
                    <th style="background: white; color: #1b5e20; font-size: 10px; font-weight: 600;">Documentation & Compliance</th>
                    <th style="background: #808080; color: white; font-size: 10px; font-weight: 700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                </tr>
            </thead>
            <tbody>
                <tr>`;

    const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
    let totalYearAvg = 0;
    
    quarters.forEach(q => {
        const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
        const qAvg = (audit.scoreImpl + audit.docuComp) / 2;
        totalYearAvg += qAvg;

        html += `
            <td class="cell-white"><input type="number" min="0" max="100" value="${audit.scoreImpl}" ${inputsEditable ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)" placeholder="0"></td>
            <td class="cell-white"><input type="number" min="0" max="100" value="${audit.docuComp}" ${inputsEditable ? '' : 'disabled'} oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)" placeholder="0"></td>
            <td class="cell-avg-gray" style="border-right: 2px solid #e0e0e0;">${qAvg.toFixed(2)}</td>`;
    });

    html += `<td class="cell-grand-total">${(totalYearAvg / 4).toFixed(2)}</td>
                </tr>
            </tbody>
        </table>
    </div>`;
}

                  // ==================== DOE TABS MOVED AFTER GROUPED TABLES ====================
                  // (See after line ~7687 for DOE Reportorial and DOE Safety Officer Permit rendering)
                  
                  if (state.currentTab === 'nov-monitoring') {
    // Special rendering for ESH NOV Monitoring - all projects grouped per region
    // Skip individual project rendering - will be done at region level
}
else if (state.currentTab !== 'overall' && state.currentTab !== 'audit' && state.currentTab !== 'doe' && state.currentTab !== 'doe-permit') {
    const isDateType = ['kpm','dole','permits','emb','cshp','reg'].includes(state.currentTab);
    const isCshp = state.currentTab === 'cshp' || state.currentTab === 'reg';
    const hasYTD = ['exposures', 'rates', 'medical', 'nov', 'activities'].includes(state.currentTab);
    const isNov = state.currentTab === 'nov';

    // Adjust TYPE column width based on tab - narrower for short text tabs
    let typeColumnWidth = '250px';
    if (state.currentTab === 'permits' || state.currentTab === 'dole') {
        typeColumnWidth = '280px'; // Wider for long permit names
    } else if (state.currentTab === 'emb') {
        typeColumnWidth = '220px';
    }

    html += `<div class="table-container"><table>`;
    html += `<tr><th style="width:${typeColumnWidth}; min-width:${typeColumnWidth}; max-width:${typeColumnWidth}; text-align:left; background: #2e7d32; position: sticky; left: 0; z-index: 10; white-space: normal; padding: 10px 12px; line-height: 1.3; vertical-align: middle;">TYPE</th>`;

    if (isCshp) {
        const headerText = (state.currentTab === 'cshp') ? "DATE APPROVED" : "DATE REGISTERED";
        html += `<th style="background: #388e3c;">${headerText}</th>`;
    } else {
        // Previous column header
        if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb' && state.currentTab !== 'permits') {
            html += `<th class="prev-year${isNov ? ' nov-narrow-th' : ''}" style="background: #388e3c;">PREVIOUS</th>`;
        }

        // Main columns
        if (state.currentTab === 'emb') {
            html += `<th style="background: #388e3c;">Q1 (JAN-MAR)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Apr 15</small></th>`;
            html += `<th style="background: #388e3c;">Q2 (APR-JUN)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Jul 15</small></th>`;
            html += `<th style="background: #388e3c;">Q3 (JUL-SEP)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Oct 15</small></th>`;
            html += `<th style="background: #388e3c;">Q4 (OCT-DEC)<br><small style="font-weight: 400; font-size: 0.65rem;">SMR Due: Jan 15</small></th>`;
        } else if (state.currentTab === 'permits') {
            html += `<th style="background: #388e3c; min-width: 200px; white-space: normal; padding: 10px 12px;">PERMIT NO. / ACCREDITATION NO.</th>`;
            html += `<th style="background: #388e3c; min-width: 140px; white-space: nowrap;">DATE ISSUED</th>`;
            html += `<th style="background: #388e3c; min-width: 140px; white-space: nowrap;">EXPIRY DATE</th>`;
        } else {
            const isDole = state.currentTab === 'dole';
            MONTHS.forEach(m => html += `<th${isNov ? ' class="nov-narrow-th"' : (isDole ? ' class="dole-narrow-th"' : '')} style="background: #388e3c;">${m}</th>`);
        }

        if (hasYTD) {
            html += `<th class="ytd-header" style="background: #f9a825;">RUNNING YTD</th>`;
        }
    }

    html += `</tr>`;

    // Safety check: Ensure SCHEMA exists for this tab
    if (!SCHEMA[state.currentTab]) {
        console.warn(`‚ö†Ô∏è No SCHEMA defined for tab: ${state.currentTab}`);
        html += `</table></div>`;
        return html;
    }

    SCHEMA[state.currentTab].forEach((row, rowIdx) => {
        const key = `${state.currentTab}_${row}`;
        
        html += `<tr><td style="width:${typeColumnWidth}; min-width:${typeColumnWidth}; max-width:${typeColumnWidth}; text-align:left; font-weight:700; background:#e8f5e9; color:#1b5e20; position: sticky; left: 0; z-index: 5; white-space: normal; padding: 10px 12px; line-height: 1.3; vertical-align: middle;">${row}</td>`;

        if (isCshp) {
            const v = p.vals[key] ? p.vals[key][1] : "";
            html += `<td><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>`;
        } else {
            // Previous Year Column
            const prevVal = p.vals[key] ? p.vals[key][0] : "";
            
            if (state.currentTab !== 'kpm' && state.currentTab !== 'dole' && state.currentTab !== 'emb' && state.currentTab !== 'permits') {
                html += `<td class="prev-year${isNov ? ' nov-narrow-td' : ''}">
                    <input type="${isDateType ? 'date' : 'number'}"
                        value="${prevVal}"
                        ${inputsEditable ? '' : 'disabled'}
                        oninput="updateVal('${p.name}','${key}',0,this.value)">
                </td>`;
            }
            
            // Main data columns
            if (state.currentTab === 'permits') {
                // Environmental Permits - 3 columns per permit type
                const permitNo = p.vals[key] ? p.vals[key][1] : "";
                const dateIssued = p.vals[key] ? p.vals[key][2] : "";
                const expiryDate = p.vals[key] ? p.vals[key][3] : "";
                html += `<td style="min-width: 200px; padding: 8px 12px;"><input type="text" placeholder="Permit/Accreditation #" value="${permitNo}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 100%;"></td>`;
                html += `<td style="min-width: 140px; padding: 8px 12px;"><input type="date" value="${dateIssued}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 100%;"></td>`;
                html += `<td style="min-width: 140px; padding: 8px 12px;"><input type="date" value="${expiryDate}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',3,this.value)" style="width: 100%;"></td>`;
            } else if (state.currentTab === 'emb') {
                // EMB Reportorial - Simple approach
                if (row === "SMR (Quarterly) - Submission Date") {
                    // SMR: Q1, Q2, Q3, Q4
                    for (let i = 1; i <= 4; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="monthly-data"><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                } else if (row === "SMR (Quarterly) - Reference No.") {
                    // SMR: Q1, Q2, Q3, Q4
                    for (let i = 1; i <= 4; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="monthly-data"><input type="text" placeholder="Ref #" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                } else if (row === "CMR (Semi-Annual) - Submission Date") {
                    // CMR: 2 semi-annual periods with clear labels
                    // Period 1: Jan-June (Q1-Q2 merged) - Due July 15
                    const v1 = p.vals[key] ? p.vals[key][1] : "";
                    html += `<td colspan="2" style="text-align: center; border-right: 2px solid #ddd;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jan-Jun (Due: Jul 15)</div>
                        <input type="date" value="${v1}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 180px;">
                    </td>`;
                    // Period 2: Jul-Dec (Q3-Q4 merged) - Due January 15
                    const v2 = p.vals[key] ? p.vals[key][2] : "";
                    html += `<td colspan="2" style="text-align: center;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jul-Dec (Due: Jan 15)</div>
                        <input type="date" value="${v2}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 180px;">
                    </td>`;
                } else if (row === "CMR (Semi-Annual) - Reference No.") {
                    // CMR: 2 semi-annual periods with clear labels
                    // Period 1: Jan-June (Q1-Q2 merged)
                    const v1 = p.vals[key] ? p.vals[key][1] : "";
                    html += `<td colspan="2" style="text-align: center; border-right: 2px solid #ddd;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jan-Jun</div>
                        <input type="text" placeholder="Ref #" value="${v1}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 180px;">
                    </td>`;
                    // Period 2: Jul-Dec (Q3-Q4 merged)
                    const v2 = p.vals[key] ? p.vals[key][2] : "";
                    html += `<td colspan="2" style="text-align: center;">
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 4px; font-weight: 600;">Jul-Dec</div>
                        <input type="text" placeholder="Ref #" value="${v2}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 180px;">
                    </td>`;
                }
            } else {
                // Monthly Columns for other tabs
                const isDole = state.currentTab === 'dole';
                
                // Check if this is AEDR or AMR (annual reports) - use colspan=12
                if (isDole && (row === 'AEDR' || row === 'AMR')) {
                    const v = p.vals[key] ? p.vals[key][1] : "";
                    html += `<td colspan="12" style="text-align: center;"><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 180px;"></td>`;
                } else {
                    // Normal monthly columns - REMOVED RED "NO REPORT", just normal input
                    for (let i = 1; i <= 12; i++) {
                        const v = p.vals[key] ? p.vals[key][i] : "";
                        html += `<td class="${isNov ? 'nov-narrow-td' : (isDole ? 'dole-narrow-td' : 'monthly-data')}"><input type="${isDateType ? 'date' : 'number'}" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                    }
                }
            }
            
            // Add Running YTD column
            if (hasYTD) {
                let ytdValue = 0;
                if (row === "Total Manpower") {
                    ytdValue = calculateAverage(p.vals[key], rowIdx);
                    html += `<td class="average-cell">${ytdValue}</td>`;
                } else {
                    ytdValue = calculateYTD(p.vals[key], rowIdx);
                    html += `<td class="ytd-cell">${ytdValue}</td>`;
                }
            }
        }
        html += `</tr>`;
    });
    html += `</table></div>`;
    
    // ANNUAL REPORTS SECTION - Now integrated in main table above
    if (false && state.currentTab === 'dole' && SCHEMA.dole_annual) {
        html += `<div style="margin-top: 30px;">`;
        html += `<div style="background: var(--header-grad); color: white; padding: 10px 15px; border-radius: 6px; font-weight: 700; margin-bottom: 10px;">
                    üìÖ ANNUAL REPORTS (Submitted Every January)
                 </div>`;
        html += `<div class="table-container"><table>`;
        html += `<tr><th style="width:120px; text-align:left; position: sticky; left: 0; z-index: 10; background: #2e7d32;">TYPE</th><th class="dole-narrow-th">DATE SUBMITTED</th></tr>`;
        
        SCHEMA.dole_annual.forEach((row, rowIdx) => {
            const key = `dole_annual_${row}`;
            const v = p.vals[key] ? p.vals[key][1] : "";
            html += `<tr>
                <td style="text-align:left; font-weight:600; background:var(--border-color); position: sticky; left: 0; z-index: 5;">${row}</td>
                <td class="dole-narrow-td"><input type="date" value="${v}" ${inputsEditable ? '' : 'disabled'} oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
            </tr>`;
        });
        
        html += `</table></div></div>`;
    }
}

        });
html += '</div>'; // Close region-content
            });
            } // End skip for DOE tabs

            // ‚îÄ‚îÄ PER-REGION GROUPED TABLES: kpm, cshp, reg, audit ‚îÄ‚îÄ
            if (['kpm','cshp','reg','audit'].includes(state.currentTab)) {
                html = ''; // Rebuild cleanly ‚Äî no per-project rows needed

                const isCshpReg = (state.currentTab === 'cshp' || state.currentTab === 'reg');
                const isAudit   = (state.currentTab === 'audit');

                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;

                    const regSum  = projs.reduce((sum, p) => sum + getPerc(p), 0);
                    const regAvg  = Math.round(regSum / projs.length);
                    const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg);
                    const isCollapsed = isRegionCollapsed(reg);

                    html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" onclick="toggleRegion('${reg}', event)">
                        <div>
                            <i class="fas fa-location-dot"></i> ${reg}
                            ${!canEditRegion ? `<i class="fas fa-lock" style="color: #f57c00; margin-left: 8px;" title="üîí View Only - This region is locked for you"></i>` : ''}
                            <span class="badge">${projs.length} PROJ</span>
                            <span class="badge" style="background:#1b5e20;color:var(--safety-yellow);">AVG: ${regAvg}%</span>
                            <i class="fas fa-chevron-down region-toggle-icon"></i>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            ${state.isEditing && canEditRegion ? `<button onclick="event.stopPropagation(); openAddProjectModal('${reg}')" class="btn btn-primary">+ ADD PROJECT</button>` : ''}
                            ${state.isEditing && !canEditRegion ? `<button disabled style="opacity: 0.5; cursor: not-allowed; background: #999;" class="btn btn-primary" title="You can only add projects to your assigned region">LOCKED</button>` : ''}
                        </div>
                    </div>`;
                    
                    html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;

                    // ‚îÄ‚îÄ CSHP / REG ‚îÄ‚îÄ
                    if (isCshpReg) {
                        const headerText = (state.currentTab === 'cshp') ? 'DATE APPROVED' : 'DATE REGISTERED';
                        const schemaRow  = SCHEMA[state.currentTab][0];
                        const key        = `${state.currentTab}_${schemaRow}`;

                        html += `<div class="table-container"><table>
                            <tr>
                                <th style="width:250px;text-align:left; position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>
                                <th style="width:150px;">${headerText}</th>
                                <th style="width:350px;">PDF DOCUMENT</th>
                            </tr>`;

                        projs.forEach(p => {
                            const v = p.vals[key] ? p.vals[key][1] : "";
                            const pdfKey = `${key}_pdf`;
                            const pdfData = p.vals[pdfKey] ? p.vals[pdfKey][1] : null;
                            
                            let pdfCell = '';
                            if (pdfData) {
                                // PDF exists - show view, replace, and delete buttons
                                pdfCell = `
                                    <div class="pdf-upload-container">
                                        <a href="${pdfData.url}" target="_blank" class="pdf-view-btn" title="View PDF">
                                            <i class="fas fa-file-pdf"></i> View
                                        </a>
                                        <span class="pdf-filename" title="${pdfData.name}">${pdfData.name}</span>
                                        ${state.isEditing && canEditRegion ? `
                                            <input type="file" id="pdf_${p.name}_${state.currentTab}" accept=".pdf" 
                                                style="display:none;" onchange="uploadPDF(this, '${p.name}','${pdfKey}', true)">
                                            <button class="pdf-replace-btn" onclick="document.getElementById('pdf_${p.name}_${state.currentTab}').click()" title="Replace PDF">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button class="pdf-delete-btn" onclick="deletePDF('${p.name}','${pdfKey}')" title="Delete PDF">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>`;
                            } else {
                                // No PDF - show upload button
                                pdfCell = (state.isEditing && canEditRegion) ? `
                                    <div class="pdf-upload-container">
                                        <input type="file" id="pdf_${p.name}_${state.currentTab}" accept=".pdf" 
                                            style="display:none;" onchange="uploadPDF(this, '${p.name}','${pdfKey}', false)">
                                        <button class="pdf-upload-btn" onclick="document.getElementById('pdf_${p.name}_${state.currentTab}').click()">
                                            <i class="fas fa-upload"></i> Upload PDF
                                        </button>
                                    </div>` : '<span style="color: #999; font-style: italic;">No document</span>';
                            }
                            
                            html += `<tr>
                                <td style="text-align:left;font-weight:600;background:var(--border-color); position: sticky; left: 0; z-index: 5;">
                                    ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                    ${p.name}
                                </td>
                                <td><input type="date" value="${v}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',1,this.value)"></td>
                                <td>${pdfCell}</td>
                            </tr>`;
                        });

                        html += `</table></div>`;

                    // ‚îÄ‚îÄ AUDIT ‚îÄ‚îÄ
                    } else if (isAudit) {
                        html += `<div class="table-container">
                            <table class="audit-table">
                                <thead>
                                    <tr>
                                        <th rowspan="3" style="text-align:left; min-width:200px; padding-left: 12px; border-right: 2px solid rgba(255,255,255,0.3); position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q1 (JAN-MAR)</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q2 (APR-JUN)</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q3 (JUL-SEP)</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Q4 (OCT-DEC)</th>
                                        <th rowspan="3" class="cell-grand-total" style="border-left: 3px solid #fbc02d; vertical-align: middle; line-height: 1.3;">GRAND<br>TOTAL<br>AVERAGE</th>
                                    </tr>
                                    <tr>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                        <th colspan="3" style="border-right: 2px solid rgba(255,255,255,0.3);">Quarterly Score</th>
                                    </tr>
                                    <tr>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Implementation</th>
                                        <th style="background:white; color:#1b5e20; font-size:10px; font-weight:600;">Documentation & Compliance</th>
                                        <th style="background:#808080; color:white; font-size:10px; font-weight:700; border-right: 2px solid rgba(255,255,255,0.3);">Average</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        projs.forEach(p => {
                            let totalYearAvg = 0;
                            html += `<tr><td style="text-align:left; font-weight:700; background:#f8f9fa; padding:10px 12px; color:#1b5e20; border-right: 2px solid #e0e0e0; position: sticky; left: 0; z-index: 5;">
                                ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                ${p.name}
                            </td>`;
                            ['Q1','Q2','Q3','Q4'].forEach(q => {
                                const audit = p.auditData?.[q] || { scoreImpl: 0, docuComp: 0 };
                                const qAvg  = (audit.scoreImpl + audit.docuComp) / 2;
                                totalYearAvg += qAvg;
                                html += `
                                    <td class="cell-white"><input type="number" min="0" max="100" value="${audit.scoreImpl}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                        oninput="updateAuditData('${p.name}','${q}','scoreImpl',this.value)" placeholder="0"></td>
                                    <td class="cell-white"><input type="number" min="0" max="100" value="${audit.docuComp}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                        oninput="updateAuditData('${p.name}','${q}','docuComp',this.value)" placeholder="0"></td>
                                    <td class="cell-avg-gray" style="border-right: 2px solid #e0e0e0;">${qAvg.toFixed(2)}</td>`;
                            });
                            html += `<td class="cell-grand-total">${(totalYearAvg/4).toFixed(2)}</td></tr>`;
                        });

                        html += `</tbody></table></div>`;

                    // ‚îÄ‚îÄ KPM (Monthly Report) ‚îÄ‚îÄ
                    } else {
                        html += `<div class="table-container"><table>
                            <tr><th style="width:220px;text-align:left; position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>`;
                        MONTHS.forEach(m => html += `<th style="width:100px;min-width:100px;max-width:100px;">${m}</th>`);
                        html += `</tr>`;

                        projs.forEach(p => {
                            SCHEMA['kpm'].forEach(row => {
                                const key = `kpm_${row}`;
                                html += `<tr>
                                    <td style="text-align:left;font-weight:600;background:var(--border-color); position: sticky; left: 0; z-index: 5;">
                                        ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                        ${p.name}
                                    </td>`;
                                for (let i = 1; i <= 12; i++) {
                                    const v = p.vals[key] ? p.vals[key][i] : "";
                                    // Removed red NO REPORT - just normal input
                                    html += `<td class="monthly-data"><input type="date" value="${v}"
                                        ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                        oninput="updateVal('${p.name}','${key}',${i},this.value)"></td>`;
                                }
                                html += `</tr>`;
                            });
                        });

                        html += `</table></div>`;
                    }
                    html += `</div>`; // Close region-content
                });
            }

            // ==================== DOE REPORTORIAL TAB ====================
            if (state.currentTab === 'doe') {
                html = ''; // Start fresh
                
                // Filter only renewable energy projects
                const renewableProjects = displayProjects.filter(p => p.isRenewable === true);
                
                if (renewableProjects.length === 0) {
                    html += `
                        <div style="background: var(--bg-card); padding: 40px; margin: 20px; border-radius: 12px; text-align: center; border: 2px dashed var(--border-color);">
                            <i class="fas fa-solar-panel" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">No Renewable Energy Projects</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                DOE Reportorial only applies to Renewable Energy projects.<br>
                                Mark projects as "Renewable Energy" when adding/editing them to see them here.
                            </p>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #43a047 100%); color: white; padding: 20px; margin: 20px 20px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-solar-panel" style="font-size: 1.8rem; color: #fbc02d;"></i>
                                <div>
                                    <h2 style="margin: 0; font-size: 1.3rem; font-weight: 800;">DOE REPORTORIAL - RENEWABLE ENERGY PROJECTS</h2>
                                    <p style="margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9;">
                                        Quarterly submission (Due: 20th of the following month after each quarter)
                                    </p>
                                    <p style="margin: 5px 0 0; font-size: 0.75rem; opacity: 0.8;">
                                        <i class="fas fa-leaf"></i> Showing ${renewableProjects.length} Renewable Energy project(s)
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Group by region
                    const key = 'doe_DOE Quarterly Report Submission Date';
                    
                    REGIONS.forEach(reg => {
                        const regProjects = renewableProjects.filter(p => p.region === reg);
                        if (regProjects.length === 0) return;
                        
                        const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg);
                        const isCollapsed = isRegionCollapsed(reg);
                        
                        // Region banner with lock icon
                        html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" style="margin-top: 20px;" onclick="toggleRegion('${reg}', event)">
                            <div>
                                <i class="fas fa-location-dot"></i> ${reg}
                                ${!canEditRegion ? `<i class="fas fa-lock" style="color: #f57c00; margin-left: 8px;" title="üîí View Only - This region is locked for you"></i>` : ''}
                                <span class="badge">${regProjects.length} PROJ</span>
                                <i class="fas fa-chevron-down region-toggle-icon"></i>
                            </div>
                        </div>`;
                        
                        html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                        
                        html += `
                        <div class="table-container">
                            <table>
                                <tr>
                                    <th style="width: 280px; text-align: left;">PROJECT NAME</th>
                                    <th>Q1 (JAN-MAR)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Apr 20</small></th>
                                    <th>Q2 (APR-JUN)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Jul 20</small></th>
                                    <th>Q3 (JUL-SEP)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Oct 20</small></th>
                                    <th>Q4 (OCT-DEC)<br><small style="font-weight: 400; font-size: 0.65rem;">Due: Jan 20</small></th>
                                </tr>
                        `;
                        
                        regProjects.forEach(p => {
                            html += `<tr>
                                <td style="text-align: left; font-weight: 700; background: #e8f5e9; color: #1b5e20; position: sticky; left: 0; z-index: 5;">
                                    <i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;"></i>
                                    ${p.name}
                                </td>`;
                            
                            for (let q = 1; q <= 4; q++) {
                                const val = p.vals[key] ? p.vals[key][q] : '';
                                const hasPdf = p.doePdfFiles && p.doePdfFiles[`Q${q}`];
                                
                                html += `<td>
                                    <input type="date" 
                                           value="${val}" 
                                           ${(state.isEditing && canEditRegion) ? '' : 'disabled'} 
                                           oninput="updateVal('${p.name}','${key}',${q},this.value)"
                                           style="width: 140px;">
                                    
                                    ${(state.isEditing && canEditRegion) ? `
                                        <div class="pdf-upload-container">
                                            ${hasPdf ? `
                                                <span class="pdf-file-info">
                                                    <i class="fas fa-file-pdf" style="color: #d32f2f;"></i>
                                                    <span style="font-size: 0.65rem; color: var(--text-secondary);">
                                                        ${p.doePdfFiles[`Q${q}`].fileName.substring(0, 12)}...
                                                    </span>
                                                    <button class="pdf-view-btn" 
                                                            onclick="viewDoePdf('${p.name}', ${q})" 
                                                            title="View PDF">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="pdf-delete-btn" 
                                                            onclick="deleteDoePdf('${p.name}', ${q})" 
                                                            title="Delete PDF">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </span>
                                            ` : `
                                                <button class="pdf-upload-btn" 
                                                        onclick="uploadDoePdf('${p.name}', ${q})" 
                                                        title="Upload Certificate PDF">
                                                    <i class="fas fa-upload"></i> Upload
                                                </button>
                                            `}
                                        </div>
                                    ` : hasPdf ? `
                                        <button class="pdf-view-btn" 
                                                onclick="viewDoePdf('${p.name}', ${q})" 
                                                title="View PDF"
                                                style="margin-left: 10px;">
                                            <i class="fas fa-file-pdf"></i> View
                                        </button>
                                    ` : ''}
                                </td>`;
                            }
                            
                            html += `</tr>`;
                        });
                        
                        html += `
                            </table>
                        </div>
                        `;
                        html += `</div>`; // Close region-content
                    });
                }
            }
            // ==================== END DOE REPORTORIAL ====================

            // ==================== DOE SAFETY OFFICER PERMIT TAB ====================
            if (state.currentTab === 'doe-permit') {
                html = ''; // Start fresh
                
                // Filter only renewable energy projects
                const renewableProjects = displayProjects.filter(p => p.isRenewable === true);
                
                if (renewableProjects.length === 0) {
                    html += `
                        <div style="background: var(--bg-card); padding: 40px; margin: 20px; border-radius: 12px; text-align: center; border: 2px dashed var(--border-color);">
                            <i class="fas fa-id-card" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">No Renewable Energy Projects</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                DOE Safety Officer Permit only applies to Renewable Energy projects.<br>
                                Mark projects as "Renewable Energy" when adding/editing them to see them here.
                            </p>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #43a047 100%); color: white; padding: 20px; margin: 20px 20px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-id-card" style="font-size: 1.8rem; color: #fbc02d;"></i>
                                <div>
                                    <h2 style="margin: 0; font-size: 1.3rem; font-weight: 800;">DOE SAFETY OFFICER PERMIT</h2>
                                    <p style="margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9;">
                                        Department Circular No. DC2012-11-0009 (RE Safety, Health and Environment Rules)
                                    </p>
                                    <p style="margin: 5px 0 0; font-size: 0.75rem; opacity: 0.8;">
                                        <i class="fas fa-leaf"></i> Showing ${renewableProjects.length} Renewable Energy project(s)
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Group by region
                    const key = 'doe-permit_DOE Safety Officer Permit';
                    
                    REGIONS.forEach(reg => {
                        const regProjects = renewableProjects.filter(p => p.region === reg);
                        if (regProjects.length === 0) return;
                        
                        const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg);
                        const isCollapsed = isRegionCollapsed(reg);
                        
                        // Region banner with lock icon
                        html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" style="margin-top: 20px;" onclick="toggleRegion('${reg}', event)">
                            <div>
                                <i class="fas fa-location-dot"></i> ${reg}
                                ${!canEditRegion ? `<i class="fas fa-lock" style="color: #f57c00; margin-left: 8px;" title="üîí View Only - This region is locked for you"></i>` : ''}
                                <span class="badge">${regProjects.length} PROJ</span>
                                <i class="fas fa-chevron-down region-toggle-icon"></i>
                            </div>
                        </div>`;
                        
                        html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                        
                        html += `
                        <div class="table-container">
                            <table>
                                <tr>
                                    <th style="width: 280px; text-align: left;">PROJECT NAME</th>
                                    <th style="width: 200px;">SAFETY OFFICER PERMIT NUMBER</th>
                                    <th style="width: 150px;">VALID UNTIL</th>
                                    <th style="width: 200px;">PDF FILE</th>
                                </tr>
                        `;
                        
                        regProjects.forEach(p => {
                            const permitNumber = p.vals[key] ? p.vals[key][1] : "";
                            const validUntil = p.vals[key] ? p.vals[key][2] : "";
                            const hasPdf = p.vals[key] && p.vals[key][3];
                            
                            let pdfCell = '';
                            if (state.isEditing && canEditRegion) {
                                if (hasPdf) {
                                    pdfCell = `
                                        <span class="pdf-file-info">
                                            <button class="pdf-view-btn" onclick="viewDoePermitPdf('${p.name}')" title="View PDF">
                                                <i class="fas fa-file-pdf"></i> View
                                            </button>
                                            <button class="pdf-delete-btn" onclick="deleteDoePermitPdf('${p.name}')" title="Replace PDF">
                                                <i class="fas fa-sync-alt"></i> Replace
                                            </button>
                                        </span>
                                    `;
                                } else {
                                    pdfCell = `
                                        <button class="pdf-upload-btn" onclick="uploadDoePermitPdf('${p.name}')" title="Upload Permit PDF">
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                    `;
                                }
                            } else {
                                if (hasPdf) {
                                    pdfCell = `
                                        <button class="pdf-view-btn" onclick="viewDoePermitPdf('${p.name}')" title="View PDF">
                                            <i class="fas fa-file-pdf"></i> View
                                        </button>
                                    `;
                                } else {
                                    pdfCell = '<span style="color: var(--text-secondary); font-size: 0.75rem;">No PDF</span>';
                                }
                            }
                            
                            html += `<tr>
                                <td style="text-align: left; font-weight: 700; background: #e8f5e9; color: #1b5e20; position: sticky; left: 0; z-index: 5;">
                                    <i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;"></i>
                                    ${p.name}
                                </td>
                                <td><input type="text" placeholder="e.g., HOEMD-2025-486" value="${permitNumber}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',1,this.value)" style="width: 100%;"></td>
                                <td><input type="date" value="${validUntil}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',2,this.value)" style="width: 100%;"></td>
                                <td style="text-align: center;">${pdfCell}</td>
                            </tr>`;
                        });
                        
                        html += `
                            </table>
                        </div>
                        `;
                        html += `</div>`; // Close region-content
                    });
                }
            }
            // ==================== END DOE SAFETY OFFICER PERMIT ====================

            // ESH NOV MONITORING - Render grouped tables per region
            if (state.currentTab === 'nov-monitoring') {
                html = ''; // Clear previous HTML
                
                // Add CSS styles for NOV Monitoring
                html += `<style>
                    .nov-monitoring-table {
                        border-collapse: collapse;
                        width: 100%;
                        margin: 10px 0;
                        font-family: Arial, sans-serif;
                        border: none;
                    }
                    /* Option 4: Dark green header with yellow accent */
                    .nov-monitoring-table th {
                        background-color: #1b5e20;
                        color: #ffffff;
                        font-weight: bold;
                        text-transform: uppercase;
                        font-size: 10px;
                        padding: 8px 4px;
                        border: none;
                        border-bottom: 3px solid var(--safety-yellow);
                        text-align: center;
                    }
                    /* Striped rows */
                    .nov-monitoring-table tbody tr {
                        transition: all 0.2s ease;
                        border-left: 3px solid transparent;
                    }
                    .nov-monitoring-table tbody tr:nth-child(odd) {
                        background: white;
                    }
                    .nov-monitoring-table tbody tr:nth-child(even) {
                        background: #f1f8e9;
                    }
                    /* Hover effect with left border accent */
                    .nov-monitoring-table tbody tr:hover {
                        border-left: 3px solid #4caf50;
                        background: #e8f5e9 !important;
                    }
                    .nov-monitoring-table td {
                        border: none;
                        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                        text-align: center;
                        vertical-align: middle;
                        padding: 4px;
                        font-size: 11px;
                    }
                    .nov-monitoring-table td.project-name {
                        text-align: left;
                        font-weight: 600;
                        min-width: 150px;
                        position: sticky;
                        left: 0;
                        z-index: 5;
                    }
                    .nov-monitoring-table input {
                        text-align: center;
                        width: 40px;
                        border: 0.5px solid #ccc;
                        border-radius: 2px;
                        font-size: 11px;
                        padding: 2px;
                    }
                    .nov-monitoring-table td.month-col {
                        width: 45px;
                        max-width: 45px;
                    }
                    .nov-monitoring-table td.summary-col {
                        width: 50px;
                        max-width: 50px;
                    }
                    .nov-monitoring-table td.total-col {
                        background: #fff9c4 !important;
                        font-weight: 700;
                    }
                    .nov-monitoring-table tr.regional-total {
                        background: #c8e6c9 !important;
                        font-weight: 700;
                    }
                    .nov-monitoring-table tr.overall-total {
                        background: #a5d6a7 !important;
                        font-weight: 700;
                    }
                    /* Dark mode support for NOV monitoring table */
                    body.dark-mode .nov-monitoring-table tbody tr:nth-child(odd) {
                        background: #2d2d2d;
                    }
                    body.dark-mode .nov-monitoring-table tbody tr:nth-child(even) {
                        background: #1f2e1f;
                    }
                    body.dark-mode .nov-monitoring-table tbody tr:hover {
                        background: #1b3d1b !important;
                    }
                    body.dark-mode .nov-monitoring-table td {
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                    }
                    body.dark-mode .nov-monitoring-table td.total-col {
                        background: #4a4a1f !important;
                    }
                    body.dark-mode .nov-monitoring-table tr.regional-total {
                        background: #2e5d2e !important;
                    }
                    body.dark-mode .nov-monitoring-table tr.overall-total {
                        background: #3d6d3d !important;
                    }
                </style>`;
                
                // Initialize overall totals
                let overallTotals = {
                    prev: 0,
                    months: new Array(12).fill(0),
                    open: 0,
                    pending: 0,
                    closed: 0,
                    total: 0
                };
                
                // First pass: Calculate overall totals
                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;
                    
                    projs.forEach(p => {
                        const key = 'nov-monitoring_data';
                        if (!p.vals[key]) p.vals[key] = new Array(17).fill("");
                        
                        overallTotals.prev += parseFloat(p.vals[key][0]) || 0;
                        
                        for (let i = 1; i <= 12; i++) {
                            const val = parseFloat(p.vals[key][i]) || 0;
                            overallTotals.months[i-1] += val;
                            overallTotals.total += val;
                        }
                        
                        overallTotals.open += parseFloat(p.vals[key][13]) || 0;
                        overallTotals.pending += parseFloat(p.vals[key][14]) || 0;
                        overallTotals.closed += parseFloat(p.vals[key][15]) || 0;
                    });
                });
                
                // Calculate overall percentage
                const overallPercentage = overallTotals.total > 0 
                    ? ((overallTotals.closed / overallTotals.total) * 100).toFixed(2) 
                    : '0.00';
                
                // Render Overall Total Table at the TOP - NEW DESIGN
                html += `
                <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); color: white; padding: 20px; margin: 20px 20px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; position: relative; z-index: 2;">
                        <i class="fas fa-globe" style="font-size: 1.8rem; color: #fbc02d;"></i>
                        <div>
                            <h2 style="margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: 0.5px;">OVERALL SUMMARY - ALL REGIONS</h2>
                            <p style="margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9;">ESH NOV Monitoring consolidated data from all projects</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-container" style="margin: 0 20px 20px;">
                    <table class="nov-monitoring-table">
                        <thead>
                            <tr>
                                <th style="min-width: 150px; background: #2e7d32; position: sticky; left: 0; z-index: 10;">TYPE</th>
                                <th class="prev-year" style="background: #388e3c;">PREVIOUS</th>
                                <th style="background: #388e3c;">JAN</th><th style="background: #388e3c;">FEB</th><th style="background: #388e3c;">MAR</th><th style="background: #388e3c;">APR</th>
                                <th style="background: #388e3c;">MAY</th><th style="background: #388e3c;">JUN</th><th style="background: #388e3c;">JUL</th><th style="background: #388e3c;">AUG</th>
                                <th style="background: #388e3c;">SEP</th><th style="background: #388e3c;">OCT</th><th style="background: #388e3c;">NOV</th><th style="background: #388e3c;">DEC</th>
                                <th style="background: #66bb6a;">OPEN</th>
                                <th style="background: #ffa726;">PENDING</th>
                                <th style="background: #42a5f5;">CLOSED</th>
                                <th style="background: #f9a825;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="overall-total">
                                <td style="text-align: left; font-weight: 700; background: #e8f5e9; color: #1b5e20; position: sticky; left: 0; z-index: 5;">OVERALL TOTAL</td>
                                <td style="background: #c8e6c9; font-weight: 700;">${overallTotals.prev}</td>`;
                
                for (let i = 0; i < 12; i++) {
                    html += `<td style="background: #f1f8e9; font-weight: 600;">${overallTotals.months[i]}</td>`;
                }
                
                html += `<td style="background: #a5d6a7; font-weight: 700;">${overallTotals.open}</td>
                    <td style="background: #ffcc80; font-weight: 700;">${overallTotals.pending}</td>
                    <td style="background: #90caf9; font-weight: 700;">${overallTotals.closed}</td>
                    <td style="background: #fff59d; font-weight: 800; font-size: 1rem;">${overallTotals.total}</td>
                </tr>
                <tr style="background: #c8e6c9;">
                    <td colspan="17" style="text-align: center; font-size: 1.1rem; padding: 15px; font-weight: 700; color: #1b5e20;">
                        <i class="fas fa-chart-line"></i> OVERALL COMPLETION RATE: <span style="font-size: 1.3rem; color: #2e7d32;">${overallPercentage}%</span>
                    </td>
                </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin: 0 20px 30px; padding: 15px; background: #fff3e0; border-left: 5px solid #ff9800; border-radius: 6px;">
                    <p style="margin: 0; font-size: 0.85rem; color: #e65100; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> This summary aggregates ESH NOV data from <strong>${displayProjects.length} project(s)</strong> across all regions. 
                        Individual project details are shown below by region.
                    </p>
                </div>`;
                
                // Now render table for each region
                REGIONS.forEach(reg => {
                    const projs = displayProjects.filter(p => p.region === reg);
                    if (projs.length === 0) return;
                    
                    const canEditRegion = UserAccounts.canEdit(state.currentUser?.email, reg);
                    const isCollapsed = isRegionCollapsed(reg);
                    
                    html += `<div id="region-banner-${reg}" class="region-banner region-${reg.toLowerCase()} ${isCollapsed ? 'collapsed' : ''}" style="margin-top: 30px;" onclick="toggleRegion('${reg}', event)">
                        <div>
                            <i class="fas fa-location-dot"></i> ${reg}
                            ${!canEditRegion ? `<i class="fas fa-lock" style="color: #f57c00; margin-left: 8px;" title="üîí View Only - This region is locked for you"></i>` : ''}
                            <span class="badge">${projs.length} PROJECTS</span>
                            <i class="fas fa-chevron-down region-toggle-icon"></i>
                        </div>
                    </div>`;
                    
                    html += `<div id="region-content-${reg}" class="region-content ${isCollapsed ? 'collapsed' : ''}">`;
                    
                    html += `<div class="table-container">
                        <table class="nov-monitoring-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 150px; position: sticky; left: 0; z-index: 10; background: #2e7d32;">PROJECT NAME</th>
                                    <th class="prev-year">PREVIOUS</th>
                                    <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th>
                                    <th>MAY</th><th>JUN</th><th>JUL</th><th>AUG</th>
                                    <th>SEP</th><th>OCT</th><th>NOV</th><th>DEC</th>
                                    <th style="background: #66bb6a;">OPEN</th>
                                    <th style="background: #ffa726;">PENDING</th>
                                    <th style="background: #42a5f5;">CLOSED</th>
                                    <th style="background: #fbc02d;">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    // Initialize regional totals
                    let regionalTotals = {
                        prev: 0,
                        months: new Array(12).fill(0),
                        open: 0,
                        pending: 0,
                        closed: 0,
                        total: 0
                    };
                    
                    // Render each project in this region
                    projs.forEach(p => {
                        const key = 'nov-monitoring_data';
                        if (!p.vals[key]) p.vals[key] = new Array(17).fill("");
                        
                        html += `<tr>
                            <td class="project-name">
                                ${p.isRenewable ? '<i class="fas fa-leaf" style="color: #4caf50; margin-right: 5px;" title="Renewable Energy Project"></i>' : ''}
                                ${p.name}
                            </td>
                            <td class="prev-year">
                                <input type="number" min="0" value="${p.vals[key][0] || ''}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'} 
                                    oninput="updateVal('${p.name}','${key}',0,this.value)">
                            </td>`;
                        
                        // Add to regional prev totals
                        regionalTotals.prev += parseFloat(p.vals[key][0]) || 0;
                        
                        // Monthly columns (1-12)
                        let rowTotal = 0;
                        for (let i = 1; i <= 12; i++) {
                            const val = parseFloat(p.vals[key][i]) || 0;
                            html += `<td class="month-col">
                                <input type="number" min="0" value="${p.vals[key][i] || ''}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                    oninput="updateVal('${p.name}','${key}',${i},this.value)">
                            </td>`;
                            regionalTotals.months[i-1] += val;
                            rowTotal += val;
                        }
                        
                        // Summary columns
                        const openVal = parseFloat(p.vals[key][13]) || 0;
                        const pendingVal = parseFloat(p.vals[key][14]) || 0;
                        const closedVal = parseFloat(p.vals[key][15]) || 0;
                        
                        html += `<td class="summary-col" style="background: #c8e6c9;">
                            <input type="number" min="0" value="${p.vals[key][13] || ''}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                oninput="updateVal('${p.name}','${key}',13,this.value)">
                        </td>
                        <td class="summary-col" style="background: #ffe0b2;">
                            <input type="number" min="0" value="${p.vals[key][14] || ''}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                oninput="updateVal('${p.name}','${key}',14,this.value)">
                        </td>
                        <td class="summary-col" style="background: #bbdefb;">
                            <input type="number" min="0" value="${p.vals[key][15] || ''}" ${(state.isEditing && canEditRegion) ? '' : 'disabled'}
                                oninput="updateVal('${p.name}','${key}',15,this.value)">
                        </td>
                        <td class="total-col">${rowTotal}</td>
                        </tr>`;
                        
                        regionalTotals.open += openVal;
                        regionalTotals.pending += pendingVal;
                        regionalTotals.closed += closedVal;
                        regionalTotals.total += rowTotal;
                    });
                    
                    // Calculate regional percentage
                    const regionalPercentage = regionalTotals.total > 0 
                        ? ((regionalTotals.closed / regionalTotals.total) * 100).toFixed(2) 
                        : '0.00';
                    
                    // Regional Total Row
                    html += `<tr class="regional-total">
                        <td class="project-name" style="background: #2e7d32; color: white;">REGIONAL TOTAL</td>
                        <td style="background: #a5d6a7;">${regionalTotals.prev}</td>`;
                    
                    for (let i = 0; i < 12; i++) {
                        html += `<td style="background: #c8e6c9;">${regionalTotals.months[i]}</td>`;
                    }
                    
                    html += `<td style="background: #81c784;">${regionalTotals.open}</td>
                        <td style="background: #ffb74d;">${regionalTotals.pending}</td>
                        <td style="background: #64b5f6;">${regionalTotals.closed}</td>
                        <td style="background: #fbc02d;">${regionalTotals.total}</td>
                    </tr>`;
                    
                    // Regional Percentage Row
                    html += `<tr class="regional-total">
                        <td colspan="17" style="text-align: right; padding-right: 10px; background: #e8f5e9;">
                            <strong>${reg} COMPLETION RATE:</strong> ${regionalPercentage}%
                        </td>
                    </tr>`;
                    
                    html += `</tbody></table></div>`;
                    html += `</div>`; // Close region-content
                });
            }

            container.innerHTML = html;
            
            // Initialize trend chart if on rates or medical tab
            if (state.currentTab === 'rates' || state.currentTab === 'medical') {
                setTimeout(() => {
                    populateProjectFilter();
                    updateTrendChart(state.currentTab);
                }, 100);
            }
        }


        
// Close dropdowns when clicking elsewhere
document.addEventListener('click', closeAllStatusDropdowns);
        function toggleProjectSelect(projectName) {
            const project = state.filteredProjects.find(p => p.name === projectName);
            if (project) project.selected = !project.selected;
        }

        // ===== SETTINGS FUNCTIONS =====

        // Toggle password field visibility
        function togglePwd(fieldId, btn) {
            const input = document.getElementById(fieldId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // IMPROVED: Password strength indicator with detailed feedback
        document.addEventListener('input', function(e) {
            if (e.target.id === 'new-password') {
                const pwd = e.target.value;
                const strengthDiv = document.getElementById('pwd-strength');
                
                if (!strengthDiv) return;
                
                if (!pwd) {
                    strengthDiv.innerHTML = '';
                    return;
                }

                let strength = 0;
                let feedback = [];
                
                // Length check (25 points)
                if (pwd.length >= 8) {
                    strength += 25;
                } else {
                    feedback.push('min 8 characters');
                }
                
                // Number check (25 points)
                if (/[0-9]/.test(pwd)) {
                    strength += 25;
                } else {
                    feedback.push('add numbers');
                }
                
                // Special character check (25 points)
                if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd)) {
                    strength += 25;
                } else {
                    feedback.push('add special chars (!@#$)');
                }
                
                // Uppercase/lowercase check (25 points)
                if (/[a-z]/.test(pwd) && /[A-Z]/.test(pwd)) {
                    strength += 25;
                } else {
                    feedback.push('mix upper & lowercase');
                }

                let color, label;
                if (strength < 50) {
                    color = '#e53935'; label = '‚ùå Weak';
                } else if (strength < 75) {
                    color = '#ff9800'; label = '‚ö†Ô∏è Moderate';
                } else if (strength < 100) {
                    color = '#fbc02d'; label = '‚úì Good';
                } else {
                    color = '#2e7d32'; label = '‚úÖ Strong';
                }

                let html = `<span style="color: ${color}; font-weight: 600;">${label}</span>`;
                if (feedback.length > 0) {
                    html += ` <span style="color: #666; font-size: 11px;">‚Äî Need: ${feedback.join(', ')}</span>`;
                }
                
                strengthDiv.innerHTML = html;
            }
        });

        // Toggle username edit form
        function toggleUsernameEdit() {
            const fields = document.getElementById('username-edit-fields');
            const isVisible = fields.style.display !== 'none';
            fields.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                const current = document.getElementById('current-display-name-text').textContent;
                document.getElementById('new-display-name').value = (current === '‚Äî' || current === 'ESH User') ? '' : current;
                document.getElementById('new-display-name').focus();
            }
        }

        // Save display name to Firebase
        async function saveDisplayName() {
            const nameVal = document.getElementById('new-display-name').value.trim();
            const msgEl = document.getElementById('name-msg');
            const btn = document.getElementById('save-name-btn');

            showSettingsMsg('name-msg', '', '');
            if (!nameVal) { showSettingsMsg('name-msg', '‚ö†Ô∏è Please enter a display name', 'error'); return; }
            if (nameVal.length < 2) { showSettingsMsg('name-msg', '‚ö†Ô∏è Name must be at least 2 characters', 'error'); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
            showSettingsMsg('name-msg', 'Updating display name...', 'loading');

            try {
                // Save to Firebase Firestore user profile
                if (firebaseReady && window.firebaseDb && state.currentUser) {
                    const userId = getCurrentUserId();
                    const docRef = window.firebase.doc(window.firebaseDb, 'users', userId);
                    await window.firebase.setDoc(docRef, { displayName: nameVal }, { merge: true });
                }
                // Update state and UI
                state.currentUser.displayName = nameVal;
                localStorage.setItem('esh_displayname_' + state.currentUser.email, nameVal);

                document.getElementById('current-display-name-text').textContent = nameVal;
                document.getElementById('settings-display-name').textContent = nameVal;
                // Update sidebar user badge too
                const badge = document.getElementById('user-badge');
                if (badge) badge.innerHTML = `<i class="fas fa-user-circle"></i> ${nameVal}`;

                document.getElementById('username-edit-fields').style.display = 'none';
                showSettingsMsg('name-msg', '‚úÖ Display name updated successfully!', 'success');
            } catch (err) {
                console.error('‚ùå Name update error:', err);
                showSettingsMsg('name-msg', '‚ùå Failed to update: ' + err.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> SAVE NAME';
        }

        // Update Password via Firebase
        // IMPROVED: Secure password update with re-authentication
        async function updatePasswordSecure() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const btn = document.getElementById('update-pwd-btn');

            showSettingsMsg('settings-message', '', '');

            // Validation checks
            if (!currentPass || !newPass || !confirmPass) {
                showSettingsMsg('settings-message', '‚ö†Ô∏è Please fill all fields', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showSettingsMsg('settings-message', '‚ùå New passwords do not match', 'error');
                return;
            }

            if (newPass.length < 8) {
                showSettingsMsg('settings-message', '‚ùå Password must be at least 8 characters', 'error');
                return;
            }

            // Password strength validation
            const hasNumber = /[0-9]/.test(newPass);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPass);
            
            if (!hasNumber || !hasSpecial) {
                showSettingsMsg('settings-message', '‚ùå Password must contain at least one number and one special character (!@#$%^&*)', 'error');
                return;
            }

            if (currentPass === newPass) {
                showSettingsMsg('settings-message', '‚ö†Ô∏è New password must be different from current password', 'error');
                return;
            }

            // Show custom confirmation dialog
            const confirmChange = await showConfirmModal();

            if (!confirmChange) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING & UPDATING...';
            showSettingsMsg('settings-message', 'üîê Step 1/3: Verifying your identity...', 'loading');

            try {
                // STEP 1: Re-authenticate with current password
                const user = window.firebaseAuth.currentUser;
                const email = user.email;
                
                // Import reauthenticateWithCredential if not already available
                if (!window.firebase.reauthenticateWithCredential) {
                    const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    window.firebase.reauthenticateWithCredential = reauthenticateWithCredential;
                    window.firebase.EmailAuthProvider = EmailAuthProvider;
                }

                const credential = window.firebase.EmailAuthProvider.credential(email, currentPass);
                
                try {
                    await window.firebase.reauthenticateWithCredential(user, credential);
                    console.log('‚úÖ Re-authentication successful');
                } catch (authError) {
                    throw new Error('WRONG_PASSWORD');
                }

                // STEP 2: Update password
                showSettingsMsg('settings-message', 'üîë Step 2/3: Updating password securely...', 'loading');
                await window.firebase.updatePassword(user, newPass);
                console.log('‚úÖ Password updated successfully');

                // STEP 3: Logout for security
                showSettingsMsg('settings-message', '‚úÖ Step 3/3: Password updated! Logging out all sessions...', 'success');
                
                // Clear form
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('pwd-strength').innerHTML = '';

                // Show custom success modal with countdown
                setTimeout(() => {
                    showSuccessModal();
                }, 500);

            } catch (error) {
                console.error('‚ùå Password update error:', error);
                
                if (error.message === 'WRONG_PASSWORD') {
                    showSettingsMsg('settings-message', '‚ùå Current password is incorrect. Please try again.', 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showSettingsMsg('settings-message', '‚ùå For security, please log out and log back in before changing your password.', 'error');
                } else {
                    showSettingsMsg('settings-message', '‚ùå Password update failed: ' + error.message, 'error');
                }
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-key"></i> UPDATE PASSWORD';
            }
        }

        // Legacy function name support (in case called elsewhere)
        async function updatePassword() {
            await updatePasswordSecure();
        }

        // Send password reset email
        async function sendPasswordReset() {
            const email = state.currentUser?.email;
            if (!email) return;
            showSettingsMsg('settings-message', 'Sending reset email...', 'loading');
            const success = await firebaseResetPassword(email);
            if (success) {
                showSettingsMsg('settings-message', '‚úÖ Password reset email sent to ' + email, 'success');
            }
        }

        // Apply theme from settings page
        function applyTheme(mode) {
            if (mode === 'dark') {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
            updateSettingsThemeButtons();
        }

        function updateSettingsThemeButtons() {
            const isDark = document.body.classList.contains('dark-mode');
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');
            if (lightBtn) lightBtn.classList.toggle('active', !isDark);
            if (darkBtn) darkBtn.classList.toggle('active', isDark);
        }

        // Show message helper
        function showSettingsMsg(elId, text, type) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.className = 'settings-msg' + (type ? ' ' + type : '');
            el.innerHTML = type === 'loading'
                ? `<i class="fas fa-spinner fa-spin"></i> ${text}`
                : text;
            if (text && type !== 'loading') {
                setTimeout(() => { el.className = 'settings-msg'; el.innerHTML = ''; }, 4500);
            }
        }

        // Populate settings tab with latest data
        function populateSettingsTab() {
            const user = state.currentUser;
            if (!user) return;

            // Display name: check state, localStorage, then fallback
            const savedName = user.displayName || localStorage.getItem('esh_displayname_' + user.email) || '';
            const displayName = savedName || user.email.split('@')[0];
            document.getElementById('settings-display-name').textContent = displayName;
            document.getElementById('current-display-name-text').textContent = savedName || '‚Äî';
            document.getElementById('settings-hero-email').textContent = user.email;
            document.getElementById('current-email').textContent = user.email;

            // Firebase UID
            const uidEl = document.getElementById('settings-uid');
            if (uidEl) uidEl.textContent = user.uid ? user.uid.substring(0, 20) + '...' : '‚Äî';

            // Firebase status
            const fbStatus = document.getElementById('settings-firebase-status');
            if (fbStatus) {
                if (firebaseReady && window.firebaseDb) {
                    fbStatus.className = 'firebase-status-badge connected';
                    fbStatus.innerHTML = '<i class="fas fa-wifi"></i> Connected';
                } else {
                    fbStatus.className = 'firebase-status-badge disconnected';
                    fbStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Disconnected';
                }
            }

            // Last sync
            const syncEl = document.getElementById('settings-last-sync');
            if (syncEl && state.lastSyncTimestamp) {
                syncEl.textContent = new Date(state.lastSyncTimestamp).toLocaleString('en-PH');
            } else if (syncEl) {
                syncEl.textContent = 'Not yet synced';
            }

            // Total projects
            const projEl = document.getElementById('settings-total-projects');
            if (projEl) projEl.textContent = state.projects.length + ' projects';

            // Theme buttons
            updateSettingsThemeButtons();

            // Backup section
            const backupSection = document.getElementById('backup-recovery-section');
            if (backupSection) backupSection.innerHTML = showBackupRecoveryUI();
            
            // Update copyright year
            const copyrightYear = document.getElementById('copyright-year');
            if (copyrightYear) copyrightYear.textContent = new Date().getFullYear();
            
            // Hide admin-only sections for superintendents
            const isAdmin = UserAccounts.isAdmin(user.email);
            const forceSyncSection = document.getElementById('force-sync-section');
            const yearManagementSection = document.getElementById('year-management-section');
            const auditTrailSection = document.getElementById('audit-trail-section');
            const dangerZoneSection = document.getElementById('danger-zone-section');
            
            if (!isAdmin) {
                // Hide these sections for superintendents
                if (forceSyncSection) forceSyncSection.style.display = 'none';
                if (yearManagementSection) yearManagementSection.style.display = 'none';
                if (auditTrailSection) auditTrailSection.style.display = 'none';
                if (dangerZoneSection) dangerZoneSection.style.display = 'none';
            } else {
                // Show for admins
                if (forceSyncSection) forceSyncSection.style.display = 'block';
                if (yearManagementSection) yearManagementSection.style.display = 'block';
                if (auditTrailSection) auditTrailSection.style.display = 'block';
                if (dangerZoneSection) dangerZoneSection.style.display = 'block';
            }
        }

        setInterval(() => {
            const now = new Date();
            const dateEl = document.getElementById('live-date');
            const clockEl = document.getElementById('live-clock');
            if (dateEl) dateEl.innerText = now.toLocaleDateString('en-PH', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).toUpperCase();
            if (clockEl) clockEl.innerText = now.toLocaleTimeString('en-PH');
        }, 1000);

       window.addEventListener('load', () => {
    initDarkMode();
    backupManager.init();
    // Firebase auth state is handled by setupAuthObserver() in the Firebase integration section below.
    // No session storage check needed ‚Äî Firebase persists login automatically.
});
function showModernDialog(title, message, isDanger = false, confirmText = null, cancelText = 'Cancel') {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'modern-dialog-overlay';

        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = isDanger ? 'modern-dialog error' : 'modern-dialog';

        // Icon
        const iconEl = document.createElement('div');
        iconEl.className = 'modern-dialog-icon';
        iconEl.innerHTML = isDanger ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-check-circle"></i>';

        // Title
        const titleEl = document.createElement('h2');
        titleEl.className = 'modern-dialog-title';
        titleEl.textContent = title;

        // Message
        const messageEl = document.createElement('p');
        messageEl.className = 'modern-dialog-message';
        messageEl.innerHTML = message; // Changed to innerHTML to render HTML tags

        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'modern-dialog-buttons';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modern-dialog-btn modern-dialog-btn-cancel';
        cancelBtn.textContent = cancelText;
        cancelBtn.onclick = () => {
            overlay.remove();
            resolve(false);
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.className = isDanger ? 'modern-dialog-btn modern-dialog-btn-danger' : 'modern-dialog-btn modern-dialog-btn-confirm';
        
        // Set button text based on parameter or default
        if (confirmText) {
            confirmBtn.textContent = confirmText;
        } else {
            confirmBtn.textContent = isDanger ? 'Delete' : 'OK';
        }
        
        confirmBtn.onclick = () => {
            overlay.remove();
            resolve(true);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(iconEl);
        dialog.appendChild(titleEl);
        dialog.appendChild(messageEl);
        dialog.appendChild(buttonsDiv);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // Modal is locked - no overlay click close
        // User must use CANCEL or CONFIRM buttons
        
        confirmBtn.focus();
    });
}

// Custom confirm dialog with customizable button labels and icon
function showCustomConfirm(title, message, confirmText = 'CONFIRM', cancelText = 'CANCEL', iconClass = 'fa-graduation-cap', isInfo = true) {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'modern-dialog-overlay';

        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = isInfo ? 'modern-dialog info' : 'modern-dialog';

        // Icon
        const iconEl = document.createElement('div');
        iconEl.className = 'modern-dialog-icon';
        iconEl.style.background = isInfo ? 'linear-gradient(135deg, #1976d2, #2196f3)' : 'linear-gradient(135deg, #2e7d32, #4caf50)';
        iconEl.innerHTML = `<i class="fas ${iconClass}"></i>`;

        // Title
        const titleEl = document.createElement('h2');
        titleEl.className = 'modern-dialog-title';
        titleEl.textContent = title;

        // Message
        const messageEl = document.createElement('p');
        messageEl.className = 'modern-dialog-message';
        messageEl.innerHTML = message;

        // Buttons
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'modern-dialog-buttons';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modern-dialog-btn modern-dialog-btn-cancel';
        cancelBtn.innerHTML = `<i class="fas fa-times"></i> ${cancelText}`;
        cancelBtn.onclick = () => {
            overlay.remove();
            resolve(false);
        };

        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'modern-dialog-btn modern-dialog-btn-confirm';
        confirmBtn.innerHTML = `<i class="fas fa-check"></i> ${confirmText}`;
        confirmBtn.onclick = () => {
            overlay.remove();
            resolve(true);
        };

        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);

        dialog.appendChild(iconEl);
        dialog.appendChild(titleEl);
        dialog.appendChild(messageEl);
        dialog.appendChild(buttonsDiv);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        confirmBtn.focus();
    });
}

// --- ESH PERSONNEL MONITORING SYSTEM ---

/**
 * Calculate years of service from hire date to current date
 */
function calculateYearsOfService(hireDate) {
    if (!hireDate) return '';
    
    const hired = new Date(hireDate);
    const today = new Date();
    
    // Calculate the difference in years
    let years = today.getFullYear() - hired.getFullYear();
    const monthDiff = today.getMonth() - hired.getMonth();
    
    // Adjust if birthday hasn't occurred this year yet
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < hired.getDate())) {
        years--;
    }
    
    // Return 0 if negative (future date)
    return years < 0 ? 0 : years;
}

function addPRow() {
    if (!state.personnelData) state.personnelData = [];
    state.personnelData.push({ name: '', pos: '', id: '', hired: '', current: '', age: '', gen: '', mail: '', num: '', addr: '', len: '' });
    renderPTable();
    // Auto-open edit mode on the newly added row
    const newIdx = state.personnelData.length - 1;
    setTimeout(() => pRowEdit(newIdx), 50);
    saveUserData(state.currentUser.email);
}

// Add Personnel Modal Functions
function openAddPersonnelModal() {
    // Populate assignment dropdown with projects
    const assignmentSelect = document.getElementById('personnelAssignmentInput');
    let options = '<option value="">Select Assignment</option>';
    options += '<option value="Corporate Office">Corporate Office</option>';
    
    if (state.projects && state.projects.length > 0) {
        // For non-admin users, only show projects from their region
        let projectsList = state.projects;
        if (!state.isAdmin && state.userRegion) {
            projectsList = state.projects.filter(p => p.region === state.userRegion);
        }
        
        projectsList.forEach(p => {
            options += `<option value="${p.name}">${p.name}</option>`;
        });
    }
    
    assignmentSelect.innerHTML = options;
    
    // Clear all inputs
    document.getElementById('personnelLastNameInput').value = '';
    document.getElementById('personnelFirstNameInput').value = '';
    document.getElementById('personnelMiddleNameInput').value = '';
    document.getElementById('personnelNameExtInput').value = '';
    document.getElementById('personnelPositionInput').value = '';
    document.getElementById('personnelIdInput').value = '';
    document.getElementById('personnelHiredInput').value = '';
    document.getElementById('personnelAssignmentInput').value = '';
    document.getElementById('personnelAgeInput').value = '';
    document.getElementById('personnelGenderInput').value = '';
    document.getElementById('personnelEmailInput').value = '';
    document.getElementById('personnelContactInput').value = '';
    document.getElementById('personnelAddressInput').value = '';
    document.getElementById('personnelModalError').textContent = '';
    
    // Show modal
    document.getElementById('addPersonnelModal').classList.add('show');
}

function closeAddPersonnelModal() {
    document.getElementById('addPersonnelModal').classList.remove('show');
}

function confirmAddPersonnel() {
    const lastName = document.getElementById('personnelLastNameInput').value.trim().toUpperCase();
    const firstName = document.getElementById('personnelFirstNameInput').value.trim().toUpperCase();
    const middleName = document.getElementById('personnelMiddleNameInput').value.trim().toUpperCase();
    const nameExt = document.getElementById('personnelNameExtInput').value;
    
    // Build full name: LAST NAME, FIRST NAME MIDDLE NAME EXT
    let fullName = `${lastName}, ${firstName}`;
    if (middleName) {
        fullName += ` ${middleName}`;
    }
    if (nameExt) {
        fullName += ` ${nameExt}`;
    }
    
    const pos = document.getElementById('personnelPositionInput').value;
    const id = document.getElementById('personnelIdInput').value.trim();
    const hired = document.getElementById('personnelHiredInput').value;
    const current = document.getElementById('personnelAssignmentInput').value;
    const age = document.getElementById('personnelAgeInput').value;
    const gen = document.getElementById('personnelGenderInput').value;
    const mail = document.getElementById('personnelEmailInput').value.trim();
    const num = document.getElementById('personnelContactInput').value.trim();
    const addr = document.getElementById('personnelAddressInput').value.trim();
    
    const errorEl = document.getElementById('personnelModalError');
    
    // Validation
    if (!lastName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter last name';
        return;
    }
    if (!firstName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter first name';
        return;
    }
    if (!pos) {
        errorEl.textContent = '‚ö†Ô∏è Please select position';
        return;
    }
    if (!id) {
        errorEl.textContent = '‚ö†Ô∏è Please enter ID number';
        return;
    }
    if (!hired) {
        errorEl.textContent = '‚ö†Ô∏è Please enter date hired';
        return;
    }
    if (!current) {
        errorEl.textContent = '‚ö†Ô∏è Please select current assignment';
        return;
    }
    if (!age || age < 18 || age > 100) {
        errorEl.textContent = '‚ö†Ô∏è Please enter valid age (18-100)';
        return;
    }
    if (!gen) {
        errorEl.textContent = '‚ö†Ô∏è Please select gender';
        return;
    }
    
    // Check for duplicate ID
    if (state.personnelData && state.personnelData.some(p => p.id === id)) {
        errorEl.textContent = '‚ö†Ô∏è ID Number already exists';
        return;
    }
    
    // Calculate years of service
    const len = calculateYearsOfService(hired);
    
    // Add personnel
    if (!state.personnelData) state.personnelData = [];
    state.personnelData.push({
        name: fullName,
        pos: pos,
        id: id,
        hired: hired,
        current: current,
        age: age,
        gen: gen,
        mail: mail,
        num: num,
        addr: addr,
        len: len
    });
    
    // Save and refresh
    saveUserData(state.currentUser.email);
    renderPTable();
    updatePersonnelSummary();
    closeAddPersonnelModal();
    showToast('‚úÖ Personnel added successfully!', 'success');
}

// Edit Personnel Modal Functions
function openEditPersonnelModal(index) {
    const person = state.personnelData[index];
    if (!person) return;
    
    // Check permission for non-admin users
    if (!state.isAdmin && state.userRegion) {
        // Get user's region projects
        const userProjects = state.masterProjects
            .filter(p => p.region === state.userRegion)
            .map(p => p.name);
        
        // Check if person is assigned to user's region or Corporate Office
        if (person.current !== 'Corporate Office' && !userProjects.includes(person.current)) {
            showToast('‚ö†Ô∏è Access Denied - You can only edit personnel from your region', 'error');
            return;
        }
    }
    
    // Populate assignment dropdown with projects
    const assignmentSelect = document.getElementById('editPersonnelAssignmentInput');
    let options = '<option value="">Select Assignment</option>';
    options += '<option value="Corporate Office">Corporate Office</option>';
    
    if (state.projects && state.projects.length > 0) {
        // For non-admin users, only show projects from their region
        let projectsList = state.projects;
        if (!state.isAdmin && state.userRegion) {
            projectsList = state.projects.filter(p => p.region === state.userRegion);
        }
        
        projectsList.forEach(p => {
            options += `<option value="${p.name}">${p.name}</option>`;
        });
    }
    
    assignmentSelect.innerHTML = options;
    
    // Fill form with current data
    document.getElementById('editPersonnelIndex').value = index;
    
    // Parse the full name into components: LAST NAME, FIRST NAME MIDDLE NAME EXT
    const fullName = person.name || '';
    const nameParts = fullName.split(',').map(s => s.trim());
    
    let lastName = '';
    let firstName = '';
    let middleName = '';
    let nameExt = '';
    
    if (nameParts.length >= 1) {
        lastName = nameParts[0];
        
        if (nameParts.length >= 2) {
            const restOfName = nameParts[1].trim().split(' ');
            firstName = restOfName[0] || '';
            
            // Check for name extensions
            const extensions = ['JR.', 'SR.', 'II', 'III', 'IV', 'V'];
            const lastPart = restOfName[restOfName.length - 1];
            
            if (extensions.includes(lastPart.toUpperCase())) {
                nameExt = lastPart.toUpperCase();
                // Middle name is everything between first name and extension
                if (restOfName.length > 2) {
                    middleName = restOfName.slice(1, -1).join(' ');
                }
            } else {
                // No extension, so everything after first name is middle name
                if (restOfName.length > 1) {
                    middleName = restOfName.slice(1).join(' ');
                }
            }
        }
    }
    
    document.getElementById('editPersonnelLastNameInput').value = lastName;
    document.getElementById('editPersonnelFirstNameInput').value = firstName;
    document.getElementById('editPersonnelMiddleNameInput').value = middleName;
    document.getElementById('editPersonnelNameExtInput').value = nameExt;
    document.getElementById('editPersonnelPositionInput').value = person.pos || '';
    document.getElementById('editPersonnelIdInput').value = person.id || '';
    document.getElementById('editPersonnelHiredInput').value = person.hired || '';
    document.getElementById('editPersonnelAssignmentInput').value = person.current || '';
    document.getElementById('editPersonnelAgeInput').value = person.age || '';
    document.getElementById('editPersonnelGenderInput').value = person.gen || '';
    document.getElementById('editPersonnelEmailInput').value = person.mail || '';
    document.getElementById('editPersonnelContactInput').value = person.num || '';
    document.getElementById('editPersonnelAddressInput').value = person.addr || '';
    document.getElementById('editPersonnelModalError').textContent = '';
    
    // Show modal
    document.getElementById('editPersonnelModal').classList.add('show');
}

function closeEditPersonnelModal() {
    document.getElementById('editPersonnelModal').classList.remove('show');
}

function confirmEditPersonnel() {
    const index = parseInt(document.getElementById('editPersonnelIndex').value);
    const lastName = document.getElementById('editPersonnelLastNameInput').value.trim().toUpperCase();
    const firstName = document.getElementById('editPersonnelFirstNameInput').value.trim().toUpperCase();
    const middleName = document.getElementById('editPersonnelMiddleNameInput').value.trim().toUpperCase();
    const nameExt = document.getElementById('editPersonnelNameExtInput').value;
    
    // Build full name: LAST NAME, FIRST NAME MIDDLE NAME EXT
    let fullName = `${lastName}, ${firstName}`;
    if (middleName) {
        fullName += ` ${middleName}`;
    }
    if (nameExt) {
        fullName += ` ${nameExt}`;
    }
    
    const pos = document.getElementById('editPersonnelPositionInput').value;
    const id = document.getElementById('editPersonnelIdInput').value.trim();
    const hired = document.getElementById('editPersonnelHiredInput').value;
    const current = document.getElementById('editPersonnelAssignmentInput').value;
    const age = document.getElementById('editPersonnelAgeInput').value;
    const gen = document.getElementById('editPersonnelGenderInput').value;
    const mail = document.getElementById('editPersonnelEmailInput').value.trim();
    const num = document.getElementById('editPersonnelContactInput').value.trim();
    const addr = document.getElementById('editPersonnelAddressInput').value.trim();
    
    const errorEl = document.getElementById('editPersonnelModalError');
    
    // Validation
    if (!lastName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter last name';
        return;
    }
    if (!firstName) {
        errorEl.textContent = '‚ö†Ô∏è Please enter first name';
        return;
    }
    if (!pos) {
        errorEl.textContent = '‚ö†Ô∏è Please select position';
        return;
    }
    if (!id) {
        errorEl.textContent = '‚ö†Ô∏è Please enter ID number';
        return;
    }
    if (!hired) {
        errorEl.textContent = '‚ö†Ô∏è Please enter date hired';
        return;
    }
    if (!current) {
        errorEl.textContent = '‚ö†Ô∏è Please select current assignment';
        return;
    }
    if (!age || age < 18 || age > 100) {
        errorEl.textContent = '‚ö†Ô∏è Please enter valid age (18-100)';
        return;
    }
    if (!gen) {
        errorEl.textContent = '‚ö†Ô∏è Please select gender';
        return;
    }
    
    // Check for duplicate ID (excluding current record)
    if (state.personnelData && state.personnelData.some((p, idx) => p.id === id && idx !== index)) {
        errorEl.textContent = '‚ö†Ô∏è ID Number already exists';
        return;
    }
    
    // Calculate years of service
    const len = calculateYearsOfService(hired);
    
    // Update personnel
    state.personnelData[index] = {
        name: fullName,
        pos: pos,
        id: id,
        hired: hired,
        current: current,
        age: age,
        gen: gen,
        mail: mail,
        num: num,
        addr: addr,
        len: len
    };
    
    // Save and refresh
    saveUserData(state.currentUser.email);
    renderPTable();
    updatePersonnelSummary();
    closeEditPersonnelModal();
    showToast('‚úÖ Personnel updated successfully!', 'success');
}

function renderPTable() {
    const tbody = document.getElementById('p-body');
    if (!tbody) return;
    
    // Build project options with Corporate Office/Head Office at the top
    let projOptions = '<optgroup label="Corporate/Head Office">';
    projOptions += '<option value="Corporate Office">Corporate Office</option>';
    projOptions += '</optgroup>';
    
    if (state.projects && state.projects.length > 0) {
        projOptions += '<optgroup label="Project Sites">';
        projOptions += (state.projects || []).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        projOptions += '</optgroup>';
    }
    
    let data = state.personnelData || [];
    
    // Regional Filtering: Non-admin users only see personnel from their region's projects
    if (!state.isAdmin && state.userRegion) {
        // Get all project names in user's region
        const userProjects = state.masterProjects
            .filter(p => p.region === state.userRegion)
            .map(p => p.name);
        
        // Filter personnel: show only if assigned to user's region projects or Corporate Office
        data = data.filter(person => {
            return person.current === 'Corporate Office' || userProjects.includes(person.current);
        });
    }

    tbody.innerHTML = data.map((p, i) => {
        const genderClass = p.gen === 'Male' ? 'p-gender-m' : p.gen === 'Female' ? 'p-gender-f' : '';
        const posDisplay  = p.pos && p.pos !== 'Select' ? `<span class="p-pos-badge">${p.pos}</span>` : '';
        const genDisplay  = p.gen && p.gen !== 'Select' ? `<span class="p-pos-badge ${genderClass}">${p.gen}</span>` : '';
        
        // Auto-calculate years of service from hire date
        const yearsOfService = calculateYearsOfService(p.hired);
        // Update the stored value if it's different
        if (p.hired && yearsOfService !== '' && p.len !== yearsOfService.toString()) {
            state.personnelData[i].len = yearsOfService.toString();
        }

        return `
        <tr id="p-row-${i}">
            <td style="min-width:250px; text-align:left; position: sticky; left: 0; z-index: 5; background: var(--bg-card);">
                <span class="p-row-num">${i+1}</span>
                <input type="text" value="${(p.name || '').toUpperCase()}" onchange="state.personnelData[${i}].name=this.value.toUpperCase()" style="min-width:220px; text-align:left; text-transform: uppercase;" disabled>
            </td>
            <td style="width:180px; text-align:left;">
                ${posDisplay}
                <select onchange="state.personnelData[${i}].pos=this.value;renderPTable();" style="width:170px;display:none; text-align:left;" disabled>
                    <option value="${p.pos||''}">${p.pos||'Select'}</option>
                    <optgroup label="Project-Based Positions">
                        <option>ESH Superintendent</option>
                        <option>ESH Head</option>
                        <option>Safety Officer I</option>
                        <option>Safety Officer II</option>
                        <option>Safety Officer III</option>
                        <option>Safety Officer IV</option>
                        <option>PCO</option>
			<option>Project Physician</option>
                        <option>Project Nurse</option>
                        <option>First Aider</option>
                    </optgroup>
                    <optgroup label="Corporate Positions">
                        <option>QESH Group Manager</option>
                        <option>QESH Deputy Manager</option>
                        <option>ESH Manager for Regulation & Compliance</option>
                        <option>ESH Manager for Project Implementation</option>
                        <option>Environmental and Sustainability Head</option>
						<option>Corporate Physician</option>
						<option>Corporate Nurse</option>
                        <option>QESH Corp. DC</option>                            
                    </optgroup>
                    <optgroup label="Other">
                        <option>Others</option>
                    </optgroup>
                </select>
            </td>
            <td style="width:95px; text-align:center;">
                <input type="text" value="${p.id||''}" onchange="state.personnelData[${i}].id=this.value" style="width:80px;text-align:center;" disabled>
            </td>
            <td style="width:110px; text-align:center;">
                <input type="date" value="${p.hired||''}" onchange="state.personnelData[${i}].hired=this.value;renderPTable();" style="width:100px;" disabled>
            </td>
            <td style="min-width:180px;">
                <select onchange="state.personnelData[${i}].current=this.value" style="min-width:170px;" disabled>
                    <option value="${p.current||''}">${p.current||'Select Assignment'}</option>
                    ${projOptions}
                </select>
            </td>
            <td style="width:48px; text-align:center;">
                <input type="number" value="${p.age||''}" onchange="state.personnelData[${i}].age=this.value" style="width:38px;text-align:center;" min="0" max="99" disabled>
            </td>
            <td style="width:80px; text-align:center;">
                ${genDisplay}
                <select onchange="state.personnelData[${i}].gen=this.value;renderPTable();" style="width:70px;display:none;" disabled>
                    <option value="${p.gen||''}">${p.gen||'Select'}</option>
                    <option>Male</option><option>Female</option>
                </select>
            </td>
            <td style="min-width:180px;">
                <input type="email" value="${p.mail||''}" onchange="state.personnelData[${i}].mail=this.value" style="min-width:165px;" disabled>
            </td>
            <td style="width:115px; text-align:center;">
                <input type="text" value="${p.num||''}" onchange="state.personnelData[${i}].num=this.value" style="width:105px;" disabled>
            </td>
            <td style="min-width:200px;">
                <input type="text" value="${p.addr||''}" onchange="state.personnelData[${i}].addr=this.value" style="min-width:185px;" disabled>
            </td>
            <td style="width:70px; text-align:center;">
                <input type="number" value="${yearsOfService !== '' ? yearsOfService : (p.len||'')}" style="width:50px;text-align:center;background:#f0f0f0;color:#666;font-weight:600;" min="0" max="99" disabled readonly title="Auto-calculated from Date Hired">
            </td>
            <td style="width:100px; text-align:center; white-space:nowrap;">
                <button class="p-edit-btn" id="p-edit-btn-${i}" onclick="openEditPersonnelModal(${i})"><i class="fas fa-edit"></i></button>
                <button class="p-del-btn" onclick="pRowDelete(${i})" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');

    // Show/hide empty state
    const emptyEl = document.getElementById('p-empty');
    if (emptyEl) emptyEl.style.display = data.length === 0 ? 'block' : 'none';

    // Update summary badges
    updatePersonnelSummary();
}

function updatePersonnelSummary() {
    const data = state.personnelData || [];
    const badgesEl = document.getElementById('p-summary-badges');
    const footerEl = document.getElementById('p-footer');
    if (!badgesEl) return;

    const total  = data.length;
    const male   = data.filter(p => p.gen === 'Male').length;
    const female = data.filter(p => p.gen === 'Female').length;

    badgesEl.innerHTML = `
        <span style="background:rgba(255,255,255,0.2);color:white;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            <i class="fas fa-users"></i> ${total} Total
        </span>
        <span style="background:rgba(33,150,243,0.3);color:#bbdefb;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            ‚ôÇ ${male} Male
        </span>
        <span style="background:rgba(233,30,99,0.3);color:#f8bbd0;padding:4px 12px;border-radius:20px;font-size:0.68rem;font-weight:700;">
            ‚ôÄ ${female} Female
        </span>`;

    if (footerEl) {
        const positions = {};
        data.forEach(p => { if (p.pos && p.pos !== 'Select') positions[p.pos] = (positions[p.pos]||0)+1; });
        const posStr = Object.entries(positions).map(([k,v]) => `${k}: ${v}`).join(' &nbsp;|&nbsp; ');
        footerEl.innerHTML = posStr
            ? `<i class="fas fa-id-badge" style="color:#2e7d32;"></i> &nbsp; ${posStr}`
            : '';
    }
}

function pRowEdit(i) {
    const row = document.getElementById('p-row-' + i);
    if (!row) return;
    row.querySelectorAll('input').forEach(el => el.disabled = false);
    row.querySelectorAll('select').forEach(el => { el.disabled = false; el.style.display = ''; });
    row.querySelectorAll('.p-pos-badge').forEach(el => el.style.display = 'none');
    row.classList.add('p-editing');
    const editBtn = document.getElementById('p-edit-btn-' + i);
    const saveBtn = document.getElementById('p-save-btn-' + i);
    if (editBtn) editBtn.style.display = 'none';
    if (saveBtn) { saveBtn.style.display = 'inline-flex'; }
}

function pRowSave(i) {
    const row = document.getElementById('p-row-' + i);
    if (!row) return;
    
    // Recalculate years of service before saving
    if (state.personnelData[i] && state.personnelData[i].hired) {
        const yearsOfService = calculateYearsOfService(state.personnelData[i].hired);
        if (yearsOfService !== '') {
            state.personnelData[i].len = yearsOfService.toString();
        }
    }
    
    row.querySelectorAll('input').forEach(el => el.disabled = true);
    row.querySelectorAll('select').forEach(el => { el.disabled = true; el.style.display = 'none'; });
    row.querySelectorAll('.p-pos-badge').forEach(el => el.style.display = '');
    row.classList.remove('p-editing');
    const editBtn = document.getElementById('p-edit-btn-' + i);
    const saveBtn = document.getElementById('p-save-btn-' + i);
    if (editBtn) editBtn.style.display = 'inline-flex';
    if (saveBtn) saveBtn.style.display = 'none';
    saveUserData(state.currentUser.email);
    renderPTable(); // refresh badges and recalculate years
}

function pRowDelete(i) {
    const person = state.personnelData[i];
    if (!person) return;
    
    // Check permission for non-admin users
    if (!state.isAdmin && state.userRegion) {
        // Get user's region projects
        const userProjects = state.masterProjects
            .filter(p => p.region === state.userRegion)
            .map(p => p.name);
        
        // Check if person is assigned to user's region or Corporate Office
        if (person.current !== 'Corporate Office' && !userProjects.includes(person.current)) {
            showToast('‚ö†Ô∏è Access Denied - You can only delete personnel from your region', 'error');
            return;
        }
    }
    
    state.personnelData.splice(i, 1);
    renderPTable();
    saveUserData(state.currentUser.email);
    showToast('‚úÖ Personnel deleted successfully', 'success');
}

function filterPTable() {
    const column = document.getElementById('p-filter-column').value;
    const filterValue = document.getElementById('p-filter-value').value.toLowerCase();
    const tbody = document.getElementById('p-body');
    
    if (!tbody || !state.personnelData) return;
    
    // If no filter value, show all rows
    if (!filterValue) {
        tbody.querySelectorAll('tr').forEach(row => row.style.display = '');
        return;
    }
    
    // Filter based on selected column
    const rows = tbody.querySelectorAll('tr');
    state.personnelData.forEach((person, i) => {
        let shouldShow = false;
        
        if (column === 'all') {
            // Search all columns
            shouldShow = 
                (person.name || '').toLowerCase().includes(filterValue) ||
                (person.pos || '').toLowerCase().includes(filterValue) ||
                (person.id || '').toLowerCase().includes(filterValue) ||
                (person.current || '').toLowerCase().includes(filterValue) ||
                (person.gen || '').toLowerCase().includes(filterValue) ||
                (person.mail || '').toLowerCase().includes(filterValue) ||
                (person.num || '').toLowerCase().includes(filterValue) ||
                (person.addr || '').toLowerCase().includes(filterValue);
        } else {
            // Search specific column
            const fieldValue = (person[column] || '').toLowerCase();
            shouldShow = fieldValue.includes(filterValue);
        }
        
        if (rows[i]) {
            rows[i].style.display = shouldShow ? '' : 'none';
        }
    });
}

// --- INCIDENT TABULATION RATE SYSTEM (merged into Statistics Rate tab) ---

/**
 * Computes aggregate tabulation stats from all projects' rates + exposures data.
 */
function computeAggregateTabulation() {
    // Aggregate across ALL projects and ALL 12 months
    let totalManHours   = 0;   // from exposures_Total Exposed Manhour
    let ltaCases        = 0;   // from medical_LTA  (Lost Time Accidents)
    let medTreatment    = 0;   // from medical_Medical Treatment
    let firstAid        = 0;   // from medical_First Aid
    let fatality        = 0;   // from medical_Fatality
    let highPotential   = 0;   // from medical_High-Potential incident
    let lostDaysTotal   = 0;   // from exposures_No. of Days w/o LTA (inverse: total days - days without LTA)
    // Also try to get lost days from a dedicated field if present
    // We'll approximate: No. of Days w/o LTA is NOT the same as lost days.
    // For lost days we use the SEVERITY RATE √ó TotalHours / 1,000,000 approach as fallback.
    let totalSeveritySum = 0;  // sum of Severity Rate values per month (fallback for lost days)

    state.projects.forEach(p => {
        for (let i = 1; i <= 12; i++) {
            totalManHours   += parseFloat(p.vals['exposures_Total Exposed Manhour']?.[i]) || 0;
            ltaCases        += parseFloat(p.vals['medical_LTA']?.[i])                     || 0;
            medTreatment    += parseFloat(p.vals['medical_Medical Treatment']?.[i])       || 0;
            firstAid        += parseFloat(p.vals['medical_First Aid']?.[i])               || 0;
            fatality        += parseFloat(p.vals['medical_Fatality']?.[i])                || 0;
            highPotential   += parseFloat(p.vals['medical_High-Potential incident']?.[i]) || 0;
            totalSeveritySum+= parseFloat(p.vals['rates_SEVERITY RATE']?.[i])             || 0;
        }
    });

    // Recordable Cases = LTA + Medical Treatment + Fatality + High-Potential
    // (First Aid is typically NOT recordable under OSHS, but included if needed)
    const recordableCases = ltaCases + medTreatment + fatality + highPotential;

    // Lost Days: back-calculate from Severity Rate if no direct field
    // SR (OSHS) = LostDays √ó 1,000,000 / ManHours  ‚Üí  LostDays = SR √ó ManHours / 1,000,000
    // We use the average SR per month that has data, multiplied by total hours
    let lostDays = 0;
    if (totalManHours > 0 && totalSeveritySum > 0) {
        // Count months that have severity data
        let srMonthCount = 0;
        state.projects.forEach(p => {
            for (let i = 1; i <= 12; i++) {
                if (parseFloat(p.vals['rates_SEVERITY RATE']?.[i]) > 0) srMonthCount++;
            }
        });
        const avgSR = srMonthCount > 0 ? totalSeveritySum / srMonthCount : totalSeveritySum;
        lostDays = Math.round((avgSR * totalManHours) / 1000000);
    }

    // OSHS Formula (Philippines standard) ‚Äî base: 1,000,000 man-hours
    // LTIR = LTA Cases √ó 1,000,000 / Total Man-hours
    // TRIR = Recordable Cases √ó 1,000,000 / Total Man-hours
    // SR   = Lost Days √ó 1,000,000 / Total Man-hours
    // OSHA Formula ‚Äî base: 200,000 man-hours
    // LTIR = LTA Cases √ó 200,000 / Total Man-hours
    // TRIR = Recordable Cases √ó 200,000 / Total Man-hours
    // SR   = Lost Days √ó 200,000 / Total Man-hours

    let ltirOsha = 0, ltirOshs = 0, trirOsha = 0, trirOshs = 0, srOsha = 0, srOshs = 0;
    if (totalManHours > 0) {
        ltirOsha = (ltaCases        * 200000)   / totalManHours;
        ltirOshs = (ltaCases        * 1000000)  / totalManHours;
        trirOsha = (recordableCases * 200000)   / totalManHours;
        trirOshs = (recordableCases * 1000000)  / totalManHours;
        srOsha   = (lostDays        * 200000)   / totalManHours;
        srOshs   = (lostDays        * 1000000)  / totalManHours;
    }

    return {
        recordableCases: recordableCases,
        lostDays:        lostDays,
        totalHours:      Math.round(totalManHours),
        ltaCases:        ltaCases,
        ltirOsha:  ltirOsha.toFixed(4), ltirOshs:  ltirOshs.toFixed(4),
        trirOsha:  trirOsha.toFixed(4), trirOshs:  trirOshs.toFixed(4),
        srOsha:    srOsha.toFixed(4),   srOshs:    srOshs.toFixed(4)
    };
}

/**
 * Returns the HTML string for the Incident Tabulation Rate panel.
 * Injected at the TOP of the Statistics Rate tab on every render.
 */
function buildIncidentTabulationHTML() {
    const d = computeAggregateTabulation();
    return `
    <div id="incident-tabulation-panel" style="padding: 20px 20px 0 20px;">
      <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); margin-bottom: 6px;">

        <!-- Panel header -->
        <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); color: white; padding: 14px 20px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
          <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
          <i class="fas fa-calculator" style="font-size: 1.1rem; position: relative; z-index: 2;"></i>
          <span style="font-weight: 700; font-size: 1rem; letter-spacing: 0.5px; position: relative; z-index: 2;">INCIDENT TABULATION RATE</span>
          <span style="background: var(--safety-yellow); color: #1b5e20; padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 800; margin-left: 4px; position: relative; z-index: 2;">AUTO-COMPUTED FROM ALL PROJECTS</span>
        </div>

        <!-- 4 summary cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">

          <div style="padding: 18px 20px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">No. of LTA Cases</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #1b5e20; line-height: 1;">${d.ltaCases}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">Lost Time Accidents YTD</div>
          </div>

          <div style="padding: 18px 20px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">No. of Recordable Cases</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #e65100; line-height: 1;">${d.recordableCases}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">LTA + Medical + Fatality + High-Pot.</div>
          </div>

          <div style="padding: 18px 20px; text-align: center; border-right: 1px solid var(--border-color);">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">No. of Lost Days</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #1565c0; line-height: 1;">${d.lostDays}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">From Severity Rate data</div>
          </div>

          <div style="padding: 18px 20px; text-align: center;">
            <div style="font-size: 0.62rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px;">Total Man-hours Exposure</div>
            <div style="font-size: 2.2rem; font-weight: 900; color: #b71c1c; line-height: 1;">${d.totalHours.toLocaleString()}</div>
            <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 4px;">Total Exposed Manhour YTD</div>
          </div>

        </div>

        <!-- Rates results table -->
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.82rem;">
            <thead>
              <tr>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 12px 15px; text-align: left; border: none; width: 40%;">INJURY / ILLNESS</th>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 12px 15px; text-align: center; border: none; width: 30%;">OSHA<br><span style="font-size:0.72rem;font-weight:400;">200,000 hrs base</span></th>
                <th style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white; padding: 12px 15px; text-align: center; border: none; width: 30%;">OSHS<br><span style="font-size:0.72rem;font-weight:400;">1,000,000 hrs base</span></th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:14px 15px;border:none;">
                  <div style="font-weight:700;font-size:0.88rem;">LTIR ‚Äî Lost Time Incident Rate</div>
                  <div style="font-size:0.66rem;opacity:0.9;margin-top:3px;">LTA Cases √ó 200K or 1M √∑ Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1b5e20;">${d.ltirOsha}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1b5e20;">${d.ltirOshs}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:14px 15px;border:none;">
                  <div style="font-weight:700;font-size:0.88rem;">TRIR ‚Äî Total Recordable Incident Rate</div>
                  <div style="font-size:0.66rem;opacity:0.9;margin-top:3px;">Recordable Cases √ó 200K or 1M √∑ Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1565c0;">${d.trirOsha}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#1565c0;">${d.trirOshs}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
              </tr>
              <tr>
                <td style="background:linear-gradient(135deg,#2e7d32 0%,#43a047 100%);color:white;padding:14px 15px;border:none;">
                  <div style="font-weight:700;font-size:0.88rem;">SR ‚Äî Severity Rate</div>
                  <div style="font-size:0.66rem;opacity:0.9;margin-top:3px;">Total Days Lost √ó 200K or 1M √∑ Total Man-hours</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#b71c1c;">${d.srOsha}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHA (200K base)</div>
                </td>
                <td style="background:var(--bg-card);padding:12px;text-align:center;border:1px solid var(--border-color);">
                  <div style="font-size:1.8rem;font-weight:800;color:#b71c1c;">${d.srOshs}</div>
                  <div style="font-size:0.62rem;color:var(--text-secondary);">OSHS (1M base)</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>`;
}

// ==================== TREND LINE CHART FUNCTIONS ====================

function buildTrendChartHTML(tabType) {
    const chartId = `trendChart_${tabType}`;
    const title = tabType === 'rates' ? 'STATISTICS RATE TRENDS' : 'ACCIDENT/INCIDENT TRENDS';
    const icon = tabType === 'rates' ? 'fa-chart-line' : 'fa-chart-area';
    
    return `
    <div id="trend-chart-panel" style="padding: 20px 20px 0 20px;">
      <div style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); margin-bottom: 20px;">
        
        <!-- Chart header with filters -->
        <div style="background: linear-gradient(135deg, #0d3d0f 0%, #1b5e20 25%, #2e7d32 50%, #43a047 75%, #66bb6a 100%); color: white; padding: 14px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); position: relative; overflow: hidden;">
          <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%); pointer-events: none; z-index: 1;"></div>
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; position: relative; z-index: 2;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <i class="fas ${icon}" style="font-size: 1.1rem;"></i>
              <span style="font-weight: 700; font-size: 1rem; letter-spacing: 0.5px;">${title}</span>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <!-- Region Filter -->
              <select id="trendRegionFilter" onchange="updateTrendChart('${tabType}')" 
                      style="padding: 6px 12px; border-radius: 6px; border: none; font-size: 0.75rem; font-weight: 600; background: white; color: #1b5e20; cursor: pointer;">
                <option value="all">All Regions</option>
                <option value="NCR">NCR</option>
                <option value="LUZON">LUZON</option>
                <option value="VISAYAS">VISAYAS</option>
                <option value="MINDANAO">MINDANAO</option>
              </select>
              
              <!-- Project Filter -->
              <select id="trendProjectFilter" onchange="updateTrendChart('${tabType}')" 
                      style="padding: 6px 12px; border-radius: 6px; border: none; font-size: 0.75rem; font-weight: 600; background: white; color: #1b5e20; cursor: pointer;">
                <option value="all">All Projects</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Chart canvas -->
        <div style="padding: 20px;">
          <canvas id="${chartId}" style="max-height: 400px;"></canvas>
        </div>
        
      </div>
    </div>`;
}

function populateProjectFilter() {
    const projectFilter = document.getElementById('trendProjectFilter');
    if (!projectFilter) return;
    
    // Keep the "All Projects" option
    projectFilter.innerHTML = '<option value="all">All Projects</option>';
    
    // Add each project
    state.projects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.textContent = p.name;
        projectFilter.appendChild(option);
    });
}

let trendChartInstance = null;

function updateTrendChart(tabType) {
    const regionFilter = document.getElementById('trendRegionFilter')?.value || 'all';
    const projectFilter = document.getElementById('trendProjectFilter')?.value || 'all';
    const chartId = `trendChart_${tabType}`;
    const canvas = document.getElementById(chartId);
    
    if (!canvas) return;
    
    // Destroy existing chart
    if (trendChartInstance) {
        trendChartInstance.destroy();
        trendChartInstance = null;
    }
    
    // Filter projects based on selection
    let filteredProjects = state.projects;
    
    if (regionFilter !== 'all') {
        filteredProjects = filteredProjects.filter(p => p.region === regionFilter);
    }
    
    if (projectFilter !== 'all') {
        filteredProjects = filteredProjects.filter(p => p.name === projectFilter);
    }
    
    // Prepare data
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const datasets = [];
    
    if (tabType === 'rates') {
        // Statistics Rate data
        const rateTypes = ['LTIR', 'TRIR', 'SEVERITY RATE'];
        const colors = ['#1b5e20', '#1565c0', '#b71c1c'];
        
        rateTypes.forEach((rateType, idx) => {
            const data = new Array(12).fill(0);
            const counts = new Array(12).fill(0);
            
            filteredProjects.forEach(p => {
                const key = `rates_${rateType}`;
                if (p.vals && p.vals[key]) {
                    for (let i = 1; i <= 12; i++) {
                        const val = parseFloat(p.vals[key][i]) || 0;
                        if (val > 0) {
                            data[i-1] += val;
                            counts[i-1]++;
                        }
                    }
                }
            });
            
            // Calculate averages
            const avgData = data.map((sum, i) => counts[i] > 0 ? (sum / counts[i]).toFixed(2) : 0);
            
            datasets.push({
                label: rateType,
                data: avgData,
                borderColor: colors[idx],
                backgroundColor: colors[idx] + '20',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        });
        
    } else if (tabType === 'medical') {
        // Accident/Incident Record data
        const incidentTypes = ['Medical Treatment', 'First Aid', 'LTA', 'Fatality', 'High-Potential incident', 'Dangerous Occurrences'];
        const colors = ['#1b5e20', '#2e7d32', '#1565c0', '#b71c1c', '#e65100', '#f57c00'];
        
        incidentTypes.forEach((incidentType, idx) => {
            const data = new Array(12).fill(0);
            
            filteredProjects.forEach(p => {
                const key = `medical_${incidentType}`;
                if (p.vals && p.vals[key]) {
                    for (let i = 1; i <= 12; i++) {
                        const val = parseFloat(p.vals[key][i]) || 0;
                        data[i-1] += val;
                    }
                }
            });
            
            datasets.push({
                label: incidentType,
                data: data,
                borderColor: colors[idx],
                backgroundColor: colors[idx] + '20',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        });
    }
    
    // Create chart with gradient fills
    const ctx = canvas.getContext('2d');
    
    // Create gradients for each dataset
    const datasetsWithGradients = datasets.map(ds => {
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, ds.borderColor + '40');
        gradient.addColorStop(1, ds.borderColor + '00');
        
        return {
            label: ds.label,
            data: ds.data,
            borderColor: ds.borderColor,
            backgroundColor: gradient,
            borderWidth: 2,
            pointRadius: 5,
            pointBackgroundColor: ds.borderColor,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            tension: 0.4,
            fill: true
        };
    });
    
    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: datasetsWithGradients
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        padding: 10,
                        font: {
                            size: 11,
                            weight: 600
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || '#333'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 13,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#666'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#666'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}



// ==================== LOCAL STORAGE FUNCTIONS ====================

// Save to localStorage only (called internally, no Firebase trigger)
function saveUserDataLocal(email) {
    if (!email) return;
    
    const year = state.selectedYear || 2026;
    const userData = {
        year: year,
        projects: state.projects.map(p => { const c = {...p}; delete c.selected; return c; }),
        personnelData: state.personnelData,
        incidentRateData: state.incidentRateData,
        darkMode: state.darkMode,
        lastSaved: new Date().toISOString(),
        timestamp: Date.now(),
        lastModified: new Date().toISOString()
    };
    
    // Save with year-based key
    localStorage.setItem(`esh_dashboard_${year}_${email}`, JSON.stringify(userData));
    console.log(`üíæ Saved to localStorage (local only) for year ${year}`);
}

// Main Firebase Save Button Handler
// ==================== OPTIMIZED FIREBASE INTEGRATION ====================

let firebaseReady = false;
let firebaseUnsubscribe = null;

function getCurrentUserId() {
    return window.firebaseAuth?.currentUser?.uid || 'local-user';
}

// NEW: Get the UID to read data from (always admin's UID for shared data)
function getDataSourceUserId() {
    // HARDCODED: Admin's UID from Firebase
    const ADMIN_UID = 'fUnXsvKnRYMpuySRbeVYJk7TO452';
    
    // All users read from admin's data location
    return ADMIN_UID;
}

function waitForFirebase() {
    return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
            if (window.firebase && window.firebaseDb && window.firebaseAuth) {
                clearInterval(checkInterval);
                firebaseReady = true;
                resolve();
            }
        }, 100);
    });
}

// OPTIMIZED: Save to Firebase - MANUAL ONLY
async function saveToFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('‚è≥ Firebase not ready');
        return false;
    }

    try {
        const dataUserId = getDataSourceUserId(); // Save to admin's UID (shared location)
        const currentUserId = getCurrentUserId(); // Current user's UID for preferences
        const currentYear = state.selectedYear || 2026;
        
        // Update masterProjects with current changes
        // Remove old versions and add updated versions
        state.projects.forEach(project => {
            const index = state.masterProjects.findIndex(p => p.name === project.name);
            if (index >= 0) {
                state.masterProjects[index] = project;
            } else {
                state.masterProjects.push(project);
            }
        });
        
        // Now save ALL master projects to ALL their relevant years
        // Group projects by year they should appear in
        const projectsByYear = new Map();
        
        state.masterProjects.forEach(project => {
            const startYear = project.dateStarted ? parseInt(project.dateStarted.split('-')[0]) : null;
            const finishedYear = project.dateFinished ? parseInt(project.dateFinished.split('-')[0]) : null;
            
            if (startYear) {
                const endYear = finishedYear || YEAR_RANGE.max;
                
                for (let year = Math.max(startYear, YEAR_RANGE.min); year <= Math.min(endYear, YEAR_RANGE.max); year++) {
                    if (!projectsByYear.has(year)) {
                        projectsByYear.set(year, []);
                    }
                    projectsByYear.get(year).push(project);
                }
            }
        });
        
        // Save to each year
        const savePromises = [];
        projectsByYear.forEach((projects, year) => {
            const yearDocRef = window.firebase.doc(window.firebaseDb, 'users', dataUserId, 'years', year.toString());
            
            const dataToSave = {
                year: year,
                email: state.currentUser?.email || 'local-user',
                displayName: state.currentUser?.displayName || localStorage.getItem('esh_displayname_' + state.currentUser?.email) || '',
                projects: projects,
                lastUpdated: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            // Add personnel and incident data only for current year
            if (year === currentYear) {
                dataToSave.personnelData = state.personnelData || [];
                dataToSave.incidentRateData = state.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
            }
            
            savePromises.push(window.firebase.setDoc(yearDocRef, dataToSave, { merge: true }));
        });
        
        // Save all in parallel for speed
        await Promise.all(savePromises);
        
        // Also save user preferences (darkMode) to CURRENT user's doc
        const userDocRef = window.firebase.doc(window.firebaseDb, 'users', currentUserId);
        await window.firebase.setDoc(userDocRef, {
            email: state.currentUser?.email,
            displayName: state.currentUser?.displayName || '',
            darkMode: state.darkMode || false,
            lastActiveYear: currentYear,
            isDataMigrated: true
        }, { merge: true });
        
        state.lastSyncTimestamp = Date.now();
        console.log(`‚úÖ Data saved to Firebase for all relevant years:`, new Date().toLocaleTimeString());
        return true;
        
    } catch (error) {
        console.error('‚ùå Error saving to Firebase:', error);
        showToast('Failed to save: ' + error.message, 'error');
        return false;
    }
}

// OPTIMIZED: Load from Firebase - ONCE on login only with YEAR SUPPORT + AUTO MIGRATION
async function loadFromFirebase() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('‚è≥ Firebase not ready, loading from localStorage only');
        loadFromLocalStorage();
        return;
    }

    try {
        const userId = getCurrentUserId();
        const userEmail = state.currentUser?.email;
        const year = state.selectedYear || 2026;
        
        // Load user preferences first
        const userDocRef = window.firebase.doc(window.firebaseDb, 'users', userId);
        const userDocSnap = await window.firebase.getDoc(userDocRef);
        
        // üîÑ AUTO-MIGRATION: Check if old data structure exists and migrate
        if (userDocSnap.exists()) {
            const userData = userDocSnap.data();
            
            // Load dark mode preference
            if (userData.darkMode !== undefined) {
                state.darkMode = userData.darkMode;
            }
            
            // Load display name
            if (userData.displayName) {
                state.currentUser.displayName = userData.displayName;
                localStorage.setItem('esh_displayname_' + userEmail, userData.displayName);
                const badge = document.getElementById('user-badge');
                if (badge) badge.innerHTML = `<i class="fas fa-user-circle"></i> ${userData.displayName}`;
            }
            
            // üö® MIGRATION: If old structure detected (has projects array at root), migrate to 2026
            if (userData.projects && !userData.isDataMigrated) {
                console.log('üîÑ OLD STRUCTURE DETECTED - Migrating to year-based structure...');
                
                // Create backup
                const backupDocRef = window.firebase.doc(window.firebaseDb, 'users', userId, 'backups', 'pre_migration');
                await window.firebase.setDoc(backupDocRef, {
                    ...userData,
                    migratedAt: new Date().toISOString(),
                    backupNote: 'Auto-backup before year-based migration'
                });
                console.log('‚úÖ Backup created at /backups/pre_migration');
                
                // Migrate to 2026
                const year2026Ref = window.firebase.doc(window.firebaseDb, 'users', userId, 'years', '2026');
                await window.firebase.setDoc(year2026Ref, {
                    year: 2026,
                    email: userData.email,
                    displayName: userData.displayName || '',
                    projects: userData.projects || [],
                    personnelData: userData.personnelData || [],
                    incidentRateData: userData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 },
                    lastUpdated: new Date().toISOString(),
                    timestamp: Date.now(),
                    migratedFrom: 'old_structure'
                });
                console.log('‚úÖ Data migrated to /years/2026');
                
                // Mark as migrated
                await window.firebase.setDoc(userDocRef, { isDataMigrated: true }, { merge: true });
                
                showToast('‚úÖ Your data has been migrated to year-based structure (2026)', 'success');
            }
        }
        
        // Load year-specific data
        const yearDocRef = window.firebase.doc(window.firebaseDb, 'users', userId, 'years', year.toString());
        const yearDocSnap = await window.firebase.getDoc(yearDocRef);
        
        // Check localStorage for newer unsaved data for this year
        const localKey = `esh_dashboard_${year}_${userEmail}`;
        const localRaw = localStorage.getItem(localKey);
        const localData = localRaw ? JSON.parse(localRaw) : null;
        const localTimestamp = localData?.lastSaved ? new Date(localData.lastSaved).getTime() : 0;

        if (yearDocSnap.exists()) {
            const fbData = yearDocSnap.data();
            const fbTimestamp = fbData.timestamp || 0;

            // Use whichever is newer: localStorage or Firebase
            if (localTimestamp > fbTimestamp) {
                console.log(`üíæ localStorage is newer for year ${year} ‚Äî loading from localStorage`);
                state.projects = localData.projects || [];
                state.personnelData = localData.personnelData || [];
                state.incidentRateData = localData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.lastSyncTimestamp = fbTimestamp;
                // Push local data up to Firebase so it's in sync
                await saveToFirebase();
            } else {
                console.log(`‚òÅÔ∏è Firebase is newer for year ${year} ‚Äî loading from Firebase`);
                state.projects = fbData.projects || [];
                state.personnelData = fbData.personnelData || [];
                state.incidentRateData = fbData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.lastSyncTimestamp = fbTimestamp;
                // Sync Firebase data down to localStorage
                saveUserDataLocal(userEmail);
            }
            
            state.filteredProjects = [...state.projects];
            console.log(`‚úÖ Data loaded for year ${year}. Projects:`, state.projects.length, '| Personnel:', state.personnelData.length);

        } else {
            // No Firebase doc for this year ‚Äî use localStorage if available, else start fresh
            if (localData) {
                console.log(`üìù No Firebase doc for year ${year} ‚Äî restoring from localStorage`);
                state.projects = localData.projects || [];
                state.personnelData = localData.personnelData || [];
                state.incidentRateData = localData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.filteredProjects = [...state.projects];
                await saveToFirebase(); // Save to create the year doc
            } else {
                console.log(`üìù No data for year ${year} ‚Äî starting fresh`);
                state.projects = [];
                state.personnelData = [];
                state.incidentRateData = { recordableCases: 0, lostDays: 0, totalHours: 0 };
                state.filteredProjects = [];
            }
        }

        // Apply dark mode
        if (state.darkMode) {
            document.body.classList.add('dark-mode');
        }
        
        // Update UI
        render();
        renderPTable();
        
    } catch (error) {
        console.error('‚ùå Error loading from Firebase:', error);
        // Fallback to localStorage on error
        loadFromLocalStorage();
    }
}

// Fallback: load from localStorage only
function loadFromLocalStorage() {
    const userEmail = state.currentUser?.email;
    if (!userEmail) return;
    
    const year = state.selectedYear || 2026;
    const localKey = `esh_dashboard_${year}_${userEmail}`;
    const localRaw = localStorage.getItem(localKey);
    
    if (localRaw) {
        const data = JSON.parse(localRaw);
        state.projects = data.projects || [];
        state.personnelData = data.personnelData || [];
        state.incidentRateData = data.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
        state.filteredProjects = [...state.projects];
        console.log(`üíæ Loaded from localStorage fallback for year ${year}`);
        render();
        renderPTable();
    }
}

// Load all projects ONCE and filter by selected year (called only on login)
async function loadAllProjectsAndFilter() {
    if (!firebaseReady || !window.firebaseDb) {
        console.log('‚è≥ Firebase not ready');
        return;
    }

    try {
        const dataUserId = getDataSourceUserId(); // Use admin's UID for shared data
        const selectedYear = state.selectedYear;
        
        console.log(`üìÇ Loading master project list from Firebase...`);
        console.log(`üìã Available years to check:`, availableYears);
        
        // Load projects from ALL available years to build master list
        let allProjects = [];
        const projectMap = new Map(); // Use Map to avoid duplicates by name
        
        for (const year of availableYears) {
            const yearDocRef = window.firebase.doc(window.firebaseDb, 'users', dataUserId, 'years', year.toString());
            const yearDocSnap = await window.firebase.getDoc(yearDocRef);
            
            if (yearDocSnap.exists()) {
                const yearData = yearDocSnap.data();
                const yearProjects = yearData.projects || [];
                
                console.log(`   Year ${year}: Found ${yearProjects.length} projects`);
                
                // Add projects to map, keeping the most recent version
                yearProjects.forEach(project => {
                    if (!projectMap.has(project.name)) {
                        projectMap.set(project.name, project);
                    }
                });
            } else {
                console.log(`   Year ${year}: No data`);
            }
        }
        
        // Convert map to array
        state.masterProjects = Array.from(projectMap.values());
        
        console.log(`‚úÖ Loaded ${state.masterProjects.length} unique projects into master list`);
        
        // Now filter to show only projects active in the selected year
        state.projects = filterProjectsByYear(state.masterProjects, selectedYear);
        state.filteredProjects = [...state.projects];
        
        console.log(`‚úÖ Showing ${state.projects.length} projects active in ${selectedYear}`);
        console.log(`üìä Projects to display:`, state.projects.map(p => p.name));
        
        // Load personnel and incident data for the selected year
        const yearDocRef = window.firebase.doc(window.firebaseDb, 'users', dataUserId, 'years', selectedYear.toString());
        const yearDocSnap = await window.firebase.getDoc(yearDocRef);
        
        if (yearDocSnap.exists()) {
            const yearData = yearDocSnap.data();
            state.personnelData = yearData.personnelData || [];
            state.incidentRateData = yearData.incidentRateData || { recordableCases: 0, lostDays: 0, totalHours: 0 };
        } else {
            state.personnelData = [];
            state.incidentRateData = { recordableCases: 0, lostDays: 0, totalHours: 0 };
        }
        
        // CRITICAL: Render the UI with loaded data
        console.log(`üé® Rendering UI...`);
        render();
        renderPTable();
        console.log(`‚úÖ UI rendered successfully`);
        
    } catch (error) {
        console.error('‚ùå Error loading projects:', error);
        showToast('‚ùå Error loading data: ' + error.message, 'error');
    }
}

// REMOVED: Real-time listener completely - saves lots of Firebase reads!
// No setupFirebaseListener() function = no continuous reads

// Firebase Authentication Handlers
async function firebaseLogin(email, password) {
    if (!window.firebase) {
        showToast('Firebase not initialized. Please refresh the page.', 'error');
        return false;
    }

    try {
        const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('‚úÖ Login successful:', userCredential.user.email);
        return true;
    } catch (error) {
        console.error('‚ùå Login error:', error);
        showToast('Login failed: ' + error.message, 'error');
        return false;
    }
}

async function firebaseSignup(email, password) {
    if (!window.firebase) {
        showToast('Firebase not initialized. Please refresh the page.', 'error');
        return false;
    }

    // ‚ö†Ô∏è SECURITY WARNING: Password Validation
    // Wala pang minimum requirements para sa password strength
    // Dapat mag-implement ng:
    // - Minimum 8+ characters
    // - May numbers at special characters
    // - May uppercase at lowercase letters
    // Halimbawa:
    // if (password.length < 8) {
    //     showToast('Password must be at least 8 characters long', 'warning');
    //     return false;
    // }
    // if (!/(?=.*[0-9])(?=.*[!@#$%^&*])/.test(password)) {
    //     showToast('Password must contain at least one number and one special character', 'warning');
    //     return false;
    // }

    try {
        const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
        console.log('‚úÖ Signup successful:', userCredential.user.email);
        
        // Initialize user data
        await saveToFirebase();
        
        return true;
    } catch (error) {
        console.error('‚ùå Signup error:', error);
        showToast('Signup failed: ' + error.message, 'error');
        return false;
    }
}

async function firebaseLogout() {
    if (!window.firebase) {
        return;
    }

    try {
        // Cleanup presence before signing out
        if (state.currentUser && state.currentUser.uid) {
            PresenceTracker.cleanup();
        }
        
        // üîä Play logout sound before signing out
        playLogoutSound();
        
        // ‚è±Ô∏è Clear work timer on logout
        clearWorkTimerOnLogout();
        
        await window.firebase.signOut(window.firebaseAuth);
        
        // Unsubscribe from listener (if any exists)
        if (firebaseUnsubscribe) {
            firebaseUnsubscribe();
            firebaseUnsubscribe = null;
        }
        
        console.log('‚úÖ Logout successful');
    } catch (error) {
        console.error('‚ùå Logout error:', error);
    }
}

async function firebaseChangePassword(newPassword) {
    if (!window.firebase || !window.firebaseAuth.currentUser) {
        alert('Not authenticated');
        return false;
    }

    try {
        await window.firebase.updatePassword(window.firebaseAuth.currentUser, newPassword);
        console.log('‚úÖ Password changed successfully');
        return true;
    } catch (error) {
        console.error('‚ùå Password change error:', error);
        return false;
    }
}

async function firebaseResetPassword(email) {
    if (!window.firebase) {
        alert('Firebase not initialized');
        return false;
    }

    try {
        await window.firebase.sendPasswordResetEmail(window.firebaseAuth, email);
        console.log('‚úÖ Password reset email sent');
        return true;
    } catch (error) {
        console.error('‚ùå Password reset error:', error);
        return false;
    }
}


// Auth State Observer - OPTIMIZED: No real-time listener!
function setupAuthObserver() {
    if (!window.firebase) {
        return;
    }

    window.firebase.onAuthStateChanged(window.firebaseAuth, async (user) => {
        // Always hide the loading overlay once Firebase responds
        const loadingOverlay = document.getElementById('firebase-loading-overlay');
        if (loadingOverlay) loadingOverlay.style.display = 'none';

        if (user) {
            console.log('üë§ User authenticated:', user.email);
            
            // Load displayName from Firestore
            let displayName = user.email; // Default to email
            try {
                const userDocRef = window.firebase.doc(window.firebaseDb, 'users', user.uid);
                const userDocSnap = await window.firebase.getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    displayName = userData.displayName || user.email;
                    console.log('‚úÖ Loaded display name:', displayName);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not load display name, using email');
            }
            
            state.currentUser = { 
                email: user.email, 
                uid: user.uid,
                displayName: displayName 
            };
            state.isLoggedIn = true;

            // ==================== INITIALIZE USER ROLE & REGION ====================
            const userInfo = UserAccounts.getUserInfo(user.email);
            state.userRole = userInfo.role;
            state.userRegion = userInfo.region;
            state.userColor = userInfo.color;
            state.isAdmin = userInfo.role === 'admin';
            
            console.log(`üé≠ Role: ${state.userRole} | Region: ${state.userRegion}`);
            
            // ==================== GENERATE DEVICE FINGERPRINT ====================
            if (!state.deviceFingerprint) {
                state.deviceFingerprint = await DeviceFingerprint.generate();
                console.log('üîë Device fingerprint generated');
            }

            // Hide login, show main UI
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'none';

            // Update user badge with role
            const userBadge = document.getElementById('user-badge');
            if (userBadge) {
                const roleIcon = state.isAdmin ? 'fa-user-shield' : 'fa-user-tie';
                // Use custom displayName if available, otherwise use default role name
                const roleLabel = state.currentUser.displayName || (state.isAdmin ? 'ESH Admin' : userInfo.displayName);
                
                // Only update the name part, not the whole innerHTML to preserve dropdown
                const nameDiv = userBadge.querySelector('.name');
                if (nameDiv) {
                    nameDiv.innerHTML = `
                        <i class="fas ${roleIcon}"></i>
                        ${roleLabel}
                    `;
                }
                
                // Show admin menu in user profile dropdown if admin
                if (state.isAdmin) {
                    console.log('üõ°Ô∏è Admin badge active');
                }
            }

            // Update user-email field (settings page)
            const userEmailEl = document.getElementById('user-email');
            if (userEmailEl) {
                userEmailEl.textContent = user.email;
            }

            // Show dashboard UI
            showUI();
            initDarkMode();
            initializeYears(); // Initialize year selector

            // Load user data with year-based filtering
            await loadAllProjectsAndFilter();
            
            // üîä Play login sound
            playLoginSound();
            
            // ==================== INITIALIZE NEW SYSTEMS ====================
            // Initialize Offline Mode Management
            OfflineManager.init();
            
            // Initialize Lazy Loading
            LazyLoader.init();
            
            // Note: AdminSystem.checkAdminAccess() removed - now using UserAccounts system
            // state.isAdmin already set correctly by UserAccounts.getUserInfo()
            
            // Show admin menu in user profile dropdown if admin
            if (state.isAdmin) {
                console.log('üõ°Ô∏è Admin access granted');
            } else {
                // Hide settings tab for superintendents
                const settingsTab = document.querySelector('[onclick*="settings"]');
                if (settingsTab) {
                    settingsTab.style.display = 'none';
                }
                console.log('üëî Superintendent access - restricted mode');
            }
            
            // Initialize presence tracking
            await PresenceTracker.initialize(user.uid, user.email);
            console.log('üü¢ Presence tracking active');
            
            // Show admin UI elements (device counter & active users)
            if (state.isAdmin) {
                // Small delay to ensure Firebase listeners are ready
                setTimeout(() => {
                    PresenceTracker.updateDeviceCounterUI();
                    PresenceTracker.updateActiveUsersUI();
                }, 500);
            }
            
            // Log login to logbook with IP and location
            await LoginLogbook.logLogin(user);
            
            // Log user login in audit trail
            AuditLogger.log('USER_LOGIN', { 
                email: user.email, 
                role: state.userRole,
                region: state.userRegion,
                timestamp: new Date().toISOString(),
                isAdmin: state.isAdmin,
                deviceId: state.deviceFingerprint
            });
            
            console.log('‚úÖ All systems initialized successfully!');
            // ==================== END NEW SYSTEMS ====================


        } else {
            console.log('üë§ No user authenticated ‚Äî showing login screen');
            
            // Cleanup presence tracking
            if (state.currentUser) {
                PresenceTracker.cleanup();
            }
            
            state.currentUser = null;
            state.isLoggedIn = false;
            state.userRole = null;
            state.userRegion = null;
            state.isAdmin = false;

            // Show login overlay
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) loginOverlay.style.display = 'flex';

            // Hide main UI
            const sidebar = document.getElementById('main-sidebar');
            const content = document.getElementById('main-content');
            if (sidebar) sidebar.classList.add('hidden');
            if (content) content.classList.add('hidden');

            // Reset login button state if it got stuck
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-right-to-bracket"></i> ACCESS SYSTEM';
            }
        }
    });
}

// CRITICAL FIX: saveUserData now saves to BOTH localStorage AND Firebase
// so data is never lost on refresh
const originalSaveUserData = window.saveUserData || function() {};

window.saveUserData = function(email) {
    // Always save to localStorage first (instant, no network)
    originalSaveUserData(email);
    
    // Also auto-save to Firebase if ready (prevents data loss on refresh)
    if (firebaseReady && window.firebaseDb && state.currentUser) {
        saveToFirebase().then(success => {
            if (success) console.log('‚òÅÔ∏è Auto-synced to Firebase');
        }).catch(err => console.warn('‚ö†Ô∏è Firebase auto-sync failed:', err.message));
    }
};

// Initialize Firebase Integration
waitForFirebase().then(async () => {
    console.log('üî• Firebase Ready! (OPTIMIZED MODE)');
    
    // Setup auth observer ‚Äî handles login state, UI show/hide, and data loading
    setupAuthObserver();
    
    // Setup inactivity auto-logout
    setupInactivityTimer();
});

// ==================== AUTO-LOGOUT AFTER INACTIVITY ====================
let inactivityTimer = null;
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

function setupInactivityTimer() {
    console.log('‚è∞ Inactivity timer initialized (30 minutes)');
    
    // Events that indicate user activity
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    
    // Reset the timer on any user activity
    function resetInactivityTimer() {
        // Only track if user is logged in
        if (!state.isLoggedIn) return;
        
        // Clear existing timer
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }
        
        // Set new timer
        inactivityTimer = setTimeout(() => {
            handleInactivityLogout();
        }, INACTIVITY_TIMEOUT);
    }
    
    // Handle logout due to inactivity
    async function handleInactivityLogout() {
        console.log('‚è∞ User inactive for 30 minutes - logging out...');
        
        // Show warning
        showToast('‚è∞ You have been logged out due to inactivity (30 minutes)', 'warning');
        
        // Wait a moment for the toast to show
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Perform logout
        if (window.firebaseAuth) {
            try {
                await window.firebase.signOut(window.firebaseAuth);
                console.log('‚úÖ Auto-logout successful');
            } catch (error) {
                console.error('‚ùå Error during auto-logout:', error);
            }
        }
    }
    
    // Attach event listeners
    activityEvents.forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
    });
    
    // Start the initial timer
    resetInactivityTimer();
}

// Cleanup presence when page is closed or refreshed
window.addEventListener('beforeunload', () => {
    if (state.currentUser && state.currentUser.uid) {
        PresenceTracker.cleanup();
    }
});

console.log('üî• Firebase integration loaded - OPTIMIZED: Save button only!');

// ==================== MOBILE MENU FUNCTIONALITY ====================
// Restore navigation states on load
document.addEventListener('DOMContentLoaded', function() {
    // Restore navigation group collapse states
    restoreNavGroupStates();
    
    // PREVENT NEGATIVE NUMBERS IN ALL NUMBER INPUTS
    document.addEventListener('keydown', function(e) {
        // Check if the target is a number input
        if (e.target.type === 'number') {
            // Prevent minus sign (-), plus sign (+), and 'e' (scientific notation)
            if (e.key === '-' || e.key === '+' || e.key === 'e' || e.key === 'E') {
                e.preventDefault();
                showToast('‚ö†Ô∏è Only positive numbers are allowed', 'warning');
            }
        }
    });
    
    // ALSO PREVENT PASTE OF NEGATIVE NUMBERS
    document.addEventListener('paste', function(e) {
        if (e.target.type === 'number') {
            const pasteData = e.clipboardData.getData('text');
            const number = parseFloat(pasteData);
            if (number < 0) {
                e.preventDefault();
                showToast('‚ö†Ô∏è Cannot paste negative numbers', 'warning');
            }
        }
    });
    
    // ALSO VALIDATE ON INPUT CHANGE
    document.addEventListener('input', function(e) {
        if (e.target.type === 'number') {
            const value = parseFloat(e.target.value);
            if (value < 0) {
                e.target.value = '';
                showToast('‚ö†Ô∏è Negative numbers are not allowed', 'warning');
            }
        }
    });
});

// ==================== AUDIO CONTEXT INITIALIZATION ====================
// Create global AudioContext for sound effects (needed for browser autoplay policies)
let globalAudioContext = null;
let audioContextReady = false;

function initAudioContext() {
    if (!globalAudioContext) {
        try {
            globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('üîä AudioContext initialized');
        } catch (e) {
            console.warn('Could not initialize AudioContext:', e);
            return null;
        }
    }
    
    // Resume AudioContext if suspended (required by browsers)
    if (globalAudioContext && globalAudioContext.state === 'suspended') {
        globalAudioContext.resume().then(() => {
            console.log('üîä AudioContext resumed');
            audioContextReady = true;
        }).catch(err => {
            console.warn('Could not resume AudioContext:', err);
        });
    } else if (globalAudioContext && globalAudioContext.state === 'running') {
        audioContextReady = true;
    }
    
    return globalAudioContext;
}

// Initialize on first user interaction
document.addEventListener('click', initAudioContext, { once: true });
document.addEventListener('keydown', initAudioContext, { once: true });
document.addEventListener('touchstart', initAudioContext, { once: true });

// ==================== SAFETY REMINDER SYSTEM ====================
// Load work start time from localStorage or initialize
let workStartTime = parseInt(localStorage.getItem('workStartTime')) || Date.now();
// Save to localStorage
localStorage.setItem('workStartTime', workStartTime);

let timerInterval = null;
let reminderTimeout = null;
let currentReminderType = null;
let soundInterval = null; // For looping sound

// Reminder configurations (in milliseconds)
const REMINDERS = {
    EYES_20: {
        interval: 20 * 60 * 1000, // 20 minutes
        icon: 'üëÄ',
        title: '20-20-20 Rule',
        text: 'Tumingin sa malayo (20 feet) sa loob ng 20 segundo para maiwasan ang eye strain!',
        sound: true
    },
    MICRO_BREAK: {
        interval: 60 * 60 * 1000, // 1 hour
        icon: 'üßò',
        title: 'Micro Break Time',
        text: 'Tumayo, mag-unat ng likod at balikat, at maglakad kahit ilang hakbang lang para iwas stiff muscles!',
        sound: true
    },
    LONG_BREAK: {
        interval: 2 * 60 * 60 * 1000, // 2 hours
        icon: '‚òï',
        title: 'Longer Break Time',
        text: 'Mag-break ng 10-15 minuto. Lumayo sa workstation, uminom ng tubig, at huwag mag-cellphone!',
        sound: true
    },
    EXTENDED_BREAK: {
        interval: 3 * 60 * 60 * 1000, // 3 hours
        icon: 'üå≥',
        title: 'Extended Break',
        text: 'Maglakad-lakad sa labas, huminga ng fresh air, at mag-relax. Importante ang kalusugan mo!',
        sound: true
    }
};

// Update timer display (no visual display, but keeps timer running for reminders)
function updateTimerDisplay() {
    // Timer runs silently in background for reminder calculations
    // No visual display needed
}

// Determine which reminder to show based on elapsed time
function getAppropriateReminder() {
    const elapsed = Date.now() - workStartTime;
    
    // Check in reverse order (longest to shortest) to show the most relevant reminder
    if (elapsed >= REMINDERS.EXTENDED_BREAK.interval && elapsed % REMINDERS.EXTENDED_BREAK.interval < 60000) {
        return 'EXTENDED_BREAK';
    } else if (elapsed >= REMINDERS.LONG_BREAK.interval && elapsed % REMINDERS.LONG_BREAK.interval < 60000) {
        return 'LONG_BREAK';
    } else if (elapsed >= REMINDERS.MICRO_BREAK.interval && elapsed % REMINDERS.MICRO_BREAK.interval < 60000) {
        return 'MICRO_BREAK';
    } else if (elapsed >= REMINDERS.EYES_20.interval && elapsed % REMINDERS.EYES_20.interval < 60000) {
        return 'EYES_20';
    }
    
    return null;
}

// Show reminder
function showReminder(type) {
    if (!REMINDERS[type]) return;
    
    const reminder = REMINDERS[type];
    const container = document.getElementById('safety-reminder-container');
    const iconEl = document.getElementById('reminder-icon');
    const titleEl = document.getElementById('reminder-title');
    const textEl = document.getElementById('reminder-text');
    
    if (!container || !iconEl || !titleEl || !textEl) return;
    
    // Update content
    iconEl.textContent = reminder.icon;
    titleEl.textContent = reminder.title;
    textEl.textContent = reminder.text;
    
    // Show the reminder with animation
    container.classList.add('show');
    currentReminderType = type;
    
    // Play sound notification (simple beep using Web Audio API)
    if (reminder.sound) {
        playNotificationSound();
    }
    
    // Auto-dismiss after 30 seconds if not manually dismissed
    if (reminderTimeout) {
        clearTimeout(reminderTimeout);
    }
    reminderTimeout = setTimeout(() => {
        dismissReminder();
    }, 30000);
    
    console.log(`üîî Reminder shown: ${reminder.title}`);
}

// Dismiss reminder
function dismissReminder() {
    const container = document.getElementById('safety-reminder-container');
    if (container) {
        container.classList.remove('show');
    }
    currentReminderType = null;
    
    // Stop the looping sound
    stopNotificationSound();
    
    if (reminderTimeout) {
        clearTimeout(reminderTimeout);
        reminderTimeout = null;
    }
}

// Play notification sound - loops continuously
function playNotificationSound() {
    // Clear any existing sound interval
    if (soundInterval) {
        clearInterval(soundInterval);
    }
    
    // Function to play one beep based on reminder type
    function playBeep() {
        try {
            // Don't call initAudioContext() - just check if it exists and is ready
            if (!globalAudioContext || !audioContextReady) {
                console.log('üîá Reminder sound skipped (AudioContext not ready)');
                return;
            }
            
            // Play different sounds based on reminder type
            if (currentReminderType === 'EYES_20') {
                // Option 2: Gentle Chime - C-E-G notes
                playNote(globalAudioContext, 523, 0.2, 0.25, 0.01, 0.15); // C
                setTimeout(() => playNote(globalAudioContext, 659, 0.2, 0.25, 0.01, 0.15), 150); // E
                setTimeout(() => playNote(globalAudioContext, 784, 0.3, 0.25, 0.01, 0.2), 300); // G
            } else if (currentReminderType === 'MICRO_BREAK') {
                // Option 1: Rising Melody - Do-Re-Mi-Fa-Sol
                playNote(globalAudioContext, 523, 0.15, 0.3, 0.01, 0.1); // C
                setTimeout(() => playNote(globalAudioContext, 587, 0.15, 0.3, 0.01, 0.1), 120); // D
                setTimeout(() => playNote(globalAudioContext, 659, 0.15, 0.3, 0.01, 0.1), 240); // E
                setTimeout(() => playNote(globalAudioContext, 698, 0.15, 0.3, 0.01, 0.1), 360); // F
                setTimeout(() => playNote(globalAudioContext, 784, 0.25, 0.4, 0.01, 0.15), 480); // G
            } else if (currentReminderType === 'LONG_BREAK') {
                // Option 2: Alarm Clock - 4 repeating beeps
                playNote(globalAudioContext, 1047, 0.2, 0.45, 0.01, 0.15);
                setTimeout(() => playNote(globalAudioContext, 1047, 0.2, 0.45, 0.01, 0.15), 250);
                setTimeout(() => playNote(globalAudioContext, 1047, 0.2, 0.45, 0.01, 0.15), 500);
                setTimeout(() => playNote(globalAudioContext, 1047, 0.3, 0.5, 0.01, 0.2), 750);
            } else if (currentReminderType === 'EXTENDED_BREAK') {
                // Option 1: Emergency Alert - alternating high-low siren
                playNote(globalAudioContext, 880, 0.3, 0.5, 0.01, 0.2);
                setTimeout(() => playNote(globalAudioContext, 660, 0.3, 0.5, 0.01, 0.2), 350);
                setTimeout(() => playNote(globalAudioContext, 880, 0.3, 0.5, 0.01, 0.2), 700);
                setTimeout(() => playNote(globalAudioContext, 660, 0.3, 0.5, 0.01, 0.2), 1050);
            }
        } catch (e) {
            console.warn('Could not play notification sound:', e);
        }
    }
    
    // Helper function to play a single note
    function playNote(ctx, frequency, duration, volume, attackTime, releaseTime) {
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        const now = ctx.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(volume, now + attackTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration + releaseTime);
        
        oscillator.start(now);
        oscillator.stop(now + duration + releaseTime);
    }
    
    // Play first beep immediately
    playBeep();
    
    // Then repeat every 2 seconds
    soundInterval = setInterval(() => {
        playBeep();
    }, 2000);
}

// Stop notification sound
function stopNotificationSound() {
    if (soundInterval) {
        clearInterval(soundInterval);
        soundInterval = null;
    }
}

// ==================== EXPORT TO PDF FUNCTIONALITY ====================

async function exportCurrentTabToPDF() {
    showToast('üìÑ Generating PDF report...', 'info');
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
        
        const year = state.selectedYear || 2026;
        const tabName = state.currentTab || 'overall';
        
        // Tab titles
        const tabTitles = {
            'overall': 'OVERALL SUMMARY',
            'exposures': 'SAFETY EXPOSURES',
            'medical': 'ACCIDENT/INCIDENT RECORD',
            'activities': 'SAFETY ACTIVITIES',
            'audit': 'SAFETY AUDIT',
            'nov': 'NOV',
            'rates': 'STATISTICS RATE',
            'personnel': 'ESH PERSONNEL MONITORING',
            'doe-report': 'DOE REPORTORIAL',
            'doe-permit': 'DOE SAFETY OFFICER PERMIT'
        };
        
        const title = tabTitles[tabName] || 'ESH COMPLIANCE REPORT';
        const filename = `ESH_${tabName.toUpperCase()}_${year}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // Add header
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 14;
        
        doc.setFillColor(27, 94, 32);
        doc.rect(0, 0, pageWidth, 30, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('ESH COMPLIANCE DASHBOARD', pageWidth / 2, 12, { align: 'center' });
        
        doc.setFontSize(14);
        doc.text(title, pageWidth / 2, 22, { align: 'center' });
        
        // Add metadata
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text(`Year: ${year}`, margin, 38);
        doc.text(`Generated: ${new Date().toLocaleString()}`, margin, 43);
        doc.text(`Total Projects: ${(state.projects || []).length}`, margin, 48);
        
        let startY = 55;
        
        // Generate data based on tab
        let headers = [];
        let rows = [];
        
        if (tabName === 'personnel') {
            // Personnel data
            headers = ['#', 'Full Name', 'Position', 'ID Number', 'Date Hired', 'Current Assignment', 'Age', 'Gender', 'Email', 'Contact No.', 'Home Address', 'Yrs. of Svc'];
            const personnelData = state.personnelData || [];
            rows = personnelData.map((p, idx) => [
                String(idx + 1),
                p.name || '',
                p.pos || '',
                p.id || '',
                p.hired || '',
                p.current || '',
                p.age || '',
                p.gen || '',
                p.mail || '',
                p.num || '',
                p.addr || '',
                p.len || ''
            ]);
        } else if (tabName === 'overall') {
            // Overall summary
            headers = ['#', 'Project Name', 'Region', 'Start Date', 'Status', 'Completion %'];
            const projects = state.projects || [];
            rows = projects.map((p, idx) => [
                String(idx + 1),
                p.name || '',
                p.region || '',
                p.start || '',
                p.status || 'on-going',
                String(getPerc(p)) + '%'
            ]);
        } else {
            // Other tabs - try to get table from DOM
            let table = null;
            const dashboardContent = document.getElementById('dashboard-content');
            table = dashboardContent ? dashboardContent.querySelector('table') : null;
            
            if (table) {
                // Get headers
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(th => {
                    const text = th.textContent.trim().replace(/\s+/g, ' ');
                    headers.push(text);
                });
                
                // Get rows
                const bodyRows = table.querySelectorAll('tbody tr');
                bodyRows.forEach(tr => {
                    const row = [];
                    const cells = tr.querySelectorAll('td');
                    cells.forEach(td => {
                        // Check for input/select elements
                        const input = td.querySelector('input[type="text"], input[type="date"], input[type="number"], select, textarea');
                        if (input) {
                            row.push(input.value || '');
                        } else {
                            // Clean up text content
                            let text = td.textContent.trim().replace(/\s+/g, ' ');
                            // Remove button text
                            text = text.replace(/\b(Edit|Save|Delete|Cancel|View|Upload|Download|‚úì|‚úï)\b/gi, '').trim();
                            row.push(text);
                        }
                    });
                    if (row.some(cell => cell !== '')) {
                        rows.push(row);
                    }
                });
            } else {
                // If no table found, extract from state.projects
                const categoryMap = {
                    'exposures': 'exposures',
                    'medical': 'medical',
                    'activities': 'activities',
                    'audit': 'audit',
                    'nov': 'nov',
                    'rates': 'rates'
                };
                
                const category = categoryMap[tabName];
                if (category) {
                    headers = ['#', 'Project Name', 'Region', 'Data Entries'];
                    const projects = state.projects || [];
                    rows = projects.map((p, idx) => {
                        let dataCount = 0;
                        if (p.vals) {
                            Object.keys(p.vals).forEach(key => {
                                if (key.startsWith(category + '_') || key.startsWith(category + '-')) {
                                    const val = p.vals[key];
                                    if (val && typeof val === 'object') {
                                        dataCount += Object.values(val).filter(v => v && String(v).trim() !== '').length;
                                    }
                                }
                            });
                        }
                        return [
                            String(idx + 1),
                            p.name || '',
                            p.region || '',
                            String(dataCount) + ' entries'
                        ];
                    });
                }
            }
        }
        
        if (headers.length === 0 || rows.length === 0) {
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(10);
            doc.text('No data available for this tab.', margin, startY);
        } else {
            // Generate table
            doc.autoTable({
                startY: startY,
                head: [headers],
                body: rows,
                theme: 'grid',
                styles: {
                    fontSize: 7,
                    cellPadding: 2,
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1,
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                headStyles: {
                    fillColor: [27, 94, 32],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 8,
                    halign: 'center',
                    valign: 'middle'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { left: margin, right: margin, top: 55, bottom: 15 },
                didDrawPage: function(data) {
                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                    
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(
                        'ESH Compliance Dashboard - SCIC',
                        margin,
                        pageHeight - 8
                    );
                    doc.text(
                        `Page ${data.pageNumber} of ${pageCount}`,
                        pageWidth - margin - 20,
                        pageHeight - 8
                    );
                }
            });
        }
        
        // Save PDF
        doc.save(filename);
        showToast('‚úÖ PDF report generated successfully!', 'success');
        
    } catch (error) {
        console.error('Error exporting PDF:', error);
        showToast('‚ùå Failed to generate PDF: ' + error.message, 'error');
    }
}

// ==================== END EXPORT PDF ====================

// Play login sound (once, no loop)
function playLoginSound() {
    try {
        // Don't call initAudioContext() here - just check if it exists
        if (!globalAudioContext || !audioContextReady) {
            console.log('üîá Login sound skipped (waiting for user interaction)');
            return;
        }
        
        // Option 2: Success Jingle - E-G-C-E
        playNote(globalAudioContext, 659, 0.15, 0.3, 0.01, 0.1); // E
        setTimeout(() => playNote(globalAudioContext, 784, 0.15, 0.3, 0.01, 0.1), 120); // G
        setTimeout(() => playNote(globalAudioContext, 1047, 0.2, 0.35, 0.01, 0.15), 240); // C
        setTimeout(() => playNote(globalAudioContext, 1319, 0.25, 0.4, 0.01, 0.18), 360); // E
        
        console.log('üîä Login sound played');
    } catch (e) {
        console.warn('Could not play login sound:', e);
    }
    
    function playNote(ctx, frequency, duration, volume, attackTime, releaseTime) {
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        const now = ctx.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(volume, now + attackTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration + releaseTime);
        
        oscillator.start(now);
        oscillator.stop(now + duration + releaseTime);
    }
}

// Play logout sound (once, no loop)
function playLogoutSound() {
    try {
        // Don't call initAudioContext() - just check if it exists
        if (!globalAudioContext || !audioContextReady) {
            console.log('üîá Logout sound skipped (AudioContext not ready)');
            return;
        }
        
        // Option 1: Goodbye Tone - G-E-C descending
        playNote(globalAudioContext, 784, 0.15, 0.3, 0.01, 0.1); // G
        setTimeout(() => playNote(globalAudioContext, 659, 0.15, 0.3, 0.01, 0.1), 150); // E
        setTimeout(() => playNote(globalAudioContext, 523, 0.25, 0.35, 0.01, 0.18), 300); // C
        
        console.log('üîä Logout sound played');
    } catch (e) {
        console.warn('Could not play logout sound:', e);
    }
    
    function playNote(ctx, frequency, duration, volume, attackTime, releaseTime) {
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        const now = ctx.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(volume, now + attackTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration + releaseTime);
        
        oscillator.start(now);
        oscillator.stop(now + duration + releaseTime);
    }
}

// Clear work timer on logout
function clearWorkTimerOnLogout() {
    // Stop any active reminders
    dismissReminder();
    
    // Clear the timer interval
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // Clear localStorage
    localStorage.removeItem('workStartTime');
    
    console.log('‚è±Ô∏è Work timer cleared on logout');
}

// Check if reminder should be shown
function checkReminders() {
    const elapsed = Date.now() - workStartTime;
    
    // Don't check if a reminder is currently showing
    if (currentReminderType) return;
    
    // Check reminders in PRIORITY ORDER (longer breaks override shorter ones)
    // When multiple reminders are due at the same time, show the most important one
    const checkIntervals = [
        { type: 'EXTENDED_BREAK', interval: REMINDERS.EXTENDED_BREAK.interval },   // 3 hours - HIGHEST PRIORITY
        { type: 'LONG_BREAK', interval: REMINDERS.LONG_BREAK.interval },           // 2 hours
        { type: 'MICRO_BREAK', interval: REMINDERS.MICRO_BREAK.interval },         // 1 hour
        { type: 'EYES_20', interval: REMINDERS.EYES_20.interval }                  // 20 minutes - LOWEST PRIORITY
    ];
    
    for (const check of checkIntervals) {
        // Check if we've hit this interval (within 2 second tolerance for reliability)
        if (elapsed >= check.interval) {
            const timeSinceInterval = elapsed % check.interval;
            
            // Trigger within 2 seconds of the interval mark
            if (timeSinceInterval < 2000) {
                console.log(`üîî Reminder triggered: ${check.type} at ${Math.floor(elapsed/60000)} minutes`);
                showReminder(check.type);
                break; // Show only one reminder at a time (highest priority wins)
            }
        }
    }
}

// Initialize safety reminder system
function initSafetyReminder() {
    // Load existing start time from localStorage or set new one
    const savedTime = localStorage.getItem('workStartTime');
    if (savedTime) {
        workStartTime = parseInt(savedTime);
    } else {
        workStartTime = Date.now();
        localStorage.setItem('workStartTime', workStartTime);
    }
    
    // Update timer every second
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    timerInterval = setInterval(() => {
        updateTimerDisplay();
        checkReminders();
    }, 1000);
    
    // Initial display update
    updateTimerDisplay();
    
    // Log reminder schedule
    const elapsed = Date.now() - workStartTime;
    console.log('‚úÖ Safety reminder system initialized');
    console.log(`‚è±Ô∏è Current work time: ${Math.floor(elapsed/60000)} minutes`);
    console.log('üìÖ Reminder Schedule:');
    console.log(`  üëÄ 20-20-20 Rule: Every 20 minutes (20, 40, 60, 80, 100, 120...)`);
    console.log(`  üßò Micro Break: Every 60 minutes (60, 120, 180...)`);
    console.log(`  ‚òï Longer Break: Every 120 minutes (120, 240...)`);
    console.log(`  üå≥ Extended Break: Every 180 minutes (180, 360...)`);
    console.log('');
    console.log('üîß Test Commands (paste in console):');
    console.log('  testReminder("EYES_20")    - Test 20-20-20 reminder');
    console.log('  testReminder("MICRO_BREAK") - Test micro break');
    console.log('  testReminder("LONG_BREAK")  - Test longer break');
    console.log('  testReminder("EXTENDED_BREAK") - Test extended break');
    console.log('  resetWorkTimer()            - Reset timer to 0');
    console.log('  setWorkTimer(minutes)       - Set timer to specific minutes');
}

// TEST FUNCTIONS for debugging
window.testReminder = function(type) {
    if (REMINDERS[type]) {
        console.log(`üß™ Testing reminder: ${type}`);
        showReminder(type);
    } else {
        console.error(`‚ùå Unknown reminder type: ${type}`);
        console.log('Available types: EYES_20, MICRO_BREAK, LONG_BREAK, EXTENDED_BREAK');
    }
};

window.resetWorkTimer = function() {
    workStartTime = Date.now();
    localStorage.setItem('workStartTime', workStartTime);
    updateTimerDisplay();
    console.log('üîÑ Work timer reset to 0:00:00');
};

window.setWorkTimer = function(minutes) {
    const targetTime = Date.now() - (minutes * 60 * 1000);
    workStartTime = targetTime;
    localStorage.setItem('workStartTime', workStartTime);
    updateTimerDisplay();
    console.log(`‚è±Ô∏è Work timer set to ${minutes} minutes`);
    console.log(`Next reminder should trigger at:`);
    
    // Calculate next reminder
    if (minutes < 20) {
        console.log(`  üëÄ 20-20-20 Rule in ${20 - minutes} minutes`);
    } else if (minutes < 60) {
        const nextEyes = Math.ceil(minutes / 20) * 20;
        console.log(`  üëÄ 20-20-20 Rule in ${nextEyes - minutes} minutes`);
    } else if (minutes < 120) {
        const nextMicro = Math.ceil(minutes / 60) * 60;
        console.log(`  üßò Micro Break in ${nextMicro - minutes} minutes`);
    } else if (minutes < 180) {
        const nextLong = Math.ceil(minutes / 120) * 120;
        console.log(`  ‚òï Longer Break in ${nextLong - minutes} minutes`);
    } else {
        const nextExtended = Math.ceil(minutes / 180) * 180;
        console.log(`  üå≥ Extended Break in ${nextExtended - minutes} minutes`);
    }
};

// Make dismiss function globally available
window.dismissReminder = dismissReminder;

// Start the system when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for the page to settle, then start
    setTimeout(() => {
        initSafetyReminder();
    }, 2000);
});

// Reset timer when user becomes active again after being away
let lastActivityTime = Date.now();
let inactivityTimeout = null;

function resetInactivityTimer() {
    lastActivityTime = Date.now();
    
    // If user was inactive for more than 10 minutes, reset the work timer
    if (inactivityTimeout) {
        clearTimeout(inactivityTimeout);
    }
    
    inactivityTimeout = setTimeout(() => {
        const inactiveTime = Date.now() - lastActivityTime;
        if (inactiveTime >= 10 * 60 * 1000) { // 10 minutes
            console.log('üîÑ User was inactive, resetting work timer');
            workStartTime = Date.now();
            localStorage.setItem('workStartTime', workStartTime);
            dismissReminder();
        }
    }, 10 * 60 * 1000);
}

// Track user activity
['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, true);
});

console.log('‚úÖ Safety reminder character loaded!');
// ==================== END SAFETY REMINDER SYSTEM ====================

// ==================== PRESENCE DEBUGGING ====================
// ==================== END FIREBASE INTEGRATION ====================

// ==================== AUTOMATIC COLOR CODING FOR REPORTORIAL TABLES ====================
function updateReportorialColors() {
    // Only apply colors when on the relevant tabs
    if (!['kpm', 'dole', 'emb', 'doe', 'doe-permit'].includes(state.currentTab)) return;
    
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth(); // 0-11 (0=January)
    const currentYear = currentDate.getFullYear();
    
    // Helper function to check if a month/quarter is overdue
    function isOverdue(monthIndex) {
        // If the month has already passed (strictly less than current month)
        if (monthIndex < currentMonth) {
            return true;
        }
        return false;
    }
    
    // Wait for table to be rendered
    setTimeout(() => {
        const tables = document.querySelectorAll('.table-container table');
        
        tables.forEach(table => {
            const rows = table.querySelectorAll('tbody tr, tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                
                // Skip header rows
                if (cells.length === 0) return;
                
                // For KPM and DOLE - monthly columns (1-12)
                if (state.currentTab === 'kpm' || state.currentTab === 'dole') {
                    // Check if this is a merged cell row (AEDR, AMR) - skip color coding
                    const firstDataCell = cells[1];
                    if (firstDataCell && firstDataCell.getAttribute('colspan') === '12') {
                        return; // Skip annual report rows
                    }
                    
                    // Process cells 1-12 (January to December)
                    for (let i = 1; i <= 12 && i < cells.length; i++) {
                        const cell = cells[i];
                        const input = cell.querySelector('input[type="date"]');
                        
                        if (input) {
                            const monthIndex = i - 1; // Convert to 0-based index (0=Jan, 11=Dec)
                            const inputValue = input.value.trim();
                            
                            // If input is empty and month is overdue
                            if (inputValue === '' && isOverdue(monthIndex)) {
                                cell.style.backgroundColor = '#ffcdd2'; // Light red
                                input.style.backgroundColor = '#ffcdd2';
                                input.style.color = '#c62828'; // Dark red text
                            } 
                            // If input has a date - mark as green (submitted)
                            else if (inputValue !== '') {
                                cell.style.backgroundColor = '#c8e6c9'; // Light green
                                input.style.backgroundColor = '#c8e6c9';
                                input.style.color = '#2e7d32'; // Dark green text
                            }
                            // Future months - no special color
                            else {
                                cell.style.backgroundColor = '';
                                input.style.backgroundColor = '';
                                input.style.color = '';
                            }
                        }
                    }
                }
                
                // For EMB - quarterly columns (Q1-Q4)
                else if (state.currentTab === 'emb') {
                    const rowType = cells[0]?.textContent.trim() || '';
                    
                    // Only apply to "Submission Date" rows, not "Reference No." rows
                    if (rowType.includes('Submission Date')) {
                        // Check if this is CMR Semi-Annual (has colspan="2")
                        const firstDataCell = cells[1];
                        const secondDataCell = cells[2];
                        
                        if (firstDataCell && firstDataCell.getAttribute('colspan') === '2' && 
                            secondDataCell && secondDataCell.getAttribute('colspan') === '2') {
                            // CMR Semi-Annual with 2 periods
                            
                            // Period 1: Jan-June, Due July 15
                            const input1 = firstDataCell.querySelector('input[type="date"]');
                            if (input1) {
                                const inputValue1 = input1.value.trim();
                                let isOverdue1 = false;
                                
                                // Due July 15 of the selected year
                                if (currentDate.getFullYear() > state.selectedYear) {
                                    // Past the deadline year
                                    isOverdue1 = true;
                                } else if (currentDate.getFullYear() === state.selectedYear) {
                                    if (currentMonth > 6) { // After July
                                        isOverdue1 = true;
                                    } else if (currentMonth === 6 && currentDate.getDate() > 15) { // After July 15
                                        isOverdue1 = true;
                                    }
                                }
                                
                                if (inputValue1 === '' && isOverdue1) {
                                    firstDataCell.style.backgroundColor = '#ffcdd2';
                                    input1.style.backgroundColor = '#ffcdd2';
                                    input1.style.color = '#c62828';
                                } else if (inputValue1 !== '') {
                                    firstDataCell.style.backgroundColor = '#c8e6c9';
                                    input1.style.backgroundColor = '#c8e6c9';
                                    input1.style.color = '#2e7d32';
                                } else {
                                    firstDataCell.style.backgroundColor = '';
                                    input1.style.backgroundColor = '';
                                    input1.style.color = '';
                                }
                            }
                            
                            // Period 2: Jul-Dec, Due January 15 of NEXT year
                            const input2 = secondDataCell.querySelector('input[type="date"]');
                            if (input2) {
                                const inputValue2 = input2.value.trim();
                                let isOverdue2 = false;
                                
                                // CMR Jul-Dec 2026 is due January 15, 2027
                                // Using EXACT same logic as Q4 SMR
                                const deadlineYear = state.selectedYear + 1; // Deadline is in the next year
                                const currentYear = currentDate.getFullYear();
                                
                                // Check if we've passed the deadline
                                if (currentYear > deadlineYear) {
                                    // Already past the deadline year
                                    isOverdue2 = true;
                                } else if (currentYear === deadlineYear) {
                                    // In the deadline year - check month and day
                                    if (currentMonth === 0 && currentDate.getDate() > 15) {
                                        // January 16+ of deadline year
                                        isOverdue2 = true;
                                    } else if (currentMonth > 0) {
                                        // February or later of deadline year
                                        isOverdue2 = true;
                                    }
                                }
                                // If currentYear < deadlineYear, not overdue yet
                                
                                if (inputValue2 === '' && isOverdue2) {
                                    secondDataCell.style.backgroundColor = '#ffcdd2';
                                    input2.style.backgroundColor = '#ffcdd2';
                                    input2.style.color = '#c62828';
                                } else if (inputValue2 !== '') {
                                    secondDataCell.style.backgroundColor = '#c8e6c9';
                                    input2.style.backgroundColor = '#c8e6c9';
                                    input2.style.color = '#2e7d32';
                                } else {
                                    secondDataCell.style.backgroundColor = '';
                                    input2.style.backgroundColor = '';
                                    input2.style.color = '';
                                }
                            }
                        } else {
                            // SMR Quarterly - Due 15th of following month after quarter
                            // Q1 (Jan-Mar) due April 15, Q2 (Apr-Jun) due July 15
                            // Q3 (Jul-Sep) due October 15, Q4 (Oct-Dec) due January 15 NEXT YEAR
                            for (let q = 1; q <= 4 && q < cells.length; q++) {
                                const cell = cells[q];
                                const input = cell.querySelector('input[type="date"]');
                                
                                if (input) {
                                    // Deadline is 15th of month after quarter ends
                                    // Q1 ends March (month 2), due April 15 (month 3, day 15)
                                    // Q2 ends June (month 5), due July 15 (month 6, day 15)
                                    // Q3 ends September (month 8), due October 15 (month 9, day 15)
                                    // Q4 ends December (month 11), due January 15 NEXT YEAR (month 0, day 15)
                                    const quarterEndMonth = (q * 3) - 1; // Q1->2(Mar), Q2->5(Jun), Q3->8(Sep), Q4->11(Dec)
                                    const deadlineMonth = (quarterEndMonth + 1) % 12; // Next month: Q1->3(Apr), Q2->6(Jul), Q3->9(Oct), Q4->0(Jan)
                                    const inputValue = input.value.trim();
                                    
                                    let isOverdue = false;
                                    
                                    // Special handling for Q4 (due January 15 of NEXT year)
                                    if (q === 4) {
                                        // Q4 2026 is due January 15, 2027
                                        const deadlineYear = state.selectedYear + 1; // Q4's deadline is in the next year
                                        const currentYear = currentDate.getFullYear();
                                        
                                        // Check if we've passed the deadline
                                        if (currentYear > deadlineYear) {
                                            // Already past the deadline year
                                            isOverdue = true;
                                        } else if (currentYear === deadlineYear) {
                                            // In the deadline year - check month and day
                                            if (currentMonth === 0 && currentDate.getDate() > 15) {
                                                // January 16+ of deadline year
                                                isOverdue = true;
                                            } else if (currentMonth > 0) {
                                                // February or later of deadline year
                                                isOverdue = true;
                                            }
                                        }
                                        // If currentYear < deadlineYear, not overdue yet
                                    } else {
                                        // For Q1, Q2, Q3 - normal logic
                                        if (currentMonth > deadlineMonth) {
                                            isOverdue = true;
                                        } else if (currentMonth === deadlineMonth && currentDate.getDate() > 15) {
                                            isOverdue = true;
                                        }
                                    }
                                    
                                    // If input is empty and deadline has passed
                                    if (inputValue === '' && isOverdue) {
                                        cell.style.backgroundColor = '#ffcdd2';
                                        input.style.backgroundColor = '#ffcdd2';
                                        input.style.color = '#c62828';
                                    }
                                    // If input has a date - mark as green
                                    else if (inputValue !== '') {
                                        cell.style.backgroundColor = '#c8e6c9';
                                        input.style.backgroundColor = '#c8e6c9';
                                        input.style.color = '#2e7d32';
                                    }
                                    // Future quarters - no color
                                    else {
                                        cell.style.backgroundColor = '';
                                        input.style.backgroundColor = '';
                                        input.style.color = '';
                                    }
                                }
                            }
                        }
                    }
                }
                
                // For DOE - quarterly columns (Q1-Q4) - due 20th of following month
                else if (state.currentTab === 'doe') {
                    const rowType = cells[0]?.textContent.trim() || '';
                    
                    // DOE only has submission date row now
                    if (rowType.includes('Submission Date')) {
                        // DOE Quarterly - Q1, Q2, Q3, Q4
                        for (let q = 1; q <= 4 && q < cells.length; q++) {
                            const cell = cells[q];
                            const input = cell.querySelector('input[type="date"]');
                            
                            if (input) {
                                const inputValue = input.value.trim();
                                let isOverdue = false;
                                
                                // Special handling for Q4 (due January 20 of NEXT year)
                                if (q === 4) {
                                    // Q4 2026 is due January 20, 2027
                                    const deadlineYear = state.selectedYear + 1;
                                    const currentYear = currentDate.getFullYear();
                                    
                                    if (currentYear > deadlineYear) {
                                        isOverdue = true;
                                    } else if (currentYear === deadlineYear) {
                                        if (currentMonth === 0 && currentDate.getDate() > 20) {
                                            isOverdue = true;
                                        } else if (currentMonth > 0) {
                                            isOverdue = true;
                                        }
                                    }
                                } else {
                                    // For Q1, Q2, Q3 - normal logic
                                    const quarterLastMonth = (q * 3) - 1;
                                    const deadlineMonth = quarterLastMonth + 1;
                                    
                                    if (currentMonth > deadlineMonth) {
                                        isOverdue = true;
                                    } else if (currentMonth === deadlineMonth && currentDate.getDate() > 20) {
                                        isOverdue = true;
                                    }
                                }
                                
                                if (inputValue === '' && isOverdue) {
                                    cell.style.backgroundColor = '#ffcdd2';
                                    input.style.backgroundColor = '#ffcdd2';
                                    input.style.color = '#c62828';
                                }
                                else if (inputValue !== '') {
                                    cell.style.backgroundColor = '#c8e6c9';
                                    input.style.backgroundColor = '#c8e6c9';
                                    input.style.color = '#2e7d32';
                                }
                                else {
                                    cell.style.backgroundColor = '';
                                    input.style.backgroundColor = '';
                                    input.style.color = '';
                                }
                            }
                        }
                    }
                }
                
                // For DOE Safety Officer Permit - check expiry dates
                else if (state.currentTab === 'doe-permit') {
                    // Find "Valid Until" column (index 2)
                    if (cells.length >= 3) {
                        const validUntilCell = cells[2];
                        const dateInput = validUntilCell.querySelector('input[type="date"]');
                        
                        if (dateInput) {
                            const validUntilValue = dateInput.value.trim();
                            
                            if (validUntilValue !== '') {
                                const expiryDate = new Date(validUntilValue);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                expiryDate.setHours(0, 0, 0, 0);
                                
                                // Check if expired
                                if (expiryDate < today) {
                                    // EXPIRED - Red
                                    validUntilCell.style.backgroundColor = '#ffcdd2';
                                    dateInput.style.backgroundColor = '#ffcdd2';
                                    dateInput.style.color = '#c62828';
                                    dateInput.style.fontWeight = '700';
                                } 
                                // Check if expiring within 30 days
                                else {
                                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                                    
                                    if (daysUntilExpiry <= 30) {
                                        // Expiring soon - Yellow
                                        validUntilCell.style.backgroundColor = '#fff9c4';
                                        dateInput.style.backgroundColor = '#fff9c4';
                                        dateInput.style.color = '#f57c00';
                                        dateInput.style.fontWeight = '600';
                                    } else {
                                        // Valid - Green
                                        validUntilCell.style.backgroundColor = '#c8e6c9';
                                        dateInput.style.backgroundColor = '#c8e6c9';
                                        dateInput.style.color = '#2e7d32';
                                    }
                                }
                            } else {
                                // No date entered - leave default
                                validUntilCell.style.backgroundColor = '';
                                dateInput.style.backgroundColor = '';
                                dateInput.style.color = '';
                            }
                        }
                    }
                }
            });
        });
        
        console.log(`‚úÖ Color coding applied for ${state.currentTab.toUpperCase()}`);
    }, 100);
}

// Hook into the render function to update colors AND notifications after rendering
// (Combining both hooks to avoid duplicate originalRender declaration)
const originalRenderBase = render;
render = function() {
    originalRenderBase();
    updateReportorialColors();
    if (typeof updateNotifications === 'function') {
        updateNotifications();
    }
    checkExpiredPermits(); // Check for expired DOE permits
};

// Check for expired DOE Safety Officer Permits and show notification
function checkExpiredPermits() {
    if (state.currentTab !== 'doe-permit') return;
    
    const renewableProjects = state.projects.filter(p => p.isRenewable === true);
    const key = 'doe-permit_DOE Safety Officer Permit';
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const expiredPermits = [];
    const expiringSoon = [];
    
    renewableProjects.forEach(p => {
        const validUntil = p.vals[key] ? p.vals[key][2] : "";
        
        if (validUntil) {
            const expiryDate = new Date(validUntil);
            expiryDate.setHours(0, 0, 0, 0);
            
            if (expiryDate < today) {
                expiredPermits.push({
                    project: p.name,
                    expiryDate: validUntil
                });
            } else {
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry <= 30) {
                    expiringSoon.push({
                        project: p.name,
                        expiryDate: validUntil,
                        daysLeft: daysUntilExpiry
                    });
                }
            }
        }
    });
    
    // Show notifications for expired permits
    if (expiredPermits.length > 0) {
        const message = expiredPermits.length === 1
            ? `‚ö†Ô∏è DOE Safety Officer Permit for "${expiredPermits[0].project}" has EXPIRED!`
            : `‚ö†Ô∏è ${expiredPermits.length} DOE Safety Officer Permits have EXPIRED!`;
        
        showToast(message, 'error');
    }
    
    // Show notification for expiring soon
    if (expiringSoon.length > 0) {
        const message = expiringSoon.length === 1
            ? `‚è∞ DOE Safety Officer Permit for "${expiringSoon[0].project}" expires in ${expiringSoon[0].daysLeft} day(s)`
            : `‚è∞ ${expiringSoon.length} DOE Safety Officer Permits expiring within 30 days`;
        
        showToast(message, 'warning');
    }
}

// Run color update when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        updateReportorialColors();
        console.log('‚úÖ Reportorial color coding system initialized');
    }, 1500);
});

// Re-run color update whenever cells are edited
function refreshReportorialColors() {
    updateReportorialColors();
}

// Make the function globally available
window.refreshReportorialColors = refreshReportorialColors;

// Also update colors when input values change
document.addEventListener('input', function(e) {
    if (e.target.tagName === 'INPUT' && e.target.type === 'date') {
        if (['kpm', 'dole', 'emb', 'doe'].includes(state.currentTab)) {
            setTimeout(updateReportorialColors, 50);
        }
    }
});

// ==================== END AUTOMATIC COLOR CODING ====================

// ==================== DOE REPORTORIAL & SAFETY OFFICER PERMIT FUNCTIONS ====================

// PDF Upload Functions for DOE Reportorial
async function uploadDoePdf(projectName, quarter) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type !== 'application/pdf') {
            showToast('‚ö†Ô∏è Please select a PDF file', 'warning');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            showToast('‚ö†Ô∏è File size must be less than 10MB', 'warning');
            return;
        }
        
        try {
            showToast(`üì§ Uploading PDF for Q${quarter}...`, 'info');
            
            const userId = getCurrentUserId();
            const year = state.selectedYear;
            const fileName = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_Q${quarter}_${Date.now()}.pdf`;
            const storagePath = `doe-reports/${userId}/${year}/${fileName}`;
            
            const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
            await window.firebase.uploadBytes(storageRef, file);
            const downloadURL = await window.firebase.getDownloadURL(storageRef);
            
            const project = state.projects.find(p => p.name === projectName);
            if (project) {
                if (!project.doePdfFiles) project.doePdfFiles = {};
                project.doePdfFiles[`Q${quarter}`] = {
                    url: downloadURL,
                    fileName: file.name,
                    storagePath: storagePath,
                    uploadedAt: new Date().toISOString()
                };
                
                await saveToFirebase();
                render();
                showToast(`‚úÖ PDF uploaded for Q${quarter}`, 'success');
            }
        } catch (error) {
            console.error('Error uploading PDF:', error);
            showToast('‚ùå Failed to upload PDF: ' + error.message, 'error');
        }
    };
    
    input.click();
}

async function viewDoePdf(projectName, quarter) {
    const project = state.projects.find(p => p.name === projectName);
    if (!project || !project.doePdfFiles || !project.doePdfFiles[`Q${quarter}`]) {
        showToast('‚ö†Ô∏è No PDF file found', 'warning');
        return;
    }
    
    const pdfData = project.doePdfFiles[`Q${quarter}`];
    window.open(pdfData.url, '_blank');
}

async function deleteDoePdf(projectName, quarter) {
    const confirmed = await showModernDialog(
        'üóëÔ∏è Delete PDF',
        `Delete the uploaded PDF for Q${quarter}?<br><br>This action cannot be undone.`,
        true
    );
    
    if (!confirmed) return;
    
    try {
        const project = state.projects.find(p => p.name === projectName);
        if (!project || !project.doePdfFiles || !project.doePdfFiles[`Q${quarter}`]) {
            showToast('‚ö†Ô∏è No PDF file found', 'warning');
            return;
        }
        
        const pdfData = project.doePdfFiles[`Q${quarter}`];
        
        const storageRef = window.firebase.ref(window.firebaseStorage, pdfData.storagePath);
        await window.firebase.deleteObject(storageRef);
        
        delete project.doePdfFiles[`Q${quarter}`];
        
        await saveToFirebase();
        render();
        showToast(`‚úÖ PDF deleted for Q${quarter}`, 'success');
    } catch (error) {
        console.error('Error deleting PDF:', error);
        showToast('‚ùå Failed to delete PDF: ' + error.message, 'error');
    }
}

// DOE Safety Officer Permit PDF Functions
async function uploadDoePermitPdf(projectName) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type !== 'application/pdf') {
            showToast('‚ö†Ô∏è Please select a PDF file', 'warning');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            showToast('‚ö†Ô∏è File size must be less than 10MB', 'warning');
            return;
        }
        
        try {
            showToast('üì§ Uploading DOE Safety Officer Permit...', 'info');
            
            const userId = getCurrentUserId();
            const year = state.selectedYear;
            const fileName = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_DOE_Permit_${Date.now()}.pdf`;
            const storagePath = `doe-permits/${userId}/${year}/${fileName}`;
            
            const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
            await window.firebase.uploadBytes(storageRef, file);
            const downloadURL = await window.firebase.getDownloadURL(storageRef);
            
            const project = state.projects.find(p => p.name === projectName);
            if (project) {
                const key = 'doe-permit_DOE Safety Officer Permit';
                if (!project.vals[key]) project.vals[key] = {};
                
                // Store PDF URL in index 3
                project.vals[key][3] = downloadURL;
                project.vals[key].pdfFileName = file.name;
                project.vals[key].pdfStoragePath = storagePath;
                
                await saveToFirebase();
                render();
                showToast('‚úÖ DOE Safety Officer Permit PDF uploaded', 'success');
            }
        } catch (error) {
            console.error('Error uploading PDF:', error);
            showToast('‚ùå Failed to upload PDF: ' + error.message, 'error');
        }
    };
    
    input.click();
}

async function viewDoePermitPdf(projectName) {
    const project = state.projects.find(p => p.name === projectName);
    const key = 'doe-permit_DOE Safety Officer Permit';
    
    if (!project || !project.vals[key] || !project.vals[key][3]) {
        showToast('‚ö†Ô∏è No PDF file found', 'warning');
        return;
    }
    
    window.open(project.vals[key][3], '_blank');
}

async function deleteDoePermitPdf(projectName) {
    const confirmed = await showModernDialog(
        'üîÑ Replace PDF',
        'This will delete the current PDF so you can upload a new one. Continue?',
        true
    );
    
    if (!confirmed) return;
    
    try {
        const project = state.projects.find(p => p.name === projectName);
        const key = 'doe-permit_DOE Safety Officer Permit';
        
        if (!project || !project.vals[key] || !project.vals[key][3]) {
            showToast('‚ö†Ô∏è No PDF file found', 'warning');
            return;
        }
        
        const storagePath = project.vals[key].pdfStoragePath;
        if (storagePath) {
            const storageRef = window.firebase.ref(window.firebaseStorage, storagePath);
            await window.firebase.deleteObject(storageRef);
        }
        
        delete project.vals[key][3];
        delete project.vals[key].pdfFileName;
        delete project.vals[key].pdfStoragePath;
        
        await saveToFirebase();
        render();
        showToast('‚úÖ PDF deleted. You can now upload a new one.', 'success');
    } catch (error) {
        console.error('Error deleting PDF:', error);
        showToast('‚ùå Failed to delete PDF: ' + error.message, 'error');
    }
}

// DOE Safety Officer Permit Functions (deprecated - now using table format)

// ==================== MODAL OVERLAY HANDLERS ====================
// Modals are now LOCKED - cannot close by clicking outside
// Users must explicitly click Cancel or Save buttons to exit
// This prevents accidental data loss during editing
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîí Modal safety enabled: Click-outside disabled');
    console.log('üí° Use Cancel or Save buttons to close modals');
});

// ==================== END DOE FUNCTIONS ====================
    </script>

<!-- Safety Reminder Character -->
<div id="safety-reminder-container">
    <div class="safety-character">
        <div class="reminder-bubble">
            <div class="reminder-header">
                <span class="reminder-icon" id="reminder-icon">üëÄ</span>
                <span class="reminder-title" id="reminder-title">20-20-20 Rule</span>
            </div>
            <div class="reminder-text" id="reminder-text">
                Tumingin sa malayo (20 feet) sa loob ng 20 segundo para maiwasan ang eye strain!
            </div>
            <button class="reminder-dismiss" onclick="dismissReminder()">
                <i class="fas fa-check"></i> Salamat sa Reminder!
            </button>
        </div>
        <div class="character-emoji">üë∑‚Äç‚ôÇÔ∏è</div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container"></div>

<!-- Floating Edit/Save Button -->
<button id="floating-edit-btn" class="floating-edit-btn" onclick="toggleEdit()" title="Edit Mode">
    <i class="fas fa-edit" id="floating-edit-icon"></i>
    <span class="edit-tooltip" id="floating-edit-tooltip">Click to Edit</span>
</button>

</body>
</html>
